[
  {
    "id": 2376291,
    "slug": "ubuntu-preseed-base-installer-kernel",
    "title": "039-解决ubuntu使用preseed装机 base-installer/kernel/failed-package-install 问题",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-08-16 18:30:07\n\ntags: [pxe,dhcp,cloudboot,ubuntu,preseed]<br />categories: 运维<br />---\n\n> 这是坚持技术写作计划（含翻译）的第39篇，定个小目标999，每周最少2篇。\n\n\n本文主要介绍在使用pressed无人装机安装ubuntu时，偶尔出现<br />![](https://cdn.nlark.com/yuque/0/2019/png/226273/1565929377804-60abd47c-6890-4bca-b20b-7132192158e1.png#align=left&display=inline&height=595&originHeight=595&originWidth=801&size=0&status=done&width=801)\n\n```bash\nUnexpected error; command not executed: 'sh -c debconf-apt-progress --no-progress --logstederr -- apt-get -q -y --no-remove install busybox-initramfs'\nbase-installer: error: exiting on error base-installer/kernel/failed-package-install\n```\n的解决方案。\n\n之前写的几篇无人装机的文章(有基于cobbler和cloudboot的)\n\n- [010-cloudboot批量安装rancheros](https://juejin.im/post/5c84f9d8f265da2de33f5936)\n- [007-Cobbler批量自动化部署Windows10和Server 2019及激活](https://juejin.im/post/5c748b2af265da2d9262ed0f)\n- [006-Cobbler批量自动化部署CentOS/Ubuntu/Windows](https://juejin.im/post/5c748ae2f265da2d84108d71)\n\n<!-- more -->\n\n<a name=\"2ncpC\"></a>\n## 排查过程\n首先，点击继续，返回上一层页面，选择shell, `cat /var/log/syslog` 找到报错信息 `base-installer: error: exiting on error base-installer/kernel/failed-package-install` <br />在百度和google搜索后，找到跟我类似的问题 [XenServer安装ubuntu16.04遇到的错误](https://imaojia.com/blog/questions/error-install-ubuntu-16-04-on-xenserver/) \n\n但是使用作者的方式处理一遍后，没啥效果，但是阴差阳错的get了 `ctrl+alt+f4` (参考 [Reverting from Ctrl - Alt - F1](https://askubuntu.com/a/157621) )\n\n能看安装日志就简单了，排查就行了，发现是安装ubuntu security时，国外ip被ban了，换成国内源即可。\n\n修改preseed\n\n```bash\nd-i apt-setup/services-select multiselect security\nd-i apt-setup/security_host string mirrors.aliyun.com\nd-i apt-setup/security_path string /ubuntu\n```\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。<br />长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [我的博客](https://anjia0532.github.io/2019/08/16/ubuntu-preseed-base-installer-kernel)\n- [我的掘金](https://juejin.im/post/5d5638f45188255d51425ced)\n- [XenServer安装ubuntu16.04遇到的错误](https://imaojia.com/blog/questions/error-install-ubuntu-16-04-on-xenserver/)\n- [Reverting from Ctrl - Alt - F1](https://askubuntu.com/a/157621)\n- [Headless Installation: Unable to install busybox-initramfs](https://askubuntu.com/questions/949826/headless-installation-unable-to-install-busybox-initramfs)\n- [How do I configure a preseed to skip the language support question?](https://askubuntu.com/questions/129651/how-do-i-configure-a-preseed-to-skip-the-language-support-question/349841#349841)\n\n",
    "body_draft": "date: 2010-08-01 19:35:21\n\ntags: []<br />categories: <br />---\n\n> 这是坚持技术写作计划（含翻译）的第36篇，定个小目标999，每周最少2篇。\n\n\n本文\n\n<!-- more -->\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。<br />长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- 我的博客\n- 我的掘金\n",
    "body_html": "<p><span style=\"background-color: transparent;\">date: 2019-08-16 18:30:07</span><br /></p><p>tags: [pxe,dhcp,cloudboot,ubuntu,preseed]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第39篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要介绍在使用pressed无人装机安装ubuntu时，偶尔出现</p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1565929377804-60abd47c-6890-4bca-b20b-7132192158e1.png#align=left&amp;display=inline&amp;height=595&amp;originHeight=595&amp;originWidth=801&amp;size=0&amp;status=done&amp;width=801\" style=\"max-width: 600px; width: 801px;\" /></p><p><br /></p><pre data-lang=\"bash\"><code>Unexpected error; command not executed: 'sh -c debconf-apt-progress --no-progress --logstederr -- apt-get -q -y --no-remove install busybox-initramfs'\nbase-installer: error: exiting on error base-installer/kernel/failed-package-install</code></pre><p>的解决方案。</p><p><br /></p><p>之前写的几篇无人装机的文章(有基于cobbler和cloudboot的)</p><ul><li><a href=\"https://juejin.im/post/5c84f9d8f265da2de33f5936\" target=\"_blank\">010-cloudboot批量安装rancheros</a></li><li><a href=\"https://juejin.im/post/5c748b2af265da2d9262ed0f\" target=\"_blank\">007-Cobbler批量自动化部署Windows10和Server 2019及激活</a></li><li><a href=\"https://juejin.im/post/5c748ae2f265da2d84108d71\" target=\"_blank\">006-Cobbler批量自动化部署CentOS/Ubuntu/Windows</a></li></ul><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"2ncpC\">排查过程</h2><p>首先，点击继续，返回上一层页面，选择shell, <code>cat /var/log/syslog</code> 找到报错信息 <code>base-installer: error: exiting on error base-installer/kernel/failed-package-install</code> </p><p>在百度和google搜索后，找到跟我类似的问题 <span><a href=\"https://imaojia.com/blog/questions/error-install-ubuntu-16-04-on-xenserver/\" target=\"_blank\">XenServer安装ubuntu16.04遇到的错误</a> </span></p><p><span><br /></span></p><p><span>但是使用作者的方式处理一遍后，没啥效果，但是阴差阳错的get了 </span><code><span>ctrl+alt+f4</span></code> (参考 <a href=\"https://askubuntu.com/a/157621\" target=\"_blank\">Reverting from Ctrl - Alt - F1</a> )</p><p><br /></p><p>能看安装日志就简单了，排查就行了，发现是安装ubuntu security时，国外ip被ban了，换成国内源即可。</p><p><br /></p><p>修改preseed</p><p><br /></p><pre data-lang=\"bash\"><code>d-i apt-setup/services-select multiselect security\nd-i apt-setup/security_host string mirrors.aliyun.com\nd-i apt-setup/security_path string /ubuntu</code></pre><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><p><br /></p><ul><li><a href=\"https://anjia0532.github.io/2019/08/16/ubuntu-preseed-base-installer-kernel\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d5638f45188255d51425ced\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://imaojia.com/blog/questions/error-install-ubuntu-16-04-on-xenserver/\" target=\"_blank\">XenServer安装ubuntu16.04遇到的错误</a></li><li><a href=\"https://askubuntu.com/a/157621\" target=\"_blank\">Reverting from Ctrl - Alt - F1</a></li><li><a href=\"https://askubuntu.com/questions/949826/headless-installation-unable-to-install-busybox-initramfs\" target=\"_blank\">Headless Installation: Unable to install busybox-initramfs</a></li><li><a href=\"https://askubuntu.com/questions/129651/how-do-i-configure-a-preseed-to-skip-the-language-support-question/349841#349841\" target=\"_blank\">How do I configure a preseed to skip the language support question?</a></li></ul><p><br /></p>",
    "body_lake": "<!doctype lake><meta name=\"doc-version\" content=\"1\" /><p><span style=\"background-color: transparent;\">date: 2019-08-16 18:30:07</span><br /></p><p>tags: [pxe,dhcp,cloudboot,ubuntu,preseed]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第39篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要介绍在使用pressed无人装机安装ubuntu时，偶尔出现</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1565929377804-60abd47c-6890-4bca-b20b-7132192158e1.png%22%2C%22originWidth%22%3A801%2C%22originHeight%22%3A595%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A801%2C%22height%22%3A595%7D\"></card></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22Unexpected%20error%3B%20command%20not%20executed%3A%20'sh%20-c%20debconf-apt-progress%20--no-progress%20--logstederr%20--%20apt-get%20-q%20-y%20--no-remove%20install%20busybox-initramfs'%5Cnbase-installer%3A%20error%3A%20exiting%20on%20error%20base-installer%2Fkernel%2Ffailed-package-install%22%2C%22id%22%3A%22F60ec%22%7D\"></card><p>的解决方案。</p><p><br /></p><p>之前写的几篇无人装机的文章(有基于cobbler和cloudboot的)</p><ul><li><a href=\"https://juejin.im/post/5c84f9d8f265da2de33f5936\" target=\"_blank\">010-cloudboot批量安装rancheros</a></li><li><a href=\"https://juejin.im/post/5c748b2af265da2d9262ed0f\" target=\"_blank\">007-Cobbler批量自动化部署Windows10和Server 2019及激活</a></li><li><a href=\"https://juejin.im/post/5c748ae2f265da2d84108d71\" target=\"_blank\">006-Cobbler批量自动化部署CentOS/Ubuntu/Windows</a></li></ul><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"2ncpC\">排查过程</h2><p>首先，点击继续，返回上一层页面，选择shell, <code>cat /var/log/syslog</code> 找到报错信息 <code>base-installer: error: exiting on error base-installer/kernel/failed-package-install</code> </p><p>在百度和google搜索后，找到跟我类似的问题 <span><a href=\"https://imaojia.com/blog/questions/error-install-ubuntu-16-04-on-xenserver/\" target=\"_blank\">XenServer安装ubuntu16.04遇到的错误</a> </span></p><p><span><br /></span></p><p><span>但是使用作者的方式处理一遍后，没啥效果，但是阴差阳错的get了 </span><code><span>ctrl+alt+f4</span></code> (参考 <a href=\"https://askubuntu.com/a/157621\" target=\"_blank\">Reverting from Ctrl - Alt - F1</a> )</p><p><br /></p><p>能看安装日志就简单了，排查就行了，发现是安装ubuntu security时，国外ip被ban了，换成国内源即可。</p><p><br /></p><p>修改preseed</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22d-i%20apt-setup%2Fservices-select%20multiselect%20security%5Cnd-i%20apt-setup%2Fsecurity_host%20string%20mirrors.aliyun.com%5Cnd-i%20apt-setup%2Fsecurity_path%20string%20%2Fubuntu%22%2C%22id%22%3A%22lHmac%22%7D\"></card><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><p><br /></p><ul><li><a href=\"https://anjia0532.github.io/2019/08/16/ubuntu-preseed-base-installer-kernel\" target=\"_blank\">我的博客<cursor /></a></li><li><a href=\"https://juejin.im/post/5d5638f45188255d51425ced\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://imaojia.com/blog/questions/error-install-ubuntu-16-04-on-xenserver/\" target=\"_blank\">XenServer安装ubuntu16.04遇到的错误</a></li><li><a href=\"https://askubuntu.com/a/157621\" target=\"_blank\">Reverting from Ctrl - Alt - F1</a></li><li><a href=\"https://askubuntu.com/questions/949826/headless-installation-unable-to-install-busybox-initramfs\" target=\"_blank\">Headless Installation: Unable to install busybox-initramfs</a></li><li><a href=\"https://askubuntu.com/questions/129651/how-do-i-configure-a-preseed-to-skip-the-language-support-question/349841#349841\" target=\"_blank\">How do I configure a preseed to skip the language support question?</a></li></ul><p><br /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-08-16T05:03:02.000Z",
    "deleted_at": null,
    "created_at": "2019-08-16T03:47:41.000Z",
    "updated_at": "2019-08-16T05:03:02.000Z",
    "published_at": "2019-08-16T05:03:02.000Z",
    "first_published_at": "2019-08-16T05:03:02.000Z",
    "word_count": 431,
    "cover": "",
    "description": "date: 2019-08-16 18:30:07tags: [pxe,dhcp,cloudboot,ubuntu,preseed]categories: 运维---这是坚持技术写作计划（含翻译）的第39篇，定个小目标999，每周最少2篇。本文主要介绍在使用pressed无人装机安装ubunt...",
    "custom_description": "date: 2019-08-16 18:30:07tags: [pxe,dhcp,cloudboot,ubuntu,preseed]categories: 运维---这是坚持技术写作计划（含翻译）的第39篇，定个小目标999，每周最少2篇。本文主要介绍在使用pressed无人装机安装ubunt...",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 2252962,
    "slug": "blog-template",
    "title": "博客模板",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T06:40:10.330Z",
      "updated_at": "2019-08-16T06:40:10.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2010-08-01 19:35:21\n\ntags: []<br />categories: []<br />---\n\n> 这是坚持技术写作计划（含翻译）的第36篇，定个小目标999，每周最少2篇。\n\n\n本文\n\n<!-- more -->\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。<br />长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- 我的博客\n- 我的掘金\n",
    "body_draft": "",
    "body_html": "<p><span style=\"background-color: transparent;\">date: 2010-08-01 19:35:21</span><br /></p><p>tags: []</p><p>categories: []</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第36篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><p><br /></p><ul><li>我的博客</li><li>我的掘金</li></ul>",
    "body_lake": "<!doctype lake><meta name=\"doc-version\" content=\"1\" /><p><span style=\"background-color: transparent;\">date: 2010-08-01 19:35:21</span><br /></p><p>tags: []</p><p>categories: []<cursor /></p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第36篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><p><br /></p><ul><li>我的博客</li><li>我的掘金</li></ul>",
    "public": 0,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-08-16T06:40:10.000Z",
    "deleted_at": null,
    "created_at": "2019-08-01T01:44:45.000Z",
    "updated_at": "2019-08-16T06:40:10.000Z",
    "published_at": "2019-08-16T06:40:10.000Z",
    "first_published_at": "2019-08-01T01:46:40.000Z",
    "word_count": 107,
    "cover": "",
    "description": "date: 2010-08-01 19:35:21tags: []categories: []---这是坚持技术写作计划（含翻译）的第36篇，定个小目标999，每周最少2篇。本文&lt;!-- more --&gt;招聘小广告山东济南的小伙伴欢迎投简历啊 加入我们 , 一起搞事情。长期招聘，J...",
    "custom_description": "date: 2019-08-01 19:35:21tags: []categories: ---这是坚持技术写作计划（含翻译）的第36篇，定个小目标999，每周最少2篇。本文&lt;!-- more --&gt;招聘小广告山东济南的小伙伴欢迎投简历啊 加入我们 , 一起搞事情。长期招聘，Jav...",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 2251618,
    "slug": "tidb-tikv-bad-regions",
    "title": "038-拯救大兵瑞恩之Tidb如何在Tikv损坏的情况下恢复",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-08-01 22:35:41<br />tags: [数据库,mysql,database,tidb,tikv,dba]<br />categories: 数据库<br />---\n> 这是坚持技术写作计划（含翻译）的第38篇，定个小目标999，每周最少2篇。\n\n\n很喜欢TiDB的设计哲学，比如，数据库就活该要么OLAP，要么OLTP么，为嘛就不能兼顾一下？数据量大了后，就一定要反人类的分库分表么？你当分库分表好玩么？分库一时爽，维护火葬场！\n\n尤其在一些中小型团队里，为了数据分析搞一套hadoop，约等于为了喝牛奶，从牛崽开始养一头奶牛。一路上明坑暗坑不断。\n\n考虑到学习成本，迁移成本(高度兼容MySQL-但不是100%)，运维成本(支持Ansible-团队有ansible运维经验)，使用成本(相比hadoop)，硬件成本(相比hadoop)，收益(不用分开分表，支持olap和oltp，支持分布式事务,支持TiSpark,支持tikv，自带同步工具)等。\n\n好了，疑似广告的一段话说完了，回归正题，介绍是如何悲催的遇上整栋大厦停电，并且恰好tikv文件损坏，以及如何在Tidb各位大佬的远程文字指导下，一步步把心态从删库跑路，转变成说不定还有救，以及，我擦，真救回来的坎坷心路旅程。\n\n因为Tidb之前是别的同事负责，刚接过来不久，对Tidb整个的掌握还很初级。真·面向故障学习！\n\n全文主要是对本次事故的回溯，琐碎细节较多，介意的可以直接看最后。\n\n<!-- more -->\n\n集群环境\n\n| name | ip | service |\n| --- | --- | --- |\n| tikv-1 | 192.168.1.200 | tikv |\n| tikv-2 | 192.168.1.201 | tikv |\n| tikv-3 | 192.168.1.202 | tikv(有坏region) |\n| pd | 192.168.1.203 | pd |\n| tidb | 192.168.1.204 | tidb,monitoring |\n| sn-data-node-1 | 192.168.1.216 | tidb |\n| sn-data-node-2 | 192.168.1.217 | tidb |\n| tikv-4 | 192.168.1.218 | tikv(有坏region) |\n\n\n<a name=\"H7w7e\"></a>\n## 悲催之始\n\n上午coding正嗨，突发性停电<br />来电后 ssh 到 tidb的ansible主控机 `ansible-playbook start.yml` <br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564644740298-54b52606-d594-4ba7-b98c-0cb6c21137df.png#align=left&display=inline&height=527&name=image.png&originHeight=527&originWidth=1329&size=82800&status=done&width=1329)\n\n事情有点不妙，但是扔不死心的， `stop and start` 一通后，仍是这个结果。事情有点大条。\n\n好在之前偷偷潜伏到TiDB的官方群里，没事就听各位大佬吹水打屁，多少受了点熏陶。撸起袖子，开搞。\n\n<a name=\"TCaY3\"></a>\n## 定位问题\n<a name=\"ckulg\"></a>\n### Round 1 懵逼树上懵逼果\n先看官方文档<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564648950258-956bb3fb-25de-467f-b6cf-82a7df480f49.png#align=left&display=inline&height=604&name=image.png&originHeight=604&originWidth=1261&size=102094&status=done&width=1261)<br />好吧，跟没看区别不大。\n\n既然是tidb起不来，就先看tidb的日志(实际上应该看http://prometheus:9090/targets ，因为不太熟悉，所以走了弯路，为嘛不看grafana,是因为tidb那卡到后，ansible就自动退出了，没有起grafana)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564648871805-b912a3d1-b5bd-456a-9d4c-8e7db9a47678.png#align=left&display=inline&height=558&name=image.png&originHeight=558&originWidth=1206&size=122785&status=done&width=1206)<br />暴露的是连接两个tikv报错，这是前期比较关键的线索，起码有初步排查方向了。<br />另外从日志看到，疑似报空间不足，实际上没意义，在两台tikv执行 `df -i` `df -h` 来看，都很充足。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564649022668-c8585d09-5958-4143-8314-05fd56deccb4.png#align=left&display=inline&height=88&name=image.png&originHeight=88&originWidth=1538&size=21191&status=done&width=1538)\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564649493786-8d8b7428-0cde-447a-a69f-8b4eeeff6f19.png#align=left&display=inline&height=806&name=image.png&originHeight=806&originWidth=556&size=109795&status=done&width=556)<br />群内 @张曾钧@PingCAP 大佬开始介入，并且开始了将近8个小时的细心和耐心的指导，讲真，PingCAP团队是我见过最热心耐心的团队，素未蒙面，但乐于助人[呲牙]\n\n此时，通过看官方文档，尝试性，试了下Prometheus可以打开，<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564649685360-a05e8e44-b756-4fdd-ab74-1032893b8820.png#align=left&display=inline&height=522&name=image.png&originHeight=522&originWidth=497&size=38639&status=done&width=497)<br />能看出有两个TiKV down掉，正好是上面两个。PS ,我是事后才发现的，当时我一直认为TiKV是起来的[捂脸]<br />插播一下，[TiDB 整体架构](https://pingcap.com/docs-cn/v3.0/architecture/) ，不多解释。建议看看，可以了解一下TiDB的架构原理，比如，TiDB,TiKV,PD等的职责。<br />![](https://cdn.nlark.com/yuque/0/2019/png/226273/1564649874173-be2c66cd-022a-446b-bed8-fadd92e8c0fa.png#align=left&display=inline&height=1112&originHeight=1112&originWidth=1996&size=0&status=done&width=1996)\n> 小结： Round 1 以找出两个TiKV down结束，效率低到羞愧。\n\n\n<a name=\"wnRsx\"></a>\n### Round 2 懵逼树前排排坐\n注意，下面如无特殊说明，一律是TiKV关掉状态下，执行命令。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564650252340-21759119-1843-4434-867a-9963ea765209.png#align=left&display=inline&height=905&name=image.png&originHeight=905&originWidth=547&size=98917&status=done&width=547)![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564650290157-89fc6eec-843d-4e59-a186-c45f21487c44.png#align=left&display=inline&height=856&name=image.png&originHeight=856&originWidth=552&size=112176&status=done&width=552)<br />使用@唐刘@PingCAP的方法 `grep -B 50 Welcome` ,开始接触事发原因了。\n> 更多的grep的方法(-A -B -C)，参考 man grep 或者 [GREP(1)](http://man7.org/linux/man-pages/man1/grep.1.html) ，因为tikv启动会打印Welcome，所以有理由认为，每次的Welcome之前的，肯定是上次退出的原因。\n\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564650861003-ced69111-e25b-4e7a-91fa-1e07eeead844.png#align=left&display=inline&height=850&name=image.png&originHeight=850&originWidth=1530&size=211744&status=done&width=1530)<br />至此，出现了第一个坏掉的region。<br />当时执行了 `./pd-ctl store -d -u http://127.0.0.1:2379` <br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564651001470-549e9680-0b9f-47dd-9713-3e4833167f6e.png#align=left&display=inline&height=554&name=image.png&originHeight=554&originWidth=1059&size=55248&status=done&width=1059)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564650935734-5b346583-f35d-4b50-a788-0bc7840a30d3.png#align=left&display=inline&height=448&name=image.png&originHeight=448&originWidth=399&size=18168&status=done&width=399)<br />找到挂掉的两个TiKV的store id，跟上图的![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564651146956-35cba4a9-55f6-4577-b434-264f20faea47.png#align=left&display=inline&height=46&name=image.png&originHeight=46&originWidth=125&size=3516&status=done&width=125) 68935能对起来。\n\n此时救苦救难的  大佬 提供了 [TiKV Control 使用说明#恢复损坏的-mvcc-数据](https://pingcap.com/docs-cn/v3.0/reference/tools/tikv-control/#恢复损坏的-mvcc-数据)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564651249500-2b1a9f82-1b58-4969-8601-1bc01e2402e8.png#align=left&display=inline&height=675&name=image.png&originHeight=675&originWidth=551&size=81077&status=done&width=551)![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564651219522-f6219985-567d-487c-bafd-71983748cb57.png#align=left&display=inline&height=682&name=image.png&originHeight=682&originWidth=1248&size=108238&status=done&width=1248)<br />实际上执行后，没啥效果，后来发现是因为此region超过一半副本出问题了，recover-mvcc 没法恢复。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564652211716-e27ec913-9262-4429-a3bb-9a9043625b65.png#align=left&display=inline&height=49&name=image.png&originHeight=49&originWidth=857&size=7616&status=done&width=857)\n> Round 2 结束，找到了救命稻草，TiKV Control 和PD Control,但是，事情远没这么简单。\n\n\n<a name=\"EyoeN\"></a>\n### Round 3 渐入佳境\n中间出了个差点搞死自己的小插曲<br />`/home/tidb/tidb-ansible/resources/bin/pd-ctl -u \"http://172.16.10.1:2379\" -d store delete 10` 自作聪明的以为，TiKV 已经没救了，执行了store delete 操作。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564651626772-b211f752-e5e4-4786-b1bd-0ba2b23557cb.png#align=left&display=inline&height=602&name=image.png&originHeight=602&originWidth=1301&size=92940&status=done&width=1301)<br />但是实际上还有救，所以又变成了，如何把已经delete掉的store，再度挂上去。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564651566804-822ec7d1-84f8-41f5-936f-7ed676bd83d0.png#align=left&display=inline&height=503&name=image.png&originHeight=503&originWidth=552&size=62399&status=done&width=552)<br />根据  大佬的 `curl -X POST http://${pd_ip}:2379/pd/api/v1/store/${store_id}/state?state=Up` 成功挂上，当然还是down的状态。\n\n根据![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564652020901-07018aee-c4fa-49b8-bc3c-fbf3e6c79338.png#align=left&display=inline&height=352&name=image.png&originHeight=352&originWidth=1269&size=68592&status=done&width=1269)<br />`tikv-ctl --db /path/to/tikv/db bad-regions` 两台坏的，分别如下<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564651955786-839ddeb4-24c4-48ea-ac4c-5388070ad861.png#align=left&display=inline&height=84&name=image.png&originHeight=84&originWidth=1008&size=15053&status=done&width=1008)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564652396271-4b1eb843-e26f-49e4-99c3-b69dfb1ca5f3.png#align=left&display=inline&height=53&name=image.png&originHeight=53&originWidth=813&size=9564&status=done&width=813)<br />发现坏掉的 region是 31101（实际上因为用的是2.1.4，每次只显示一个，处理完后，才会显示下一个，效率很低，后来在 [@戚铮](#) 大佬的指导下，换用tikv-ctl 3.x ，每次可以显示全部的坏的region ）<br />在好的节点上执行，也不是文中的all regions are healthy ，实际上是因为，数据文件被占用，没法获取句柄，停掉就行 `ansible-playbook stop.yml  -l tikv_servers` 停掉全部tikv节点<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564652278072-088aa64f-abf6-422e-bb3d-8f48911b1bcc.png#align=left&display=inline&height=150&name=image.png&originHeight=150&originWidth=1328&size=26658&status=done&width=1328)\n\n此时@张曾钧@PingCAP 提示用 `tikv-ctl --db /path/to/tikv/db tombstone -p 127.0.0.1:2379 -r`   把坏的 region 设置为tombstone ，但是报错<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564652514513-9392a0eb-14f1-4db0-9b53-913755ab9c2e.png#align=left&display=inline&height=55&name=image.png&originHeight=55&originWidth=984&size=12889&status=done&width=984)\n\n通过执行 pd-ctl region 31101 发现<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564652666941-f219b6a8-177d-49fe-97cd-0c4b598c9b6f.png#align=left&display=inline&height=471&name=image.png&originHeight=471&originWidth=920&size=44057&status=done&width=920)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564652692433-3691b53b-baf4-4a07-b48b-04baffb296a5.png#align=left&display=inline&height=252&name=image.png&originHeight=252&originWidth=339&size=8996&status=done&width=339)<br />这个region有两个副本是在坏节点上，超过一半损坏（剧透一下，实际上最后发现，出问题的都是损坏超过1半的，1/3的都自己恢复了）\n\n尝试执行 operator add remove-peer 发现删不掉。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564652808996-cc279c2f-ba16-411e-8eb5-c00c43839a64.png#align=left&display=inline&height=501&name=image.png&originHeight=501&originWidth=992&size=89355&status=done&width=992)\n\n此时 戚铮 大佬出场。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564652991806-2c3f7356-46a3-4661-8d94-fe002d67e420.png#align=left&display=inline&height=724&name=image.png&originHeight=724&originWidth=530&size=86534&status=done&width=530)<br />经过一番测试，发现 region31101很坚挺，使用 `recover-mvcc`  恢复不了，前面说了是因为损失超过一半副本的原因，使用 `operator add remove-peer` 删不了，估计也是。\n\n<a name=\"zvbGH\"></a>\n### Round 4 貌似解决\n不能因为一颗老鼠屎，坏了一锅汤，部分region坏掉了，先尝试强制恢复试试，保证别的正常吧。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564653280296-469366c4-a6ae-47a8-a497-40bd7ce7fa06.png#align=left&display=inline&height=582&name=image.png&originHeight=582&originWidth=1256&size=110748&status=done&width=1256)<br />注意此命令是在好的store上执行<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564653489333-def691f2-726e-475c-a4ca-8cd7ee40e793.png#align=left&display=inline&height=45&name=image.png&originHeight=45&originWidth=610&size=6467&status=done&width=610)<br />此时启动TiKV集群，执行region 31101，坏掉的已经删掉了，但是服务还是起不来。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564653530458-02c011c8-20fd-4a2f-a05f-8c93515c609f.png#align=left&display=inline&height=495&name=image.png&originHeight=495&originWidth=523&size=27235&status=done&width=523)<br />此时执行 ![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564653616113-ab0e4831-4813-4e58-b7d5-ee49b9e86b87.png#align=left&display=inline&height=78&name=image.png&originHeight=78&originWidth=1035&size=12329&status=done&width=1035)\n\n此时在 [@戚铮](#) 老大的指导下，升级 tikv-ctl ,<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564653856567-a2abc9d6-4f8f-4cf6-bd5f-96fa3a2f6e0a.png#align=left&display=inline&height=695&name=image.png&originHeight=695&originWidth=1322&size=117796&status=done&width=1322)<br />结果202这台，一共三个region坏了，处理了俩，感觉遥遥无期，下了tikv-ctl 3.x后发现，就还有一个坏的。胜利在望。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564653924392-b0be58c8-e5f3-4d82-97f7-f5e9e21e6340.png#align=left&display=inline&height=83&name=image.png&originHeight=83&originWidth=682&size=9300&status=done&width=682)\n\n重复上述操作后，此节点终于up了<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564653986410-df4091d6-436f-4f1c-ba65-0b86d4012df0.png#align=left&display=inline&height=369&name=image.png&originHeight=369&originWidth=488&size=23247&status=done&width=488)\n\n218这个有6个坏的<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564654011573-d22aa7a1-cddd-4e14-9537-31dd02f76212.png#align=left&display=inline&height=154&name=image.png&originHeight=154&originWidth=749&size=20993&status=done&width=749)<br />`unsafe-recover remove-fail-stores`  一通后，终于起来服务了。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564654127217-6f3318f9-1f93-4cee-b64f-649125144a59.png#align=left&display=inline&height=783&name=image.png&originHeight=783&originWidth=697&size=76233&status=done&width=697)\n\n> Round 4 服务已可以启动，总结一下\n> 1. 先stop tikv\n> 1. 如果坏的region少于一半，可以尝试 recover-mvcc\n> 1. 如果超过一半，就玄乎了，是在不行就 unsafe-recover remove-fail-stores,然后再 tikv-ctl --db /path/to/tikv/db tombstone -p 127.0.0.1:2379 -r 31101,xx,xx,xx \n> 1. 再start tikv\n\n\n<a name=\"58Wno\"></a>\n### Round 5 最终局\n你以为万事大吉了？命运就是爱捉弄人。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564654457090-8b4b7bc1-c86b-46f9-bd8c-770334b1581a.png#align=left&display=inline&height=520&name=image.png&originHeight=520&originWidth=549&size=59936&status=done&width=549)\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564654496584-e2f090a0-2837-4979-9d1e-ba278925441f.png#align=left&display=inline&height=637&name=image.png&originHeight=637&originWidth=1459&size=107875&status=done&width=1459)<br />回到原点。\n\n最后还是损失了部分，但是量不大。\n\n<a name=\"mYLTJ\"></a>\n## 总结\n\n1. 对TiDB不够熟悉，很多流于表面\n1. 对TiDB的文档和工具使用不熟练\n1. TiDB的文档不太清晰，比如在故障处理里，没有内链像是pd-ctl,tikv-ctl，甚至都没有提，在pd-ctl和tikv-ctl等工具没有提如何下载，在工具下载里，没有提包含啥工具。很佛系\n1. 多亏了群内各位大佬的热心指导\n1. 如果是tikv有问题，先stop tikv\n1. 如果对于损坏数小于半数的，可以尝试 recover-mvcc\n1. 对于超过半数的，可以尝试 unsafe-recover remove-fail-stores ，再 将store设置 tombstone\n1. 再start tikv\n1. 可以结合 [tidb损坏tikv节点怎么恢复集群](https://www.cnblogs.com/vansky/p/9415551.html) 来做。\n1. 多试验，尤其是做极限测试，并且尝试处理，会积累很多经验。\n1. 虽然没有瑞恩没有全须全尾的拯救回来，但是缺胳膊少腿总好过没命啊。\n\n<a name=\"Gf6U8\"></a>\n## 一点小广告\n其实如果不考虑OLTP的场景，还可以尝试使用clickhouse。这是之前整理的clickhouse的一些文章。\n\n- [031-数据可视化之redash(支持43种数据源)](https://anjia0532.github.io/2019/07/08/redash/)\n- [033-史上最全-mysql迁移到clickhouse的5种办法](https://anjia0532.github.io/2019/07/17/mysql-to-clickhouse/)\n- [035-解决streamsets jdbc全量模式数据重复问题](https://anjia0532.github.io/2019/07/22/sdc-jdbc-full-mode/)\n\n<a name=\"7y7Px\"></a>\n## 参考资料\n\n- [我的博客](http://anjia0532.github.io/2019/08/01/tidb-tikv-bad-regions)\n- [我的掘金](https://juejin.im/post/5d42f942f265da03d60ee060)\n- [failed to write to engine #10596](https://github.com/pingcap/tidb/issues/10596)\n- [使用 TiDB-Ansible 扩容缩容 TiDB 集群](https://pingcap.com/docs-cn/v3.0/how-to/scale/with-ansible/)\n- [TiDB 集群故障诊断](https://pingcap.com/docs-cn/v3.0/how-to/troubleshoot/cluster-setup/)\n- [PD Control 使用说明](https://pingcap.com/docs-cn/v3.0/reference/tools/pd-control/)\n- [TiKV Control 使用说明](https://pingcap.com/docs-cn/v3.0/reference/tools/tikv-control/)\n- [TiDB 工具下载](https://pingcap.com/docs-cn/v3.0/reference/tools/download/)\n- [tidb损坏tikv节点怎么恢复集群](https://www.cnblogs.com/vansky/p/9415551.html)\n- [Tidb用户案例](https://pingcap.com/cases-cn/)\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-08-01 22:35:41</p><p>tags: [数据库,mysql,database,tidb,tikv,dba]</p><p>categories: 数据库</p><p>---</p><blockquote><p><span>这是坚持技术写作计划（含翻译）的第38篇，定个小目标999，每周最少2篇。</span></p></blockquote><p><br /></p><p>很喜欢TiDB的设计哲学，比如，数据库就活该要么OLAP，要么OLTP么，为嘛就不能兼顾一下？数据量大了后，就一定要反人类的分库分表么？你当分库分表好玩么？分库一时爽，维护火葬场！</p><p><br /></p><p>尤其在一些中小型团队里，为了数据分析搞一套hadoop，约等于为了喝牛奶，从牛崽开始养一头奶牛。一路上明坑暗坑不断。</p><p><br /></p><p>考虑到学习成本，<span>迁移成本</span>(高度兼容MySQL-但不是100%)，运维成本(支持Ansible-团队有ansible运维经验)，使用成本(相比hadoop)，硬件成本(相比hadoop)，收益(不用分开分表，支持olap和oltp，支持分布式事务,支持TiSpark,支持tikv，自带同步工具)等。</p><p><br /></p><p>好了，疑似广告的一段话说完了，回归正题，<span style=\"background-color: transparent;\">介绍是如何悲催的遇上整栋大厦停电，并且恰好tikv文件损坏，以及如何在Tidb各位大佬的远程文字指导下，一步步把心态从删库跑路，转变成说不定还有救，以及，我擦，真救回来的坎坷心路旅程。</span></p><p><br /></p><p>因为Tidb之前是别的同事负责，刚接过来不久，对Tidb整个的掌握还很初级。真·面向故障学习！</p><p><br /></p><p>全文主要是对本次事故的回溯，琐碎细节较多，介意的可以直接看最后。</p><p><br /></p><p><span style=\"background-color: transparent;\">&lt;!-- more --&gt;</span></p><p><br /></p><p>集群环境</p><p><br /></p><table class=\"lake-table\" style=\"width: 721px;\"><colgroup><col width=\"240\"></col><col width=\"240\"></col><col width=\"240\"></col></colgroup><tbody><tr><td><p>name</p></td><td><p>ip</p></td><td><p>service</p></td></tr><tr><td><p>tikv-1</p></td><td rowspan=\"1\" colspan=\"1\"><p>192.168.1.200</p></td><td rowspan=\"1\" colspan=\"1\">tikv</td></tr><tr><td><p>tikv-2</p></td><td><p><span>192.168.1</span><span>.201</span></p></td><td rowspan=\"1\" colspan=\"1\">tikv</td></tr><tr><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p>tikv-3</p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p><span>192.168.1</span><span>.202</span></p></td><td colspan=\"1\" rowspan=\"1\" style=\"background-color: #FFFFFF;\">tikv(有坏region)</td></tr><tr><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p>pd</p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p><span>192.168.1</span><span>.203</span></p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p>pd</p></td></tr><tr><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p>tidb</p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p><span>192.168.1</span>.204</p></td><td colspan=\"1\" rowspan=\"1\" style=\"background-color: #FFFFFF;\">tidb,monitoring</td></tr><tr><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p>sn-data-node-1</p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p><span>192.168.1</span><span>.216</span></p></td><td colspan=\"1\" rowspan=\"1\" style=\"background-color: #FFFFFF;\">tidb</td></tr><tr><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p>sn-data-node-2</p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p><span>192.168.1</span>.217</p></td><td colspan=\"1\" rowspan=\"1\" style=\"background-color: #FFFFFF;\">tidb</td></tr><tr><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p>tikv-4</p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p><span>192.168.1</span><span>.218</span></p></td><td colspan=\"1\" rowspan=\"1\" style=\"background-color: #FFFFFF;\">tikv(有坏region)</td></tr></tbody></table><p><br /></p><h2 id=\"H7w7e\">悲催之始</h2><p><br /></p><p>上午coding正嗨，突发性停电</p><p>来电后 ssh 到 tidb的ansible主控机 <code>ansible-playbook start.yml</code> </p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564644740298-54b52606-d594-4ba7-b98c-0cb6c21137df.png#align=left&amp;display=inline&amp;height=527&amp;name=image.png&amp;originHeight=527&amp;originWidth=1329&amp;size=82800&amp;status=done&amp;width=1329\" style=\"max-width: 600px; width: 1329px;\" /></p><p><br /></p><p>事情有点不妙，但是扔不死心的， <code>stop and start</code> 一通后，仍是这个结果。事情有点大条。</p><p><br /></p><p>好在之前偷偷潜伏到TiDB的官方群里，没事就听各位大佬吹水打屁，多少受了点熏陶。撸起袖子，开搞。</p><p><br /></p><h2 id=\"TCaY3\">定位问题</h2><h3 id=\"ckulg\">Round 1 懵逼树上懵逼果</h3><p>先看官方文档</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564648950258-956bb3fb-25de-467f-b6cf-82a7df480f49.png#align=left&amp;display=inline&amp;height=604&amp;name=image.png&amp;originHeight=604&amp;originWidth=1261&amp;size=102094&amp;status=done&amp;width=1261\" style=\"max-width: 600px; width: 1261px;\" /></p><p>好吧，跟没看区别不大。</p><p><br /></p><p>既然是tidb起不来，就先看tidb的日志(实际上应该看http://p<span class=\"lake-fontsize-10\" style=\"color: #333333;\">rometheus:</span>9090/targets ，因为不太熟悉，所以走了弯路，为嘛不看grafana,是因为tidb那卡到后，ansible就自动退出了，没有起grafana)</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564648871805-b912a3d1-b5bd-456a-9d4c-8e7db9a47678.png#align=left&amp;display=inline&amp;height=558&amp;name=image.png&amp;originHeight=558&amp;originWidth=1206&amp;size=122785&amp;status=done&amp;width=1206\" style=\"max-width: 600px; width: 1206px;\" /></p><p>暴露的是连接两个tikv报错，这是前期比较关键的线索，起码有初步排查方向了。</p><p>另外从日志看到，疑似报空间不足，实际上没意义，在两台tikv执行 <code>df -i</code> <code>df -h</code> 来看，都很充足。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564649022668-c8585d09-5958-4143-8314-05fd56deccb4.png#align=left&amp;display=inline&amp;height=88&amp;name=image.png&amp;originHeight=88&amp;originWidth=1538&amp;size=21191&amp;status=done&amp;width=1538\" style=\"max-width: 600px; width: 1538px;\" /></p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564649493786-8d8b7428-0cde-447a-a69f-8b4eeeff6f19.png#align=left&amp;display=inline&amp;height=806&amp;name=image.png&amp;originHeight=806&amp;originWidth=556&amp;size=109795&amp;status=done&amp;width=556\" style=\"max-width: 600px; width: 556px;\" /></p><p>群内 @张曾钧@PingCAP 大佬开始介入，并且开始了将近8个小时的细心和耐心的指导，讲真，PingCAP团队是我见过最热心耐心的团队，素未蒙面，但乐于助人[呲牙]</p><p><br /></p><p>此时，通过看官方文档，尝试性，试了下Prometheus可以打开，</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564649685360-a05e8e44-b756-4fdd-ab74-1032893b8820.png#align=left&amp;display=inline&amp;height=522&amp;name=image.png&amp;originHeight=522&amp;originWidth=497&amp;size=38639&amp;status=done&amp;width=497\" style=\"max-width: 600px; width: 497px;\" /></p><p>能看出有两个TiKV down掉，正好是上面两个。PS ,我是事后才发现的，当时我一直认为TiKV是起来的[捂脸]</p><p>插播一下，<a href=\"https://pingcap.com/docs-cn/v3.0/architecture/\" target=\"_blank\">TiDB 整体架构</a> ，不多解释。建议看看，可以了解一下TiDB的架构原理，比如，TiDB,TiKV,PD等的职责。</p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564649874173-be2c66cd-022a-446b-bed8-fadd92e8c0fa.png#align=left&amp;display=inline&amp;height=1112&amp;originHeight=1112&amp;originWidth=1996&amp;size=0&amp;status=done&amp;width=1996\" style=\"max-width: 600px; width: 1996px;\" /></p><blockquote><p><span>小结： Round 1 以找出两个TiKV down结束，效率低到羞愧。</span></p></blockquote><p><br /></p><h3 id=\"wnRsx\">Round 2 懵逼树前排排坐</h3><p>注意，下面如无特殊说明，一律是TiKV关掉状态下，执行命令。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564650252340-21759119-1843-4434-867a-9963ea765209.png#align=left&amp;display=inline&amp;height=905&amp;name=image.png&amp;originHeight=905&amp;originWidth=547&amp;size=98917&amp;status=done&amp;width=547\" style=\"max-width: 600px; width: 547px;\" /><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564650290157-89fc6eec-843d-4e59-a186-c45f21487c44.png#align=left&amp;display=inline&amp;height=856&amp;name=image.png&amp;originHeight=856&amp;originWidth=552&amp;size=112176&amp;status=done&amp;width=552\" style=\"max-width: 600px; width: 552px;\" /></p><p>使用@唐刘@PingCAP的方法 <code>grep -B 50 Welcome</code> ,开始接触事发原因了。</p><blockquote><p>更多的grep的方法(-A -B -C)，参考 man grep 或者 <a href=\"http://man7.org/linux/man-pages/man1/grep.1.html\" target=\"_blank\">GREP(1)</a> ，因为tikv启动会打印Welcome，所以有理由认为，每次的Welcome之前的，肯定是上次退出的原因。</p></blockquote><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564650861003-ced69111-e25b-4e7a-91fa-1e07eeead844.png#align=left&amp;display=inline&amp;height=850&amp;name=image.png&amp;originHeight=850&amp;originWidth=1530&amp;size=211744&amp;status=done&amp;width=1530\" style=\"max-width: 600px; width: 1530px;\" /></p><p>至此，出现了第一个坏掉的region。</p><p>当时执行了 <code>./pd-ctl store -d -u http://127.0.0.1:2379</code> </p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564651001470-549e9680-0b9f-47dd-9713-3e4833167f6e.png#align=left&amp;display=inline&amp;height=554&amp;name=image.png&amp;originHeight=554&amp;originWidth=1059&amp;size=55248&amp;status=done&amp;width=1059\" style=\"max-width: 600px; width: 1059px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564650935734-5b346583-f35d-4b50-a788-0bc7840a30d3.png#align=left&amp;display=inline&amp;height=448&amp;name=image.png&amp;originHeight=448&amp;originWidth=399&amp;size=18168&amp;status=done&amp;width=399\" style=\"max-width: 600px; width: 399px;\" /></p><p>找到挂掉的两个TiKV的store id，跟上图的<img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564651146956-35cba4a9-55f6-4577-b434-264f20faea47.png#align=left&amp;display=inline&amp;height=46&amp;name=image.png&amp;originHeight=46&amp;originWidth=125&amp;size=3516&amp;status=done&amp;width=125\" style=\"max-width: 600px; width: 125px;\" /><span> 68935能对起来。</span></p><p><span><br /></span></p><p>此时救苦救难的  大佬 提供了 <a href=\"https://pingcap.com/docs-cn/v3.0/reference/tools/tikv-control/#恢复损坏的-mvcc-数据\" target=\"_blank\">TiKV Control 使用说明#恢复损坏的-mvcc-数据</a></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564651249500-2b1a9f82-1b58-4969-8601-1bc01e2402e8.png#align=left&amp;display=inline&amp;height=675&amp;name=image.png&amp;originHeight=675&amp;originWidth=551&amp;size=81077&amp;status=done&amp;width=551\" style=\"max-width: 600px; width: 551px;\" /><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564651219522-f6219985-567d-487c-bafd-71983748cb57.png#align=left&amp;display=inline&amp;height=682&amp;name=image.png&amp;originHeight=682&amp;originWidth=1248&amp;size=108238&amp;status=done&amp;width=1248\" style=\"max-width: 600px; width: 1248px;\" /></p><p>实际上执行后，没啥效果，后来发现是因为此region超过一半副本出问题了，recover-mvcc 没法恢复。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564652211716-e27ec913-9262-4429-a3bb-9a9043625b65.png#align=left&amp;display=inline&amp;height=49&amp;name=image.png&amp;originHeight=49&amp;originWidth=857&amp;size=7616&amp;status=done&amp;width=857\" style=\"max-width: 600px; width: 857px;\" /></p><blockquote><p>Round 2 结束，找到了救命稻草，TiKV Control 和PD Control,但是，事情远没这么简单。</p></blockquote><p><br /></p><h3 id=\"EyoeN\">Round 3 渐入佳境</h3><p>中间出了个差点搞死自己的小插曲</p><p><code>/home/tidb/tidb-ansible/resources/bin/pd-ctl -u &quot;http://172.16.10.1:2379&quot; -d store delete 10</code> 自作聪明的以为，TiKV 已经没救了，执行了store delete 操作。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564651626772-b211f752-e5e4-4786-b1bd-0ba2b23557cb.png#align=left&amp;display=inline&amp;height=602&amp;name=image.png&amp;originHeight=602&amp;originWidth=1301&amp;size=92940&amp;status=done&amp;width=1301\" style=\"max-width: 600px; width: 1301px;\" /></p><p>但是实际上还有救，所以又变成了，如何把已经delete掉的store，再度挂上去。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564651566804-822ec7d1-84f8-41f5-936f-7ed676bd83d0.png#align=left&amp;display=inline&amp;height=503&amp;name=image.png&amp;originHeight=503&amp;originWidth=552&amp;size=62399&amp;status=done&amp;width=552\" style=\"max-width: 600px; width: 552px;\" /></p><p>根据  大佬的 <code>curl -X POST http://${pd_ip}:2379/pd/api/v1/store/${store_id}/state?state=Up</code> 成功挂上，当然还是down的状态。</p><p><br /></p><p>根据<img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564652020901-07018aee-c4fa-49b8-bc3c-fbf3e6c79338.png#align=left&amp;display=inline&amp;height=352&amp;name=image.png&amp;originHeight=352&amp;originWidth=1269&amp;size=68592&amp;status=done&amp;width=1269\" style=\"max-width: 600px; width: 1269px;\" /></p><p><code>tikv-ctl --db /path/to/tikv/db bad-regions</code> 两台坏的，分别如下</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564651955786-839ddeb4-24c4-48ea-ac4c-5388070ad861.png#align=left&amp;display=inline&amp;height=84&amp;name=image.png&amp;originHeight=84&amp;originWidth=1008&amp;size=15053&amp;status=done&amp;width=1008\" style=\"max-width: 600px; width: 1008px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564652396271-4b1eb843-e26f-49e4-99c3-b69dfb1ca5f3.png#align=left&amp;display=inline&amp;height=53&amp;name=image.png&amp;originHeight=53&amp;originWidth=813&amp;size=9564&amp;status=done&amp;width=813\" style=\"max-width: 600px; width: 813px;\" /></p><p>发现坏掉的 region是 31101（实际上因为用的是2.1.4，每次只显示一个，处理完后，才会显示下一个，效率很低，后来在 <a href=\"#\">@戚铮</a> 大佬的指导下，换用tikv-ctl 3.x ，每次可以显示全部的坏的region ）</p><p>在好的节点上执行，也不是文中的all regions are healthy ，实际上是因为，数据文件被占用，没法获取句柄，停掉就行 <code>ansible-playbook stop.yml  -l tikv_servers</code> 停掉全部tikv节点</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564652278072-088aa64f-abf6-422e-bb3d-8f48911b1bcc.png#align=left&amp;display=inline&amp;height=150&amp;name=image.png&amp;originHeight=150&amp;originWidth=1328&amp;size=26658&amp;status=done&amp;width=1328\" style=\"max-width: 600px; width: 1328px;\" /></p><p><br /></p><p>此时<span>@张曾钧@PingCAP</span> 提示用 <code>tikv-ctl --db /path/to/tikv/db tombstone -p 127.0.0.1:2379 -r</code> <span>  把坏的 region 设置为tombstone ，但是报错</span></p><p><span><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564652514513-9392a0eb-14f1-4db0-9b53-913755ab9c2e.png#align=left&amp;display=inline&amp;height=55&amp;name=image.png&amp;originHeight=55&amp;originWidth=984&amp;size=12889&amp;status=done&amp;width=984\" style=\"max-width: 600px; width: 984px;\" /></span></p><p><span><br /></span></p><p><span>通过执行 pd-ctl region 31101 发现</span></p><p><span><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564652666941-f219b6a8-177d-49fe-97cd-0c4b598c9b6f.png#align=left&amp;display=inline&amp;height=471&amp;name=image.png&amp;originHeight=471&amp;originWidth=920&amp;size=44057&amp;status=done&amp;width=920\" style=\"max-width: 600px; width: 920px;\" /></span></p><p><span><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564652692433-3691b53b-baf4-4a07-b48b-04baffb296a5.png#align=left&amp;display=inline&amp;height=252&amp;name=image.png&amp;originHeight=252&amp;originWidth=339&amp;size=8996&amp;status=done&amp;width=339\" style=\"max-width: 600px; width: 339px;\" /></span></p><p>这个region有两个副本是在坏节点上，超过一半损坏（剧透一下，实际上最后发现，出问题的都是损坏超过1半的，1/3的都自己恢复了）</p><p><br /></p><p>尝试执行 operator add remove-peer 发现删不掉。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564652808996-cc279c2f-ba16-411e-8eb5-c00c43839a64.png#align=left&amp;display=inline&amp;height=501&amp;name=image.png&amp;originHeight=501&amp;originWidth=992&amp;size=89355&amp;status=done&amp;width=992\" style=\"max-width: 600px; width: 992px;\" /></p><p><br /></p><p>此时 <span>戚铮</span> 大佬出场。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564652991806-2c3f7356-46a3-4661-8d94-fe002d67e420.png#align=left&amp;display=inline&amp;height=724&amp;name=image.png&amp;originHeight=724&amp;originWidth=530&amp;size=86534&amp;status=done&amp;width=530\" style=\"max-width: 600px; width: 530px;\" /></p><p>经过一番测试，发现 region31101很坚挺，使用 <code>recover-mvcc</code>  恢复不了，前面说了是因为损失超过一半副本的原因，使用 <code>operator add remove-peer</code> 删不了，估计也是。</p><p><br /></p><h3 id=\"zvbGH\">Round 4 貌似解决</h3><p>不能因为一颗老鼠屎，坏了一锅汤，部分region坏掉了，先尝试强制恢复试试，保证别的正常吧。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564653280296-469366c4-a6ae-47a8-a497-40bd7ce7fa06.png#align=left&amp;display=inline&amp;height=582&amp;name=image.png&amp;originHeight=582&amp;originWidth=1256&amp;size=110748&amp;status=done&amp;width=1256\" style=\"max-width: 600px; width: 1256px;\" /></p><p>注意此命令是在好的store上执行</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564653489333-def691f2-726e-475c-a4ca-8cd7ee40e793.png#align=left&amp;display=inline&amp;height=45&amp;name=image.png&amp;originHeight=45&amp;originWidth=610&amp;size=6467&amp;status=done&amp;width=610\" style=\"max-width: 600px; width: 610px;\" /></p><p>此时启动TiKV集群，执行region 31101，坏掉的已经删掉了，但是服务还是起不来。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564653530458-02c011c8-20fd-4a2f-a05f-8c93515c609f.png#align=left&amp;display=inline&amp;height=495&amp;name=image.png&amp;originHeight=495&amp;originWidth=523&amp;size=27235&amp;status=done&amp;width=523\" style=\"max-width: 600px; width: 523px;\" /></p><p>此时执行 <img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564653616113-ab0e4831-4813-4e58-b7d5-ee49b9e86b87.png#align=left&amp;display=inline&amp;height=78&amp;name=image.png&amp;originHeight=78&amp;originWidth=1035&amp;size=12329&amp;status=done&amp;width=1035\" style=\"max-width: 600px; width: 1035px;\" /></p><p><br /></p><p>此时在 <a href=\"#\">@戚铮</a> 老大的指导下，升级 tikv-ctl ,</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564653856567-a2abc9d6-4f8f-4cf6-bd5f-96fa3a2f6e0a.png#align=left&amp;display=inline&amp;height=695&amp;name=image.png&amp;originHeight=695&amp;originWidth=1322&amp;size=117796&amp;status=done&amp;width=1322\" style=\"max-width: 600px; width: 1322px;\" /></p><p>结果202这台，一共三个region坏了，处理了俩，感觉遥遥无期，下了tikv-ctl 3.x后发现，就还有一个坏的。胜利在望。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564653924392-b0be58c8-e5f3-4d82-97f7-f5e9e21e6340.png#align=left&amp;display=inline&amp;height=83&amp;name=image.png&amp;originHeight=83&amp;originWidth=682&amp;size=9300&amp;status=done&amp;width=682\" style=\"max-width: 600px; width: 682px;\" /></p><p><br /></p><p>重复上述操作后，此节点终于up了</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564653986410-df4091d6-436f-4f1c-ba65-0b86d4012df0.png#align=left&amp;display=inline&amp;height=369&amp;name=image.png&amp;originHeight=369&amp;originWidth=488&amp;size=23247&amp;status=done&amp;width=488\" style=\"max-width: 600px; width: 488px;\" /></p><p><br /></p><p>218这个有6个坏的</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564654011573-d22aa7a1-cddd-4e14-9537-31dd02f76212.png#align=left&amp;display=inline&amp;height=154&amp;name=image.png&amp;originHeight=154&amp;originWidth=749&amp;size=20993&amp;status=done&amp;width=749\" style=\"max-width: 600px; width: 749px;\" /></p><p><code>unsafe-recover remove-fail-stores</code>  一通后，终于起来服务了。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564654127217-6f3318f9-1f93-4cee-b64f-649125144a59.png#align=left&amp;display=inline&amp;height=783&amp;name=image.png&amp;originHeight=783&amp;originWidth=697&amp;size=76233&amp;status=done&amp;width=697\" style=\"max-width: 600px; width: 697px;\" /></p><p><br /></p><blockquote><p>Round 4 服务已可以启动，总结一下</p><ol start=\"1\"><li>先stop tikv</li><li>如果坏的region少于一半，可以尝试 recover-mvcc</li><li>如果超过一半，就玄乎了，是在不行就 unsafe-recover remove-fail-stores,然后再 tikv-ctl --db /path/to/tikv/db tombstone -p 127.0.0.1:2379 -r 31101,xx,xx,xx </li><li>再start tikv</li></ol></blockquote><p><br /></p><h3 id=\"58Wno\">Round 5 最终局</h3><p>你以为万事大吉了？命运就是爱捉弄人。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564654457090-8b4b7bc1-c86b-46f9-bd8c-770334b1581a.png#align=left&amp;display=inline&amp;height=520&amp;name=image.png&amp;originHeight=520&amp;originWidth=549&amp;size=59936&amp;status=done&amp;width=549\" style=\"max-width: 600px; width: 549px;\" /></p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564654496584-e2f090a0-2837-4979-9d1e-ba278925441f.png#align=left&amp;display=inline&amp;height=637&amp;name=image.png&amp;originHeight=637&amp;originWidth=1459&amp;size=107875&amp;status=done&amp;width=1459\" style=\"max-width: 600px; width: 1459px;\" /></p><p>回到原点。</p><p><br /></p><p>最后还是损失了部分，但是量不大。</p><p><br /></p><h2 id=\"mYLTJ\">总结</h2><ol start=\"1\"><li>对TiDB不够熟悉，很多流于表面</li><li>对TiDB的文档和工具使用不熟练</li><li>TiDB的文档不太清晰，比如在故障处理里，没有内链像是pd-ctl,tikv-ctl，甚至都没有提，在pd-ctl和tikv-ctl等工具没有提如何下载，在工具下载里，没有提包含啥工具。很佛系</li><li>多亏了群内各位大佬的热心指导</li><li>如果是tikv有问题，先stop tikv</li><li>如果对于损坏数小于半数的，可以尝试 <span>recover-mvcc</span></li><li>对于超过半数的，可以尝试 <span>unsafe-recover remove-fail-stores ，再 将store设置 </span><span>tombstone</span></li><li>再start tikv</li><li>可以结合 <span><a href=\"https://www.cnblogs.com/vansky/p/9415551.html\" target=\"_blank\">tidb损坏tikv节点怎么恢复集群</a> 来做。</span></li><li>多试验，尤其是做极限测试，并且尝试处理，会积累很多经验。</li><li>虽然没有瑞恩没有全须全尾的拯救回来，但是缺胳膊少腿总好过没命啊。</li></ol><p><br /></p><h2 id=\"Gf6U8\">一点小广告</h2><p>其实如果不考虑OLTP的场景，还可以尝试使用clickhouse。这是之前整理的clickhouse的一些文章。</p><ul><li><a href=\"https://anjia0532.github.io/2019/07/08/redash/\" target=\"_blank\">031-数据可视化之redash(支持43种数据源)</a></li><li><a href=\"https://anjia0532.github.io/2019/07/17/mysql-to-clickhouse/\" target=\"_blank\">033-史上最全-mysql迁移到clickhouse的5种办法</a></li><li><a href=\"https://anjia0532.github.io/2019/07/22/sdc-jdbc-full-mode/\" target=\"_blank\">035-解决streamsets jdbc全量模式数据重复问题</a></li></ul><p><br /></p><h2 id=\"7y7Px\">参考资料</h2><ul><li><a href=\"http://anjia0532.github.io/2019/08/01/tidb-tikv-bad-regions\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d42f942f265da03d60ee060\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://github.com/pingcap/tidb/issues/10596\" target=\"_blank\">failed to write to engine #10596</a></li><li><a href=\"https://pingcap.com/docs-cn/v3.0/how-to/scale/with-ansible/\" target=\"_blank\">使用 TiDB-Ansible 扩容缩容 TiDB 集群</a></li><li><a href=\"https://pingcap.com/docs-cn/v3.0/how-to/troubleshoot/cluster-setup/\" target=\"_blank\">TiDB 集群故障诊断</a></li><li><a href=\"https://pingcap.com/docs-cn/v3.0/reference/tools/pd-control/\" target=\"_blank\">PD Control 使用说明</a></li><li><a href=\"https://pingcap.com/docs-cn/v3.0/reference/tools/tikv-control/\" target=\"_blank\">TiKV Control 使用说明</a></li><li><a href=\"https://pingcap.com/docs-cn/v3.0/reference/tools/download/\" target=\"_blank\">TiDB 工具下载</a></li><li><a href=\"https://www.cnblogs.com/vansky/p/9415551.html\" target=\"_blank\">tidb损坏tikv节点怎么恢复集群</a></li><li><a href=\"https://pingcap.com/cases-cn/\" target=\"_blank\">Tidb用户案例</a></li></ul>",
    "body_lake": "<!doctype lake><meta name=\"doc-version\" content=\"1\" /><p>date: 2019-08-01 22:35:41</p><p>tags: [数据库,mysql,database,tidb,tikv,dba]</p><p>categories: 数据库</p><p>---</p><blockquote><p><span>这是坚持技术写作计划（含翻译）的第38篇，定个小目标999，每周最少2篇。</span></p></blockquote><p><br /></p><p>很喜欢TiDB的设计哲学，比如，数据库就活该要么OLAP，要么OLTP么，为嘛就不能兼顾一下？数据量大了后，就一定要反人类的分库分表么？你当分库分表好玩么？分库一时爽，维护火葬场！</p><p><br /></p><p>尤其在一些中小型团队里，为了数据分析搞一套hadoop，约等于为了喝牛奶，从牛崽开始养一头奶牛。一路上明坑暗坑不断。</p><p><br /></p><p>考虑到学习成本，<span>迁移成本</span>(高度兼容MySQL-但不是100%)，运维成本(支持Ansible-团队有ansible运维经验)，使用成本(相比hadoop)，硬件成本(相比hadoop)，收益(不用分开分表，支持olap和oltp，支持分布式事务,支持TiSpark,支持tikv，自带同步工具)等。</p><p><br /></p><p>好了，疑似广告的一段话说完了，回归正题，<span style=\"background-color: transparent;\">介绍是如何悲催的遇上整栋大厦停电，并且恰好tikv文件损坏，以及如何在Tidb各位大佬的远程文字指导下，一步步把心态从删库跑路，转变成说不定还有救，以及，我擦，真救回来的坎坷心路旅程。</span></p><p><br /></p><p>因为Tidb之前是别的同事负责，刚接过来不久，对Tidb整个的掌握还很初级。真·面向故障学习！</p><p><br /></p><p>全文主要是对本次事故的回溯，琐碎细节较多，介意的可以直接看最后。</p><p><br /></p><p><span style=\"background-color: transparent;\">&lt;!-- more --&gt;</span></p><p><br /></p><p>集群环境</p><p><br /></p><card type=\"block\" name=\"table\" value=\"data:%7B%22rows%22%3A9%2C%22cols%22%3A3%2C%22html%22%3A%22%3Ctable%20class%3D%5C%22lake-table%5C%22%20style%3D%5C%22width%3A%20721px%3B%5C%22%3E%3Ccolgroup%3E%3Ccol%20width%3D%5C%22240%5C%22%20span%3D%5C%221%5C%22%20%2F%3E%3Ccol%20width%3D%5C%22240%5C%22%20span%3D%5C%221%5C%22%20%2F%3E%3Ccol%20width%3D%5C%22240%5C%22%20span%3D%5C%221%5C%22%20%2F%3E%3C%2Fcolgroup%3E%3Ctbody%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3E%3Cp%3Ename%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%3Cp%3Eip%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%3Cp%3Eservice%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3E%3Cp%3Etikv-1%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20colspan%3D%5C%221%5C%22%3E%3Cp%3E192.168.1.200%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20colspan%3D%5C%221%5C%22%3Etikv%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3E%3Cp%3Etikv-2%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%3Cp%3E%3Cspan%3E192.168.1%3C%2Fspan%3E%3Cspan%3E.201%3C%2Fspan%3E%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20colspan%3D%5C%221%5C%22%3Etikv%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3Etikv-3%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E%3Cspan%3E192.168.1%3C%2Fspan%3E%3Cspan%3E.202%3C%2Fspan%3E%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3Etikv(%E6%9C%89%E5%9D%8Fregion)%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3Epd%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E%3Cspan%3E192.168.1%3C%2Fspan%3E%3Cspan%3E.203%3C%2Fspan%3E%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3Epd%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3Etidb%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E%3Cspan%3E192.168.1%3C%2Fspan%3E.204%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3Etidb%2Cmonitoring%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3Esn-data-node-1%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E%3Cspan%3E192.168.1%3C%2Fspan%3E%3Cspan%3E.216%3C%2Fspan%3E%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3Etidb%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3Esn-data-node-2%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E%3Cspan%3E192.168.1%3C%2Fspan%3E.217%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3Etidb%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3Etikv-4%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E%3Cspan%3E192.168.1%3C%2Fspan%3E%3Cspan%3E.218%3C%2Fspan%3E%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3Etikv(%E6%9C%89%E5%9D%8Fregion)%3C%2Ftd%3E%3C%2Ftr%3E%3C%2Ftbody%3E%3C%2Ftable%3E%22%2C%22id%22%3A%22STYnR%22%7D\"></card><p><br /></p><h2 id=\"H7w7e\">悲催之始</h2><p><br /></p><p>上午coding正嗨，突发性停电</p><p>来电后 ssh 到 tidb的ansible主控机 <code>ansible-playbook start.yml</code> </p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564644740298-54b52606-d594-4ba7-b98c-0cb6c21137df.png%22%2C%22originWidth%22%3A1329%2C%22originHeight%22%3A527%2C%22name%22%3A%22image.png%22%2C%22size%22%3A82800%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1329%2C%22height%22%3A527%7D\"></card></p><p><br /></p><p>事情有点不妙，但是扔不死心的， <code>stop and start</code> 一通后，仍是这个结果。事情有点大条。</p><p><br /></p><p>好在之前偷偷潜伏到TiDB的官方群里，没事就听各位大佬吹水打屁，多少受了点熏陶。撸起袖子，开搞。</p><p><br /></p><h2 id=\"TCaY3\">定位问题</h2><h3 id=\"ckulg\">Round 1 懵逼树上懵逼果</h3><p>先看官方文档</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564648950258-956bb3fb-25de-467f-b6cf-82a7df480f49.png%22%2C%22originWidth%22%3A1261%2C%22originHeight%22%3A604%2C%22name%22%3A%22image.png%22%2C%22size%22%3A102094%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1261%2C%22height%22%3A604%7D\"></card></p><p>好吧，跟没看区别不大。</p><p><br /></p><p>既然是tidb起不来，就先看tidb的日志(实际上应该看http://p<span class=\"lake-fontsize-10\" style=\"color: #333333;\">rometheus:</span>9090/targets ，因为不太熟悉，所以走了弯路，为嘛不看grafana,是因为tidb那卡到后，ansible就自动退出了，没有起grafana)</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564648871805-b912a3d1-b5bd-456a-9d4c-8e7db9a47678.png%22%2C%22originWidth%22%3A1206%2C%22originHeight%22%3A558%2C%22name%22%3A%22image.png%22%2C%22size%22%3A122785%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1206%2C%22height%22%3A558%7D\"></card></p><p>暴露的是连接两个tikv报错，这是前期比较关键的线索，起码有初步排查方向了。</p><p>另外从日志看到，疑似报空间不足，实际上没意义，在两台tikv执行 <code>df -i</code> <code>df -h</code> 来看，都很充足。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564649022668-c8585d09-5958-4143-8314-05fd56deccb4.png%22%2C%22originWidth%22%3A1538%2C%22originHeight%22%3A88%2C%22name%22%3A%22image.png%22%2C%22size%22%3A21191%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1538%2C%22height%22%3A88%7D\"></card></p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564649493786-8d8b7428-0cde-447a-a69f-8b4eeeff6f19.png%22%2C%22originWidth%22%3A556%2C%22originHeight%22%3A806%2C%22name%22%3A%22image.png%22%2C%22size%22%3A109795%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A556%2C%22height%22%3A806%7D\"></card></p><p>群内 @张曾钧@PingCAP 大佬开始介入，并且开始了将近8个小时的细心和耐心的指导，讲真，PingCAP团队是我见过最热心耐心的团队，素未蒙面，但乐于助人[呲牙]</p><p><br /></p><p>此时，通过看官方文档，尝试性，试了下Prometheus可以打开，</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564649685360-a05e8e44-b756-4fdd-ab74-1032893b8820.png%22%2C%22originWidth%22%3A497%2C%22originHeight%22%3A522%2C%22name%22%3A%22image.png%22%2C%22size%22%3A38639%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A497%2C%22height%22%3A522%7D\"></card></p><p>能看出有两个TiKV down掉，正好是上面两个。PS ,我是事后才发现的，当时我一直认为TiKV是起来的[捂脸]</p><p>插播一下，<a href=\"https://pingcap.com/docs-cn/v3.0/architecture/\" target=\"_blank\">TiDB 整体架构</a> ，不多解释。建议看看，可以了解一下TiDB的架构原理，比如，TiDB,TiKV,PD等的职责。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564649874173-be2c66cd-022a-446b-bed8-fadd92e8c0fa.png%22%2C%22originWidth%22%3A1996%2C%22originHeight%22%3A1112%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1996%2C%22height%22%3A1112%7D\"></card></p><blockquote><p><span>小结： Round 1 以找出两个TiKV down结束，效率低到羞愧。</span></p></blockquote><p><br /></p><h3 id=\"wnRsx\">Round 2 懵逼树前排排坐</h3><p>注意，下面如无特殊说明，一律是TiKV关掉状态下，执行命令。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564650252340-21759119-1843-4434-867a-9963ea765209.png%22%2C%22originWidth%22%3A547%2C%22originHeight%22%3A905%2C%22name%22%3A%22image.png%22%2C%22size%22%3A98917%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A547%2C%22height%22%3A905%7D\"></card><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564650290157-89fc6eec-843d-4e59-a186-c45f21487c44.png%22%2C%22originWidth%22%3A552%2C%22originHeight%22%3A856%2C%22name%22%3A%22image.png%22%2C%22size%22%3A112176%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A552%2C%22height%22%3A856%7D\"></card></p><p>使用@唐刘@PingCAP的方法 <code>grep -B 50 Welcome</code> ,开始接触事发原因了。</p><blockquote><p>更多的grep的方法(-A -B -C)，参考 man grep 或者 <a href=\"http://man7.org/linux/man-pages/man1/grep.1.html\" target=\"_blank\">GREP(1)</a> ，因为tikv启动会打印Welcome，所以有理由认为，每次的Welcome之前的，肯定是上次退出的原因。</p></blockquote><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564650861003-ced69111-e25b-4e7a-91fa-1e07eeead844.png%22%2C%22originWidth%22%3A1530%2C%22originHeight%22%3A850%2C%22name%22%3A%22image.png%22%2C%22size%22%3A211744%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1530%2C%22height%22%3A850%7D\"></card></p><p>至此，出现了第一个坏掉的region。</p><p>当时执行了 <code>./pd-ctl store -d -u http://127.0.0.1:2379</code> </p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564651001470-549e9680-0b9f-47dd-9713-3e4833167f6e.png%22%2C%22originWidth%22%3A1059%2C%22originHeight%22%3A554%2C%22name%22%3A%22image.png%22%2C%22size%22%3A55248%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1059%2C%22height%22%3A554%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564650935734-5b346583-f35d-4b50-a788-0bc7840a30d3.png%22%2C%22originWidth%22%3A399%2C%22originHeight%22%3A448%2C%22name%22%3A%22image.png%22%2C%22size%22%3A18168%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A399%2C%22height%22%3A448%7D\"></card></p><p>找到挂掉的两个TiKV的store id，跟上图的<card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564651146956-35cba4a9-55f6-4577-b434-264f20faea47.png%22%2C%22originWidth%22%3A125%2C%22originHeight%22%3A46%2C%22name%22%3A%22image.png%22%2C%22size%22%3A3516%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A125%2C%22height%22%3A46%7D\"></card><span> 68935能对起来。</span></p><p><span><br /></span></p><p>此时救苦救难的 <card type=\"inline\" name=\"mention\"></card> 大佬 提供了 <a href=\"https://pingcap.com/docs-cn/v3.0/reference/tools/tikv-control/#恢复损坏的-mvcc-数据\" target=\"_blank\">TiKV Control 使用说明#恢复损坏的-mvcc-数据</a></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564651249500-2b1a9f82-1b58-4969-8601-1bc01e2402e8.png%22%2C%22originWidth%22%3A551%2C%22originHeight%22%3A675%2C%22name%22%3A%22image.png%22%2C%22size%22%3A81077%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A551%2C%22height%22%3A675%7D\"></card><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564651219522-f6219985-567d-487c-bafd-71983748cb57.png%22%2C%22originWidth%22%3A1248%2C%22originHeight%22%3A682%2C%22name%22%3A%22image.png%22%2C%22size%22%3A108238%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1248%2C%22height%22%3A682%7D\"></card></p><p>实际上执行后，没啥效果，后来发现是因为此region超过一半副本出问题了，recover-mvcc 没法恢复。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564652211716-e27ec913-9262-4429-a3bb-9a9043625b65.png%22%2C%22originWidth%22%3A857%2C%22originHeight%22%3A49%2C%22name%22%3A%22image.png%22%2C%22size%22%3A7616%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A857%2C%22height%22%3A49%7D\"></card></p><blockquote><p>Round 2 结束，找到了救命稻草，TiKV Control 和PD Control,但是，事情远没这么简单。</p></blockquote><p><br /></p><h3 id=\"EyoeN\">Round 3 渐入佳境</h3><p>中间出了个差点搞死自己的小插曲</p><p><code>/home/tidb/tidb-ansible/resources/bin/pd-ctl -u &quot;http://172.16.10.1:2379&quot; -d store delete 10</code> 自作聪明的以为，TiKV 已经没救了，执行了store delete 操作。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564651626772-b211f752-e5e4-4786-b1bd-0ba2b23557cb.png%22%2C%22originWidth%22%3A1301%2C%22originHeight%22%3A602%2C%22name%22%3A%22image.png%22%2C%22size%22%3A92940%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1301%2C%22height%22%3A602%7D\"></card></p><p>但是实际上还有救，所以又变成了，如何把已经delete掉的store，再度挂上去。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564651566804-822ec7d1-84f8-41f5-936f-7ed676bd83d0.png%22%2C%22originWidth%22%3A552%2C%22originHeight%22%3A503%2C%22name%22%3A%22image.png%22%2C%22size%22%3A62399%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A552%2C%22height%22%3A503%7D\"></card></p><p>根据 <card type=\"inline\" name=\"mention\"></card> 大佬的 <code>curl -X POST http://${pd_ip}:2379/pd/api/v1/store/${store_id}/state?state=Up</code> 成功挂上，当然还是down的状态。</p><p><br /></p><p>根据<card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564652020901-07018aee-c4fa-49b8-bc3c-fbf3e6c79338.png%22%2C%22originWidth%22%3A1269%2C%22originHeight%22%3A352%2C%22name%22%3A%22image.png%22%2C%22size%22%3A68592%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1269%2C%22height%22%3A352%7D\"></card></p><p><code>tikv-ctl --db /path/to/tikv/db bad-regions</code> 两台坏的，分别如下</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564651955786-839ddeb4-24c4-48ea-ac4c-5388070ad861.png%22%2C%22originWidth%22%3A1008%2C%22originHeight%22%3A84%2C%22name%22%3A%22image.png%22%2C%22size%22%3A15053%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1008%2C%22height%22%3A84%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564652396271-4b1eb843-e26f-49e4-99c3-b69dfb1ca5f3.png%22%2C%22originWidth%22%3A813%2C%22originHeight%22%3A53%2C%22name%22%3A%22image.png%22%2C%22size%22%3A9564%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A813%2C%22height%22%3A53%7D\"></card></p><p>发现坏掉的 region是 31101（实际上因为用的是2.1.4，每次只显示一个，处理完后，才会显示下一个，效率很低，后来在 <card type=\"inline\" name=\"mention\" value=\"data:%7B%22login%22%3A%22%22%2C%22name%22%3A%22%E6%88%9A%E9%93%AE%22%7D\"></card> 大佬的指导下，换用tikv-ctl 3.x ，每次可以显示全部的坏的region ）</p><p>在好的节点上执行，也不是文中的all regions are healthy ，实际上是因为，数据文件被占用，没法获取句柄，停掉就行 <code>ansible-playbook stop.yml  -l tikv_servers</code> 停掉全部tikv节点</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564652278072-088aa64f-abf6-422e-bb3d-8f48911b1bcc.png%22%2C%22originWidth%22%3A1328%2C%22originHeight%22%3A150%2C%22name%22%3A%22image.png%22%2C%22size%22%3A26658%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1328%2C%22height%22%3A150%7D\"></card></p><p><br /></p><p>此时<span>@张曾钧@PingCAP</span> 提示用 <code>tikv-ctl --db /path/to/tikv/db tombstone -p 127.0.0.1:2379 -r</code> <span>  把坏的 region 设置为tombstone ，但是报错</span></p><p><span><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564652514513-9392a0eb-14f1-4db0-9b53-913755ab9c2e.png%22%2C%22originWidth%22%3A984%2C%22originHeight%22%3A55%2C%22name%22%3A%22image.png%22%2C%22size%22%3A12889%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A984%2C%22height%22%3A55%7D\"></card></span></p><p><span><br /></span></p><p><span>通过执行 pd-ctl region 31101 发现</span></p><p><span><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564652666941-f219b6a8-177d-49fe-97cd-0c4b598c9b6f.png%22%2C%22originWidth%22%3A920%2C%22originHeight%22%3A471%2C%22name%22%3A%22image.png%22%2C%22size%22%3A44057%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A920%2C%22height%22%3A471%7D\"></card></span></p><p><span><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564652692433-3691b53b-baf4-4a07-b48b-04baffb296a5.png%22%2C%22originWidth%22%3A339%2C%22originHeight%22%3A252%2C%22name%22%3A%22image.png%22%2C%22size%22%3A8996%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A339%2C%22height%22%3A252%7D\"></card></span></p><p>这个region有两个副本是在坏节点上，超过一半损坏（剧透一下，实际上最后发现，出问题的都是损坏超过1半的，1/3的都自己恢复了）</p><p><br /></p><p>尝试执行 operator add remove-peer 发现删不掉。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564652808996-cc279c2f-ba16-411e-8eb5-c00c43839a64.png%22%2C%22originWidth%22%3A992%2C%22originHeight%22%3A501%2C%22name%22%3A%22image.png%22%2C%22size%22%3A89355%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A992%2C%22height%22%3A501%7D\"></card></p><p><br /></p><p>此时 <card type=\"inline\" name=\"mention\"></card><span>戚铮</span> 大佬出场。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564652991806-2c3f7356-46a3-4661-8d94-fe002d67e420.png%22%2C%22originWidth%22%3A530%2C%22originHeight%22%3A724%2C%22name%22%3A%22image.png%22%2C%22size%22%3A86534%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A530%2C%22height%22%3A724%7D\"></card></p><p>经过一番测试，发现 region31101很坚挺，使用 <code>recover-mvcc</code>  恢复不了，前面说了是因为损失超过一半副本的原因，使用 <code>operator add remove-peer</code> 删不了，估计也是。</p><p><br /></p><h3 id=\"zvbGH\">Round 4 貌似解决</h3><p>不能因为一颗老鼠屎，坏了一锅汤，部分region坏掉了，先尝试强制恢复试试，保证别的正常吧。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564653280296-469366c4-a6ae-47a8-a497-40bd7ce7fa06.png%22%2C%22originWidth%22%3A1256%2C%22originHeight%22%3A582%2C%22name%22%3A%22image.png%22%2C%22size%22%3A110748%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1256%2C%22height%22%3A582%7D\"></card></p><p>注意此命令是在好的store上执行</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564653489333-def691f2-726e-475c-a4ca-8cd7ee40e793.png%22%2C%22originWidth%22%3A610%2C%22originHeight%22%3A45%2C%22name%22%3A%22image.png%22%2C%22size%22%3A6467%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A610%2C%22height%22%3A45%7D\"></card></p><p>此时启动TiKV集群，执行region 31101，坏掉的已经删掉了，但是服务还是起不来。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564653530458-02c011c8-20fd-4a2f-a05f-8c93515c609f.png%22%2C%22originWidth%22%3A523%2C%22originHeight%22%3A495%2C%22name%22%3A%22image.png%22%2C%22size%22%3A27235%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A523%2C%22height%22%3A495%7D\"></card></p><p>此时执行 <card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564653616113-ab0e4831-4813-4e58-b7d5-ee49b9e86b87.png%22%2C%22originWidth%22%3A1035%2C%22originHeight%22%3A78%2C%22name%22%3A%22image.png%22%2C%22size%22%3A12329%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1035%2C%22height%22%3A78%7D\"></card></p><p><br /></p><p>此时在 <card type=\"inline\" name=\"mention\" value=\"data:%7B%22login%22%3A%22%22%2C%22name%22%3A%22%E6%88%9A%E9%93%AE%22%7D\"></card> 老大的指导下，升级 tikv-ctl ,</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564653856567-a2abc9d6-4f8f-4cf6-bd5f-96fa3a2f6e0a.png%22%2C%22originWidth%22%3A1322%2C%22originHeight%22%3A695%2C%22name%22%3A%22image.png%22%2C%22size%22%3A117796%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1322%2C%22height%22%3A695%7D\"></card></p><p>结果202这台，一共三个region坏了，处理了俩，感觉遥遥无期，下了tikv-ctl 3.x后发现，就还有一个坏的。胜利在望。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564653924392-b0be58c8-e5f3-4d82-97f7-f5e9e21e6340.png%22%2C%22originWidth%22%3A682%2C%22originHeight%22%3A83%2C%22name%22%3A%22image.png%22%2C%22size%22%3A9300%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A682%2C%22height%22%3A83%7D\"></card></p><p><br /></p><p>重复上述操作后，此节点终于up了</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564653986410-df4091d6-436f-4f1c-ba65-0b86d4012df0.png%22%2C%22originWidth%22%3A488%2C%22originHeight%22%3A369%2C%22name%22%3A%22image.png%22%2C%22size%22%3A23247%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A488%2C%22height%22%3A369%7D\"></card></p><p><br /></p><p>218这个有6个坏的</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564654011573-d22aa7a1-cddd-4e14-9537-31dd02f76212.png%22%2C%22originWidth%22%3A749%2C%22originHeight%22%3A154%2C%22name%22%3A%22image.png%22%2C%22size%22%3A20993%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A749%2C%22height%22%3A154%7D\"></card></p><p><code>unsafe-recover remove-fail-stores</code>  一通后，终于起来服务了。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564654127217-6f3318f9-1f93-4cee-b64f-649125144a59.png%22%2C%22originWidth%22%3A697%2C%22originHeight%22%3A783%2C%22name%22%3A%22image.png%22%2C%22size%22%3A76233%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A697%2C%22height%22%3A783%7D\"></card></p><p><br /></p><blockquote><p>Round 4 服务已可以启动，总结一下</p><ol start=\"1\"><li>先stop tikv</li><li>如果坏的region少于一半，可以尝试 recover-mvcc</li><li>如果超过一半，就玄乎了，是在不行就 unsafe-recover remove-fail-stores,然后再 tikv-ctl --db /path/to/tikv/db tombstone -p 127.0.0.1:2379 -r 31101,xx,xx,xx </li><li>再start tikv</li></ol></blockquote><p><br /></p><h3 id=\"58Wno\">Round 5 最终局</h3><p>你以为万事大吉了？命运就是爱捉弄人。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564654457090-8b4b7bc1-c86b-46f9-bd8c-770334b1581a.png%22%2C%22originWidth%22%3A549%2C%22originHeight%22%3A520%2C%22name%22%3A%22image.png%22%2C%22size%22%3A59936%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A549%2C%22height%22%3A520%7D\"></card></p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564654496584-e2f090a0-2837-4979-9d1e-ba278925441f.png%22%2C%22originWidth%22%3A1459%2C%22originHeight%22%3A637%2C%22name%22%3A%22image.png%22%2C%22size%22%3A107875%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1459%2C%22height%22%3A637%7D\"></card></p><p>回到原点。</p><p><br /></p><p>最后还是损失了部分，但是量不大。</p><p><br /></p><h2 id=\"mYLTJ\">总结</h2><ol start=\"1\"><li>对TiDB不够熟悉，很多流于表面</li><li>对TiDB的文档和工具使用不熟练</li><li>TiDB的文档不太清晰，比如在故障处理里，没有内链像是pd-ctl,tikv-ctl，甚至都没有提，在pd-ctl和tikv-ctl等工具没有提如何下载，在工具下载里，没有提包含啥工具。很佛系</li><li>多亏了群内各位大佬的热心指导</li><li>如果是tikv有问题，先stop tikv</li><li>如果对于损坏数小于半数的，可以尝试 <span>recover-mvcc</span></li><li>对于超过半数的，可以尝试 <span>unsafe-recover remove-fail-stores ，再 将store设置 </span><span>tombstone</span></li><li>再start tikv</li><li>可以结合 <span><a href=\"https://www.cnblogs.com/vansky/p/9415551.html\" target=\"_blank\">tidb损坏tikv节点怎么恢复集群</a> 来做。</span></li><li>多试验，尤其是做极限测试，并且尝试处理，会积累很多经验。</li><li>虽然没有瑞恩没有全须全尾的拯救回来，但是缺胳膊少腿总好过没命啊。</li></ol><p><br /></p><h2 id=\"Gf6U8\">一点小广告</h2><p>其实如果不考虑OLTP的场景，还可以尝试使用clickhouse。这是之前整理的clickhouse的一些文章。</p><ul><li><a href=\"https://anjia0532.github.io/2019/07/08/redash/\" target=\"_blank\">031-数据可视化之redash(支持43种数据源)</a></li><li><a href=\"https://anjia0532.github.io/2019/07/17/mysql-to-clickhouse/\" target=\"_blank\">033-史上最全-mysql迁移到clickhouse的5种办法</a></li><li><a href=\"https://anjia0532.github.io/2019/07/22/sdc-jdbc-full-mode/\" target=\"_blank\">035-解决streamsets jdbc全量模式数据重复问题</a></li></ul><p><br /></p><h2 id=\"7y7Px\">参考资料</h2><ul><li><a href=\"http://anjia0532.github.io/2019/08/01/tidb-tikv-bad-regions\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d42f942f265da03d60ee060\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://github.com/pingcap/tidb/issues/10596\" target=\"_blank\">failed to write to engine #10596</a></li><li><a href=\"https://pingcap.com/docs-cn/v3.0/how-to/scale/with-ansible/\" target=\"_blank\">使用 TiDB-Ansible 扩容缩容 TiDB 集群</a></li><li><a href=\"https://pingcap.com/docs-cn/v3.0/how-to/troubleshoot/cluster-setup/\" target=\"_blank\">TiDB 集群故障诊断</a></li><li><a href=\"https://pingcap.com/docs-cn/v3.0/reference/tools/pd-control/\" target=\"_blank\">PD Control 使用说明</a></li><li><a href=\"https://pingcap.com/docs-cn/v3.0/reference/tools/tikv-control/\" target=\"_blank\">TiKV Control 使用说明</a></li><li><a href=\"https://pingcap.com/docs-cn/v3.0/reference/tools/download/\" target=\"_blank\">TiDB 工具下载</a></li><li><a href=\"https://www.cnblogs.com/vansky/p/9415551.html\" target=\"_blank\">tidb损坏tikv节点怎么恢复集群</a></li><li><a href=\"https://pingcap.com/cases-cn/\" target=\"_blank\">Tidb用户案例<cursor /></a></li></ul>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-08-02T00:36:32.000Z",
    "deleted_at": null,
    "created_at": "2019-07-31T13:57:34.000Z",
    "updated_at": "2019-08-02T00:36:33.000Z",
    "published_at": "2019-08-02T00:36:32.000Z",
    "first_published_at": "2019-08-01T14:37:27.000Z",
    "word_count": 2275,
    "cover": "",
    "description": "date: 2019-08-01 22:35:41tags: [数据库,mysql,database,tidb,tikv,dba]categories: 数据库---这是坚持技术写作计划（含翻译）的第38篇，定个小目标999，每周最少2篇。很喜欢TiDB的设计哲学，比如，数据库就活该要么OLA...",
    "custom_description": "很喜欢TiDB的设计哲学，比如，数据库就活该要么OLAP，要么OLTP么，为嘛就不能兼顾一下？数据量大了后，就一定要反人类的分库分表么？你当分库分表好玩么？分库一时爽，维护火葬场！\n尤其在一些中小型团队里，为了数据分析搞一套hadoop，约等于为了喝牛奶，从牛崽开始养一头奶牛。一路上明坑暗坑不断。\n",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 2223476,
    "slug": "vagrant-startup-run-rsync",
    "title": "037-vagrant启动(up)后自动同步文件(rsync-auto)",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-08-14 12:30:00<br />tags: [虚拟机,kvm,vagrant,virtualbox,python]<br />categories: python<br />---\n\n> 这是坚持技术写作计划（含翻译）的第37篇，定个小目标999，每周最少2篇。\n\n\n本文介绍两种vagrant up后自动同步文件(rsync) 分别基于 `sync` 和 `nfs` (如果不设置的话，需要再起一个终端，单独运行 `vagrant rsync-auto` )\n\n另外可以参考我的 [036-win10搭建python的linux开发环境(pycharm+vagrant+virtualbox)](https://juejin.im/post/5d3a55ece51d454f71439dd2)\n\n<!-- more -->\n<a name=\"M2lMe\"></a>\n## sync\n\n```bash\n  config.vm.synced_folder \".\", \"/vagrant\", type: \"rsync\",\n    # rsync__verbose: true,\n    # rsync__auto: true,\n    rsync__exclude: ['.git*', 'node_modules*','*.log','*.box','Vagrantfile']\n\n  config.trigger.after :up do |t|\n   t.info = \"rsync auto\"\n   t.run = {inline: \"vagrant rsync-auto\"}\n    # 如果想后台运行，则使用下面语句\n    # t.run = {inline: \"bash -c 'vagrant rsync-auto &'\"}\n  end\n```\n\n参考 [Vagrant Does not Start RSync-Auto on Up or Reload#briancain's reply](https://github.com/hashicorp/vagrant/issues/10002#issuecomment-419503397)\n\n<a name=\"3GPil\"></a>\n## nfs\n\n经测试，在win10上，需要安装插件（vagrant-vbguest vagrant-winnfsd）\n\n```bash\nvagrant plugin install vagrant-vbguest vagrant-winnfsd\n```\n如果报\n\n```bash\nInstalling the 'vagrant-vbguest' plugin. This can take a few minutes...\nERROR:  SSL verification error at depth 3: unable to get local issuer certificate (20)\nERROR:  You must add /C=US/O=Starfield Technologies, Inc./OU=Starfield Class 2 Certification Authority to your local trusted store\nVagrant failed to load a configured plugin source. This can be caused\nby a variety of issues including: transient connectivity issues, proxy\nfiltering rejecting access to a configured plugin source, or a configured\nplugin source not responding correctly. Please review the error message\nbelow to help resolve the issue:\n\n  SSL_connect returned=1 errno=0 state=error: certificate verify failed (https://gems.hashicorp.com/specs.4.8.gz)\n\nSource: https://gems.hashicorp.com/\n```\n需要设置CAfile\n\n```bash\nset SSL_CERT_FILE=\"path\\to\\Vagrant\\embedded\\cacert.pem\"\n```\n如果下载速度慢，并且有境外代理服务器，可以考虑设置代理\n\n```bash\nset http_proxy=http://username:password@ip:port\nset https_proxy=http://username:password@ip:port\n```\n\n设置Vagrantfile\n```bash\n  # ... 忽略无关内容\n  config.vm.synced_folder \".\", \"/vagrant\",\n     type:\"nfs\"\n  # ... 忽略无关内容\n```\n\n<a name=\"qruRF\"></a>\n## 参考资料\n\n- [我的博客](https://anjia0532.github.io/2019/08/14/vagrant-startup-run-rsync/)\n- [我的掘金](https://juejin.im/post/5d562b5e5188252d43756db8)\n- [Vagrant Does not Start RSync-Auto on Up or Reload#briancain's reply](https://github.com/hashicorp/vagrant/issues/10002#issuecomment-419503397)\n- [How to speed up Vagrant on Windows 10 using NFS](https://peshmerge.io/how-to-speed-up-vagrant-on-windows-10-using-nfs/)\n",
    "body_draft": "",
    "body_html": "<p><span style=\"background-color: transparent;\">date: 2019-08-14 12:30:00</span></p><p>tags: [<span>虚拟机,kvm,vagrant,virtualbox,python</span>]</p><p>categories: <span>python</span></p><p>---</p><p><br /></p><blockquote><p><span>这是坚持技术写作计划（含翻译）的第37篇，定个小目标999，每周最少2篇。</span></p></blockquote><p><br /></p><p>本文介绍两种vagrant up后自动同步文件(rsync) 分别基于 <code>sync</code> 和 <code>nfs</code> (如果不设置的话，需要再起一个终端，单独运行 <code>vagrant rsync-auto</code> )</p><p><br /></p><p>另外可以参考我的 <a href=\"https://juejin.im/post/5d3a55ece51d454f71439dd2\" target=\"_blank\">036-win10搭建python的linux开发环境(pycharm+vagrant+virtualbox)</a></p><p><br /></p><p>&lt;!-- more --&gt;</p><h2 id=\"M2lMe\">sync</h2><p><br /></p><pre data-lang=\"bash\"><code>  config.vm.synced_folder &quot;.&quot;, &quot;/vagrant&quot;, type: &quot;rsync&quot;,\n    # rsync__verbose: true,\n    # rsync__auto: true,\n    rsync__exclude: ['.git*', 'node_modules*','*.log','*.box','Vagrantfile']\n\n  config.trigger.after :up do |t|\n   t.info = &quot;rsync auto&quot;\n   t.run = {inline: &quot;vagrant rsync-auto&quot;}\n    # 如果想后台运行，则使用下面语句\n    # t.run = {inline: &quot;bash -c 'vagrant rsync-auto &amp;'&quot;}\n  end</code></pre><p><br /></p><p>参考 <a href=\"https://github.com/hashicorp/vagrant/issues/10002#issuecomment-419503397\" target=\"_blank\"><span>Vagrant Does not Start RSync-Auto on Up or Reload#briancain's reply</span></a></p><p><span><br /></span></p><h2 id=\"3GPil\">nfs</h2><p><br /></p><p>经测试，在win10上，需要安装插件（vagrant-vbguest vagrant-winnfsd）</p><p><br /></p><pre data-lang=\"bash\"><code>vagrant plugin install vagrant-vbguest vagrant-winnfsd</code></pre><p>如果报</p><p><br /></p><pre data-lang=\"bash\"><code>Installing the 'vagrant-vbguest' plugin. This can take a few minutes...\nERROR:  SSL verification error at depth 3: unable to get local issuer certificate (20)\nERROR:  You must add /C=US/O=Starfield Technologies, Inc./OU=Starfield Class 2 Certification Authority to your local trusted store\nVagrant failed to load a configured plugin source. This can be caused\nby a variety of issues including: transient connectivity issues, proxy\nfiltering rejecting access to a configured plugin source, or a configured\nplugin source not responding correctly. Please review the error message\nbelow to help resolve the issue:\n\n  SSL_connect returned=1 errno=0 state=error: certificate verify failed (https://gems.hashicorp.com/specs.4.8.gz)\n\nSource: https://gems.hashicorp.com/</code></pre><p>需要设置CAfile</p><p><br /></p><pre data-lang=\"bash\"><code>set SSL_CERT_FILE=&quot;path\\to\\Vagrant\\embedded\\cacert.pem&quot;</code></pre><p>如果下载速度慢，并且有境外代理服务器，可以考虑设置代理</p><p><br /></p><pre data-lang=\"bash\"><code>set http_proxy=http://username:password@ip:port\nset https_proxy=http://username:password@ip:port</code></pre><p><br /></p><p>设置Vagrantfile</p><pre data-lang=\"bash\"><code>  # ... 忽略无关内容\n  config.vm.synced_folder &quot;.&quot;, &quot;/vagrant&quot;,\n     type:&quot;nfs&quot;\n  # ... 忽略无关内容</code></pre><p><br /></p><h2 id=\"qruRF\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/08/14/vagrant-startup-run-rsync/\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d562b5e5188252d43756db8\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://github.com/hashicorp/vagrant/issues/10002#issuecomment-419503397\" target=\"_blank\">Vagrant Does not Start RSync-Auto on Up or Reload#briancain's reply</a></li><li><a href=\"https://peshmerge.io/how-to-speed-up-vagrant-on-windows-10-using-nfs/\" target=\"_blank\">How to speed up Vagrant on Windows 10 using NFS</a></li></ul>",
    "body_lake": "<!doctype lake><meta name=\"doc-version\" content=\"1\" /><p><span style=\"background-color: transparent;\">date: 2019-08-14 12:30:00</span></p><p>tags: [<span>虚拟机,kvm,vagrant,virtualbox,python</span>]</p><p>categories: <span>python</span></p><p>---</p><p><br /></p><blockquote><p><span>这是坚持技术写作计划（含翻译）的第37<cursor />篇，定个小目标999，每周最少2篇。</span></p></blockquote><p><br /></p><p>本文介绍两种vagrant up后自动同步文件(rsync) 分别基于 <code>sync</code> 和 <code>nfs</code> (如果不设置的话，需要再起一个终端，单独运行 <code>vagrant rsync-auto</code> )</p><p><br /></p><p>另外可以参考我的 <a href=\"https://juejin.im/post/5d3a55ece51d454f71439dd2\" target=\"_blank\">036-win10搭建python的linux开发环境(pycharm+vagrant+virtualbox)</a></p><p><br /></p><p>&lt;!-- more --&gt;</p><h2 id=\"M2lMe\">sync</h2><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%20%20config.vm.synced_folder%20%5C%22.%5C%22%2C%20%5C%22%2Fvagrant%5C%22%2C%20type%3A%20%5C%22rsync%5C%22%2C%5Cn%20%20%20%20%23%20rsync__verbose%3A%20true%2C%5Cn%20%20%20%20%23%20rsync__auto%3A%20true%2C%5Cn%20%20%20%20rsync__exclude%3A%20%5B'.git*'%2C%20'node_modules*'%2C'*.log'%2C'*.box'%2C'Vagrantfile'%5D%5Cn%5Cn%20%20config.trigger.after%20%3Aup%20do%20%7Ct%7C%5Cn%20%20%20t.info%20%3D%20%5C%22rsync%20auto%5C%22%5Cn%20%20%20t.run%20%3D%20%7Binline%3A%20%5C%22vagrant%20rsync-auto%5C%22%7D%5Cn%20%20%20%20%23%20%E5%A6%82%E6%9E%9C%E6%83%B3%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C%EF%BC%8C%E5%88%99%E4%BD%BF%E7%94%A8%E4%B8%8B%E9%9D%A2%E8%AF%AD%E5%8F%A5%5Cn%20%20%20%20%23%20t.run%20%3D%20%7Binline%3A%20%5C%22bash%20-c%20'vagrant%20rsync-auto%20%26'%5C%22%7D%5Cn%20%20end%22%2C%22id%22%3A%22jPssU%22%7D\"></card><p><br /></p><p>参考 <a href=\"https://github.com/hashicorp/vagrant/issues/10002#issuecomment-419503397\" target=\"_blank\"><span>Vagrant Does not Start RSync-Auto on Up or Reload#briancain's reply</span></a></p><p><span><br /></span></p><h2 id=\"3GPil\">nfs</h2><p><br /></p><p>经测试，在win10上，需要安装插件（vagrant-vbguest vagrant-winnfsd）</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22vagrant%20plugin%20install%20vagrant-vbguest%20vagrant-winnfsd%22%2C%22id%22%3A%2283zGi%22%7D\"></card><p>如果报</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22Installing%20the%20'vagrant-vbguest'%20plugin.%20This%20can%20take%20a%20few%20minutes...%5CnERROR%3A%20%20SSL%20verification%20error%20at%20depth%203%3A%20unable%20to%20get%20local%20issuer%20certificate%20(20)%5CnERROR%3A%20%20You%20must%20add%20%2FC%3DUS%2FO%3DStarfield%20Technologies%2C%20Inc.%2FOU%3DStarfield%20Class%202%20Certification%20Authority%20to%20your%20local%20trusted%20store%5CnVagrant%20failed%20to%20load%20a%20configured%20plugin%20source.%20This%20can%20be%20caused%5Cnby%20a%20variety%20of%20issues%20including%3A%20transient%20connectivity%20issues%2C%20proxy%5Cnfiltering%20rejecting%20access%20to%20a%20configured%20plugin%20source%2C%20or%20a%20configured%5Cnplugin%20source%20not%20responding%20correctly.%20Please%20review%20the%20error%20message%5Cnbelow%20to%20help%20resolve%20the%20issue%3A%5Cn%5Cn%20%20SSL_connect%20returned%3D1%20errno%3D0%20state%3Derror%3A%20certificate%20verify%20failed%20(https%3A%2F%2Fgems.hashicorp.com%2Fspecs.4.8.gz)%5Cn%5CnSource%3A%20https%3A%2F%2Fgems.hashicorp.com%2F%22%2C%22id%22%3A%224Mz2n%22%7D\"></card><p>需要设置CAfile</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22set%20SSL_CERT_FILE%3D%5C%22path%5C%5Cto%5C%5CVagrant%5C%5Cembedded%5C%5Ccacert.pem%5C%22%22%2C%22id%22%3A%22rzI1M%22%7D\"></card><p>如果下载速度慢，并且有境外代理服务器，可以考虑设置代理</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22set%20http_proxy%3Dhttp%3A%2F%2Fusername%3Apassword%40ip%3Aport%5Cnset%20https_proxy%3Dhttp%3A%2F%2Fusername%3Apassword%40ip%3Aport%22%2C%22id%22%3A%22RATVa%22%7D\"></card><p><br /></p><p>设置Vagrantfile</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%20%20%23%20...%20%E5%BF%BD%E7%95%A5%E6%97%A0%E5%85%B3%E5%86%85%E5%AE%B9%5Cn%20%20config.vm.synced_folder%20%5C%22.%5C%22%2C%20%5C%22%2Fvagrant%5C%22%2C%5Cn%20%20%20%20%20type%3A%5C%22nfs%5C%22%5Cn%20%20%23%20...%20%E5%BF%BD%E7%95%A5%E6%97%A0%E5%85%B3%E5%86%85%E5%AE%B9%22%2C%22id%22%3A%2256QJz%22%7D\"></card><p><br /></p><h2 id=\"qruRF\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/08/14/vagrant-startup-run-rsync/\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d562b5e5188252d43756db8\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://github.com/hashicorp/vagrant/issues/10002#issuecomment-419503397\" target=\"_blank\">Vagrant Does not Start RSync-Auto on Up or Reload#briancain's reply</a></li><li><a href=\"https://peshmerge.io/how-to-speed-up-vagrant-on-windows-10-using-nfs/\" target=\"_blank\">How to speed up Vagrant on Windows 10 using NFS</a></li></ul>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-08-16T04:22:08.000Z",
    "deleted_at": null,
    "created_at": "2019-07-29T00:37:45.000Z",
    "updated_at": "2019-08-16T04:22:08.000Z",
    "published_at": "2019-08-16T04:22:08.000Z",
    "first_published_at": "2019-08-16T04:04:36.000Z",
    "word_count": 465,
    "cover": "",
    "description": "date: 2019-08-14 12:30:00tags: [虚拟机,kvm,vagrant,virtualbox,python]categories: python---这是坚持技术写作计划（含翻译）的第37篇，定个小目标999，每周最少2篇。本文介绍两种vagrant up后自动同步文件...",
    "custom_description": "date: 2019-08-14 12:30:00tags: [vagrant,python,虚拟化]categories: 虚拟化---本文介绍两种vagrant up后自动同步文件(rsync) 分别基于 sync 和 nfs (如果不设置的话，需要再起一个终端，单独运行 vagrant ...",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 2188835,
    "slug": "jumpserver-vagrant-virtualbox",
    "title": "036-win10搭建python的linux开发环境(pycharm+vagrant+virtualbox)",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-07-24 19:35:21<br />tags: [虚拟机,kvm,vagrant,virtualbox,jumpserver,堡垒机]<br />categories: python<br />---\n\n> 这是坚持技术写作计划（含翻译）的第36篇，定个小目标999，每周最少2篇。\n\n\n本文以jumpserver为例，介绍如何在windows环境下进行jumpserver开发(jumpserver依赖的一些库，只有linux环境才能用)，其实不局限于jumpserver，其他项目也适用(不限于python)。参考 [打造跨平台一致性开发环境](https://juejin.im/entry/5c6a6da5f265da2de52d7d7c/detail)\n\n<!-- more -->\n\n<a name=\"FBqFH\"></a>\n## 初始化环境\n<a name=\"DzvF8\"></a>\n### 安装vagrant+virtualbox\n参考 [Vagrant系列(一)----win10搭建Vagrant+VirtualBox环境](https://blog.csdn.net/u011781521/article/details/80275212)\n<a name=\"LDM8N\"></a>\n### 下载centos镜像\n可以使用境外服务器或者迅雷下载 `https://cloud.centos.org/centos/7/vagrant/x86_64/images/CentOS-7-x86_64-Vagrant-1905_01.VirtualBox.box` \n```bash\nvagrant box add centos/7 \\\n    https://cloud.centos.org/centos/7/vagrant/x86_64/images/CentOS-7-x86_64-Vagrant-1905_01.VirtualBox.box\n\n## 或者\n\nvagrant box add centos/7 /path/to/CentOS-7-x86_64-Vagrant-1905_01.VirtualBox.box\n```\n\n<a name=\"3o5Z3\"></a>\n### 下载jumpserver源代码并创建vagrant\n如果下载速度慢，可以使用码云(gitee.com)自己创建个镜像项目，clone码云上的jumpserver\n```bash\ngit clone --depth=1 https://github.com/jumpserver/jumpserver.git\ncd jumpserver\n```\n在jumpserver下创建Vagrantfile\n```ruby\n# -*- mode: ruby -*-\n# vi: set ft=ruby :\n\nVagrant.configure(\"2\") do |config|\n  # Every Vagrant development environment requires a box. You can search for\n  # boxes at https://vagrantcloud.com/search.\n  config.vm.box_check_update = false\n  config.vm.box = \"centos/7\"\n  config.vm.hostname = \"jumpserver\"\n  config.vm.network \"private_network\", ip: \"172.17.8.101\"\n  config.vm.provider \"virtualbox\" do |vb|\n    vb.memory = \"4096\"\n    vb.cpus = 2\n    vb.name = \"jumpserver\"\n  end\n\n  config.vm.synced_folder \".\", \"/vagrant\", type: \"rsync\",\n    rsync__verbose: true,\n    rsync__exclude: ['.git*', 'node_modules*','*.log','*.box','Vagrantfile']\n\n  config.vm.provision \"shell\", inline: <<-SHELL\nsudo curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\nsudo sed -i -e '/mirrors.cloud.aliyuncs.com/d' -e '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo\nsudo curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\nsudo yum makecache\n\nsudo yum install -y python36 python36-devel python36-pip \\\n\t\t libtiff-devel libjpeg-devel libzip-devel freetype-devel \\\n     lcms2-devel libwebp-devel tcl-devel tk-devel sshpass \\\n     openldap-devel mariadb-devel mysql-devel libffi-devel \\\n     openssh-clients telnet openldap-clients gcc\n\nmkdir /home/vagrant/.pip\ncat << EOF | sudo tee -a /home/vagrant/.pip/pip.conf\n[global]\ntimeout = 6000\nindex-url = https://mirrors.aliyun.com/pypi/simple/\n\n[install]\nuse-mirrors = true\nmirrors = https://mirrors.aliyun.com/pypi/simple/\ntrusted-host=mirrors.aliyun.com\nEOF\n\npython3.6 -m venv /home/vagrant/venv\nsource /home/vagrant/venv/bin/activate\necho \"source /home/vagrant/venv/bin/activate\" >> /home/vagrant/.bash_profile\n  SHELL\nend\n\n```\n\n```bash\ncd jumpserver\nvagrant up\nvagrant ssh\n```\n\n<a name=\"gn90K\"></a>\n### ~~安装python3.6及配置pip源~~\n如果使用我的Vargrantfile，已经自动配置阿里云源并且安装必要依赖包了，不需要重复配置\n```bash\n## 设置yum的阿里云源\nsudo curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\nsudo sed -i -e '/mirrors.cloud.aliyuncs.com/d' -e '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo\nsudo curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\nsudo yum makecache\n\n## 安装依赖包\nsudo yum install -y python36 python36-devel python36-pip \\\n\t\t libtiff-devel libjpeg-devel libzip-devel freetype-devel \\\n     lcms2-devel libwebp-devel tcl-devel tk-devel sshpass \\\n     openldap-devel mariadb-devel mysql-devel libffi-devel \\\n     openssh-clients telnet openldap-clients gcc\n\n## 配置pip阿里云源\nmkdir ~/.pip\ncat << EOF | sudo tee -a ~/.pip/pip.conf\n[global]\ntimeout = 6000\nindex-url = https://mirrors.aliyun.com/pypi/simple/\n\n[install]\nuse-mirrors = true\nmirrors = https://mirrors.aliyun.com/pypi/simple/\ntrusted-host=mirrors.aliyun.com\nEOF\n```\n\n<a name=\"YFYr7\"></a>\n### 安装依赖\n如果使用我的Vargrantfile，不需要配置python env了，已经配置好了\n```bash\nvagrant ssh\npython3.6 -m venv /home/vagrant/venv\nsource /home/vagrant/venv/bin/activate\n```\n\n只需要执行这个即可\n```bash\npip3 install -r /vagrant/requirements/requirements.txt\n```\n\n参考 [安装文档](http://docs.jumpserver.org/zh/docs/step_by_step.html)\n\n<a name=\"KRTaO\"></a>\n## 配置pycharm并启动jumpserver\n<a name=\"Mk0Vl\"></a>\n### 配置pycharm\n\n<kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>S</kbd>打开设置\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564102215460-c6a602ed-86e6-49fc-b2b1-d43689243daa.png#align=left&display=inline&height=706&name=image.png&originHeight=706&originWidth=1009&size=70204&status=done&width=1009)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564102389714-c0a5c982-1597-4007-8719-c4f316457bf8.png#align=left&display=inline&height=678&name=image.png&originHeight=678&originWidth=841&size=65908&status=done&width=841)<br />如果正常，会显示已经安装的pip包，如果是空，或者只有两个，那意味着python的env设置的不对。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564102637247-a8c69ed0-d6a2-4d00-ad3b-feebe98a0589.png#align=left&display=inline&height=674&name=image.png&originHeight=674&originWidth=1007&size=68920&status=done&width=1007)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564102989073-8062df66-c4cc-45dd-b574-db6e6a39cb6d.png#align=left&display=inline&height=739&name=image.png&originHeight=739&originWidth=1068&size=108292&status=done&width=1068)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564110989520-3f8ac63d-5b58-46b7-89bc-d24f6352785c.png#align=left&display=inline&height=706&name=image.png&originHeight=706&originWidth=1009&size=63412&status=done&width=1009)\n\n[使用 PyCharm专业版和vagrant进行同步开发](https://blog.csdn.net/weixin_42393089/article/details/83211456)\n\n<a name=\"TVFTG\"></a>\n### 修改配置并初始化数据库\n\n```bash\ncd jumpserver\ncp config_example.yml config.yml\n## 修改config.yml的相关配置\nvagrant ssh\nsource /home/vagrant/venv/bin/activate\ncd /vagrant/utils\n./make_migrations.sh\n```\n\n<a name=\"avGGO\"></a>\n### 启动项目\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564103536157-efbb24a4-c29d-45b4-991f-b314544ed548.png#align=left&display=inline&height=79&name=image.png&originHeight=79&originWidth=353&size=5532&status=done&width=353)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564103574288-28ffdb6f-25f2-4a67-b8ba-936cca59ccf3.png#align=left&display=inline&height=273&name=image.png&originHeight=273&originWidth=407&size=25404&status=done&width=407)<br />浏览器打开 [http://172.17.8.101:8080/auth/login/?next=/](http://172.17.8.101:8080/auth/login/?next=/)\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564103612991-53990854-279f-41c9-8250-6647b7889279.png#align=left&display=inline&height=368&name=image.png&originHeight=368&originWidth=889&size=55638&status=done&width=889)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1564103694901-b41968af-0830-4fc3-beab-4a2393a76279.png#align=left&display=inline&height=240&name=image.png&originHeight=240&originWidth=596&size=56566&status=done&width=596)\n\n\n<a name=\"Kgbm8\"></a>\n## 其他\n已经提交PR，如果有需要的朋友， 可以在PR上投票，可以提高通过率[added Vagrantfile to support windows dev#3036](https://github.com/jumpserver/jumpserver/pull/3036)\n\njumpserver virtualbox 已上传百度云盘 <br />链接：[https://pan.baidu.com/s/1mr6xM7UVkPJy3TPTyoM_NQ](https://pan.baidu.com/s/1mr6xM7UVkPJy3TPTyoM_NQ)  密码：rci6\n\n<a name=\"sNYV4\"></a>\n## 参考资料\n\n- [我的博客](http://anjia0532.github.io/2019/07/24/jumpserver-vagrant-virtualbox)\n- [我的掘金](https://juejin.im/post/5d3a55ece51d454f71439dd2)\n- [Win10 10月更新 VirtualBox VT-x is not available (VERR_VMX_NO_VMX). 解决](https://blog.csdn.net/imilano/article/details/83038682)\n- [Vagrant系列(一)----win10搭建Vagrant+VirtualBox环境](https://blog.csdn.net/u011781521/article/details/80275212)\n- [安装文档](http://docs.jumpserver.org/zh/docs/step_by_step.html)\n- [使用 PyCharm专业版和vagrant进行同步开发](https://blog.csdn.net/weixin_42393089/article/details/83211456)\n- [打造跨平台一致性开发环境](https://juejin.im/entry/5c6a6da5f265da2de52d7d7c/detail)\n\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-07-24 19:35:21</p><p>tags: [虚拟机,kvm,vagrant,virtualbox,jumpserver,堡垒机]</p><p>categories: python</p><p>---</p><p><br /></p><blockquote><p><span>这是坚持技术写作计划（含翻译）的第36篇，定个小目标999，每周最少2篇。</span></p></blockquote><p><br /></p><p>本文以jumpserver为例，介绍如何在windows环境下进行jumpserver开发(jumpserver依赖的一些库，只有linux环境才能用)，其实不局限于jumpserver，其他项目也适用(不限于python)。参考 <a href=\"https://juejin.im/entry/5c6a6da5f265da2de52d7d7c/detail\" target=\"_blank\">打造跨平台一致性开发环境</a></p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"FBqFH\">初始化环境</h2><h3 id=\"DzvF8\">安装vagrant+virtualbox</h3><p>参考 <a href=\"https://blog.csdn.net/u011781521/article/details/80275212\" target=\"_blank\"><span>Vagrant系列(一)----win10搭建Vagrant+VirtualBox环境</span></a></p><h3 id=\"LDM8N\">下载centos镜像</h3><p>可以使用境外服务器或者迅雷下载 <code>https://cloud.centos.org/centos/7/vagrant/x86_64/images/CentOS-7-x86_64-Vagrant-1905_01.VirtualBox.box</code> </p><pre data-lang=\"bash\"><code>vagrant box add centos/7 \\\n    https://cloud.centos.org/centos/7/vagrant/x86_64/images/CentOS-7-x86_64-Vagrant-1905_01.VirtualBox.box\n\n## 或者\n\nvagrant box add centos/7 /path/to/CentOS-7-x86_64-Vagrant-1905_01.VirtualBox.box</code></pre><p><br /></p><h3 id=\"3o5Z3\"><span>下载jumpserver源代码并创建vagrant</span></h3><p>如果下载速度慢，可以使用码云(gitee.com)自己创建个镜像项目，clone码云上的jumpserver</p><pre data-lang=\"bash\"><code>git clone --depth=1 https://github.com/jumpserver/jumpserver.git\ncd jumpserver</code></pre><p>在jumpserver下创建Vagrantfile</p><pre data-lang=\"ruby\"><code># -*- mode: ruby -*-\n# vi: set ft=ruby :\n\nVagrant.configure(&quot;2&quot;) do |config|\n  # Every Vagrant development environment requires a box. You can search for\n  # boxes at https://vagrantcloud.com/search.\n  config.vm.box_check_update = false\n  config.vm.box = &quot;centos/7&quot;\n  config.vm.hostname = &quot;jumpserver&quot;\n  config.vm.network &quot;private_network&quot;, ip: &quot;172.17.8.101&quot;\n  config.vm.provider &quot;virtualbox&quot; do |vb|\n    vb.memory = &quot;4096&quot;\n    vb.cpus = 2\n    vb.name = &quot;jumpserver&quot;\n  end\n\n  config.vm.synced_folder &quot;.&quot;, &quot;/vagrant&quot;, type: &quot;rsync&quot;,\n    rsync__verbose: true,\n    rsync__exclude: ['.git*', 'node_modules*','*.log','*.box','Vagrantfile']\n\n  config.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL\nsudo curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\nsudo sed -i -e '/mirrors.cloud.aliyuncs.com/d' -e '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo\nsudo curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\nsudo yum makecache\n\nsudo yum install -y python36 python36-devel python36-pip \\\n\t\t libtiff-devel libjpeg-devel libzip-devel freetype-devel \\\n     lcms2-devel libwebp-devel tcl-devel tk-devel sshpass \\\n     openldap-devel mariadb-devel mysql-devel libffi-devel \\\n     openssh-clients telnet openldap-clients gcc\n\nmkdir /home/vagrant/.pip\ncat &lt;&lt; EOF | sudo tee -a /home/vagrant/.pip/pip.conf\n[global]\ntimeout = 6000\nindex-url = https://mirrors.aliyun.com/pypi/simple/\n\n[install]\nuse-mirrors = true\nmirrors = https://mirrors.aliyun.com/pypi/simple/\ntrusted-host=mirrors.aliyun.com\nEOF\n\npython3.6 -m venv /home/vagrant/venv\nsource /home/vagrant/venv/bin/activate\necho &quot;source /home/vagrant/venv/bin/activate&quot; &gt;&gt; /home/vagrant/.bash_profile\n  SHELL\nend\n</code></pre><p><br /></p><pre data-lang=\"bash\"><code>cd jumpserver\nvagrant up\nvagrant ssh</code></pre><p><br /></p><h3 id=\"gn90K\"><del>安装python3.6及配置pip源</del></h3><p>如果使用我的Vargrantfile，已经自动配置阿里云源并且安装必要依赖包了，不需要重复配置</p><pre data-lang=\"bash\"><code>## 设置yum的阿里云源\nsudo curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\nsudo sed -i -e '/mirrors.cloud.aliyuncs.com/d' -e '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo\nsudo curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\nsudo yum makecache\n\n## 安装依赖包\nsudo yum install -y python36 python36-devel python36-pip \\\n\t\t libtiff-devel libjpeg-devel libzip-devel freetype-devel \\\n     lcms2-devel libwebp-devel tcl-devel tk-devel sshpass \\\n     openldap-devel mariadb-devel mysql-devel libffi-devel \\\n     openssh-clients telnet openldap-clients gcc\n\n## 配置pip阿里云源\nmkdir ~/.pip\ncat &lt;&lt; EOF | sudo tee -a ~/.pip/pip.conf\n[global]\ntimeout = 6000\nindex-url = https://mirrors.aliyun.com/pypi/simple/\n\n[install]\nuse-mirrors = true\nmirrors = https://mirrors.aliyun.com/pypi/simple/\ntrusted-host=mirrors.aliyun.com\nEOF</code></pre><p><br /></p><h3 id=\"YFYr7\">安装依赖</h3><p>如果使用我的Vargrantfile，不需要配置python env了，已经配置好了</p><pre data-lang=\"bash\"><code>vagrant ssh\npython3.6 -m venv /home/vagrant/venv\nsource /home/vagrant/venv/bin/activate</code></pre><p><br /></p><p>只需要执行这个即可</p><pre data-lang=\"bash\"><code>pip3 install -r /vagrant/requirements/requirements.txt</code></pre><p><br /></p><p>参考 <a href=\"http://docs.jumpserver.org/zh/docs/step_by_step.html\" target=\"_blank\">安装文档</a></p><p><br /></p><h2 id=\"KRTaO\">配置pycharm并启动jumpserver</h2><h3 id=\"Mk0Vl\">配置pycharm</h3><p><br /></p><p>&lt;kbd&gt;Ctrl&lt;/kbd&gt;+<span>&lt;kbd&gt;Alt&lt;/kbd&gt;+</span><span>&lt;kbd&gt;S&lt;/kbd&gt;打开设置</span></p><p><span><br /></span></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564102215460-c6a602ed-86e6-49fc-b2b1-d43689243daa.png#align=left&amp;display=inline&amp;height=706&amp;name=image.png&amp;originHeight=706&amp;originWidth=1009&amp;size=70204&amp;status=done&amp;width=1009\" style=\"max-width: 600px; width: 1009px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564102389714-c0a5c982-1597-4007-8719-c4f316457bf8.png#align=left&amp;display=inline&amp;height=678&amp;name=image.png&amp;originHeight=678&amp;originWidth=841&amp;size=65908&amp;status=done&amp;width=841\" style=\"max-width: 600px; width: 841px;\" /></p><p>如果正常，会显示已经安装的pip包，如果是空，或者只有两个，那意味着python的env设置的不对。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564102637247-a8c69ed0-d6a2-4d00-ad3b-feebe98a0589.png#align=left&amp;display=inline&amp;height=674&amp;name=image.png&amp;originHeight=674&amp;originWidth=1007&amp;size=68920&amp;status=done&amp;width=1007\" style=\"max-width: 600px; width: 1007px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564102989073-8062df66-c4cc-45dd-b574-db6e6a39cb6d.png#align=left&amp;display=inline&amp;height=739&amp;name=image.png&amp;originHeight=739&amp;originWidth=1068&amp;size=108292&amp;status=done&amp;width=1068\" style=\"max-width: 600px; width: 1068px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564110989520-3f8ac63d-5b58-46b7-89bc-d24f6352785c.png#align=left&amp;display=inline&amp;height=706&amp;name=image.png&amp;originHeight=706&amp;originWidth=1009&amp;size=63412&amp;status=done&amp;width=1009\" style=\"max-width: 600px; width: 1009px;\" /></p><p><br /></p><p><a href=\"https://blog.csdn.net/weixin_42393089/article/details/83211456\" target=\"_blank\">使用 PyCharm专业版和vagrant进行同步开发</a></p><p><br /></p><h3 id=\"TVFTG\">修改配置并初始化数据库</h3><p><br /></p><pre data-lang=\"bash\"><code>cd jumpserver\ncp config_example.yml config.yml\n## 修改config.yml的相关配置\nvagrant ssh\nsource /home/vagrant/venv/bin/activate\ncd /vagrant/utils\n./make_migrations.sh</code></pre><p><br /></p><h3 id=\"avGGO\">启动项目</h3><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564103536157-efbb24a4-c29d-45b4-991f-b314544ed548.png#align=left&amp;display=inline&amp;height=79&amp;name=image.png&amp;originHeight=79&amp;originWidth=353&amp;size=5532&amp;status=done&amp;width=353\" style=\"max-width: 600px; width: 353px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564103574288-28ffdb6f-25f2-4a67-b8ba-936cca59ccf3.png#align=left&amp;display=inline&amp;height=273&amp;name=image.png&amp;originHeight=273&amp;originWidth=407&amp;size=25404&amp;status=done&amp;width=407\" style=\"max-width: 600px; width: 407px;\" /></p><p><span>浏览器打开 </span><a href=\"http://172.17.8.101:8080/auth/login/?next=/\" target=\"_blank\">http://172.17.8.101:8080/auth/login/?next=/</a></p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564103612991-53990854-279f-41c9-8250-6647b7889279.png#align=left&amp;display=inline&amp;height=368&amp;name=image.png&amp;originHeight=368&amp;originWidth=889&amp;size=55638&amp;status=done&amp;width=889\" style=\"max-width: 600px; width: 889px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1564103694901-b41968af-0830-4fc3-beab-4a2393a76279.png#align=left&amp;display=inline&amp;height=240&amp;name=image.png&amp;originHeight=240&amp;originWidth=596&amp;size=56566&amp;status=done&amp;width=596\" style=\"max-width: 600px; width: 596px;\" /></p><p><br /></p><p><br /></p><h2 id=\"Kgbm8\">其他</h2><p>已经提交PR，如果有需要的朋友， 可以在PR上投票，可以提高通过率<a href=\"https://github.com/jumpserver/jumpserver/pull/3036\" target=\"_blank\">added Vagrantfile to support windows dev#3036</a></p><p><br /></p><p>jumpserver virtualbox 已上传百度云盘 </p><p>链接：<a href=\"https://pan.baidu.com/s/1mr6xM7UVkPJy3TPTyoM_NQ\" target=\"_blank\">https://pan.baidu.com/s/1mr6xM7UVkPJy3TPTyoM_NQ</a>  密码：rci6</p><p><br /></p><h2 id=\"sNYV4\"><span style=\"background-color: transparent;\">参考资料</span></h2><p><br /></p><ul><li><a href=\"http://anjia0532.github.io/2019/07/24/jumpserver-vagrant-virtualbox\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d3a55ece51d454f71439dd2\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://blog.csdn.net/imilano/article/details/83038682\" target=\"_blank\">Win10 10月更新 VirtualBox VT-x is not available (VERR_VMX_NO_VMX). 解决</a></li><li><a href=\"https://blog.csdn.net/u011781521/article/details/80275212\" target=\"_blank\">Vagrant系列(一)----win10搭建Vagrant+VirtualBox环境</a></li><li><a href=\"http://docs.jumpserver.org/zh/docs/step_by_step.html\" target=\"_blank\"><span>安装文档</span></a></li><li><a href=\"https://blog.csdn.net/weixin_42393089/article/details/83211456\" target=\"_blank\"><span>使用 PyCharm专业版和vagrant进行同步开发</span></a></li><li><a href=\"https://juejin.im/entry/5c6a6da5f265da2de52d7d7c/detail\" target=\"_blank\"><span>打造跨平台一致性开发环境</span></a></li></ul><p><br /></p>",
    "body_lake": "<!doctype lake><p>date: 2019-07-24 19:35:21</p><p>tags: [虚拟机,kvm,vagrant,virtualbox,jumpserver,堡垒机]</p><p>categories: python</p><p>---</p><p><br /></p><blockquote><p><span>这是坚持技术写作计划（含翻译）的第36篇，定个小目标999，每周最少2篇。</span></p></blockquote><p><br /></p><p>本文以jumpserver为例，<cursor />介绍如何在windows环境下进行jumpserver开发(jumpserver依赖的一些库，只有linux环境才能用)，其实不局限于jumpserver，其他项目也适用(不限于python)。参考 <a href=\"https://juejin.im/entry/5c6a6da5f265da2de52d7d7c/detail\" target=\"_blank\">打造跨平台一致性开发环境</a></p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"FBqFH\">初始化环境</h2><h3 id=\"DzvF8\">安装vagrant+virtualbox</h3><p>参考 <a href=\"https://blog.csdn.net/u011781521/article/details/80275212\" target=\"_blank\"><span>Vagrant系列(一)----win10搭建Vagrant+VirtualBox环境</span></a></p><h3 id=\"LDM8N\">下载centos镜像</h3><p>可以使用境外服务器或者迅雷下载 <code>https://cloud.centos.org/centos/7/vagrant/x86_64/images/CentOS-7-x86_64-Vagrant-1905_01.VirtualBox.box</code> </p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22vagrant%20box%20add%20centos%2F7%20%5C%5C%5Cn%20%20%20%20https%3A%2F%2Fcloud.centos.org%2Fcentos%2F7%2Fvagrant%2Fx86_64%2Fimages%2FCentOS-7-x86_64-Vagrant-1905_01.VirtualBox.box%5Cn%5Cn%23%23%20%E6%88%96%E8%80%85%5Cn%5Cnvagrant%20box%20add%20centos%2F7%20%2Fpath%2Fto%2FCentOS-7-x86_64-Vagrant-1905_01.VirtualBox.box%22%2C%22id%22%3A%22kbedD%22%7D\"></card><p><br /></p><h3 id=\"3o5Z3\"><span>下载jumpserver源代码并创建vagrant</span></h3><p>如果下载速度慢，可以使用码云(gitee.com)自己创建个镜像项目，clone码云上的jumpserver</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22git%20clone%20--depth%3D1%20https%3A%2F%2Fgithub.com%2Fjumpserver%2Fjumpserver.git%5Cncd%20jumpserver%22%2C%22id%22%3A%22gknuQ%22%7D\"></card><p>在jumpserver下创建Vagrantfile</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22ruby%22%2C%22code%22%3A%22%23%20-*-%20mode%3A%20ruby%20-*-%5Cn%23%20vi%3A%20set%20ft%3Druby%20%3A%5Cn%5CnVagrant.configure(%5C%222%5C%22)%20do%20%7Cconfig%7C%5Cn%20%20%23%20Every%20Vagrant%20development%20environment%20requires%20a%20box.%20You%20can%20search%20for%5Cn%20%20%23%20boxes%20at%20https%3A%2F%2Fvagrantcloud.com%2Fsearch.%5Cn%20%20config.vm.box_check_update%20%3D%20false%5Cn%20%20config.vm.box%20%3D%20%5C%22centos%2F7%5C%22%5Cn%20%20config.vm.hostname%20%3D%20%5C%22jumpserver%5C%22%5Cn%20%20config.vm.network%20%5C%22private_network%5C%22%2C%20ip%3A%20%5C%22172.17.8.101%5C%22%5Cn%20%20config.vm.provider%20%5C%22virtualbox%5C%22%20do%20%7Cvb%7C%5Cn%20%20%20%20vb.memory%20%3D%20%5C%224096%5C%22%5Cn%20%20%20%20vb.cpus%20%3D%202%5Cn%20%20%20%20vb.name%20%3D%20%5C%22jumpserver%5C%22%5Cn%20%20end%5Cn%5Cn%20%20config.vm.synced_folder%20%5C%22.%5C%22%2C%20%5C%22%2Fvagrant%5C%22%2C%20type%3A%20%5C%22rsync%5C%22%2C%5Cn%20%20%20%20rsync__verbose%3A%20true%2C%5Cn%20%20%20%20rsync__exclude%3A%20%5B'.git*'%2C%20'node_modules*'%2C'*.log'%2C'*.box'%2C'Vagrantfile'%5D%5Cn%5Cn%20%20config.vm.provision%20%5C%22shell%5C%22%2C%20inline%3A%20%3C%3C-SHELL%5Cnsudo%20curl%20-o%20%2Fetc%2Fyum.repos.d%2FCentOS-Base.repo%20http%3A%2F%2Fmirrors.aliyun.com%2Frepo%2FCentos-7.repo%5Cnsudo%20sed%20-i%20-e%20'%2Fmirrors.cloud.aliyuncs.com%2Fd'%20-e%20'%2Fmirrors.aliyuncs.com%2Fd'%20%2Fetc%2Fyum.repos.d%2FCentOS-Base.repo%5Cnsudo%20curl%20-o%20%2Fetc%2Fyum.repos.d%2Fepel.repo%20http%3A%2F%2Fmirrors.aliyun.com%2Frepo%2Fepel-7.repo%5Cnsudo%20yum%20makecache%5Cn%5Cnsudo%20yum%20install%20-y%20python36%20python36-devel%20python36-pip%20%5C%5C%5Cn%5Ct%5Ct%20libtiff-devel%20libjpeg-devel%20libzip-devel%20freetype-devel%20%5C%5C%5Cn%20%20%20%20%20lcms2-devel%20libwebp-devel%20tcl-devel%20tk-devel%20sshpass%20%5C%5C%5Cn%20%20%20%20%20openldap-devel%20mariadb-devel%20mysql-devel%20libffi-devel%20%5C%5C%5Cn%20%20%20%20%20openssh-clients%20telnet%20openldap-clients%20gcc%5Cn%5Cnmkdir%20%2Fhome%2Fvagrant%2F.pip%5Cncat%20%3C%3C%20EOF%20%7C%20sudo%20tee%20-a%20%2Fhome%2Fvagrant%2F.pip%2Fpip.conf%5Cn%5Bglobal%5D%5Cntimeout%20%3D%206000%5Cnindex-url%20%3D%20https%3A%2F%2Fmirrors.aliyun.com%2Fpypi%2Fsimple%2F%5Cn%5Cn%5Binstall%5D%5Cnuse-mirrors%20%3D%20true%5Cnmirrors%20%3D%20https%3A%2F%2Fmirrors.aliyun.com%2Fpypi%2Fsimple%2F%5Cntrusted-host%3Dmirrors.aliyun.com%5CnEOF%5Cn%5Cnpython3.6%20-m%20venv%20%2Fhome%2Fvagrant%2Fvenv%5Cnsource%20%2Fhome%2Fvagrant%2Fvenv%2Fbin%2Factivate%5Cnecho%20%5C%22source%20%2Fhome%2Fvagrant%2Fvenv%2Fbin%2Factivate%5C%22%20%3E%3E%20%2Fhome%2Fvagrant%2F.bash_profile%5Cn%20%20SHELL%5Cnend%5Cn%22%2C%22id%22%3A%22d6dUQ%22%7D\"></card><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22cd%20jumpserver%5Cnvagrant%20up%5Cnvagrant%20ssh%22%2C%22id%22%3A%22ntRai%22%7D\"></card><p><br /></p><h3 id=\"gn90K\"><del>安装python3.6及配置pip源</del></h3><p>如果使用我的Vargrantfile，已经自动配置阿里云源并且安装必要依赖包了，不需要重复配置</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23%23%20%E8%AE%BE%E7%BD%AEyum%E7%9A%84%E9%98%BF%E9%87%8C%E4%BA%91%E6%BA%90%5Cnsudo%20curl%20-o%20%2Fetc%2Fyum.repos.d%2FCentOS-Base.repo%20http%3A%2F%2Fmirrors.aliyun.com%2Frepo%2FCentos-7.repo%5Cnsudo%20sed%20-i%20-e%20'%2Fmirrors.cloud.aliyuncs.com%2Fd'%20-e%20'%2Fmirrors.aliyuncs.com%2Fd'%20%2Fetc%2Fyum.repos.d%2FCentOS-Base.repo%5Cnsudo%20curl%20-o%20%2Fetc%2Fyum.repos.d%2Fepel.repo%20http%3A%2F%2Fmirrors.aliyun.com%2Frepo%2Fepel-7.repo%5Cnsudo%20yum%20makecache%5Cn%5Cn%23%23%20%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%8C%85%5Cnsudo%20yum%20install%20-y%20python36%20python36-devel%20python36-pip%20%5C%5C%5Cn%5Ct%5Ct%20libtiff-devel%20libjpeg-devel%20libzip-devel%20freetype-devel%20%5C%5C%5Cn%20%20%20%20%20lcms2-devel%20libwebp-devel%20tcl-devel%20tk-devel%20sshpass%20%5C%5C%5Cn%20%20%20%20%20openldap-devel%20mariadb-devel%20mysql-devel%20libffi-devel%20%5C%5C%5Cn%20%20%20%20%20openssh-clients%20telnet%20openldap-clients%20gcc%5Cn%5Cn%23%23%20%E9%85%8D%E7%BD%AEpip%E9%98%BF%E9%87%8C%E4%BA%91%E6%BA%90%5Cnmkdir%20~%2F.pip%5Cncat%20%3C%3C%20EOF%20%7C%20sudo%20tee%20-a%20~%2F.pip%2Fpip.conf%5Cn%5Bglobal%5D%5Cntimeout%20%3D%206000%5Cnindex-url%20%3D%20https%3A%2F%2Fmirrors.aliyun.com%2Fpypi%2Fsimple%2F%5Cn%5Cn%5Binstall%5D%5Cnuse-mirrors%20%3D%20true%5Cnmirrors%20%3D%20https%3A%2F%2Fmirrors.aliyun.com%2Fpypi%2Fsimple%2F%5Cntrusted-host%3Dmirrors.aliyun.com%5CnEOF%22%2C%22id%22%3A%22D4H5X%22%7D\"></card><p><br /></p><h3 id=\"YFYr7\">安装依赖</h3><p>如果使用我的Vargrantfile，不需要配置python env了，已经配置好了</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22vagrant%20ssh%5Cnpython3.6%20-m%20venv%20%2Fhome%2Fvagrant%2Fvenv%5Cnsource%20%2Fhome%2Fvagrant%2Fvenv%2Fbin%2Factivate%22%2C%22id%22%3A%226nhEK%22%7D\"></card><p><br /></p><p>只需要执行这个即可</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22pip3%20install%20-r%20%2Fvagrant%2Frequirements%2Frequirements.txt%22%2C%22id%22%3A%22z5Xja%22%7D\"></card><p><br /></p><p>参考 <a href=\"http://docs.jumpserver.org/zh/docs/step_by_step.html\" target=\"_blank\">安装文档</a></p><p><br /></p><h2 id=\"KRTaO\">配置pycharm并启动jumpserver</h2><h3 id=\"Mk0Vl\">配置pycharm</h3><p><br /></p><p>&lt;kbd&gt;Ctrl&lt;/kbd&gt;+<span>&lt;kbd&gt;Alt&lt;/kbd&gt;+</span><span>&lt;kbd&gt;S&lt;/kbd&gt;打开设置</span></p><p><span><br /></span></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564102215460-c6a602ed-86e6-49fc-b2b1-d43689243daa.png%22%2C%22originWidth%22%3A1009%2C%22originHeight%22%3A706%2C%22name%22%3A%22image.png%22%2C%22size%22%3A70204%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1009%2C%22height%22%3A706%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564102389714-c0a5c982-1597-4007-8719-c4f316457bf8.png%22%2C%22originWidth%22%3A841%2C%22originHeight%22%3A678%2C%22name%22%3A%22image.png%22%2C%22size%22%3A65908%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A841%2C%22height%22%3A678%7D\"></card></p><p>如果正常，会显示已经安装的pip包，如果是空，或者只有两个，那意味着python的env设置的不对。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564102637247-a8c69ed0-d6a2-4d00-ad3b-feebe98a0589.png%22%2C%22originWidth%22%3A1007%2C%22originHeight%22%3A674%2C%22name%22%3A%22image.png%22%2C%22size%22%3A68920%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1007%2C%22height%22%3A674%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564102989073-8062df66-c4cc-45dd-b574-db6e6a39cb6d.png%22%2C%22originWidth%22%3A1068%2C%22originHeight%22%3A739%2C%22name%22%3A%22image.png%22%2C%22size%22%3A108292%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1068%2C%22height%22%3A739%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564110989520-3f8ac63d-5b58-46b7-89bc-d24f6352785c.png%22%2C%22originWidth%22%3A1009%2C%22originHeight%22%3A706%2C%22name%22%3A%22image.png%22%2C%22size%22%3A63412%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1009%2C%22height%22%3A706%7D\"></card></p><p><br /></p><p><a href=\"https://blog.csdn.net/weixin_42393089/article/details/83211456\" target=\"_blank\">使用 PyCharm专业版和vagrant进行同步开发</a></p><p><br /></p><h3 id=\"TVFTG\">修改配置并初始化数据库</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22cd%20jumpserver%5Cncp%20config_example.yml%20config.yml%5Cn%23%23%20%E4%BF%AE%E6%94%B9config.yml%E7%9A%84%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%5Cnvagrant%20ssh%5Cnsource%20%2Fhome%2Fvagrant%2Fvenv%2Fbin%2Factivate%5Cncd%20%2Fvagrant%2Futils%5Cn.%2Fmake_migrations.sh%22%2C%22id%22%3A%22NK4im%22%7D\"></card><p><br /></p><h3 id=\"avGGO\">启动项目</h3><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564103536157-efbb24a4-c29d-45b4-991f-b314544ed548.png%22%2C%22originWidth%22%3A353%2C%22originHeight%22%3A79%2C%22name%22%3A%22image.png%22%2C%22size%22%3A5532%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A353%2C%22height%22%3A79%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564103574288-28ffdb6f-25f2-4a67-b8ba-936cca59ccf3.png%22%2C%22originWidth%22%3A407%2C%22originHeight%22%3A273%2C%22name%22%3A%22image.png%22%2C%22size%22%3A25404%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A407%2C%22height%22%3A273%7D\"></card></p><p><span>浏览器打开 </span><a href=\"http://172.17.8.101:8080/auth/login/?next=/\" target=\"_blank\">http://172.17.8.101:8080/auth/login/?next=/</a></p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564103612991-53990854-279f-41c9-8250-6647b7889279.png%22%2C%22originWidth%22%3A889%2C%22originHeight%22%3A368%2C%22name%22%3A%22image.png%22%2C%22size%22%3A55638%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A889%2C%22height%22%3A368%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1564103694901-b41968af-0830-4fc3-beab-4a2393a76279.png%22%2C%22originWidth%22%3A596%2C%22originHeight%22%3A240%2C%22name%22%3A%22image.png%22%2C%22size%22%3A56566%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A596%2C%22height%22%3A240%7D\"></card></p><p><br /></p><p><br /></p><h2 id=\"Kgbm8\">其他</h2><p>已经提交PR，如果有需要的朋友， 可以在PR上投票，可以提高通过率<a href=\"https://github.com/jumpserver/jumpserver/pull/3036\" target=\"_blank\">added Vagrantfile to support windows dev#3036</a></p><p><br /></p><p>jumpserver virtualbox 已上传百度云盘 </p><p>链接：<a href=\"https://pan.baidu.com/s/1mr6xM7UVkPJy3TPTyoM_NQ\" target=\"_blank\">https://pan.baidu.com/s/1mr6xM7UVkPJy3TPTyoM_NQ</a>  密码：rci6</p><p><br /></p><h2 id=\"sNYV4\"><span style=\"background-color: transparent;\">参考资料</span></h2><p><br /></p><ul><li><a href=\"http://anjia0532.github.io/2019/07/24/jumpserver-vagrant-virtualbox\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d3a55ece51d454f71439dd2\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://blog.csdn.net/imilano/article/details/83038682\" target=\"_blank\">Win10 10月更新 VirtualBox VT-x is not available (VERR_VMX_NO_VMX). 解决</a></li><li><a href=\"https://blog.csdn.net/u011781521/article/details/80275212\" target=\"_blank\">Vagrant系列(一)----win10搭建Vagrant+VirtualBox环境</a></li><li><a href=\"http://docs.jumpserver.org/zh/docs/step_by_step.html\" target=\"_blank\"><span>安装文档</span></a></li><li><a href=\"https://blog.csdn.net/weixin_42393089/article/details/83211456\" target=\"_blank\"><span>使用 PyCharm专业版和vagrant进行同步开发</span></a></li><li><a href=\"https://juejin.im/entry/5c6a6da5f265da2de52d7d7c/detail\" target=\"_blank\"><span>打造跨平台一致性开发环境</span></a></li></ul><p><br /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-07-28T14:39:44.000Z",
    "deleted_at": null,
    "created_at": "2019-07-24T06:08:59.000Z",
    "updated_at": "2019-07-28T14:39:44.000Z",
    "published_at": "2019-07-28T14:39:44.000Z",
    "first_published_at": "2019-07-26T01:22:37.000Z",
    "word_count": 1123,
    "cover": "",
    "description": "date: 2019-07-24 19:35:21tags: [虚拟机,kvm,vagrant,virtualbox,jumpserver,堡垒机]categories: python---这是坚持技术写作计划（含翻译）的第36篇，定个小目标999，每周最少2篇。本文以jumpserver为例...",
    "custom_description": "本文主要介绍如何在windows环境下进行jumpserver开发(jumpserver依赖的一些库，只有linux环境才能用)，其实不局限于jumpserver，其他项目也适用(不限于python)。参考 打造跨平台一致性开发环境",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 2182550,
    "slug": "sdc-jdbc-full-mode",
    "title": "035-解决streamsets jdbc全量模式数据重复问题",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-07-22 21:00:00<br />tags: [streamsets,sdc,mysql,binlog,etl,数据分析,数据处理]<br />categories: 大数据<br />---\n\n> 这是坚持技术写作计划（含翻译）的第35篇，定个小目标999，每周最少2篇。\n\n\n本文主要解决在使用streamsets的JDBC Query Consumer Origin组件消费时，使用全量模式(Full Mode)，数据重复问题。\n\n<!-- more -->\n\n在之前一篇《[033-史上最全-mysql迁移到clickhouse的5种办法](https://anjia0532.github.io/2019/07/17/mysql-to-clickhouse/#streamsets)》中，有介绍如何使用JDBC Query Consumer全量导出，但是有人反馈因为streamsets的管道(pipeline)一直在重复运行，导致最后数据是重复的。\n\n实际上在官方文档有讲 [Full and Incremental Mode](https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/JDBCConsumer.html#ariaid-title6)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563874566018-7fd172c4-91aa-4c76-a6af-cf7211443aca.png#align=left&display=inline&height=476&name=image.png&originHeight=476&originWidth=1187&size=73254&status=done&width=1187)\n\n主要看提示(Tip)部分，如果只想执行一次查询后就停止pipeline，应该配置origin的generate events 并且使用Pipeline Finisher来自动停止pipeline，更多信息参见 Event Generation.\n\n在jdbc origin勾选 Produce Events\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563875657778-70e75154-a57b-444d-bf73-4315d05e9fc4.png#align=left&display=inline&height=692&name=image.png&originHeight=692&originWidth=821&size=56065&status=done&width=821)<br />从组件选则Pipeline Finisher，并且配置 Preconditions 为 `${record:eventType() == 'no-more-data'}` 即可<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563875726527-ed22dd7a-cff4-4b10-ac57-2e29ce2f0075.png#align=left&display=inline&height=618&name=image.png&originHeight=618&originWidth=1351&size=70288&status=done&width=1351)\n\n\n\n\n<a name=\"5OqvA\"></a>\n## 参考资料\n\n- [我的博客](https://anjia0532.github.io/2019/07/22/sdc-jdbc-full-mode)\n- [我的掘金](https://juejin.im/post/5d36dbca5188257b775d4b40)\n- [Full and Incremental Mode](https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/JDBCConsumer.html#ariaid-title6)\n- [Event Generation](https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/JDBCConsumer.html#concept_o1c_kwr_kz)\n- [Case Study: Stop the Pipeline](https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Event_Handling/EventFramework-Title.html#concept_kff_ykv_lz)\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-07-22 21:00:00</p><p>tags: [streamsets,sdc,mysql,binlog,etl,数据分析,数据处理]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第35篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要解决在使用streamsets的JDBC Query Consumer Origin组件消费时，使用全量模式(Full Mode)，数据重复问题。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><p>在之前一篇《<a href=\"https://anjia0532.github.io/2019/07/17/mysql-to-clickhouse/#streamsets\" target=\"_blank\">033-史上最全-mysql迁移到clickhouse的5种办法</a>》中，有介绍如何使用JDBC Query Consumer全量导出，但是有人反馈因为streamsets的管道(pipeline)一直在重复运行，导致最后数据是重复的。</p><p><br /></p><p>实际上在官方文档有讲 <a href=\"https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/JDBCConsumer.html#ariaid-title6\" target=\"_blank\">Full and Incremental Mode</a></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563874566018-7fd172c4-91aa-4c76-a6af-cf7211443aca.png#align=left&amp;display=inline&amp;height=476&amp;name=image.png&amp;originHeight=476&amp;originWidth=1187&amp;size=73254&amp;status=done&amp;width=1187\" style=\"max-width: 600px; width: 1187px;\" /></p><p><br /></p><p>主要看提示(Tip)部分，如果只想执行一次查询后就停止pipeline，应该配置origin的generate events 并且使用Pipeline Finisher来自动停止pipeline，更多信息参见 Event Generation.</p><p><br /></p><p>在jdbc origin勾选 Produce Events</p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563875657778-70e75154-a57b-444d-bf73-4315d05e9fc4.png#align=left&amp;display=inline&amp;height=692&amp;name=image.png&amp;originHeight=692&amp;originWidth=821&amp;size=56065&amp;status=done&amp;width=821\" style=\"max-width: 600px; width: 821px;\" /></p><p>从组件选则Pipeline Finisher，并且配置 Preconditions 为 <code>${record:eventType() == 'no-more-data'}</code> 即可</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563875726527-ed22dd7a-cff4-4b10-ac57-2e29ce2f0075.png#align=left&amp;display=inline&amp;height=618&amp;name=image.png&amp;originHeight=618&amp;originWidth=1351&amp;size=70288&amp;status=done&amp;width=1351\" style=\"max-width: 600px; width: 1351px;\" /></p><p><br /></p><p><br /></p><p><br /></p><p><br /></p><h2 id=\"5OqvA\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/07/22/sdc-jdbc-full-mode\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d36dbca5188257b775d4b40\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/JDBCConsumer.html#ariaid-title6\" target=\"_blank\"><span>Full and Incremental Mode</span></a></li><li><a href=\"https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/JDBCConsumer.html#concept_o1c_kwr_kz\" target=\"_blank\">Event Generation</a></li><li><a href=\"https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Event_Handling/EventFramework-Title.html#concept_kff_ykv_lz\" target=\"_blank\">Case Study: Stop the Pipeline</a></li></ul>",
    "body_lake": "<!doctype lake><p>date: 2019-07-22 21:00:00</p><p>tags: [streamsets,sdc,mysql,binlog,etl,数据分析,数据处理]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第35篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要解决在使用streamsets的JDBC Query Consumer Origin组件消费时，使用全量模式(Full Mode)，数据重复问题。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><p>在之前一篇《<a href=\"https://anjia0532.github.io/2019/07/17/mysql-to-clickhouse/#streamsets\" target=\"_blank\">033-史上最全-mysql迁移到clickhouse的5种办法</a>》中，有介绍如何使用JDBC Query Consumer全量导出，但是有人反馈因为streamsets的管道(pipeline)一直在重复运行，导致最后数据是重复的。</p><p><br /></p><p>实际上在官方文档有讲 <a href=\"https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/JDBCConsumer.html#ariaid-title6\" target=\"_blank\">Full and Incremental Mode</a></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563874566018-7fd172c4-91aa-4c76-a6af-cf7211443aca.png%22%2C%22originWidth%22%3A1187%2C%22originHeight%22%3A476%2C%22name%22%3A%22image.png%22%2C%22size%22%3A73254%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1187%2C%22height%22%3A476%7D\"></card></p><p><br /></p><p>主要看提示(Tip)部分，如果只想执行一次查询后就停止pipeline，应该配置origin的generate events 并且使用Pipeline Finisher来自动停止pipeline，更多信息参见 Event Generation.</p><p><br /></p><p>在jdbc origin勾选 Produce Events</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563875657778-70e75154-a57b-444d-bf73-4315d05e9fc4.png%22%2C%22originWidth%22%3A821%2C%22originHeight%22%3A692%2C%22name%22%3A%22image.png%22%2C%22size%22%3A56065%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A821%2C%22height%22%3A692%7D\"></card></p><p>从组件选则Pipeline Finisher，并且配置 Preconditions 为 <code>${record:eventType() == 'no-more-data'}</code> 即可</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563875726527-ed22dd7a-cff4-4b10-ac57-2e29ce2f0075.png%22%2C%22originWidth%22%3A1351%2C%22originHeight%22%3A618%2C%22name%22%3A%22image.png%22%2C%22size%22%3A70288%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1351%2C%22height%22%3A618%7D\"></card></p><p><br /></p><p><br /></p><p><br /></p><p><br /></p><h2 id=\"5OqvA\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/07/22/sdc-jdbc-full-mode\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d36dbca5188257b775d4b40\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/JDBCConsumer.html#ariaid-title6\" target=\"_blank\"><span>Full and Incremental Mode</span></a></li><li><a href=\"https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/JDBCConsumer.html#concept_o1c_kwr_kz\" target=\"_blank\">Event Generation<cursor /></a></li><li><a href=\"https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Event_Handling/EventFramework-Title.html#concept_kff_ykv_lz\" target=\"_blank\">Case Study: Stop the Pipeline</a></li></ul>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-07-23T10:05:55.000Z",
    "deleted_at": null,
    "created_at": "2019-07-23T09:25:00.000Z",
    "updated_at": "2019-07-24T06:56:15.000Z",
    "published_at": "2019-07-24T06:56:15.000Z",
    "first_published_at": "2019-07-23T10:05:55.000Z",
    "word_count": 273,
    "cover": "",
    "description": "date: 2019-07-22 21:00:00tags: [streamsets,sdc,mysql,binlog,etl,数据分析,数据处理]categories: 大数据---这是坚持技术写作计划（含翻译）的第35篇，定个小目标999，每周最少2篇。本文主要解决在使用streamset...",
    "custom_description": "本文主要解决在使用streamsets的JDBC Query Consumer Origin组件消费时，使用全量模式(Full Mode)，数据重复问题。",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 2168590,
    "slug": "fixed-sdc-mysql-binlog-master-purged",
    "title": "034-解决streamsets订阅过期binlog导致无法启动问题",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-07-22 20:00:52<br />tags: [streamsets,sdc,mysql,binlog,etl,数据分析,数据处理]<br />categories: 大数据<br />---\n> 这是坚持技术写作计划（含翻译）的第34篇，定个小目标999，每周最少2篇。\n\n\nstreamsets停机时间过长，mysql master设置了自动清除binlog，服务启动时报  `ERROR MysqlSource - BinaryLogClient server error: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.` \n\n<!-- more -->\n\n```\n2019-07-20 11:14:19,713 [user:*admin] [pipeline:demo/demo-e2cf-4f6d-b2dc-ce7fc5aeb041] [runner:] [thread:ProductionPipelineRunnable-demo-e2cf-4f6d-b2dc-ce7fc5aeb041-demo] ERROR MysqlSource - BinaryLogClient server error: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.\ncom.github.shyiko.mysql.binlog.network.ServerException: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.\n\tat com.github.shyiko.mysql.binlog.BinaryLogClient.listenForEventPackets(BinaryLogClient.java:882)\n\tat com.github.shyiko.mysql.binlog.BinaryLogClient.connect(BinaryLogClient.java:559)\n\tat com.github.shyiko.mysql.binlog.BinaryLogClient$7.run(BinaryLogClient.java:793)\n\tat java.lang.Thread.run(Thread.java:748)\n2019-07-20 11:14:19,717 [user:*admin] [pipeline:demo/demo-e2cf-4f6d-b2dc-ce7fc5aeb041] [runner:] [thread:ProductionPipelineRunnable-demo-e2cf-4f6d-b2dc-ce7fc5aeb041-demo] ERROR ProductionPipelineRunner - Pipeline execution failed\ncom.streamsets.pipeline.api.StageException: MYSQL_006 - MySql server error: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.\n\tat com.streamsets.pipeline.stage.origin.mysql.MysqlSource.handleErrors(MysqlSource.java:389)\n\tat com.streamsets.pipeline.stage.origin.mysql.MysqlSource.produce(MysqlSource.java:225)\n\tat com.streamsets.datacollector.runner.StageRuntime.lambda$execute$2(StageRuntime.java:295)\n\tat com.streamsets.pipeline.api.impl.CreateByRef.call(CreateByRef.java:40)\n\tat com.streamsets.datacollector.runner.StageRuntime.execute(StageRuntime.java:243)\n\tat com.streamsets.datacollector.runner.StageRuntime.execute(StageRuntime.java:310)\n\tat com.streamsets.datacollector.runner.StagePipe.process(StagePipe.java:219)\n\tat com.streamsets.datacollector.execution.runner.common.ProductionPipelineRunner.processPipe(ProductionPipelineRunner.java:817)\n\tat com.streamsets.datacollector.execution.runner.common.ProductionPipelineRunner.runPollSource(ProductionPipelineRunner.java:561)\n\tat com.streamsets.datacollector.execution.runner.common.ProductionPipelineRunner.run(ProductionPipelineRunner.java:385)\n\tat com.streamsets.datacollector.runner.Pipeline.run(Pipeline.java:529)\n\tat com.streamsets.datacollector.execution.runner.common.ProductionPipeline.run(ProductionPipeline.java:110)\n\tat com.streamsets.datacollector.execution.runner.common.ProductionPipelineRunnable.run(ProductionPipelineRunnable.java:75)\n\tat com.streamsets.datacollector.execution.runner.standalone.StandaloneRunner.start(StandaloneRunner.java:701)\n\tat com.streamsets.datacollector.execution.runner.common.AsyncRunner.lambda$start$3(AsyncRunner.java:151)\n\tat com.streamsets.pipeline.lib.executor.SafeScheduledExecutorService$SafeCallable.lambda$call$0(SafeScheduledExecutorService.java:226)\n\tat com.streamsets.datacollector.security.GroupsInScope.execute(GroupsInScope.java:33)\n\tat com.streamsets.pipeline.lib.executor.SafeScheduledExecutorService$SafeCallable.call(SafeScheduledExecutorService.java:222)\n\tat com.streamsets.pipeline.lib.executor.SafeScheduledExecutorService$SafeCallable.lambda$call$0(SafeScheduledExecutorService.java:226)\n\tat com.streamsets.datacollector.security.GroupsInScope.execute(GroupsInScope.java:33)\n\tat com.streamsets.pipeline.lib.executor.SafeScheduledExecutorService$SafeCallable.call(SafeScheduledExecutorService.java:222)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)\n\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)\n\tat com.streamsets.datacollector.metrics.MetricSafeScheduledExecutorService$MetricsTask.run(MetricSafeScheduledExecutorService.java:100)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\tat java.lang.Thread.run(Thread.java:748)\nCaused by: com.github.shyiko.mysql.binlog.network.ServerException: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.\n\tat com.github.shyiko.mysql.binlog.BinaryLogClient.listenForEventPackets(BinaryLogClient.java:882)\n\tat com.github.shyiko.mysql.binlog.BinaryLogClient.connect(BinaryLogClient.java:559)\n\tat com.github.shyiko.mysql.binlog.BinaryLogClient$7.run(BinaryLogClient.java:793)\n\t... 1 more\n```\n\n尝试了手动设置偏移量无果。(参考资料 [MySQL Binary Log#Initial Offset](https://streamsets.com/documentation/datacollector/3.9.x/help/datacollector/UserGuide/Origins/MySQLBinaryLog.html#ariaid-title5) ）<br />通过查看运行日志，![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563761388749-2ef53ec1-40d5-479b-852e-7dfb7261cd67.png#align=left&display=inline&height=101&name=image.png&originHeight=101&originWidth=304&size=5193&status=done&width=304) <br />发现后台还有在运行之前的offset，突然想起在官方文档.\n> **Note:** If you change the GTID mode on the database server after you have run a pipeline with the MySQL Binary Log origin, you must reset the origin and change the format of the initial offset value. Otherwise, the origin cannot correctly read the offset.\n> When the pipeline stops, the MySQL Binary Log origin notes the offset where it stops reading. When the pipeline starts again, the origin continues processing from the last saved offset. You can reset the origin to process all requested objects.\n\n\n以及<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563761746217-5afefc26-937d-44b7-b4c1-ba114e64a154.png#align=left&display=inline&height=139&name=image.png&originHeight=139&originWidth=397&size=14704&status=done&width=397)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563761793852-caf1a2f7-1c81-4b3c-b046-19d2d1dda76e.png#align=left&display=inline&height=240&name=image.png&originHeight=240&originWidth=387&size=24451&status=done&width=387)<br />解决办法就简单了，直接在启动时，Reset Origin即可。会从server的当前binlog进行订阅。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563761663744-640cf864-f48f-4ffa-9a7a-811ce396caa3.png#align=left&display=inline&height=152&name=image.png&originHeight=152&originWidth=349&size=11373&status=done&width=349)\n\n**总结:** <br />多看官方文档，仔细看，另外，尽量别用翻译工具，否则类似该案例中的origin会被翻译成原点，起源等，会无法联想到sdc的一些概念用词。\n<a name=\"qheIM\"></a>\n## 参考资料\n\n- [我的博客](https://anjia0532.github.io/2019/07/16/fixed-sdc-mysql-binlog-master-purged/)\n- [我的掘金](https://juejin.im/post/5d3652f96fb9a07eda0355aa)\n- [sdc官方文档>MySQL Binary Log](https://streamsets.com/documentation/datacollector/3.9.x/help/datacollector/UserGuide/Origins/MySQLBinaryLog.html)\n- [MySQL · 答疑解惑 · GTID不一致分析](http://mysql.taobao.org/monthly/2016/01/08/)\n- [Mysql binlog 查看方法](http://soft.dog/2016/06/13/dig-mysql-binlog/)\n- [Mysql之binlog日志说明及利用binlog日志恢复数据操作记录](https://www.cnblogs.com/kevingrace/p/5907254.html)\n- [MySQL的binlog日志](https://www.cnblogs.com/martinzhang/p/3454358.html)\n\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-07-22 20:00:52</p><p>tags: [streamsets,sdc,mysql,binlog,etl,数据分析,数据处理]</p><p>categories: 大数据</p><p>---</p><blockquote><p><span>这是坚持技术写作计划（含翻译）的第34篇，定个小目标999，每周最少2篇。</span></p></blockquote><p><br /></p><p>streamsets停机时间过长，<span>mysql master设置了自动清除binlog，服务启动时报  </span><code><span>ERROR MysqlSource - BinaryLogClient server error: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.</span></code> </p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><pre><code>2019-07-20 11:14:19,713 [user:*admin] [pipeline:demo/demo-e2cf-4f6d-b2dc-ce7fc5aeb041] [runner:] [thread:ProductionPipelineRunnable-demo-e2cf-4f6d-b2dc-ce7fc5aeb041-demo] ERROR MysqlSource - BinaryLogClient server error: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.\ncom.github.shyiko.mysql.binlog.network.ServerException: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.\n\tat com.github.shyiko.mysql.binlog.BinaryLogClient.listenForEventPackets(BinaryLogClient.java:882)\n\tat com.github.shyiko.mysql.binlog.BinaryLogClient.connect(BinaryLogClient.java:559)\n\tat com.github.shyiko.mysql.binlog.BinaryLogClient$7.run(BinaryLogClient.java:793)\n\tat java.lang.Thread.run(Thread.java:748)\n2019-07-20 11:14:19,717 [user:*admin] [pipeline:demo/demo-e2cf-4f6d-b2dc-ce7fc5aeb041] [runner:] [thread:ProductionPipelineRunnable-demo-e2cf-4f6d-b2dc-ce7fc5aeb041-demo] ERROR ProductionPipelineRunner - Pipeline execution failed\ncom.streamsets.pipeline.api.StageException: MYSQL_006 - MySql server error: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.\n\tat com.streamsets.pipeline.stage.origin.mysql.MysqlSource.handleErrors(MysqlSource.java:389)\n\tat com.streamsets.pipeline.stage.origin.mysql.MysqlSource.produce(MysqlSource.java:225)\n\tat com.streamsets.datacollector.runner.StageRuntime.lambda$execute$2(StageRuntime.java:295)\n\tat com.streamsets.pipeline.api.impl.CreateByRef.call(CreateByRef.java:40)\n\tat com.streamsets.datacollector.runner.StageRuntime.execute(StageRuntime.java:243)\n\tat com.streamsets.datacollector.runner.StageRuntime.execute(StageRuntime.java:310)\n\tat com.streamsets.datacollector.runner.StagePipe.process(StagePipe.java:219)\n\tat com.streamsets.datacollector.execution.runner.common.ProductionPipelineRunner.processPipe(ProductionPipelineRunner.java:817)\n\tat com.streamsets.datacollector.execution.runner.common.ProductionPipelineRunner.runPollSource(ProductionPipelineRunner.java:561)\n\tat com.streamsets.datacollector.execution.runner.common.ProductionPipelineRunner.run(ProductionPipelineRunner.java:385)\n\tat com.streamsets.datacollector.runner.Pipeline.run(Pipeline.java:529)\n\tat com.streamsets.datacollector.execution.runner.common.ProductionPipeline.run(ProductionPipeline.java:110)\n\tat com.streamsets.datacollector.execution.runner.common.ProductionPipelineRunnable.run(ProductionPipelineRunnable.java:75)\n\tat com.streamsets.datacollector.execution.runner.standalone.StandaloneRunner.start(StandaloneRunner.java:701)\n\tat com.streamsets.datacollector.execution.runner.common.AsyncRunner.lambda$start$3(AsyncRunner.java:151)\n\tat com.streamsets.pipeline.lib.executor.SafeScheduledExecutorService$SafeCallable.lambda$call$0(SafeScheduledExecutorService.java:226)\n\tat com.streamsets.datacollector.security.GroupsInScope.execute(GroupsInScope.java:33)\n\tat com.streamsets.pipeline.lib.executor.SafeScheduledExecutorService$SafeCallable.call(SafeScheduledExecutorService.java:222)\n\tat com.streamsets.pipeline.lib.executor.SafeScheduledExecutorService$SafeCallable.lambda$call$0(SafeScheduledExecutorService.java:226)\n\tat com.streamsets.datacollector.security.GroupsInScope.execute(GroupsInScope.java:33)\n\tat com.streamsets.pipeline.lib.executor.SafeScheduledExecutorService$SafeCallable.call(SafeScheduledExecutorService.java:222)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)\n\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)\n\tat com.streamsets.datacollector.metrics.MetricSafeScheduledExecutorService$MetricsTask.run(MetricSafeScheduledExecutorService.java:100)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\tat java.lang.Thread.run(Thread.java:748)\nCaused by: com.github.shyiko.mysql.binlog.network.ServerException: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.\n\tat com.github.shyiko.mysql.binlog.BinaryLogClient.listenForEventPackets(BinaryLogClient.java:882)\n\tat com.github.shyiko.mysql.binlog.BinaryLogClient.connect(BinaryLogClient.java:559)\n\tat com.github.shyiko.mysql.binlog.BinaryLogClient$7.run(BinaryLogClient.java:793)\n\t... 1 more</code></pre><p><br /></p><p>尝试了手动设置偏移量无果。(参考资料 <a href=\"https://streamsets.com/documentation/datacollector/3.9.x/help/datacollector/UserGuide/Origins/MySQLBinaryLog.html#ariaid-title5\" target=\"_blank\">MySQL Binary Log#Initial Offset</a> ）</p><p>通过查看运行<span>日志，</span><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563761388749-2ef53ec1-40d5-479b-852e-7dfb7261cd67.png#align=left&amp;display=inline&amp;height=101&amp;name=image.png&amp;originHeight=101&amp;originWidth=304&amp;size=5193&amp;status=done&amp;width=304\" style=\"max-width: 600px; width: 304px;\" /><span> </span></p><p><span>发现后台还有在运行之前的offset，突然想起在官方文档.</span></p><blockquote><p><strong>Note:</strong> If you change the GTID mode on the database server after you have run a pipeline with the MySQL Binary Log origin, you must reset the origin and change the format of the initial offset value. Otherwise, the origin cannot correctly read the offset.</p><p>When the pipeline stops, the MySQL Binary Log origin notes the offset where it stops reading. When the pipeline starts again, the origin continues processing from the last saved offset. You can reset the origin to process all requested objects.</p></blockquote><p><br /></p><p>以及</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563761746217-5afefc26-937d-44b7-b4c1-ba114e64a154.png#align=left&amp;display=inline&amp;height=139&amp;name=image.png&amp;originHeight=139&amp;originWidth=397&amp;size=14704&amp;status=done&amp;width=397\" style=\"max-width: 600px; width: 397px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563761793852-caf1a2f7-1c81-4b3c-b046-19d2d1dda76e.png#align=left&amp;display=inline&amp;height=240&amp;name=image.png&amp;originHeight=240&amp;originWidth=387&amp;size=24451&amp;status=done&amp;width=387\" style=\"max-width: 600px; width: 387px;\" /></p><p>解决办法就简单了，直接在启动时，Reset Origin即可。会从server的当前binlog进行订阅。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563761663744-640cf864-f48f-4ffa-9a7a-811ce396caa3.png#align=left&amp;display=inline&amp;height=152&amp;name=image.png&amp;originHeight=152&amp;originWidth=349&amp;size=11373&amp;status=done&amp;width=349\" style=\"max-width: 600px; width: 349px;\" /></p><p><br /></p><p><strong>总结:</strong> </p><p>多看官方文档，仔细看，另外，尽量别用翻译工具，否则类似该案例中的origin会被翻译成原点，起源等，会无法联想到sdc的一些概念用词。</p><h2 id=\"qheIM\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/07/16/fixed-sdc-mysql-binlog-master-purged/\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d3652f96fb9a07eda0355aa\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://streamsets.com/documentation/datacollector/3.9.x/help/datacollector/UserGuide/Origins/MySQLBinaryLog.html\" target=\"_blank\">sdc官方文档&gt;MySQL Binary Log</a></li><li><a href=\"http://mysql.taobao.org/monthly/2016/01/08/\" target=\"_blank\">MySQL · 答疑解惑 · GTID不一致分析</a></li><li><a href=\"http://soft.dog/2016/06/13/dig-mysql-binlog/\" target=\"_blank\">Mysql binlog 查看方法</a></li><li><a href=\"https://www.cnblogs.com/kevingrace/p/5907254.html\" target=\"_blank\">Mysql之binlog日志说明及利用binlog日志恢复数据操作记录</a></li><li><a href=\"https://www.cnblogs.com/martinzhang/p/3454358.html\" target=\"_blank\">MySQL的binlog日志</a></li></ul><p><br /></p>",
    "body_lake": "<!doctype lake><p>date: 2019-07-22 20:00:52</p><p>tags: [streamsets,sdc,mysql,binlog,etl,数据分析,数据处理]</p><p>categories: 大数据</p><p>---</p><blockquote><p><span>这是坚持技术写作计划（含翻译）的第34篇，定个小目标999，每周最少2篇。</span></p></blockquote><p><br /></p><p>streamsets停机时间过长，<span>mysql master设置了自动清除binlog，服务启动时报  </span><code><span>ERROR MysqlSource - BinaryLogClient server error: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.</span></code> </p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22plain%22%2C%22code%22%3A%222019-07-20%2011%3A14%3A19%2C713%20%5Buser%3A*admin%5D%20%5Bpipeline%3Ademo%2Fdemo-e2cf-4f6d-b2dc-ce7fc5aeb041%5D%20%5Brunner%3A%5D%20%5Bthread%3AProductionPipelineRunnable-demo-e2cf-4f6d-b2dc-ce7fc5aeb041-demo%5D%20ERROR%20MysqlSource%20-%20BinaryLogClient%20server%20error%3A%20The%20slave%20is%20connecting%20using%20CHANGE%20MASTER%20TO%20MASTER_AUTO_POSITION%20%3D%201%2C%20but%20the%20master%20has%20purged%20binary%20logs%20containing%20GTIDs%20that%20the%20slave%20requires.%5Cncom.github.shyiko.mysql.binlog.network.ServerException%3A%20The%20slave%20is%20connecting%20using%20CHANGE%20MASTER%20TO%20MASTER_AUTO_POSITION%20%3D%201%2C%20but%20the%20master%20has%20purged%20binary%20logs%20containing%20GTIDs%20that%20the%20slave%20requires.%5Cn%5Ctat%20com.github.shyiko.mysql.binlog.BinaryLogClient.listenForEventPackets(BinaryLogClient.java%3A882)%5Cn%5Ctat%20com.github.shyiko.mysql.binlog.BinaryLogClient.connect(BinaryLogClient.java%3A559)%5Cn%5Ctat%20com.github.shyiko.mysql.binlog.BinaryLogClient%247.run(BinaryLogClient.java%3A793)%5Cn%5Ctat%20java.lang.Thread.run(Thread.java%3A748)%5Cn2019-07-20%2011%3A14%3A19%2C717%20%5Buser%3A*admin%5D%20%5Bpipeline%3Ademo%2Fdemo-e2cf-4f6d-b2dc-ce7fc5aeb041%5D%20%5Brunner%3A%5D%20%5Bthread%3AProductionPipelineRunnable-demo-e2cf-4f6d-b2dc-ce7fc5aeb041-demo%5D%20ERROR%20ProductionPipelineRunner%20-%20Pipeline%20execution%20failed%5Cncom.streamsets.pipeline.api.StageException%3A%20MYSQL_006%20-%20MySql%20server%20error%3A%20The%20slave%20is%20connecting%20using%20CHANGE%20MASTER%20TO%20MASTER_AUTO_POSITION%20%3D%201%2C%20but%20the%20master%20has%20purged%20binary%20logs%20containing%20GTIDs%20that%20the%20slave%20requires.%5Cn%5Ctat%20com.streamsets.pipeline.stage.origin.mysql.MysqlSource.handleErrors(MysqlSource.java%3A389)%5Cn%5Ctat%20com.streamsets.pipeline.stage.origin.mysql.MysqlSource.produce(MysqlSource.java%3A225)%5Cn%5Ctat%20com.streamsets.datacollector.runner.StageRuntime.lambda%24execute%242(StageRuntime.java%3A295)%5Cn%5Ctat%20com.streamsets.pipeline.api.impl.CreateByRef.call(CreateByRef.java%3A40)%5Cn%5Ctat%20com.streamsets.datacollector.runner.StageRuntime.execute(StageRuntime.java%3A243)%5Cn%5Ctat%20com.streamsets.datacollector.runner.StageRuntime.execute(StageRuntime.java%3A310)%5Cn%5Ctat%20com.streamsets.datacollector.runner.StagePipe.process(StagePipe.java%3A219)%5Cn%5Ctat%20com.streamsets.datacollector.execution.runner.common.ProductionPipelineRunner.processPipe(ProductionPipelineRunner.java%3A817)%5Cn%5Ctat%20com.streamsets.datacollector.execution.runner.common.ProductionPipelineRunner.runPollSource(ProductionPipelineRunner.java%3A561)%5Cn%5Ctat%20com.streamsets.datacollector.execution.runner.common.ProductionPipelineRunner.run(ProductionPipelineRunner.java%3A385)%5Cn%5Ctat%20com.streamsets.datacollector.runner.Pipeline.run(Pipeline.java%3A529)%5Cn%5Ctat%20com.streamsets.datacollector.execution.runner.common.ProductionPipeline.run(ProductionPipeline.java%3A110)%5Cn%5Ctat%20com.streamsets.datacollector.execution.runner.common.ProductionPipelineRunnable.run(ProductionPipelineRunnable.java%3A75)%5Cn%5Ctat%20com.streamsets.datacollector.execution.runner.standalone.StandaloneRunner.start(StandaloneRunner.java%3A701)%5Cn%5Ctat%20com.streamsets.datacollector.execution.runner.common.AsyncRunner.lambda%24start%243(AsyncRunner.java%3A151)%5Cn%5Ctat%20com.streamsets.pipeline.lib.executor.SafeScheduledExecutorService%24SafeCallable.lambda%24call%240(SafeScheduledExecutorService.java%3A226)%5Cn%5Ctat%20com.streamsets.datacollector.security.GroupsInScope.execute(GroupsInScope.java%3A33)%5Cn%5Ctat%20com.streamsets.pipeline.lib.executor.SafeScheduledExecutorService%24SafeCallable.call(SafeScheduledExecutorService.java%3A222)%5Cn%5Ctat%20com.streamsets.pipeline.lib.executor.SafeScheduledExecutorService%24SafeCallable.lambda%24call%240(SafeScheduledExecutorService.java%3A226)%5Cn%5Ctat%20com.streamsets.datacollector.security.GroupsInScope.execute(GroupsInScope.java%3A33)%5Cn%5Ctat%20com.streamsets.pipeline.lib.executor.SafeScheduledExecutorService%24SafeCallable.call(SafeScheduledExecutorService.java%3A222)%5Cn%5Ctat%20java.util.concurrent.FutureTask.run(FutureTask.java%3A266)%5Cn%5Ctat%20java.util.concurrent.ScheduledThreadPoolExecutor%24ScheduledFutureTask.access%24201(ScheduledThreadPoolExecutor.java%3A180)%5Cn%5Ctat%20java.util.concurrent.ScheduledThreadPoolExecutor%24ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java%3A293)%5Cn%5Ctat%20com.streamsets.datacollector.metrics.MetricSafeScheduledExecutorService%24MetricsTask.run(MetricSafeScheduledExecutorService.java%3A100)%5Cn%5Ctat%20java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java%3A1149)%5Cn%5Ctat%20java.util.concurrent.ThreadPoolExecutor%24Worker.run(ThreadPoolExecutor.java%3A624)%5Cn%5Ctat%20java.lang.Thread.run(Thread.java%3A748)%5CnCaused%20by%3A%20com.github.shyiko.mysql.binlog.network.ServerException%3A%20The%20slave%20is%20connecting%20using%20CHANGE%20MASTER%20TO%20MASTER_AUTO_POSITION%20%3D%201%2C%20but%20the%20master%20has%20purged%20binary%20logs%20containing%20GTIDs%20that%20the%20slave%20requires.%5Cn%5Ctat%20com.github.shyiko.mysql.binlog.BinaryLogClient.listenForEventPackets(BinaryLogClient.java%3A882)%5Cn%5Ctat%20com.github.shyiko.mysql.binlog.BinaryLogClient.connect(BinaryLogClient.java%3A559)%5Cn%5Ctat%20com.github.shyiko.mysql.binlog.BinaryLogClient%247.run(BinaryLogClient.java%3A793)%5Cn%5Ct...%201%20more%22%2C%22id%22%3A%22Chxo8%22%7D\"></card><p><br /></p><p>尝试了手动设置偏移量无果。(参考资料 <a href=\"https://streamsets.com/documentation/datacollector/3.9.x/help/datacollector/UserGuide/Origins/MySQLBinaryLog.html#ariaid-title5\" target=\"_blank\">MySQL Binary Log#Initial Offset</a> ）</p><p>通过查看运行<span>日志，</span><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563761388749-2ef53ec1-40d5-479b-852e-7dfb7261cd67.png%22%2C%22originWidth%22%3A304%2C%22originHeight%22%3A101%2C%22name%22%3A%22image.png%22%2C%22size%22%3A5193%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A304%2C%22height%22%3A101%7D\"></card><span> </span></p><p><span>发现后台还有在运行之前的offset，突然想起在官方文档.</span></p><blockquote><p><strong>Note:</strong> If you change the GTID mode on the database server after you have run a pipeline with the MySQL Binary Log origin, you must reset the origin and change the format of the initial offset value. Otherwise, the origin cannot correctly read the offset.</p><p>When the pipeline stops, the MySQL Binary Log origin notes the offset where it stops reading. When the pipeline starts again, the origin continues processing from the last saved offset. You can reset the origin to process all requested objects.</p></blockquote><p><br /></p><p>以及</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563761746217-5afefc26-937d-44b7-b4c1-ba114e64a154.png%22%2C%22originWidth%22%3A397%2C%22originHeight%22%3A139%2C%22name%22%3A%22image.png%22%2C%22size%22%3A14704%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A397%2C%22height%22%3A139%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563761793852-caf1a2f7-1c81-4b3c-b046-19d2d1dda76e.png%22%2C%22originWidth%22%3A387%2C%22originHeight%22%3A240%2C%22name%22%3A%22image.png%22%2C%22size%22%3A24451%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A387%2C%22height%22%3A240%7D\"></card></p><p>解决办法就简单了，直接在启动时，Reset Origin即可。会从server的当前binlog进行订阅。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563761663744-640cf864-f48f-4ffa-9a7a-811ce396caa3.png%22%2C%22originWidth%22%3A349%2C%22originHeight%22%3A152%2C%22name%22%3A%22image.png%22%2C%22size%22%3A11373%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A349%2C%22height%22%3A152%7D\"></card></p><p><br /></p><p><strong>总结:</strong> </p><p>多看官方文档，仔细看，另外，尽量别用翻译工具，否则类似该案例中的origin会被翻译成原点，起源等，会无法联想到sdc的一些概念用词。</p><h2 id=\"qheIM\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/07/16/fixed-sdc-mysql-binlog-master-purged/\" target=\"_blank\">我的博客<cursor /></a></li><li><a href=\"https://juejin.im/post/5d3652f96fb9a07eda0355aa\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://streamsets.com/documentation/datacollector/3.9.x/help/datacollector/UserGuide/Origins/MySQLBinaryLog.html\" target=\"_blank\">sdc官方文档&gt;MySQL Binary Log</a></li><li><a href=\"http://mysql.taobao.org/monthly/2016/01/08/\" target=\"_blank\">MySQL · 答疑解惑 · GTID不一致分析</a></li><li><a href=\"http://soft.dog/2016/06/13/dig-mysql-binlog/\" target=\"_blank\">Mysql binlog 查看方法</a></li><li><a href=\"https://www.cnblogs.com/kevingrace/p/5907254.html\" target=\"_blank\">Mysql之binlog日志说明及利用binlog日志恢复数据操作记录</a></li><li><a href=\"https://www.cnblogs.com/martinzhang/p/3454358.html\" target=\"_blank\">MySQL的binlog日志</a></li></ul><p><br /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-07-23T00:21:41.000Z",
    "deleted_at": null,
    "created_at": "2019-07-22T01:55:57.000Z",
    "updated_at": "2019-07-23T00:21:41.000Z",
    "published_at": "2019-07-23T00:21:41.000Z",
    "first_published_at": "2019-07-23T00:21:41.000Z",
    "word_count": 959,
    "cover": "",
    "description": "date: 2019-07-22 20:00:52tags: [streamsets,sdc,mysql,binlog,etl,数据分析,数据处理]categories: 大数据---这是坚持技术写作计划（含翻译）的第34篇，定个小目标999，每周最少2篇。streamsets停机时间过长，m...",
    "custom_description": "streamsets停机时间过长，mysql master设置了自动清除binlog，服务启动时报  ERROR MysqlSource - BinaryLogClient server error: The slave is connecting using CHANGE MASTER TO MA",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 2144954,
    "slug": "clean-csv",
    "title": "032-csv文件容错处理",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-07-16 21:30:00<br />tags: [python,csv,数据分析,数据处理]<br />categories: 大数据<br />---\n\n> 这是坚持技术写作计划（含翻译）的第32篇，定个小目标999，每周最少2篇。\n\n\n如果数据库有特殊字符(换行符，转义符),会导致生成的csv无法正常导入。\n\n```\nval1,val2,val3\naa,bb,cc\na\na,bb,cc\naa\n,bb,cc\naa,\nbb,cc\na\\a,bb,cc\n```\n> 第一行header和第二行数据正常。\n> 第三行第一个列有换行符，此时导致第四行看着正常(3列),但是数据又是错误的。\n> 第五行跟第三行类似\n> 第七行实际是第二个单元格首字符换行，导致第八行缺失一列。\n> 第九行有转义符\n\n\n处理成\n\n```\nval1,val2,val3\naa,bb,cc\naa,bb,cc\naa,bb,cc\naa,bb,cc\naa,bb,cc\n```\n\n<!-- more -->\n\n利用空闲时间，用python写了个修补工具,原理是利用，csv是从上往下读的，如果前一行列数不够，一定可以从后一列补上。但是可能存在补完后超过指定列(比如列内包含分隔符，导致数据库3列，变成4列)，所以需要对其切片，只保留指定列数。\n\nclean_csv.py\n```python\n# -*- coding: utf-8 -*-\n# Author AnJia(anjia0532@gmail.com https://anjia0532.github.io)\nimport argparse\nimport sys, os\nimport io\n\nreload(sys)\nsys.setdefaultencoding('utf8')\nblack_dict={\"\\\\\":\"\",\"\\\"\":\"\"}\ndef main():\n    parser = argparse.ArgumentParser()\n    parser.add_argument('--cols', type=int, dest='cols', action='store', default=-1,help=\"count of columns,default first line's cells\")\n    parser.add_argument('--src', type=str, dest='src', action='store', default='',\n                        help='path to source csv file')\n    parser.add_argument('--dest', type=str, dest='dest', action='store', default='',\n                        help='path to dest csv file')\n    parser.add_argument('--encoding', type=str, dest='encoding', action='store', default='utf-8',\n                        help='file encoding,default utf-8')\n    parser.add_argument('--chunksize', type=int, dest='chunksize', action='store', default='10000',\n                        help='batch lines to write dest file,default 10000')\n    parser.add_argument('--delimiter', type=str, dest='delimiter', action='store', default=',',\n                        help='csv delimiter,default ,')\n\n    args = parser.parse_args()\n    cols = args.cols\n    src = args.src\n    dest = args.dest\n    encoding = args.encoding\n    chunksize = args.chunksize\n    delimiter = args.delimiter\n\n    if not (src and dest) or chunksize <= 0:\n      print(\"invaild args!\") \n      sys.exit(-1)\n\n    olds=[]\n    lines=[]\n    with io.open(src,encoding=encoding) as fp:\n      for line in fp.readlines():\n        line = line.strip()\n        for k,v in black_dict.items():\n          if k in line:\n            line=line.replace(k,v)\n        cells = line.split(delimiter)\n        if cols == -1:\n          cols=len(cells)\n\n        if(len(cells) < cols or (len(olds)>0 and len(olds) < cols)):\n          if not olds:\n            olds = cells\n          else:\n            cells[0]=olds[-1]+cells[0]\n            olds.pop()\n            olds.extend(cells)\n          \n        if len(olds) >= cols:\n          cells=olds\n          olds=[]\n        if not olds:\n          lines.append(delimiter.join(cells[0:cols])+\"\\n\")\n\n        if len(lines) % chunksize == 0:\n          write_to_file(dest=dest,lines=lines)\n          lines=[]\n                        \n      write_to_file(dest=dest,lines=lines)\n\ndef write_to_file(dest,lines=[],encoding='utf-8'):\n  p = os.path.split(dest)[0]\n  if not os.path.exists(p):\n    os.makedirs(p)\n  with io.open(file=dest,mode=\"a+\",encoding=encoding) as fp:\n    fp.writelines(lines)\n\nif __name__ == '__main__':\n    main()\n```\n\n使用方式<br />`python clean_csv.py --src=src.csv --dest=dest.csv --chunksize=50000 --cols --encoding=utf-8 --delimiter=,` \n\n<a name=\"iz1V1\"></a>\n## 参考资料\n\n- [我的博客](https://anjia0532.github.io/2019/07/16/clean-csv/)\n- [我的掘金](https://juejin.im/post/5d2ff38b51882526ae230186)\n- [anjia0532/clean_csv.py](https://gist.github.com/anjia0532/6db48b0886d91d9a663e5a9fd19f2aaa)\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-07-16 21:30:00</p><p>tags: [python,csv,数据分析,数据处理]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第32篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>如果数据库有特殊字符(换行符，转义符),会导致生成的csv无法正常导入。</p><p><br /></p><pre><code>val1,val2,val3\naa,bb,cc\na\na,bb,cc\naa\n,bb,cc\naa,\nbb,cc\na\\a,bb,cc</code></pre><blockquote><p>第一行header和第二行数据正常。</p><p>第三行第一个列有换行符，此时导致第四行看着正常(3列),但是数据又是错误的。</p><p>第五行跟第三行类似</p><p>第七行实际是第二个单元格首字符换行，导致第八行缺失一列。</p><p>第九行有转义符</p></blockquote><p><br /></p><p>处理成</p><p><br /></p><pre><code>val1,val2,val3\naa,bb,cc\naa,bb,cc\naa,bb,cc\naa,bb,cc\naa,bb,cc</code></pre><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><p>利用空闲时间，用python写了个修补工具,原理是利用，csv是从上往下读的，如果前一行列数不够，一定可以从后一列补上。但是可能存在补完后超过指定列(比如列内包含分隔符，导致数据库3列，变成4列)，所以需要对其切片，只保留指定列数。</p><p><br /></p><p>clean_csv.py</p><pre data-lang=\"python\"><code># -*- coding: utf-8 -*-\n# Author AnJia(anjia0532@gmail.com https://anjia0532.github.io)\nimport argparse\nimport sys, os\nimport io\n\nreload(sys)\nsys.setdefaultencoding('utf8')\nblack_dict={&quot;\\\\&quot;:&quot;&quot;,&quot;\\&quot;&quot;:&quot;&quot;}\ndef main():\n    parser = argparse.ArgumentParser()\n    parser.add_argument('--cols', type=int, dest='cols', action='store', default=-1,help=&quot;count of columns,default first line's cells&quot;)\n    parser.add_argument('--src', type=str, dest='src', action='store', default='',\n                        help='path to source csv file')\n    parser.add_argument('--dest', type=str, dest='dest', action='store', default='',\n                        help='path to dest csv file')\n    parser.add_argument('--encoding', type=str, dest='encoding', action='store', default='utf-8',\n                        help='file encoding,default utf-8')\n    parser.add_argument('--chunksize', type=int, dest='chunksize', action='store', default='10000',\n                        help='batch lines to write dest file,default 10000')\n    parser.add_argument('--delimiter', type=str, dest='delimiter', action='store', default=',',\n                        help='csv delimiter,default ,')\n\n    args = parser.parse_args()\n    cols = args.cols\n    src = args.src\n    dest = args.dest\n    encoding = args.encoding\n    chunksize = args.chunksize\n    delimiter = args.delimiter\n\n    if not (src and dest) or chunksize &lt;= 0:\n      print(&quot;invaild args!&quot;) \n      sys.exit(-1)\n\n    olds=[]\n    lines=[]\n    with io.open(src,encoding=encoding) as fp:\n      for line in fp.readlines():\n        line = line.strip()\n        for k,v in black_dict.items():\n          if k in line:\n            line=line.replace(k,v)\n        cells = line.split(delimiter)\n        if cols == -1:\n          cols=len(cells)\n\n        if(len(cells) &lt; cols or (len(olds)&gt;0 and len(olds) &lt; cols)):\n          if not olds:\n            olds = cells\n          else:\n            cells[0]=olds[-1]+cells[0]\n            olds.pop()\n            olds.extend(cells)\n          \n        if len(olds) &gt;= cols:\n          cells=olds\n          olds=[]\n        if not olds:\n          lines.append(delimiter.join(cells[0:cols])+&quot;\\n&quot;)\n\n        if len(lines) % chunksize == 0:\n          write_to_file(dest=dest,lines=lines)\n          lines=[]\n                        \n      write_to_file(dest=dest,lines=lines)\n\ndef write_to_file(dest,lines=[],encoding='utf-8'):\n  p = os.path.split(dest)[0]\n  if not os.path.exists(p):\n    os.makedirs(p)\n  with io.open(file=dest,mode=&quot;a+&quot;,encoding=encoding) as fp:\n    fp.writelines(lines)\n\nif __name__ == '__main__':\n    main()</code></pre><p><br /></p><p>使用方式</p><p><code>python clean_csv.py --src=src.csv --dest=dest.csv --chunksize=50000 --cols --encoding=utf-8 --delimiter=,</code> </p><p><br /></p><h2 id=\"iz1V1\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/07/16/clean-csv/\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d2ff38b51882526ae230186\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://gist.github.com/anjia0532/6db48b0886d91d9a663e5a9fd19f2aaa\" target=\"_blank\">anjia0532/clean_csv.py</a></li></ul>",
    "body_lake": "<!doctype lake><p>date: 2019-07-16 21:30:00</p><p>tags: [python,csv,数据分析,数据处理]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第32篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>如果数据库有特殊字符(换行符，转义符),会导致生成的csv无法正常导入。</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22plain%22%2C%22code%22%3A%22val1%2Cval2%2Cval3%5Cnaa%2Cbb%2Ccc%5Cna%5Cna%2Cbb%2Ccc%5Cnaa%5Cn%2Cbb%2Ccc%5Cnaa%2C%5Cnbb%2Ccc%5Cna%5C%5Ca%2Cbb%2Ccc%22%2C%22id%22%3A%22nhq3O%22%7D\"></card><blockquote><p>第一行header和第二行数据正常。</p><p>第三行第一个列有换行符，此时导致第四行看着正常(3列),但是数据又是错误的。</p><p>第五行跟第三行类似</p><p>第七行实际是第二个单元格首字符换行，导致第八行缺失一列。</p><p>第九行有转义符</p></blockquote><p><br /></p><p>处理成</p><p><cursor /><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22plain%22%2C%22code%22%3A%22val1%2Cval2%2Cval3%5Cnaa%2Cbb%2Ccc%5Cnaa%2Cbb%2Ccc%5Cnaa%2Cbb%2Ccc%5Cnaa%2Cbb%2Ccc%5Cnaa%2Cbb%2Ccc%22%2C%22id%22%3A%22wNoY1%22%7D\"></card><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><p>利用空闲时间，用python写了个修补工具,原理是利用，csv是从上往下读的，如果前一行列数不够，一定可以从后一列补上。但是可能存在补完后超过指定列(比如列内包含分隔符，导致数据库3列，变成4列)，所以需要对其切片，只保留指定列数。</p><p><br /></p><p>clean_csv.py</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22python%22%2C%22code%22%3A%22%23%20-*-%20coding%3A%20utf-8%20-*-%5Cn%23%20Author%20AnJia(anjia0532%40gmail.com%20https%3A%2F%2Fanjia0532.github.io)%5Cnimport%20argparse%5Cnimport%20sys%2C%20os%5Cnimport%20io%5Cn%5Cnreload(sys)%5Cnsys.setdefaultencoding('utf8')%5Cnblack_dict%3D%7B%5C%22%5C%5C%5C%5C%5C%22%3A%5C%22%5C%22%2C%5C%22%5C%5C%5C%22%5C%22%3A%5C%22%5C%22%7D%5Cndef%20main()%3A%5Cn%20%20%20%20parser%20%3D%20argparse.ArgumentParser()%5Cn%20%20%20%20parser.add_argument('--cols'%2C%20type%3Dint%2C%20dest%3D'cols'%2C%20action%3D'store'%2C%20default%3D-1%2Chelp%3D%5C%22count%20of%20columns%2Cdefault%20first%20line's%20cells%5C%22)%5Cn%20%20%20%20parser.add_argument('--src'%2C%20type%3Dstr%2C%20dest%3D'src'%2C%20action%3D'store'%2C%20default%3D''%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20help%3D'path%20to%20source%20csv%20file')%5Cn%20%20%20%20parser.add_argument('--dest'%2C%20type%3Dstr%2C%20dest%3D'dest'%2C%20action%3D'store'%2C%20default%3D''%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20help%3D'path%20to%20dest%20csv%20file')%5Cn%20%20%20%20parser.add_argument('--encoding'%2C%20type%3Dstr%2C%20dest%3D'encoding'%2C%20action%3D'store'%2C%20default%3D'utf-8'%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20help%3D'file%20encoding%2Cdefault%20utf-8')%5Cn%20%20%20%20parser.add_argument('--chunksize'%2C%20type%3Dint%2C%20dest%3D'chunksize'%2C%20action%3D'store'%2C%20default%3D'10000'%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20help%3D'batch%20lines%20to%20write%20dest%20file%2Cdefault%2010000')%5Cn%20%20%20%20parser.add_argument('--delimiter'%2C%20type%3Dstr%2C%20dest%3D'delimiter'%2C%20action%3D'store'%2C%20default%3D'%2C'%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20help%3D'csv%20delimiter%2Cdefault%20%2C')%5Cn%5Cn%20%20%20%20args%20%3D%20parser.parse_args()%5Cn%20%20%20%20cols%20%3D%20args.cols%5Cn%20%20%20%20src%20%3D%20args.src%5Cn%20%20%20%20dest%20%3D%20args.dest%5Cn%20%20%20%20encoding%20%3D%20args.encoding%5Cn%20%20%20%20chunksize%20%3D%20args.chunksize%5Cn%20%20%20%20delimiter%20%3D%20args.delimiter%5Cn%5Cn%20%20%20%20if%20not%20(src%20and%20dest)%20or%20chunksize%20%3C%3D%200%3A%5Cn%20%20%20%20%20%20print(%5C%22invaild%20args!%5C%22)%20%5Cn%20%20%20%20%20%20sys.exit(-1)%5Cn%5Cn%20%20%20%20olds%3D%5B%5D%5Cn%20%20%20%20lines%3D%5B%5D%5Cn%20%20%20%20with%20io.open(src%2Cencoding%3Dencoding)%20as%20fp%3A%5Cn%20%20%20%20%20%20for%20line%20in%20fp.readlines()%3A%5Cn%20%20%20%20%20%20%20%20line%20%3D%20line.strip()%5Cn%20%20%20%20%20%20%20%20for%20k%2Cv%20in%20black_dict.items()%3A%5Cn%20%20%20%20%20%20%20%20%20%20if%20k%20in%20line%3A%5Cn%20%20%20%20%20%20%20%20%20%20%20%20line%3Dline.replace(k%2Cv)%5Cn%20%20%20%20%20%20%20%20cells%20%3D%20line.split(delimiter)%5Cn%20%20%20%20%20%20%20%20if%20cols%20%3D%3D%20-1%3A%5Cn%20%20%20%20%20%20%20%20%20%20cols%3Dlen(cells)%5Cn%5Cn%20%20%20%20%20%20%20%20if(len(cells)%20%3C%20cols%20or%20(len(olds)%3E0%20and%20len(olds)%20%3C%20cols))%3A%5Cn%20%20%20%20%20%20%20%20%20%20if%20not%20olds%3A%5Cn%20%20%20%20%20%20%20%20%20%20%20%20olds%20%3D%20cells%5Cn%20%20%20%20%20%20%20%20%20%20else%3A%5Cn%20%20%20%20%20%20%20%20%20%20%20%20cells%5B0%5D%3Dolds%5B-1%5D%2Bcells%5B0%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20olds.pop()%5Cn%20%20%20%20%20%20%20%20%20%20%20%20olds.extend(cells)%5Cn%20%20%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20if%20len(olds)%20%3E%3D%20cols%3A%5Cn%20%20%20%20%20%20%20%20%20%20cells%3Dolds%5Cn%20%20%20%20%20%20%20%20%20%20olds%3D%5B%5D%5Cn%20%20%20%20%20%20%20%20if%20not%20olds%3A%5Cn%20%20%20%20%20%20%20%20%20%20lines.append(delimiter.join(cells%5B0%3Acols%5D)%2B%5C%22%5C%5Cn%5C%22)%5Cn%5Cn%20%20%20%20%20%20%20%20if%20len(lines)%20%25%20chunksize%20%3D%3D%200%3A%5Cn%20%20%20%20%20%20%20%20%20%20write_to_file(dest%3Ddest%2Clines%3Dlines)%5Cn%20%20%20%20%20%20%20%20%20%20lines%3D%5B%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20write_to_file(dest%3Ddest%2Clines%3Dlines)%5Cn%5Cndef%20write_to_file(dest%2Clines%3D%5B%5D%2Cencoding%3D'utf-8')%3A%5Cn%20%20p%20%3D%20os.path.split(dest)%5B0%5D%5Cn%20%20if%20not%20os.path.exists(p)%3A%5Cn%20%20%20%20os.makedirs(p)%5Cn%20%20with%20io.open(file%3Ddest%2Cmode%3D%5C%22a%2B%5C%22%2Cencoding%3Dencoding)%20as%20fp%3A%5Cn%20%20%20%20fp.writelines(lines)%5Cn%5Cnif%20__name__%20%3D%3D%20'__main__'%3A%5Cn%20%20%20%20main()%22%2C%22id%22%3A%22JDuW5%22%7D\"></card><p><br /></p><p>使用方式</p><p><code>python clean_csv.py --src=src.csv --dest=dest.csv --chunksize=50000 --cols --encoding=utf-8 --delimiter=,</code> </p><p><br /></p><h2 id=\"iz1V1\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/07/16/clean-csv/\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d2ff38b51882526ae230186\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://gist.github.com/anjia0532/6db48b0886d91d9a663e5a9fd19f2aaa\" target=\"_blank\">anjia0532/clean_csv.py</a></li></ul>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-07-18T10:25:09.000Z",
    "deleted_at": null,
    "created_at": "2019-07-18T03:51:35.000Z",
    "updated_at": "2019-07-18T10:25:22.000Z",
    "published_at": "2019-07-18T10:25:21.000Z",
    "first_published_at": "2019-07-18T04:18:43.000Z",
    "word_count": 697,
    "cover": "",
    "description": "date: 2019-07-16 21:30:00tags: [python,csv,数据分析,数据处理]categories: 大数据---这是坚持技术写作计划（含翻译）的第32篇，定个小目标999，每周最少2篇。如果数据库有特殊字符(换行符，转义符),会导致生成的csv无法正常导入。val...",
    "custom_description": "如果数据库有特殊字符(换行符，转义符),会导致生成的csv无法正常导入。val1,val2,val3 aa,bb,cc a a,bb,cc aa ,bb,cc aa, bb,cc a\\a,bb,cc第一行header和第二行数据正常。第三行第一个列有换行符，此时导致第四行看着正常(3列),但是...",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 2085589,
    "slug": "mysql-to-clickhouse",
    "title": "033-史上最全-mysql迁移到clickhouse的5种办法",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-07-17 22:15:38<br />tags: [数据分析,数据处理,mysql,数据库,clickhouse]<br />categories: 大数据<br />---\n\n> 这是坚持技术写作计划（含翻译）的第33篇，定个小目标999，每周最少2篇。\n\n\n数据迁移需要从mysql导入clickhouse, 总结方案如下，包括clickhouse自身支持的三种方式，第三方工具两种。\n\n<!-- more -->\n<a name=\"0nrjs\"></a>\n## create table engin mysql\n\n```sql\nCREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster]\n(\n    name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1] [TTL expr1],\n    name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2] [TTL expr2],\n    ...\n    INDEX index_name1 expr1 TYPE type1(...) GRANULARITY value1,\n    INDEX index_name2 expr2 TYPE type2(...) GRANULARITY value2\n) ENGINE = MySQL('host:port', 'database', 'table', 'user', 'password'[, replace_query, 'on_duplicate_clause']);\n```\n\n> 官方文档: [https://clickhouse.yandex/docs/en/operations/table_engines/mysql/](https://clickhouse.yandex/docs/en/operations/table_engines/mysql/)\n\n注意，实际数据存储在远端mysql数据库中，可以理解成外表。<br />可以通过在mysql增删数据进行验证。\n\n<a name=\"CDYbo\"></a>\n## insert into select from\n\n```sql\n-- 先建表\nCREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster]\n(\n    name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1],\n    name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2],\n    ...\n) ENGINE = engine\n-- 导入数据\nINSERT INTO [db.]table [(c1, c2, c3)] select 列或者* from mysql('host:port', 'db', 'table_name', 'user', 'password')\n```\n可以自定义列类型，列数，使用clickhouse函数对数据进行处理，比如 `select toDate(xx) from mysql(\"host:port\",\"db\",\"table_name\",\"user_name\",\"password\")` \n\n<a name=\"jwRVs\"></a>\n## create table as select from\n\n```sql\nCREATE TABLE [IF NOT EXISTS] [db.]table_name\nENGINE =Log\nAS \nSELECT *\nFROM mysql('host:port', 'db', 'article_clientuser_sum', 'user', 'password')\n```\n> 网友文章: [http://jackpgao.github.io/2018/02/04/ClickHouse-Use-MySQL-Data/](http://jackpgao.github.io/2018/02/04/ClickHouse-Use-MySQL-Data/)\n\n不支持自定义列，参考资料里的博主写的 `ENGIN=MergeTree` 测试失败。<br />可以理解成 create table 和 insert into select 的组合\n\n<a name=\"rbmGL\"></a>\n## Altinity/clickhouse-mysql-data-reader\nAltinity公司开源的一个python工具，用来从mysql迁移数据到clickhouse(支持binlog增量更新和全量导入)，但是官方readme和代码脱节，根据quick start跑不通。\n```bash\n## 创建表\nclickhouse-mysql \\\n    --src-host=127.0.0.1 \\\n    --src-user=reader \\\n    --src-password=Qwerty1# \\\n    --table-templates-with-create-database \\\n    --src-table=airline.ontime > create_clickhouse_table_template.sql\n## 修改脚本\nvim create_clickhouse_table_template.sql\n\n## 导入建表\nclickhouse-client -mn < create_clickhouse_table_template.sql\n\n## 数据导入\nclickhouse-mysql \\\n     --src-host=127.0.0.1 \\\n     --src-user=reader \\\n     --src-password=Qwerty1# \\\n     --table-migrate \\\n     --dst-host=127.0.0.1 \\\n     --dst-table=logunified \\\n     --csvpool\n```\n> 官方文档: [https://github.com/Altinity/clickhouse-mysql-data-reader#mysql-migration-case-1---migrate-existing-data](https://github.com/Altinity/clickhouse-mysql-data-reader#mysql-migration-case-1---migrate-existing-data)\n\n\n注意，上述三种都是从mysql导入clickhouse，如果数据量大，对于mysql压力还是挺大的。下面介绍两种离线方式(streamsets支持实时，也支持离线)<br />csv\n\n```bash\n## 忽略建表\nclickhouse-client \\\n  -h host \\\n  --query=\"INSERT INTO [db].table FORMAT CSV\" < test.csv\n```\n\n但是如果源数据质量不高，往往会有问题，比如包含特殊字符(分隔符，转义符)，或者换行。被坑的很惨。\n\n- 自定义分隔符, `--format_csv_delimiter=\"|\"` \n- 遇到错误跳过而不中止， `--input_format_allow_errors_num=10` 最多允许10行错误, `--input_format_allow_errors_ratio=0.1` 允许10%的错误\n- csv 跳过空值(null) ，报 `Code: 27. DB::Exception: Cannot parse input: expected , before: xxxx: (at row 69) ERROR: garbage after Nullable(Date): \"8,002<LINE FEED>0205\"`  `sed ' :a;s/,,/,\\\\N,/g;ta' |clickhouse-client -h host --query \"INSERT INTO [db].table FORMAT CSV\"` 将 `,,` 替换成 `,\\N,` \n\n`python clean_csv.py --src=src.csv --dest=dest.csv --chunksize=50000 --cols --encoding=utf-8 --delimiter=,` \n\nclean_csv.py参考我另外一篇 [032-csv文件容错处理](https://anjia0532.github.io/2019/07/16/clean-csv/) \n\n<a name=\"JB7MZ\"></a>\n## streamsets\nstreamsets支持从mysql或者读csv全量导入，也支持订阅binlog增量插入，参考我另外一篇 [025-大数据ETL工具之StreamSets安装及订阅mysql binlog](https://anjia0532.github.io/2019/06/10/cdh-streamsets/)。<br />本文只展示从mysql全量导入clickhouse<br />本文假设你已经搭建起streamsets服务<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563437517163-af02c2db-f03b-4884-8f16-4850918ddc0d.png#align=left&display=inline&height=850&name=image.png&originHeight=850&originWidth=1911&size=97265&status=done&width=1911)<br />启用并重启服务<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563437777046-970dff85-960f-48f3-a3e9-0a10002f34b4.png#align=left&display=inline&height=860&name=image.png&originHeight=860&originWidth=1843&size=89828&status=done&width=1843)<br />上传mysql和clickhouse的jdbc jar和依赖包<br />便捷方式，创建pom.xml，使用maven统一下载\n\n```xml\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n  xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd\">\n  <modelVersion>4.0.0</modelVersion>\n  <groupId>com.anjia</groupId>\n  <artifactId>demo</artifactId>\n  <packaging>jar</packaging>\n  <version>1.0-SNAPSHOT</version>\n  <name>demo</name>\n  <url>http://maven.apache.org</url>\n  <dependencies>\n    <dependency>\n        <groupId>ru.yandex.clickhouse</groupId>\n        <artifactId>clickhouse-jdbc</artifactId>\n        <version>0.1.54</version>\n    </dependency>\n    <dependency>\n      <groupId>mysql</groupId>\n      <artifactId>mysql-connector-java</artifactId>\n      <version>5.1.47</version>\n  </dependency>\n  </dependencies>\n</project>\n```\n如果本地装有maven，执行如下命令<br />`mvn dependency:copy-dependencies -DoutputDirectory=lib -DincludeScope=compile` <br />所有需要的jar会下载并复制到lib目录下<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563438052063-1f073ee5-1c50-4842-8f9e-5f9974867895.png#align=left&display=inline&height=298&name=image.png&originHeight=298&originWidth=391&size=34034&status=done&width=391)<br />然后拷贝到 streamsets `/opt/streamsets-datacollector-3.9.1/streamsets-libs-extras/streamsets-datacollector-jdbc-lib/lib/` 目录下<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563442430751-7889c386-014a-417e-bc0c-069414f08b89.png#align=left&display=inline&height=740&name=image.png&originHeight=740&originWidth=751&size=59852&status=done&width=751)<br />重启streamsets服务<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563443529858-b23e198f-a097-4359-ad0b-85768a5c68ec.png#align=left&display=inline&height=320&name=image.png&originHeight=320&originWidth=194&size=13854&status=done&width=194)![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563443568159-590b99dc-af61-45d2-8724-b33d08ba7df2.png#align=left&display=inline&height=235&name=image.png&originHeight=235&originWidth=189&size=9943&status=done&width=189)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563444143877-060e4c52-53af-42f3-99e2-38cfc2add983.png#align=left&display=inline&height=726&name=image.png&originHeight=726&originWidth=1253&size=83069&status=done&width=1253)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563444315768-4295a91d-b610-4df8-8796-196358662c68.png#align=left&display=inline&height=776&name=image.png&originHeight=776&originWidth=1378&size=80345&status=done&width=1378)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563444358478-d8bd7c56-c0c0-49a6-903e-1d284d812e5d.png#align=left&display=inline&height=773&name=image.png&originHeight=773&originWidth=1344&size=81650&status=done&width=1344)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1563444395375-690becdc-1f48-4cfb-b6bd-13d03554cbc1.png#align=left&display=inline&height=785&name=image.png&originHeight=785&originWidth=1629&size=69971&status=done&width=1629)\n<a name=\"ri8A5\"></a>\n## 参考资料\n\n- [我的博客](https://anjia0532.github.io/2019/07/17/mysql-to-clickhouse)\n- [我的掘金](https://juejin.im/post/5d30454ce51d4510bf1d6737)\n- [Building data stream pipelines with CrateDB and StreamSets data collector](https://crate.io/docs/crate/guide/en/latest/tools/streamsets.html)\n- [JDBC Query Consumer](https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/JDBCConsumer.html)\n- [Data Flow Pipeline Using StreamSets](https://dzone.com/articles/data-flow-pipeline-using-streamsets)\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-07-17 22:15:38</p><p>tags: [数据分析,数据处理,mysql,数据库,clickhouse]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第33篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>数据迁移需要从mysql导入clickhouse, 总结方案如下，包括clickhouse自身支持的三种方式，第三方工具两种。</p><p><br /></p><p>&lt;!-- more --&gt;</p><h2 id=\"0nrjs\"><span style=\"background-color: transparent;\">create table engin mysql</span></h2><p><br /></p><pre data-lang=\"sql\"><code>CREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster]\n(\n    name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1] [TTL expr1],\n    name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2] [TTL expr2],\n    ...\n    INDEX index_name1 expr1 TYPE type1(...) GRANULARITY value1,\n    INDEX index_name2 expr2 TYPE type2(...) GRANULARITY value2\n) ENGINE = MySQL('host:port', 'database', 'table', 'user', 'password'[, replace_query, 'on_duplicate_clause']);</code></pre><p><br /></p><blockquote><p>官方文档: <a href=\"https://clickhouse.yandex/docs/en/operations/table_engines/mysql/\" target=\"_blank\">https://clickhouse.yandex/docs/en/operations/table_engines/mysql/</a></p></blockquote><p>注意，实际数据存储在远端mysql数据库中，可以理解成外表。</p><p>可以通过在mysql增删数据进行验证。</p><p><br /></p><h2 id=\"CDYbo\">insert into select from</h2><p><br /></p><pre data-lang=\"sql\"><code>-- 先建表\nCREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster]\n(\n    name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1],\n    name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2],\n    ...\n) ENGINE = engine\n-- 导入数据\nINSERT INTO [db.]table [(c1, c2, c3)] select 列或者* from mysql('host:port', 'db', 'table_name', 'user', 'password')</code></pre><p>可以自定义列类型，列数，使用clickhouse函数对数据进行处理，比如 <code>select toDate(xx) from mysql(&quot;host:port&quot;,&quot;db&quot;,&quot;table_name&quot;,&quot;user_name&quot;,&quot;password&quot;)</code> </p><p><br /></p><h2 id=\"jwRVs\"><span style=\"background-color: transparent;\">create table as select from</span></h2><p><br /></p><pre data-lang=\"sql\"><code>CREATE TABLE [IF NOT EXISTS] [db.]table_name\nENGINE =Log\nAS \nSELECT *\nFROM mysql('host:port', 'db', 'article_clientuser_sum', 'user', 'password')</code></pre><blockquote><p>网友文章: <a href=\"http://jackpgao.github.io/2018/02/04/ClickHouse-Use-MySQL-Data/\" target=\"_blank\">http://jackpgao.github.io/2018/02/04/ClickHouse-Use-MySQL-Data/</a></p></blockquote><p>不支持自定义列，参考资料里的博主写的 <code>ENGIN=MergeTree</code> 测试失败。</p><p>可以理解成 create table 和 insert into select 的组合</p><p><br /></p><h2 id=\"rbmGL\">Altinity/clickhouse-mysql-data-reader</h2><p>Altinity公司开源的一个python工具，用来从mysql迁移数据到clickhouse(支持binlog增量更新和全量导入)，但是官方readme和代码脱节，根据quick start跑不通。</p><pre data-lang=\"bash\"><code>## 创建表\nclickhouse-mysql \\\n    --src-host=127.0.0.1 \\\n    --src-user=reader \\\n    --src-password=Qwerty1# \\\n    --table-templates-with-create-database \\\n    --src-table=airline.ontime &gt; create_clickhouse_table_template.sql\n## 修改脚本\nvim create_clickhouse_table_template.sql\n\n## 导入建表\nclickhouse-client -mn &lt; create_clickhouse_table_template.sql\n\n## 数据导入\nclickhouse-mysql \\\n     --src-host=127.0.0.1 \\\n     --src-user=reader \\\n     --src-password=Qwerty1# \\\n     --table-migrate \\\n     --dst-host=127.0.0.1 \\\n     --dst-table=logunified \\\n     --csvpool</code></pre><blockquote><p>官方文档: <a href=\"https://github.com/Altinity/clickhouse-mysql-data-reader#mysql-migration-case-1---migrate-existing-data\" target=\"_blank\">https://github.com/Altinity/clickhouse-mysql-data-reader#mysql-migration-case-1---migrate-existing-data</a></p></blockquote><p><br /></p><p>注意，上述三种都是从mysql导入clickhouse，如果数据量大，对于mysql压力还是挺大的。下面介绍两种离线方式(streamsets支持实时，也支持离线)</p><p><span style=\"background-color: transparent;\">csv</span></p><p><br /></p><pre data-lang=\"bash\"><code>## 忽略建表\nclickhouse-client \\\n  -h host \\\n  --query=&quot;INSERT INTO [db].table FORMAT CSV&quot; &lt; test.csv</code></pre><p><br /></p><p>但是如果源数据质量不高，往往会有问题，比如包含特殊字符(分隔符，转义符)，或者换行。被坑的很惨。</p><p><br /></p><ul><li>自定义分隔符, <code>--format_csv_delimiter=&quot;|&quot;</code> </li><li>遇到错误跳过而不中止， <code>--input_format_allow_errors_num=10</code> 最多允许10行错误, <code>--input_format_allow_errors_ratio=0.1</code> 允许10%的错误</li><li>csv 跳过空值(null) ，报 <code>Code: 27. DB::Exception: Cannot parse input: expected , before: xxxx: (at row 69) ERROR: garbage after Nullable(Date): &quot;8,002&lt;LINE FEED&gt;0205&quot;</code>  <code>sed ' :a;s/,,/,\\\\N,/g;ta' |clickhouse-client -h host --query &quot;INSERT INTO [db].table FORMAT CSV&quot;</code> 将 <code>,,</code> 替换成 <code>,\\N,</code> </li></ul><p><br /></p><p><code>python clean_csv.py --src=src.csv --dest=dest.csv --chunksize=50000 --cols --encoding=utf-8 --delimiter=,</code> </p><p><br /></p><p>clean_csv.py参考我另外一篇 <a href=\"https://anjia0532.github.io/2019/07/16/clean-csv/\" target=\"_blank\">032-csv文件容错处理</a> </p><p><br /></p><h2 id=\"JB7MZ\"><span style=\"background-color: transparent;\">streamsets</span></h2><p><span style=\"background-color: transparent;\">streamsets支持从mysql或者读csv全量导入，也支持订阅binlog增量插入，参考我另外一篇 </span><a href=\"https://anjia0532.github.io/2019/06/10/cdh-streamsets/\" target=\"_blank\">025-大数据ETL工具之StreamSets安装及订阅mysql binlog</a><span style=\"background-color: transparent;\">。</span></p><p>本文只展示从mysql全量导入clickhouse</p><p>本文假设你已经搭建起streamsets服务</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563437517163-af02c2db-f03b-4884-8f16-4850918ddc0d.png#align=left&amp;display=inline&amp;height=850&amp;name=image.png&amp;originHeight=850&amp;originWidth=1911&amp;size=97265&amp;status=done&amp;width=1911\" style=\"max-width: 600px; width: 1911px;\" /></p><p>启用并重启服务</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563437777046-970dff85-960f-48f3-a3e9-0a10002f34b4.png#align=left&amp;display=inline&amp;height=860&amp;name=image.png&amp;originHeight=860&amp;originWidth=1843&amp;size=89828&amp;status=done&amp;width=1843\" style=\"max-width: 600px; width: 1843px;\" /></p><p>上传mysql和clickhouse的jdbc jar和依赖包</p><p>便捷方式，创建pom.xml，使用maven统一下载</p><p><br /></p><pre data-lang=\"xml\"><code>&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n  xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;&gt;\n  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n  &lt;groupId&gt;com.anjia&lt;/groupId&gt;\n  &lt;artifactId&gt;demo&lt;/artifactId&gt;\n  &lt;packaging&gt;jar&lt;/packaging&gt;\n  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;\n  &lt;name&gt;demo&lt;/name&gt;\n  &lt;url&gt;http://maven.apache.org&lt;/url&gt;\n  &lt;dependencies&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;ru.yandex.clickhouse&lt;/groupId&gt;\n        &lt;artifactId&gt;clickhouse-jdbc&lt;/artifactId&gt;\n        &lt;version&gt;0.1.54&lt;/version&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n      &lt;groupId&gt;mysql&lt;/groupId&gt;\n      &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;\n      &lt;version&gt;5.1.47&lt;/version&gt;\n  &lt;/dependency&gt;\n  &lt;/dependencies&gt;\n&lt;/project&gt;</code></pre><p>如果本地装有maven，执行如下命令</p><p><code>mvn dependency:copy-dependencies -DoutputDirectory=lib -DincludeScope=compile</code> </p><p>所有需要的jar会下载并复制到lib目录下</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563438052063-1f073ee5-1c50-4842-8f9e-5f9974867895.png#align=left&amp;display=inline&amp;height=298&amp;name=image.png&amp;originHeight=298&amp;originWidth=391&amp;size=34034&amp;status=done&amp;width=391\" style=\"max-width: 600px; width: 391px;\" /></p><p>然后拷贝到 streamsets <code>/opt/streamsets-datacollector-3.9.1/streamsets-libs-extras/streamsets-datacollector-jdbc-lib/lib/</code> 目录下</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563442430751-7889c386-014a-417e-bc0c-069414f08b89.png#align=left&amp;display=inline&amp;height=740&amp;name=image.png&amp;originHeight=740&amp;originWidth=751&amp;size=59852&amp;status=done&amp;width=751\" style=\"max-width: 600px; width: 751px;\" /></p><p>重启streamsets服务</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563443529858-b23e198f-a097-4359-ad0b-85768a5c68ec.png#align=left&amp;display=inline&amp;height=320&amp;name=image.png&amp;originHeight=320&amp;originWidth=194&amp;size=13854&amp;status=done&amp;width=194\" style=\"max-width: 600px; width: 194px;\" /><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563443568159-590b99dc-af61-45d2-8724-b33d08ba7df2.png#align=left&amp;display=inline&amp;height=235&amp;name=image.png&amp;originHeight=235&amp;originWidth=189&amp;size=9943&amp;status=done&amp;width=189\" style=\"max-width: 600px; width: 189px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563444143877-060e4c52-53af-42f3-99e2-38cfc2add983.png#align=left&amp;display=inline&amp;height=726&amp;name=image.png&amp;originHeight=726&amp;originWidth=1253&amp;size=83069&amp;status=done&amp;width=1253\" style=\"max-width: 600px; width: 1253px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563444315768-4295a91d-b610-4df8-8796-196358662c68.png#align=left&amp;display=inline&amp;height=776&amp;name=image.png&amp;originHeight=776&amp;originWidth=1378&amp;size=80345&amp;status=done&amp;width=1378\" style=\"max-width: 600px; width: 1378px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563444358478-d8bd7c56-c0c0-49a6-903e-1d284d812e5d.png#align=left&amp;display=inline&amp;height=773&amp;name=image.png&amp;originHeight=773&amp;originWidth=1344&amp;size=81650&amp;status=done&amp;width=1344\" style=\"max-width: 600px; width: 1344px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1563444395375-690becdc-1f48-4cfb-b6bd-13d03554cbc1.png#align=left&amp;display=inline&amp;height=785&amp;name=image.png&amp;originHeight=785&amp;originWidth=1629&amp;size=69971&amp;status=done&amp;width=1629\" style=\"max-width: 600px; width: 1629px;\" /></p><h2 id=\"ri8A5\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/07/17/mysql-to-clickhouse\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d30454ce51d4510bf1d6737\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://crate.io/docs/crate/guide/en/latest/tools/streamsets.html\" target=\"_blank\"><span style=\"color: #000000;\">Building data stream pipelines with CrateDB and StreamSets data collector</span></a></li><li><a href=\"https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/JDBCConsumer.html\" target=\"_blank\">JDBC Query Consumer</a></li><li><a href=\"https://dzone.com/articles/data-flow-pipeline-using-streamsets\" target=\"_blank\">Data Flow Pipeline Using StreamSets</a></li></ul>",
    "body_lake": "<!doctype lake><p>date: 2019-07-17 22:15:38</p><p>tags: [数据分析,数据处理,mysql,数据库,clickhouse]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第33篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>数据迁移需要从mysql导入clickhouse, 总结方案如下，包括clickhouse自身支持的三种方式，第三方工具两种。</p><p><br /></p><p>&lt;!-- more --&gt;</p><h2 id=\"0nrjs\"><span style=\"background-color: transparent;\">create table engin mysql</span></h2><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22sql%22%2C%22code%22%3A%22CREATE%20TABLE%20%5BIF%20NOT%20EXISTS%5D%20%5Bdb.%5Dtable_name%20%5BON%20CLUSTER%20cluster%5D%5Cn(%5Cn%20%20%20%20name1%20%5Btype1%5D%20%5BDEFAULT%7CMATERIALIZED%7CALIAS%20expr1%5D%20%5BTTL%20expr1%5D%2C%5Cn%20%20%20%20name2%20%5Btype2%5D%20%5BDEFAULT%7CMATERIALIZED%7CALIAS%20expr2%5D%20%5BTTL%20expr2%5D%2C%5Cn%20%20%20%20...%5Cn%20%20%20%20INDEX%20index_name1%20expr1%20TYPE%20type1(...)%20GRANULARITY%20value1%2C%5Cn%20%20%20%20INDEX%20index_name2%20expr2%20TYPE%20type2(...)%20GRANULARITY%20value2%5Cn)%20ENGINE%20%3D%20MySQL('host%3Aport'%2C%20'database'%2C%20'table'%2C%20'user'%2C%20'password'%5B%2C%20replace_query%2C%20'on_duplicate_clause'%5D)%3B%22%2C%22id%22%3A%22DK6QU%22%7D\"></card><p><br /></p><blockquote><p>官方文档: <a href=\"https://clickhouse.yandex/docs/en/operations/table_engines/mysql/\" target=\"_blank\">https://clickhouse.yandex/docs/en/operations/table_engines/mysql/</a></p></blockquote><p>注意，实际数据存储在远端mysql数据库中，可以理解成外表。</p><p>可以通过在mysql增删数据进行验证。</p><p><br /></p><h2 id=\"CDYbo\">insert into select from</h2><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22sql%22%2C%22code%22%3A%22--%20%E5%85%88%E5%BB%BA%E8%A1%A8%5CnCREATE%20TABLE%20%5BIF%20NOT%20EXISTS%5D%20%5Bdb.%5Dtable_name%20%5BON%20CLUSTER%20cluster%5D%5Cn(%5Cn%20%20%20%20name1%20%5Btype1%5D%20%5BDEFAULT%7CMATERIALIZED%7CALIAS%20expr1%5D%2C%5Cn%20%20%20%20name2%20%5Btype2%5D%20%5BDEFAULT%7CMATERIALIZED%7CALIAS%20expr2%5D%2C%5Cn%20%20%20%20...%5Cn)%20ENGINE%20%3D%20engine%5Cn--%20%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%5CnINSERT%20INTO%20%5Bdb.%5Dtable%20%5B(c1%2C%20c2%2C%20c3)%5D%20select%20%E5%88%97%E6%88%96%E8%80%85*%20from%20mysql('host%3Aport'%2C%20'db'%2C%20'table_name'%2C%20'user'%2C%20'password')%22%2C%22id%22%3A%228iUeB%22%7D\"></card><p>可以自定义列类型，列数，使用clickhouse函数对数据进行处理，比如 <code>select toDate(xx) from mysql(&quot;host:port&quot;,&quot;db&quot;,&quot;table_name&quot;,&quot;user_name&quot;,&quot;password&quot;)</code> </p><p><br /></p><h2 id=\"jwRVs\"><span style=\"background-color: transparent;\">create table as select from</span></h2><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22sql%22%2C%22code%22%3A%22CREATE%20TABLE%20%5BIF%20NOT%20EXISTS%5D%20%5Bdb.%5Dtable_name%5CnENGINE%20%3DLog%5CnAS%20%5CnSELECT%20*%5CnFROM%20mysql('host%3Aport'%2C%20'db'%2C%20'article_clientuser_sum'%2C%20'user'%2C%20'password')%22%2C%22id%22%3A%22935Lt%22%7D\"></card><blockquote><p>网友文章: <a href=\"http://jackpgao.github.io/2018/02/04/ClickHouse-Use-MySQL-Data/\" target=\"_blank\">http://jackpgao.github.io/2018/02/04/ClickHouse-Use-MySQL-Data/</a></p></blockquote><p>不支持自定义列，参考资料里的博主写的 <code>ENGIN=MergeTree</code> 测试失败。</p><p>可以理解成 create table 和 insert into select 的组合</p><p><br /></p><h2 id=\"rbmGL\">Altinity/clickhouse-mysql-data-reader</h2><p>Altinity公司开源的一个python工具，用来从mysql迁移数据到clickhouse(支持binlog增量更新和全量导入)，但是官方readme和代码脱节，根据quick start跑不通。</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23%23%20%E5%88%9B%E5%BB%BA%E8%A1%A8%5Cnclickhouse-mysql%20%5C%5C%5Cn%20%20%20%20--src-host%3D127.0.0.1%20%5C%5C%5Cn%20%20%20%20--src-user%3Dreader%20%5C%5C%5Cn%20%20%20%20--src-password%3DQwerty1%23%20%5C%5C%5Cn%20%20%20%20--table-templates-with-create-database%20%5C%5C%5Cn%20%20%20%20--src-table%3Dairline.ontime%20%3E%20create_clickhouse_table_template.sql%5Cn%23%23%20%E4%BF%AE%E6%94%B9%E8%84%9A%E6%9C%AC%5Cnvim%20create_clickhouse_table_template.sql%5Cn%5Cn%23%23%20%E5%AF%BC%E5%85%A5%E5%BB%BA%E8%A1%A8%5Cnclickhouse-client%20-mn%20%3C%20create_clickhouse_table_template.sql%5Cn%5Cn%23%23%20%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5%5Cnclickhouse-mysql%20%5C%5C%5Cn%20%20%20%20%20--src-host%3D127.0.0.1%20%5C%5C%5Cn%20%20%20%20%20--src-user%3Dreader%20%5C%5C%5Cn%20%20%20%20%20--src-password%3DQwerty1%23%20%5C%5C%5Cn%20%20%20%20%20--table-migrate%20%5C%5C%5Cn%20%20%20%20%20--dst-host%3D127.0.0.1%20%5C%5C%5Cn%20%20%20%20%20--dst-table%3Dlogunified%20%5C%5C%5Cn%20%20%20%20%20--csvpool%22%2C%22id%22%3A%22XtXVC%22%7D\"></card><blockquote><p>官方文档: <a href=\"https://github.com/Altinity/clickhouse-mysql-data-reader#mysql-migration-case-1---migrate-existing-data\" target=\"_blank\">https://github.com/Altinity/clickhouse-mysql-data-reader#mysql-migration-case-1---migrate-existing-data</a></p></blockquote><p><br /></p><p>注意，上述三种都是从mysql导入clickhouse，如果数据量大，对于mysql压力还是挺大的。下面介绍两种离线方式(streamsets支持实时，也支持离线)</p><p><span style=\"background-color: transparent;\">csv</span></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23%23%20%E5%BF%BD%E7%95%A5%E5%BB%BA%E8%A1%A8%5Cnclickhouse-client%20%5C%5C%5Cn%20%20-h%20host%20%5C%5C%5Cn%20%20--query%3D%5C%22INSERT%20INTO%20%5Bdb%5D.table%20FORMAT%20CSV%5C%22%20%3C%20test.csv%22%2C%22id%22%3A%220hBq9%22%7D\"></card><p><br /></p><p>但是如果源数据质量不高，往往会有问题，比如包含特殊字符(分隔符，转义符)，或者换行。被坑的很惨。</p><p><br /></p><ul><li>自定义分隔符, <code>--format_csv_delimiter=&quot;|&quot;</code> </li><li>遇到错误跳过而不中止， <code>--input_format_allow_errors_num=10</code> 最多允许10行错误, <code>--input_format_allow_errors_ratio=0.1</code> 允许10%的错误</li><li>csv 跳过空值(null) ，报 <code>Code: 27. DB::Exception: Cannot parse input: expected , before: xxxx: (at row 69) ERROR: garbage after Nullable(Date): &quot;8,002&lt;LINE FEED&gt;0205&quot;</code>  <code>sed ' :a;s/,,/,\\\\N,/g;ta' |clickhouse-client -h host --query &quot;INSERT INTO [db].table FORMAT CSV&quot;</code> 将 <code>,,</code> 替换成 <code>,\\N,</code> </li></ul><p><br /></p><p><code>python clean_csv.py --src=src.csv --dest=dest.csv --chunksize=50000 --cols --encoding=utf-8 --delimiter=,</code> </p><p><br /></p><p>clean_csv.py参考我另外一篇 <a href=\"https://anjia0532.github.io/2019/07/16/clean-csv/\" target=\"_blank\">032-csv文件容错处理</a> </p><p><br /></p><h2 id=\"JB7MZ\"><span style=\"background-color: transparent;\">streamsets</span></h2><p><span style=\"background-color: transparent;\">streamsets支持从mysql或者读csv全量导入，也支持订阅binlog增量插入，参考我另外一篇 </span><a href=\"https://anjia0532.github.io/2019/06/10/cdh-streamsets/\" target=\"_blank\">025-大数据ETL工具之StreamSets安装及订阅mysql binlog</a><span style=\"background-color: transparent;\">。</span></p><p>本文只展示从mysql全量导入clickhouse</p><p>本文假设你已经搭建起streamsets服务</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563437517163-af02c2db-f03b-4884-8f16-4850918ddc0d.png%22%2C%22originWidth%22%3A1911%2C%22originHeight%22%3A850%2C%22name%22%3A%22image.png%22%2C%22size%22%3A97265%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1911%2C%22height%22%3A850%7D\"></card></p><p>启用并重启服务</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563437777046-970dff85-960f-48f3-a3e9-0a10002f34b4.png%22%2C%22originWidth%22%3A1843%2C%22originHeight%22%3A860%2C%22name%22%3A%22image.png%22%2C%22size%22%3A89828%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1843%2C%22height%22%3A860%7D\"></card></p><p>上传mysql和clickhouse的jdbc jar和依赖包</p><p>便捷方式，创建pom.xml，使用maven统一下载</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22xml%22%2C%22code%22%3A%22%3Cproject%20xmlns%3D%5C%22http%3A%2F%2Fmaven.apache.org%2FPOM%2F4.0.0%5C%22%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%5Cn%20%20xsi%3AschemaLocation%3D%5C%22http%3A%2F%2Fmaven.apache.org%2FPOM%2F4.0.0%20http%3A%2F%2Fmaven.apache.org%2Fmaven-v4_0_0.xsd%5C%22%3E%5Cn%20%20%3CmodelVersion%3E4.0.0%3C%2FmodelVersion%3E%5Cn%20%20%3CgroupId%3Ecom.anjia%3C%2FgroupId%3E%5Cn%20%20%3CartifactId%3Edemo%3C%2FartifactId%3E%5Cn%20%20%3Cpackaging%3Ejar%3C%2Fpackaging%3E%5Cn%20%20%3Cversion%3E1.0-SNAPSHOT%3C%2Fversion%3E%5Cn%20%20%3Cname%3Edemo%3C%2Fname%3E%5Cn%20%20%3Curl%3Ehttp%3A%2F%2Fmaven.apache.org%3C%2Furl%3E%5Cn%20%20%3Cdependencies%3E%5Cn%20%20%20%20%3Cdependency%3E%5Cn%20%20%20%20%20%20%20%20%3CgroupId%3Eru.yandex.clickhouse%3C%2FgroupId%3E%5Cn%20%20%20%20%20%20%20%20%3CartifactId%3Eclickhouse-jdbc%3C%2FartifactId%3E%5Cn%20%20%20%20%20%20%20%20%3Cversion%3E0.1.54%3C%2Fversion%3E%5Cn%20%20%20%20%3C%2Fdependency%3E%5Cn%20%20%20%20%3Cdependency%3E%5Cn%20%20%20%20%20%20%3CgroupId%3Emysql%3C%2FgroupId%3E%5Cn%20%20%20%20%20%20%3CartifactId%3Emysql-connector-java%3C%2FartifactId%3E%5Cn%20%20%20%20%20%20%3Cversion%3E5.1.47%3C%2Fversion%3E%5Cn%20%20%3C%2Fdependency%3E%5Cn%20%20%3C%2Fdependencies%3E%5Cn%3C%2Fproject%3E%22%2C%22id%22%3A%22YPs1Y%22%7D\"></card><p>如果本地装有maven，执行如下命令</p><p><code>mvn dependency:copy-dependencies -DoutputDirectory=lib -DincludeScope=compile</code> </p><p>所有需要的jar会下载并复制到lib目录下</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563438052063-1f073ee5-1c50-4842-8f9e-5f9974867895.png%22%2C%22originWidth%22%3A391%2C%22originHeight%22%3A298%2C%22name%22%3A%22image.png%22%2C%22size%22%3A34034%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A391%2C%22height%22%3A298%7D\"></card></p><p>然后拷贝到 streamsets <code>/opt/streamsets-datacollector-3.9.1/streamsets-libs-extras/streamsets-datacollector-jdbc-lib/lib/</code> 目录下</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563442430751-7889c386-014a-417e-bc0c-069414f08b89.png%22%2C%22originWidth%22%3A751%2C%22originHeight%22%3A740%2C%22name%22%3A%22image.png%22%2C%22size%22%3A59852%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A751%2C%22height%22%3A740%7D\"></card></p><p>重启streamsets服务</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563443529858-b23e198f-a097-4359-ad0b-85768a5c68ec.png%22%2C%22originWidth%22%3A194%2C%22originHeight%22%3A320%2C%22name%22%3A%22image.png%22%2C%22size%22%3A13854%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A194%2C%22height%22%3A320%7D\"></card><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563443568159-590b99dc-af61-45d2-8724-b33d08ba7df2.png%22%2C%22originWidth%22%3A189%2C%22originHeight%22%3A235%2C%22name%22%3A%22image.png%22%2C%22size%22%3A9943%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A189%2C%22height%22%3A235%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563444143877-060e4c52-53af-42f3-99e2-38cfc2add983.png%22%2C%22originWidth%22%3A1253%2C%22originHeight%22%3A726%2C%22name%22%3A%22image.png%22%2C%22size%22%3A83069%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1253%2C%22height%22%3A726%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563444315768-4295a91d-b610-4df8-8796-196358662c68.png%22%2C%22originWidth%22%3A1378%2C%22originHeight%22%3A776%2C%22name%22%3A%22image.png%22%2C%22size%22%3A80345%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1378%2C%22height%22%3A776%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563444358478-d8bd7c56-c0c0-49a6-903e-1d284d812e5d.png%22%2C%22originWidth%22%3A1344%2C%22originHeight%22%3A773%2C%22name%22%3A%22image.png%22%2C%22size%22%3A81650%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1344%2C%22height%22%3A773%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1563444395375-690becdc-1f48-4cfb-b6bd-13d03554cbc1.png%22%2C%22originWidth%22%3A1629%2C%22originHeight%22%3A785%2C%22name%22%3A%22image.png%22%2C%22size%22%3A69971%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1629%2C%22height%22%3A785%7D\"></card></p><h2 id=\"ri8A5\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/07/17/mysql-to-clickhouse\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d30454ce51d4510bf1d6737\" target=\"_blank\">我的掘金<cursor /></a></li><li><a href=\"https://crate.io/docs/crate/guide/en/latest/tools/streamsets.html\" target=\"_blank\"><span style=\"color: #000000;\">Building data stream pipelines with CrateDB and StreamSets data collector</span></a></li><li><a href=\"https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/JDBCConsumer.html\" target=\"_blank\">JDBC Query Consumer</a></li><li><a href=\"https://dzone.com/articles/data-flow-pipeline-using-streamsets\" target=\"_blank\">Data Flow Pipeline Using StreamSets</a></li></ul>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-07-18T10:11:21.000Z",
    "deleted_at": null,
    "created_at": "2019-07-10T10:08:47.000Z",
    "updated_at": "2019-07-18T10:31:44.000Z",
    "published_at": "2019-07-18T10:31:44.000Z",
    "first_published_at": "2019-07-18T10:11:21.000Z",
    "word_count": 1156,
    "cover": "",
    "description": "date: 2019-07-17 22:15:38tags: [数据分析,数据处理,mysql,数据库,clickhouse]categories: 大数据---这是坚持技术写作计划（含翻译）的第33篇，定个小目标999，每周最少2篇。数据迁移需要从mysql导入clickhouse, 总结方...",
    "custom_description": "数据迁移需要从mysql导入clickhouse, 总结方案如下，包括clickhouse自身支持的三种方式，第三方工具两种。",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 2061583,
    "slug": "redash",
    "title": "031-数据可视化之redash(支持43种数据源)",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-07-08 12:30:00<br />tags: [CDH,hadoop,大数据,数据可视化,Superset,redash]<br />categories: 大数据<br />---\n> 这是坚持技术写作计划（含翻译）的第31篇，定个小目标999，每周最少2篇。\n\n\n本文是数据可视化系列第二篇,本系列会讲解 [PowerBI/Excel](https://juejin.im/post/5cdfdfa4f265da1bbf68ec4b),[Metabase](https://www.metabase.com/),[Redash](https://anjia0532.github.io/2019/07/08/redash),[Superset](http://superset.apache.org/),[CBoard](https://juejin.im/post/5b4ee1c2f265da0f5d4cc978)\n\n人类都是视觉动物，讲究一图胜千言。如果没了可视化，那么你在跟领导汇报工作时，很大程度会鸡同鸭讲。<br />其实excel2016+已经是一个不错的数据分析及可视化工具了(支持几十种数据源),但是，不方便权限控制，集中，及报警。\n\n我一般将redash作为可视化工具、数据库查询编辑器(类似navicat-premium)、数据挖掘探索工具来用。<br />截止目前，自建redash支持43种数据源<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562561680709-399441ab-b14d-4d93-b797-60925f2eafd6.png#align=left&display=inline&height=944&name=image.png&originHeight=944&originWidth=1133&size=147027&status=done&width=1133)\n\n<!-- more -->\n\n<a name=\"nxb7z\"></a>\n## 安装redash\n\n```bash\n## 安装必要工具\napt install -y pwgen python-pip\npip install pip -U\npip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple\npip install docker-compose\n\n## 生成脚本\ncat << EOF | sudo tee -a ./setup.sh\n#!/usr/bin/env bash\n# This script setups dockerized Redash on Ubuntu 18.04.\nset -eu\n\nREDASH_BASE_PATH=/opt/redash\n\ncreate_directories() {\n    if [[ ! -e $REDASH_BASE_PATH ]]; then\n        sudo mkdir -p $REDASH_BASE_PATH\n        sudo chown $USER:$USER $REDASH_BASE_PATH\n    fi\n\n    if [[ ! -e $REDASH_BASE_PATH/postgres-data ]]; then\n        mkdir $REDASH_BASE_PATH/postgres-data\n    fi\n}\n\ncreate_config() {\n    if [[ -e $REDASH_BASE_PATH/env ]]; then\n        rm $REDASH_BASE_PATH/env\n        touch $REDASH_BASE_PATH/env\n    fi\n\n    COOKIE_SECRET=$(pwgen -1s 32)\n    SECRET_KEY=$(pwgen -1s 32)\n    POSTGRES_PASSWORD=$(pwgen -1s 32)\n    REDASH_DATABASE_URL=\"postgresql://postgres:${POSTGRES_PASSWORD}@postgres/postgres\"\n\n    echo \"PYTHONUNBUFFERED=0\" >> $REDASH_BASE_PATH/env\n    echo \"REDASH_LOG_LEVEL=INFO\" >> $REDASH_BASE_PATH/env\n    echo \"REDASH_REDIS_URL=redis://redis:6379/0\" >> $REDASH_BASE_PATH/env\n    echo \"POSTGRES_PASSWORD=$POSTGRES_PASSWORD\" >> $REDASH_BASE_PATH/env\n    echo \"REDASH_COOKIE_SECRET=$COOKIE_SECRET\" >> $REDASH_BASE_PATH/env\n    echo \"REDASH_SECRET_KEY=$SECRET_KEY\" >> $REDASH_BASE_PATH/env\n    echo \"REDASH_DATABASE_URL=$REDASH_DATABASE_URL\" >> $REDASH_BASE_PATH/env\n}\n\ncreate_directories\ncreate_config\nEOF\n\n## 生成必要配置文件\nchmod +x ./setup && ./setup\n```\n\ndocker-compose.yml\n```yaml\nversion: '2'\nx-redash-service: &redash-service\n  image: redash/redash:7.0.0.b18042\n  depends_on:\n    - postgres\n    - redis\n  env_file: /opt/redash/env\n  restart: always\nservices:\n  server:\n    <<: *redash-service\n    command: server\n    ports:\n      - \"5000:5000\"\n    environment:\n      REDASH_WEB_WORKERS: 4\n  scheduler:\n    <<: *redash-service\n    command: scheduler\n    environment:\n      QUEUES: \"celery\"\n      WORKERS_COUNT: 1\n  scheduled_worker:\n    <<: *redash-service\n    command: worker\n    environment:\n      QUEUES: \"scheduled_queries,schemas\"\n      WORKERS_COUNT: 1\n  adhoc_worker:\n    <<: *redash-service\n    command: worker\n    environment:\n      QUEUES: \"queries\"\n      WORKERS_COUNT: 2\n  redis:\n    image: redis:5.0-alpine\n    restart: always\n  postgres:\n    image: postgres:9.5-alpine\n    env_file: /opt/redash/env\n    volumes:\n      - /opt/redash/postgres-data:/var/lib/postgresql/data\n    restart: always\n  nginx:\n    image: redash/nginx:latest\n    ports:\n      - \"80:80\"\n    depends_on:\n      - server\n    links:\n      - server:redash\n    restart: always\n```\n\n```bash\n## 配置数据库\nsudo docker-compose run --rm server create_db\n## 启动\nsudo docker-compose up -d\n```\n\n<a name=\"MAfiF\"></a>\n## 配置redash\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562631840989-c6c2d739-b9df-4b95-a3fa-61cdc7b35dde.png#align=left&display=inline&height=626&name=image.png&originHeight=626&originWidth=508&size=35369&status=done&width=508)\n\n创建数据源<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562631903553-80df8657-983c-4d8e-b7a1-d1c6e126fb62.png#align=left&display=inline&height=620&name=image.png&originHeight=620&originWidth=1328&size=93814&status=done&width=1328)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562634341179-6242da8f-b79e-424c-bd1c-4ef8d959b6f2.png#align=left&display=inline&height=616&name=image.png&originHeight=616&originWidth=965&size=35160&status=done&width=965)\n\n> 注意：\n> 为做演示，clickhouse已导入官网提供的2018年航天数据，详见 [https://clickhouse.yandex/docs/zh/getting_started/example_datasets/ontime/](https://clickhouse.yandex/docs/zh/getting_started/example_datasets/ontime/)\n\n\n<a name=\"xjUpG\"></a>\n## 演示redash\n创建查询 **查询2007年各航空公司延误超过10分钟以上的百分比** <br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562736509902-041060bf-8e40-4025-82a0-cb9b6d2accaf.png#align=left&display=inline&height=480&name=image.png&originHeight=480&originWidth=1340&size=55546&status=done&width=1340)\n\n`SELECT Carrier, avg(DepDelay > 10) * 100 AS c3 FROM ontime WHERE Year = 2018 GROUP BY Carrier ORDER BY Carrier` <br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562736271917-dadece08-87f4-4103-a298-170d115fe073.png#align=left&display=inline&height=503&name=image.png&originHeight=503&originWidth=1052&size=28083&status=done&width=1052)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562736536023-b44eaf65-9397-4c7a-9574-43ecfede72ef.png#align=left&display=inline&height=254&name=image.png&originHeight=254&originWidth=297&size=6701&status=done&width=297)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562736589364-dcb99f35-22ca-47d8-97a5-a98491f45bfe.png#align=left&display=inline&height=609&name=image.png&originHeight=609&originWidth=1347&size=108611&status=done&width=1347)\n\n发布<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562736715789-e21eea66-eb35-40a5-8061-100b79f2dac7.png#align=left&display=inline&height=312&name=image.png&originHeight=312&originWidth=1056&size=30412&status=done&width=1056)\n\n\n创建仪表盘(Dashboard)\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562736796292-ac3b67dd-1d2f-41a2-a1db-a7e9456ba2cd.png#align=left&display=inline&height=557&name=image.png&originHeight=557&originWidth=1342&size=39921&status=done&width=1342)\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562736761829-08ae709d-eeda-46d7-a3b3-5d17e3eb38fe.png#align=left&display=inline&height=457&name=image.png&originHeight=457&originWidth=1021&size=43007&status=done&width=1021)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562736856319-c2134885-f7fe-4468-9609-d1a1e155f220.png#align=left&display=inline&height=477&name=image.png&originHeight=477&originWidth=1359&size=90419&status=done&width=1359)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562736915850-1639d58c-faf7-40f9-827b-5ad787fb52fb.png#align=left&display=inline&height=515&name=image.png&originHeight=515&originWidth=1354&size=109611&status=done&width=1354)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562736878154-9f97437c-6b4f-419e-89bc-17f45f49947e.png#align=left&display=inline&height=273&name=image.png&originHeight=273&originWidth=551&size=17982&status=done&width=551)<br />分享后的dashboard，在底下有个redash的logo<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562736970500-ed1b5503-69c7-40e3-99d8-b5a7cdd58d82.png#align=left&display=inline&height=295&name=image.png&originHeight=295&originWidth=500&size=9731&status=done&width=500)\n\n可以嵌入到已有系统里。\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [我的博客](https://anjia0532.github.io/2019/07/08/redash/)\n- [我的掘金](https://juejin.im/post/5d25b88cf265da1bc23f9ff3)\n- [Knowledge Base](https://redash.io/help/)\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。<br />长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-07-08 12:30:00</p><p>tags: [CDH,hadoop,大数据,数据可视化,Superset,redash]</p><p>categories: 大数据</p><p>---</p><blockquote style=\"padding-left: 1em;\"><p>这是坚持技术写作计划（含翻译）的第31篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文是数据可视化系列第二篇,本系列会讲解 <a href=\"https://juejin.im/post/5cdfdfa4f265da1bbf68ec4b\" target=\"_blank\">PowerBI/Excel</a>,<a href=\"https://www.metabase.com/\" target=\"_blank\">Metabase</a>,<a href=\"https://anjia0532.github.io/2019/07/08/redash\" target=\"_blank\">Redash</a>,<a href=\"http://superset.apache.org/\" target=\"_blank\">Superset</a>,<a href=\"https://juejin.im/post/5b4ee1c2f265da0f5d4cc978\" target=\"_blank\">CBoard</a></p><p><br /></p><p>人类都是视觉动物，讲究一图胜千言。如果没了可视化，那么你在跟领导汇报工作时，很大程度会鸡同鸭讲。</p><p>其实excel2016+已经是一个不错的数据分析及可视化工具了(支持几十种数据源),但是，不方便权限控制，集中，及报警。</p><p><br /></p><p>我一般将redash作为可视化工具、数据库查询编辑器(类似navicat-premium)、数据挖掘探索工具来用。</p><p>截止目前，自建redash支持43种数据源</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562561680709-399441ab-b14d-4d93-b797-60925f2eafd6.png#align=left&amp;display=inline&amp;height=944&amp;name=image.png&amp;originHeight=944&amp;originWidth=1133&amp;size=147027&amp;status=done&amp;width=1133\" style=\"max-width: 600px; width: 1133px;\" /></p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"nxb7z\">安装redash</h2><p><br /></p><pre data-lang=\"bash\"><code>## 安装必要工具\napt install -y pwgen python-pip\npip install pip -U\npip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple\npip install docker-compose\n\n## 生成脚本\ncat &lt;&lt; EOF | sudo tee -a ./setup.sh\n#!/usr/bin/env bash\n# This script setups dockerized Redash on Ubuntu 18.04.\nset -eu\n\nREDASH_BASE_PATH=/opt/redash\n\ncreate_directories() {\n    if [[ ! -e $REDASH_BASE_PATH ]]; then\n        sudo mkdir -p $REDASH_BASE_PATH\n        sudo chown $USER:$USER $REDASH_BASE_PATH\n    fi\n\n    if [[ ! -e $REDASH_BASE_PATH/postgres-data ]]; then\n        mkdir $REDASH_BASE_PATH/postgres-data\n    fi\n}\n\ncreate_config() {\n    if [[ -e $REDASH_BASE_PATH/env ]]; then\n        rm $REDASH_BASE_PATH/env\n        touch $REDASH_BASE_PATH/env\n    fi\n\n    COOKIE_SECRET=$(pwgen -1s 32)\n    SECRET_KEY=$(pwgen -1s 32)\n    POSTGRES_PASSWORD=$(pwgen -1s 32)\n    REDASH_DATABASE_URL=&quot;postgresql://postgres:${POSTGRES_PASSWORD}@postgres/postgres&quot;\n\n    echo &quot;PYTHONUNBUFFERED=0&quot; &gt;&gt; $REDASH_BASE_PATH/env\n    echo &quot;REDASH_LOG_LEVEL=INFO&quot; &gt;&gt; $REDASH_BASE_PATH/env\n    echo &quot;REDASH_REDIS_URL=redis://redis:6379/0&quot; &gt;&gt; $REDASH_BASE_PATH/env\n    echo &quot;POSTGRES_PASSWORD=$POSTGRES_PASSWORD&quot; &gt;&gt; $REDASH_BASE_PATH/env\n    echo &quot;REDASH_COOKIE_SECRET=$COOKIE_SECRET&quot; &gt;&gt; $REDASH_BASE_PATH/env\n    echo &quot;REDASH_SECRET_KEY=$SECRET_KEY&quot; &gt;&gt; $REDASH_BASE_PATH/env\n    echo &quot;REDASH_DATABASE_URL=$REDASH_DATABASE_URL&quot; &gt;&gt; $REDASH_BASE_PATH/env\n}\n\ncreate_directories\ncreate_config\nEOF\n\n## 生成必要配置文件\nchmod +x ./setup &amp;&amp; ./setup</code></pre><p><br /></p><p>docker-compose.yml</p><pre data-lang=\"yaml\"><code>version: '2'\nx-redash-service: &amp;redash-service\n  image: redash/redash:7.0.0.b18042\n  depends_on:\n    - postgres\n    - redis\n  env_file: /opt/redash/env\n  restart: always\nservices:\n  server:\n    &lt;&lt;: *redash-service\n    command: server\n    ports:\n      - &quot;5000:5000&quot;\n    environment:\n      REDASH_WEB_WORKERS: 4\n  scheduler:\n    &lt;&lt;: *redash-service\n    command: scheduler\n    environment:\n      QUEUES: &quot;celery&quot;\n      WORKERS_COUNT: 1\n  scheduled_worker:\n    &lt;&lt;: *redash-service\n    command: worker\n    environment:\n      QUEUES: &quot;scheduled_queries,schemas&quot;\n      WORKERS_COUNT: 1\n  adhoc_worker:\n    &lt;&lt;: *redash-service\n    command: worker\n    environment:\n      QUEUES: &quot;queries&quot;\n      WORKERS_COUNT: 2\n  redis:\n    image: redis:5.0-alpine\n    restart: always\n  postgres:\n    image: postgres:9.5-alpine\n    env_file: /opt/redash/env\n    volumes:\n      - /opt/redash/postgres-data:/var/lib/postgresql/data\n    restart: always\n  nginx:\n    image: redash/nginx:latest\n    ports:\n      - &quot;80:80&quot;\n    depends_on:\n      - server\n    links:\n      - server:redash\n    restart: always</code></pre><p><br /></p><pre data-lang=\"bash\"><code>## 配置数据库\nsudo docker-compose run --rm server create_db\n## 启动\nsudo docker-compose up -d</code></pre><p><br /></p><h2 id=\"MAfiF\">配置redash</h2><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562631840989-c6c2d739-b9df-4b95-a3fa-61cdc7b35dde.png#align=left&amp;display=inline&amp;height=626&amp;name=image.png&amp;originHeight=626&amp;originWidth=508&amp;size=35369&amp;status=done&amp;width=508\" style=\"max-width: 600px; width: 508px;\" /></p><p><br /></p><p>创建数据源</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562631903553-80df8657-983c-4d8e-b7a1-d1c6e126fb62.png#align=left&amp;display=inline&amp;height=620&amp;name=image.png&amp;originHeight=620&amp;originWidth=1328&amp;size=93814&amp;status=done&amp;width=1328\" style=\"max-width: 600px; width: 1328px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562634341179-6242da8f-b79e-424c-bd1c-4ef8d959b6f2.png#align=left&amp;display=inline&amp;height=616&amp;name=image.png&amp;originHeight=616&amp;originWidth=965&amp;size=35160&amp;status=done&amp;width=965\" style=\"max-width: 600px; width: 965px;\" /></p><p><br /></p><blockquote><p>注意：</p><p>为做演示，clickhouse已导入官网提供的2018年航天数据，详见 <a href=\"https://clickhouse.yandex/docs/zh/getting_started/example_datasets/ontime/\" target=\"_blank\">https://clickhouse.yandex/docs/zh/getting_started/example_datasets/ontime/</a></p></blockquote><p><br /></p><h2 id=\"xjUpG\">演示redash</h2><p>创建查询 <strong>查询2007年各航空公司延误超过10分钟以上的百分比</strong> </p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562736509902-041060bf-8e40-4025-82a0-cb9b6d2accaf.png#align=left&amp;display=inline&amp;height=480&amp;name=image.png&amp;originHeight=480&amp;originWidth=1340&amp;size=55546&amp;status=done&amp;width=1340\" style=\"max-width: 600px; width: 1340px;\" /></p><p><br /></p><p><code>SELECT Carrier, avg(DepDelay &gt; 10) * 100 AS c3 FROM ontime WHERE Year = 2018 GROUP BY Carrier ORDER BY Carrier</code> </p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562736271917-dadece08-87f4-4103-a298-170d115fe073.png#align=left&amp;display=inline&amp;height=503&amp;name=image.png&amp;originHeight=503&amp;originWidth=1052&amp;size=28083&amp;status=done&amp;width=1052\" style=\"max-width: 600px; width: 1052px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562736536023-b44eaf65-9397-4c7a-9574-43ecfede72ef.png#align=left&amp;display=inline&amp;height=254&amp;name=image.png&amp;originHeight=254&amp;originWidth=297&amp;size=6701&amp;status=done&amp;width=297\" style=\"max-width: 600px; width: 297px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562736589364-dcb99f35-22ca-47d8-97a5-a98491f45bfe.png#align=left&amp;display=inline&amp;height=609&amp;name=image.png&amp;originHeight=609&amp;originWidth=1347&amp;size=108611&amp;status=done&amp;width=1347\" style=\"max-width: 600px; width: 1347px;\" /></p><p><br /></p><p>发布</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562736715789-e21eea66-eb35-40a5-8061-100b79f2dac7.png#align=left&amp;display=inline&amp;height=312&amp;name=image.png&amp;originHeight=312&amp;originWidth=1056&amp;size=30412&amp;status=done&amp;width=1056\" style=\"max-width: 600px; width: 1056px;\" /></p><p><br /></p><p><br /></p><p>创建仪表盘(Dashboard)</p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562736796292-ac3b67dd-1d2f-41a2-a1db-a7e9456ba2cd.png#align=left&amp;display=inline&amp;height=557&amp;name=image.png&amp;originHeight=557&amp;originWidth=1342&amp;size=39921&amp;status=done&amp;width=1342\" style=\"max-width: 600px; width: 1342px;\" /></p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562736761829-08ae709d-eeda-46d7-a3b3-5d17e3eb38fe.png#align=left&amp;display=inline&amp;height=457&amp;name=image.png&amp;originHeight=457&amp;originWidth=1021&amp;size=43007&amp;status=done&amp;width=1021\" style=\"max-width: 600px; width: 1021px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562736856319-c2134885-f7fe-4468-9609-d1a1e155f220.png#align=left&amp;display=inline&amp;height=477&amp;name=image.png&amp;originHeight=477&amp;originWidth=1359&amp;size=90419&amp;status=done&amp;width=1359\" style=\"max-width: 600px; width: 1359px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562736915850-1639d58c-faf7-40f9-827b-5ad787fb52fb.png#align=left&amp;display=inline&amp;height=515&amp;name=image.png&amp;originHeight=515&amp;originWidth=1354&amp;size=109611&amp;status=done&amp;width=1354\" style=\"max-width: 600px; width: 1354px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562736878154-9f97437c-6b4f-419e-89bc-17f45f49947e.png#align=left&amp;display=inline&amp;height=273&amp;name=image.png&amp;originHeight=273&amp;originWidth=551&amp;size=17982&amp;status=done&amp;width=551\" style=\"max-width: 600px; width: 551px;\" /></p><p>分享后的dashboard，在底下有个redash的logo</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562736970500-ed1b5503-69c7-40e3-99d8-b5a7cdd58d82.png#align=left&amp;display=inline&amp;height=295&amp;name=image.png&amp;originHeight=295&amp;originWidth=500&amp;size=9731&amp;status=done&amp;width=500\" style=\"max-width: 600px; width: 500px;\" /></p><p><br /></p><p>可以嵌入到已有系统里。</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/07/08/redash/\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d25b88cf265da1bc23f9ff3\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://redash.io/help/\" target=\"_blank\">Knowledge Base</a></li></ul><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p>",
    "body_lake": "<!doctype lake><p>date: 2019-07-08 12:30:00</p><p>tags: [CDH,hadoop,大数据,数据可视化,Superset,redash]</p><p>categories: 大数据</p><p>---</p><blockquote style=\"padding-left: 1em;\"><p>这是坚持技术写作计划（含翻译）的第31篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文是数据可视化系列第二篇,本系列会讲解 <a href=\"https://juejin.im/post/5cdfdfa4f265da1bbf68ec4b\" target=\"_blank\">PowerBI/Excel</a>,<a href=\"https://www.metabase.com/\" target=\"_blank\">Metabase</a>,<a href=\"https://anjia0532.github.io/2019/07/08/redash\" target=\"_blank\">Redash</a>,<a href=\"http://superset.apache.org/\" target=\"_blank\">Superset</a>,<a href=\"https://juejin.im/post/5b4ee1c2f265da0f5d4cc978\" target=\"_blank\">CBoard</a></p><p><br /></p><p>人类都是视觉动物，讲究一图胜千言。如果没了可视化，那么你在跟领导汇报工作时，很大程度会鸡同鸭讲。</p><p>其实excel2016+已经是一个不错的数据分析及可视化工具了(支持几十种数据源),但是，不方便权限控制，集中，及报警。</p><p><br /></p><p>我一般将redash作为可视化工具、数据库查询编辑器(类似navicat-premium)、数据挖掘探索工具来用。</p><p>截止目前，自建redash支持43种数据源</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562561680709-399441ab-b14d-4d93-b797-60925f2eafd6.png%22%2C%22originWidth%22%3A1133%2C%22originHeight%22%3A944%2C%22name%22%3A%22image.png%22%2C%22size%22%3A147027%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1133%2C%22height%22%3A944%7D\"></card></p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"nxb7z\">安装redash</h2><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23%23%20%E5%AE%89%E8%A3%85%E5%BF%85%E8%A6%81%E5%B7%A5%E5%85%B7%5Cnapt%20install%20-y%20pwgen%20python-pip%5Cnpip%20install%20pip%20-U%5Cnpip%20config%20set%20global.index-url%20https%3A%2F%2Fpypi.tuna.tsinghua.edu.cn%2Fsimple%5Cnpip%20install%20docker-compose%5Cn%5Cn%23%23%20%E7%94%9F%E6%88%90%E8%84%9A%E6%9C%AC%5Cncat%20%3C%3C%20EOF%20%7C%20sudo%20tee%20-a%20.%2Fsetup.sh%5Cn%23!%2Fusr%2Fbin%2Fenv%20bash%5Cn%23%20This%20script%20setups%20dockerized%20Redash%20on%20Ubuntu%2018.04.%5Cnset%20-eu%5Cn%5CnREDASH_BASE_PATH%3D%2Fopt%2Fredash%5Cn%5Cncreate_directories()%20%7B%5Cn%20%20%20%20if%20%5B%5B%20!%20-e%20%24REDASH_BASE_PATH%20%5D%5D%3B%20then%5Cn%20%20%20%20%20%20%20%20sudo%20mkdir%20-p%20%24REDASH_BASE_PATH%5Cn%20%20%20%20%20%20%20%20sudo%20chown%20%24USER%3A%24USER%20%24REDASH_BASE_PATH%5Cn%20%20%20%20fi%5Cn%5Cn%20%20%20%20if%20%5B%5B%20!%20-e%20%24REDASH_BASE_PATH%2Fpostgres-data%20%5D%5D%3B%20then%5Cn%20%20%20%20%20%20%20%20mkdir%20%24REDASH_BASE_PATH%2Fpostgres-data%5Cn%20%20%20%20fi%5Cn%7D%5Cn%5Cncreate_config()%20%7B%5Cn%20%20%20%20if%20%5B%5B%20-e%20%24REDASH_BASE_PATH%2Fenv%20%5D%5D%3B%20then%5Cn%20%20%20%20%20%20%20%20rm%20%24REDASH_BASE_PATH%2Fenv%5Cn%20%20%20%20%20%20%20%20touch%20%24REDASH_BASE_PATH%2Fenv%5Cn%20%20%20%20fi%5Cn%5Cn%20%20%20%20COOKIE_SECRET%3D%24(pwgen%20-1s%2032)%5Cn%20%20%20%20SECRET_KEY%3D%24(pwgen%20-1s%2032)%5Cn%20%20%20%20POSTGRES_PASSWORD%3D%24(pwgen%20-1s%2032)%5Cn%20%20%20%20REDASH_DATABASE_URL%3D%5C%22postgresql%3A%2F%2Fpostgres%3A%24%7BPOSTGRES_PASSWORD%7D%40postgres%2Fpostgres%5C%22%5Cn%5Cn%20%20%20%20echo%20%5C%22PYTHONUNBUFFERED%3D0%5C%22%20%3E%3E%20%24REDASH_BASE_PATH%2Fenv%5Cn%20%20%20%20echo%20%5C%22REDASH_LOG_LEVEL%3DINFO%5C%22%20%3E%3E%20%24REDASH_BASE_PATH%2Fenv%5Cn%20%20%20%20echo%20%5C%22REDASH_REDIS_URL%3Dredis%3A%2F%2Fredis%3A6379%2F0%5C%22%20%3E%3E%20%24REDASH_BASE_PATH%2Fenv%5Cn%20%20%20%20echo%20%5C%22POSTGRES_PASSWORD%3D%24POSTGRES_PASSWORD%5C%22%20%3E%3E%20%24REDASH_BASE_PATH%2Fenv%5Cn%20%20%20%20echo%20%5C%22REDASH_COOKIE_SECRET%3D%24COOKIE_SECRET%5C%22%20%3E%3E%20%24REDASH_BASE_PATH%2Fenv%5Cn%20%20%20%20echo%20%5C%22REDASH_SECRET_KEY%3D%24SECRET_KEY%5C%22%20%3E%3E%20%24REDASH_BASE_PATH%2Fenv%5Cn%20%20%20%20echo%20%5C%22REDASH_DATABASE_URL%3D%24REDASH_DATABASE_URL%5C%22%20%3E%3E%20%24REDASH_BASE_PATH%2Fenv%5Cn%7D%5Cn%5Cncreate_directories%5Cncreate_config%5CnEOF%5Cn%5Cn%23%23%20%E7%94%9F%E6%88%90%E5%BF%85%E8%A6%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%5Cnchmod%20%2Bx%20.%2Fsetup%20%26%26%20.%2Fsetup%22%2C%22id%22%3A%22MrHoC%22%7D\"></card><p><br /></p><p>docker-compose.yml</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22yaml%22%2C%22code%22%3A%22version%3A%20'2'%5Cnx-redash-service%3A%20%26redash-service%5Cn%20%20image%3A%20redash%2Fredash%3A7.0.0.b18042%5Cn%20%20depends_on%3A%5Cn%20%20%20%20-%20postgres%5Cn%20%20%20%20-%20redis%5Cn%20%20env_file%3A%20%2Fopt%2Fredash%2Fenv%5Cn%20%20restart%3A%20always%5Cnservices%3A%5Cn%20%20server%3A%5Cn%20%20%20%20%3C%3C%3A%20*redash-service%5Cn%20%20%20%20command%3A%20server%5Cn%20%20%20%20ports%3A%5Cn%20%20%20%20%20%20-%20%5C%225000%3A5000%5C%22%5Cn%20%20%20%20environment%3A%5Cn%20%20%20%20%20%20REDASH_WEB_WORKERS%3A%204%5Cn%20%20scheduler%3A%5Cn%20%20%20%20%3C%3C%3A%20*redash-service%5Cn%20%20%20%20command%3A%20scheduler%5Cn%20%20%20%20environment%3A%5Cn%20%20%20%20%20%20QUEUES%3A%20%5C%22celery%5C%22%5Cn%20%20%20%20%20%20WORKERS_COUNT%3A%201%5Cn%20%20scheduled_worker%3A%5Cn%20%20%20%20%3C%3C%3A%20*redash-service%5Cn%20%20%20%20command%3A%20worker%5Cn%20%20%20%20environment%3A%5Cn%20%20%20%20%20%20QUEUES%3A%20%5C%22scheduled_queries%2Cschemas%5C%22%5Cn%20%20%20%20%20%20WORKERS_COUNT%3A%201%5Cn%20%20adhoc_worker%3A%5Cn%20%20%20%20%3C%3C%3A%20*redash-service%5Cn%20%20%20%20command%3A%20worker%5Cn%20%20%20%20environment%3A%5Cn%20%20%20%20%20%20QUEUES%3A%20%5C%22queries%5C%22%5Cn%20%20%20%20%20%20WORKERS_COUNT%3A%202%5Cn%20%20redis%3A%5Cn%20%20%20%20image%3A%20redis%3A5.0-alpine%5Cn%20%20%20%20restart%3A%20always%5Cn%20%20postgres%3A%5Cn%20%20%20%20image%3A%20postgres%3A9.5-alpine%5Cn%20%20%20%20env_file%3A%20%2Fopt%2Fredash%2Fenv%5Cn%20%20%20%20volumes%3A%5Cn%20%20%20%20%20%20-%20%2Fopt%2Fredash%2Fpostgres-data%3A%2Fvar%2Flib%2Fpostgresql%2Fdata%5Cn%20%20%20%20restart%3A%20always%5Cn%20%20nginx%3A%5Cn%20%20%20%20image%3A%20redash%2Fnginx%3Alatest%5Cn%20%20%20%20ports%3A%5Cn%20%20%20%20%20%20-%20%5C%2280%3A80%5C%22%5Cn%20%20%20%20depends_on%3A%5Cn%20%20%20%20%20%20-%20server%5Cn%20%20%20%20links%3A%5Cn%20%20%20%20%20%20-%20server%3Aredash%5Cn%20%20%20%20restart%3A%20always%22%2C%22id%22%3A%22ugxiI%22%7D\"></card><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23%23%20%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93%5Cnsudo%20docker-compose%20run%20--rm%20server%20create_db%5Cn%23%23%20%E5%90%AF%E5%8A%A8%5Cnsudo%20docker-compose%20up%20-d%22%2C%22id%22%3A%22GyIt1%22%7D\"></card><p><br /></p><h2 id=\"MAfiF\">配置redash</h2><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562631840989-c6c2d739-b9df-4b95-a3fa-61cdc7b35dde.png%22%2C%22originWidth%22%3A508%2C%22originHeight%22%3A626%2C%22name%22%3A%22image.png%22%2C%22size%22%3A35369%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A508%2C%22height%22%3A626%7D\"></card></p><p><br /></p><p>创建数据源</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562631903553-80df8657-983c-4d8e-b7a1-d1c6e126fb62.png%22%2C%22originWidth%22%3A1328%2C%22originHeight%22%3A620%2C%22name%22%3A%22image.png%22%2C%22size%22%3A93814%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1328%2C%22height%22%3A620%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562634341179-6242da8f-b79e-424c-bd1c-4ef8d959b6f2.png%22%2C%22originWidth%22%3A965%2C%22originHeight%22%3A616%2C%22name%22%3A%22image.png%22%2C%22size%22%3A35160%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A965%2C%22height%22%3A616%7D\"></card></p><p><br /></p><blockquote><p>注意：</p><p>为做演示，clickhouse已导入官网提供的2018年航天数据，详见 <a href=\"https://clickhouse.yandex/docs/zh/getting_started/example_datasets/ontime/\" target=\"_blank\">https://clickhouse.yandex/docs/zh/getting_started/example_datasets/ontime/</a></p></blockquote><p><br /></p><h2 id=\"xjUpG\">演示redash</h2><p>创建查询 <strong>查询2007年各航空公司延误超过10分钟以上的百分比</strong> </p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562736509902-041060bf-8e40-4025-82a0-cb9b6d2accaf.png%22%2C%22originWidth%22%3A1340%2C%22originHeight%22%3A480%2C%22name%22%3A%22image.png%22%2C%22size%22%3A55546%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1340%2C%22height%22%3A480%7D\"></card></p><p><br /></p><p><code>SELECT Carrier, avg(DepDelay &gt; 10) * 100 AS c3 FROM ontime WHERE Year = 2018 GROUP BY Carrier ORDER BY Carrier</code> </p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562736271917-dadece08-87f4-4103-a298-170d115fe073.png%22%2C%22originWidth%22%3A1052%2C%22originHeight%22%3A503%2C%22name%22%3A%22image.png%22%2C%22size%22%3A28083%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1052%2C%22height%22%3A503%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562736536023-b44eaf65-9397-4c7a-9574-43ecfede72ef.png%22%2C%22originWidth%22%3A297%2C%22originHeight%22%3A254%2C%22name%22%3A%22image.png%22%2C%22size%22%3A6701%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A297%2C%22height%22%3A254%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562736589364-dcb99f35-22ca-47d8-97a5-a98491f45bfe.png%22%2C%22originWidth%22%3A1347%2C%22originHeight%22%3A609%2C%22name%22%3A%22image.png%22%2C%22size%22%3A108611%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1347%2C%22height%22%3A609%7D\"></card></p><p><br /></p><p>发布</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562736715789-e21eea66-eb35-40a5-8061-100b79f2dac7.png%22%2C%22originWidth%22%3A1056%2C%22originHeight%22%3A312%2C%22name%22%3A%22image.png%22%2C%22size%22%3A30412%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1056%2C%22height%22%3A312%7D\"></card></p><p><br /></p><p><br /></p><p>创建仪表盘(Dashboard)</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562736796292-ac3b67dd-1d2f-41a2-a1db-a7e9456ba2cd.png%22%2C%22originWidth%22%3A1342%2C%22originHeight%22%3A557%2C%22name%22%3A%22image.png%22%2C%22size%22%3A39921%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1342%2C%22height%22%3A557%7D\"></card></p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562736761829-08ae709d-eeda-46d7-a3b3-5d17e3eb38fe.png%22%2C%22originWidth%22%3A1021%2C%22originHeight%22%3A457%2C%22name%22%3A%22image.png%22%2C%22size%22%3A43007%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1021%2C%22height%22%3A457%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562736856319-c2134885-f7fe-4468-9609-d1a1e155f220.png%22%2C%22originWidth%22%3A1359%2C%22originHeight%22%3A477%2C%22name%22%3A%22image.png%22%2C%22size%22%3A90419%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1359%2C%22height%22%3A477%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562736915850-1639d58c-faf7-40f9-827b-5ad787fb52fb.png%22%2C%22originWidth%22%3A1354%2C%22originHeight%22%3A515%2C%22name%22%3A%22image.png%22%2C%22size%22%3A109611%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1354%2C%22height%22%3A515%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562736878154-9f97437c-6b4f-419e-89bc-17f45f49947e.png%22%2C%22originWidth%22%3A551%2C%22originHeight%22%3A273%2C%22name%22%3A%22image.png%22%2C%22size%22%3A17982%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A551%2C%22height%22%3A273%7D\"></card></p><p>分享后的dashboard，在底下有个redash的logo</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562736970500-ed1b5503-69c7-40e3-99d8-b5a7cdd58d82.png%22%2C%22originWidth%22%3A500%2C%22originHeight%22%3A295%2C%22name%22%3A%22image.png%22%2C%22size%22%3A9731%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A500%2C%22height%22%3A295%7D\"></card></p><p><br /></p><p>可以嵌入到已有系统里。</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/07/08/redash/\" target=\"_blank\">我的博客</a></li><li><a href=\"https://juejin.im/post/5d25b88cf265da1bc23f9ff3\" target=\"_blank\">我的掘金<cursor /></a></li><li><a href=\"https://redash.io/help/\" target=\"_blank\">Knowledge Base</a></li></ul><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-07-10T10:07:53.000Z",
    "deleted_at": null,
    "created_at": "2019-07-08T04:03:21.000Z",
    "updated_at": "2019-07-11T02:18:12.000Z",
    "published_at": "2019-07-11T02:18:11.000Z",
    "first_published_at": "2019-07-10T08:17:55.000Z",
    "word_count": 829,
    "cover": "",
    "description": "date: 2019-07-08 12:30:00tags: [CDH,hadoop,大数据,数据可视化,Superset,redash]categories: 大数据---这是坚持技术写作计划（含翻译）的第31篇，定个小目标999，每周最少2篇。本文是数据可视化系列第二篇,本系列会讲解 Po...",
    "custom_description": "本文是数据可视化系列第二篇,本系列会讲解 PowerBI/Excel,Metabase,Redash,Superset,CBoard\n\n\n\n人类都是视觉动物，讲究一图胜千言。如果没了可视化，那么你在跟领导汇报工作时，很大程度会鸡同鸭讲。\n\n其实excel2016+已经是一个不错的数据分析及可视化工具",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 2016094,
    "slug": "sentry-and-matomo-install",
    "title": "030-前端错误日志上报及网站统计(sentry+matomo)",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-07-07 15:00:00<br />tags: [sentry,运维,日志,前端,vuejs,matomo,网站分析]<br />categories: 运维<br />---\n\n> 这是坚持技术写作计划（含翻译）的第30篇，定个小目标999，每周最少2篇。\n\n\n本文配合rancher1.6(手头一个测试集群没升级到最新的2.x)讲解如何搭建并配置日志错误上报框架[Sentry](https://sentry.io)及网站统计分析框架[matomo](https://matomo.org/) 的搭建及接入vue(本文以[iview-admin](https://github.com/iview/iview-admin)为例)项目。\n\n<a name=\"3suXa\"></a>\n## 背景简述\n\n- sentry 项目运行过程中，难免出现bug，前端不像后端可以很方便的采集项目日志(比如log4j + elk)，导致每次出问题后还原车祸现场费时费力。另外现在随着vue等兴起，构建项目时打成min.js，无疑又加大了前端定位问题的难度。而sentry是一款专注于错误采集的框架，支持常见的主流语言![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562489039361-12bbbf21-c134-424c-a4ef-24a8d5ed536b.png#align=left&display=inline&height=544&name=image.png&originHeight=544&originWidth=1779&size=112141&status=done&width=1779)采集，聚合，并推送错误信息。注意，sentry并不是日志平台(e.g. log4j + elk)，也不是监控平台，sentry专注于项目中的Error信息的采集，聚合，报警。\n- matomo 前身Pwiki，是一款开源的web网站分析利器。类似于Google Analytics。具体的特性，参见 [Premium Web Analytics](https://matomo.org/feature-overview/) ，比如绘制页面热力图，录制会话，访问漏斗，A/B Test等(这几样都是收费插件功能)。\n\n> 注意：本文假设你已经有rancher1.6的环境\n\n\n<!-- more -->\n\n<a name=\"LmUTY\"></a>\n## 安装\n<a name=\"Z2rjL\"></a>\n### matomo\n<a name=\"RXPnQ\"></a>\n#### rancher 创建matomo\n\n在rancher主机上\n\n```bash\n## 创建必要文件夹\nmkdir -p /data/matomo/{config,logs,php,maxmind}/\n\n## 安装maxmind ip数据库\nwget -P /tmp/ https://github.com/maxmind/geoipupdate/releases/download/v4.0.3/geoipupdate_4.0.3_linux_amd64.deb\ndpkg -i /tmp/geoipupdate_4.0.3_linux_amd64.deb\nmv /etc/GeoIP.conf{,.bak}\ncat << EOF | sudo tee -a /etc/GeoIP.conf\nAccountID 0\nLicenseKey 000000000000\nEditionIDs GeoLite2-Country GeoLite2-City GeoLite2-ASN\nDatabaseDirectory /data/matomo/maxmind\nEOF\n\n## 下载最新maxmind数据库\ngeoipupdate\nls -lah /data/matomo/maxmind/\n总用量 67M\ndrwxr-xr-x 2 root root 4.0K 7月   7 17:25 .\ndrwxr-xr-x 6 root root 4.0K 7月   7 17:23 ..\n-rw------- 1 root root    0 7月   7 17:25 .geoipupdate.lock\n-rw-r--r-- 1 root root 6.3M 7月   7 17:25 GeoLite2-ASN.mmdb\n-rw-r--r-- 1 root root  57M 7月   7 17:25 GeoLite2-City.mmdb\n-rw-r--r-- 1 root root 3.7M 7月   7 17:25 GeoLite2-Country.mmdb\n\n## 定时更新ip数据库\ncat << EOF | sudo tee -a /etc/cron.d/geoipupdate\n50 2 * * 4 root /usr/bin/geoipupdate\nEOF\n\n## 设置php.ini\ncat << EOF | sudo tee -a /data/matomo/php/php.ini\nupload_max_filesize = 128M\npost_max_size = 128M\nmax_execution_time = 200\nmemory_limit = 256M\nEOF\n```\n\ndocker-compose.yaml\n```yaml\nversion: '2'\nservices:\n  matomo:\n    image: matomo:latest\n    stdin_open: true\n    volumes:\n    - /data/matomo/config:/var/www/html/config\n    - /data/matomo/logs:/var/www/html/logs\n    - /data/matomo/php/php.ini:/usr/local/etc/php/php.ini\n    - /data/matomo/maxmind/GeoLite2-City.mmdb:/var/www/html/misc/GeoLite2-City.mmdb\n    - /data/matomo/maxmind/GeoLite2-Country.mmdb:/var/www/html/misc/GeoLite2-Country.mmdb\n    - /data/matomo/maxmind/GeoLite2-ASN.mmdb:/var/www/html/misc/GeoLite2-ASN.mmdb\n    tty: true\n    ports:\n    - 80:80/tcp\n    - 443:443/tcp\n```\n\nrancher-compose.yaml\n```yaml\nversion: '2'\nservices:\n  matomo:\n    scale: 1\n    start_on_create: true\n    health_check:\n      response_timeout: 2000\n      healthy_threshold: 2\n      port: 80\n      unhealthy_threshold: 3\n      initializing_timeout: 60000\n      interval: 2000\n      strategy: recreate\n      reinitializing_timeout: 60000\n```\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562492855584-f8bc4414-c57b-4780-94ee-60f0c42258fb.png#align=left&display=inline&height=588&name=image.png&originHeight=588&originWidth=1884&size=72142&status=done&width=1884)\n\n<a name=\"5Sk9s\"></a>\n#### 配置matomo\n选择中文<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562474861136-8a51035c-9f3d-45c9-b560-17a8d251f21b.png#align=left&display=inline&height=508&name=image.png&originHeight=508&originWidth=606&size=39934&status=done&width=606)<br />系统检查<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562474876102-d3669793-8f7c-4884-a7c8-57c6892b0a63.png#align=left&display=inline&height=602&name=image.png&originHeight=602&originWidth=1361&size=59313&status=done&width=1361)<br />配置数据库<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562475009264-1585cc06-9880-4eb3-9908-70e78cf9012e.png#align=left&display=inline&height=830&name=image.png&originHeight=830&originWidth=823&size=53486&status=done&width=823)<br />自动建表完成<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562475051907-56c50bd2-4e8a-4696-9e99-929d43bd60c8.png#align=left&display=inline&height=520&name=image.png&originHeight=520&originWidth=1348&size=46284&status=done&width=1348)<br />创建管理员用户(忘记截图了)<br />设置分析网站(可以随便创建，后边再进行修改),注意跟进实际情况修改时区<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562475212464-ed37c762-0452-4ae2-9976-c4a90d8eadda.png#align=left&display=inline&height=711&name=image.png&originHeight=711&originWidth=936&size=51354&status=done&width=936)<br />复制跟踪代码<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562475254242-9a8baee0-dc7e-47ff-a913-cca4bcecf018.png#align=left&display=inline&height=844&name=image.png&originHeight=844&originWidth=1396&size=113598&status=done&width=1396)<br />配置matomo<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562475288189-d137a11a-cb01-4311-955e-d42788988f21.png#align=left&display=inline&height=843&name=image.png&originHeight=843&originWidth=1172&size=109853&status=done&width=1172)<br />登陆<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562475319066-c88fd562-3712-4022-a040-f64b1cbbafbe.png#align=left&display=inline&height=668&name=image.png&originHeight=668&originWidth=798&size=26965&status=done&width=798)\n\n<a name=\"uErEW\"></a>\n### Sentry\n<a name=\"FH6Ax\"></a>\n#### rancher 创建Sentry\ndocker-compose.yml\n```yaml\nversion: '2'\nservices:\n  cron:\n    image: sentry:9\n    environment:\n      SENTRY_MEMCACHED_HOST: memcached\n      SENTRY_REDIS_HOST: redis\n      SENTRY_POSTGRES_HOST: postgres\n      SENTRY_EMAIL_HOST: smtp\n      SENTRY_SECRET_KEY: SENTRY_SECRET_KEY_XXX\n    stdin_open: true\n    volumes:\n    - /data/sentry-data:/var/lib/sentry/files\n    - /data/sentry-data/config.yml:/etc/sentry/config.yml\n    tty: true\n    command:\n    - run\n    - cron\n  memcached:\n    image: memcached:1.5-alpine\n  web:\n    image: sentry:9\n    environment:\n      SENTRY_MEMCACHED_HOST: memcached\n      SENTRY_REDIS_HOST: redis\n      SENTRY_POSTGRES_HOST: postgres\n      SENTRY_EMAIL_HOST: smtp\n      SENTRY_SECRET_KEY: SENTRY_SECRET_KEY_XXX\n    stdin_open: true\n    volumes:\n    - /data/sentry-data:/var/lib/sentry/files\n    - /data/sentry-data/config.yml:/etc/sentry/config.yml\n    tty: true\n    ports:\n    - 9000:9000/tcp\n  worker:\n    image: sentry:9\n    environment:\n      SENTRY_MEMCACHED_HOST: memcached\n      SENTRY_REDIS_HOST: redis\n      SENTRY_POSTGRES_HOST: postgres\n      SENTRY_EMAIL_HOST: smtp\n      SENTRY_SECRET_KEY: SENTRY_SECRET_KEY_XXX\n    stdin_open: true\n    volumes:\n    - /data/sentry-data:/var/lib/sentry/files\n    - /data/sentry-data/config.yml:/etc/sentry/config.yml\n    tty: true\n    command:\n    - run\n    - worker\n  redis:\n    image: redis:3.2-alpine\n  postgres:\n    restart: unless-stopped\n    image: postgres:9.5\n    volumes:\n    - /data/postgresql/data:/var/lib/postgresql/data\n    ports:\n    - 5432:5432/tcp\n```\n> 注意把  SENTRY_SECRET_KEY 换成 sentry的实际secret key\n\n\nrancher-compose.yml\n```yaml\nversion: '2'\nservices:\n  cron:\n    scale: 1\n    start_on_create: true\n  memcached:\n    scale: 1\n    start_on_create: true\n  web:\n    scale: 1\n    start_on_create: true\n    health_check:\n      response_timeout: 2000\n      healthy_threshold: 2\n      port: 9000\n      unhealthy_threshold: 3\n      initializing_timeout: 60000\n      interval: 2000\n      strategy: recreate\n      reinitializing_timeout: 60000\n  worker:\n    scale: 1\n    start_on_create: true\n  redis:\n    scale: 1\n    start_on_create: true\n  postgres:\n    scale: 1\n    start_on_create: true\n    health_check:\n      response_timeout: 2000\n      healthy_threshold: 2\n      port: 5432\n      unhealthy_threshold: 3\n      initializing_timeout: 60000\n      interval: 2000\n      strategy: recreate\n      reinitializing_timeout: 60000\n```\n先将docker-compose.yml 保存到服务器上，用来初始化db和创建账号\n\n```bash\ndocker-compose run --rm web upgrade\nWould you like to create a user account now? [Y/n]: y\nEmail: anjia0532@gmail.com\nPassword: \nRepeat for confirmation: \nShould this user be a superuser? [y/N]: y\n## 直到输出\nMigrated:\n - sentry\n - sentry.nodestore\n - sentry.search\n - social_auth\n - sentry.tagstore\n - sentry_plugins.hipchat_ac\n - sentry_plugins.jira_ac\nCreating missing DSNs\nCorrecting Group.num_comments counter\n## 并退出\n```\n\n<a name=\"13XYc\"></a>\n#### 配置Sentry\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562504762029-c863b8c3-4b57-4260-b370-e538cce436e7.png#align=left&display=inline&height=503&name=image.png&originHeight=503&originWidth=716&size=44203&status=done&width=716)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562504816401-106637ac-f528-4985-bcd1-f5649f00cc18.png#align=left&display=inline&height=712&name=image.png&originHeight=712&originWidth=656&size=148457&status=done&width=656)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562504900957-00a0a900-8276-47cf-b33a-52fe87cdd130.png#align=left&display=inline&height=804&name=image.png&originHeight=804&originWidth=1501&size=130999&status=done&width=1501)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562505169347-a858daf1-bd4d-4101-97d5-aa071564a8db.png#align=left&display=inline&height=222&name=image.png&originHeight=222&originWidth=258&size=5513&status=done&width=258)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562505136746-68d7b0e7-932e-4aef-be34-12da8cc9bbf7.png#align=left&display=inline&height=575&name=image.png&originHeight=575&originWidth=1029&size=69263&status=done&width=1029)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562505216529-4a3b7152-0b37-4014-a9e2-266cff0b72d7.png#align=left&display=inline&height=620&name=image.png&originHeight=620&originWidth=1281&size=95572&status=done&width=1281)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562505244285-e97409c9-7565-4b53-b4da-d669bf2db3ad.png#align=left&display=inline&height=894&name=image.png&originHeight=894&originWidth=1272&size=139045&status=done&width=1272)\n\n<a name=\"jFXcp\"></a>\n## 配置vue\n本文以iview-admin为例\n\n```bash\ngit clone https://gitee.com/anjia/iview-admin.git\ncd iview-admin\n```\n\n<a name=\"e7gJY\"></a>\n### sentry\n注意，网上很多文档，以讹传讹的使用过时的工具，raven-js .从5.x后官方建议使用@sentry/browser和@sentry/integrations\n```bash\nnpm install --save @sentry/integrations\nnpm install --save @sentry/browser\n```\n\n修改 `iview-admin\\src\\main.js` \n\n```javascript\n// The Vue build version to load with the `import` command\n// (runtime-only or standalone) has been set in webpack.base.conf with an alias.\nimport Vue from 'vue'\nimport App from './App'\nimport router from './router'\nimport store from './store'\nimport iView from 'iview'\nimport i18n from '@/locale'\nimport config from '@/config'\nimport importDirective from '@/directive'\nimport { directive as clickOutside } from 'v-click-outside-x'\nimport installPlugin from '@/plugin'\nimport './index.less'\nimport '@/assets/icons/iconfont.css'\nimport TreeTable from 'tree-table-vue'\nimport VOrgTree from 'v-org-tree'\nimport 'v-org-tree/dist/v-org-tree.css'\nimport * as Sentry from '@sentry/browser';\nimport * as Integrations from '@sentry/integrations';\n// 实际打包时应该不引入mock\n/* eslint-disable */\nif (process.env.NODE_ENV !== 'production') require('@/mock')\n\nVue.use(iView, {\n  i18n: (key, value) => i18n.t(key, value)\n})\nVue.use(TreeTable)\nVue.use(VOrgTree)\n/**\n * @description 注册admin内置插件\n */\ninstallPlugin(Vue)\n/**\n * @description 生产环境关掉提示\n */\nVue.config.productionTip = false\n/**\n * @description 全局注册应用配置\n */\nVue.prototype.$config = config\n/**\n * 注册指令\n */\nimportDirective(Vue)\nVue.directive('clickOutside', clickOutside)\n\n/* eslint-disable no-new */\nnew Vue({\n  el: '#app',\n  router,\n  i18n,\n  store,\n  render: h => h(App)\n})\n\nSentry.init({\n  dsn: 'https://xxx@xxx.xxx.com/xxx',\n  integrations: [\n    new Integrations.Vue({\n      Vue,\n      attachProps: true,\n    }),\n  ],\n});\n```\n\n```bash\nnpm install\nnpm run dev\n```\n\n打开 [http://localhost:8080/error_store/error_store_page](http://localhost:8080/error_store/error_store_page)<br />分别点击两个按钮，模拟出错<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562507067736-b37abeba-06bb-48cf-9421-7229b0250070.png#align=left&display=inline&height=797&name=image.png&originHeight=797&originWidth=913&size=108137&status=done&width=913)<br />打开sentry发现已经有错误上报了，并且对错误进行聚合。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562507097119-284acf63-b1df-4004-9027-512dad7b3af3.png#align=left&display=inline&height=464&name=image.png&originHeight=464&originWidth=1783&size=102500&status=done&width=1783)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562507211900-c2fcf0a4-2265-43e5-8ed4-d41ce849b37c.png#align=left&display=inline&height=927&name=image.png&originHeight=927&originWidth=1533&size=181472&status=done&width=1533)点开查看详细内容。\n\n如果需要生成source-map ,可以参考官方文档 [https://docs.sentry.io/platforms/javascript/sourcemaps/](https://docs.sentry.io/platforms/javascript/sourcemaps/)\n\n<a name=\"cwyoX\"></a>\n### matomo\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562507978926-cd3d0612-a601-4294-bd27-afe1aa95e76f.png#align=left&display=inline&height=615&name=image.png&originHeight=615&originWidth=1843&size=53616&status=done&width=1843)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562508055404-00bd3ea6-b9d9-4911-9d73-84e9b40d3499.png#align=left&display=inline&height=277&name=image.png&originHeight=277&originWidth=1084&size=18426&status=done&width=1084)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562508079973-2f10991b-1f19-4403-bc6f-3d62694e0abd.png#align=left&display=inline&height=559&name=image.png&originHeight=559&originWidth=633&size=35279&status=done&width=633)\n\n```bash\nnpm install --save vue-matomo\n```\n修改 `iview-admin\\src\\main.js` \n\n```javascript\n// The Vue build version to load with the `import` command\n// (runtime-only or standalone) has been set in webpack.base.conf with an alias.\nimport Vue from 'vue'\nimport App from './App'\nimport router from './router'\nimport store from './store'\nimport iView from 'iview'\nimport i18n from '@/locale'\nimport config from '@/config'\nimport importDirective from '@/directive'\nimport { directive as clickOutside } from 'v-click-outside-x'\nimport installPlugin from '@/plugin'\nimport './index.less'\nimport '@/assets/icons/iconfont.css'\nimport TreeTable from 'tree-table-vue'\nimport VOrgTree from 'v-org-tree'\nimport 'v-org-tree/dist/v-org-tree.css'\nimport * as Sentry from '@sentry/browser'\nimport * as Integrations from '@sentry/integrations'\nimport VueMatomo from 'vue-matomo'\n\n// 实际打包时应该不引入mock\n/* eslint-disable */\nif (process.env.NODE_ENV !== 'production') require('@/mock')\n\nVue.use(iView, {\n  i18n: (key, value) => i18n.t(key, value)\n})\nVue.use(TreeTable)\nVue.use(VOrgTree)\n/**\n * @description 注册admin内置插件\n */\ninstallPlugin(Vue)\n/**\n * @description 生产环境关掉提示\n */\nVue.config.productionTip = false\n/**\n * @description 全局注册应用配置\n */\nVue.prototype.$config = config\n/**\n * 注册指令\n */\nimportDirective(Vue)\nVue.directive('clickOutside', clickOutside)\n\n/* eslint-disable no-new */\nnew Vue({\n  el: '#app',\n  router,\n  i18n,\n  store,\n  render: h => h(App)\n})\n\nSentry.init({\n  dsn: 'https://xxx@xxx.xxx.com/xxx',\n  integrations: [\n    new Integrations.Vue({\n      Vue,\n      attachProps: true,\n    }),\n  ],\n});\nVue.use(VueMatomo, {\n  // Configure your matomo server and site by providing\n  host: '//xxxx.xxxx.com/',\n  siteId: xx,\n \n  // Changes the default .js and .php endpoint's filename\n  // Default: 'piwik'\n  trackerFileName: 'matomo.js',\n \n  // Overrides the autogenerated tracker endpoint entirely\n  // Default: undefined\n  trackerUrl: '//xxxx.xxxx.com/matomo.php',\n \n  // Enables automatically registering pageviews on the router\n  router: router,\n \n  // Enables link tracking on regular links. Note that this won't\n  // work for routing links (ie. internal Vue router links)\n  // Default: true\n  enableLinkTracking: true,\n \n  // Require consent before sending tracking information to matomo\n  // Default: false\n  requireConsent: false,\n \n  // Whether to track the initial page view\n  // Default: true\n  trackInitialView: true,\n \n  // Whether or not to log debug information\n  // Default: false\n  debug: false\n});\n \n \n// or\nwindow._paq.push\n \n// or through\nwindow.Piwik.getTracker\n```\n\n打开 http://localhost:8080, 随便访问几个菜单,然后打开matomo<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562508801909-af15cc0f-180a-4cfc-86ec-768bfd892d67.png#align=left&display=inline&height=515&name=image.png&originHeight=515&originWidth=880&size=45838&status=done&width=880)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562508853543-f7592d90-ff5e-4f58-974a-e1f37b230e2c.png#align=left&display=inline&height=727&name=image.png&originHeight=727&originWidth=1416&size=69029&status=done&width=1416)<br />路由已经有数据了<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1562508892758-378acda5-d8ee-44a1-81f9-7ac7933da610.png#align=left&display=inline&height=749&name=image.png&originHeight=749&originWidth=1553&size=122920&status=done&width=1553)<br />并且将用户的常规数据聚合起来\n\n<a name=\"9yhO5\"></a>\n## 更多\n其实本文只是sentry和matomo简单介绍<br />更深入的使用，比如sentry，推送邮件，文中一带而过的sourcemap，单点登录(集成内部的权限认证)，自定义上报内容(将错误与用户id关联起来)，,敏感数据脱敏等<br />比如matomo, 每日发送分析报表，增加kafka插件，进行更深层次的挖掘，自定义上报内容(购物车等),大数据量情况下的优化，优化用户设备指纹，使用了nginx等反代软件后，如何正确识别真实ip，热力图，A/B test,漏斗图等\n<a name=\"ND8RQ\"></a>\n## 参考资料\n\n- [我的个人博客](https://anjia0532.github.io/2019/07/07/sentry-and-matomo-install)\n- [我的掘金](https://juejin.im/post/5d22013de51d45775a700395)\n- [matomo官网](https://matomo.org/)\n- [INSTALLING MATOMO](https://matomo.org/docs/installation/)\n- [Sentry官网](https://sentry.io)\n- [Installation with Docker](https://docs.sentry.io/server/installation/docker/)\n- [Automatic Updates for GeoIP2 and GeoIP Legacy Databases](https://dev.maxmind.com/geoip/geoipupdate/)\n- [vue中如何使用sentry对错误日志进行监控](https://segmentfault.com/a/1190000016309667)\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-07-07 15:00:00</p><p>tags: [sentry,运维,日志,前端,vuejs,matomo,网站分析]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第30篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文配合rancher1.6(手头一个测试集群没升级到最新的2.x)讲解如何搭建并配置日志错误上报框架<a href=\"https://sentry.io\" target=\"_blank\">Sentry</a>及网站统计分析框架<a href=\"https://matomo.org/\" target=\"_blank\">matomo</a> 的搭建及接入vue(本文以<a href=\"https://github.com/iview/iview-admin\" target=\"_blank\">iview-admin</a>为例)项目。</p><p><br /></p><h2 id=\"3suXa\"><span style=\"background-color: transparent;\">背景简述</span></h2><p><br /></p><ul><li>sentry 项目运行过程中，难免出现bug，前端不像后端可以很方便的采集项目日志(比如log4j + elk)，导致每次出问题后还原车祸现场费时费力。另外现在随着vue等兴起，构建项目时打成min.js，无疑又加大了前端定位问题的难度。而sentry是一款专注于错误采集的框架，支持常见的主流语言<img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562489039361-12bbbf21-c134-424c-a4ef-24a8d5ed536b.png#align=left&amp;display=inline&amp;height=544&amp;name=image.png&amp;originHeight=544&amp;originWidth=1779&amp;size=112141&amp;status=done&amp;width=1779\" style=\"max-width: 600px; width: 1779px;\" /><span>采</span>集，聚合，并推送错误信息。注意，sentry并不是日志平台(e.g. log4j + elk)，也不是监控平台，sentry专注于项目中的Error信息的采集，聚合，报警。</li><li>matomo 前身Pwiki，是一款开源的web网站分析利器。类似于Google Analytics。具体的特性，参见 <a href=\"https://matomo.org/feature-overview/\" target=\"_blank\">Premium Web Analytics</a> ，比如绘制页面热力图，录制会话，访问漏斗，A/B Test等(这几样都是收费插件功能)。</li></ul><p><br /></p><blockquote><p>注意：本文假设你已经有rancher1.6的环境</p></blockquote><p><br /></p><p><span>&lt;!-- more --&gt;</span></p><p><span><br /></span></p><h2 id=\"LmUTY\">安装</h2><h3 id=\"Z2rjL\">matomo</h3><h4 id=\"RXPnQ\">rancher 创建matomo</h4><p><br /></p><p>在rancher主机上</p><p><br /></p><pre data-lang=\"bash\"><code>## 创建必要文件夹\nmkdir -p /data/matomo/{config,logs,php,maxmind}/\n\n## 安装maxmind ip数据库\nwget -P /tmp/ https://github.com/maxmind/geoipupdate/releases/download/v4.0.3/geoipupdate_4.0.3_linux_amd64.deb\ndpkg -i /tmp/geoipupdate_4.0.3_linux_amd64.deb\nmv /etc/GeoIP.conf{,.bak}\ncat &lt;&lt; EOF | sudo tee -a /etc/GeoIP.conf\nAccountID 0\nLicenseKey 000000000000\nEditionIDs GeoLite2-Country GeoLite2-City GeoLite2-ASN\nDatabaseDirectory /data/matomo/maxmind\nEOF\n\n## 下载最新maxmind数据库\ngeoipupdate\nls -lah /data/matomo/maxmind/\n总用量 67M\ndrwxr-xr-x 2 root root 4.0K 7月   7 17:25 .\ndrwxr-xr-x 6 root root 4.0K 7月   7 17:23 ..\n-rw------- 1 root root    0 7月   7 17:25 .geoipupdate.lock\n-rw-r--r-- 1 root root 6.3M 7月   7 17:25 GeoLite2-ASN.mmdb\n-rw-r--r-- 1 root root  57M 7月   7 17:25 GeoLite2-City.mmdb\n-rw-r--r-- 1 root root 3.7M 7月   7 17:25 GeoLite2-Country.mmdb\n\n## 定时更新ip数据库\ncat &lt;&lt; EOF | sudo tee -a /etc/cron.d/geoipupdate\n50 2 * * 4 root /usr/bin/geoipupdate\nEOF\n\n## 设置php.ini\ncat &lt;&lt; EOF | sudo tee -a /data/matomo/php/php.ini\nupload_max_filesize = 128M\npost_max_size = 128M\nmax_execution_time = 200\nmemory_limit = 256M\nEOF</code></pre><p><br /></p><p>docker-compose.yaml</p><pre data-lang=\"yaml\"><code>version: '2'\nservices:\n  matomo:\n    image: matomo:latest\n    stdin_open: true\n    volumes:\n    - /data/matomo/config:/var/www/html/config\n    - /data/matomo/logs:/var/www/html/logs\n    - /data/matomo/php/php.ini:/usr/local/etc/php/php.ini\n    - /data/matomo/maxmind/GeoLite2-City.mmdb:/var/www/html/misc/GeoLite2-City.mmdb\n    - /data/matomo/maxmind/GeoLite2-Country.mmdb:/var/www/html/misc/GeoLite2-Country.mmdb\n    - /data/matomo/maxmind/GeoLite2-ASN.mmdb:/var/www/html/misc/GeoLite2-ASN.mmdb\n    tty: true\n    ports:\n    - 80:80/tcp\n    - 443:443/tcp</code></pre><p><br /></p><p>rancher-compose.yaml</p><pre data-lang=\"yaml\"><code>version: '2'\nservices:\n  matomo:\n    scale: 1\n    start_on_create: true\n    health_check:\n      response_timeout: 2000\n      healthy_threshold: 2\n      port: 80\n      unhealthy_threshold: 3\n      initializing_timeout: 60000\n      interval: 2000\n      strategy: recreate\n      reinitializing_timeout: 60000</code></pre><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562492855584-f8bc4414-c57b-4780-94ee-60f0c42258fb.png#align=left&amp;display=inline&amp;height=588&amp;name=image.png&amp;originHeight=588&amp;originWidth=1884&amp;size=72142&amp;status=done&amp;width=1884\" style=\"max-width: 600px; width: 1884px;\" /></p><p><br /></p><h4 id=\"5Sk9s\">配置matomo</h4><p>选择中文</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562474861136-8a51035c-9f3d-45c9-b560-17a8d251f21b.png#align=left&amp;display=inline&amp;height=508&amp;name=image.png&amp;originHeight=508&amp;originWidth=606&amp;size=39934&amp;status=done&amp;width=606\" style=\"max-width: 600px; width: 606px;\" /></p><p>系统检查</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562474876102-d3669793-8f7c-4884-a7c8-57c6892b0a63.png#align=left&amp;display=inline&amp;height=602&amp;name=image.png&amp;originHeight=602&amp;originWidth=1361&amp;size=59313&amp;status=done&amp;width=1361\" style=\"max-width: 600px; width: 1361px;\" /></p><p>配置数据库</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562475009264-1585cc06-9880-4eb3-9908-70e78cf9012e.png#align=left&amp;display=inline&amp;height=830&amp;name=image.png&amp;originHeight=830&amp;originWidth=823&amp;size=53486&amp;status=done&amp;width=823\" style=\"max-width: 600px; width: 823px;\" /></p><p>自动建表完成</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562475051907-56c50bd2-4e8a-4696-9e99-929d43bd60c8.png#align=left&amp;display=inline&amp;height=520&amp;name=image.png&amp;originHeight=520&amp;originWidth=1348&amp;size=46284&amp;status=done&amp;width=1348\" style=\"max-width: 600px; width: 1348px;\" /></p><p>创建管理员用户(忘记截图了)</p><p>设置分析网站(可以随便创建，后边再进行修改),注意跟进实际情况修改时区</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562475212464-ed37c762-0452-4ae2-9976-c4a90d8eadda.png#align=left&amp;display=inline&amp;height=711&amp;name=image.png&amp;originHeight=711&amp;originWidth=936&amp;size=51354&amp;status=done&amp;width=936\" style=\"max-width: 600px; width: 936px;\" /></p><p>复制跟踪代码</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562475254242-9a8baee0-dc7e-47ff-a913-cca4bcecf018.png#align=left&amp;display=inline&amp;height=844&amp;name=image.png&amp;originHeight=844&amp;originWidth=1396&amp;size=113598&amp;status=done&amp;width=1396\" style=\"max-width: 600px; width: 1396px;\" /></p><p>配置matomo</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562475288189-d137a11a-cb01-4311-955e-d42788988f21.png#align=left&amp;display=inline&amp;height=843&amp;name=image.png&amp;originHeight=843&amp;originWidth=1172&amp;size=109853&amp;status=done&amp;width=1172\" style=\"max-width: 600px; width: 1172px;\" /></p><p>登陆</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562475319066-c88fd562-3712-4022-a040-f64b1cbbafbe.png#align=left&amp;display=inline&amp;height=668&amp;name=image.png&amp;originHeight=668&amp;originWidth=798&amp;size=26965&amp;status=done&amp;width=798\" style=\"max-width: 600px; width: 798px;\" /></p><p><br /></p><h3 id=\"uErEW\">Sentry</h3><h4 id=\"FH6Ax\">rancher 创建Sentry</h4><p>docker-compose.yml</p><pre data-lang=\"yaml\"><code>version: '2'\nservices:\n  cron:\n    image: sentry:9\n    environment:\n      SENTRY_MEMCACHED_HOST: memcached\n      SENTRY_REDIS_HOST: redis\n      SENTRY_POSTGRES_HOST: postgres\n      SENTRY_EMAIL_HOST: smtp\n      SENTRY_SECRET_KEY: SENTRY_SECRET_KEY_XXX\n    stdin_open: true\n    volumes:\n    - /data/sentry-data:/var/lib/sentry/files\n    - /data/sentry-data/config.yml:/etc/sentry/config.yml\n    tty: true\n    command:\n    - run\n    - cron\n  memcached:\n    image: memcached:1.5-alpine\n  web:\n    image: sentry:9\n    environment:\n      SENTRY_MEMCACHED_HOST: memcached\n      SENTRY_REDIS_HOST: redis\n      SENTRY_POSTGRES_HOST: postgres\n      SENTRY_EMAIL_HOST: smtp\n      SENTRY_SECRET_KEY: SENTRY_SECRET_KEY_XXX\n    stdin_open: true\n    volumes:\n    - /data/sentry-data:/var/lib/sentry/files\n    - /data/sentry-data/config.yml:/etc/sentry/config.yml\n    tty: true\n    ports:\n    - 9000:9000/tcp\n  worker:\n    image: sentry:9\n    environment:\n      SENTRY_MEMCACHED_HOST: memcached\n      SENTRY_REDIS_HOST: redis\n      SENTRY_POSTGRES_HOST: postgres\n      SENTRY_EMAIL_HOST: smtp\n      SENTRY_SECRET_KEY: SENTRY_SECRET_KEY_XXX\n    stdin_open: true\n    volumes:\n    - /data/sentry-data:/var/lib/sentry/files\n    - /data/sentry-data/config.yml:/etc/sentry/config.yml\n    tty: true\n    command:\n    - run\n    - worker\n  redis:\n    image: redis:3.2-alpine\n  postgres:\n    restart: unless-stopped\n    image: postgres:9.5\n    volumes:\n    - /data/postgresql/data:/var/lib/postgresql/data\n    ports:\n    - 5432:5432/tcp</code></pre><blockquote><p>注意把  SENTRY_SECRET_KEY 换成 sentry的实际secret key</p></blockquote><p><br /></p><p>rancher-compose.yml</p><pre data-lang=\"yaml\"><code>version: '2'\nservices:\n  cron:\n    scale: 1\n    start_on_create: true\n  memcached:\n    scale: 1\n    start_on_create: true\n  web:\n    scale: 1\n    start_on_create: true\n    health_check:\n      response_timeout: 2000\n      healthy_threshold: 2\n      port: 9000\n      unhealthy_threshold: 3\n      initializing_timeout: 60000\n      interval: 2000\n      strategy: recreate\n      reinitializing_timeout: 60000\n  worker:\n    scale: 1\n    start_on_create: true\n  redis:\n    scale: 1\n    start_on_create: true\n  postgres:\n    scale: 1\n    start_on_create: true\n    health_check:\n      response_timeout: 2000\n      healthy_threshold: 2\n      port: 5432\n      unhealthy_threshold: 3\n      initializing_timeout: 60000\n      interval: 2000\n      strategy: recreate\n      reinitializing_timeout: 60000</code></pre><p>先将docker-compose.yml 保存到服务器上，用来初始化db和创建账号</p><p><br /></p><pre data-lang=\"bash\"><code>docker-compose run --rm web upgrade\nWould you like to create a user account now? [Y/n]: y\nEmail: anjia0532@gmail.com\nPassword: \nRepeat for confirmation: \nShould this user be a superuser? [y/N]: y\n## 直到输出\nMigrated:\n - sentry\n - sentry.nodestore\n - sentry.search\n - social_auth\n - sentry.tagstore\n - sentry_plugins.hipchat_ac\n - sentry_plugins.jira_ac\nCreating missing DSNs\nCorrecting Group.num_comments counter\n## 并退出</code></pre><p><br /></p><h4 id=\"13XYc\">配置Sentry</h4><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562504762029-c863b8c3-4b57-4260-b370-e538cce436e7.png#align=left&amp;display=inline&amp;height=503&amp;name=image.png&amp;originHeight=503&amp;originWidth=716&amp;size=44203&amp;status=done&amp;width=716\" style=\"max-width: 600px; width: 716px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562504816401-106637ac-f528-4985-bcd1-f5649f00cc18.png#align=left&amp;display=inline&amp;height=712&amp;name=image.png&amp;originHeight=712&amp;originWidth=656&amp;size=148457&amp;status=done&amp;width=656\" style=\"max-width: 600px; width: 656px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562504900957-00a0a900-8276-47cf-b33a-52fe87cdd130.png#align=left&amp;display=inline&amp;height=804&amp;name=image.png&amp;originHeight=804&amp;originWidth=1501&amp;size=130999&amp;status=done&amp;width=1501\" style=\"max-width: 600px; width: 1501px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562505169347-a858daf1-bd4d-4101-97d5-aa071564a8db.png#align=left&amp;display=inline&amp;height=222&amp;name=image.png&amp;originHeight=222&amp;originWidth=258&amp;size=5513&amp;status=done&amp;width=258\" style=\"max-width: 600px; width: 258px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562505136746-68d7b0e7-932e-4aef-be34-12da8cc9bbf7.png#align=left&amp;display=inline&amp;height=575&amp;name=image.png&amp;originHeight=575&amp;originWidth=1029&amp;size=69263&amp;status=done&amp;width=1029\" style=\"max-width: 600px; width: 1029px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562505216529-4a3b7152-0b37-4014-a9e2-266cff0b72d7.png#align=left&amp;display=inline&amp;height=620&amp;name=image.png&amp;originHeight=620&amp;originWidth=1281&amp;size=95572&amp;status=done&amp;width=1281\" style=\"max-width: 600px; width: 1281px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562505244285-e97409c9-7565-4b53-b4da-d669bf2db3ad.png#align=left&amp;display=inline&amp;height=894&amp;name=image.png&amp;originHeight=894&amp;originWidth=1272&amp;size=139045&amp;status=done&amp;width=1272\" style=\"max-width: 600px; width: 1272px;\" /></p><p><br /></p><h2 id=\"jFXcp\">配置vue</h2><p>本文以iview-admin为例</p><p><br /></p><pre data-lang=\"bash\"><code>git clone https://gitee.com/anjia/iview-admin.git\ncd iview-admin</code></pre><p><br /></p><h3 id=\"e7gJY\">sentry</h3><p>注意，网上很多文档，以讹传讹的使用过时的工具，raven-js .从5.x后官方建议使用@sentry/browser和@sentry/integrations</p><pre data-lang=\"bash\"><code>npm install --save @sentry/integrations\nnpm install --save @sentry/browser</code></pre><p><br /></p><p>修改 <code>iview-admin\\src\\main.js</code> </p><p><br /></p><pre data-lang=\"javascript\"><code>// The Vue build version to load with the `import` command\n// (runtime-only or standalone) has been set in webpack.base.conf with an alias.\nimport Vue from 'vue'\nimport App from './App'\nimport router from './router'\nimport store from './store'\nimport iView from 'iview'\nimport i18n from '@/locale'\nimport config from '@/config'\nimport importDirective from '@/directive'\nimport { directive as clickOutside } from 'v-click-outside-x'\nimport installPlugin from '@/plugin'\nimport './index.less'\nimport '@/assets/icons/iconfont.css'\nimport TreeTable from 'tree-table-vue'\nimport VOrgTree from 'v-org-tree'\nimport 'v-org-tree/dist/v-org-tree.css'\nimport * as Sentry from '@sentry/browser';\nimport * as Integrations from '@sentry/integrations';\n// 实际打包时应该不引入mock\n/* eslint-disable */\nif (process.env.NODE_ENV !== 'production') require('@/mock')\n\nVue.use(iView, {\n  i18n: (key, value) =&gt; i18n.t(key, value)\n})\nVue.use(TreeTable)\nVue.use(VOrgTree)\n/**\n * @description 注册admin内置插件\n */\ninstallPlugin(Vue)\n/**\n * @description 生产环境关掉提示\n */\nVue.config.productionTip = false\n/**\n * @description 全局注册应用配置\n */\nVue.prototype.$config = config\n/**\n * 注册指令\n */\nimportDirective(Vue)\nVue.directive('clickOutside', clickOutside)\n\n/* eslint-disable no-new */\nnew Vue({\n  el: '#app',\n  router,\n  i18n,\n  store,\n  render: h =&gt; h(App)\n})\n\nSentry.init({\n  dsn: 'https://xxx@xxx.xxx.com/xxx',\n  integrations: [\n    new Integrations.Vue({\n      Vue,\n      attachProps: true,\n    }),\n  ],\n});</code></pre><p><br /></p><pre data-lang=\"bash\"><code>npm install\nnpm run dev</code></pre><p><br /></p><p>打开 <a href=\"http://localhost:8080/error_store/error_store_page\" target=\"_blank\">http://localhost:8080/error_store/error_store_page</a></p><p>分别点击两个按钮，模拟出错</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562507067736-b37abeba-06bb-48cf-9421-7229b0250070.png#align=left&amp;display=inline&amp;height=797&amp;name=image.png&amp;originHeight=797&amp;originWidth=913&amp;size=108137&amp;status=done&amp;width=913\" style=\"max-width: 600px; width: 913px;\" /></p><p>打开sentry发现已经有错误上报了，并且对错误进行聚合。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562507097119-284acf63-b1df-4004-9027-512dad7b3af3.png#align=left&amp;display=inline&amp;height=464&amp;name=image.png&amp;originHeight=464&amp;originWidth=1783&amp;size=102500&amp;status=done&amp;width=1783\" style=\"max-width: 600px; width: 1783px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562507211900-c2fcf0a4-2265-43e5-8ed4-d41ce849b37c.png#align=left&amp;display=inline&amp;height=927&amp;name=image.png&amp;originHeight=927&amp;originWidth=1533&amp;size=181472&amp;status=done&amp;width=1533\" style=\"max-width: 600px; width: 1533px;\" /><span>点开查看详细内容。</span></p><p><span><br /></span></p><p>如果需要生成source-map ,可以参考官方文档 <a href=\"https://docs.sentry.io/platforms/javascript/sourcemaps/\" target=\"_blank\">https://docs.sentry.io/platforms/javascript/sourcemaps/</a></p><p><br /></p><h3 id=\"cwyoX\">matomo</h3><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562507978926-cd3d0612-a601-4294-bd27-afe1aa95e76f.png#align=left&amp;display=inline&amp;height=615&amp;name=image.png&amp;originHeight=615&amp;originWidth=1843&amp;size=53616&amp;status=done&amp;width=1843\" style=\"max-width: 600px; width: 1843px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562508055404-00bd3ea6-b9d9-4911-9d73-84e9b40d3499.png#align=left&amp;display=inline&amp;height=277&amp;name=image.png&amp;originHeight=277&amp;originWidth=1084&amp;size=18426&amp;status=done&amp;width=1084\" style=\"max-width: 600px; width: 1084px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562508079973-2f10991b-1f19-4403-bc6f-3d62694e0abd.png#align=left&amp;display=inline&amp;height=559&amp;name=image.png&amp;originHeight=559&amp;originWidth=633&amp;size=35279&amp;status=done&amp;width=633\" style=\"max-width: 600px; width: 633px;\" /></p><p><br /></p><pre data-lang=\"bash\"><code>npm install --save vue-matomo</code></pre><p><span>修改 </span><code>iview-admin\\src\\main.js</code> </p><p><br /></p><pre data-lang=\"javascript\"><code>// The Vue build version to load with the `import` command\n// (runtime-only or standalone) has been set in webpack.base.conf with an alias.\nimport Vue from 'vue'\nimport App from './App'\nimport router from './router'\nimport store from './store'\nimport iView from 'iview'\nimport i18n from '@/locale'\nimport config from '@/config'\nimport importDirective from '@/directive'\nimport { directive as clickOutside } from 'v-click-outside-x'\nimport installPlugin from '@/plugin'\nimport './index.less'\nimport '@/assets/icons/iconfont.css'\nimport TreeTable from 'tree-table-vue'\nimport VOrgTree from 'v-org-tree'\nimport 'v-org-tree/dist/v-org-tree.css'\nimport * as Sentry from '@sentry/browser'\nimport * as Integrations from '@sentry/integrations'\nimport VueMatomo from 'vue-matomo'\n\n// 实际打包时应该不引入mock\n/* eslint-disable */\nif (process.env.NODE_ENV !== 'production') require('@/mock')\n\nVue.use(iView, {\n  i18n: (key, value) =&gt; i18n.t(key, value)\n})\nVue.use(TreeTable)\nVue.use(VOrgTree)\n/**\n * @description 注册admin内置插件\n */\ninstallPlugin(Vue)\n/**\n * @description 生产环境关掉提示\n */\nVue.config.productionTip = false\n/**\n * @description 全局注册应用配置\n */\nVue.prototype.$config = config\n/**\n * 注册指令\n */\nimportDirective(Vue)\nVue.directive('clickOutside', clickOutside)\n\n/* eslint-disable no-new */\nnew Vue({\n  el: '#app',\n  router,\n  i18n,\n  store,\n  render: h =&gt; h(App)\n})\n\nSentry.init({\n  dsn: 'https://xxx@xxx.xxx.com/xxx',\n  integrations: [\n    new Integrations.Vue({\n      Vue,\n      attachProps: true,\n    }),\n  ],\n});\nVue.use(VueMatomo, {\n  // Configure your matomo server and site by providing\n  host: '//xxxx.xxxx.com/',\n  siteId: xx,\n \n  // Changes the default .js and .php endpoint's filename\n  // Default: 'piwik'\n  trackerFileName: 'matomo.js',\n \n  // Overrides the autogenerated tracker endpoint entirely\n  // Default: undefined\n  trackerUrl: '//xxxx.xxxx.com/matomo.php',\n \n  // Enables automatically registering pageviews on the router\n  router: router,\n \n  // Enables link tracking on regular links. Note that this won't\n  // work for routing links (ie. internal Vue router links)\n  // Default: true\n  enableLinkTracking: true,\n \n  // Require consent before sending tracking information to matomo\n  // Default: false\n  requireConsent: false,\n \n  // Whether to track the initial page view\n  // Default: true\n  trackInitialView: true,\n \n  // Whether or not to log debug information\n  // Default: false\n  debug: false\n});\n \n \n// or\nwindow._paq.push\n \n// or through\nwindow.Piwik.getTracker</code></pre><p><br /></p><p>打开 http://localhost:8080, 随便访问几个菜单,然后打开matomo</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562508801909-af15cc0f-180a-4cfc-86ec-768bfd892d67.png#align=left&amp;display=inline&amp;height=515&amp;name=image.png&amp;originHeight=515&amp;originWidth=880&amp;size=45838&amp;status=done&amp;width=880\" style=\"max-width: 600px; width: 880px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562508853543-f7592d90-ff5e-4f58-974a-e1f37b230e2c.png#align=left&amp;display=inline&amp;height=727&amp;name=image.png&amp;originHeight=727&amp;originWidth=1416&amp;size=69029&amp;status=done&amp;width=1416\" style=\"max-width: 600px; width: 1416px;\" /></p><p>路由已经有数据了</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1562508892758-378acda5-d8ee-44a1-81f9-7ac7933da610.png#align=left&amp;display=inline&amp;height=749&amp;name=image.png&amp;originHeight=749&amp;originWidth=1553&amp;size=122920&amp;status=done&amp;width=1553\" style=\"max-width: 600px; width: 1553px;\" /></p><p>并且将用户的常规数据聚合起来</p><p><br /></p><h2 id=\"9yhO5\">更多</h2><p>其实本文只是sentry和matomo简单介绍</p><p>更深入的使用，比如sentry，推送邮件，文中一带而过的sourcemap，单点登录(集成内部的权限认证)，自定义上报内容(将错误与用户id关联起来)，<span>,敏感数据脱敏</span>等</p><p>比如matomo, 每日发送分析报表，增加kafka插件，进行更深层次的挖掘，自定义上报内容(购物车等),大数据量情况下的优化，优化用户设备指纹，使用了nginx等反代软件后，如何正确识别真实ip，热力图，A/B test,漏斗图等</p><h2 id=\"ND8RQ\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/07/07/sentry-and-matomo-install\" target=\"_blank\">我的个人博客</a></li><li><a href=\"https://juejin.im/post/5d22013de51d45775a700395\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://matomo.org/\" target=\"_blank\">matomo官网</a></li><li><a href=\"https://matomo.org/docs/installation/\" target=\"_blank\">INSTALLING MATOMO</a></li><li><a href=\"https://sentry.io\" target=\"_blank\">Sentry官网</a></li><li><a href=\"https://docs.sentry.io/server/installation/docker/\" target=\"_blank\">Installation with Docker</a></li><li><a href=\"https://dev.maxmind.com/geoip/geoipupdate/\" target=\"_blank\">Automatic Updates for GeoIP2 and GeoIP Legacy Databases</a></li><li><a href=\"https://segmentfault.com/a/1190000016309667\" target=\"_blank\">vue中如何使用sentry对错误日志进行监控</a></li></ul>",
    "body_lake": "<!doctype lake><p>date: 2019-07-07 15:00:00</p><p>tags: [sentry,运维,日志,前端,vuejs,matomo,网站分析]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第30<cursor />篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文配合rancher1.6(手头一个测试集群没升级到最新的2.x)讲解如何搭建并配置日志错误上报框架<a href=\"https://sentry.io\" target=\"_blank\">Sentry</a>及网站统计分析框架<a href=\"https://matomo.org/\" target=\"_blank\">matomo</a> 的搭建及接入vue(本文以<a href=\"https://github.com/iview/iview-admin\" target=\"_blank\">iview-admin</a>为例)项目。</p><p><br /></p><h2 id=\"3suXa\"><span style=\"background-color: transparent;\">背景简述</span></h2><p><br /></p><ul><li>sentry 项目运行过程中，难免出现bug，前端不像后端可以很方便的采集项目日志(比如log4j + elk)，导致每次出问题后还原车祸现场费时费力。另外现在随着vue等兴起，构建项目时打成min.js，无疑又加大了前端定位问题的难度。而sentry是一款专注于错误采集的框架，支持常见的主流语言<card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562489039361-12bbbf21-c134-424c-a4ef-24a8d5ed536b.png%22%2C%22originWidth%22%3A1779%2C%22originHeight%22%3A544%2C%22name%22%3A%22image.png%22%2C%22size%22%3A112141%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1779%2C%22height%22%3A544%7D\"></card><span>采</span>集，聚合，并推送错误信息。注意，sentry并不是日志平台(e.g. log4j + elk)，也不是监控平台，sentry专注于项目中的Error信息的采集，聚合，报警。</li><li>matomo 前身Pwiki，是一款开源的web网站分析利器。类似于Google Analytics。具体的特性，参见 <a href=\"https://matomo.org/feature-overview/\" target=\"_blank\">Premium Web Analytics</a> ，比如绘制页面热力图，录制会话，访问漏斗，A/B Test等(这几样都是收费插件功能)。</li></ul><p><br /></p><blockquote><p>注意：本文假设你已经有rancher1.6的环境</p></blockquote><p><br /></p><p><span>&lt;!-- more --&gt;</span></p><p><span><br /></span></p><h2 id=\"LmUTY\">安装</h2><h3 id=\"Z2rjL\">matomo</h3><h4 id=\"RXPnQ\">rancher 创建matomo</h4><p><br /></p><p>在rancher主机上</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23%23%20%E5%88%9B%E5%BB%BA%E5%BF%85%E8%A6%81%E6%96%87%E4%BB%B6%E5%A4%B9%5Cnmkdir%20-p%20%2Fdata%2Fmatomo%2F%7Bconfig%2Clogs%2Cphp%2Cmaxmind%7D%2F%5Cn%5Cn%23%23%20%E5%AE%89%E8%A3%85maxmind%20ip%E6%95%B0%E6%8D%AE%E5%BA%93%5Cnwget%20-P%20%2Ftmp%2F%20https%3A%2F%2Fgithub.com%2Fmaxmind%2Fgeoipupdate%2Freleases%2Fdownload%2Fv4.0.3%2Fgeoipupdate_4.0.3_linux_amd64.deb%5Cndpkg%20-i%20%2Ftmp%2Fgeoipupdate_4.0.3_linux_amd64.deb%5Cnmv%20%2Fetc%2FGeoIP.conf%7B%2C.bak%7D%5Cncat%20%3C%3C%20EOF%20%7C%20sudo%20tee%20-a%20%2Fetc%2FGeoIP.conf%5CnAccountID%200%5CnLicenseKey%20000000000000%5CnEditionIDs%20GeoLite2-Country%20GeoLite2-City%20GeoLite2-ASN%5CnDatabaseDirectory%20%2Fdata%2Fmatomo%2Fmaxmind%5CnEOF%5Cn%5Cn%23%23%20%E4%B8%8B%E8%BD%BD%E6%9C%80%E6%96%B0maxmind%E6%95%B0%E6%8D%AE%E5%BA%93%5Cngeoipupdate%5Cnls%20-lah%20%2Fdata%2Fmatomo%2Fmaxmind%2F%5Cn%E6%80%BB%E7%94%A8%E9%87%8F%2067M%5Cndrwxr-xr-x%202%20root%20root%204.0K%207%E6%9C%88%20%20%207%2017%3A25%20.%5Cndrwxr-xr-x%206%20root%20root%204.0K%207%E6%9C%88%20%20%207%2017%3A23%20..%5Cn-rw-------%201%20root%20root%20%20%20%200%207%E6%9C%88%20%20%207%2017%3A25%20.geoipupdate.lock%5Cn-rw-r--r--%201%20root%20root%206.3M%207%E6%9C%88%20%20%207%2017%3A25%20GeoLite2-ASN.mmdb%5Cn-rw-r--r--%201%20root%20root%20%2057M%207%E6%9C%88%20%20%207%2017%3A25%20GeoLite2-City.mmdb%5Cn-rw-r--r--%201%20root%20root%203.7M%207%E6%9C%88%20%20%207%2017%3A25%20GeoLite2-Country.mmdb%5Cn%5Cn%23%23%20%E5%AE%9A%E6%97%B6%E6%9B%B4%E6%96%B0ip%E6%95%B0%E6%8D%AE%E5%BA%93%5Cncat%20%3C%3C%20EOF%20%7C%20sudo%20tee%20-a%20%2Fetc%2Fcron.d%2Fgeoipupdate%5Cn50%202%20*%20*%204%20root%20%2Fusr%2Fbin%2Fgeoipupdate%5CnEOF%5Cn%5Cn%23%23%20%E8%AE%BE%E7%BD%AEphp.ini%5Cncat%20%3C%3C%20EOF%20%7C%20sudo%20tee%20-a%20%2Fdata%2Fmatomo%2Fphp%2Fphp.ini%5Cnupload_max_filesize%20%3D%20128M%5Cnpost_max_size%20%3D%20128M%5Cnmax_execution_time%20%3D%20200%5Cnmemory_limit%20%3D%20256M%5CnEOF%22%2C%22id%22%3A%22fAt48%22%7D\"></card><p><br /></p><p>docker-compose.yaml</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22yaml%22%2C%22code%22%3A%22version%3A%20'2'%5Cnservices%3A%5Cn%20%20matomo%3A%5Cn%20%20%20%20image%3A%20matomo%3Alatest%5Cn%20%20%20%20stdin_open%3A%20true%5Cn%20%20%20%20volumes%3A%5Cn%20%20%20%20-%20%2Fdata%2Fmatomo%2Fconfig%3A%2Fvar%2Fwww%2Fhtml%2Fconfig%5Cn%20%20%20%20-%20%2Fdata%2Fmatomo%2Flogs%3A%2Fvar%2Fwww%2Fhtml%2Flogs%5Cn%20%20%20%20-%20%2Fdata%2Fmatomo%2Fphp%2Fphp.ini%3A%2Fusr%2Flocal%2Fetc%2Fphp%2Fphp.ini%5Cn%20%20%20%20-%20%2Fdata%2Fmatomo%2Fmaxmind%2FGeoLite2-City.mmdb%3A%2Fvar%2Fwww%2Fhtml%2Fmisc%2FGeoLite2-City.mmdb%5Cn%20%20%20%20-%20%2Fdata%2Fmatomo%2Fmaxmind%2FGeoLite2-Country.mmdb%3A%2Fvar%2Fwww%2Fhtml%2Fmisc%2FGeoLite2-Country.mmdb%5Cn%20%20%20%20-%20%2Fdata%2Fmatomo%2Fmaxmind%2FGeoLite2-ASN.mmdb%3A%2Fvar%2Fwww%2Fhtml%2Fmisc%2FGeoLite2-ASN.mmdb%5Cn%20%20%20%20tty%3A%20true%5Cn%20%20%20%20ports%3A%5Cn%20%20%20%20-%2080%3A80%2Ftcp%5Cn%20%20%20%20-%20443%3A443%2Ftcp%22%2C%22id%22%3A%226RO7v%22%7D\"></card><p><br /></p><p>rancher-compose.yaml</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22yaml%22%2C%22code%22%3A%22version%3A%20'2'%5Cnservices%3A%5Cn%20%20matomo%3A%5Cn%20%20%20%20scale%3A%201%5Cn%20%20%20%20start_on_create%3A%20true%5Cn%20%20%20%20health_check%3A%5Cn%20%20%20%20%20%20response_timeout%3A%202000%5Cn%20%20%20%20%20%20healthy_threshold%3A%202%5Cn%20%20%20%20%20%20port%3A%2080%5Cn%20%20%20%20%20%20unhealthy_threshold%3A%203%5Cn%20%20%20%20%20%20initializing_timeout%3A%2060000%5Cn%20%20%20%20%20%20interval%3A%202000%5Cn%20%20%20%20%20%20strategy%3A%20recreate%5Cn%20%20%20%20%20%20reinitializing_timeout%3A%2060000%22%2C%22id%22%3A%22cx3uO%22%7D\"></card><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562492855584-f8bc4414-c57b-4780-94ee-60f0c42258fb.png%22%2C%22originWidth%22%3A1884%2C%22originHeight%22%3A588%2C%22name%22%3A%22image.png%22%2C%22size%22%3A72142%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1884%2C%22height%22%3A588%7D\"></card></p><p><br /></p><h4 id=\"5Sk9s\">配置matomo</h4><p>选择中文</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562474861136-8a51035c-9f3d-45c9-b560-17a8d251f21b.png%22%2C%22originWidth%22%3A606%2C%22originHeight%22%3A508%2C%22name%22%3A%22image.png%22%2C%22size%22%3A39934%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A606%2C%22height%22%3A508%7D\"></card></p><p>系统检查</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562474876102-d3669793-8f7c-4884-a7c8-57c6892b0a63.png%22%2C%22originWidth%22%3A1361%2C%22originHeight%22%3A602%2C%22name%22%3A%22image.png%22%2C%22size%22%3A59313%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1361%2C%22height%22%3A602%7D\"></card></p><p>配置数据库</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562475009264-1585cc06-9880-4eb3-9908-70e78cf9012e.png%22%2C%22originWidth%22%3A823%2C%22originHeight%22%3A830%2C%22name%22%3A%22image.png%22%2C%22size%22%3A53486%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A823%2C%22height%22%3A830%7D\"></card></p><p>自动建表完成</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562475051907-56c50bd2-4e8a-4696-9e99-929d43bd60c8.png%22%2C%22originWidth%22%3A1348%2C%22originHeight%22%3A520%2C%22name%22%3A%22image.png%22%2C%22size%22%3A46284%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1348%2C%22height%22%3A520%7D\"></card></p><p>创建管理员用户(忘记截图了)</p><p>设置分析网站(可以随便创建，后边再进行修改),注意跟进实际情况修改时区</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562475212464-ed37c762-0452-4ae2-9976-c4a90d8eadda.png%22%2C%22originWidth%22%3A936%2C%22originHeight%22%3A711%2C%22name%22%3A%22image.png%22%2C%22size%22%3A51354%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A936%2C%22height%22%3A711%7D\"></card></p><p>复制跟踪代码</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562475254242-9a8baee0-dc7e-47ff-a913-cca4bcecf018.png%22%2C%22originWidth%22%3A1396%2C%22originHeight%22%3A844%2C%22name%22%3A%22image.png%22%2C%22size%22%3A113598%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1396%2C%22height%22%3A844%7D\"></card></p><p>配置matomo</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562475288189-d137a11a-cb01-4311-955e-d42788988f21.png%22%2C%22originWidth%22%3A1172%2C%22originHeight%22%3A843%2C%22name%22%3A%22image.png%22%2C%22size%22%3A109853%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1172%2C%22height%22%3A843%7D\"></card></p><p>登陆</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562475319066-c88fd562-3712-4022-a040-f64b1cbbafbe.png%22%2C%22originWidth%22%3A798%2C%22originHeight%22%3A668%2C%22name%22%3A%22image.png%22%2C%22size%22%3A26965%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A798%2C%22height%22%3A668%7D\"></card></p><p><br /></p><h3 id=\"uErEW\">Sentry</h3><h4 id=\"FH6Ax\">rancher 创建Sentry</h4><p>docker-compose.yml</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22yaml%22%2C%22code%22%3A%22version%3A%20'2'%5Cnservices%3A%5Cn%20%20cron%3A%5Cn%20%20%20%20image%3A%20sentry%3A9%5Cn%20%20%20%20environment%3A%5Cn%20%20%20%20%20%20SENTRY_MEMCACHED_HOST%3A%20memcached%5Cn%20%20%20%20%20%20SENTRY_REDIS_HOST%3A%20redis%5Cn%20%20%20%20%20%20SENTRY_POSTGRES_HOST%3A%20postgres%5Cn%20%20%20%20%20%20SENTRY_EMAIL_HOST%3A%20smtp%5Cn%20%20%20%20%20%20SENTRY_SECRET_KEY%3A%20SENTRY_SECRET_KEY_XXX%5Cn%20%20%20%20stdin_open%3A%20true%5Cn%20%20%20%20volumes%3A%5Cn%20%20%20%20-%20%2Fdata%2Fsentry-data%3A%2Fvar%2Flib%2Fsentry%2Ffiles%5Cn%20%20%20%20-%20%2Fdata%2Fsentry-data%2Fconfig.yml%3A%2Fetc%2Fsentry%2Fconfig.yml%5Cn%20%20%20%20tty%3A%20true%5Cn%20%20%20%20command%3A%5Cn%20%20%20%20-%20run%5Cn%20%20%20%20-%20cron%5Cn%20%20memcached%3A%5Cn%20%20%20%20image%3A%20memcached%3A1.5-alpine%5Cn%20%20web%3A%5Cn%20%20%20%20image%3A%20sentry%3A9%5Cn%20%20%20%20environment%3A%5Cn%20%20%20%20%20%20SENTRY_MEMCACHED_HOST%3A%20memcached%5Cn%20%20%20%20%20%20SENTRY_REDIS_HOST%3A%20redis%5Cn%20%20%20%20%20%20SENTRY_POSTGRES_HOST%3A%20postgres%5Cn%20%20%20%20%20%20SENTRY_EMAIL_HOST%3A%20smtp%5Cn%20%20%20%20%20%20SENTRY_SECRET_KEY%3A%20SENTRY_SECRET_KEY_XXX%5Cn%20%20%20%20stdin_open%3A%20true%5Cn%20%20%20%20volumes%3A%5Cn%20%20%20%20-%20%2Fdata%2Fsentry-data%3A%2Fvar%2Flib%2Fsentry%2Ffiles%5Cn%20%20%20%20-%20%2Fdata%2Fsentry-data%2Fconfig.yml%3A%2Fetc%2Fsentry%2Fconfig.yml%5Cn%20%20%20%20tty%3A%20true%5Cn%20%20%20%20ports%3A%5Cn%20%20%20%20-%209000%3A9000%2Ftcp%5Cn%20%20worker%3A%5Cn%20%20%20%20image%3A%20sentry%3A9%5Cn%20%20%20%20environment%3A%5Cn%20%20%20%20%20%20SENTRY_MEMCACHED_HOST%3A%20memcached%5Cn%20%20%20%20%20%20SENTRY_REDIS_HOST%3A%20redis%5Cn%20%20%20%20%20%20SENTRY_POSTGRES_HOST%3A%20postgres%5Cn%20%20%20%20%20%20SENTRY_EMAIL_HOST%3A%20smtp%5Cn%20%20%20%20%20%20SENTRY_SECRET_KEY%3A%20SENTRY_SECRET_KEY_XXX%5Cn%20%20%20%20stdin_open%3A%20true%5Cn%20%20%20%20volumes%3A%5Cn%20%20%20%20-%20%2Fdata%2Fsentry-data%3A%2Fvar%2Flib%2Fsentry%2Ffiles%5Cn%20%20%20%20-%20%2Fdata%2Fsentry-data%2Fconfig.yml%3A%2Fetc%2Fsentry%2Fconfig.yml%5Cn%20%20%20%20tty%3A%20true%5Cn%20%20%20%20command%3A%5Cn%20%20%20%20-%20run%5Cn%20%20%20%20-%20worker%5Cn%20%20redis%3A%5Cn%20%20%20%20image%3A%20redis%3A3.2-alpine%5Cn%20%20postgres%3A%5Cn%20%20%20%20restart%3A%20unless-stopped%5Cn%20%20%20%20image%3A%20postgres%3A9.5%5Cn%20%20%20%20volumes%3A%5Cn%20%20%20%20-%20%2Fdata%2Fpostgresql%2Fdata%3A%2Fvar%2Flib%2Fpostgresql%2Fdata%5Cn%20%20%20%20ports%3A%5Cn%20%20%20%20-%205432%3A5432%2Ftcp%22%2C%22id%22%3A%220clN9%22%7D\"></card><blockquote><p>注意把  SENTRY_SECRET_KEY 换成 sentry的实际secret key</p></blockquote><p><br /></p><p>rancher-compose.yml</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22yaml%22%2C%22code%22%3A%22version%3A%20'2'%5Cnservices%3A%5Cn%20%20cron%3A%5Cn%20%20%20%20scale%3A%201%5Cn%20%20%20%20start_on_create%3A%20true%5Cn%20%20memcached%3A%5Cn%20%20%20%20scale%3A%201%5Cn%20%20%20%20start_on_create%3A%20true%5Cn%20%20web%3A%5Cn%20%20%20%20scale%3A%201%5Cn%20%20%20%20start_on_create%3A%20true%5Cn%20%20%20%20health_check%3A%5Cn%20%20%20%20%20%20response_timeout%3A%202000%5Cn%20%20%20%20%20%20healthy_threshold%3A%202%5Cn%20%20%20%20%20%20port%3A%209000%5Cn%20%20%20%20%20%20unhealthy_threshold%3A%203%5Cn%20%20%20%20%20%20initializing_timeout%3A%2060000%5Cn%20%20%20%20%20%20interval%3A%202000%5Cn%20%20%20%20%20%20strategy%3A%20recreate%5Cn%20%20%20%20%20%20reinitializing_timeout%3A%2060000%5Cn%20%20worker%3A%5Cn%20%20%20%20scale%3A%201%5Cn%20%20%20%20start_on_create%3A%20true%5Cn%20%20redis%3A%5Cn%20%20%20%20scale%3A%201%5Cn%20%20%20%20start_on_create%3A%20true%5Cn%20%20postgres%3A%5Cn%20%20%20%20scale%3A%201%5Cn%20%20%20%20start_on_create%3A%20true%5Cn%20%20%20%20health_check%3A%5Cn%20%20%20%20%20%20response_timeout%3A%202000%5Cn%20%20%20%20%20%20healthy_threshold%3A%202%5Cn%20%20%20%20%20%20port%3A%205432%5Cn%20%20%20%20%20%20unhealthy_threshold%3A%203%5Cn%20%20%20%20%20%20initializing_timeout%3A%2060000%5Cn%20%20%20%20%20%20interval%3A%202000%5Cn%20%20%20%20%20%20strategy%3A%20recreate%5Cn%20%20%20%20%20%20reinitializing_timeout%3A%2060000%22%2C%22id%22%3A%22x8VHG%22%7D\"></card><p>先将docker-compose.yml 保存到服务器上，用来初始化db和创建账号</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22docker-compose%20run%20--rm%20web%20upgrade%5CnWould%20you%20like%20to%20create%20a%20user%20account%20now%3F%20%5BY%2Fn%5D%3A%20y%5CnEmail%3A%20anjia0532%40gmail.com%5CnPassword%3A%20%5CnRepeat%20for%20confirmation%3A%20%5CnShould%20this%20user%20be%20a%20superuser%3F%20%5By%2FN%5D%3A%20y%5Cn%23%23%20%E7%9B%B4%E5%88%B0%E8%BE%93%E5%87%BA%5CnMigrated%3A%5Cn%20-%20sentry%5Cn%20-%20sentry.nodestore%5Cn%20-%20sentry.search%5Cn%20-%20social_auth%5Cn%20-%20sentry.tagstore%5Cn%20-%20sentry_plugins.hipchat_ac%5Cn%20-%20sentry_plugins.jira_ac%5CnCreating%20missing%20DSNs%5CnCorrecting%20Group.num_comments%20counter%5Cn%23%23%20%E5%B9%B6%E9%80%80%E5%87%BA%22%2C%22id%22%3A%22n06QP%22%7D\"></card><p><br /></p><h4 id=\"13XYc\">配置Sentry</h4><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562504762029-c863b8c3-4b57-4260-b370-e538cce436e7.png%22%2C%22originWidth%22%3A716%2C%22originHeight%22%3A503%2C%22name%22%3A%22image.png%22%2C%22size%22%3A44203%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A716%2C%22height%22%3A503%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562504816401-106637ac-f528-4985-bcd1-f5649f00cc18.png%22%2C%22originWidth%22%3A656%2C%22originHeight%22%3A712%2C%22name%22%3A%22image.png%22%2C%22size%22%3A148457%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A656%2C%22height%22%3A712%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562504900957-00a0a900-8276-47cf-b33a-52fe87cdd130.png%22%2C%22originWidth%22%3A1501%2C%22originHeight%22%3A804%2C%22name%22%3A%22image.png%22%2C%22size%22%3A130999%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1501%2C%22height%22%3A804%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562505169347-a858daf1-bd4d-4101-97d5-aa071564a8db.png%22%2C%22originWidth%22%3A258%2C%22originHeight%22%3A222%2C%22name%22%3A%22image.png%22%2C%22size%22%3A5513%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A258%2C%22height%22%3A222%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562505136746-68d7b0e7-932e-4aef-be34-12da8cc9bbf7.png%22%2C%22originWidth%22%3A1029%2C%22originHeight%22%3A575%2C%22name%22%3A%22image.png%22%2C%22size%22%3A69263%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1029%2C%22height%22%3A575%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562505216529-4a3b7152-0b37-4014-a9e2-266cff0b72d7.png%22%2C%22originWidth%22%3A1281%2C%22originHeight%22%3A620%2C%22name%22%3A%22image.png%22%2C%22size%22%3A95572%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1281%2C%22height%22%3A620%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562505244285-e97409c9-7565-4b53-b4da-d669bf2db3ad.png%22%2C%22originWidth%22%3A1272%2C%22originHeight%22%3A894%2C%22name%22%3A%22image.png%22%2C%22size%22%3A139045%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1272%2C%22height%22%3A894%7D\"></card></p><p><br /></p><h2 id=\"jFXcp\">配置vue</h2><p>本文以iview-admin为例</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22git%20clone%20https%3A%2F%2Fgitee.com%2Fanjia%2Fiview-admin.git%5Cncd%20iview-admin%22%2C%22id%22%3A%22jAYRp%22%7D\"></card><p><br /></p><h3 id=\"e7gJY\">sentry</h3><p>注意，网上很多文档，以讹传讹的使用过时的工具，raven-js .从5.x后官方建议使用@sentry/browser和@sentry/integrations</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22npm%20install%20--save%20%40sentry%2Fintegrations%5Cnnpm%20install%20--save%20%40sentry%2Fbrowser%22%2C%22id%22%3A%22gbXr3%22%7D\"></card><p><br /></p><p>修改 <code>iview-admin\\src\\main.js</code> </p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22javascript%22%2C%22code%22%3A%22%2F%2F%20The%20Vue%20build%20version%20to%20load%20with%20the%20%60import%60%20command%5Cn%2F%2F%20(runtime-only%20or%20standalone)%20has%20been%20set%20in%20webpack.base.conf%20with%20an%20alias.%5Cnimport%20Vue%20from%20'vue'%5Cnimport%20App%20from%20'.%2FApp'%5Cnimport%20router%20from%20'.%2Frouter'%5Cnimport%20store%20from%20'.%2Fstore'%5Cnimport%20iView%20from%20'iview'%5Cnimport%20i18n%20from%20'%40%2Flocale'%5Cnimport%20config%20from%20'%40%2Fconfig'%5Cnimport%20importDirective%20from%20'%40%2Fdirective'%5Cnimport%20%7B%20directive%20as%20clickOutside%20%7D%20from%20'v-click-outside-x'%5Cnimport%20installPlugin%20from%20'%40%2Fplugin'%5Cnimport%20'.%2Findex.less'%5Cnimport%20'%40%2Fassets%2Ficons%2Ficonfont.css'%5Cnimport%20TreeTable%20from%20'tree-table-vue'%5Cnimport%20VOrgTree%20from%20'v-org-tree'%5Cnimport%20'v-org-tree%2Fdist%2Fv-org-tree.css'%5Cnimport%20*%20as%20Sentry%20from%20'%40sentry%2Fbrowser'%3B%5Cnimport%20*%20as%20Integrations%20from%20'%40sentry%2Fintegrations'%3B%5Cn%2F%2F%20%E5%AE%9E%E9%99%85%E6%89%93%E5%8C%85%E6%97%B6%E5%BA%94%E8%AF%A5%E4%B8%8D%E5%BC%95%E5%85%A5mock%5Cn%2F*%20eslint-disable%20*%2F%5Cnif%20(process.env.NODE_ENV%20!%3D%3D%20'production')%20require('%40%2Fmock')%5Cn%5CnVue.use(iView%2C%20%7B%5Cn%20%20i18n%3A%20(key%2C%20value)%20%3D%3E%20i18n.t(key%2C%20value)%5Cn%7D)%5CnVue.use(TreeTable)%5CnVue.use(VOrgTree)%5Cn%2F**%5Cn%20*%20%40description%20%E6%B3%A8%E5%86%8Cadmin%E5%86%85%E7%BD%AE%E6%8F%92%E4%BB%B6%5Cn%20*%2F%5CninstallPlugin(Vue)%5Cn%2F**%5Cn%20*%20%40description%20%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%85%B3%E6%8E%89%E6%8F%90%E7%A4%BA%5Cn%20*%2F%5CnVue.config.productionTip%20%3D%20false%5Cn%2F**%5Cn%20*%20%40description%20%E5%85%A8%E5%B1%80%E6%B3%A8%E5%86%8C%E5%BA%94%E7%94%A8%E9%85%8D%E7%BD%AE%5Cn%20*%2F%5CnVue.prototype.%24config%20%3D%20config%5Cn%2F**%5Cn%20*%20%E6%B3%A8%E5%86%8C%E6%8C%87%E4%BB%A4%5Cn%20*%2F%5CnimportDirective(Vue)%5CnVue.directive('clickOutside'%2C%20clickOutside)%5Cn%5Cn%2F*%20eslint-disable%20no-new%20*%2F%5Cnnew%20Vue(%7B%5Cn%20%20el%3A%20'%23app'%2C%5Cn%20%20router%2C%5Cn%20%20i18n%2C%5Cn%20%20store%2C%5Cn%20%20render%3A%20h%20%3D%3E%20h(App)%5Cn%7D)%5Cn%5CnSentry.init(%7B%5Cn%20%20dsn%3A%20'https%3A%2F%2Fxxx%40xxx.xxx.com%2Fxxx'%2C%5Cn%20%20integrations%3A%20%5B%5Cn%20%20%20%20new%20Integrations.Vue(%7B%5Cn%20%20%20%20%20%20Vue%2C%5Cn%20%20%20%20%20%20attachProps%3A%20true%2C%5Cn%20%20%20%20%7D)%2C%5Cn%20%20%5D%2C%5Cn%7D)%3B%22%2C%22id%22%3A%228VRxp%22%7D\"></card><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22npm%20install%5Cnnpm%20run%20dev%22%2C%22id%22%3A%221C1b9%22%7D\"></card><p><br /></p><p>打开 <a href=\"http://localhost:8080/error_store/error_store_page\" target=\"_blank\">http://localhost:8080/error_store/error_store_page</a></p><p>分别点击两个按钮，模拟出错</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562507067736-b37abeba-06bb-48cf-9421-7229b0250070.png%22%2C%22originWidth%22%3A913%2C%22originHeight%22%3A797%2C%22name%22%3A%22image.png%22%2C%22size%22%3A108137%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A913%2C%22height%22%3A797%7D\"></card></p><p>打开sentry发现已经有错误上报了，并且对错误进行聚合。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562507097119-284acf63-b1df-4004-9027-512dad7b3af3.png%22%2C%22originWidth%22%3A1783%2C%22originHeight%22%3A464%2C%22name%22%3A%22image.png%22%2C%22size%22%3A102500%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1783%2C%22height%22%3A464%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562507211900-c2fcf0a4-2265-43e5-8ed4-d41ce849b37c.png%22%2C%22originWidth%22%3A1533%2C%22originHeight%22%3A927%2C%22name%22%3A%22image.png%22%2C%22size%22%3A181472%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1533%2C%22height%22%3A927%7D\"></card><span>点开查看详细内容。</span></p><p><span><br /></span></p><p>如果需要生成source-map ,可以参考官方文档 <a href=\"https://docs.sentry.io/platforms/javascript/sourcemaps/\" target=\"_blank\">https://docs.sentry.io/platforms/javascript/sourcemaps/</a></p><p><br /></p><h3 id=\"cwyoX\">matomo</h3><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562507978926-cd3d0612-a601-4294-bd27-afe1aa95e76f.png%22%2C%22originWidth%22%3A1843%2C%22originHeight%22%3A615%2C%22name%22%3A%22image.png%22%2C%22size%22%3A53616%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1843%2C%22height%22%3A615%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562508055404-00bd3ea6-b9d9-4911-9d73-84e9b40d3499.png%22%2C%22originWidth%22%3A1084%2C%22originHeight%22%3A277%2C%22name%22%3A%22image.png%22%2C%22size%22%3A18426%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1084%2C%22height%22%3A277%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562508079973-2f10991b-1f19-4403-bc6f-3d62694e0abd.png%22%2C%22originWidth%22%3A633%2C%22originHeight%22%3A559%2C%22name%22%3A%22image.png%22%2C%22size%22%3A35279%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A633%2C%22height%22%3A559%7D\"></card></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22npm%20install%20--save%20vue-matomo%22%2C%22id%22%3A%22bGsHz%22%7D\"></card><p><span>修改 </span><code>iview-admin\\src\\main.js</code> </p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22javascript%22%2C%22code%22%3A%22%2F%2F%20The%20Vue%20build%20version%20to%20load%20with%20the%20%60import%60%20command%5Cn%2F%2F%20(runtime-only%20or%20standalone)%20has%20been%20set%20in%20webpack.base.conf%20with%20an%20alias.%5Cnimport%20Vue%20from%20'vue'%5Cnimport%20App%20from%20'.%2FApp'%5Cnimport%20router%20from%20'.%2Frouter'%5Cnimport%20store%20from%20'.%2Fstore'%5Cnimport%20iView%20from%20'iview'%5Cnimport%20i18n%20from%20'%40%2Flocale'%5Cnimport%20config%20from%20'%40%2Fconfig'%5Cnimport%20importDirective%20from%20'%40%2Fdirective'%5Cnimport%20%7B%20directive%20as%20clickOutside%20%7D%20from%20'v-click-outside-x'%5Cnimport%20installPlugin%20from%20'%40%2Fplugin'%5Cnimport%20'.%2Findex.less'%5Cnimport%20'%40%2Fassets%2Ficons%2Ficonfont.css'%5Cnimport%20TreeTable%20from%20'tree-table-vue'%5Cnimport%20VOrgTree%20from%20'v-org-tree'%5Cnimport%20'v-org-tree%2Fdist%2Fv-org-tree.css'%5Cnimport%20*%20as%20Sentry%20from%20'%40sentry%2Fbrowser'%5Cnimport%20*%20as%20Integrations%20from%20'%40sentry%2Fintegrations'%5Cnimport%20VueMatomo%20from%20'vue-matomo'%5Cn%5Cn%2F%2F%20%E5%AE%9E%E9%99%85%E6%89%93%E5%8C%85%E6%97%B6%E5%BA%94%E8%AF%A5%E4%B8%8D%E5%BC%95%E5%85%A5mock%5Cn%2F*%20eslint-disable%20*%2F%5Cnif%20(process.env.NODE_ENV%20!%3D%3D%20'production')%20require('%40%2Fmock')%5Cn%5CnVue.use(iView%2C%20%7B%5Cn%20%20i18n%3A%20(key%2C%20value)%20%3D%3E%20i18n.t(key%2C%20value)%5Cn%7D)%5CnVue.use(TreeTable)%5CnVue.use(VOrgTree)%5Cn%2F**%5Cn%20*%20%40description%20%E6%B3%A8%E5%86%8Cadmin%E5%86%85%E7%BD%AE%E6%8F%92%E4%BB%B6%5Cn%20*%2F%5CninstallPlugin(Vue)%5Cn%2F**%5Cn%20*%20%40description%20%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%85%B3%E6%8E%89%E6%8F%90%E7%A4%BA%5Cn%20*%2F%5CnVue.config.productionTip%20%3D%20false%5Cn%2F**%5Cn%20*%20%40description%20%E5%85%A8%E5%B1%80%E6%B3%A8%E5%86%8C%E5%BA%94%E7%94%A8%E9%85%8D%E7%BD%AE%5Cn%20*%2F%5CnVue.prototype.%24config%20%3D%20config%5Cn%2F**%5Cn%20*%20%E6%B3%A8%E5%86%8C%E6%8C%87%E4%BB%A4%5Cn%20*%2F%5CnimportDirective(Vue)%5CnVue.directive('clickOutside'%2C%20clickOutside)%5Cn%5Cn%2F*%20eslint-disable%20no-new%20*%2F%5Cnnew%20Vue(%7B%5Cn%20%20el%3A%20'%23app'%2C%5Cn%20%20router%2C%5Cn%20%20i18n%2C%5Cn%20%20store%2C%5Cn%20%20render%3A%20h%20%3D%3E%20h(App)%5Cn%7D)%5Cn%5CnSentry.init(%7B%5Cn%20%20dsn%3A%20'https%3A%2F%2Fxxx%40xxx.xxx.com%2Fxxx'%2C%5Cn%20%20integrations%3A%20%5B%5Cn%20%20%20%20new%20Integrations.Vue(%7B%5Cn%20%20%20%20%20%20Vue%2C%5Cn%20%20%20%20%20%20attachProps%3A%20true%2C%5Cn%20%20%20%20%7D)%2C%5Cn%20%20%5D%2C%5Cn%7D)%3B%5CnVue.use(VueMatomo%2C%20%7B%5Cn%20%20%2F%2F%20Configure%20your%20matomo%20server%20and%20site%20by%20providing%5Cn%20%20host%3A%20'%2F%2Fxxxx.xxxx.com%2F'%2C%5Cn%20%20siteId%3A%20xx%2C%5Cn%20%5Cn%20%20%2F%2F%20Changes%20the%20default%20.js%20and%20.php%20endpoint's%20filename%5Cn%20%20%2F%2F%20Default%3A%20'piwik'%5Cn%20%20trackerFileName%3A%20'matomo.js'%2C%5Cn%20%5Cn%20%20%2F%2F%20Overrides%20the%20autogenerated%20tracker%20endpoint%20entirely%5Cn%20%20%2F%2F%20Default%3A%20undefined%5Cn%20%20trackerUrl%3A%20'%2F%2Fxxxx.xxxx.com%2Fmatomo.php'%2C%5Cn%20%5Cn%20%20%2F%2F%20Enables%20automatically%20registering%20pageviews%20on%20the%20router%5Cn%20%20router%3A%20router%2C%5Cn%20%5Cn%20%20%2F%2F%20Enables%20link%20tracking%20on%20regular%20links.%20Note%20that%20this%20won't%5Cn%20%20%2F%2F%20work%20for%20routing%20links%20(ie.%20internal%20Vue%20router%20links)%5Cn%20%20%2F%2F%20Default%3A%20true%5Cn%20%20enableLinkTracking%3A%20true%2C%5Cn%20%5Cn%20%20%2F%2F%20Require%20consent%20before%20sending%20tracking%20information%20to%20matomo%5Cn%20%20%2F%2F%20Default%3A%20false%5Cn%20%20requireConsent%3A%20false%2C%5Cn%20%5Cn%20%20%2F%2F%20Whether%20to%20track%20the%20initial%20page%20view%5Cn%20%20%2F%2F%20Default%3A%20true%5Cn%20%20trackInitialView%3A%20true%2C%5Cn%20%5Cn%20%20%2F%2F%20Whether%20or%20not%20to%20log%20debug%20information%5Cn%20%20%2F%2F%20Default%3A%20false%5Cn%20%20debug%3A%20false%5Cn%7D)%3B%5Cn%20%5Cn%20%5Cn%2F%2F%20or%5Cnwindow._paq.push%5Cn%20%5Cn%2F%2F%20or%20through%5Cnwindow.Piwik.getTracker%22%2C%22id%22%3A%224Tr53%22%7D\"></card><p><br /></p><p>打开 http://localhost:8080, 随便访问几个菜单,然后打开matomo</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562508801909-af15cc0f-180a-4cfc-86ec-768bfd892d67.png%22%2C%22originWidth%22%3A880%2C%22originHeight%22%3A515%2C%22name%22%3A%22image.png%22%2C%22size%22%3A45838%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A880%2C%22height%22%3A515%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562508853543-f7592d90-ff5e-4f58-974a-e1f37b230e2c.png%22%2C%22originWidth%22%3A1416%2C%22originHeight%22%3A727%2C%22name%22%3A%22image.png%22%2C%22size%22%3A69029%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1416%2C%22height%22%3A727%7D\"></card></p><p>路由已经有数据了</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1562508892758-378acda5-d8ee-44a1-81f9-7ac7933da610.png%22%2C%22originWidth%22%3A1553%2C%22originHeight%22%3A749%2C%22name%22%3A%22image.png%22%2C%22size%22%3A122920%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1553%2C%22height%22%3A749%7D\"></card></p><p>并且将用户的常规数据聚合起来</p><p><br /></p><h2 id=\"9yhO5\">更多</h2><p>其实本文只是sentry和matomo简单介绍</p><p>更深入的使用，比如sentry，推送邮件，文中一带而过的sourcemap，单点登录(集成内部的权限认证)，自定义上报内容(将错误与用户id关联起来)，<span>,敏感数据脱敏</span>等</p><p>比如matomo, 每日发送分析报表，增加kafka插件，进行更深层次的挖掘，自定义上报内容(购物车等),大数据量情况下的优化，优化用户设备指纹，使用了nginx等反代软件后，如何正确识别真实ip，热力图，A/B test,漏斗图等</p><h2 id=\"ND8RQ\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/07/07/sentry-and-matomo-install\" target=\"_blank\">我的个人博客</a></li><li><a href=\"https://juejin.im/post/5d22013de51d45775a700395\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://matomo.org/\" target=\"_blank\">matomo官网</a></li><li><a href=\"https://matomo.org/docs/installation/\" target=\"_blank\">INSTALLING MATOMO</a></li><li><a href=\"https://sentry.io\" target=\"_blank\">Sentry官网</a></li><li><a href=\"https://docs.sentry.io/server/installation/docker/\" target=\"_blank\">Installation with Docker</a></li><li><a href=\"https://dev.maxmind.com/geoip/geoipupdate/\" target=\"_blank\">Automatic Updates for GeoIP2 and GeoIP Legacy Databases</a></li><li><a href=\"https://segmentfault.com/a/1190000016309667\" target=\"_blank\">vue中如何使用sentry对错误日志进行监控</a></li></ul>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-07-07T14:30:52.000Z",
    "deleted_at": null,
    "created_at": "2019-07-01T08:45:57.000Z",
    "updated_at": "2019-07-08T03:59:12.000Z",
    "published_at": "2019-07-08T03:59:12.000Z",
    "first_published_at": "2019-07-07T14:26:46.000Z",
    "word_count": 2238,
    "cover": "",
    "description": "date: 2019-07-07 15:00:00tags: [sentry,运维,日志,前端,vuejs,matomo,网站分析]categories: 运维---这是坚持技术写作计划（含翻译）的第30篇，定个小目标999，每周最少2篇。本文配合rancher1.6(手头一个测试集群没升级到...",
    "custom_description": "本文配合rancher1.6(手头一个测试集群没升级到最新的2.x)讲解如何搭建并配置日志错误上报框架Sentry及网站统计分析框架matomo 的搭建及接入vue(本文以iview-admin为例)项目。",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 2015352,
    "slug": "sentry-qq-mail",
    "title": "029-解决sentry禁用qq邮箱问题",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-07-01 20:00:00<br />tags: [sentry,运维,日志]<br />categories: 运维<br />---\n> 这是坚持技术写作计划（含翻译）的第29篇，定个小目标999，每周最少2篇。\n\n\nSentry是一款错误日志采集、聚合框架。有Saas版，也可以本地部署。部署可以参考官网或者我之前写的 [30-前端错误日志上报及网站统计(sentry+matomo)](https://anjia0532.github.io/2019/07/07/sentry-and-matomo-install/)\n\n本文主要讲解Sentry默认禁用qq邮箱的排查思路以及如何解决。\n\n添加和自行注册qq邮箱都报无效邮箱。<br />![](https://cdn.nlark.com/yuque/0/2019/png/226273/1561966878110-16806fe5-58ff-4d1d-8287-933328fd8819.png#align=left&display=inline&height=240&originHeight=456&originWidth=1418&size=0&status=done&width=746)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561967139251-c939294d-9ed6-4301-8c4b-c51719989847.png#align=left&display=inline&height=382&name=image.png&originHeight=382&originWidth=633&size=27110&status=done&width=633)\n\n但是QQ邮箱，烂归烂，在国内存量还是挺大的。\n\n<!-- more -->\n\n<a name=\"DyCB3\"></a>\n## 排查思路\nF12大法，看到错误信息是从服务端返回的。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561967659211-59f1fb29-96aa-4625-bead-5d07788aa142.png#align=left&display=inline&height=525&name=image.png&originHeight=525&originWidth=1144&size=76127&status=done&width=1144)\n\n拿到 错误提示 `Enter a valid email address.` 去github搜，<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561968321654-bdbf1381-1e9c-43aa-b7f8-0c612ce52933.png#align=left&display=inline&height=806&name=image.png&originHeight=806&originWidth=822&size=89255&status=done&width=822)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561968360680-7a687c4f-93d4-4ea6-97c9-ecad24a46ed8.png#align=left&display=inline&height=159&name=image.png&originHeight=159&originWidth=426&size=16407&status=done&width=426)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561968410999-fdcfeef4-7f04-461e-b3a6-a697a83ae7e2.png#align=left&display=inline&height=109&name=image.png&originHeight=109&originWidth=596&size=8716&status=done&width=596)<br />拿到 `INVALID_EMAIL_ADDRESS_PATTERN` 再次搜索<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561968483952-2f2b929e-e20a-4cff-999c-8a8f877f1f5a.png#align=left&display=inline&height=514&name=image.png&originHeight=514&originWidth=1080&size=60182&status=done&width=1080)<br />居然是硬编码到代码里的。发现有两个相关的issues.\n\n通过 [getsentry/sentry How to custom INVALID_EMAIL_ADDRESS_PATTERN? #13541](https://github.com/getsentry/sentry/issues/13541) 了解到，官方发现，qq.com 是有很多滥用行为，所以直接硬编码拉黑 [捂脸] .\n\n<a name=\"0Izxl\"></a>\n## 解决\n解决的办法也简单，如果是本地运行的，修改 `/usr/local/lib/python2.7/site-packages/sentry/conf/server.py` ,如果是sass版的，换个邮箱。\n\n注意，如果是 docker 运行的， `docker exec -it sentry /bin/sh`  -> `sed -i \"s/qq/xx/g\" /usr/local/lib/python2.7/site-packages/sentry/conf/server.py` ,重新拉取镜像时，又会变回 `qq.com` \n\n可以 将  `/usr/local/lib/python2.7/site-packages/sentry/conf/server.py`  挂载到宿主机 `docker run -v /opt/sentry/server.py:/usr/local/lib/python2.7/site-packages/sentry/conf/server.py ....` \n\n<a name=\"oz04Q\"></a>\n## 参考资料\n\n- [我的个人博客](https://anjia0532.github.io/2019/07/07/sentry-and-matomo-install/)\n- [我的掘金](https://juejin.im/post/5d22029b6fb9a07ecd3d7f25)\n- [getsentry/sentry How to custom INVALID_EMAIL_ADDRESS_PATTERN? #13541](https://github.com/getsentry/sentry/issues/13541)\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-07-01 20:00:00</p><p>tags: [sentry,运维,日志]</p><p>categories: 运维</p><p>---</p><blockquote><p>这是坚持技术写作计划（含翻译）的第29篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>Sentry是一款错误日志采集、聚合框架。有Saas版，也可以本地部署。部署可以参考官网或者我之前写的 <a href=\"https://anjia0532.github.io/2019/07/07/sentry-and-matomo-install/\" target=\"_blank\">30-前端错误日志上报及网站统计(sentry+matomo)</a></p><p><br /></p><p>本文主要讲解Sentry默认禁用qq邮箱的排查思路以及如何解决。</p><p><br /></p><p>添加和自行注册qq邮箱都报无效邮箱。</p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561966878110-16806fe5-58ff-4d1d-8287-933328fd8819.png#align=left&amp;display=inline&amp;height=240&amp;originHeight=456&amp;originWidth=1418&amp;size=0&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561967139251-c939294d-9ed6-4301-8c4b-c51719989847.png#align=left&amp;display=inline&amp;height=382&amp;name=image.png&amp;originHeight=382&amp;originWidth=633&amp;size=27110&amp;status=done&amp;width=633\" style=\"max-width: 600px; width: 633px;\" /></p><p><br /></p><p>但是QQ邮箱，<span>烂归烂，</span>在国内存量还是挺大的。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"DyCB3\">排查思路</h2><p>F12大法，看到错误信息是从服务端返回的。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561967659211-59f1fb29-96aa-4625-bead-5d07788aa142.png#align=left&amp;display=inline&amp;height=525&amp;name=image.png&amp;originHeight=525&amp;originWidth=1144&amp;size=76127&amp;status=done&amp;width=1144\" style=\"max-width: 600px; width: 1144px;\" /></p><p><br /></p><p>拿到 错误提示 <code>Enter a valid email address.</code> 去github搜，</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561968321654-bdbf1381-1e9c-43aa-b7f8-0c612ce52933.png#align=left&amp;display=inline&amp;height=806&amp;name=image.png&amp;originHeight=806&amp;originWidth=822&amp;size=89255&amp;status=done&amp;width=822\" style=\"max-width: 600px; width: 822px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561968360680-7a687c4f-93d4-4ea6-97c9-ecad24a46ed8.png#align=left&amp;display=inline&amp;height=159&amp;name=image.png&amp;originHeight=159&amp;originWidth=426&amp;size=16407&amp;status=done&amp;width=426\" style=\"max-width: 600px; width: 426px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561968410999-fdcfeef4-7f04-461e-b3a6-a697a83ae7e2.png#align=left&amp;display=inline&amp;height=109&amp;name=image.png&amp;originHeight=109&amp;originWidth=596&amp;size=8716&amp;status=done&amp;width=596\" style=\"max-width: 600px; width: 596px;\" /></p><p>拿到 <code>INVALID_EMAIL_ADDRESS_PATTERN</code> 再次搜索</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561968483952-2f2b929e-e20a-4cff-999c-8a8f877f1f5a.png#align=left&amp;display=inline&amp;height=514&amp;name=image.png&amp;originHeight=514&amp;originWidth=1080&amp;size=60182&amp;status=done&amp;width=1080\" style=\"max-width: 600px; width: 1080px;\" /></p><p>居然是硬编码到代码里的。发现有两个相关的issues.</p><p><br /></p><p>通过 <a href=\"https://github.com/getsentry/sentry/issues/13541\" target=\"_blank\">getsentry/sentry How to custom INVALID_EMAIL_ADDRESS_PATTERN? #13541</a> 了解到，官方发现，qq.com 是有很多滥用行为，所以直接硬编码拉黑 [捂脸] .</p><p><br /></p><h2 id=\"0Izxl\">解决</h2><p>解决的办法也简单，如果是本地运行的，修改 <code>/usr/local/lib/python2.7/site-packages/sentry/conf/server.py</code> ,如果是sass版的，换个邮箱。</p><p><br /></p><p>注意，如果是 docker 运行的， <code>docker exec -it sentry /bin/sh</code>  -&gt; <code>sed -i &quot;s/qq/xx/g&quot; /usr/local/lib/python2.7/site-packages/sentry/conf/server.py</code> ,重新拉取镜像时，又会变回 <code>qq.com</code> </p><p><br /></p><p>可以 将  <code>/usr/local/lib/python2.7/site-packages/sentry/conf/server.py</code>  挂载到宿主机 <code>docker run -v /opt/sentry/server.py:/usr/local/lib/python2.7/site-packages/sentry/conf/server.py ....</code> </p><p><br /></p><h2 id=\"oz04Q\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/07/07/sentry-and-matomo-install/\" target=\"_blank\">我的个人博客</a></li><li><a href=\"https://juejin.im/post/5d22029b6fb9a07ecd3d7f25\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://github.com/getsentry/sentry/issues/13541\" target=\"_blank\">getsentry/sentry How to custom INVALID_EMAIL_ADDRESS_PATTERN? #13541</a></li></ul>",
    "body_lake": "<!doctype lake><p>date: 2019-07-01 20:00:00</p><p>tags: [sentry,运维,日志]</p><p>categories: 运维</p><p>---</p><blockquote><p>这是坚持技术写作计划（含翻译）的第29篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>Sentry是一款错误日志采集、聚合框架。有Saas版，也可以本地部署。部署可以参考官网或者我之前写的 <a href=\"https://anjia0532.github.io/2019/07/07/sentry-and-matomo-install/\" target=\"_blank\">30-前端错误日志上报及网站统计(sentry+matomo)</a></p><p><br /></p><p>本文主要讲解Sentry默认禁用qq邮箱的排查思路以及如何解决。</p><p><br /></p><p>添加和自行注册qq邮箱都报无效邮箱。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561966878110-16806fe5-58ff-4d1d-8287-933328fd8819.png%22%2C%22originWidth%22%3A1418%2C%22originHeight%22%3A456%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A240%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561967139251-c939294d-9ed6-4301-8c4b-c51719989847.png%22%2C%22originWidth%22%3A633%2C%22originHeight%22%3A382%2C%22name%22%3A%22image.png%22%2C%22size%22%3A27110%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A633%2C%22height%22%3A382%7D\"></card></p><p><br /></p><p>但是QQ邮箱，<span>烂归烂，</span>在国内存量还是挺大的。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"DyCB3\">排查思路</h2><p>F12大法，看到错误信息是从服务端返回的。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561967659211-59f1fb29-96aa-4625-bead-5d07788aa142.png%22%2C%22originWidth%22%3A1144%2C%22originHeight%22%3A525%2C%22name%22%3A%22image.png%22%2C%22size%22%3A76127%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1144%2C%22height%22%3A525%7D\"></card></p><p><br /></p><p>拿到 错误提示 <code>Enter a valid email address.</code> 去github搜，</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561968321654-bdbf1381-1e9c-43aa-b7f8-0c612ce52933.png%22%2C%22originWidth%22%3A822%2C%22originHeight%22%3A806%2C%22name%22%3A%22image.png%22%2C%22size%22%3A89255%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A822%2C%22height%22%3A806%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561968360680-7a687c4f-93d4-4ea6-97c9-ecad24a46ed8.png%22%2C%22originWidth%22%3A426%2C%22originHeight%22%3A159%2C%22name%22%3A%22image.png%22%2C%22size%22%3A16407%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A426%2C%22height%22%3A159%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561968410999-fdcfeef4-7f04-461e-b3a6-a697a83ae7e2.png%22%2C%22originWidth%22%3A596%2C%22originHeight%22%3A109%2C%22name%22%3A%22image.png%22%2C%22size%22%3A8716%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A596%2C%22height%22%3A109%7D\"></card></p><p>拿到 <code>INVALID_EMAIL_ADDRESS_PATTERN</code> 再次搜索</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561968483952-2f2b929e-e20a-4cff-999c-8a8f877f1f5a.png%22%2C%22originWidth%22%3A1080%2C%22originHeight%22%3A514%2C%22name%22%3A%22image.png%22%2C%22size%22%3A60182%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1080%2C%22height%22%3A514%7D\"></card></p><p>居然是硬编码到代码里的。发现有两个相关的issues.</p><p><br /></p><p>通过 <a href=\"https://github.com/getsentry/sentry/issues/13541\" target=\"_blank\">getsentry/sentry How to custom INVALID_EMAIL_ADDRESS_PATTERN? #13541</a> 了解到，官方发现，qq.com 是有很多滥用行为，所以直接硬编码拉黑 [捂脸] .</p><p><br /></p><h2 id=\"0Izxl\">解决</h2><p>解决的办法也简单，如果是本地运行的，修改 <code>/usr/local/lib/python2.7/site-packages/sentry/conf/server.py</code> ,如果是sass版的，换个邮箱。</p><p><br /></p><p>注意，如果是 docker 运行的， <code>docker exec -it sentry /bin/sh</code>  -&gt; <code>sed -i &quot;s/qq/xx/g&quot; /usr/local/lib/python2.7/site-packages/sentry/conf/server.py</code> ,重新拉取镜像时，又会变回 <code>qq.com</code> </p><p><br /></p><p>可以 将  <code>/usr/local/lib/python2.7/site-packages/sentry/conf/server.py</code>  挂载到宿主机 <code>docker run -v /opt/sentry/server.py:/usr/local/lib/python2.7/site-packages/sentry/conf/server.py ....</code> </p><p><br /></p><h2 id=\"oz04Q\">参考资料</h2><ul><li><a href=\"https://anjia0532.github.io/2019/07/07/sentry-and-matomo-install/\" target=\"_blank\">我的个人博客<cursor /></a></li><li><a href=\"https://juejin.im/post/5d22029b6fb9a07ecd3d7f25\" target=\"_blank\">我的掘金</a></li><li><a href=\"https://github.com/getsentry/sentry/issues/13541\" target=\"_blank\">getsentry/sentry How to custom INVALID_EMAIL_ADDRESS_PATTERN? #13541</a></li></ul>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-07-07T14:33:48.000Z",
    "deleted_at": null,
    "created_at": "2019-07-01T07:36:22.000Z",
    "updated_at": "2019-07-08T03:59:37.000Z",
    "published_at": "2019-07-08T03:59:36.000Z",
    "first_published_at": "2019-07-01T08:45:19.000Z",
    "word_count": 417,
    "cover": "",
    "description": "date: 2019-07-01 20:00:00tags: [sentry,运维,日志]categories: 运维---这是坚持技术写作计划（含翻译）的第29篇，定个小目标999，每周最少2篇。Sentry是一款错误日志采集、聚合框架。有Saas版，也可以本地部署。部署可以参考官网或者我之...",
    "custom_description": "Sentry是一款错误日志采集、聚合框架。有Saas版，也可以本地部署。部署可以参考官网或者我之前写的 28-Sentry搭建并配置本文主要讲解Sentry默认禁用qq邮箱的排查思路以及如何解决。添加和自行注册qq邮箱都报无效邮箱。但是QQ邮箱，烂归烂，在国内存量还是挺大的。&lt;!-- m...",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1938165,
    "slug": "failed-to-install-oozie-share-lib",
    "title": "028-解决cdh6.2 报 Failed to install Oozie ShareLib",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-06-12 12:30:53<br />tags: [CDH,hadoop,oozie]<br />categories: 大数据<br />---\n\n> 这是坚持技术写作计划（含翻译）的第28篇，定个小目标999，每周最少2篇。\n\n\n本文主要参考 [0590-6.1.0-C6升级过程中Oozie共享库的问题分析](https://cloud.tencent.com/developer/article/1419295) ，这个问题是，cdh6.2的通病，只要安装oozie就会出现(无论是升级，还是新装)。<br />\n\n1. 纠正解决方案里的软连接问题\n\n```bash\ncd /opt/cloudera/parcels/CDH/lib/oozie/libtools\nln -s ../../../jars/logredactor-2.0.7.jar logredactor-2.0.7.jar \n```\n\n2. 此方案需要在部署oozie的主机上执行(我一开始执行错节点了)，执行完后重启oozie。\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-06-12 12:30:53</p><p>tags: [CDH,hadoop,oozie]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第28篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p><span style=\"background-color: transparent;\">本文主要参考 </span><a href=\"https://cloud.tencent.com/developer/article/1419295\" target=\"_blank\">0590-6.1.0-C6升级过程中Oozie共享库的问题分析</a><span style=\"background-color: transparent;\"> ，这个问题是，cdh6.2的通病，只要安装oozie就会出现(无论是升级，还是新装)。</span><br /></p><p><br /></p><ol start=\"1\"><li>纠正解决方案里的软连接问题</li></ol><p><br /></p><pre data-lang=\"bash\"><code>cd /opt/cloudera/parcels/CDH/lib/oozie/libtools\nln -s ../../../jars/logredactor-2.0.7.jar logredactor-2.0.7.jar </code></pre><p><br /></p><ol start=\"2\"><li>此方案需要在部署oozie的主机上执行(我一开始执行错节点了)，执行完后重启oozie。</li></ol>",
    "body_lake": "<!doctype lake><p>date: 2019-06-12 12:30:53</p><p>tags: [CDH,hadoop,oozie]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第28篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p><span style=\"background-color: transparent;\">本文主要参考 </span><a href=\"https://cloud.tencent.com/developer/article/1419295\" target=\"_blank\">0590-6.1.0-C6升级过程中Oozie共享库的问题分析</a><span style=\"background-color: transparent;\"> ，这个问题是，cdh6.2的通病，只要安装oozie就会出现(无论是升级，还是新装)。</span><br /></p><p><br /></p><ol start=\"1\"><li>纠正解决方案里的软连接问题</li></ol><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22cd%20%2Fopt%2Fcloudera%2Fparcels%2FCDH%2Flib%2Foozie%2Flibtools%5Cnln%20-s%20..%2F..%2F..%2Fjars%2Flogredactor-2.0.7.jar%20logredactor-2.0.7.jar%20%22%2C%22id%22%3A%22pTJwv%22%7D\"></card><p><br /></p><ol start=\"2\"><li>此方案需要在部署oozie的主机上执行(我一开始执行错节点了)，执行完后重启oozie。<cursor /></li></ol>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-06-20T10:19:45.000Z",
    "deleted_at": null,
    "created_at": "2019-06-19T06:57:39.000Z",
    "updated_at": "2019-06-20T10:19:45.000Z",
    "published_at": "2019-06-20T10:19:45.000Z",
    "first_published_at": "2019-06-20T10:19:45.000Z",
    "word_count": 163,
    "cover": "",
    "description": "date: 2019-06-12 12:30:53tags: [CDH,hadoop,oozie]categories: 大数据---这是坚持技术写作计划（含翻译）的第28篇，定个小目标999，每周最少2篇。本文主要参考 0590-6.1.0-C6升级过程中Oozie共享库的问题分析 ，这个问...",
    "custom_description": "解决cdh6.2 报 Failed to install Oozie ShareLib",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1935315,
    "slug": "hdfs-datanode-start-failed",
    "title": "027-解决cdh6.2中datanode无法启动问题",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-06-10 21:00:01<br />tags: [CDH,hadoop,大数据,hdfs,datanode]<br />categories: 大数据<br />---\n\n> 这是坚持技术写作计划（含翻译）的第27篇，定个小目标999，每周最少2篇。\n\n\n今天安装cdh时遇到hdfs启动失败问题，解决起来倒是不麻烦，简单记录下。\n\n<!-- more -->\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560907215000-3fe2af8a-139e-4fc6-ae67-1abb7d5e19e7.png#align=left&display=inline&height=767&name=image.png&originHeight=767&originWidth=1596&size=260810&status=done&width=1596)<br />关键信息 `java.io.IOException: Incompatible clusterIDs in /dfs/dn: namenode clusterID = cluster74; datanode clusterID = cluster14` <br />关键信息，namenode的 clusterID和datanode的不一致。\n\n原因：执行hdfs namenode -format后，current目录会删除并重新生成，其中VERSION文件中的clusterID也会随之变化，而datanode的VERSION文件中的clusterID保持不变，造成两个clusterID不一致。\n\n方案：\n\n1. 如果是新建的集群，则直接主机目录 `/dfs/dn` （cdh->hdfs->配置-> `dfs.datanode.data.dir` ）下的current目录下的文件删除 `rm -rf /dfs/dn/current/*` \n1. 如果集群内有数据，则只改 /dfs/dn/current/VERSION 中的 `clusterID=clusterXX`  XX为正确的namenode的clusterID\n\n重启datanode即可\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-06-10 21:00:01</p><p>tags: [CDH,hadoop,大数据,hdfs,datanode]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第27篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>今天安装cdh时遇到hdfs启动失败问题，解决起来倒是不麻烦，简单记录下。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560907215000-3fe2af8a-139e-4fc6-ae67-1abb7d5e19e7.png#align=left&amp;display=inline&amp;height=767&amp;name=image.png&amp;originHeight=767&amp;originWidth=1596&amp;size=260810&amp;status=done&amp;width=1596\" style=\"max-width: 600px; width: 1596px;\" /></p><p>关键信息 <code>java.io.IOException: Incompatible clusterIDs in /dfs/dn: namenode clusterID = cluster74; datanode clusterID = cluster14</code> </p><p>关键信息，namenode的 clusterID和datanode的不一致。</p><p><br /></p><p>原因：执行hdfs namenode -format后，current目录会删除并重新生成，其中VERSION文件中的clusterID也会随之变化，而datanode的VERSION文件中的clusterID保持不变，造成两个clusterID不一致。</p><p><br /></p><p>方案：</p><ol start=\"1\"><li>如果是新建的集群，则直接主机目录 <code>/dfs/dn</code> （cdh-&gt;hdfs-&gt;配置-&gt; <code>dfs.datanode.data.dir</code> ）下的current目录下的文件删除 <code>rm -rf /dfs/dn/current/*</code> </li><li>如果集群内有数据，则只改 <span style=\"background-color: \"rgba(0, 0, 0, 0.06)\";\">/dfs/dn/current/VERSION</span> 中的 <code>clusterID=clusterXX</code>  XX为正确的namenode的clusterID</li></ol><p><br /></p><p>重启datanode即可</p>",
    "body_lake": "<!doctype lake><p>date: 2019-06-10 21:00:01</p><p>tags: [CDH,hadoop,大数据,hdfs,datanode]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第27篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>今天安装cdh时遇到hdfs启动失败问题，解决起来倒是不麻烦，简单记录下。<cursor /></p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560907215000-3fe2af8a-139e-4fc6-ae67-1abb7d5e19e7.png%22%2C%22originWidth%22%3A1596%2C%22originHeight%22%3A767%2C%22name%22%3A%22image.png%22%2C%22size%22%3A260810%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1596%2C%22height%22%3A767%7D\"></card></p><p>关键信息 <code>java.io.IOException: Incompatible clusterIDs in /dfs/dn: namenode clusterID = cluster74; datanode clusterID = cluster14</code> </p><p>关键信息，namenode的 clusterID和datanode的不一致。</p><p><br /></p><p>原因：执行hdfs namenode -format后，current目录会删除并重新生成，其中VERSION文件中的clusterID也会随之变化，而datanode的VERSION文件中的clusterID保持不变，造成两个clusterID不一致。</p><p><br /></p><p>方案：</p><ol start=\"1\"><li>如果是新建的集群，则直接主机目录 <code>/dfs/dn</code> （cdh-&gt;hdfs-&gt;配置-&gt; <code>dfs.datanode.data.dir</code> ）下的current目录下的文件删除 <code>rm -rf /dfs/dn/current/*</code> </li><li>如果集群内有数据，则只改 <span style=\"background-color: rgba(0, 0, 0, 0.06);\">/dfs/dn/current/VERSION</span> 中的 <code>clusterID=clusterXX</code>  XX为正确的namenode的clusterID</li></ol><p><br /></p><p>重启datanode即可</p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-06-20T10:24:01.000Z",
    "deleted_at": null,
    "created_at": "2019-06-19T01:15:38.000Z",
    "updated_at": "2019-06-20T10:24:01.000Z",
    "published_at": "2019-06-20T10:24:01.000Z",
    "first_published_at": "2019-06-20T10:24:01.000Z",
    "word_count": 244,
    "cover": "",
    "description": "date: 2019-06-10 21:00:01tags: [CDH,hadoop,大数据,hdfs,datanode]categories: 大数据---这是坚持技术写作计划（含翻译）的第27篇，定个小目标999，每周最少2篇。今天安装cdh时遇到hdfs启动失败问题，解决起来倒是不麻烦，...",
    "custom_description": "解决cdh6.2中datanode无法启动问题",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1891768,
    "slug": "kettle-speed-on",
    "title": "026-Kettle表输入表输出提升50倍的秘诀",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-06-12 12:30:53<br />tags: [Kettle,ETL,PDI,pentaho]<br />categories: 大数据<br />---\n\n> 这是坚持技术写作计划（含翻译）的第26篇，定个小目标999，每周最少2篇。\n\n\n最近工作需要，需要从Oracle导数据到Mysql，并且需要进行适当的清洗，转换。<br />数据量在5亿条左右，硬件环境为Winserver 2008R2 64位 ，64G，48核，1T hdd，kettle是8.2，从Oracle（11G,linux服务器，局域网连接）抽到mysql(5.7,本机，win server)。<br />优化前的速度是读1000r/s(Oracle)左右，写1000r/s左右。<br />优化后的速度是读8Wr/s(Oracle)左右，写4Wr/s左右。<br />因为表的字段大小和类型以及是否有索引都有关系，所以总体来说，提升了20-50倍左右。\n\n<!-- more -->\n\n<a name=\"HII81\"></a>\n## mysql 优化\nmysql此处只是为了迁移数据用，实际上用csv，或者clickhouse也行。但是担心csv在处理日期时可能有问题，而clickhouse不能在win下跑，而条件所限，没有多余的linux资源，而mysql第三方开源框架(不管是导入hdfs)，还是作为clickhouse的外表，还是数据展示(supserset,metabase等)，还是迁移到tidb，都很方便。所以最终决定用mysql。\n\n> Note:此处的mysql只做临时数据迁移用，所以可以随便重启跟修改mysqld参数。如果是跟业务混用时，需要咨询dba，确保不会影响其他业务。\n\n\n<a name=\"kYnwx\"></a>\n### mysql 安装及配置优化\n\n- 从 [https://dev.mysql.com/downloads/mysql/5.7.html#downloads](https://dev.mysql.com/downloads/mysql/5.7.html#downloads) 下载64位 zip mysql\n- 解压 mysql-5.7.26-winx64.zip 到目录，比如 D:\\mysql-5.7.26-winx64\n- 创建D:\\mysql-5.7.26-winx64\\my.ini\n```\n[mysqld]\nport=3306\nbasedir=D:\\mysql-5.7.26-winx64\\\ndatadir=D:\\mysql-5.7.26-winx64\\data\nnet_buffer_length=5242880\nmax_allowed_packet=104857600\nbulk_insert_buffer_size=104857600\nmax_connections = 1000\ninnodb_flush_log_at_trx_commit = 2\n# 本场景下测试MyISAM比InnoDB 提升1倍左右\ndefault-storage-engine=MyISAM\ngeneral_log = 1\ngeneral_log_file=D:\\mysql-5.7.26-winx64\\logs\\mysql.log\ninnodb_buffer_pool_size = 36G\ninnodb_log_files_in_group=2\ninnodb_log_file_size = 500M\ninnodb_log_buffer_size = 50M\nsync_binlog=1\ninnodb_lock_wait_timeout = 50\ninnodb_thread_concurrency = 16\nkey_buffer_size=82M\nread_buffer_size=64K\nread_rnd_buffer_size=256K\nsort_buffer_size=256K\nmyisam_max_sort_file_size=100G\nmyisam_sort_buffer_size=100M\ntransaction_isolation=READ-COMMITTED\n```\n\n- 参考 [2.3.5 Installing MySQL on Microsoft Windows Using a noinstall ZIP Archive](https://dev.mysql.com/doc/refman/5.7/en/windows-install-archive.html) 进行安装\n- 启动mysql服务\n\n<a name=\"NrnAs\"></a>\n## Kettle优化\n\n<a name=\"p9t6p\"></a>\n### 启动参数优化\n本机内存较大，为了防止OOM，所以调大内存参数，创建环境变量 `PENTAHO_DI_JAVA_OPTIONS` = `-Xms20480m -Xmx30720m -XX:MaxPermSize=1024m` 起始20G，最大30G\n\n<a name=\"LDDFl\"></a>\n### 表输入和表输出开启多线程\n表输入如果开启多线程的话，会导致数据重复。比如 `select * from test` ,起3个线程，就会查3遍，最后的数据就是3份。肯定不行，没达到优化的目的。<br />因为source是oracle，利用oracle的特性： `rownum` 和函数： `mod` ,以及kettle的参数: `Internal.Step.Unique.Count,Internal.Step.Unique.Number` \n```sql\nselect * from (SELECT test.*,rownum rn FROM test ) where mod(rn,${Internal.Step.Unique.Count}) = ${Internal.Step.Unique.Number}\n```\n解释一下\n\n- rownum 是oracle系统顺序分配为从查询返回的行的编号,返回的第一行分配的是1,第二行是2，意味着，如果排序字段或者数据有变化的话，rownum也会变（也就是跟物理数据没有对应关系,如果要对应关系的话，应该用rowid,但是rowid不是数字，而是类似 AAAR3sAAEAAAACXAAA  的编码），所以需要对rownum进行固化，所以将 `SELECT test.*,rownum rn FROM test` 作为子查询\n- mod 是oracle的取模运算函数，比如， `mod(5,3)`  意即 `5%3=2` ，就是 `5/3=1...2` 中的2,也就是如果能获取到总线程数，以及当前线程数，取模，就可以对结果集进行拆分了。 `mod(行号,总线程数)=当前线程序号` \n- kettle 内置函数 `${Internal.Step.Unique.Count}` 和 `${Internal.Step.Unique.Number}` 分别代表线程总数和当前线程序号\n\n而表输出就无所谓了，开多少线程，kettle都会求总数然后平摊的。\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560314746879-dda9ca2b-4796-4a40-bef3-445afc7bfa39.png#align=left&display=inline&height=200&name=image.png&originHeight=200&originWidth=383&size=15147&status=done&width=383)<br />右键选择表输入或者表输出，选择 `改变开始复制的数量...` 注意，不是一味的调大就一定能提升效率，要进行测试的。<br />表输入时，注意勾选替换变量<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560314826857-199c854f-e240-4094-b112-c0b0c9a8bc8a.png#align=left&display=inline&height=261&name=image.png&originHeight=261&originWidth=744&size=12391&status=done&width=744)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560314887846-35838541-cab9-484c-859a-968d3566241c.png#align=left&display=inline&height=732&name=image.png&originHeight=732&originWidth=505&size=28983&status=done&width=505)\n\n- 修改提交数量(默认100，但是不是越大越好)\n- 去掉裁剪表，因为是多线程，你肯定不希望，A线程刚插入的，B给删掉。\n- 必须要指定数据库字段，因为表输入的时候，会多一个行号字段。会导致插入失败。当然如果你在创建表时，多加了行号字段，当做自增id的话，那就不需要这一步了。\n- 开启批量插入\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560315449676-93873a23-b85d-4446-98be-589792105ec1.png#align=left&display=inline&height=538&name=image.png&originHeight=538&originWidth=529&size=33262&status=done&width=529)\n\n> Note: 通过开启多线程，速度能提升5倍以上。\n\n\n<a name=\"UL8Sb\"></a>\n### 开启线程池及优化jdbc参数\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560315569302-4a129a71-4921-4c32-96c8-80a423811f46.png#align=left&display=inline&height=338&name=image.png&originHeight=338&originWidth=440&size=17388&status=done&width=440)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560315593202-4f39a1a4-6340-4dc1-8915-70428c1c1a34.png#align=left&display=inline&height=408&name=image.png&originHeight=408&originWidth=1005&size=19781&status=done&width=1005)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560315610579-7ce37a68-6bc9-4041-b67d-a3d5c6162291.png#align=left&display=inline&height=253&name=image.png&originHeight=253&originWidth=1015&size=14437&status=done&width=1015)\n\n<a name=\"01roX\"></a>\n## 运行观察结果\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560315664223-5d94f858-ef86-42a3-ae31-86b83d189490.png#align=left&display=inline&height=399&name=image.png&originHeight=399&originWidth=708&size=34982&status=done&width=708)<br />注意调整不同的参数(线程数，提交数),观察速度。\n\n<a name=\"Dgs07\"></a>\n## 其余提升空间\n\n1. 换ssd\n1. 继续优化mysql参数\n1. 换引擎，比如，tokudb\n1. 换抽取工具，比如streamsets,datax\n1. 换数据库，比如 clickhouse,tidb,Cassandra\n1. kettle集群\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。<br />长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-06-12 12:30:53</p><p>tags: [Kettle,ETL,PDI,pentaho]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第26篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>最近工作需要，需要从Oracle导数据到Mysql，并且需要进行适当的清洗，转换。</p><p>数据量在5亿条左右，硬件环境为Winserver 2008R2 64位 ，64G，48核，1T hdd，<span>kettle是8.2，</span>从Oracle（11G,linux服务器，局域网连接）抽到mysql(5.7,本机，win server)。</p><p>优化前的速度是读1000r/s(Oracle)左右，写1000r/s左右。</p><p>优化后的速度是读8Wr/s(Oracle)左右，写4Wr/s左右。</p><p>因为表的字段大小和类型以及是否有索引都有关系，所以总体来说，提升了20-50倍左右。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"HII81\">mysql 优化</h2><p>mysql此处只是为了迁移数据用，实际上用csv，或者clickhouse也行。但是担心csv在处理日期时可能有问题，而clickhouse不能在win下跑，而条件所限，没有多余的linux资源，而mysql第三方开源框架(不管是导入hdfs)，还是作为clickhouse的外表，还是数据展示(supserset,metabase等)，还是迁移到tidb，都很方便。所以最终决定用mysql。</p><p><br /></p><blockquote><p>Note:此处的mysql只做临时数据迁移用，所以可以随便重启跟修改mysqld参数。如果是跟业务混用时，需要咨询dba，确保不会影响其他业务。</p></blockquote><p><br /></p><h3 id=\"kYnwx\">mysql 安装及配置优化</h3><p><br /></p><ul><li>从 <a href=\"https://dev.mysql.com/downloads/mysql/5.7.html#downloads\" target=\"_blank\">https://dev.mysql.com/downloads/mysql/5.7.html#downloads</a> 下载64位 zip mysql</li><li>解压 mysql-5.7.26-winx64.zip 到目录，比如 D:\\<span>mysql-5.7.26-winx64</span></li><li>创建<span>D:\\mysql-5.7.26-winx64\\my.ini</span></li></ul><pre><code>[mysqld]\nport=3306\nbasedir=D:\\mysql-5.7.26-winx64\\\ndatadir=D:\\mysql-5.7.26-winx64\\data\nnet_buffer_length=5242880\nmax_allowed_packet=104857600\nbulk_insert_buffer_size=104857600\nmax_connections = 1000\ninnodb_flush_log_at_trx_commit = 2\n# 本场景下测试MyISAM比InnoDB 提升1倍左右\ndefault-storage-engine=MyISAM\ngeneral_log = 1\ngeneral_log_file=D:\\mysql-5.7.26-winx64\\logs\\mysql.log\ninnodb_buffer_pool_size = 36G\ninnodb_log_files_in_group=2\ninnodb_log_file_size = 500M\ninnodb_log_buffer_size = 50M\nsync_binlog=1\ninnodb_lock_wait_timeout = 50\ninnodb_thread_concurrency = 16\nkey_buffer_size=82M\nread_buffer_size=64K\nread_rnd_buffer_size=256K\nsort_buffer_size=256K\nmyisam_max_sort_file_size=100G\nmyisam_sort_buffer_size=100M\ntransaction_isolation=READ-COMMITTED</code></pre><ul><li>参考 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/windows-install-archive.html\" target=\"_blank\">2.3.5 Installing MySQL on Microsoft Windows Using a noinstall ZIP Archive</a> 进行安装</li><li>启动mysql服务</li></ul><p><br /></p><h2 id=\"NrnAs\">Kettle优化</h2><p><br /></p><h3 id=\"p9t6p\">启动参数优化</h3><p>本机内存较大，为了防止OOM，所以调大内存参数，创建环境变量 <code>PENTAHO_DI_JAVA_OPTIONS</code> = <code>-Xms20480m -Xmx30720m -XX:MaxPermSize=1024m</code> 起始20G，最大30G</p><p><br /></p><h3 id=\"LDDFl\">表输入和表输出开启多线程</h3><p>表输入如果开启多线程的话，会导致数据重复。比如 <code>select * from test</code> ,起3个线程，就会查3遍，最后的数据就是3份。肯定不行，没达到优化的目的。</p><p>因为source是oracle，利用oracle的特性： <code>rownum</code> 和函数： <code>mod</code> ,以及kettle的参数: <code>Internal.Step.Unique.Count,Internal.Step.Unique.Number</code> </p><pre data-lang=\"sql\"><code>select * from (SELECT test.*,rownum rn FROM test ) where mod(rn,${Internal.Step.Unique.Count}) = ${Internal.Step.Unique.Number}</code></pre><p>解释一下</p><ul><li>rownum 是oracle系统顺序分配为从查询返回的行的编号,返回的第一行分配的是1,第二行是2，意味着，如果排序字段或者数据有变化的话，rownum也会变（也就是跟物理数据没有对应关系,如果要对应关系的话，应该用rowid,但是rowid不是数字，而是类似 <span style=\"color: #454545;\">AAAR3sAAEAAAAC</span><span style=\"color: #454545;\">XAAA  的编码</span>），所以需要对rownum进行固化，所以将 <code>SELECT test.*,rownum rn FROM test</code> 作为子查询</li><li>mod 是oracle的取模运算函数，比如， <code>mod(5,3)</code>  意即 <code>5%3=2</code> ，就是 <code>5/3=1...2</code> 中的2,也就是如果能获取到总线程数，以及当前线程数，取模，就可以对结果集进行拆分了。 <code>mod(行号,总线程数)=当前线程序号</code> </li><li><span style=\"background-color: transparent;\">kettle 内置函数 </span><code><span style=\"background-color: transparent;\">${Internal.Step.Unique.Count}</span></code> 和 <code>${Internal.Step.Unique.Number}</code> 分别代表线程总数和当前线程序号</li></ul><p><br /></p><p>而表输出就无所谓了，开多少线程，kettle都会求总数然后平摊的。</p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560314746879-dda9ca2b-4796-4a40-bef3-445afc7bfa39.png#align=left&amp;display=inline&amp;height=200&amp;name=image.png&amp;originHeight=200&amp;originWidth=383&amp;size=15147&amp;status=done&amp;width=383\" style=\"max-width: 600px; width: 383px;\" /></p><p>右键选择表输入或者表输出，选择 <code>改变开始复制的数量...</code> 注意，不是一味的调大就一定能提升效率，要进行测试的。</p><p>表输入时，注意勾选替换变量</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560314826857-199c854f-e240-4094-b112-c0b0c9a8bc8a.png#align=left&amp;display=inline&amp;height=261&amp;name=image.png&amp;originHeight=261&amp;originWidth=744&amp;size=12391&amp;status=done&amp;width=744\" style=\"max-width: 600px; width: 744px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560314887846-35838541-cab9-484c-859a-968d3566241c.png#align=left&amp;display=inline&amp;height=732&amp;name=image.png&amp;originHeight=732&amp;originWidth=505&amp;size=28983&amp;status=done&amp;width=505\" style=\"max-width: 600px; width: 505px;\" /></p><ul><li>修改提交数量(默认100，但是不是越大越好)</li><li>去掉裁剪表，因为是多线程，你肯定不希望，A线程刚插入的，B给删掉。</li><li>必须要指定数据库字段，因为表输入的时候，会多一个行号字段。会导致插入失败。当然如果你在创建表时，多加了行号字段，当做自增id的话，那就不需要这一步了。</li><li>开启批量插入</li></ul><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560315449676-93873a23-b85d-4446-98be-589792105ec1.png#align=left&amp;display=inline&amp;height=538&amp;name=image.png&amp;originHeight=538&amp;originWidth=529&amp;size=33262&amp;status=done&amp;width=529\" style=\"max-width: 600px; width: 529px;\" /></p><p><br /></p><blockquote><p>Note: 通过开启多线程，速度能提升5倍以上。</p></blockquote><p><br /></p><h3 id=\"UL8Sb\">开启线程池及优化jdbc参数</h3><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560315569302-4a129a71-4921-4c32-96c8-80a423811f46.png#align=left&amp;display=inline&amp;height=338&amp;name=image.png&amp;originHeight=338&amp;originWidth=440&amp;size=17388&amp;status=done&amp;width=440\" style=\"max-width: 600px; width: 440px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560315593202-4f39a1a4-6340-4dc1-8915-70428c1c1a34.png#align=left&amp;display=inline&amp;height=408&amp;name=image.png&amp;originHeight=408&amp;originWidth=1005&amp;size=19781&amp;status=done&amp;width=1005\" style=\"max-width: 600px; width: 1005px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560315610579-7ce37a68-6bc9-4041-b67d-a3d5c6162291.png#align=left&amp;display=inline&amp;height=253&amp;name=image.png&amp;originHeight=253&amp;originWidth=1015&amp;size=14437&amp;status=done&amp;width=1015\" style=\"max-width: 600px; width: 1015px;\" /></p><p><br /></p><h2 id=\"01roX\">运行观察结果</h2><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560315664223-5d94f858-ef86-42a3-ae31-86b83d189490.png#align=left&amp;display=inline&amp;height=399&amp;name=image.png&amp;originHeight=399&amp;originWidth=708&amp;size=34982&amp;status=done&amp;width=708\" style=\"max-width: 600px; width: 708px;\" /></p><p>注意调整不同的参数(线程数，提交数),观察速度。</p><p><br /></p><h2 id=\"Dgs07\">其余提升空间</h2><ol start=\"1\"><li>换ssd</li><li>继续优化mysql参数</li><li>换引擎，比如，tokudb</li><li>换抽取工具，比如streamsets,datax</li><li>换数据库，比如 clickhouse,tidb,Cassandra</li><li>kettle集群</li></ol><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p>",
    "body_lake": "<!doctype lake><p>date: 2019-06-12 12:30:53</p><p>tags: [Kettle,ETL,PDI,pentaho]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第26篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>最近工作需要，需要从Oracle导数据到Mysql，并且需要进行适当的清洗，转换。</p><p>数据量在5亿条左右，硬件环境为Winserver 2008R2 64位 ，64G，48核，1T hdd，<span>kettle是8.2，</span>从Oracle（11G,linux服务器，局域网连接）抽到mysql(5.7,本机，win server)。</p><p>优化前的速度是读1000r/s(Oracle)左右，写1000r/s左右。</p><p>优化后的速度是读8Wr/s(Oracle)左右，写4Wr/s左右。</p><p>因为表的字段大小和类型以及是否有索引都有关系，所以总体来说，提升了20-50倍左右。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"HII81\">mysql 优化</h2><p>mysql此处只是为了迁移数据用，实际上用csv，或者clickhouse也行。但是担心csv在处理日期时可能有问题，而clickhouse不能在win下跑，而条件所限，没有多余的linux资源，而mysql第三方开源框架(不管是导入hdfs)，还是作为clickhouse的外表，还是数据展示(supserset,metabase等)，还是迁移到tidb，都很方便。所以最终决定用mysql。</p><p><br /></p><blockquote><p>Note:此处的mysql只做临时数据迁移用，所以可以随便重启跟修改mysqld参数。如果是跟业务混用时，需要咨询dba，确保不会影响其他业务。</p></blockquote><p><br /></p><h3 id=\"kYnwx\">mysql 安装及配置优化</h3><p><br /></p><ul><li>从 <a href=\"https://dev.mysql.com/downloads/mysql/5.7.html#downloads\" target=\"_blank\">https://dev.mysql.com/downloads/mysql/5.7.html#downloads</a> 下载64位 zip mysql</li><li>解压 mysql-5.7.26-winx64.zip 到目录，比如 D:\\<span>mysql-5.7.26-winx64</span></li><li>创建<span>D:\\mysql-5.7.26-winx64\\my.ini</span></li></ul><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22plain%22%2C%22code%22%3A%22%5Bmysqld%5D%5Cnport%3D3306%5Cnbasedir%3DD%3A%5C%5Cmysql-5.7.26-winx64%5C%5C%5Cndatadir%3DD%3A%5C%5Cmysql-5.7.26-winx64%5C%5Cdata%5Cnnet_buffer_length%3D5242880%5Cnmax_allowed_packet%3D104857600%5Cnbulk_insert_buffer_size%3D104857600%5Cnmax_connections%20%3D%201000%5Cninnodb_flush_log_at_trx_commit%20%3D%202%5Cn%23%20%E6%9C%AC%E5%9C%BA%E6%99%AF%E4%B8%8B%E6%B5%8B%E8%AF%95MyISAM%E6%AF%94InnoDB%20%E6%8F%90%E5%8D%871%E5%80%8D%E5%B7%A6%E5%8F%B3%5Cndefault-storage-engine%3DMyISAM%5Cngeneral_log%20%3D%201%5Cngeneral_log_file%3DD%3A%5C%5Cmysql-5.7.26-winx64%5C%5Clogs%5C%5Cmysql.log%5Cninnodb_buffer_pool_size%20%3D%2036G%5Cninnodb_log_files_in_group%3D2%5Cninnodb_log_file_size%20%3D%20500M%5Cninnodb_log_buffer_size%20%3D%2050M%5Cnsync_binlog%3D1%5Cninnodb_lock_wait_timeout%20%3D%2050%5Cninnodb_thread_concurrency%20%3D%2016%5Cnkey_buffer_size%3D82M%5Cnread_buffer_size%3D64K%5Cnread_rnd_buffer_size%3D256K%5Cnsort_buffer_size%3D256K%5Cnmyisam_max_sort_file_size%3D100G%5Cnmyisam_sort_buffer_size%3D100M%5Cntransaction_isolation%3DREAD-COMMITTED%22%2C%22id%22%3A%22B5Do6%22%7D\"></card><ul><li>参考 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/windows-install-archive.html\" target=\"_blank\">2.3.5 Installing MySQL on Microsoft Windows Using a noinstall ZIP Archive</a> 进行安装</li><li>启动mysql服务</li></ul><p><br /></p><h2 id=\"NrnAs\">Kettle优化</h2><p><br /></p><h3 id=\"p9t6p\">启动参数优化</h3><p>本机内存较大，为了防止OOM，所以调大内存参数，创建环境变量 <code>PENTAHO_DI_JAVA_OPTIONS</code> = <code>-Xms20480m -Xmx30720m -XX:MaxPermSize=1024m</code> 起始20G，最大30G</p><p><br /></p><h3 id=\"LDDFl\">表输入和表输出开启多线程</h3><p>表输入如果开启多线程的话，会导致数据重复。比如 <code>select * from test</code> ,起3个线程，就会查3遍，最后的数据就是3份。肯定不行，没达到优化的目的。</p><p>因为source是oracle，利用oracle的特性： <code>rownum</code> 和函数： <code>mod</code> ,以及kettle的参数: <code>Internal.Step.Unique.Count,Internal.Step.Unique.Number</code> </p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22sql%22%2C%22code%22%3A%22select%20*%20from%20(SELECT%20test.*%2Crownum%20rn%20FROM%20test%20)%20where%20mod(rn%2C%24%7BInternal.Step.Unique.Count%7D)%20%3D%20%24%7BInternal.Step.Unique.Number%7D%22%2C%22id%22%3A%226TSFt%22%7D\"></card><p>解释一下</p><ul><li>rownum 是oracle系统顺序分配为从查询返回的行的编号,返回的第一行分配的是1,第二行是2，意味着，如果排序字段或者数据有变化的话，rownum也会变（也就是跟物理数据没有对应关系,如果要对应关系的话，应该用rowid,但是rowid不是数字，而是类似 <span style=\"color: #454545;\">AAAR3sAAEAAAAC</span><span style=\"color: #454545;\">XAAA  的编码</span>），所以需要对rownum进行固化，所以将 <code>SELECT test.*,rownum rn FROM test</code> 作为子查询</li><li>mod 是oracle的取模运算函数，比如， <code>mod(5,3)</code>  意即 <code>5%3=2</code> ，就是 <code>5/3=1...2</code> 中的2,也就是如果能获取到总线程数，以及当前线程数，取模，就可以对结果集进行拆分了。 <code>mod(行号,总线程数)=当前线程序号</code> </li><li><span style=\"background-color: transparent;\">kettle 内置函数 </span><code><span style=\"background-color: transparent;\">${Internal.Step.Unique.Count}</span></code> 和 <code>${Internal.Step.Unique.Number}</code> 分别代表线程总数和当前线程序号</li></ul><p><br /></p><p>而表输出就无所谓了，开多少线程，kettle都会求总数然后平摊的。</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560314746879-dda9ca2b-4796-4a40-bef3-445afc7bfa39.png%22%2C%22originWidth%22%3A383%2C%22originHeight%22%3A200%2C%22name%22%3A%22image.png%22%2C%22size%22%3A15147%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A383%2C%22height%22%3A200%7D\"></card></p><p>右键选择表输入或者表输出，选择 <code>改变开始复制的数量...</code> 注意，不是一味的调大就一定能提升效率，要进行测试的。</p><p>表输入时，注意勾选替换变量</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560314826857-199c854f-e240-4094-b112-c0b0c9a8bc8a.png%22%2C%22originWidth%22%3A744%2C%22originHeight%22%3A261%2C%22name%22%3A%22image.png%22%2C%22size%22%3A12391%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A744%2C%22height%22%3A261%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560314887846-35838541-cab9-484c-859a-968d3566241c.png%22%2C%22originWidth%22%3A505%2C%22originHeight%22%3A732%2C%22name%22%3A%22image.png%22%2C%22size%22%3A28983%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A505%2C%22height%22%3A732%7D\"></card></p><ul><li>修改提交数量(默认100，但是不是越大越好)</li><li>去掉裁剪表，因为是多线程，你肯定不希望，A线程刚插入的，B给删掉。</li><li>必须要指定数据库字段，因为表输入的时候，会多一个行号字段。会导致插入失败。当然如果你在创建表时，多加了行号字段，当做自增id的话，那就不需要这一步了。</li><li>开启批量插入</li></ul><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560315449676-93873a23-b85d-4446-98be-589792105ec1.png%22%2C%22originWidth%22%3A529%2C%22originHeight%22%3A538%2C%22name%22%3A%22image.png%22%2C%22size%22%3A33262%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A529%2C%22height%22%3A538%7D\"></card></p><p><br /></p><blockquote><p>Note: 通过开启多线程，速度能提升5倍以上。</p></blockquote><p><br /></p><h3 id=\"UL8Sb\">开启线程池及优化jdbc参数</h3><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560315569302-4a129a71-4921-4c32-96c8-80a423811f46.png%22%2C%22originWidth%22%3A440%2C%22originHeight%22%3A338%2C%22name%22%3A%22image.png%22%2C%22size%22%3A17388%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A440%2C%22height%22%3A338%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560315593202-4f39a1a4-6340-4dc1-8915-70428c1c1a34.png%22%2C%22originWidth%22%3A1005%2C%22originHeight%22%3A408%2C%22name%22%3A%22image.png%22%2C%22size%22%3A19781%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1005%2C%22height%22%3A408%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560315610579-7ce37a68-6bc9-4041-b67d-a3d5c6162291.png%22%2C%22originWidth%22%3A1015%2C%22originHeight%22%3A253%2C%22name%22%3A%22image.png%22%2C%22size%22%3A14437%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1015%2C%22height%22%3A253%7D\"></card></p><p><br /></p><h2 id=\"01roX\">运行观察结果</h2><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560315664223-5d94f858-ef86-42a3-ae31-86b83d189490.png%22%2C%22originWidth%22%3A708%2C%22originHeight%22%3A399%2C%22name%22%3A%22image.png%22%2C%22size%22%3A34982%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A708%2C%22height%22%3A399%7D\"></card></p><p>注意调整不同的参数(线程数，提交数),观察速度。</p><p><br /></p><h2 id=\"Dgs07\">其余提升空间</h2><ol start=\"1\"><li>换ssd</li><li>继续优化mysql参数</li><li>换引擎，比如，tokudb</li><li>换抽取工具，比如streamsets,datax</li><li>换数据库，比如 clickhouse,tidb,Cassandra</li><li>kettle集群<cursor /></li></ol><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-06-12T05:35:39.000Z",
    "deleted_at": null,
    "created_at": "2019-06-11T10:45:32.000Z",
    "updated_at": "2019-06-12T05:35:40.000Z",
    "published_at": "2019-06-12T05:35:39.000Z",
    "first_published_at": "2019-06-12T05:04:14.000Z",
    "word_count": 1319,
    "cover": "",
    "description": "date: 2019-06-12 12:30:53tags: [Kettle,ETL,PDI,pentaho]categories: 大数据---这是坚持技术写作计划（含翻译）的第26篇，定个小目标999，每周最少2篇。最近工作需要，需要从Oracle导数据到Mysql，并且需要进行适当的清洗...",
    "custom_description": "最近工作需要，需要从Oracle导数据到Mysql，并且需要进行适当的清洗，转换。数据量在1亿条左右，硬件环境为64G，48核，1T ssd，Oracle是11G，kettle是8.2，mysql是5.7。优化前的速度是读1000r/s(Oracle)左右，写1000r/s左右。优化后的速度是...",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1884694,
    "slug": "cdh-streamsets",
    "title": "025-大数据ETL工具之StreamSets安装及订阅mysql binlog",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-06-10 21:00:01\n\ntags: [CDH,hadoop,大数据,ETL,StreamSets,SDC]<br />categories: 大数据<br />---\n> 这是坚持技术写作计划（含翻译）的第25篇，定个小目标999，每周最少2篇。\n\n\n本文主要介绍CDH6.2+StreamSets3.9。\n\nStreamSets是一个大数据采集和数据处理工具。可以通过拖拽式的可视化操作，实现数据管道(Pipelines)的设计和调度。其特点有：\n\n- 拖拽式的可视化界面操作，上手快。\n- 对常见数据处理(数据源、数据操作、数据输出)支持较好。\n- 内置监控，可以对数据流进行观测。\n\n类似的开源产品还有 [Apache NiFi](http://nifi.apache.org/) , 网上有关于NiFi和StreamSets 的对比 [Open Source ETL: Apache NiFi vs Streamsets](https://statsbot.co/blog/open-source-etl/) (网上有中文翻译版版)\n\n国内接触较多的ETL工具，可能是 [DataX](https://github.com/alibaba/DataX) 、 [Kettle](https://kettle.pentaho.com) 、[Sqoop](http://sqoop.apache.org/)。此处有个简单的对比，[数据集成之 kettle、sqoop、datax、streamSets 比较 ](https://my.oschina.net/peakfang/blog/2056426)\n\n\n<a name=\"t85Ls\"></a>\n## 安装StreamSets 3.9\n<a name=\"sMTmJ\"></a>\n### 下载parcel安装包\n\n从 [https://archives.streamsets.com/index.html](https://archives.streamsets.com/index.html) 下载3.9的<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560930235577-b347118a-9af6-4e1e-b3c8-d76d7d388e95.png#align=left&display=inline&height=681&name=image.png&originHeight=681&originWidth=549&size=51810&status=done&width=549)<br />并上传到http服务器的www目录下，本文以centos7.6为例\n\n```bash\nwget -P /var/www/html/streamsets3.9.0/ https://archives.streamsets.com/datacollector/3.9.0/parcel/manifest.json\nwget -P /var/www/html/streamsets3.9.0/ https://archives.streamsets.com/datacollector/3.9.0/parcel/STREAMSETS_DATACOLLECTOR-3.9.0-el7.parcel.sha\nwget -P /var/www/html/streamsets3.9.0/ https://archives.streamsets.com/datacollector/3.9.0/parcel/STREAMSETS_DATACOLLECTOR-3.9.0-el7.parcel\n```\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560930516379-4f6922d6-76ed-44cd-b5c7-1b8579743cdf.png#align=left&display=inline&height=269&name=image.png&originHeight=269&originWidth=553&size=25017&status=done&width=553)\n\n<a name=\"QEaW1\"></a>\n### 配置csd\n从 [https://streamsets.com/opensource](https://streamsets.com/opensource) 下载<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560930592344-14e9b2ee-6153-4c2b-8e6e-eafa305b11ca.png#align=left&display=inline&height=628&name=image.png&originHeight=628&originWidth=520&size=49861&status=done&width=520)\n\n```bash\nwget -P /opt/cloudera/csd/ https://archives.streamsets.com/datacollector/3.9.0/csd/STREAMSETS-3.9.0.jar\ncd /opt/cloudera/csd/\nsudo chown cloudera-scm:cloudera-scm STREAMSETS-3.9.0.jar && sudo chmod 644 STREAMSETS-3.9.0.jar\nsystemctl restart cloudera-scm-server\n```\n\n<a name=\"16S3C\"></a>\n### 下载分发Parcel包\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560931069258-56f0a704-4b7a-4765-8e19-6600d46f7f6f.png#align=left&display=inline&height=158&name=image.png&originHeight=158&originWidth=770&size=15171&status=done&width=770)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560931088736-68ef0972-74b2-4043-984c-b2b1630adca0.png#align=left&display=inline&height=98&name=image.png&originHeight=98&originWidth=394&size=5113&status=done&width=394)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560931127791-d2b173ce-ed55-4b65-99a7-2cd658468dc5.png#align=left&display=inline&height=346&name=image.png&originHeight=346&originWidth=1023&size=42564&status=done&width=1023)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560931177761-a0d04a4d-a502-4b7f-a84e-fb6323c0299e.png#align=left&display=inline&height=118&name=image.png&originHeight=118&originWidth=1029&size=14553&status=done&width=1029)<br />下载并激活，但是，我实际测试时，总大小，4.6G，实际下载后，5.2G，导致sha1sum 校验失败，报<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560931888700-b4afecab-a671-463b-9610-701e2a58b761.png#align=left&display=inline&height=227&name=image.png&originHeight=227&originWidth=628&size=18002&status=done&width=628)\n\n在cm所在主机， `ls -lah /opt/cloudera/parcel-repo`  <br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560932061185-d64adfe2-5884-4967-b98b-c76a999c3024.png#align=left&display=inline&height=159&name=image.png&originHeight=159&originWidth=777&size=25904&status=done&width=777)\n\n把下载的 [https://archives.streamsets.com/datacollector/3.9.0/parcel/STREAMSETS_DATACOLLECTOR-3.9.0-el7.parcel](https://archives.streamsets.com/datacollector/3.9.0/parcel/STREAMSETS_DATACOLLECTOR-3.9.0-el7.parcel) 复制到 /opt/cloudera/parcel-repo 下<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560932517429-eb7b8ece-4135-4a81-a751-8e8c0d267ef9.png#align=left&display=inline&height=105&name=image.png&originHeight=105&originWidth=1039&size=12588&status=done&width=1039)<br />如果已经不信邪，试过下载，并报hash错误后，直接替换后，这个页面还是提示hash，此时再次点击下载，就会变成分配。<br />激活后如下所示<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560936491543-f6e5539b-2396-4eb4-a616-ae2bafd02155.png#align=left&display=inline&height=156&name=image.png&originHeight=156&originWidth=1589&size=17337&status=done&width=1589)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560936642593-d20866d4-46d1-490e-9bff-8cf7c72587d5.png#align=left&display=inline&height=701&name=image.png&originHeight=701&originWidth=903&size=171790&status=done&width=903)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560936658975-a85eae7a-341d-4c68-8967-a670c23cb622.png#align=left&display=inline&height=378&name=image.png&originHeight=378&originWidth=1146&size=38226&status=done&width=1146)<br />创建完毕\n\n<a name=\"ScFf4\"></a>\n### streamsets 简单使用\n打开streamsets，默认用户名密码 admin/admin<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1560945744410-72401676-7384-4312-8859-c7b652c1caca.png#align=left&display=inline&height=516&name=image.png&originHeight=516&originWidth=1374&size=63461&status=done&width=1374)<br />\n        ![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561003595012-472339dd-c7c0-49be-9be3-855d9fe21016.png)\n          \n  \n  \n          \n      \n    \n  <br />\n\n官方教程，参考 [Basic Tutorial](https://streamsets.com/documentation/datacollector/3.9.x/help/datacollector/UserGuide/Tutorial/BasicTutorial.html)\n\n本文主要讲解订阅mysql binlog进行数据同步\n\n<a name=\"fcYrG\"></a>\n## mysql binlog\n\n<a name=\"nEogv\"></a>\n### 开启binlog\n修改mysql配置文件，my.cnf，在mysqld下增加（注意5.7的不加server-id无法正常启动）\n\n```\nserver-id=1\nlog-bin=mysql-bin\nbinlog_format=ROW\n```\n\n<a name=\"Q47aL\"></a>\n### 创建并配置同步账号\n\n```sql\nGRANT ALL on slave_test.* to 'slave_test'@'%' identified by 'slave_test';\nGRANT SELECT, REPLICATION CLIENT, REPLICATION SLAVE on *.* to 'slave_test'@'%';\nFLUSH PRIVILEGES;\n```\n\n<a name=\"oWlz6\"></a>\n### 安装mysql jdbc驱动\n\n```bash\nwget -P /opt/cloudera/parcels/STREAMSETS_DATACOLLECTOR/streamsets-libs/streamsets-datacollector-mysql-binlog-lib/lib/ https://repo1.maven.org/maven2/mysql/mysql-connector-java/5.1.47/mysql-connector-java-5.1.47.jar\n```\n\n重启streamsets\n\n\n<a name=\"qXsmC\"></a>\n### 创建pipeline\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561022971274-512e79c5-11a2-4910-85e2-aabeba28edb2.png#align=left&display=inline&height=483&name=image.png&originHeight=483&originWidth=1245&size=57203&status=done&width=1245)\n<a name=\"vDqzm\"></a>\n### 配置mysql binlog解析及处理\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561023067141-a97a2e75-8272-472e-8d31-812be2123206.png#align=left&display=inline&height=703&name=image.png&originHeight=703&originWidth=831&size=64114&status=done&width=831)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561023232872-f63802b3-7be6-4968-9fb9-2f7c368e7c3b.png#align=left&display=inline&height=649&name=image.png&originHeight=649&originWidth=781&size=44770&status=done&width=781)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561023290961-315616ad-faed-405c-af47-f1bed5816b07.png#align=left&display=inline&height=345&name=image.png&originHeight=345&originWidth=776&size=40429&status=done&width=776)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561023323874-819a18b1-42f9-404b-9eac-17d7b7190b3c.png#align=left&display=inline&height=211&name=image.png&originHeight=211&originWidth=658&size=15146&status=done&width=658)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561023405577-345c7f5d-e682-45ba-b684-450707e4d26d.png#align=left&display=inline&height=482&name=image.png&originHeight=482&originWidth=880&size=57665&status=done&width=880)<br />配置目标端<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561023517902-fcf0a0d8-7360-4ca9-aed4-2b2f88b07ce7.png#align=left&display=inline&height=428&name=image.png&originHeight=428&originWidth=303&size=22581&status=done&width=303)![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561023530221-53bf1e14-b792-40bf-9fcf-234b3c1ca097.png#align=left&display=inline&height=583&name=image.png&originHeight=583&originWidth=773&size=28852&status=done&width=773)\n\n\n<a name=\"AEeSg\"></a>\n### 运行\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561023620269-fd10f7a4-f48d-44d7-a61f-d03a5fc8dead.png#align=left&display=inline&height=458&name=image.png&originHeight=458&originWidth=1808&size=69037&status=done&width=1808)\n\n<a name=\"WoQS7\"></a>\n### 测试\n此处使用mysql自带的压测工具 `mysqlslap.exe` 进行测试 \n\n```bash\nbin/mysqlslap --user=root --password=xxxxxx --concurrency=50 --number-int-cols=5 --number-char-cols=20 --auto-generate-sql --number-of-queries=100000 --auto-generate-sql-load-type=write --host=192.168.0.123 --port=3306\n--user 用户(需要有建库建表权限)\n--password 密码\n--concurrency 并发数\n--number-int-cols 表内有5个数字列\n--number-char-cols 表内有20个字符串列\n--auto-generate-sql 自动生成脚本\n--number-of-queries 总执行次数\n--auto-generate-sql-load-type=write 只执行写入操作\n--host mysql 主机\n--port 端口\n```\n下方有监控报表\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1561022869352-3d191209-41df-43ef-a7a6-5b7f097f4ba0.png#align=left&display=inline&height=883&originHeight=883&originWidth=1896&status=done&width=1896)\n\n\n<a name=\"41HXC\"></a>\n## 常见错误\n\n        ![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561021775509-fa60a34d-8e71-4e30-aa65-88a23521fb26.png)\n          \n  \n  \n          \n      \n    \n  <br />同步不一致导致的错误，手动从<br />![](https://cdn.nlark.com/yuque/0/2019/png/226273/1561023290961-315616ad-faed-405c-af47-f1bed5816b07.png#align=left&display=inline&height=332&originHeight=345&originWidth=776&status=done&width=746)<br />设置偏移量<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1561022441978-aefea073-d2eb-41b6-863c-733229e35252.png#align=left&display=inline&height=709&name=image.png&originHeight=709&originWidth=900&size=124020&status=done&width=900)\n\n如果报错 `Pipeline Status: RUNNING_ERROR: For input string: \"\"xxxx\"`   ，把my.cnf改成\n\n```bash\nserver-id=1\nlog-bin=mysql-bin\nbinlog_format=ROW\nsync_binlog=1\nbinlog_gtid_simple_recovery=ON\nlog_slave_updates=ON\ngtid_mode=ON\nenforce_gtid_consistency=ON\n```\n\n<a name=\"ePxB0\"></a>\n## 参考资料\n\n- [腾讯工程师带你深入解析 MySQL binlog](https://zhuanlan.zhihu.com/p/33504555)\n- [Home/Origins/MySQL Binary Log](https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/MySQLBinaryLog.html)\n- [Home/Tutorial/Basic Tutorial](https://streamsets.com/documentation/datacollector/3.9.x/help/datacollector/UserGuide/Tutorial/BasicTutorial.html)\n- [如何在CDH中安装和使用StreamSets](https://mp.weixin.qq.com/s?__biz=MzI4OTY3MTUyNg==&mid=2247488566&idx=1&sn=8c4350eb654453b2317de2b347b6e525&chksm=ec2ac43fdb5d4d2964e2b074d02faaeebe202c2ba3565ac00f589b696644bdbfa8f6f4d9754e&scene=21#wechat_redirect)\n- [如何使用StreamSets实现MySQL中变化数据实时写入HBase](https://cloud.tencent.com/developer/article/1158163)\n",
    "body_draft": "",
    "body_html": "<p><span style=\"background-color: transparent;\">date: 2019-06-10 21:00:01</span><br /></p><p>tags: [CDH,hadoop,大数据,ETL,StreamSets,SDC]</p><p>categories: 大数据</p><p>---</p><blockquote><p>这是坚持技术写作计划（含翻译）的第25篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要介绍CDH6.2+StreamSets3.9。</p><p><br /></p><p><span>StreamSets是一个大数据采集和数据处理工具。可以通过拖拽式的可视化操作，实现数据管道(Pipelines)的设计和调度。其特点有：</span></p><ul><li>拖拽式的可视化界面操作，上手快。</li><li>对常见数据处理(数据源、数据操作、数据输出)支持较好。</li><li>内置监控，可以对数据流进行观测。</li></ul><p><br /></p><p>类似的开源产品还有 <a href=\"http://nifi.apache.org/\" target=\"_blank\">Apache NiFi</a> , 网上有关于NiFi和StreamSets 的对比 <a href=\"https://statsbot.co/blog/open-source-etl/\" target=\"_blank\">Open Source ETL: Apache NiFi vs Streamsets</a> (网上有中文翻译版版)</p><p><br /></p><p>国内接触较多的ETL工具，可能是 <a href=\"https://github.com/alibaba/DataX\" target=\"_blank\">DataX</a> 、 <a href=\"https://kettle.pentaho.com\" target=\"_blank\">Kettle</a> 、<a href=\"http://sqoop.apache.org/\" target=\"_blank\">Sqoop</a>。此处有个简单的对比，<a href=\"https://my.oschina.net/peakfang/blog/2056426\" target=\"_blank\">数据集成之 kettle、sqoop、datax、streamSets 比较 </a></p><p><br /></p><p><br /></p><h2 id=\"t85Ls\">安装StreamSets 3.9</h2><h3 id=\"sMTmJ\">下载<span style=\"color: #1A1A1A;\">parcel</span>安装包</h3><p><br /></p><p>从 <a href=\"https://archives.streamsets.com/index.html\" target=\"_blank\">https://archives.streamsets.com/index.html</a> 下载3.9的</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560930235577-b347118a-9af6-4e1e-b3c8-d76d7d388e95.png#align=left&amp;display=inline&amp;height=681&amp;name=image.png&amp;originHeight=681&amp;originWidth=549&amp;size=51810&amp;status=done&amp;width=549\" style=\"max-width: 600px; width: 549px;\" /></p><p>并上传到http服务器的www目录下，本文以centos7.6为例</p><p><br /></p><pre data-lang=\"bash\"><code>wget -P /var/www/html/streamsets3.9.0/ https://archives.streamsets.com/datacollector/3.9.0/parcel/manifest.json\nwget -P /var/www/html/streamsets3.9.0/ https://archives.streamsets.com/datacollector/3.9.0/parcel/STREAMSETS_DATACOLLECTOR-3.9.0-el7.parcel.sha\nwget -P /var/www/html/streamsets3.9.0/ https://archives.streamsets.com/datacollector/3.9.0/parcel/STREAMSETS_DATACOLLECTOR-3.9.0-el7.parcel</code></pre><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560930516379-4f6922d6-76ed-44cd-b5c7-1b8579743cdf.png#align=left&amp;display=inline&amp;height=269&amp;name=image.png&amp;originHeight=269&amp;originWidth=553&amp;size=25017&amp;status=done&amp;width=553\" style=\"max-width: 600px; width: 553px;\" /></p><p><br /></p><h3 id=\"QEaW1\">配置csd</h3><p>从 <a href=\"https://streamsets.com/opensource\" target=\"_blank\">https://streamsets.com/opensource</a> 下载</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560930592344-14e9b2ee-6153-4c2b-8e6e-eafa305b11ca.png#align=left&amp;display=inline&amp;height=628&amp;name=image.png&amp;originHeight=628&amp;originWidth=520&amp;size=49861&amp;status=done&amp;width=520\" style=\"max-width: 600px; width: 520px;\" /></p><p><br /></p><pre data-lang=\"bash\"><code>wget -P /opt/cloudera/csd/ https://archives.streamsets.com/datacollector/3.9.0/csd/STREAMSETS-3.9.0.jar\ncd /opt/cloudera/csd/\nsudo chown cloudera-scm:cloudera-scm STREAMSETS-3.9.0.jar &amp;&amp; sudo chmod 644 STREAMSETS-3.9.0.jar\nsystemctl restart cloudera-scm-server</code></pre><p><br /></p><h3 id=\"16S3C\">下载分发<span style=\"color: #1A1A1A;\">Parcel包</span></h3><p><span style=\"color: #1A1A1A;\"><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560931069258-56f0a704-4b7a-4765-8e19-6600d46f7f6f.png#align=left&amp;display=inline&amp;height=158&amp;name=image.png&amp;originHeight=158&amp;originWidth=770&amp;size=15171&amp;status=done&amp;width=770\" style=\"max-width: 600px; width: 770px;\" /></span></p><p><span style=\"color: #1A1A1A;\"><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560931088736-68ef0972-74b2-4043-984c-b2b1630adca0.png#align=left&amp;display=inline&amp;height=98&amp;name=image.png&amp;originHeight=98&amp;originWidth=394&amp;size=5113&amp;status=done&amp;width=394\" style=\"max-width: 600px; width: 394px;\" /></span></p><p><span style=\"color: #1A1A1A;\"><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560931127791-d2b173ce-ed55-4b65-99a7-2cd658468dc5.png#align=left&amp;display=inline&amp;height=346&amp;name=image.png&amp;originHeight=346&amp;originWidth=1023&amp;size=42564&amp;status=done&amp;width=1023\" style=\"max-width: 600px; width: 1023px;\" /></span></p><p><span style=\"color: #1A1A1A;\"><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560931177761-a0d04a4d-a502-4b7f-a84e-fb6323c0299e.png#align=left&amp;display=inline&amp;height=118&amp;name=image.png&amp;originHeight=118&amp;originWidth=1029&amp;size=14553&amp;status=done&amp;width=1029\" style=\"max-width: 600px; width: 1029px;\" /></span></p><p><span style=\"color: #1A1A1A;\">下载并激活，但是，我实际测试时，总大小，4.6G，实际下载后，5.2G，导致sha1sum 校验失败，报</span></p><p><span style=\"color: #1A1A1A;\"><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560931888700-b4afecab-a671-463b-9610-701e2a58b761.png#align=left&amp;display=inline&amp;height=227&amp;name=image.png&amp;originHeight=227&amp;originWidth=628&amp;size=18002&amp;status=done&amp;width=628\" style=\"max-width: 600px; width: 628px;\" /></span></p><p><span style=\"color: #1A1A1A;\"><br /></span></p><p><span style=\"color: #1A1A1A;\">在cm所在主机， <code>ls -lah /opt/cloudera/parcel-repo</code></span><span style=\"color: #1A1A1A;\">  </span></p><p><span style=\"color: #1A1A1A;\"><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560932061185-d64adfe2-5884-4967-b98b-c76a999c3024.png#align=left&amp;display=inline&amp;height=159&amp;name=image.png&amp;originHeight=159&amp;originWidth=777&amp;size=25904&amp;status=done&amp;width=777\" style=\"max-width: 600px; width: 777px;\" /></span></p><p><span style=\"color: #1A1A1A;\"><br /></span></p><p>把下载的 <a href=\"https://archives.streamsets.com/datacollector/3.9.0/parcel/STREAMSETS_DATACOLLECTOR-3.9.0-el7.parcel\" target=\"_blank\">https://archives.streamsets.com/datacollector/3.9.0/parcel/STREAMSETS_DATACOLLECTOR-3.9.0-el7.parcel</a> 复制到 <span style=\"color: #1A1A1A; background-color: \"rgba(0, 0, 0, 0.06)\";\">/opt/cloudera/parcel-repo </span>下</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560932517429-eb7b8ece-4135-4a81-a751-8e8c0d267ef9.png#align=left&amp;display=inline&amp;height=105&amp;name=image.png&amp;originHeight=105&amp;originWidth=1039&amp;size=12588&amp;status=done&amp;width=1039\" style=\"max-width: 600px; width: 1039px;\" /></p><p>如果已经不信邪，试过下载，并报hash错误后，直接替换后，这个页面还是提示hash，此时再次点击下载，就会变成分配。</p><p>激活后如下所示</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560936491543-f6e5539b-2396-4eb4-a616-ae2bafd02155.png#align=left&amp;display=inline&amp;height=156&amp;name=image.png&amp;originHeight=156&amp;originWidth=1589&amp;size=17337&amp;status=done&amp;width=1589\" style=\"max-width: 600px; width: 1589px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560936642593-d20866d4-46d1-490e-9bff-8cf7c72587d5.png#align=left&amp;display=inline&amp;height=701&amp;name=image.png&amp;originHeight=701&amp;originWidth=903&amp;size=171790&amp;status=done&amp;width=903\" style=\"max-width: 600px; width: 903px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560936658975-a85eae7a-341d-4c68-8967-a670c23cb622.png#align=left&amp;display=inline&amp;height=378&amp;name=image.png&amp;originHeight=378&amp;originWidth=1146&amp;size=38226&amp;status=done&amp;width=1146\" style=\"max-width: 600px; width: 1146px;\" /></p><p>创建完毕</p><p><br /></p><h3 id=\"ScFf4\">streamsets 简单使用</h3><p>打开streamsets，默认用户名密码 admin/admin</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1560945744410-72401676-7384-4312-8859-c7b652c1caca.png#align=left&amp;display=inline&amp;height=516&amp;name=image.png&amp;originHeight=516&amp;originWidth=1374&amp;size=63461&amp;status=done&amp;width=1374\" style=\"max-width: 600px; width: 1374px;\" /></p><p><span><span><span>\n        <span><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561003595012-472339dd-c7c0-49be-9be3-855d9fe21016.png\" alt=\"image.png\" title=\"image.png\" style=\"width: 654px; height: 316px;\" />\n          \n  \n  \n          </span>\n      </span>\n    </span>\n  </span><br /></p><p><br /></p><p>官方教程，参考 <a href=\"https://streamsets.com/documentation/datacollector/3.9.x/help/datacollector/UserGuide/Tutorial/BasicTutorial.html\" target=\"_blank\">Basic Tutorial</a></p><p><br /></p><p>本文主要讲解订阅mysql binlog进行数据同步</p><p><br /></p><h2 id=\"fcYrG\">mysql binlog</h2><p><br /></p><h3 id=\"nEogv\">开启binlog</h3><p>修改mysql配置文件，my.cnf，在mysqld下增加（注意5.7的不加server-id无法正常启动）</p><p><br /></p><pre><code>server-id=1\nlog-bin=mysql-bin\nbinlog_format=ROW</code></pre><p><br /></p><h3 id=\"Q47aL\">创建并配置同步账号</h3><p><br /></p><pre data-lang=\"sql\"><code>GRANT ALL on slave_test.* to 'slave_test'@'%' identified by 'slave_test';\nGRANT SELECT, REPLICATION CLIENT, REPLICATION SLAVE on *.* to 'slave_test'@'%';\nFLUSH PRIVILEGES;</code></pre><p><br /></p><h3 id=\"oWlz6\">安装mysql jdbc驱动</h3><p><br /></p><pre data-lang=\"bash\"><code>wget -P /opt/cloudera/parcels/STREAMSETS_DATACOLLECTOR/streamsets-libs/streamsets-datacollector-mysql-binlog-lib/lib/ https://repo1.maven.org/maven2/mysql/mysql-connector-java/5.1.47/mysql-connector-java-5.1.47.jar</code></pre><p><br /></p><p>重启streamsets</p><p><br /></p><p><br /></p><h3 id=\"qXsmC\">创建pipeline</h3><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561022971274-512e79c5-11a2-4910-85e2-aabeba28edb2.png#align=left&amp;display=inline&amp;height=483&amp;name=image.png&amp;originHeight=483&amp;originWidth=1245&amp;size=57203&amp;status=done&amp;width=1245\" style=\"max-width: 600px; width: 1245px;\" /></p><h3 id=\"vDqzm\">配置mysql binlog解析及处理</h3><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561023067141-a97a2e75-8272-472e-8d31-812be2123206.png#align=left&amp;display=inline&amp;height=703&amp;name=image.png&amp;originHeight=703&amp;originWidth=831&amp;size=64114&amp;status=done&amp;width=831\" style=\"max-width: 600px; width: 831px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561023232872-f63802b3-7be6-4968-9fb9-2f7c368e7c3b.png#align=left&amp;display=inline&amp;height=649&amp;name=image.png&amp;originHeight=649&amp;originWidth=781&amp;size=44770&amp;status=done&amp;width=781\" style=\"max-width: 600px; width: 781px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561023290961-315616ad-faed-405c-af47-f1bed5816b07.png#align=left&amp;display=inline&amp;height=345&amp;name=image.png&amp;originHeight=345&amp;originWidth=776&amp;size=40429&amp;status=done&amp;width=776\" style=\"max-width: 600px; width: 776px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561023323874-819a18b1-42f9-404b-9eac-17d7b7190b3c.png#align=left&amp;display=inline&amp;height=211&amp;name=image.png&amp;originHeight=211&amp;originWidth=658&amp;size=15146&amp;status=done&amp;width=658\" style=\"max-width: 600px; width: 658px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561023405577-345c7f5d-e682-45ba-b684-450707e4d26d.png#align=left&amp;display=inline&amp;height=482&amp;name=image.png&amp;originHeight=482&amp;originWidth=880&amp;size=57665&amp;status=done&amp;width=880\" style=\"max-width: 600px; width: 880px;\" /></p><p>配置目标端</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561023517902-fcf0a0d8-7360-4ca9-aed4-2b2f88b07ce7.png#align=left&amp;display=inline&amp;height=428&amp;name=image.png&amp;originHeight=428&amp;originWidth=303&amp;size=22581&amp;status=done&amp;width=303\" style=\"max-width: 600px; width: 303px;\" /><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561023530221-53bf1e14-b792-40bf-9fcf-234b3c1ca097.png#align=left&amp;display=inline&amp;height=583&amp;name=image.png&amp;originHeight=583&amp;originWidth=773&amp;size=28852&amp;status=done&amp;width=773\" style=\"max-width: 600px; width: 773px;\" /></p><p><br /></p><p><br /></p><h3 id=\"AEeSg\">运行</h3><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561023620269-fd10f7a4-f48d-44d7-a61f-d03a5fc8dead.png#align=left&amp;display=inline&amp;height=458&amp;name=image.png&amp;originHeight=458&amp;originWidth=1808&amp;size=69037&amp;status=done&amp;width=1808\" style=\"max-width: 600px; width: 1808px;\" /></p><p><br /></p><h3 id=\"WoQS7\">测试</h3><p>此处使用mysql自带的压测工具 <code>mysqlslap.exe</code> 进行测试 </p><p><br /></p><pre data-lang=\"bash\"><code>bin/mysqlslap --user=root --password=xxxxxx --concurrency=50 --number-int-cols=5 --number-char-cols=20 --auto-generate-sql --number-of-queries=100000 --auto-generate-sql-load-type=write --host=192.168.0.123 --port=3306\n--user 用户(需要有建库建表权限)\n--password 密码\n--concurrency 并发数\n--number-int-cols 表内有5个数字列\n--number-char-cols 表内有20个字符串列\n--auto-generate-sql 自动生成脚本\n--number-of-queries 总执行次数\n--auto-generate-sql-load-type=write 只执行写入操作\n--host mysql 主机\n--port 端口</code></pre><p>下方有监控报表</p><p><br /></p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561022869352-3d191209-41df-43ef-a7a6-5b7f097f4ba0.png#align=left&amp;display=inline&amp;height=883&amp;originHeight=883&amp;originWidth=1896&amp;status=done&amp;width=1896\" style=\"max-width: 600px; width: 1896px;\" /></p><p><br /></p><p><br /></p><h2 id=\"41HXC\">常见错误</h2><p><span><span><span>\n        <span><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561021775509-fa60a34d-8e71-4e30-aa65-88a23521fb26.png\" alt=\"image.png\" title=\"image.png\" style=\"width: 746px; height: 616px;\" />\n          \n  \n  \n          </span>\n      </span>\n    </span>\n  </span></p><p>同步不一致导致的错误，手动从</p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561023290961-315616ad-faed-405c-af47-f1bed5816b07.png#align=left&amp;display=inline&amp;height=332&amp;originHeight=345&amp;originWidth=776&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p>设置偏移量</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561022441978-aefea073-d2eb-41b6-863c-733229e35252.png#align=left&amp;display=inline&amp;height=709&amp;name=image.png&amp;originHeight=709&amp;originWidth=900&amp;size=124020&amp;status=done&amp;width=900\" style=\"max-width: 600px; width: 900px;\" /></p><p><br /></p><p>如果报错 <code>Pipeline Status: RUNNING_ERROR: For input string: &quot;&quot;xxxx&quot;</code>   ，把my.cnf改成</p><p><br /></p><pre data-lang=\"bash\"><code>server-id=1\nlog-bin=mysql-bin\nbinlog_format=ROW\nsync_binlog=1\nbinlog_gtid_simple_recovery=ON\nlog_slave_updates=ON\ngtid_mode=ON\nenforce_gtid_consistency=ON</code></pre><p><br /></p><h2 id=\"ePxB0\">参考资料</h2><ul><li><a href=\"https://zhuanlan.zhihu.com/p/33504555\" target=\"_blank\">腾讯工程师带你深入解析 MySQL binlog</a></li><li><a href=\"https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/MySQLBinaryLog.html\" target=\"_blank\">Home/Origins/MySQL Binary Log</a></li><li><a href=\"https://streamsets.com/documentation/datacollector/3.9.x/help/datacollector/UserGuide/Tutorial/BasicTutorial.html\" target=\"_blank\">Home/Tutorial/Basic Tutorial</a></li><li><a href=\"https://mp.weixin.qq.com/s?__biz=MzI4OTY3MTUyNg==&amp;mid=2247488566&amp;idx=1&amp;sn=8c4350eb654453b2317de2b347b6e525&amp;chksm=ec2ac43fdb5d4d2964e2b074d02faaeebe202c2ba3565ac00f589b696644bdbfa8f6f4d9754e&amp;scene=21#wechat_redirect\" target=\"_blank\">如何在CDH中安装和使用StreamSets</a></li><li><a href=\"https://cloud.tencent.com/developer/article/1158163\" target=\"_blank\">如何使用StreamSets实现MySQL中变化数据实时写入HBase</a></li></ul>",
    "body_lake": "<!doctype lake><p><span style=\"background-color: transparent;\">date: 2019-06-10 21:00:01</span><br /></p><p>tags: [CDH,hadoop,大数据,ETL,StreamSets,SDC]</p><p>categories: 大数据</p><p>---</p><blockquote><p>这是坚持技术写作计划（含翻译）的第25篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要介绍CDH6.2+StreamSets3.9。</p><p><br /></p><p><span>StreamSets是一个大数据采集和数据处理工具。可以通过拖拽式的可视化操作，实现数据管道(Pipelines)的设计和调度。其特点有：</span></p><ul><li>拖拽式的可视化界面操作，上手快。</li><li>对常见数据处理(数据源、数据操作、数据输出)支持较好。</li><li>内置监控，可以对数据流进行观测。</li></ul><p><br /></p><p>类似的开源产品还有 <a href=\"http://nifi.apache.org/\" target=\"_blank\">Apache NiFi</a> , 网上有关于NiFi和StreamSets 的对比 <a href=\"https://statsbot.co/blog/open-source-etl/\" target=\"_blank\">Open Source ETL: Apache NiFi vs Streamsets</a> (网上有中文翻译版版)</p><p><br /></p><p>国内接触较多的ETL工具，可能是 <a href=\"https://github.com/alibaba/DataX\" target=\"_blank\">DataX</a> 、 <a href=\"https://kettle.pentaho.com\" target=\"_blank\">Kettle</a> 、<a href=\"http://sqoop.apache.org/\" target=\"_blank\">Sqoop</a>。此处有个简单的对比，<a href=\"https://my.oschina.net/peakfang/blog/2056426\" target=\"_blank\">数据集成之 kettle、sqoop、datax、streamSets 比较 </a></p><p><br /></p><p><br /></p><h2 id=\"t85Ls\">安装StreamSets 3.9</h2><h3 id=\"sMTmJ\">下载<span style=\"color: #1A1A1A;\">parcel</span>安装包</h3><p><br /></p><p>从 <a href=\"https://archives.streamsets.com/index.html\" target=\"_blank\">https://archives.streamsets.com/index.html</a> 下载3.9的</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560930235577-b347118a-9af6-4e1e-b3c8-d76d7d388e95.png%22%2C%22originWidth%22%3A549%2C%22originHeight%22%3A681%2C%22name%22%3A%22image.png%22%2C%22size%22%3A51810%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A549%2C%22height%22%3A681%7D\"></card></p><p>并上传到http服务器的www目录下，本文以centos7.6为例</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22wget%20-P%20%2Fvar%2Fwww%2Fhtml%2Fstreamsets3.9.0%2F%20https%3A%2F%2Farchives.streamsets.com%2Fdatacollector%2F3.9.0%2Fparcel%2Fmanifest.json%5Cnwget%20-P%20%2Fvar%2Fwww%2Fhtml%2Fstreamsets3.9.0%2F%20https%3A%2F%2Farchives.streamsets.com%2Fdatacollector%2F3.9.0%2Fparcel%2FSTREAMSETS_DATACOLLECTOR-3.9.0-el7.parcel.sha%5Cnwget%20-P%20%2Fvar%2Fwww%2Fhtml%2Fstreamsets3.9.0%2F%20https%3A%2F%2Farchives.streamsets.com%2Fdatacollector%2F3.9.0%2Fparcel%2FSTREAMSETS_DATACOLLECTOR-3.9.0-el7.parcel%22%2C%22id%22%3A%22u9Orw%22%7D\"></card><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560930516379-4f6922d6-76ed-44cd-b5c7-1b8579743cdf.png%22%2C%22originWidth%22%3A553%2C%22originHeight%22%3A269%2C%22name%22%3A%22image.png%22%2C%22size%22%3A25017%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A553%2C%22height%22%3A269%7D\"></card></p><p><br /></p><h3 id=\"QEaW1\">配置csd</h3><p>从 <a href=\"https://streamsets.com/opensource\" target=\"_blank\">https://streamsets.com/opensource</a> 下载</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560930592344-14e9b2ee-6153-4c2b-8e6e-eafa305b11ca.png%22%2C%22originWidth%22%3A520%2C%22originHeight%22%3A628%2C%22name%22%3A%22image.png%22%2C%22size%22%3A49861%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A520%2C%22height%22%3A628%7D\"></card></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22wget%20-P%20%2Fopt%2Fcloudera%2Fcsd%2F%20https%3A%2F%2Farchives.streamsets.com%2Fdatacollector%2F3.9.0%2Fcsd%2FSTREAMSETS-3.9.0.jar%5Cncd%20%2Fopt%2Fcloudera%2Fcsd%2F%5Cnsudo%20chown%20cloudera-scm%3Acloudera-scm%20STREAMSETS-3.9.0.jar%20%26%26%20sudo%20chmod%20644%20STREAMSETS-3.9.0.jar%5Cnsystemctl%20restart%20cloudera-scm-server%22%2C%22id%22%3A%223MNog%22%7D\"></card><p><br /></p><h3 id=\"16S3C\">下载分发<span style=\"color: #1A1A1A;\">Parcel包</span></h3><p><span style=\"color: #1A1A1A;\"><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560931069258-56f0a704-4b7a-4765-8e19-6600d46f7f6f.png%22%2C%22originWidth%22%3A770%2C%22originHeight%22%3A158%2C%22name%22%3A%22image.png%22%2C%22size%22%3A15171%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A770%2C%22height%22%3A158%7D\"></card></span></p><p><span style=\"color: #1A1A1A;\"><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560931088736-68ef0972-74b2-4043-984c-b2b1630adca0.png%22%2C%22originWidth%22%3A394%2C%22originHeight%22%3A98%2C%22name%22%3A%22image.png%22%2C%22size%22%3A5113%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A394%2C%22height%22%3A98%7D\"></card></span></p><p><span style=\"color: #1A1A1A;\"><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560931127791-d2b173ce-ed55-4b65-99a7-2cd658468dc5.png%22%2C%22originWidth%22%3A1023%2C%22originHeight%22%3A346%2C%22name%22%3A%22image.png%22%2C%22size%22%3A42564%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1023%2C%22height%22%3A346%7D\"></card></span></p><p><span style=\"color: #1A1A1A;\"><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560931177761-a0d04a4d-a502-4b7f-a84e-fb6323c0299e.png%22%2C%22originWidth%22%3A1029%2C%22originHeight%22%3A118%2C%22name%22%3A%22image.png%22%2C%22size%22%3A14553%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1029%2C%22height%22%3A118%7D\"></card></span></p><p><span style=\"color: #1A1A1A;\">下载并激活，但是，我实际测试时，总大小，4.6G，实际下载后，5.2G，导致sha1sum 校验失败，报</span></p><p><span style=\"color: #1A1A1A;\"><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560931888700-b4afecab-a671-463b-9610-701e2a58b761.png%22%2C%22originWidth%22%3A628%2C%22originHeight%22%3A227%2C%22name%22%3A%22image.png%22%2C%22size%22%3A18002%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A628%2C%22height%22%3A227%7D\"></card></span></p><p><span style=\"color: #1A1A1A;\"><br /></span></p><p><span style=\"color: #1A1A1A;\">在cm所在主机， <code>ls -lah /opt/cloudera/parcel-repo</code></span><span style=\"color: #1A1A1A;\">  </span></p><p><span style=\"color: #1A1A1A;\"><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560932061185-d64adfe2-5884-4967-b98b-c76a999c3024.png%22%2C%22originWidth%22%3A777%2C%22originHeight%22%3A159%2C%22name%22%3A%22image.png%22%2C%22size%22%3A25904%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A777%2C%22height%22%3A159%7D\"></card></span></p><p><span style=\"color: #1A1A1A;\"><br /></span></p><p>把下载的 <a href=\"https://archives.streamsets.com/datacollector/3.9.0/parcel/STREAMSETS_DATACOLLECTOR-3.9.0-el7.parcel\" target=\"_blank\">https://archives.streamsets.com/datacollector/3.9.0/parcel/STREAMSETS_DATACOLLECTOR-3.9.0-el7.parcel</a> 复制到 <span style=\"color: #1A1A1A; background-color: rgba(0, 0, 0, 0.06);\">/opt/cloudera/parcel-repo </span>下</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560932517429-eb7b8ece-4135-4a81-a751-8e8c0d267ef9.png%22%2C%22originWidth%22%3A1039%2C%22originHeight%22%3A105%2C%22name%22%3A%22image.png%22%2C%22size%22%3A12588%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1039%2C%22height%22%3A105%7D\"></card></p><p>如果已经不信邪，试过下载，并报hash错误后，直接替换后，这个页面还是提示hash，此时再次点击下载，就会变成分配。</p><p>激活后如下所示</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560936491543-f6e5539b-2396-4eb4-a616-ae2bafd02155.png%22%2C%22originWidth%22%3A1589%2C%22originHeight%22%3A156%2C%22name%22%3A%22image.png%22%2C%22size%22%3A17337%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1589%2C%22height%22%3A156%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560936642593-d20866d4-46d1-490e-9bff-8cf7c72587d5.png%22%2C%22originWidth%22%3A903%2C%22originHeight%22%3A701%2C%22name%22%3A%22image.png%22%2C%22size%22%3A171790%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A903%2C%22height%22%3A701%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560936658975-a85eae7a-341d-4c68-8967-a670c23cb622.png%22%2C%22originWidth%22%3A1146%2C%22originHeight%22%3A378%2C%22name%22%3A%22image.png%22%2C%22size%22%3A38226%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1146%2C%22height%22%3A378%7D\"></card></p><p>创建完毕</p><p><br /></p><h3 id=\"ScFf4\">streamsets 简单使用</h3><p>打开streamsets，默认用户名密码 admin/admin</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1560945744410-72401676-7384-4312-8859-c7b652c1caca.png%22%2C%22originWidth%22%3A1374%2C%22originHeight%22%3A516%2C%22name%22%3A%22image.png%22%2C%22size%22%3A63461%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1374%2C%22height%22%3A516%7D\"></card></p><p><span><span><span>\n        <span><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561003595012-472339dd-c7c0-49be-9be3-855d9fe21016.png\" alt=\"image.png\" title=\"image.png\" style=\"width: 654px; height: 316px;\" />\n          \n  \n  \n          </span>\n      </span>\n    </span>\n  </span><br /></p><p><br /></p><p>官方教程，参考 <a href=\"https://streamsets.com/documentation/datacollector/3.9.x/help/datacollector/UserGuide/Tutorial/BasicTutorial.html\" target=\"_blank\">Basic Tutorial</a></p><p><br /></p><p>本文主要讲解订阅mysql binlog进行数据同步</p><p><br /></p><h2 id=\"fcYrG\">mysql binlog</h2><p><br /></p><h3 id=\"nEogv\">开启binlog</h3><p>修改mysql配置文件，my.cnf，在mysqld下增加（注意5.7的不加server-id无法正常启动）</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22plain%22%2C%22code%22%3A%22server-id%3D1%5Cnlog-bin%3Dmysql-bin%5Cnbinlog_format%3DROW%22%2C%22id%22%3A%22fSqLL%22%7D\"></card><p><br /></p><h3 id=\"Q47aL\">创建并配置同步账号</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22sql%22%2C%22code%22%3A%22GRANT%20ALL%20on%20slave_test.*%20to%20'slave_test'%40'%25'%20identified%20by%20'slave_test'%3B%5CnGRANT%20SELECT%2C%20REPLICATION%20CLIENT%2C%20REPLICATION%20SLAVE%20on%20*.*%20to%20'slave_test'%40'%25'%3B%5CnFLUSH%20PRIVILEGES%3B%22%2C%22id%22%3A%22K3VJJ%22%7D\"></card><p><br /></p><h3 id=\"oWlz6\">安装mysql jdbc驱动</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22wget%20-P%20%2Fopt%2Fcloudera%2Fparcels%2FSTREAMSETS_DATACOLLECTOR%2Fstreamsets-libs%2Fstreamsets-datacollector-mysql-binlog-lib%2Flib%2F%20https%3A%2F%2Frepo1.maven.org%2Fmaven2%2Fmysql%2Fmysql-connector-java%2F5.1.47%2Fmysql-connector-java-5.1.47.jar%22%2C%22id%22%3A%22DqZV4%22%7D\"></card><p><br /></p><p>重启streamsets</p><p><br /></p><p><br /></p><h3 id=\"qXsmC\">创建pipeline</h3><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561022971274-512e79c5-11a2-4910-85e2-aabeba28edb2.png%22%2C%22originWidth%22%3A1245%2C%22originHeight%22%3A483%2C%22name%22%3A%22image.png%22%2C%22size%22%3A57203%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1245%2C%22height%22%3A483%7D\"></card></p><h3 id=\"vDqzm\">配置mysql binlog解析及处理</h3><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561023067141-a97a2e75-8272-472e-8d31-812be2123206.png%22%2C%22originWidth%22%3A831%2C%22originHeight%22%3A703%2C%22name%22%3A%22image.png%22%2C%22size%22%3A64114%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A831%2C%22height%22%3A703%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561023232872-f63802b3-7be6-4968-9fb9-2f7c368e7c3b.png%22%2C%22originWidth%22%3A781%2C%22originHeight%22%3A649%2C%22name%22%3A%22image.png%22%2C%22size%22%3A44770%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A781%2C%22height%22%3A649%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561023290961-315616ad-faed-405c-af47-f1bed5816b07.png%22%2C%22originWidth%22%3A776%2C%22originHeight%22%3A345%2C%22name%22%3A%22image.png%22%2C%22size%22%3A40429%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A776%2C%22height%22%3A345%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561023323874-819a18b1-42f9-404b-9eac-17d7b7190b3c.png%22%2C%22originWidth%22%3A658%2C%22originHeight%22%3A211%2C%22name%22%3A%22image.png%22%2C%22size%22%3A15146%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A658%2C%22height%22%3A211%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561023405577-345c7f5d-e682-45ba-b684-450707e4d26d.png%22%2C%22originWidth%22%3A880%2C%22originHeight%22%3A482%2C%22name%22%3A%22image.png%22%2C%22size%22%3A57665%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A880%2C%22height%22%3A482%7D\"></card></p><p>配置目标端</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561023517902-fcf0a0d8-7360-4ca9-aed4-2b2f88b07ce7.png%22%2C%22originWidth%22%3A303%2C%22originHeight%22%3A428%2C%22name%22%3A%22image.png%22%2C%22size%22%3A22581%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A303%2C%22height%22%3A428%7D\"></card><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561023530221-53bf1e14-b792-40bf-9fcf-234b3c1ca097.png%22%2C%22originWidth%22%3A773%2C%22originHeight%22%3A583%2C%22name%22%3A%22image.png%22%2C%22size%22%3A28852%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A773%2C%22height%22%3A583%7D\"></card></p><p><br /></p><p><br /></p><h3 id=\"AEeSg\">运行</h3><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561023620269-fd10f7a4-f48d-44d7-a61f-d03a5fc8dead.png%22%2C%22originWidth%22%3A1808%2C%22originHeight%22%3A458%2C%22name%22%3A%22image.png%22%2C%22size%22%3A69037%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1808%2C%22height%22%3A458%7D\"></card></p><p><br /></p><h3 id=\"WoQS7\">测试</h3><p>此处使用mysql自带的压测工具 <code>mysqlslap.exe</code> 进行测试 </p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22bin%2Fmysqlslap%20--user%3Droot%20--password%3Dxxxxxx%20--concurrency%3D50%20--number-int-cols%3D5%20--number-char-cols%3D20%20--auto-generate-sql%20--number-of-queries%3D100000%20--auto-generate-sql-load-type%3Dwrite%20--host%3D192.168.0.123%20--port%3D3306%5Cn--user%20%E7%94%A8%E6%88%B7(%E9%9C%80%E8%A6%81%E6%9C%89%E5%BB%BA%E5%BA%93%E5%BB%BA%E8%A1%A8%E6%9D%83%E9%99%90)%5Cn--password%20%E5%AF%86%E7%A0%81%5Cn--concurrency%20%E5%B9%B6%E5%8F%91%E6%95%B0%5Cn--number-int-cols%20%E8%A1%A8%E5%86%85%E6%9C%895%E4%B8%AA%E6%95%B0%E5%AD%97%E5%88%97%5Cn--number-char-cols%20%E8%A1%A8%E5%86%85%E6%9C%8920%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%97%5Cn--auto-generate-sql%20%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E8%84%9A%E6%9C%AC%5Cn--number-of-queries%20%E6%80%BB%E6%89%A7%E8%A1%8C%E6%AC%A1%E6%95%B0%5Cn--auto-generate-sql-load-type%3Dwrite%20%E5%8F%AA%E6%89%A7%E8%A1%8C%E5%86%99%E5%85%A5%E6%93%8D%E4%BD%9C%5Cn--host%20mysql%20%E4%B8%BB%E6%9C%BA%5Cn--port%20%E7%AB%AF%E5%8F%A3%22%2C%22id%22%3A%22eFnwt%22%7D\"></card><p>下方有监控报表</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561022869352-3d191209-41df-43ef-a7a6-5b7f097f4ba0.png%22%2C%22originWidth%22%3A1896%2C%22originHeight%22%3A883%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1896%2C%22height%22%3A883%7D\"></card></p><p><br /></p><p><br /></p><h2 id=\"41HXC\">常见错误</h2><p><span><span><span>\n        <span><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1561021775509-fa60a34d-8e71-4e30-aa65-88a23521fb26.png\" alt=\"image.png\" title=\"image.png\" style=\"width: 746px; height: 616px;\" />\n          \n  \n  \n          </span>\n      </span>\n    </span>\n  </span></p><p>同步不一致导致的错误，手动从</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561023290961-315616ad-faed-405c-af47-f1bed5816b07.png%22%2C%22originWidth%22%3A776%2C%22originHeight%22%3A345%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A332%7D\"></card></p><p>设置偏移量</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1561022441978-aefea073-d2eb-41b6-863c-733229e35252.png%22%2C%22originWidth%22%3A900%2C%22originHeight%22%3A709%2C%22name%22%3A%22image.png%22%2C%22size%22%3A124020%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A900%2C%22height%22%3A709%7D\"></card></p><p><br /></p><p>如果报错 <code>Pipeline Status: RUNNING_ERROR: For input string: &quot;&quot;xxxx&quot;</code>   ，把my.cnf改成</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22server-id%3D1%5Cnlog-bin%3Dmysql-bin%5Cnbinlog_format%3DROW%5Cnsync_binlog%3D1%5Cnbinlog_gtid_simple_recovery%3DON%5Cnlog_slave_updates%3DON%5Cngtid_mode%3DON%5Cnenforce_gtid_consistency%3DON%22%2C%22id%22%3A%22Bteai%22%7D\"></card><p><br /></p><h2 id=\"ePxB0\">参考资料</h2><ul><li><a href=\"https://zhuanlan.zhihu.com/p/33504555\" target=\"_blank\">腾讯工程师带你深入解析 MySQL binlog</a></li><li><a href=\"https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/MySQLBinaryLog.html\" target=\"_blank\">Home/Origins/MySQL Binary Log<cursor /></a></li><li><a href=\"https://streamsets.com/documentation/datacollector/3.9.x/help/datacollector/UserGuide/Tutorial/BasicTutorial.html\" target=\"_blank\">Home/Tutorial/Basic Tutorial</a></li><li><a href=\"https://mp.weixin.qq.com/s?__biz=MzI4OTY3MTUyNg==&amp;mid=2247488566&amp;idx=1&amp;sn=8c4350eb654453b2317de2b347b6e525&amp;chksm=ec2ac43fdb5d4d2964e2b074d02faaeebe202c2ba3565ac00f589b696644bdbfa8f6f4d9754e&amp;scene=21#wechat_redirect\" target=\"_blank\">如何在CDH中安装和使用StreamSets</a></li><li><a href=\"https://cloud.tencent.com/developer/article/1158163\" target=\"_blank\">如何使用StreamSets实现MySQL中变化数据实时写入HBase</a></li></ul>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-06-20T10:10:37.000Z",
    "deleted_at": null,
    "created_at": "2019-06-10T09:07:55.000Z",
    "updated_at": "2019-06-20T10:10:37.000Z",
    "published_at": "2019-06-20T10:10:37.000Z",
    "first_published_at": "2019-06-20T10:00:12.000Z",
    "word_count": 960,
    "cover": "",
    "description": "date: 2019-06-10 21:00:01tags: [CDH,hadoop,大数据,ETL,StreamSets,SDC]categories: 大数据---这是坚持技术写作计划（含翻译）的第25篇，定个小目标999，每周最少2篇。本文主要介绍CDH6.2+StreamSets3.9...",
    "custom_description": "本文主要介绍CDH6.2+StreamSets3.9。\n\n\n\nStreamSets是一个大数据采集和数据处理工具。可以通过拖拽式的可视化操作，实现数据管道(Pipelines)的设计和调度。其特点有：\n\n拖拽式的可视化界面操作，上手快。\n对常见数据处理(数据源、数据操作、数据输出)支持较好。\n内置监",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1721670,
    "slug": "vmware-vsphere-6-7",
    "title": "024-VMWare VSphere 6.7(ESXI,VSCA) 下载",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-05-20 21:30:00<br />tags: [云计算,虚拟化,企业级虚拟化,私有云]<br />categories: 云计算<br />---\n> 这是坚持技术写作计划（含翻译）的第24篇，定个小目标999，每周最少2篇。\n\n\n\nVSphere是一套组件的合成，类似，word,excel,ppt合称office。而ESXI是虚拟组件，虚拟机跑在ESXI上，而VSCA是vcenter,是一个集群管理软件。提供企业级功能，比如虚拟机高可用等。\n\n本文主要讲解如何下载ESXI和VSCA。\n\n<a name=\"QvLjj\"></a>\n## 下载ESXI\n\n1. 转至  [VMware vSphere Hypervisor（ESXi）6.7下载页面](https://my.vmware.com/web/vmware/evalcenter?p=free-esxi6)\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1558333257691-7387ac13-94fc-43fb-b29d-9ff232ca77c9.png#align=left&display=inline&height=531&name=image.png&originHeight=531&originWidth=1151&size=70459&status=done&width=1151)\n\n2. 登陆或者创建一个VMware账号\n2. ![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1558333321551-eae0c876-c98e-484c-8e4d-bb9b623bf3e1.png#align=left&display=inline&height=516&name=image.png&originHeight=516&originWidth=1033&size=57459&status=done&width=1033)\n2. 下载最新的6.7.0U2。\n2. 安装到硬件设备上\n2. 如果只是个人用，则可以使用上图打马赛克的个人许可证。\n\n<a name=\"gVRsU\"></a>\n## VSCA\nvcenter是企业套件，无法通过官网免费下载。通过google搜索得到<br />[https://technet24.ir/vmware-vcenter-server-6-7-13940](https://technet24.ir/vmware-vcenter-server-6-7-13940) <br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1558334332060-23ee4240-2db2-4a0f-bcf8-0bc3bb3a7bcb.png#align=left&display=inline&height=771&name=image.png&originHeight=771&originWidth=755&size=147702&status=done&width=755)<br />其实 technet24.ir 也提供EXSI ISO的下载方式\n\n注意，为了安全起见，下载后，需要去跟官网的摘要进行比对，<br />[https://my.vmware.com/cn/group/vmware/details?downloadGroup=VC67U2A&productId=742#errorCheckDiv](https://my.vmware.com/cn/group/vmware/details?downloadGroup=VC67U2A&productId=742#errorCheckDiv)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1558334892852-4ff231a2-498f-4795-aadc-9cc7e20ae821.png#align=left&display=inline&height=294&name=image.png&originHeight=294&originWidth=1480&size=49917&status=done&width=1480)\n\n安装和使用方式，参考 [Install VCSA 6.7.1](https://blog.51cto.com/happynews/2312006)\n\n<a name=\"szit3\"></a>\n## 参考资料\n\n- [VMware vSphere Hypervisor（ESXi）6.7下载页面](https://my.vmware.com/web/vmware/evalcenter?p=free-esxi6)\n- [Vmware ESXi upgrade 11月9日](https://blog.51cto.com/happynews/2316683?source=dra)\n- [Install VCSA 6.7.1](https://blog.51cto.com/happynews/2312006)\n- [VMware VCenter Server 6.7 U2a](https://technet24.ir/vmware-vcenter-server-6-7-13940)\n- [VMware ESXi Patch Tracker](https://esxi-patches.v-front.de/ESXi-6.7.0.html)\n- [VMware ESXi Image Profiles](https://www.virten.net/vmware/vmware-esxi-image-profiles/)\n- [vmware 6 虚拟化 全系列 序列号](http://www.i5i6.net/post/190.html)\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-05-20 21:30:00</p><p>tags: [云计算,虚拟化,企业级虚拟化,私有云]</p><p>categories: 云计算</p><p>---</p><blockquote><p>这是坚持技术写作计划（含翻译）的第24篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p><br /></p><p>VSphere是一套组件的合成，类似，word,excel,ppt合称office。而ESXI是虚拟组件，虚拟机跑在ESXI上，而VSCA是vcenter,是一个集群管理软件。提供企业级功能，比如虚拟机高可用等。</p><p><br /></p><p>本文主要讲解如何下载ESXI和VSCA。</p><p><br /></p><h2 id=\"QvLjj\">下载ESXI</h2><ol start=\"1\"><li>转至  <a href=\"https://my.vmware.com/web/vmware/evalcenter?p=free-esxi6\" target=\"_blank\">VMware vSphere Hypervisor（ESXi）6.7下载页面</a></li></ol><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1558333257691-7387ac13-94fc-43fb-b29d-9ff232ca77c9.png#align=left&amp;display=inline&amp;height=531&amp;name=image.png&amp;originHeight=531&amp;originWidth=1151&amp;size=70459&amp;status=done&amp;width=1151\" style=\"max-width: 600px; width: 1151px;\" /></p><ol start=\"2\"><li>登陆或者创建一个VMware账号</li><li><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1558333321551-eae0c876-c98e-484c-8e4d-bb9b623bf3e1.png#align=left&amp;display=inline&amp;height=516&amp;name=image.png&amp;originHeight=516&amp;originWidth=1033&amp;size=57459&amp;status=done&amp;width=1033\" style=\"max-width: 600px; width: 1033px;\" /></li><li>下载最新的6.7.0U2。</li><li>安装到硬件设备上</li><li>如果只是个人用，则可以使用上图打马赛克的个人许可证。</li></ol><p><br /></p><h2 id=\"gVRsU\">VSCA</h2><p>vcenter是企业套件，无法通过官网免费下载。通过google搜索得到</p><p><a href=\"https://technet24.ir/vmware-vcenter-server-6-7-13940\" target=\"_blank\">https://technet24.ir/vmware-vcenter-server-6-7-13940</a> </p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1558334332060-23ee4240-2db2-4a0f-bcf8-0bc3bb3a7bcb.png#align=left&amp;display=inline&amp;height=771&amp;name=image.png&amp;originHeight=771&amp;originWidth=755&amp;size=147702&amp;status=done&amp;width=755\" style=\"max-width: 600px; width: 755px;\" /></p><p>其实 technet24.ir 也提供EXSI ISO的下载方式</p><p><br /></p><p>注意，为了安全起见，下载后，需要去跟官网的摘要进行比对，</p><p><a href=\"https://my.vmware.com/cn/group/vmware/details?downloadGroup=VC67U2A&amp;productId=742#errorCheckDiv\" target=\"_blank\">https://my.vmware.com/cn/group/vmware/details?downloadGroup=VC67U2A&amp;productId=742#errorCheckDiv</a></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1558334892852-4ff231a2-498f-4795-aadc-9cc7e20ae821.png#align=left&amp;display=inline&amp;height=294&amp;name=image.png&amp;originHeight=294&amp;originWidth=1480&amp;size=49917&amp;status=done&amp;width=1480\" style=\"max-width: 600px; width: 1480px;\" /></p><p><br /></p><p>安装和使用方式，参考 <a href=\"https://blog.51cto.com/happynews/2312006\" target=\"_blank\">Install VCSA 6.7.1</a></p><p><br /></p><h2 id=\"szit3\">参考资料</h2><ul><li><a href=\"https://my.vmware.com/web/vmware/evalcenter?p=free-esxi6\" target=\"_blank\">VMware vSphere Hypervisor（ESXi）6.7下载页面</a></li><li><a href=\"https://blog.51cto.com/happynews/2316683?source=dra\" target=\"_blank\">Vmware ESXi upgrade 11月9日</a></li><li><a href=\"https://blog.51cto.com/happynews/2312006\" target=\"_blank\">Install VCSA 6.7.1</a></li><li><a href=\"https://technet24.ir/vmware-vcenter-server-6-7-13940\" target=\"_blank\">VMware VCenter Server 6.7 U2a</a></li><li><a href=\"https://esxi-patches.v-front.de/ESXi-6.7.0.html\" target=\"_blank\">VMware ESXi Patch Tracker</a></li><li><a href=\"https://www.virten.net/vmware/vmware-esxi-image-profiles/\" target=\"_blank\">VMware ESXi Image Profiles</a></li><li><a href=\"http://www.i5i6.net/post/190.html\" target=\"_blank\">vmware 6 虚拟化 全系列 序列号</a></li></ul>",
    "body_lake": "<!doctype lake><p>date: 2019-05-20 21:30:00</p><p>tags: [云计算,虚拟化,企业级虚拟化,私有云]</p><p>categories: 云计算</p><p>---</p><blockquote><p>这是坚持技术写作计划（含翻译）的第24篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p><br /></p><p>VSphere是一套组件的合成，类似，word,excel,ppt合称office。而ESXI是虚拟组件，虚拟机跑在ESXI上，而VSCA是vcenter,是一个集群管理软件。提供企业级功能，比如虚拟机高可用等。</p><p><br /></p><p>本文主要讲解如何下载ESXI和VSCA。</p><p><br /></p><h2 id=\"QvLjj\">下载ESXI</h2><ol start=\"1\"><li>转至  <a href=\"https://my.vmware.com/web/vmware/evalcenter?p=free-esxi6\" target=\"_blank\">VMware vSphere Hypervisor（ESXi）6.7下载页面</a></li></ol><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1558333257691-7387ac13-94fc-43fb-b29d-9ff232ca77c9.png%22%2C%22originWidth%22%3A1151%2C%22originHeight%22%3A531%2C%22name%22%3A%22image.png%22%2C%22size%22%3A70459%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1151%2C%22height%22%3A531%7D\"></card></p><ol start=\"2\"><li>登陆或者创建一个VMware账号</li><li><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1558333321551-eae0c876-c98e-484c-8e4d-bb9b623bf3e1.png%22%2C%22originWidth%22%3A1033%2C%22originHeight%22%3A516%2C%22name%22%3A%22image.png%22%2C%22size%22%3A57459%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1033%2C%22height%22%3A516%7D\"></card></li><li>下载最新的6.7.0U2。</li><li>安装到硬件设备上</li><li>如果只是个人用，则可以使用上图打马赛克的个人许可证。</li></ol><p><br /></p><h2 id=\"gVRsU\">VSCA</h2><p>vcenter是企业套件，无法通过官网免费下载。通过google搜索得到</p><p><a href=\"https://technet24.ir/vmware-vcenter-server-6-7-13940\" target=\"_blank\">https://technet24.ir/vmware-vcenter-server-6-7-13940</a> </p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1558334332060-23ee4240-2db2-4a0f-bcf8-0bc3bb3a7bcb.png%22%2C%22originWidth%22%3A755%2C%22originHeight%22%3A771%2C%22name%22%3A%22image.png%22%2C%22size%22%3A147702%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A755%2C%22height%22%3A771%7D\"></card></p><p>其实 technet24.ir 也提供EXSI ISO的下载方式</p><p><br /></p><p>注意，为了安全起见，下载后，需要去跟官网的摘要进行比对，</p><p><a href=\"https://my.vmware.com/cn/group/vmware/details?downloadGroup=VC67U2A&amp;productId=742#errorCheckDiv\" target=\"_blank\">https://my.vmware.com/cn/group/vmware/details?downloadGroup=VC67U2A&amp;productId=742#errorCheckDiv</a></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1558334892852-4ff231a2-498f-4795-aadc-9cc7e20ae821.png%22%2C%22originWidth%22%3A1480%2C%22originHeight%22%3A294%2C%22name%22%3A%22image.png%22%2C%22size%22%3A49917%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1480%2C%22height%22%3A294%7D\"></card></p><p><br /></p><p>安装和使用方式，参考 <a href=\"https://blog.51cto.com/happynews/2312006\" target=\"_blank\">Install VCSA 6.7.1</a></p><p><br /></p><h2 id=\"szit3\">参考资料</h2><ul><li><a href=\"https://my.vmware.com/web/vmware/evalcenter?p=free-esxi6\" target=\"_blank\">VMware vSphere Hypervisor（ESXi）6.7下载页面</a></li><li><a href=\"https://blog.51cto.com/happynews/2316683?source=dra\" target=\"_blank\">Vmware ESXi upgrade 11月9日</a></li><li><a href=\"https://blog.51cto.com/happynews/2312006\" target=\"_blank\">Install VCSA 6.7.1</a></li><li><a href=\"https://technet24.ir/vmware-vcenter-server-6-7-13940\" target=\"_blank\">VMware VCenter Server 6.7 U2a</a></li><li><a href=\"https://esxi-patches.v-front.de/ESXi-6.7.0.html\" target=\"_blank\">VMware ESXi Patch Tracker</a></li><li><a href=\"https://www.virten.net/vmware/vmware-esxi-image-profiles/\" target=\"_blank\">VMware ESXi Image Profiles<cursor /></a></li><li><a href=\"http://www.i5i6.net/post/190.html\" target=\"_blank\">vmware 6 虚拟化 全系列 序列号</a></li></ul>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-05-23T03:06:48.000Z",
    "deleted_at": null,
    "created_at": "2019-05-20T06:10:25.000Z",
    "updated_at": "2019-05-23T03:06:48.000Z",
    "published_at": "2019-05-23T03:06:48.000Z",
    "first_published_at": "2019-05-22T01:18:33.000Z",
    "word_count": 343,
    "cover": "",
    "description": "date: 2019-05-20 21:30:00tags: [云计算,虚拟化,企业级虚拟化,私有云]categories: 云计算---这是坚持技术写作计划（含翻译）的第24篇，定个小目标999，每周最少2篇。VSphere是一套组件的合成，类似，word,excel,ppt合称office...",
    "custom_description": "VSphere是一套组件的合成，类似，word,excel,ppt合称office。而ESXI是虚拟组件，虚拟机跑在ESXI上，而VSCA是vcenter,是一个集群管理软件。提供企业级功能，比如虚拟机高可用等。\n\n本文主要讲解如何下载ESXI和VSCA。",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1670033,
    "slug": "kylin-excel",
    "title": "022-会Excel就会数据分析(Kylin2.6.1+Excel+Power BI)",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-05-04 19:30:00<br />tags: [CDH,hadoop,大数据,KYLIN,OLAP,麒麟,Excel,PowerBI]<br />categories: 大数据<br />---\n\n> 这是坚持技术写作计划（含翻译）的第22篇，定个小目标999，每周最少2篇。\n\n\n本文主要介绍如何使用excel/power BI 连接kylin2.6.1\n\n<!-- more -->\n\n<a name=\"Sfko7\"></a>\n## 前提准备\n<a name=\"VpJrp\"></a>\n### 下载kylin odbc\napache官网已经停止提供odbc驱动了，只能从csdn等下载别人上传的，安全性毫无保证。后来转念一想，kylin的商业公司[https://kyligence.io](https://kyligence.io/)，应该会提供吧，一番打探，果然有。\n\n下载地址：[Download Kyligence ODBC Driver for Apache Kylin](https://kyligence.io/resources/kyligence-odbc-driver-for-apache-kylin-2/)\n\n需要填写邮箱进行下载\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557487637088-183279e0-8761-48b5-81d2-8fd69bce8e36.png#align=left&display=inline&height=381&name=image.png&originHeight=381&originWidth=500&size=30999&status=done&width=500)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557487684886-c42c67f8-5dee-4af2-a47d-2bdce29db157.png#align=left&display=inline&height=381&name=image.png&originHeight=381&originWidth=500&size=47222&status=done&width=500)\n\n<a name=\"H3kat\"></a>\n### 配置odbc数据源\n\nWin+R-> Control -> 管理工具 -> ODBC 数据源(64 位)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557487993106-7a08b90d-f53d-40f0-a3c9-8fdbff8611c8.png#align=left&display=inline&height=635&name=image.png&originHeight=635&originWidth=694&size=79547&status=done&width=694)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557488108032-bddd3f2f-fbfc-4e1d-a803-5c3f7a56f8f4.png#align=left&display=inline&height=425&name=image.png&originHeight=425&originWidth=400&size=17622&status=done&width=400)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557488114771-0324f0b0-c3a7-46fa-beea-170dff5e4b2d.png#align=left&display=inline&height=537&name=image.png&originHeight=537&originWidth=691&size=37086&status=done&width=691)\n\n<a name=\"FmCqE\"></a>\n### 下载powerQuery\nExcel 2016及以后版本，自带PowerQuery<br />![](https://cdn.nlark.com/yuque/0/2019/png/226273/1557488219530-ad5c7194-e6ea-4601-b243-fe8cc45a99ab.png#align=left&display=inline&height=169&originHeight=169&originWidth=368&status=done&width=368)\n\n之前版本需要自行下载 PowerQuery [https://www.microsoft.com/zh-CN/download/details.aspx?id=39379](https://www.microsoft.com/zh-CN/download/details.aspx?id=39379)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557488170637-adb0b9c1-ee8f-4be4-a9b3-ad31bda9b8db.png#align=left&display=inline&height=530&name=image.png&originHeight=530&originWidth=841&size=43855&status=done&width=841)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557488185981-9b81bcfa-3ddc-4695-9b3f-7d899748c779.png#align=left&display=inline&height=584&name=image.png&originHeight=584&originWidth=1268&size=44789&status=done&width=1268)\n\n<a name=\"Xd680\"></a>\n## Excel连接Kylin\n<a name=\"hUPDJ\"></a>\n### Excel 配置Kylin ODBC数据源\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557488301678-c1039340-d621-4384-a12e-a0b2ba8fab3f.png#align=left&display=inline&height=804&name=image.png&originHeight=804&originWidth=531&size=81563&status=done&width=531)\n\n选择刚刚配置的KylinDSN\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557488319201-dbb80bdd-e95e-4d10-8bd0-5d13ffd14837.png#align=left&display=inline&height=215&name=image.png&originHeight=215&originWidth=698&size=13399&status=done&width=698)<br />填入用户名密码\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557488426650-7fd3f229-c5d3-4daa-a495-787e6c946a08.png#align=left&display=inline&height=323&name=image.png&originHeight=323&originWidth=698&size=23403&status=done&width=698)\n\n可以选择表进行预览<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557488441858-b8aabe15-7ac5-43c9-a7d1-154fbe70eafb.png#align=left&display=inline&height=698&name=image.png&originHeight=698&originWidth=878&size=76847&status=done&width=878)<br />点击加载按钮进行加载<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557488523780-b064229f-f003-4e0f-b125-08c8779b9eef.png#align=left&display=inline&height=640&name=image.png&originHeight=640&originWidth=1889&size=150632&status=done&width=1889)\n\n<a name=\"ioP6f\"></a>\n## PowerBI连接Kylin\n\n<a name=\"yCfu7\"></a>\n### 下载并安装PowerBI\n下载地址 [https://www.microsoft.com/zh-CN/download/details.aspx?id=45331](https://www.microsoft.com/zh-CN/download/details.aspx?id=45331)\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1558174065280-896bf454-a7cf-4ef0-af43-3053909c9b2e.png#align=left&display=inline&height=578&name=image.png&originHeight=578&originWidth=1098&size=82713&status=done&width=1098)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1558174108812-155f3b80-e2ad-4e9d-90b6-07ebe2a55c43.png#align=left&display=inline&height=663&name=image.png&originHeight=663&originWidth=610&size=47135&status=done&width=610)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1558174120855-4ec58da8-296b-446d-a2aa-45845dd377d9.png#align=left&display=inline&height=221&name=image.png&originHeight=221&originWidth=700&size=11194&status=done&width=700)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1558174179132-030a7763-fc1a-48fa-bb1a-8de1b5ff060e.png#align=left&display=inline&height=699&name=image.png&originHeight=699&originWidth=879&size=53708&status=done&width=879)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1558175521076-b79af7e2-3efb-48b5-9768-36d6d38102ca.png#align=left&display=inline&height=729&name=image.png&originHeight=729&originWidth=1850&size=101592&status=done&width=1850)\n\n<a name=\"QzhkV\"></a>\n## 参考资料\n\n- [Excel 及 Power BI 教程](http://kylin.apache.org/cn/docs/tutorial/powerbi.html)\n- [Power BI Desktop 入门](https://docs.microsoft.com/zh-cn/power-bi/guided-learning/gettingdata?tutorial-step=2)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。<br />长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-05-04 19:30:00</p><p>tags: [CDH,hadoop,大数据,KYLIN,OLAP,麒麟,Excel,PowerBI]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第22篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要介绍如何使用excel/power BI 连接kylin2.6.1</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"Sfko7\">前提准备</h2><h3 id=\"VpJrp\">下载kylin odbc</h3><p>apache官网已经停止提供odbc驱动了，只能从csdn等下载别人上传的，安全性毫无保证。后来转念一想，kylin的商业公司<a href=\"https://kyligence.io/\" target=\"_blank\">https://kyligence.io</a>，应该会提供吧，一番打探，果然有。</p><p><br /></p><p>下载地址：<a href=\"https://kyligence.io/resources/kyligence-odbc-driver-for-apache-kylin-2/\" target=\"_blank\">Download Kyligence ODBC Driver for Apache Kylin</a></p><p><br /></p><p>需要填写邮箱进行下载</p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557487637088-183279e0-8761-48b5-81d2-8fd69bce8e36.png#align=left&amp;display=inline&amp;height=381&amp;name=image.png&amp;originHeight=381&amp;originWidth=500&amp;size=30999&amp;status=done&amp;width=500\" style=\"max-width: 600px; width: 500px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557487684886-c42c67f8-5dee-4af2-a47d-2bdce29db157.png#align=left&amp;display=inline&amp;height=381&amp;name=image.png&amp;originHeight=381&amp;originWidth=500&amp;size=47222&amp;status=done&amp;width=500\" style=\"max-width: 600px; width: 500px;\" /></p><p><br /></p><h3 id=\"H3kat\">配置odbc数据源</h3><p><br /></p><p>Win+R-&gt; Control -&gt; 管理工具 -&gt; ODBC 数据源(64 位)</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557487993106-7a08b90d-f53d-40f0-a3c9-8fdbff8611c8.png#align=left&amp;display=inline&amp;height=635&amp;name=image.png&amp;originHeight=635&amp;originWidth=694&amp;size=79547&amp;status=done&amp;width=694\" style=\"max-width: 600px; width: 694px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557488108032-bddd3f2f-fbfc-4e1d-a803-5c3f7a56f8f4.png#align=left&amp;display=inline&amp;height=425&amp;name=image.png&amp;originHeight=425&amp;originWidth=400&amp;size=17622&amp;status=done&amp;width=400\" style=\"max-width: 600px; width: 400px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557488114771-0324f0b0-c3a7-46fa-beea-170dff5e4b2d.png#align=left&amp;display=inline&amp;height=537&amp;name=image.png&amp;originHeight=537&amp;originWidth=691&amp;size=37086&amp;status=done&amp;width=691\" style=\"max-width: 600px; width: 691px;\" /></p><p><br /></p><h3 id=\"FmCqE\">下载powerQuery</h3><p>Excel 2016及以后版本，自带PowerQuery</p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557488219530-ad5c7194-e6ea-4601-b243-fe8cc45a99ab.png#align=left&amp;display=inline&amp;height=169&amp;originHeight=169&amp;originWidth=368&amp;status=done&amp;width=368\" style=\"max-width: 600px; width: 368px;\" /></p><p><br /></p><p>之前版本需要自行下载 PowerQuery <a href=\"https://www.microsoft.com/zh-CN/download/details.aspx?id=39379\" target=\"_blank\">https://www.microsoft.com/zh-CN/download/details.aspx?id=39379</a></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557488170637-adb0b9c1-ee8f-4be4-a9b3-ad31bda9b8db.png#align=left&amp;display=inline&amp;height=530&amp;name=image.png&amp;originHeight=530&amp;originWidth=841&amp;size=43855&amp;status=done&amp;width=841\" style=\"max-width: 600px; width: 841px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557488185981-9b81bcfa-3ddc-4695-9b3f-7d899748c779.png#align=left&amp;display=inline&amp;height=584&amp;name=image.png&amp;originHeight=584&amp;originWidth=1268&amp;size=44789&amp;status=done&amp;width=1268\" style=\"max-width: 600px; width: 1268px;\" /></p><p><br /></p><h2 id=\"Xd680\">Excel连接Kylin</h2><h3 id=\"hUPDJ\">Excel 配置Kylin ODBC数据源</h3><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557488301678-c1039340-d621-4384-a12e-a0b2ba8fab3f.png#align=left&amp;display=inline&amp;height=804&amp;name=image.png&amp;originHeight=804&amp;originWidth=531&amp;size=81563&amp;status=done&amp;width=531\" style=\"max-width: 600px; width: 531px;\" /></p><p><br /></p><p>选择刚刚配置的KylinDSN</p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557488319201-dbb80bdd-e95e-4d10-8bd0-5d13ffd14837.png#align=left&amp;display=inline&amp;height=215&amp;name=image.png&amp;originHeight=215&amp;originWidth=698&amp;size=13399&amp;status=done&amp;width=698\" style=\"max-width: 600px; width: 698px;\" /></p><p>填入用户名密码</p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557488426650-7fd3f229-c5d3-4daa-a495-787e6c946a08.png#align=left&amp;display=inline&amp;height=323&amp;name=image.png&amp;originHeight=323&amp;originWidth=698&amp;size=23403&amp;status=done&amp;width=698\" style=\"max-width: 600px; width: 698px;\" /></p><p><br /></p><p>可以选择表进行预览</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557488441858-b8aabe15-7ac5-43c9-a7d1-154fbe70eafb.png#align=left&amp;display=inline&amp;height=698&amp;name=image.png&amp;originHeight=698&amp;originWidth=878&amp;size=76847&amp;status=done&amp;width=878\" style=\"max-width: 600px; width: 878px;\" /></p><p>点击加载按钮进行加载</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557488523780-b064229f-f003-4e0f-b125-08c8779b9eef.png#align=left&amp;display=inline&amp;height=640&amp;name=image.png&amp;originHeight=640&amp;originWidth=1889&amp;size=150632&amp;status=done&amp;width=1889\" style=\"max-width: 600px; width: 1889px;\" /></p><p><br /></p><h2 id=\"ioP6f\">PowerBI连接Kylin</h2><p><br /></p><h3 id=\"yCfu7\">下载并安装PowerBI</h3><p>下载地址 <a href=\"https://www.microsoft.com/zh-CN/download/details.aspx?id=45331\" target=\"_blank\">https://www.microsoft.com/zh-CN/download/details.aspx?id=45331</a></p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1558174065280-896bf454-a7cf-4ef0-af43-3053909c9b2e.png#align=left&amp;display=inline&amp;height=578&amp;name=image.png&amp;originHeight=578&amp;originWidth=1098&amp;size=82713&amp;status=done&amp;width=1098\" style=\"max-width: 600px; width: 1098px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1558174108812-155f3b80-e2ad-4e9d-90b6-07ebe2a55c43.png#align=left&amp;display=inline&amp;height=663&amp;name=image.png&amp;originHeight=663&amp;originWidth=610&amp;size=47135&amp;status=done&amp;width=610\" style=\"max-width: 600px; width: 610px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1558174120855-4ec58da8-296b-446d-a2aa-45845dd377d9.png#align=left&amp;display=inline&amp;height=221&amp;name=image.png&amp;originHeight=221&amp;originWidth=700&amp;size=11194&amp;status=done&amp;width=700\" style=\"max-width: 600px; width: 700px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1558174179132-030a7763-fc1a-48fa-bb1a-8de1b5ff060e.png#align=left&amp;display=inline&amp;height=699&amp;name=image.png&amp;originHeight=699&amp;originWidth=879&amp;size=53708&amp;status=done&amp;width=879\" style=\"max-width: 600px; width: 879px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1558175521076-b79af7e2-3efb-48b5-9768-36d6d38102ca.png#align=left&amp;display=inline&amp;height=729&amp;name=image.png&amp;originHeight=729&amp;originWidth=1850&amp;size=101592&amp;status=done&amp;width=1850\" style=\"max-width: 600px; width: 1850px;\" /></p><p><br /></p><h2 id=\"QzhkV\">参考资料</h2><ul><li><a href=\"http://kylin.apache.org/cn/docs/tutorial/powerbi.html\" target=\"_blank\">Excel 及 Power BI 教程</a></li><li><a href=\"https://docs.microsoft.com/zh-cn/power-bi/guided-learning/gettingdata?tutorial-step=2\" target=\"_blank\">Power BI Desktop 入门</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p>",
    "body_lake": "<!doctype lake><p>date: 2019-05-04 19:30:00</p><p>tags: [CDH,hadoop,大数据,KYLIN,OLAP,麒麟,Excel,PowerBI]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第22<cursor />篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要介绍如何使用excel/power BI 连接kylin2.6.1</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"Sfko7\">前提准备</h2><h3 id=\"VpJrp\">下载kylin odbc</h3><p>apache官网已经停止提供odbc驱动了，只能从csdn等下载别人上传的，安全性毫无保证。后来转念一想，kylin的商业公司<a href=\"https://kyligence.io/\" target=\"_blank\">https://kyligence.io</a>，应该会提供吧，一番打探，果然有。</p><p><br /></p><p>下载地址：<a href=\"https://kyligence.io/resources/kyligence-odbc-driver-for-apache-kylin-2/\" target=\"_blank\">Download Kyligence ODBC Driver for Apache Kylin</a></p><p><br /></p><p>需要填写邮箱进行下载</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557487637088-183279e0-8761-48b5-81d2-8fd69bce8e36.png%22%2C%22originWidth%22%3A500%2C%22originHeight%22%3A381%2C%22name%22%3A%22image.png%22%2C%22size%22%3A30999%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A500%2C%22height%22%3A381%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557487684886-c42c67f8-5dee-4af2-a47d-2bdce29db157.png%22%2C%22originWidth%22%3A500%2C%22originHeight%22%3A381%2C%22name%22%3A%22image.png%22%2C%22size%22%3A47222%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A500%2C%22height%22%3A381%7D\"></card></p><p><br /></p><h3 id=\"H3kat\">配置odbc数据源</h3><p><br /></p><p>Win+R-&gt; Control -&gt; 管理工具 -&gt; ODBC 数据源(64 位)</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557487993106-7a08b90d-f53d-40f0-a3c9-8fdbff8611c8.png%22%2C%22originWidth%22%3A694%2C%22originHeight%22%3A635%2C%22name%22%3A%22image.png%22%2C%22size%22%3A79547%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A694%2C%22height%22%3A635%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557488108032-bddd3f2f-fbfc-4e1d-a803-5c3f7a56f8f4.png%22%2C%22originWidth%22%3A400%2C%22originHeight%22%3A425%2C%22name%22%3A%22image.png%22%2C%22size%22%3A17622%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A400%2C%22height%22%3A425%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557488114771-0324f0b0-c3a7-46fa-beea-170dff5e4b2d.png%22%2C%22originWidth%22%3A691%2C%22originHeight%22%3A537%2C%22name%22%3A%22image.png%22%2C%22size%22%3A37086%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A691%2C%22height%22%3A537%7D\"></card></p><p><br /></p><h3 id=\"FmCqE\">下载powerQuery</h3><p>Excel 2016及以后版本，自带PowerQuery</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557488219530-ad5c7194-e6ea-4601-b243-fe8cc45a99ab.png%22%2C%22originWidth%22%3A368%2C%22originHeight%22%3A169%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A368%2C%22height%22%3A169%7D\"></card></p><p><br /></p><p>之前版本需要自行下载 PowerQuery <a href=\"https://www.microsoft.com/zh-CN/download/details.aspx?id=39379\" target=\"_blank\">https://www.microsoft.com/zh-CN/download/details.aspx?id=39379</a></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557488170637-adb0b9c1-ee8f-4be4-a9b3-ad31bda9b8db.png%22%2C%22originWidth%22%3A841%2C%22originHeight%22%3A530%2C%22name%22%3A%22image.png%22%2C%22size%22%3A43855%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A841%2C%22height%22%3A530%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557488185981-9b81bcfa-3ddc-4695-9b3f-7d899748c779.png%22%2C%22originWidth%22%3A1268%2C%22originHeight%22%3A584%2C%22name%22%3A%22image.png%22%2C%22size%22%3A44789%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1268%2C%22height%22%3A584%7D\"></card></p><p><br /></p><h2 id=\"Xd680\">Excel连接Kylin</h2><h3 id=\"hUPDJ\">Excel 配置Kylin ODBC数据源</h3><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557488301678-c1039340-d621-4384-a12e-a0b2ba8fab3f.png%22%2C%22originWidth%22%3A531%2C%22originHeight%22%3A804%2C%22name%22%3A%22image.png%22%2C%22size%22%3A81563%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A531%2C%22height%22%3A804%7D\"></card></p><p><br /></p><p>选择刚刚配置的KylinDSN</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557488319201-dbb80bdd-e95e-4d10-8bd0-5d13ffd14837.png%22%2C%22originWidth%22%3A698%2C%22originHeight%22%3A215%2C%22name%22%3A%22image.png%22%2C%22size%22%3A13399%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A698%2C%22height%22%3A215%7D\"></card></p><p>填入用户名密码</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557488426650-7fd3f229-c5d3-4daa-a495-787e6c946a08.png%22%2C%22originWidth%22%3A698%2C%22originHeight%22%3A323%2C%22name%22%3A%22image.png%22%2C%22size%22%3A23403%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A698%2C%22height%22%3A323%7D\"></card></p><p><br /></p><p>可以选择表进行预览</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557488441858-b8aabe15-7ac5-43c9-a7d1-154fbe70eafb.png%22%2C%22originWidth%22%3A878%2C%22originHeight%22%3A698%2C%22name%22%3A%22image.png%22%2C%22size%22%3A76847%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A878%2C%22height%22%3A698%7D\"></card></p><p>点击加载按钮进行加载</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557488523780-b064229f-f003-4e0f-b125-08c8779b9eef.png%22%2C%22originWidth%22%3A1889%2C%22originHeight%22%3A640%2C%22name%22%3A%22image.png%22%2C%22size%22%3A150632%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1889%2C%22height%22%3A640%7D\"></card></p><p><br /></p><h2 id=\"ioP6f\">PowerBI连接Kylin</h2><p><br /></p><h3 id=\"yCfu7\">下载并安装PowerBI</h3><p>下载地址 <a href=\"https://www.microsoft.com/zh-CN/download/details.aspx?id=45331\" target=\"_blank\">https://www.microsoft.com/zh-CN/download/details.aspx?id=45331</a></p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1558174065280-896bf454-a7cf-4ef0-af43-3053909c9b2e.png%22%2C%22originWidth%22%3A1098%2C%22originHeight%22%3A578%2C%22name%22%3A%22image.png%22%2C%22size%22%3A82713%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1098%2C%22height%22%3A578%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1558174108812-155f3b80-e2ad-4e9d-90b6-07ebe2a55c43.png%22%2C%22originWidth%22%3A610%2C%22originHeight%22%3A663%2C%22name%22%3A%22image.png%22%2C%22size%22%3A47135%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A610%2C%22height%22%3A663%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1558174120855-4ec58da8-296b-446d-a2aa-45845dd377d9.png%22%2C%22originWidth%22%3A700%2C%22originHeight%22%3A221%2C%22name%22%3A%22image.png%22%2C%22size%22%3A11194%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A700%2C%22height%22%3A221%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1558174179132-030a7763-fc1a-48fa-bb1a-8de1b5ff060e.png%22%2C%22originWidth%22%3A879%2C%22originHeight%22%3A699%2C%22name%22%3A%22image.png%22%2C%22size%22%3A53708%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A879%2C%22height%22%3A699%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1558175521076-b79af7e2-3efb-48b5-9768-36d6d38102ca.png%22%2C%22originWidth%22%3A1850%2C%22originHeight%22%3A729%2C%22name%22%3A%22image.png%22%2C%22size%22%3A101592%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1850%2C%22height%22%3A729%7D\"></card></p><p><br /></p><h2 id=\"QzhkV\">参考资料</h2><ul><li><a href=\"http://kylin.apache.org/cn/docs/tutorial/powerbi.html\" target=\"_blank\">Excel 及 Power BI 教程</a></li><li><a href=\"https://docs.microsoft.com/zh-cn/power-bi/guided-learning/gettingdata?tutorial-step=2\" target=\"_blank\">Power BI Desktop 入门</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-05-18T10:43:37.000Z",
    "deleted_at": null,
    "created_at": "2019-05-10T11:21:27.000Z",
    "updated_at": "2019-05-20T06:41:34.000Z",
    "published_at": "2019-05-18T10:43:37.000Z",
    "first_published_at": "2019-05-18T10:33:22.000Z",
    "word_count": 354,
    "cover": "",
    "description": "date: 2019-05-04 19:30:00tags: [CDH,hadoop,大数据,KYLIN,OLAP,麒麟,Excel,PowerBI]categories: 大数据---这是坚持技术写作计划（含翻译）的第22篇，定个小目标999，每周最少2篇。本文主要介绍如何使用excel/p...",
    "custom_description": "本文主要介绍如何使用excel/power BI 连接kylin2.6.1",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1668285,
    "slug": "cm6-kylin",
    "title": "021-cdh6.2+kylin2.6.2",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-05-03 20:00:01<br />tags: [CDH,hadoop,大数据,KYLIN,OLAP,麒麟]<br />categories: 大数据<br />---\n\n> 这是坚持技术写作计划（含翻译）的第21篇，定个小目标999，每周最少2篇。\n\n\n本文主要介绍，如何使用大数据神兽Kylin(2.6.2)连接cdh6.2。\n\n<!-- more -->\n\n<a name=\"kHqRf\"></a>\n## 提示\n\n- 因为cdh6.2使用的是hadoop3，而目前的kylin3.0beta版本只是hadoop2,所以只能安装kylin2.5+,此处选择kylin2.6.2-cdh60（cdh6.0版）\n\n<a name=\"0cU6y\"></a>\n## 安装kylin\n<a name=\"ZtEd1\"></a>\n### 下载kylin2.6.2二进制包\n\n```bash\nwget http://mirrors.tuna.tsinghua.edu.cn/apache/kylin/apache-kylin-2.6.2/apache-kylin-2.6.2-bin-cdh60.tar.gz\ntar zxf apache-kylin-2.6.2-bin-cdh60.tar.gz -C /usr/local/\nln -s /usr/local/apache-kylin-2.6.2-bin-cdh60 /usr/local/kylin\n```\n\n<a name=\"NtEtw\"></a>\n### 配置kylin环境变量\n\n```bash\ncat << EOF | sudo tee -a /etc/profile\n#设置java环境\nexport JAVA_HOME=/usr/java/jdk1.8.0_181-cloudera/\nexport CLASSPATH=.:\\$JAVA_HOME/lib:\\$JAVA_HOME/jre/lib:\\$CLASSPATH\nexport KYLIN_HOME=/usr/local/kylin\nexport PATH=\\$JAVA_HOME/bin:\\$JAVA_HOME/jre/bin:\\$PATH\nexport CDH_HOME=/opt/cloudera/parcels/CDH\nexport HBASE_HOME=\\${CDH_HOME}/lib/hbase\nexport HBASE_CLASSPATH=\\${HBASE_HOME}/lib/hbase-common-2.1.0-cdh6.2.0.jar\nEOF\nsource /etc/profile\n```\n\n如果不加 `$HBASE_HOME` 会报 `hbase-common lib not found` \n\n```\nRetrieving hadoop conf dir...\nKYLIN_HOME is set to /usr/local/kylin\nRetrieving hive dependency...\nRetrieving hbase dependency...\nError: Could not find or load main class org.apache.hadoop.hbase.util.GetJavaProperty\nhbase-common lib not found\n```\n\n<a name=\"8xtqi\"></a>\n### 在hdfs创建kylin和spark目录\n\n```bash\nexport HADOOP_USER_NAME=hdfs\n```\n\n否则会报\n```bash\n$KYLIN_HOME/bin/check-env.sh\nRetrieving hadoop conf dir...\nError: Could not find or load main class org.apache.hadoop.hbase.util.GetJavaProperty\nKYLIN_HOME is set to /usr/local/kylin\nmkdir: Permission denied: user=root, access=WRITE, inode=\"/kylin\":hdfs:supergroup:drwxr-xr-x\nFailed to create hdfs:///kylin/spark-history. Please make sure the user has right to access hdfs:///kylin/spark-history\n```\n\n```bash\nyum install -y net-tools\n```\n <br />否则会报\n```bash\n$KYLIN_HOME/bin/check-env.sh\nRetrieving hadoop conf dir...\nError: Could not find or load main class org.apache.hadoop.hbase.util.GetJavaProperty\nKYLIN_HOME is set to /usr/local/kylin\n/usr/local/kylin/bin/check-port-availability.sh: line 27: netstat: command not found\n```\n\n<a name=\"7pUpu\"></a>\n### 下载spark\n\n```bash\n$KYLIN_HOME/bin/download-spark.sh\n```\n否则会报 \n\n```bash\n$KYLIN_HOME/bin/kylin.sh start\nRetrieving hadoop conf dir...\n错误: 找不到或无法加载主类 org.apache.hadoop.hbase.util.GetJavaProperty\nKYLIN_HOME is set to /usr/local/kylin\nRetrieving hive dependency...\nRetrieving hbase dependency...\n错误: 找不到或无法加载主类 org.apache.hadoop.hbase.util.GetJavaProperty\nRetrieving hadoop conf dir...\n错误: 找不到或无法加载主类 org.apache.hadoop.hbase.util.GetJavaProperty\nRetrieving kafka dependency...\nRetrieving Spark dependency...\nspark not found, set SPARK_HOME, or run bin/download-spark.sh\n```\n\n如果知己指定了不兼容的spark版本，可能会导致404，参考 [Kylin web UI http 404 error](https://issues.apache.org/jira/browse/KYLIN-3872)\n\n<a name=\"xQuTy\"></a>\n### 启动kylin\n\n```bash\n$KYLIN_HOME/bin/kylin.sh start\n```\n如果成功会输出\n\n```\nA new Kylin instance is started by root. To stop it, run 'kylin.sh stop'\nCheck the log at /usr/local/kylin/logs/kylin.log\nWeb UI is at http://<hostname>:7070/kylin\n```\n浏览器打开 http://IP:7070/kylin ，用户名密码是 `ADMIN/KYLIN` <br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557482549401-ccd81caf-6b9f-4dad-8899-1262307ef09a.png#align=left&display=inline&height=445&name=image.png&originHeight=445&originWidth=822&size=19890&status=done&width=822)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557482608635-8a90d635-862f-4695-b3b7-93c634267a5c.png#align=left&display=inline&height=738&name=image.png&originHeight=738&originWidth=979&size=46329&status=done&width=979)\n\n<a name=\"a3XdE\"></a>\n## 使用kylin(以官方demo演示)\n<a name=\"kCo8L\"></a>\n### 导入数据\n\n```bash\n$KYLIN_HOME/bin/sample.sh\n\nRetrieving hadoop conf dir...\nError: Could not find or load main class org.apache.hadoop.hbase.util.GetJavaProperty\nLoading sample data into HDFS tmp path: /tmp/kylin/sample_cube/data\nGoing to create sample tables in hive to database DEFAULT by cli\nWARNING: Use \"yarn jar\" to launch YARN applications.\nSLF4J: Class path contains multiple SLF4J bindings.\nSLF4J: Found binding in [jar:file:/opt/cloudera/parcels/CDH-6.2.0-1.cdh6.2.0.p0.967373/jars/log4j-slf4j-impl-2.8.2.jar!/org/slf4j/impl/StaticLoggerBinder.class]\nSLF4J: Found binding in [jar:file:/opt/cloudera/parcels/CDH-6.2.0-1.cdh6.2.0.p0.967373/jars/slf4j-log4j12-1.7.25.jar!/org/slf4j/impl/StaticLoggerBinder.class]\nSLF4J: See http://www.slf4j.org/codes.html#multiple_bindings for an explanation.\nSLF4J: Actual binding is of type [org.apache.logging.slf4j.Log4jLoggerFactory]\n\nLogging initialized using configuration in jar:file:/opt/cloudera/parcels/CDH-6.2.0-1.cdh6.2.0.p0.967373/jars/hive-common-2.1.1-cdh6.2.0.jar!/hive-log4j2.properties Async: false\nOK\n//....\nSample cube is created successfully in project 'learn_kylin'.\n\n** Restart Kylin Server or click Web UI => System Tab => Reload Metadata to take effect **\n\n```\n\n<a name=\"aQUhJ\"></a>\n### 重新加载元数据\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557483583704-c21d7c5b-00b8-4d77-a50f-dc8fd534fe86.png#align=left&display=inline&height=581&name=image.png&originHeight=581&originWidth=1641&size=124786&status=done&width=1641)<br />选择 learn_kylin\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557483605102-3911751e-a861-4754-9dca-3b0311657f55.png#align=left&display=inline&height=149&name=image.png&originHeight=149&originWidth=222&size=7898&status=done&width=222)\n<a name=\"UmJvr\"></a>\n### 构建Cube\n选择 Model，选择kylin_sales_model,选择build<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557483714167-c3f0370c-7a1a-4f46-a532-8123b4d4b9f6.png#align=left&display=inline&height=642&name=image.png&originHeight=642&originWidth=1901&size=80161&status=done&width=1901)<br />此处选择起止日期。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557483733469-dae19d83-b08a-4d72-9a05-1de253703e9f.png#align=left&display=inline&height=365&name=image.png&originHeight=365&originWidth=1512&size=26543&status=done&width=1512)<br />如果没关闭hdfs权限校验，此处肯定会build失败。可以通过右侧 `>` 图标点击查看进度。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557486437790-8e1c97a3-aebb-4866-857a-8ef3f0848d0c.png#align=left&display=inline&height=427&name=image.png&originHeight=427&originWidth=1871&size=53965&status=done&width=1871)<br />build成功后，回到Insight界面，此时已经成功构建出5张表了。\n\n<a name=\"PBL8A\"></a>\n### 讲解demo表\nKylin的示例是销售业务分析\n\n- KYLIN_SALES 事实表，存有销售订单的详细信息(卖家，商品分类，订单金额，商品数量等)\n- KYLIN_COUNTRY 维度表，存有国家信息(简写，名称等)\n- KYLIN_CATEGORY_GROUPINGS 维度表，存有商品分类的详细介绍(分类名称等)\n- KYLIN_CAL_DT 维度表，存有时间扩展信息(日期所在年始，月始，周始，年份，月份等)\n- KYLIN_ACCOUNT 维度表，存有账户信息(账户id，卖家等级，买家等级，国家等)\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557486460421-1d88684e-825c-420d-9fdd-9e9717c28cb6.png#align=left&display=inline&height=576&name=image.png&originHeight=576&originWidth=1102&size=47232&status=done&width=1102)\n\n<a name=\"5dwAT\"></a>\n### 运行查询语句\n执行 `select count(1) from kylin_sales` 点击submit，下方会显示执行结果，以及执行耗时(此处是1.8秒)。kylin会缓存执行结果，再次执行发现变成了0.18秒<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557486561989-c58f3430-7336-49dc-9b47-14c68fb8c6d6.png#align=left&display=inline&height=771&name=image.png&originHeight=771&originWidth=1870&size=80062&status=done&width=1870)<br />执行稍微复杂的SQL语句\n\n```sql\nselect sum(KYLIN_SALES.PRICE) \nas price_sum,KYLIN_CATEGORY_GROUPINGS.META_CATEG_NAME,KYLIN_CATEGORY_GROUPINGS.CATEG_LVL2_NAME \nfrom KYLIN_SALES inner join KYLIN_CATEGORY_GROUPINGS\non KYLIN_SALES.LEAF_CATEG_ID = KYLIN_CATEGORY_GROUPINGS.LEAF_CATEG_ID and \nKYLIN_SALES.LSTG_SITE_ID = KYLIN_CATEGORY_GROUPINGS.SITE_ID\ngroup by KYLIN_CATEGORY_GROUPINGS.META_CATEG_NAME,KYLIN_CATEGORY_GROUPINGS.CATEG_LVL2_NAME\norder by KYLIN_CATEGORY_GROUPINGS.META_CATEG_NAME asc,KYLIN_CATEGORY_GROUPINGS.CATEG_LVL2_NAME desc\n```\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1558172952282-191a44d2-d434-4aad-8eff-da8cb6f8fc76.png#align=left&display=inline&height=586&name=image.png&originHeight=586&originWidth=1456&size=63114&status=done&width=1456)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1558172990808-29ba9fd6-dfab-4835-84df-c98c6fa80fb7.png#align=left&display=inline&height=638&name=image.png&originHeight=638&originWidth=1536&size=68562&status=done&width=1536)自带简单的可视化。\n\n<a name=\"jXA3N\"></a>\n## 参考资料\n\n- [如何在CDH中部署及使用Kylin](https://mp.weixin.qq.com/s?__biz=MzI4OTY3MTUyNg==&mid=2247489540&idx=1&sn=a9a2c9bbb065987cd8756635c146800d)\n- [Kylin web UI http 404 error](https://issues.apache.org/jira/browse/KYLIN-3872)\n- [Kylin 2.6.1 on Ambari 2.7.1.0 花式踩坑集锦](https://zhuanlan.zhihu.com/p/62187552)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。<br />长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-05-03 20:00:01</p><p>tags: [CDH,hadoop,大数据,KYLIN,OLAP,麒麟]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第21篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要介绍，如何使用大数据神兽Kylin(2.6.2)连接cdh6.2。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"kHqRf\">提示</h2><p><br /></p><ul><li>因为cdh6.2使用的是hadoop3，而目前的kylin3.0beta版本只是hadoop2,所以只能安装kylin2.5+,此处选择kylin2.6.2-cdh60（cdh6.0版）</li></ul><p><br /></p><h2 id=\"0cU6y\">安装kylin</h2><h3 id=\"ZtEd1\">下载kylin2.6.2二进制包</h3><p><br /></p><pre data-lang=\"bash\"><code>wget http://mirrors.tuna.tsinghua.edu.cn/apache/kylin/apache-kylin-2.6.2/apache-kylin-2.6.2-bin-cdh60.tar.gz\ntar zxf apache-kylin-2.6.2-bin-cdh60.tar.gz -C /usr/local/\nln -s /usr/local/apache-kylin-2.6.2-bin-cdh60 /usr/local/kylin</code></pre><p><br /></p><h3 id=\"NtEtw\">配置kylin环境变量</h3><p><br /></p><pre data-lang=\"bash\"><code>cat &lt;&lt; EOF | sudo tee -a /etc/profile\n#设置java环境\nexport JAVA_HOME=/usr/java/jdk1.8.0_181-cloudera/\nexport CLASSPATH=.:\\$JAVA_HOME/lib:\\$JAVA_HOME/jre/lib:\\$CLASSPATH\nexport KYLIN_HOME=/usr/local/kylin\nexport PATH=\\$JAVA_HOME/bin:\\$JAVA_HOME/jre/bin:\\$PATH\nexport CDH_HOME=/opt/cloudera/parcels/CDH\nexport HBASE_HOME=\\${CDH_HOME}/lib/hbase\nexport HBASE_CLASSPATH=\\${HBASE_HOME}/lib/hbase-common-2.1.0-cdh6.2.0.jar\nEOF\nsource /etc/profile</code></pre><p><br /></p><p>如果不加 <code>$HBASE_HOME</code> 会报 <code>hbase-common lib not found</code> </p><p><br /></p><pre><code>Retrieving hadoop conf dir...\nKYLIN_HOME is set to /usr/local/kylin\nRetrieving hive dependency...\nRetrieving hbase dependency...\nError: Could not find or load main class org.apache.hadoop.hbase.util.GetJavaProperty\nhbase-common lib not found</code></pre><p><br /></p><h3 id=\"8xtqi\">在hdfs创建kylin和spark目录</h3><p><br /></p><pre data-lang=\"bash\"><code>export HADOOP_USER_NAME=hdfs</code></pre><p><br /></p><p>否则会报</p><pre data-lang=\"bash\"><code>$KYLIN_HOME/bin/check-env.sh\nRetrieving hadoop conf dir...\nError: Could not find or load main class org.apache.hadoop.hbase.util.GetJavaProperty\nKYLIN_HOME is set to /usr/local/kylin\nmkdir: Permission denied: user=root, access=WRITE, inode=&quot;/kylin&quot;:hdfs:supergroup:drwxr-xr-x\nFailed to create hdfs:///kylin/spark-history. Please make sure the user has right to access hdfs:///kylin/spark-history</code></pre><p><br /></p><pre data-lang=\"bash\"><code>yum install -y net-tools</code></pre><p> </p><p><span style=\"background-color: transparent;\">否则会报</span></p><pre data-lang=\"bash\"><code>$KYLIN_HOME/bin/check-env.sh\nRetrieving hadoop conf dir...\nError: Could not find or load main class org.apache.hadoop.hbase.util.GetJavaProperty\nKYLIN_HOME is set to /usr/local/kylin\n/usr/local/kylin/bin/check-port-availability.sh: line 27: netstat: command not found</code></pre><p><br /></p><h3 id=\"7pUpu\">下载spark</h3><p><br /></p><pre data-lang=\"bash\"><code>$KYLIN_HOME/bin/download-spark.sh</code></pre><p>否则会报 </p><p><br /></p><pre data-lang=\"bash\"><code>$KYLIN_HOME/bin/kylin.sh start\nRetrieving hadoop conf dir...\n错误: 找不到或无法加载主类 org.apache.hadoop.hbase.util.GetJavaProperty\nKYLIN_HOME is set to /usr/local/kylin\nRetrieving hive dependency...\nRetrieving hbase dependency...\n错误: 找不到或无法加载主类 org.apache.hadoop.hbase.util.GetJavaProperty\nRetrieving hadoop conf dir...\n错误: 找不到或无法加载主类 org.apache.hadoop.hbase.util.GetJavaProperty\nRetrieving kafka dependency...\nRetrieving Spark dependency...\nspark not found, set SPARK_HOME, or run bin/download-spark.sh</code></pre><p><br /></p><p>如果知己指定了不兼容的spark版本，可能会导致404，参考 <a href=\"https://issues.apache.org/jira/browse/KYLIN-3872\" target=\"_blank\">Kylin web UI http 404 error</a></p><p><br /></p><h3 id=\"xQuTy\">启动kylin</h3><p><br /></p><pre data-lang=\"bash\"><code>$KYLIN_HOME/bin/kylin.sh start</code></pre><p>如果成功会输出</p><p><br /></p><pre><code>A new Kylin instance is started by root. To stop it, run 'kylin.sh stop'\nCheck the log at /usr/local/kylin/logs/kylin.log\nWeb UI is at http://&lt;hostname&gt;:7070/kylin</code></pre><p>浏览器打开 http://IP:7070/kylin ，用户名密码是 <code>ADMIN/KYLIN</code> </p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557482549401-ccd81caf-6b9f-4dad-8899-1262307ef09a.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=822&amp;size=19890&amp;status=done&amp;width=822\" style=\"max-width: 600px; width: 822px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557482608635-8a90d635-862f-4695-b3b7-93c634267a5c.png#align=left&amp;display=inline&amp;height=738&amp;name=image.png&amp;originHeight=738&amp;originWidth=979&amp;size=46329&amp;status=done&amp;width=979\" style=\"max-width: 600px; width: 979px;\" /></p><p><br /></p><h2 id=\"a3XdE\">使用kylin(以官方demo演示)</h2><h3 id=\"kCo8L\">导入数据</h3><p><br /></p><pre data-lang=\"bash\"><code>$KYLIN_HOME/bin/sample.sh\n\nRetrieving hadoop conf dir...\nError: Could not find or load main class org.apache.hadoop.hbase.util.GetJavaProperty\nLoading sample data into HDFS tmp path: /tmp/kylin/sample_cube/data\nGoing to create sample tables in hive to database DEFAULT by cli\nWARNING: Use &quot;yarn jar&quot; to launch YARN applications.\nSLF4J: Class path contains multiple SLF4J bindings.\nSLF4J: Found binding in [jar:file:/opt/cloudera/parcels/CDH-6.2.0-1.cdh6.2.0.p0.967373/jars/log4j-slf4j-impl-2.8.2.jar!/org/slf4j/impl/StaticLoggerBinder.class]\nSLF4J: Found binding in [jar:file:/opt/cloudera/parcels/CDH-6.2.0-1.cdh6.2.0.p0.967373/jars/slf4j-log4j12-1.7.25.jar!/org/slf4j/impl/StaticLoggerBinder.class]\nSLF4J: See http://www.slf4j.org/codes.html#multiple_bindings for an explanation.\nSLF4J: Actual binding is of type [org.apache.logging.slf4j.Log4jLoggerFactory]\n\nLogging initialized using configuration in jar:file:/opt/cloudera/parcels/CDH-6.2.0-1.cdh6.2.0.p0.967373/jars/hive-common-2.1.1-cdh6.2.0.jar!/hive-log4j2.properties Async: false\nOK\n//....\nSample cube is created successfully in project 'learn_kylin'.\n\n** Restart Kylin Server or click Web UI =&gt; System Tab =&gt; Reload Metadata to take effect **\n</code></pre><p><br /></p><h3 id=\"aQUhJ\">重新加载元数据</h3><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557483583704-c21d7c5b-00b8-4d77-a50f-dc8fd534fe86.png#align=left&amp;display=inline&amp;height=581&amp;name=image.png&amp;originHeight=581&amp;originWidth=1641&amp;size=124786&amp;status=done&amp;width=1641\" style=\"max-width: 600px; width: 1641px;\" /></p><p>选择 learn_kylin</p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557483605102-3911751e-a861-4754-9dca-3b0311657f55.png#align=left&amp;display=inline&amp;height=149&amp;name=image.png&amp;originHeight=149&amp;originWidth=222&amp;size=7898&amp;status=done&amp;width=222\" style=\"max-width: 600px; width: 222px;\" /></p><h3 id=\"UmJvr\">构建Cube</h3><p>选择 Model，选择kylin_sales_model,选择build</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557483714167-c3f0370c-7a1a-4f46-a532-8123b4d4b9f6.png#align=left&amp;display=inline&amp;height=642&amp;name=image.png&amp;originHeight=642&amp;originWidth=1901&amp;size=80161&amp;status=done&amp;width=1901\" style=\"max-width: 600px; width: 1901px;\" /></p><p>此处选择起止日期。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557483733469-dae19d83-b08a-4d72-9a05-1de253703e9f.png#align=left&amp;display=inline&amp;height=365&amp;name=image.png&amp;originHeight=365&amp;originWidth=1512&amp;size=26543&amp;status=done&amp;width=1512\" style=\"max-width: 600px; width: 1512px;\" /></p><p>如果没关闭hdfs权限校验，此处肯定会build失败。可以通过右侧 <code>&gt;</code> 图标点击查看进度。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557486437790-8e1c97a3-aebb-4866-857a-8ef3f0848d0c.png#align=left&amp;display=inline&amp;height=427&amp;name=image.png&amp;originHeight=427&amp;originWidth=1871&amp;size=53965&amp;status=done&amp;width=1871\" style=\"max-width: 600px; width: 1871px;\" /></p><p>build成功后，回到Insight界面，此时已经成功构建出5张表了。</p><p><br /></p><h3 id=\"PBL8A\">讲解demo表</h3><p>Kylin的示例是销售业务分析</p><ul><li>KYLIN_SALES 事实表，存有销售订单的详细信息(卖家，商品分类，订单金额，商品数量等)</li><li>KYLIN_COUNTRY 维度表，存有国家信息(简写，名称等)</li><li>KYLIN_CATEGORY_GROUPINGS 维度表，存有商品分类的详细介绍(分类名称等)</li><li>KYLIN_CAL_DT 维度表，存有时间扩展信息(日期所在年始，月<span>始，周</span><span>始，年份，月份等</span>)</li><li>KYLIN_ACCOUNT 维度表，存有账户信息(账户id，卖家等级，买家等级，国家等)</li></ul><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557486460421-1d88684e-825c-420d-9fdd-9e9717c28cb6.png#align=left&amp;display=inline&amp;height=576&amp;name=image.png&amp;originHeight=576&amp;originWidth=1102&amp;size=47232&amp;status=done&amp;width=1102\" style=\"max-width: 600px; width: 1102px;\" /></p><p><br /></p><h3 id=\"5dwAT\">运行查询语句</h3><p>执行 <code>select count(1) from kylin_sales</code> 点击submit，下方会显示执行结果，以及执行耗时(此处是1.8秒)。kylin会缓存执行结果，再次执行发现变成了0.18秒</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557486561989-c58f3430-7336-49dc-9b47-14c68fb8c6d6.png#align=left&amp;display=inline&amp;height=771&amp;name=image.png&amp;originHeight=771&amp;originWidth=1870&amp;size=80062&amp;status=done&amp;width=1870\" style=\"max-width: 600px; width: 1870px;\" /></p><p>执行稍微复杂的SQL语句</p><p><br /></p><pre data-lang=\"sql\"><code>select sum(KYLIN_SALES.PRICE) \nas price_sum,KYLIN_CATEGORY_GROUPINGS.META_CATEG_NAME,KYLIN_CATEGORY_GROUPINGS.CATEG_LVL2_NAME \nfrom KYLIN_SALES inner join KYLIN_CATEGORY_GROUPINGS\non KYLIN_SALES.LEAF_CATEG_ID = KYLIN_CATEGORY_GROUPINGS.LEAF_CATEG_ID and \nKYLIN_SALES.LSTG_SITE_ID = KYLIN_CATEGORY_GROUPINGS.SITE_ID\ngroup by KYLIN_CATEGORY_GROUPINGS.META_CATEG_NAME,KYLIN_CATEGORY_GROUPINGS.CATEG_LVL2_NAME\norder by KYLIN_CATEGORY_GROUPINGS.META_CATEG_NAME asc,KYLIN_CATEGORY_GROUPINGS.CATEG_LVL2_NAME desc</code></pre><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1558172952282-191a44d2-d434-4aad-8eff-da8cb6f8fc76.png#align=left&amp;display=inline&amp;height=586&amp;name=image.png&amp;originHeight=586&amp;originWidth=1456&amp;size=63114&amp;status=done&amp;width=1456\" style=\"max-width: 600px; width: 1456px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1558172990808-29ba9fd6-dfab-4835-84df-c98c6fa80fb7.png#align=left&amp;display=inline&amp;height=638&amp;name=image.png&amp;originHeight=638&amp;originWidth=1536&amp;size=68562&amp;status=done&amp;width=1536\" style=\"max-width: 600px; width: 1536px;\" /><span>自带简单的可视化。</span></p><p><br /></p><h2 id=\"jXA3N\">参考资料</h2><ul><li><a href=\"https://mp.weixin.qq.com/s?__biz=MzI4OTY3MTUyNg==&amp;mid=2247489540&amp;idx=1&amp;sn=a9a2c9bbb065987cd8756635c146800d\" target=\"_blank\">如何在CDH中部署及使用Kylin</a></li><li><a href=\"https://issues.apache.org/jira/browse/KYLIN-3872\" target=\"_blank\">Kylin web UI http 404 error</a></li><li><a href=\"https://zhuanlan.zhihu.com/p/62187552\" target=\"_blank\">Kylin 2.6.1 on Ambari 2.7.1.0 花式踩坑集锦</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p>",
    "body_lake": "<!doctype lake><p>date: 2019-05-03 20:00:01</p><p>tags: [CDH,hadoop,大数据,KYLIN,OLAP,麒麟]</p><p>categories: 大数据</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第21篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要介绍，如何使用大数据神兽Kylin(2.6.2)连接cdh6.2。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"kHqRf\">提示</h2><p><br /></p><ul><li>因为cdh6.2使用的是hadoop3，而目前的kylin3.0beta版本只是hadoop2,所以只能安装kylin2.5+,此处选择kylin2.6.2-cdh60（cdh6.0版）</li></ul><p><br /></p><h2 id=\"0cU6y\">安装kylin</h2><h3 id=\"ZtEd1\">下载kylin2.6.2二进制包</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22wget%20http%3A%2F%2Fmirrors.tuna.tsinghua.edu.cn%2Fapache%2Fkylin%2Fapache-kylin-2.6.2%2Fapache-kylin-2.6.2-bin-cdh60.tar.gz%5Cntar%20zxf%20apache-kylin-2.6.2-bin-cdh60.tar.gz%20-C%20%2Fusr%2Flocal%2F%5Cnln%20-s%20%2Fusr%2Flocal%2Fapache-kylin-2.6.2-bin-cdh60%20%2Fusr%2Flocal%2Fkylin%22%2C%22id%22%3A%22MYjy4%22%7D\"></card><p><br /></p><h3 id=\"NtEtw\">配置kylin环境变量</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22cat%20%3C%3C%20EOF%20%7C%20sudo%20tee%20-a%20%2Fetc%2Fprofile%5Cn%23%E8%AE%BE%E7%BD%AEjava%E7%8E%AF%E5%A2%83%5Cnexport%20JAVA_HOME%3D%2Fusr%2Fjava%2Fjdk1.8.0_181-cloudera%2F%5Cnexport%20CLASSPATH%3D.%3A%5C%5C%24JAVA_HOME%2Flib%3A%5C%5C%24JAVA_HOME%2Fjre%2Flib%3A%5C%5C%24CLASSPATH%5Cnexport%20KYLIN_HOME%3D%2Fusr%2Flocal%2Fkylin%5Cnexport%20PATH%3D%5C%5C%24JAVA_HOME%2Fbin%3A%5C%5C%24JAVA_HOME%2Fjre%2Fbin%3A%5C%5C%24PATH%5Cnexport%20CDH_HOME%3D%2Fopt%2Fcloudera%2Fparcels%2FCDH%5Cnexport%20HBASE_HOME%3D%5C%5C%24%7BCDH_HOME%7D%2Flib%2Fhbase%5Cnexport%20HBASE_CLASSPATH%3D%5C%5C%24%7BHBASE_HOME%7D%2Flib%2Fhbase-common-2.1.0-cdh6.2.0.jar%5CnEOF%5Cnsource%20%2Fetc%2Fprofile%22%2C%22id%22%3A%22owA6N%22%7D\"></card><p><br /></p><p>如果不加 <code>$HBASE_HOME</code> 会报 <code>hbase-common lib not found</code> </p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22plain%22%2C%22code%22%3A%22Retrieving%20hadoop%20conf%20dir...%5CnKYLIN_HOME%20is%20set%20to%20%2Fusr%2Flocal%2Fkylin%5CnRetrieving%20hive%20dependency...%5CnRetrieving%20hbase%20dependency...%5CnError%3A%20Could%20not%20find%20or%20load%20main%20class%20org.apache.hadoop.hbase.util.GetJavaProperty%5Cnhbase-common%20lib%20not%20found%22%2C%22id%22%3A%227M02V%22%7D\"></card><p><br /></p><h3 id=\"8xtqi\">在hdfs创建kylin和spark目录</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22export%20HADOOP_USER_NAME%3Dhdfs%22%2C%22id%22%3A%224DU5U%22%7D\"></card><p><br /></p><p>否则会报</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24KYLIN_HOME%2Fbin%2Fcheck-env.sh%5CnRetrieving%20hadoop%20conf%20dir...%5CnError%3A%20Could%20not%20find%20or%20load%20main%20class%20org.apache.hadoop.hbase.util.GetJavaProperty%5CnKYLIN_HOME%20is%20set%20to%20%2Fusr%2Flocal%2Fkylin%5Cnmkdir%3A%20Permission%20denied%3A%20user%3Droot%2C%20access%3DWRITE%2C%20inode%3D%5C%22%2Fkylin%5C%22%3Ahdfs%3Asupergroup%3Adrwxr-xr-x%5CnFailed%20to%20create%20hdfs%3A%2F%2F%2Fkylin%2Fspark-history.%20Please%20make%20sure%20the%20user%20has%20right%20to%20access%20hdfs%3A%2F%2F%2Fkylin%2Fspark-history%22%2C%22id%22%3A%22gcHOM%22%7D\"></card><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22yum%20install%20-y%20net-tools%22%2C%22id%22%3A%22uwDz9%22%7D\"></card><p> </p><p><span style=\"background-color: transparent;\">否则会报</span></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24KYLIN_HOME%2Fbin%2Fcheck-env.sh%5CnRetrieving%20hadoop%20conf%20dir...%5CnError%3A%20Could%20not%20find%20or%20load%20main%20class%20org.apache.hadoop.hbase.util.GetJavaProperty%5CnKYLIN_HOME%20is%20set%20to%20%2Fusr%2Flocal%2Fkylin%5Cn%2Fusr%2Flocal%2Fkylin%2Fbin%2Fcheck-port-availability.sh%3A%20line%2027%3A%20netstat%3A%20command%20not%20found%22%2C%22id%22%3A%22uDjeb%22%7D\"></card><p><br /></p><h3 id=\"7pUpu\">下载spark</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24KYLIN_HOME%2Fbin%2Fdownload-spark.sh%22%2C%22id%22%3A%22re3rV%22%7D\"></card><p>否则会报 </p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24KYLIN_HOME%2Fbin%2Fkylin.sh%20start%5CnRetrieving%20hadoop%20conf%20dir...%5Cn%E9%94%99%E8%AF%AF%3A%20%E6%89%BE%E4%B8%8D%E5%88%B0%E6%88%96%E6%97%A0%E6%B3%95%E5%8A%A0%E8%BD%BD%E4%B8%BB%E7%B1%BB%20org.apache.hadoop.hbase.util.GetJavaProperty%5CnKYLIN_HOME%20is%20set%20to%20%2Fusr%2Flocal%2Fkylin%5CnRetrieving%20hive%20dependency...%5CnRetrieving%20hbase%20dependency...%5Cn%E9%94%99%E8%AF%AF%3A%20%E6%89%BE%E4%B8%8D%E5%88%B0%E6%88%96%E6%97%A0%E6%B3%95%E5%8A%A0%E8%BD%BD%E4%B8%BB%E7%B1%BB%20org.apache.hadoop.hbase.util.GetJavaProperty%5CnRetrieving%20hadoop%20conf%20dir...%5Cn%E9%94%99%E8%AF%AF%3A%20%E6%89%BE%E4%B8%8D%E5%88%B0%E6%88%96%E6%97%A0%E6%B3%95%E5%8A%A0%E8%BD%BD%E4%B8%BB%E7%B1%BB%20org.apache.hadoop.hbase.util.GetJavaProperty%5CnRetrieving%20kafka%20dependency...%5CnRetrieving%20Spark%20dependency...%5Cnspark%20not%20found%2C%20set%20SPARK_HOME%2C%20or%20run%20bin%2Fdownload-spark.sh%22%2C%22id%22%3A%22TqpHH%22%7D\"></card><p><br /></p><p>如果知己指定了不兼容的spark版本，可能会导致404，参考 <a href=\"https://issues.apache.org/jira/browse/KYLIN-3872\" target=\"_blank\">Kylin web UI http 404 error</a></p><p><cursor /><br /></p><h3 id=\"xQuTy\">启动kylin</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24KYLIN_HOME%2Fbin%2Fkylin.sh%20start%22%2C%22id%22%3A%22xM5Kg%22%7D\"></card><p>如果成功会输出</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22plain%22%2C%22code%22%3A%22A%20new%20Kylin%20instance%20is%20started%20by%20root.%20To%20stop%20it%2C%20run%20'kylin.sh%20stop'%5CnCheck%20the%20log%20at%20%2Fusr%2Flocal%2Fkylin%2Flogs%2Fkylin.log%5CnWeb%20UI%20is%20at%20http%3A%2F%2F%3Chostname%3E%3A7070%2Fkylin%22%2C%22id%22%3A%2253L27%22%7D\"></card><p>浏览器打开 http://IP:7070/kylin ，用户名密码是 <code>ADMIN/KYLIN</code> </p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557482549401-ccd81caf-6b9f-4dad-8899-1262307ef09a.png%22%2C%22originWidth%22%3A822%2C%22originHeight%22%3A445%2C%22name%22%3A%22image.png%22%2C%22size%22%3A19890%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A822%2C%22height%22%3A445%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557482608635-8a90d635-862f-4695-b3b7-93c634267a5c.png%22%2C%22originWidth%22%3A979%2C%22originHeight%22%3A738%2C%22name%22%3A%22image.png%22%2C%22size%22%3A46329%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A979%2C%22height%22%3A738%7D\"></card></p><p><br /></p><h2 id=\"a3XdE\">使用kylin(以官方demo演示)</h2><h3 id=\"kCo8L\">导入数据</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24KYLIN_HOME%2Fbin%2Fsample.sh%5Cn%5CnRetrieving%20hadoop%20conf%20dir...%5CnError%3A%20Could%20not%20find%20or%20load%20main%20class%20org.apache.hadoop.hbase.util.GetJavaProperty%5CnLoading%20sample%20data%20into%20HDFS%20tmp%20path%3A%20%2Ftmp%2Fkylin%2Fsample_cube%2Fdata%5CnGoing%20to%20create%20sample%20tables%20in%20hive%20to%20database%20DEFAULT%20by%20cli%5CnWARNING%3A%20Use%20%5C%22yarn%20jar%5C%22%20to%20launch%20YARN%20applications.%5CnSLF4J%3A%20Class%20path%20contains%20multiple%20SLF4J%20bindings.%5CnSLF4J%3A%20Found%20binding%20in%20%5Bjar%3Afile%3A%2Fopt%2Fcloudera%2Fparcels%2FCDH-6.2.0-1.cdh6.2.0.p0.967373%2Fjars%2Flog4j-slf4j-impl-2.8.2.jar!%2Forg%2Fslf4j%2Fimpl%2FStaticLoggerBinder.class%5D%5CnSLF4J%3A%20Found%20binding%20in%20%5Bjar%3Afile%3A%2Fopt%2Fcloudera%2Fparcels%2FCDH-6.2.0-1.cdh6.2.0.p0.967373%2Fjars%2Fslf4j-log4j12-1.7.25.jar!%2Forg%2Fslf4j%2Fimpl%2FStaticLoggerBinder.class%5D%5CnSLF4J%3A%20See%20http%3A%2F%2Fwww.slf4j.org%2Fcodes.html%23multiple_bindings%20for%20an%20explanation.%5CnSLF4J%3A%20Actual%20binding%20is%20of%20type%20%5Borg.apache.logging.slf4j.Log4jLoggerFactory%5D%5Cn%5CnLogging%20initialized%20using%20configuration%20in%20jar%3Afile%3A%2Fopt%2Fcloudera%2Fparcels%2FCDH-6.2.0-1.cdh6.2.0.p0.967373%2Fjars%2Fhive-common-2.1.1-cdh6.2.0.jar!%2Fhive-log4j2.properties%20Async%3A%20false%5CnOK%5Cn%2F%2F....%5CnSample%20cube%20is%20created%20successfully%20in%20project%20'learn_kylin'.%5Cn%5Cn**%20Restart%20Kylin%20Server%20or%20click%20Web%20UI%20%3D%3E%20System%20Tab%20%3D%3E%20Reload%20Metadata%20to%20take%20effect%20**%5Cn%22%2C%22id%22%3A%22oso37%22%7D\"></card><p><br /></p><h3 id=\"aQUhJ\">重新加载元数据</h3><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557483583704-c21d7c5b-00b8-4d77-a50f-dc8fd534fe86.png%22%2C%22originWidth%22%3A1641%2C%22originHeight%22%3A581%2C%22name%22%3A%22image.png%22%2C%22size%22%3A124786%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1641%2C%22height%22%3A581%7D\"></card></p><p>选择 learn_kylin</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557483605102-3911751e-a861-4754-9dca-3b0311657f55.png%22%2C%22originWidth%22%3A222%2C%22originHeight%22%3A149%2C%22name%22%3A%22image.png%22%2C%22size%22%3A7898%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A222%2C%22height%22%3A149%7D\"></card></p><h3 id=\"UmJvr\">构建Cube</h3><p>选择 Model，选择kylin_sales_model,选择build</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557483714167-c3f0370c-7a1a-4f46-a532-8123b4d4b9f6.png%22%2C%22originWidth%22%3A1901%2C%22originHeight%22%3A642%2C%22name%22%3A%22image.png%22%2C%22size%22%3A80161%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1901%2C%22height%22%3A642%7D\"></card></p><p>此处选择起止日期。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557483733469-dae19d83-b08a-4d72-9a05-1de253703e9f.png%22%2C%22originWidth%22%3A1512%2C%22originHeight%22%3A365%2C%22name%22%3A%22image.png%22%2C%22size%22%3A26543%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1512%2C%22height%22%3A365%7D\"></card></p><p>如果没关闭hdfs权限校验，此处肯定会build失败。可以通过右侧 <code>&gt;</code> 图标点击查看进度。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557486437790-8e1c97a3-aebb-4866-857a-8ef3f0848d0c.png%22%2C%22originWidth%22%3A1871%2C%22originHeight%22%3A427%2C%22name%22%3A%22image.png%22%2C%22size%22%3A53965%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1871%2C%22height%22%3A427%7D\"></card></p><p>build成功后，回到Insight界面，此时已经成功构建出5张表了。</p><p><br /></p><h3 id=\"PBL8A\">讲解demo表</h3><p>Kylin的示例是销售业务分析</p><ul><li>KYLIN_SALES 事实表，存有销售订单的详细信息(卖家，商品分类，订单金额，商品数量等)</li><li>KYLIN_COUNTRY 维度表，存有国家信息(简写，名称等)</li><li>KYLIN_CATEGORY_GROUPINGS 维度表，存有商品分类的详细介绍(分类名称等)</li><li>KYLIN_CAL_DT 维度表，存有时间扩展信息(日期所在年始，月<span>始，周</span><span>始，年份，月份等</span>)</li><li>KYLIN_ACCOUNT 维度表，存有账户信息(账户id，卖家等级，买家等级，国家等)</li></ul><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557486460421-1d88684e-825c-420d-9fdd-9e9717c28cb6.png%22%2C%22originWidth%22%3A1102%2C%22originHeight%22%3A576%2C%22name%22%3A%22image.png%22%2C%22size%22%3A47232%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1102%2C%22height%22%3A576%7D\"></card></p><p><br /></p><h3 id=\"5dwAT\">运行查询语句</h3><p>执行 <code>select count(1) from kylin_sales</code> 点击submit，下方会显示执行结果，以及执行耗时(此处是1.8秒)。kylin会缓存执行结果，再次执行发现变成了0.18秒</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557486561989-c58f3430-7336-49dc-9b47-14c68fb8c6d6.png%22%2C%22originWidth%22%3A1870%2C%22originHeight%22%3A771%2C%22name%22%3A%22image.png%22%2C%22size%22%3A80062%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1870%2C%22height%22%3A771%7D\"></card></p><p>执行稍微复杂的SQL语句</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22sql%22%2C%22code%22%3A%22select%20sum(KYLIN_SALES.PRICE)%20%5Cnas%20price_sum%2CKYLIN_CATEGORY_GROUPINGS.META_CATEG_NAME%2CKYLIN_CATEGORY_GROUPINGS.CATEG_LVL2_NAME%20%5Cnfrom%20KYLIN_SALES%20inner%20join%20KYLIN_CATEGORY_GROUPINGS%5Cnon%20KYLIN_SALES.LEAF_CATEG_ID%20%3D%20KYLIN_CATEGORY_GROUPINGS.LEAF_CATEG_ID%20and%20%5CnKYLIN_SALES.LSTG_SITE_ID%20%3D%20KYLIN_CATEGORY_GROUPINGS.SITE_ID%5Cngroup%20by%20KYLIN_CATEGORY_GROUPINGS.META_CATEG_NAME%2CKYLIN_CATEGORY_GROUPINGS.CATEG_LVL2_NAME%5Cnorder%20by%20KYLIN_CATEGORY_GROUPINGS.META_CATEG_NAME%20asc%2CKYLIN_CATEGORY_GROUPINGS.CATEG_LVL2_NAME%20desc%22%2C%22id%22%3A%22vmhBR%22%7D\"></card><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1558172952282-191a44d2-d434-4aad-8eff-da8cb6f8fc76.png%22%2C%22originWidth%22%3A1456%2C%22originHeight%22%3A586%2C%22name%22%3A%22image.png%22%2C%22size%22%3A63114%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1456%2C%22height%22%3A586%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1558172990808-29ba9fd6-dfab-4835-84df-c98c6fa80fb7.png%22%2C%22originWidth%22%3A1536%2C%22originHeight%22%3A638%2C%22name%22%3A%22image.png%22%2C%22size%22%3A68562%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1536%2C%22height%22%3A638%7D\"></card><span>自带简单的可视化。</span></p><p><br /></p><h2 id=\"jXA3N\">参考资料</h2><ul><li><a href=\"https://mp.weixin.qq.com/s?__biz=MzI4OTY3MTUyNg==&amp;mid=2247489540&amp;idx=1&amp;sn=a9a2c9bbb065987cd8756635c146800d\" target=\"_blank\">如何在CDH中部署及使用Kylin</a></li><li><a href=\"https://issues.apache.org/jira/browse/KYLIN-3872\" target=\"_blank\">Kylin web UI http 404 error</a></li><li><a href=\"https://zhuanlan.zhihu.com/p/62187552\" target=\"_blank\">Kylin 2.6.1 on Ambari 2.7.1.0 花式踩坑集锦</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-05-29T02:50:06.000Z",
    "deleted_at": null,
    "created_at": "2019-05-10T08:23:24.000Z",
    "updated_at": "2019-05-29T02:50:06.000Z",
    "published_at": "2019-05-29T02:50:06.000Z",
    "first_published_at": "2019-05-18T09:50:57.000Z",
    "word_count": 1370,
    "cover": "",
    "description": "date: 2019-05-03 20:00:01tags: [CDH,hadoop,大数据,KYLIN,OLAP,麒麟]categories: 大数据---这是坚持技术写作计划（含翻译）的第21篇，定个小目标999，每周最少2篇。本文主要介绍，如何使用大数据神兽Kylin(2.6.2)连接c...",
    "custom_description": "本文主要介绍，如何使用大数据神兽Kylin(2.6.1)连接cdh6.2。",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1667690,
    "slug": "cm6-cluster",
    "title": "020-CM配置集群",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-04-29 18:10:00<br />tags: [CDH,hadoop,大数据]<br />categories: 大数据<br />---\n> 这是坚持技术写作计划（含翻译）的第20篇，定个小目标999，每周最少2篇。\n\n\n本文主要介绍，如何配置CM集群。\n\n<!-- more -->\n\n<a name=\"GgGW9\"></a>\n### 提示\n\n- 安装完后，打开 [http://masterIP:7180/](http://masterip:7180/) 进行登录，用户名/密码 是 admin/admin\n\n- 安装过程中，如果出现\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557474684611-ff6a7f1c-4d35-4041-b8c7-67748cafcb4e.png#align=left&display=inline&height=845&name=image.png&originHeight=845&originWidth=1456&size=26862&status=done&width=1456)和![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1558168684154-4141c4e8-4592-40a3-8c07-11ec9d3e8ed9.png#align=left&display=inline&height=612&name=image.png&originHeight=612&originWidth=897&size=25849&status=done&width=897)<br />多按几次 Ctrl+Shift+R即可\n\n<a name=\"RQBFy\"></a>\n### 选择协议\n注意授权问题，建议选择Cloudera Express 版，防止使用试用版收费项目后，60天过期后停用掉导致的问题。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557473083139-d59ce28b-5999-429d-9d51-db825bf714b7.png#align=left&display=inline&height=928&name=image.png&originHeight=928&originWidth=1764&size=122298&status=done&width=1764)\n<a name=\"Ei3Z4\"></a>\n### 配置集群\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557473101214-998d7c3b-e202-4fe7-800f-b08da5dea3f1.png#align=left&display=inline&height=900&name=image.png&originHeight=900&originWidth=1434&size=69964&status=done&width=1434)<br />填上FQDN或者ip，多台用英文逗号隔开，然后点搜索。并选中需要安装的服务器，点击继续。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557473272389-edb6fff0-2c54-4ffd-9495-ce76f709c196.png#align=left&display=inline&height=915&name=image.png&originHeight=915&originWidth=1450&size=109471&status=done&width=1450)<br />国内使用官方公开库，那等装完了，起码得以天为单位，此处使用自建repo，参考 [018-CDH6.2构建本地源加速CDH安装](https://juejin.im/post/5cc57a01f265da036c57929b) , 如果嫌麻烦，并且中科大的免费镜像能用的话，可以用中科大的，参考 [ustclug/mirrorrequest#56](https://github.com/ustclug/mirrorrequest/issues/56)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557473386274-c92e6d15-465f-46ed-9989-d1e2aede4972.png#align=left&display=inline&height=886&name=image.png&originHeight=886&originWidth=1446&size=164237&status=done&width=1446)<br />选择更多选项，把乱七八糟的都删掉，只留一个即可。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557473404683-1cdb865e-3ee0-4f07-bc3c-97138f76869d.png#align=left&display=inline&height=461&name=image.png&originHeight=461&originWidth=1701&size=46026&status=done&width=1701)\n\n如果已经安装了jdk 1.8 可以跳过。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557473446912-ef5d1472-ec49-4cc3-a4b5-ab803b54aa20.png#align=left&display=inline&height=908&name=image.png&originHeight=908&originWidth=1444&size=288573&status=done&width=1444)<br />填主机密码或者ssh key<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557473472053-b318c2b8-6611-456b-9962-85e0fbcf2c17.png#align=left&display=inline&height=899&name=image.png&originHeight=899&originWidth=1421&size=101355&status=done&width=1421)<br />点击继续，即会在对应主机执行安装操作。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557473917009-483cee28-4940-4aab-be3a-d2ec921d2eeb.png#align=left&display=inline&height=889&name=image.png&originHeight=889&originWidth=1207&size=52000&status=done&width=1207)<br />点继续，进行健康检查，如果是Inspect Network 和Hosts都是绿色的，则继续，否则可以点击，显示检查结果，进行排查，排查，改正后，点击重新运行。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557474626008-4d55b976-68d8-4af0-b02e-c9f8644ce89c.png#align=left&display=inline&height=914&name=image.png&originHeight=914&originWidth=1451&size=106906&status=done&width=1451)<br />选择需要安装的模块，点击继续<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557474843163-6ad18e46-c3f1-4daa-8810-68d956649901.png#align=left&display=inline&height=840&name=image.png&originHeight=840&originWidth=1431&size=141716&status=done&width=1431)<br />配置角色（各个主机需要安装的组件）<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557474977110-d9ba7095-a8eb-4c9d-b273-9750fb0596da.png#align=left&display=inline&height=397&name=image.png&originHeight=397&originWidth=1701&size=41273&status=done&width=1701)<br />配置元数据库信息，点击测试连接（如果提示找不到数据库驱动，需要参考之前的文章 [017-Centos7.6+CDH 6.2 安装和使用](https://juejin.im/post/5cd4c949f265da03a158463a)，安装驱动）<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557475069567-67acf641-1d6a-4d7d-a3a6-45a7845eb337.png#align=left&display=inline&height=805&name=image.png&originHeight=805&originWidth=1443&size=138020&status=done&width=1443)<br />点击继续后，会显示安装进度。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557475628886-18547c11-a4b2-4f26-9132-29ad74f282aa.png#align=left&display=inline&height=906&name=image.png&originHeight=906&originWidth=1440&size=139785&status=done&width=1440)<br />点击继续，则安装结束。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1557475636171-04c27f36-723a-4eff-b461-f9407e2faef4.png#align=left&display=inline&height=322&name=image.png&originHeight=322&originWidth=1213&size=12755&status=done&width=1213)\n\n<a name=\"FeVsY\"></a>\n### 参考资料\n\n- [018-CDH6.2构建本地源加速CDH安装](https://juejin.im/post/5cc57a01f265da036c57929b)\n- [ustclug/mirrorrequest#56](https://github.com/ustclug/mirrorrequest/issues/56)\n- [017-Centos7.6+CDH 6.2 安装和使用](https://juejin.im/post/5cd4c949f265da03a158463a)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。<br />长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-04-29 18:10:00</p><p>tags: [CDH,hadoop,大数据]</p><p>categories: 大数据</p><p>---</p><blockquote><p>这是坚持技术写作计划（含翻译）的第20篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要介绍，如何配置CM集群。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h3 id=\"GgGW9\">提示</h3><ul><li>安装完后，打开 <a href=\"http://masterip:7180/\" target=\"_blank\">http://masterIP:7180/</a> 进行登录，用户名/密码 是 admin/admin</li></ul><p><br /></p><ul><li>安装过程中，如果出现</li></ul><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557474684611-ff6a7f1c-4d35-4041-b8c7-67748cafcb4e.png#align=left&amp;display=inline&amp;height=845&amp;name=image.png&amp;originHeight=845&amp;originWidth=1456&amp;size=26862&amp;status=done&amp;width=1456\" style=\"max-width: 600px; width: 1456px;\" /><span>和</span><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1558168684154-4141c4e8-4592-40a3-8c07-11ec9d3e8ed9.png#align=left&amp;display=inline&amp;height=612&amp;name=image.png&amp;originHeight=612&amp;originWidth=897&amp;size=25849&amp;status=done&amp;width=897\" style=\"max-width: 600px; width: 897px;\" /></p><p>多按几次 Ctrl+Shift+R即可</p><p><br /></p><h3 id=\"RQBFy\">选择协议</h3><p>注意授权问题，建议选择Cloudera Express 版，防止使用试用版收费项目后，60天过期后停用掉导致的问题。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557473083139-d59ce28b-5999-429d-9d51-db825bf714b7.png#align=left&amp;display=inline&amp;height=928&amp;name=image.png&amp;originHeight=928&amp;originWidth=1764&amp;size=122298&amp;status=done&amp;width=1764\" style=\"max-width: 600px; width: 1764px;\" /></p><h3 id=\"Ei3Z4\">配置集群</h3><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557473101214-998d7c3b-e202-4fe7-800f-b08da5dea3f1.png#align=left&amp;display=inline&amp;height=900&amp;name=image.png&amp;originHeight=900&amp;originWidth=1434&amp;size=69964&amp;status=done&amp;width=1434\" style=\"max-width: 600px; width: 1434px;\" /></p><p>填上FQDN或者ip，多台用英文逗号隔开，然后点搜索。并选中需要安装的服务器，点击继续。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557473272389-edb6fff0-2c54-4ffd-9495-ce76f709c196.png#align=left&amp;display=inline&amp;height=915&amp;name=image.png&amp;originHeight=915&amp;originWidth=1450&amp;size=109471&amp;status=done&amp;width=1450\" style=\"max-width: 600px; width: 1450px;\" /></p><p>国内使用官方公开库，那等装完了，起码得以天为单位，此处使用自建repo，参考 <a href=\"https://juejin.im/post/5cc57a01f265da036c57929b\" target=\"_blank\">018-CDH6.2构建本地源加速CDH安装</a> , 如果嫌麻烦，并且中科大的免费镜像能用的话，可以用中科大的，参考 <a target=\"_blank\" href=\"https://github.com/ustclug/mirrorrequest/issues/56\">ustclug/mirrorrequest#56</a></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557473386274-c92e6d15-465f-46ed-9989-d1e2aede4972.png#align=left&amp;display=inline&amp;height=886&amp;name=image.png&amp;originHeight=886&amp;originWidth=1446&amp;size=164237&amp;status=done&amp;width=1446\" style=\"max-width: 600px; width: 1446px;\" /></p><p>选择更多选项，把乱七八糟的都删掉，只留一个即可。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557473404683-1cdb865e-3ee0-4f07-bc3c-97138f76869d.png#align=left&amp;display=inline&amp;height=461&amp;name=image.png&amp;originHeight=461&amp;originWidth=1701&amp;size=46026&amp;status=done&amp;width=1701\" style=\"max-width: 600px; width: 1701px;\" /></p><p><br /></p><p>如果已经安装了jdk 1.8 可以跳过。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557473446912-ef5d1472-ec49-4cc3-a4b5-ab803b54aa20.png#align=left&amp;display=inline&amp;height=908&amp;name=image.png&amp;originHeight=908&amp;originWidth=1444&amp;size=288573&amp;status=done&amp;width=1444\" style=\"max-width: 600px; width: 1444px;\" /></p><p>填主机密码或者ssh key</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557473472053-b318c2b8-6611-456b-9962-85e0fbcf2c17.png#align=left&amp;display=inline&amp;height=899&amp;name=image.png&amp;originHeight=899&amp;originWidth=1421&amp;size=101355&amp;status=done&amp;width=1421\" style=\"max-width: 600px; width: 1421px;\" /></p><p>点击继续，即会在对应主机执行安装操作。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557473917009-483cee28-4940-4aab-be3a-d2ec921d2eeb.png#align=left&amp;display=inline&amp;height=889&amp;name=image.png&amp;originHeight=889&amp;originWidth=1207&amp;size=52000&amp;status=done&amp;width=1207\" style=\"max-width: 600px; width: 1207px;\" /></p><p>点继续，进行健康检查，如果是Inspect Network 和Hosts都是绿色的，则继续，否则可以点击，显示检查结果，进行排查，排查，改正后，点击重新运行。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557474626008-4d55b976-68d8-4af0-b02e-c9f8644ce89c.png#align=left&amp;display=inline&amp;height=914&amp;name=image.png&amp;originHeight=914&amp;originWidth=1451&amp;size=106906&amp;status=done&amp;width=1451\" style=\"max-width: 600px; width: 1451px;\" /></p><p>选择需要安装的模块，点击继续</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557474843163-6ad18e46-c3f1-4daa-8810-68d956649901.png#align=left&amp;display=inline&amp;height=840&amp;name=image.png&amp;originHeight=840&amp;originWidth=1431&amp;size=141716&amp;status=done&amp;width=1431\" style=\"max-width: 600px; width: 1431px;\" /></p><p>配置角色（各个主机需要安装的组件）</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557474977110-d9ba7095-a8eb-4c9d-b273-9750fb0596da.png#align=left&amp;display=inline&amp;height=397&amp;name=image.png&amp;originHeight=397&amp;originWidth=1701&amp;size=41273&amp;status=done&amp;width=1701\" style=\"max-width: 600px; width: 1701px;\" /></p><p>配置元数据库信息，点击测试连接（如果提示找不到数据库驱动，需要参考之前的文章 <a href=\"https://juejin.im/post/5cd4c949f265da03a158463a\" target=\"_blank\">017-Centos7.6+CDH 6.2 安装和使用</a>，安装驱动）</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557475069567-67acf641-1d6a-4d7d-a3a6-45a7845eb337.png#align=left&amp;display=inline&amp;height=805&amp;name=image.png&amp;originHeight=805&amp;originWidth=1443&amp;size=138020&amp;status=done&amp;width=1443\" style=\"max-width: 600px; width: 1443px;\" /></p><p>点击继续后，会显示安装进度。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557475628886-18547c11-a4b2-4f26-9132-29ad74f282aa.png#align=left&amp;display=inline&amp;height=906&amp;name=image.png&amp;originHeight=906&amp;originWidth=1440&amp;size=139785&amp;status=done&amp;width=1440\" style=\"max-width: 600px; width: 1440px;\" /></p><p>点击继续，则安装结束。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1557475636171-04c27f36-723a-4eff-b461-f9407e2faef4.png#align=left&amp;display=inline&amp;height=322&amp;name=image.png&amp;originHeight=322&amp;originWidth=1213&amp;size=12755&amp;status=done&amp;width=1213\" style=\"max-width: 600px; width: 1213px;\" /></p><p><br /></p><h3 id=\"FeVsY\">参考资料</h3><p><br /></p><ul><li><a href=\"https://juejin.im/post/5cc57a01f265da036c57929b\" target=\"_blank\">018-CDH6.2构建本地源加速CDH安装</a></li><li><a target=\"_blank\" href=\"https://github.com/ustclug/mirrorrequest/issues/56\">ustclug/mirrorrequest#56</a></li><li><a href=\"https://juejin.im/post/5cd4c949f265da03a158463a\" target=\"_blank\">017-Centos7.6+CDH 6.2 安装和使用</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p>",
    "body_lake": "<!doctype lake><p>date: 2019-04-29 18:10:00</p><p>tags: [CDH,hadoop,大数据]</p><p>categories: 大数据</p><p>---</p><blockquote><p>这是坚持技术写作计划（含翻译）的第20篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要介绍，如何配置CM集群。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h3 id=\"GgGW9\">提示</h3><ul><li>安装完后，打开 <a href=\"http://masterip:7180/\" target=\"_blank\">http://masterIP:7180/</a> 进行登录，用户名/密码 是 admin/admin</li></ul><p><br /></p><ul><li>安装过程中，如果出现</li></ul><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557474684611-ff6a7f1c-4d35-4041-b8c7-67748cafcb4e.png%22%2C%22originWidth%22%3A1456%2C%22originHeight%22%3A845%2C%22name%22%3A%22image.png%22%2C%22size%22%3A26862%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1456%2C%22height%22%3A845%7D\"></card><span>和</span><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1558168684154-4141c4e8-4592-40a3-8c07-11ec9d3e8ed9.png%22%2C%22originWidth%22%3A897%2C%22originHeight%22%3A612%2C%22name%22%3A%22image.png%22%2C%22size%22%3A25849%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A897%2C%22height%22%3A612%7D\"></card></p><p>多按几次 Ctrl+Shift+R即可</p><p><br /></p><h3 id=\"RQBFy\">选择协议</h3><p>注意授权问题，建议选择Cloudera Express 版，防止使用试用版收费项目后，60天过期后停用掉导致的问题。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557473083139-d59ce28b-5999-429d-9d51-db825bf714b7.png%22%2C%22originWidth%22%3A1764%2C%22originHeight%22%3A928%2C%22name%22%3A%22image.png%22%2C%22size%22%3A122298%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1764%2C%22height%22%3A928%7D\"></card></p><h3 id=\"Ei3Z4\">配置集群</h3><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557473101214-998d7c3b-e202-4fe7-800f-b08da5dea3f1.png%22%2C%22originWidth%22%3A1434%2C%22originHeight%22%3A900%2C%22name%22%3A%22image.png%22%2C%22size%22%3A69964%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1434%2C%22height%22%3A900%7D\"></card></p><p>填上FQDN或者ip，多台用英文逗号隔开，然后点搜索。并选中需要安装的服务器，点击继续。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557473272389-edb6fff0-2c54-4ffd-9495-ce76f709c196.png%22%2C%22originWidth%22%3A1450%2C%22originHeight%22%3A915%2C%22name%22%3A%22image.png%22%2C%22size%22%3A109471%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1450%2C%22height%22%3A915%7D\"></card></p><p>国内使用官方公开库，那等装完了，起码得以天为单位，此处使用自建repo，参考 <a href=\"https://juejin.im/post/5cc57a01f265da036c57929b\" target=\"_blank\">018-CDH6.2构建本地源加速CDH安装</a> , 如果嫌麻烦，并且中科大的免费镜像能用的话，可以用中科大的，参考 <a target=\"_blank\" href=\"https://github.com/ustclug/mirrorrequest/issues/56\">ustclug/mirrorrequest#56</a></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557473386274-c92e6d15-465f-46ed-9989-d1e2aede4972.png%22%2C%22originWidth%22%3A1446%2C%22originHeight%22%3A886%2C%22name%22%3A%22image.png%22%2C%22size%22%3A164237%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1446%2C%22height%22%3A886%7D\"></card></p><p>选择更多选项，把乱七八糟的都删掉，只留一个即可。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557473404683-1cdb865e-3ee0-4f07-bc3c-97138f76869d.png%22%2C%22originWidth%22%3A1701%2C%22originHeight%22%3A461%2C%22name%22%3A%22image.png%22%2C%22size%22%3A46026%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1701%2C%22height%22%3A461%7D\"></card></p><p><br /></p><p>如果已经安装了jdk 1.8 可以跳过。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557473446912-ef5d1472-ec49-4cc3-a4b5-ab803b54aa20.png%22%2C%22originWidth%22%3A1444%2C%22originHeight%22%3A908%2C%22name%22%3A%22image.png%22%2C%22size%22%3A288573%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1444%2C%22height%22%3A908%7D\"></card></p><p>填主机密码或者ssh key</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557473472053-b318c2b8-6611-456b-9962-85e0fbcf2c17.png%22%2C%22originWidth%22%3A1421%2C%22originHeight%22%3A899%2C%22name%22%3A%22image.png%22%2C%22size%22%3A101355%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1421%2C%22height%22%3A899%7D\"></card></p><p>点击继续，即会在对应主机执行安装操作。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557473917009-483cee28-4940-4aab-be3a-d2ec921d2eeb.png%22%2C%22originWidth%22%3A1207%2C%22originHeight%22%3A889%2C%22name%22%3A%22image.png%22%2C%22size%22%3A52000%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1207%2C%22height%22%3A889%7D\"></card></p><p>点继续，进行健康检查，如果是Inspect Network 和Hosts都是绿色的，则继续，否则可以点击，显示检查结果，进行排查，排查，改正后，点击重新运行。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557474626008-4d55b976-68d8-4af0-b02e-c9f8644ce89c.png%22%2C%22originWidth%22%3A1451%2C%22originHeight%22%3A914%2C%22name%22%3A%22image.png%22%2C%22size%22%3A106906%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1451%2C%22height%22%3A914%7D\"></card></p><p>选择需要安装的模块，点击继续</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557474843163-6ad18e46-c3f1-4daa-8810-68d956649901.png%22%2C%22originWidth%22%3A1431%2C%22originHeight%22%3A840%2C%22name%22%3A%22image.png%22%2C%22size%22%3A141716%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1431%2C%22height%22%3A840%7D\"></card></p><p>配置角色（各个主机需要安装的组件）</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557474977110-d9ba7095-a8eb-4c9d-b273-9750fb0596da.png%22%2C%22originWidth%22%3A1701%2C%22originHeight%22%3A397%2C%22name%22%3A%22image.png%22%2C%22size%22%3A41273%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1701%2C%22height%22%3A397%7D\"></card></p><p>配置元数据库信息，点击测试连接（如果提示找不到数据库驱动，需要参考之前的文章 <a href=\"https://juejin.im/post/5cd4c949f265da03a158463a\" target=\"_blank\">017-Centos7.6+CDH 6.2 安装和使用</a>，安装驱动）</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557475069567-67acf641-1d6a-4d7d-a3a6-45a7845eb337.png%22%2C%22originWidth%22%3A1443%2C%22originHeight%22%3A805%2C%22name%22%3A%22image.png%22%2C%22size%22%3A138020%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1443%2C%22height%22%3A805%7D\"></card></p><p>点击继续后，会显示安装进度。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557475628886-18547c11-a4b2-4f26-9132-29ad74f282aa.png%22%2C%22originWidth%22%3A1440%2C%22originHeight%22%3A906%2C%22name%22%3A%22image.png%22%2C%22size%22%3A139785%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1440%2C%22height%22%3A906%7D\"></card></p><p>点击继续，则安装结束。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1557475636171-04c27f36-723a-4eff-b461-f9407e2faef4.png%22%2C%22originWidth%22%3A1213%2C%22originHeight%22%3A322%2C%22name%22%3A%22image.png%22%2C%22size%22%3A12755%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1213%2C%22height%22%3A322%7D\"></card></p><p><br /></p><h3 id=\"FeVsY\">参考资料</h3><p><br /></p><ul><li><a href=\"https://juejin.im/post/5cc57a01f265da036c57929b\" target=\"_blank\">018-CDH6.2构建本地源加速CDH安装</a></li><li><a target=\"_blank\" href=\"https://github.com/ustclug/mirrorrequest/issues/56\">ustclug/mirrorrequest#56</a></li><li><a href=\"https://juejin.im/post/5cd4c949f265da03a158463a\" target=\"_blank\">017-Centos7.6+CDH 6.2 安装和使用</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-05-18T09:06:08.000Z",
    "deleted_at": null,
    "created_at": "2019-05-10T07:24:26.000Z",
    "updated_at": "2019-05-18T09:06:09.000Z",
    "published_at": "2019-05-18T09:06:08.000Z",
    "first_published_at": "2019-05-18T09:06:08.000Z",
    "word_count": 550,
    "cover": "",
    "description": "date: 2019-04-29 18:10:00tags: [CDH,hadoop,大数据]categories: 大数据---这是坚持技术写作计划（含翻译）的第20篇，定个小目标999，每周最少2篇。本文主要介绍，如何配置CM集群。&lt;!-- more --&gt;提示安装完后，打开 ...",
    "custom_description": "本文主要介绍，如何配置CM集群。",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1664306,
    "slug": "redis-batch-changed-ttl",
    "title": "019-批量修改redis TTL和批量删除key",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-05-10 08:37:14<br />tags: [redis,python]<br />categories: redis<br />---\n\n> 这是坚持技术写作计划（含翻译）的第19篇，定个小目标999，每周最少2篇。\n\n\n如果因为历史原因，导致redis里存在无用且没有设置ttl的key，会造成浪费。本文主要讲如何在不阻塞redis的情况下批量修改redis的ttl和使用通配符删除key。\n\n<!-- more -->\n\n<a name=\"s9rs2\"></a>\n### 通配符删除key\n\n```\nredis-cli [-a password] [-h localhost] [-p 6379] --scan --pattern pattern* | xargs redis-cli [-a password] [-h localhost] [-p 6379] del\n```\n其中 `[]` 包裹的都是可选项\n\n- -p 端口\n- -h 是redis主机\n- -a 是密码\n- pattern* 是通配符\n> SCAN,SSCAN,HSCAN,ZSCAN四个命令都支持增量式迭代， 它们每次执行都只会返回少量元素， 所以这些命令可以用于生产环境， 而不会出现像 KEYS 命令、 SMEMBERS 命令带来的问题 —— 当 KEYS 命令被用于处理一个大的数据库时， 又或者 SMEMBERS 命令被用于处理一个大的集合键时， 它们可能会阻塞服务器达数秒之久。\n\n参考资料  [redis 命令 ](http://doc.redisfans.com/key/scan.html)[SCAN](http://doc.redisfans.com/key/scan.html) \n\n<a name=\"hG47Y\"></a>\n### 批量打印或者修改TTL\n使用方式\n\n```\n$ pip install redis\n$ python keys.py --help\n\nusage: keys.py [-h] [-p PORT] [-d DB_LIST] [--host HOST] [--password PASSWORD]\n               [--expire EXPIRE] [--random_upper RANDOM_UPPER]\n               [--max_ttl MAX_TTL]\n\noptional arguments:\n  -h, --help            show this help message and exit\n  -p PORT               port of redis\n  -d DB_LIST            ex : -d all / -d 1,2,3,4\n  --host HOST           ex : --host 127.0.0.1\n  --password PASSWORD   ex : --password password\n  --expire EXPIRE       unit: sec ,ex 1 days = 86400 sec: --expire 86400\n  --random_upper RANDOM_UPPER\n                        unit: sec ,ex 1 mins = 60 sec: --random_upper 60\n  --max_ttl MAX_TTL     unit: sec ,ex 1 mins = 60 sec: --max_ttl 60\n\n```\n\n```python\n# encoding: utf-8\n\"\"\"\nauthor: yangyi@youzan.com\ntime: 2018/4/26 下午4:34\nfunc: 获取数据库中没有设置ttl的 key\n\nauthor: anjia0532@gmail.com\ntime: 2019/05/10 上午8:19\ndesc: 增加cli选项，增加批量修改ttl功能\n\"\"\"\nimport redis\nimport argparse\nimport time\nimport sys, os\nimport random\n\nclass ShowProcess:\n    \n    \"\"\"\n    显示处理进度的类\n    调用该类相关函数即可实现处理进度的显示\n    \"\"\"\n    i = 0 # 当前的处理进度\n    max_steps = 0 # 总共需要处理的次数\n    max_arrow = 50 # 进度条的长度\n\n    # 初始化函数，需要知道总共的处理次数\n    def __init__(self, max_steps):\n        self.max_steps = max_steps\n        self.i = 0\n\n    # 显示函数，根据当前的处理进度i显示进度\n    # 效果为[>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>]100.00%\n    def show_process(self, i = None):\n        if i is not None:\n            self.i = i\n        else:\n            self.i += 1\n        num_arrow = int(self.i * self.max_arrow / self.max_steps) # 计算显示多少个'>'\n        num_line = self.max_arrow - num_arrow # 计算显示多少个'-'\n        percent = self.i * 100.0 / self.max_steps # 计算完成进度，格式为xx.xx%\n        process_bar = '[' + '>' * num_arrow + ' ' * num_line + ']'\\\n                      + '%.2f' % percent + '%' + '\\r' # 带输出的字符串，'\\r'表示不换行回到最左边\n        sys.stdout.write(process_bar) # 这两句打印字符到终端\n        sys.stdout.flush()\n\n    def close(self, words='done'):\n        print(words)\n        self.i = 0\n\n\ndef check_ttl(redis_conn, dbindex,max_ttl,random_upper,expire):\n    start_time = time.time()\n    changed_ttl_num = 0\n    keys_num = redis_conn.dbsize()\n    print( \"there are {num} keys in db {index} \".format(num=keys_num, index=dbindex))\n    process_bar = ShowProcess(keys_num)\n    for key in redis_conn.scan_iter(count=1000):\n        process_bar.show_process()\n        ttl = redis_conn.ttl(key)\n        if ttl > max_ttl or ttl == -1:\n            changed_ttl_num += 1\n            redis_conn.expire(key, expire + random.randint(0, random_upper))\n        else:\n            continue\n\n    process_bar.close()\n    print(\"cost time(s):\", time.time() - start_time)\n    print(\"changed ttl keys number:\", changed_ttl_num)\n\n\ndef main():\n    parser = argparse.ArgumentParser()\n    \n    parser.add_argument('--port', type=int, dest='port', action='store', default=6379,help='port of redis ')\n    parser.add_argument('--db_list', type=str, dest='db_list', action='store', default='0',\n                        help='ex : -d all / -d 1,2,3,4 ')\n    parser.add_argument('--host', type=str, dest='host', action='store', default='127.0.0.1',\n                        help='ex : --host 127.0.0.1 ')\n    parser.add_argument('--password', type=str, dest='password', action='store', default='',\n                        help='ex : --password password ')\n    parser.add_argument('--expire', type=int, dest='expire', action='store', default='0',\n                        help='unit: sec ,ex 1 days = 86400 sec: --expire 86400 ')\n    parser.add_argument('--random_upper', type=int, dest='random_upper', action='store', default='60',\n                        help='unit: sec ,ex 1 mins = 60 sec: --random_upper 60 ')\n    parser.add_argument('--max_ttl', type=int, dest='max_ttl', action='store', default='60',\n                        help='unit: sec ,ex 1 mins = 60 sec: --max_ttl 60 ')\n    \n    args = parser.parse_args()\n    port = args.port\n    expire = args.expire\n    random_upper = args.random_upper\n    max_ttl = args.max_ttl\n    host = args.host\n    password = args.password\n    \n    if args.db_list == 'all':\n        db_list = [i for i in range(0, 16)]\n    else:\n        db_list = [int(i) for i in args.db_list.split(',')]\n    for index in db_list:\n        try:\n            pool = redis.ConnectionPool(host=host, port=port, db=index,password=password)\n            r = redis.StrictRedis(connection_pool=pool)\n        except redis.exceptions.ConnectionError as e:\n            print(e)\n        else:\n            check_ttl(r, index,max_ttl,random_upper,expire)\nif __name__ == '__main__':\n    main()\n\n```\n\n参考资料  [【Redis】获取没有设置ttl的key脚本](http://blog.itpub.net/22664653/viewspace-2153419/)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。<br />长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-05-10 08:37:14</p><p>tags: [redis,python]</p><p>categories: redis</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第19篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>如果因为历史原因，导致redis里存在无用且没有设置ttl的key，会造成浪费。<span style=\"background-color: transparent;\">本文主要讲如何在不阻塞redis的情况下批量修改redis的ttl和使用通配符删除key。</span></p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h3 id=\"s9rs2\">通配符删除key</h3><p><br /></p><pre><code>redis-cli [-a password] [-h localhost] [-p 6379] --scan --pattern pattern* | xargs redis-cli [-a password] [-h localhost] [-p 6379] del</code></pre><p>其中 <code>[]</code> 包裹的都是可选项</p><ul><li>-p 端口</li><li>-h 是redis主机</li><li>-a 是密码</li><li>pattern* 是通配符</li></ul><blockquote><p>SCAN,SSCAN,HSCAN,ZSCAN四个命令都支持增量式迭代， 它们每次执行都只会返回少量元素， 所以这些命令可以用于生产环境， 而不会出现像 KEYS 命令、 SMEMBERS 命令带来的问题 —— 当 KEYS 命令被用于处理一个大的数据库时， 又或者 SMEMBERS 命令被用于处理一个大的集合键时， 它们可能会阻塞服务器达数秒之久。</p></blockquote><p><span>参考资料  </span><a href=\"http://doc.redisfans.com/key/scan.html\" target=\"_blank\"><span>redis 命令 </span></a><a href=\"http://doc.redisfans.com/key/scan.html\" target=\"_blank\">SCAN</a> </p><p><br /></p><h3 id=\"hG47Y\">批量打印或者修改TTL</h3><p>使用方式</p><p><br /></p><pre><code>$ pip install redis\n$ python keys.py --help\n\nusage: keys.py [-h] [-p PORT] [-d DB_LIST] [--host HOST] [--password PASSWORD]\n               [--expire EXPIRE] [--random_upper RANDOM_UPPER]\n               [--max_ttl MAX_TTL]\n\noptional arguments:\n  -h, --help            show this help message and exit\n  -p PORT               port of redis\n  -d DB_LIST            ex : -d all / -d 1,2,3,4\n  --host HOST           ex : --host 127.0.0.1\n  --password PASSWORD   ex : --password password\n  --expire EXPIRE       unit: sec ,ex 1 days = 86400 sec: --expire 86400\n  --random_upper RANDOM_UPPER\n                        unit: sec ,ex 1 mins = 60 sec: --random_upper 60\n  --max_ttl MAX_TTL     unit: sec ,ex 1 mins = 60 sec: --max_ttl 60\n</code></pre><p><br /></p><pre data-lang=\"python\"><code># encoding: utf-8\n&quot;&quot;&quot;\nauthor: yangyi@youzan.com\ntime: 2018/4/26 下午4:34\nfunc: 获取数据库中没有设置ttl的 key\n\nauthor: anjia0532@gmail.com\ntime: 2019/05/10 上午8:19\ndesc: 增加cli选项，增加批量修改ttl功能\n&quot;&quot;&quot;\nimport redis\nimport argparse\nimport time\nimport sys, os\nimport random\n\nclass ShowProcess:\n    \n    &quot;&quot;&quot;\n    显示处理进度的类\n    调用该类相关函数即可实现处理进度的显示\n    &quot;&quot;&quot;\n    i = 0 # 当前的处理进度\n    max_steps = 0 # 总共需要处理的次数\n    max_arrow = 50 # 进度条的长度\n\n    # 初始化函数，需要知道总共的处理次数\n    def __init__(self, max_steps):\n        self.max_steps = max_steps\n        self.i = 0\n\n    # 显示函数，根据当前的处理进度i显示进度\n    # 效果为[&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;]100.00%\n    def show_process(self, i = None):\n        if i is not None:\n            self.i = i\n        else:\n            self.i += 1\n        num_arrow = int(self.i * self.max_arrow / self.max_steps) # 计算显示多少个'&gt;'\n        num_line = self.max_arrow - num_arrow # 计算显示多少个'-'\n        percent = self.i * 100.0 / self.max_steps # 计算完成进度，格式为xx.xx%\n        process_bar = '[' + '&gt;' * num_arrow + ' ' * num_line + ']'\\\n                      + '%.2f' % percent + '%' + '\\r' # 带输出的字符串，'\\r'表示不换行回到最左边\n        sys.stdout.write(process_bar) # 这两句打印字符到终端\n        sys.stdout.flush()\n\n    def close(self, words='done'):\n        print(words)\n        self.i = 0\n\n\ndef check_ttl(redis_conn, dbindex,max_ttl,random_upper,expire):\n    start_time = time.time()\n    changed_ttl_num = 0\n    keys_num = redis_conn.dbsize()\n    print( &quot;there are {num} keys in db {index} &quot;.format(num=keys_num, index=dbindex))\n    process_bar = ShowProcess(keys_num)\n    for key in redis_conn.scan_iter(count=1000):\n        process_bar.show_process()\n        ttl = redis_conn.ttl(key)\n        if ttl &gt; max_ttl or ttl == -1:\n            changed_ttl_num += 1\n            redis_conn.expire(key, expire + random.randint(0, random_upper))\n        else:\n            continue\n\n    process_bar.close()\n    print(&quot;cost time(s):&quot;, time.time() - start_time)\n    print(&quot;changed ttl keys number:&quot;, changed_ttl_num)\n\n\ndef main():\n    parser = argparse.ArgumentParser()\n    \n    parser.add_argument('--port', type=int, dest='port', action='store', default=6379,help='port of redis ')\n    parser.add_argument('--db_list', type=str, dest='db_list', action='store', default='0',\n                        help='ex : -d all / -d 1,2,3,4 ')\n    parser.add_argument('--host', type=str, dest='host', action='store', default='127.0.0.1',\n                        help='ex : --host 127.0.0.1 ')\n    parser.add_argument('--password', type=str, dest='password', action='store', default='',\n                        help='ex : --password password ')\n    parser.add_argument('--expire', type=int, dest='expire', action='store', default='0',\n                        help='unit: sec ,ex 1 days = 86400 sec: --expire 86400 ')\n    parser.add_argument('--random_upper', type=int, dest='random_upper', action='store', default='60',\n                        help='unit: sec ,ex 1 mins = 60 sec: --random_upper 60 ')\n    parser.add_argument('--max_ttl', type=int, dest='max_ttl', action='store', default='60',\n                        help='unit: sec ,ex 1 mins = 60 sec: --max_ttl 60 ')\n    \n    args = parser.parse_args()\n    port = args.port\n    expire = args.expire\n    random_upper = args.random_upper\n    max_ttl = args.max_ttl\n    host = args.host\n    password = args.password\n    \n    if args.db_list == 'all':\n        db_list = [i for i in range(0, 16)]\n    else:\n        db_list = [int(i) for i in args.db_list.split(',')]\n    for index in db_list:\n        try:\n            pool = redis.ConnectionPool(host=host, port=port, db=index,password=password)\n            r = redis.StrictRedis(connection_pool=pool)\n        except redis.exceptions.ConnectionError as e:\n            print(e)\n        else:\n            check_ttl(r, index,max_ttl,random_upper,expire)\nif __name__ == '__main__':\n    main()\n</code></pre><p><br /></p><p>参考资料  <a href=\"http://blog.itpub.net/22664653/viewspace-2153419/\" target=\"_blank\">【Redis】获取没有设置ttl的key脚本</a></p><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p>",
    "body_lake": "<!doctype lake><p>date: 2019-05-10 08:37:14</p><p>tags: [redis,python]</p><p>categories: redis</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第19篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>如果因为历史原因，导致redis里存在无用且没有设置ttl的key，会造成浪费。<span style=\"background-color: transparent;\">本文主要讲如何在不阻塞redis的情况下批量修改redis的ttl和使用通配符删除key。</span></p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h3 id=\"s9rs2\">通配符删除key</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22plain%22%2C%22code%22%3A%22redis-cli%20%5B-a%20password%5D%20%5B-h%20localhost%5D%20%5B-p%206379%5D%20--scan%20--pattern%20pattern*%20%7C%20xargs%20redis-cli%20%5B-a%20password%5D%20%5B-h%20localhost%5D%20%5B-p%206379%5D%20del%22%2C%22id%22%3A%22kkje4%22%7D\"></card><p>其中 <code>[]</code> 包裹的都是可选项</p><ul><li>-p 端口</li><li>-h 是redis主机</li><li>-a 是密码</li><li>pattern* 是通配符</li></ul><blockquote><p>SCAN,SSCAN,HSCAN,ZSCAN四个命令都支持增量式迭代， 它们每次执行都只会返回少量元素， 所以这些命令可以用于生产环境， 而不会出现像 KEYS 命令、 SMEMBERS 命令带来的问题 —— 当 KEYS 命令被用于处理一个大的数据库时， 又或者 SMEMBERS 命令被用于处理一个大的集合键时， 它们可能会阻塞服务器达数秒之久。</p></blockquote><p><span>参考资料  </span><a href=\"http://doc.redisfans.com/key/scan.html\" target=\"_blank\"><span>redis 命令 </span></a><a href=\"http://doc.redisfans.com/key/scan.html\" target=\"_blank\">SCAN</a> </p><p><br /></p><h3 id=\"hG47Y\">批量打印或者修改TTL</h3><p>使用方式</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22plain%22%2C%22code%22%3A%22%24%20pip%20install%20redis%5Cn%24%20python%20keys.py%20--help%5Cn%5Cnusage%3A%20keys.py%20%5B-h%5D%20%5B-p%20PORT%5D%20%5B-d%20DB_LIST%5D%20%5B--host%20HOST%5D%20%5B--password%20PASSWORD%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B--expire%20EXPIRE%5D%20%5B--random_upper%20RANDOM_UPPER%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B--max_ttl%20MAX_TTL%5D%5Cn%5Cnoptional%20arguments%3A%5Cn%20%20-h%2C%20--help%20%20%20%20%20%20%20%20%20%20%20%20show%20this%20help%20message%20and%20exit%5Cn%20%20-p%20PORT%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20port%20of%20redis%5Cn%20%20-d%20DB_LIST%20%20%20%20%20%20%20%20%20%20%20%20ex%20%3A%20-d%20all%20%2F%20-d%201%2C2%2C3%2C4%5Cn%20%20--host%20HOST%20%20%20%20%20%20%20%20%20%20%20ex%20%3A%20--host%20127.0.0.1%5Cn%20%20--password%20PASSWORD%20%20%20ex%20%3A%20--password%20password%5Cn%20%20--expire%20EXPIRE%20%20%20%20%20%20%20unit%3A%20sec%20%2Cex%201%20days%20%3D%2086400%20sec%3A%20--expire%2086400%5Cn%20%20--random_upper%20RANDOM_UPPER%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20unit%3A%20sec%20%2Cex%201%20mins%20%3D%2060%20sec%3A%20--random_upper%2060%5Cn%20%20--max_ttl%20MAX_TTL%20%20%20%20%20unit%3A%20sec%20%2Cex%201%20mins%20%3D%2060%20sec%3A%20--max_ttl%2060%5Cn%22%2C%22id%22%3A%22xOkCn%22%7D\"></card><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22python%22%2C%22code%22%3A%22%23%20encoding%3A%20utf-8%5Cn%5C%22%5C%22%5C%22%5Cnauthor%3A%20yangyi%40youzan.com%5Cntime%3A%202018%2F4%2F26%20%E4%B8%8B%E5%8D%884%3A34%5Cnfunc%3A%20%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E6%B2%A1%E6%9C%89%E8%AE%BE%E7%BD%AEttl%E7%9A%84%20key%5Cn%5Cnauthor%3A%20anjia0532%40gmail.com%5Cntime%3A%202019%2F05%2F10%20%E4%B8%8A%E5%8D%888%3A19%5Cndesc%3A%20%E5%A2%9E%E5%8A%A0cli%E9%80%89%E9%A1%B9%EF%BC%8C%E5%A2%9E%E5%8A%A0%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9ttl%E5%8A%9F%E8%83%BD%5Cn%5C%22%5C%22%5C%22%5Cnimport%20redis%5Cnimport%20argparse%5Cnimport%20time%5Cnimport%20sys%2C%20os%5Cnimport%20random%5Cn%5Cnclass%20ShowProcess%3A%5Cn%20%20%20%20%5Cn%20%20%20%20%5C%22%5C%22%5C%22%5Cn%20%20%20%20%E6%98%BE%E7%A4%BA%E5%A4%84%E7%90%86%E8%BF%9B%E5%BA%A6%E7%9A%84%E7%B1%BB%5Cn%20%20%20%20%E8%B0%83%E7%94%A8%E8%AF%A5%E7%B1%BB%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0%E5%8D%B3%E5%8F%AF%E5%AE%9E%E7%8E%B0%E5%A4%84%E7%90%86%E8%BF%9B%E5%BA%A6%E7%9A%84%E6%98%BE%E7%A4%BA%5Cn%20%20%20%20%5C%22%5C%22%5C%22%5Cn%20%20%20%20i%20%3D%200%20%23%20%E5%BD%93%E5%89%8D%E7%9A%84%E5%A4%84%E7%90%86%E8%BF%9B%E5%BA%A6%5Cn%20%20%20%20max_steps%20%3D%200%20%23%20%E6%80%BB%E5%85%B1%E9%9C%80%E8%A6%81%E5%A4%84%E7%90%86%E7%9A%84%E6%AC%A1%E6%95%B0%5Cn%20%20%20%20max_arrow%20%3D%2050%20%23%20%E8%BF%9B%E5%BA%A6%E6%9D%A1%E7%9A%84%E9%95%BF%E5%BA%A6%5Cn%5Cn%20%20%20%20%23%20%E5%88%9D%E5%A7%8B%E5%8C%96%E5%87%BD%E6%95%B0%EF%BC%8C%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E6%80%BB%E5%85%B1%E7%9A%84%E5%A4%84%E7%90%86%E6%AC%A1%E6%95%B0%5Cn%20%20%20%20def%20__init__(self%2C%20max_steps)%3A%5Cn%20%20%20%20%20%20%20%20self.max_steps%20%3D%20max_steps%5Cn%20%20%20%20%20%20%20%20self.i%20%3D%200%5Cn%5Cn%20%20%20%20%23%20%E6%98%BE%E7%A4%BA%E5%87%BD%E6%95%B0%EF%BC%8C%E6%A0%B9%E6%8D%AE%E5%BD%93%E5%89%8D%E7%9A%84%E5%A4%84%E7%90%86%E8%BF%9B%E5%BA%A6i%E6%98%BE%E7%A4%BA%E8%BF%9B%E5%BA%A6%5Cn%20%20%20%20%23%20%E6%95%88%E6%9E%9C%E4%B8%BA%5B%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%5D100.00%25%5Cn%20%20%20%20def%20show_process(self%2C%20i%20%3D%20None)%3A%5Cn%20%20%20%20%20%20%20%20if%20i%20is%20not%20None%3A%5Cn%20%20%20%20%20%20%20%20%20%20%20%20self.i%20%3D%20i%5Cn%20%20%20%20%20%20%20%20else%3A%5Cn%20%20%20%20%20%20%20%20%20%20%20%20self.i%20%2B%3D%201%5Cn%20%20%20%20%20%20%20%20num_arrow%20%3D%20int(self.i%20*%20self.max_arrow%20%2F%20self.max_steps)%20%23%20%E8%AE%A1%E7%AE%97%E6%98%BE%E7%A4%BA%E5%A4%9A%E5%B0%91%E4%B8%AA'%3E'%5Cn%20%20%20%20%20%20%20%20num_line%20%3D%20self.max_arrow%20-%20num_arrow%20%23%20%E8%AE%A1%E7%AE%97%E6%98%BE%E7%A4%BA%E5%A4%9A%E5%B0%91%E4%B8%AA'-'%5Cn%20%20%20%20%20%20%20%20percent%20%3D%20self.i%20*%20100.0%20%2F%20self.max_steps%20%23%20%E8%AE%A1%E7%AE%97%E5%AE%8C%E6%88%90%E8%BF%9B%E5%BA%A6%EF%BC%8C%E6%A0%BC%E5%BC%8F%E4%B8%BAxx.xx%25%5Cn%20%20%20%20%20%20%20%20process_bar%20%3D%20'%5B'%20%2B%20'%3E'%20*%20num_arrow%20%2B%20'%20'%20*%20num_line%20%2B%20'%5D'%5C%5C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20'%25.2f'%20%25%20percent%20%2B%20'%25'%20%2B%20'%5C%5Cr'%20%23%20%E5%B8%A6%E8%BE%93%E5%87%BA%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%8C'%5C%5Cr'%E8%A1%A8%E7%A4%BA%E4%B8%8D%E6%8D%A2%E8%A1%8C%E5%9B%9E%E5%88%B0%E6%9C%80%E5%B7%A6%E8%BE%B9%5Cn%20%20%20%20%20%20%20%20sys.stdout.write(process_bar)%20%23%20%E8%BF%99%E4%B8%A4%E5%8F%A5%E6%89%93%E5%8D%B0%E5%AD%97%E7%AC%A6%E5%88%B0%E7%BB%88%E7%AB%AF%5Cn%20%20%20%20%20%20%20%20sys.stdout.flush()%5Cn%5Cn%20%20%20%20def%20close(self%2C%20words%3D'done')%3A%5Cn%20%20%20%20%20%20%20%20print(words)%5Cn%20%20%20%20%20%20%20%20self.i%20%3D%200%5Cn%5Cn%5Cndef%20check_ttl(redis_conn%2C%20dbindex%2Cmax_ttl%2Crandom_upper%2Cexpire)%3A%5Cn%20%20%20%20start_time%20%3D%20time.time()%5Cn%20%20%20%20changed_ttl_num%20%3D%200%5Cn%20%20%20%20keys_num%20%3D%20redis_conn.dbsize()%5Cn%20%20%20%20print(%20%5C%22there%20are%20%7Bnum%7D%20keys%20in%20db%20%7Bindex%7D%20%5C%22.format(num%3Dkeys_num%2C%20index%3Ddbindex))%5Cn%20%20%20%20process_bar%20%3D%20ShowProcess(keys_num)%5Cn%20%20%20%20for%20key%20in%20redis_conn.scan_iter(count%3D1000)%3A%5Cn%20%20%20%20%20%20%20%20process_bar.show_process()%5Cn%20%20%20%20%20%20%20%20ttl%20%3D%20redis_conn.ttl(key)%5Cn%20%20%20%20%20%20%20%20if%20ttl%20%3E%20max_ttl%20or%20ttl%20%3D%3D%20-1%3A%5Cn%20%20%20%20%20%20%20%20%20%20%20%20changed_ttl_num%20%2B%3D%201%5Cn%20%20%20%20%20%20%20%20%20%20%20%20redis_conn.expire(key%2C%20expire%20%2B%20random.randint(0%2C%20random_upper))%5Cn%20%20%20%20%20%20%20%20else%3A%5Cn%20%20%20%20%20%20%20%20%20%20%20%20continue%5Cn%5Cn%20%20%20%20process_bar.close()%5Cn%20%20%20%20print(%5C%22cost%20time(s)%3A%5C%22%2C%20time.time()%20-%20start_time)%5Cn%20%20%20%20print(%5C%22changed%20ttl%20keys%20number%3A%5C%22%2C%20changed_ttl_num)%5Cn%5Cn%5Cndef%20main()%3A%5Cn%20%20%20%20parser%20%3D%20argparse.ArgumentParser()%5Cn%20%20%20%20%5Cn%20%20%20%20parser.add_argument('--port'%2C%20type%3Dint%2C%20dest%3D'port'%2C%20action%3D'store'%2C%20default%3D6379%2Chelp%3D'port%20of%20redis%20')%5Cn%20%20%20%20parser.add_argument('--db_list'%2C%20type%3Dstr%2C%20dest%3D'db_list'%2C%20action%3D'store'%2C%20default%3D'0'%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20help%3D'ex%20%3A%20-d%20all%20%2F%20-d%201%2C2%2C3%2C4%20')%5Cn%20%20%20%20parser.add_argument('--host'%2C%20type%3Dstr%2C%20dest%3D'host'%2C%20action%3D'store'%2C%20default%3D'127.0.0.1'%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20help%3D'ex%20%3A%20--host%20127.0.0.1%20')%5Cn%20%20%20%20parser.add_argument('--password'%2C%20type%3Dstr%2C%20dest%3D'password'%2C%20action%3D'store'%2C%20default%3D''%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20help%3D'ex%20%3A%20--password%20password%20')%5Cn%20%20%20%20parser.add_argument('--expire'%2C%20type%3Dint%2C%20dest%3D'expire'%2C%20action%3D'store'%2C%20default%3D'0'%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20help%3D'unit%3A%20sec%20%2Cex%201%20days%20%3D%2086400%20sec%3A%20--expire%2086400%20')%5Cn%20%20%20%20parser.add_argument('--random_upper'%2C%20type%3Dint%2C%20dest%3D'random_upper'%2C%20action%3D'store'%2C%20default%3D'60'%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20help%3D'unit%3A%20sec%20%2Cex%201%20mins%20%3D%2060%20sec%3A%20--random_upper%2060%20')%5Cn%20%20%20%20parser.add_argument('--max_ttl'%2C%20type%3Dint%2C%20dest%3D'max_ttl'%2C%20action%3D'store'%2C%20default%3D'60'%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20help%3D'unit%3A%20sec%20%2Cex%201%20mins%20%3D%2060%20sec%3A%20--max_ttl%2060%20')%5Cn%20%20%20%20%5Cn%20%20%20%20args%20%3D%20parser.parse_args()%5Cn%20%20%20%20port%20%3D%20args.port%5Cn%20%20%20%20expire%20%3D%20args.expire%5Cn%20%20%20%20random_upper%20%3D%20args.random_upper%5Cn%20%20%20%20max_ttl%20%3D%20args.max_ttl%5Cn%20%20%20%20host%20%3D%20args.host%5Cn%20%20%20%20password%20%3D%20args.password%5Cn%20%20%20%20%5Cn%20%20%20%20if%20args.db_list%20%3D%3D%20'all'%3A%5Cn%20%20%20%20%20%20%20%20db_list%20%3D%20%5Bi%20for%20i%20in%20range(0%2C%2016)%5D%5Cn%20%20%20%20else%3A%5Cn%20%20%20%20%20%20%20%20db_list%20%3D%20%5Bint(i)%20for%20i%20in%20args.db_list.split('%2C')%5D%5Cn%20%20%20%20for%20index%20in%20db_list%3A%5Cn%20%20%20%20%20%20%20%20try%3A%5Cn%20%20%20%20%20%20%20%20%20%20%20%20pool%20%3D%20redis.ConnectionPool(host%3Dhost%2C%20port%3Dport%2C%20db%3Dindex%2Cpassword%3Dpassword)%5Cn%20%20%20%20%20%20%20%20%20%20%20%20r%20%3D%20redis.StrictRedis(connection_pool%3Dpool)%5Cn%20%20%20%20%20%20%20%20except%20redis.exceptions.ConnectionError%20as%20e%3A%5Cn%20%20%20%20%20%20%20%20%20%20%20%20print(e)%5Cn%20%20%20%20%20%20%20%20else%3A%5Cn%20%20%20%20%20%20%20%20%20%20%20%20check_ttl(r%2C%20index%2Cmax_ttl%2Crandom_upper%2Cexpire)%5Cnif%20__name__%20%3D%3D%20'__main__'%3A%5Cn%20%20%20%20main()%5Cn%22%2C%22id%22%3A%22f3WhB%22%7D\"></card><p><br /></p><p>参考资料  <a href=\"http://blog.itpub.net/22664653/viewspace-2153419/\" target=\"_blank\">【Redis】获取没有设置ttl的key脚本</a></p><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-05-10T00:40:43.000Z",
    "deleted_at": null,
    "created_at": "2019-05-10T00:01:46.000Z",
    "updated_at": "2019-05-18T09:04:39.000Z",
    "published_at": "2019-05-10T00:40:43.000Z",
    "first_published_at": "2019-05-10T00:40:43.000Z",
    "word_count": 1228,
    "cover": "",
    "description": "date: 2019-05-10 08:37:14tags: [redis,python]categories: redis---这是坚持技术写作计划（含翻译）的第19篇，定个小目标999，每周最少2篇。如果因为历史原因，导致redis里存在无用且没有设置ttl的key，会造成浪费。本文主要讲...",
    "custom_description": "如果因为历史原因，导致redis里存在无用且没有设置ttl的key，会造成浪费。本文主要讲如何在不阻塞redis的情况下批量修改redis的ttl和使用通配符删除key。",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1599972,
    "slug": "cdh-local-parcel-repo",
    "title": "018-CDH6.2构建本地源加速CDH安装",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-04-28 19:10:00<br />tags: [CDH,hadoop,大数据]<br />categories: 大数据<br />---\n> 这是坚持技术写作计划（含翻译）的第18篇，定个小目标999，每周最少2篇。\n\n\n目前国内还没有机构或者个人提供CDH的公共加速源，导致CDH安装时超慢，并且一旦失败后，还得不支持断点安装(linux机制)，配置CDH本地repo是学习cdh的第一步，否则单是安装就需要以小时为单位。\n\n<!-- more -->\n\n本文以centos7.6为例（其余发行版类似），介绍CDH 自定义 parcel和package 镜像源（parcel是cdh自定义格式）\n\n<a name=\"22xMQ\"></a>\n## 创建内网repo\n<a name=\"4pKfU\"></a>\n### 配置web服务器\n可以用apache2，也可以用nginx，任何提供http服务的都可以\n```bash\n$ sudo apt-get install -y httpd\n$ sudo systemctl start httpd\n$ sudo systemctl enable httpd\n```\n\n<a name=\"D9i4s\"></a>\n### 下载packages\n这是给centos安装cm6用的\n\n```bash\n$ sudo mkdir -p /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/cm6/6.2.0/redhat7/ -P /var/www/html/cloudera-repos\n$ sudo wget https://archive.cloudera.com/cm6/6.2.0/allkeys.asc -P /var/www/html/cloudera-repos/cm6/6.2.0/\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/cm6\n```\n\n<a name=\"POHSQ\"></a>\n### 下载和发布parcel repo\n\n1. 下载 `manifest.json` 和parcel 文件<br />**CDH6** \n\nCDH 6 parcel中包含 Apache Impala, Apache Kudu, Apache Spark 2, and Cloudera Search等组件，以6.2.0为例，在web服务器上运行下面指令，用来下载最新版的cdh 6.2，如果要换成cdh6.x的其他版本，只需要替换命令中的 `6.2.0` 即可。更多6.x版本信息参见 [CDH 6 Download Information](https://www.cloudera.com/documentation/enterprise/latest/topics/rg_cdh_6_download.html#cdh_download_info) 。\n```bash\n$ sudo mkdir -p /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/cdh6/6.2.0/parcels/ -P /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/gplextras6/6.2.0/parcels/ -P /var/www/html/cloudera-repos\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/cdh6\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/gplextras6\n```\n\n     **CDH5** <br />CDH 5 parcel中包含 Impala, Kudu, Spark 1, and Search 等组件，以5.14.4为例，在web服务器上运行以下指令，如果要换成cdh5.x的其他版本,需要替换命令中的 `5.14.4` 为指定版本号，更多5.x版本信息参见 [CDH Download Information](https://www.cloudera.com/documentation/enterprise/release-notes/topics/cdh_vd_cdh_download.html)\n```bash\n$ sudo mkdir -p /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/cdh5/parcels/5.14.4/ -P /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/gplextras5/parcels/5.14.4/ -P /var/www/html/cloudera-repos\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/cdh5\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/gplextras5\n```\n\n如果像本文实例一样，只需支持单一版本（centos7.6）cdh即可，为了节省时间，可以只下载具体版本。<br />以CDH6的为例，增加 `--accept-regex \"el7|manifest\"` ,代表只下载包含xenial和maifest的文件\n```bash\n# 官方命令\nsudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/cdh6/6.2.0/parcels/ -P /var/www/html/cloudera-repos\n# 改后命令\nsudo wget --recursive --no-parent --accept-regex \"el7|manifest\" --no-host-directories https://archive.cloudera.com/cdh6/6.2.0/parcels/ -P /var/www/html/cloudera-repos\n```\n\n如果想再快点，可以使用迅雷，axel，aria2等多线程工具快速下载后，上传到web服务器。<br />      **Apache Accumulo for CDH** <br />以下载Accumulo1.7.2为例,如果换成别的版本，替换命令中1.7.2即可\n\n```bash\n$ sudo mkdir -p /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/accumulo-c5/parcels/1.7.2/ -P /var/www/html/cloudera-repos\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/accumulo-c5\n```\n\n     **CDS Powered By Apache Spark 2 for CDH** <br />以下载CDS2.3.0.cloudera3为例,更多版本信息参见  [CDS Powered By Apache Spark Version Information](https://www.cloudera.com/documentation/spark2/latest/topics/spark2_packaging.html#versions)\n```bash\n$ sudo mkdir -p /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/spark2/parcels/2.3.0.cloudera3/ -P /var/www/html/cloudera-repos\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/spark2\n```\n\n     **Cloudera Navigator Key Trustee Server** <br /> Key Trustee KMS parcel中包含  Cloudera Navigator HSM KMS ，从 [download page](http://www.cloudera.com/content/www/en-us/downloads/navigator/key-trustee-kms.html) 下载Key Trustee KMS，选择指定Version，比如 `Navigator Key Trustee KMS 6.2.0` ,选择Package or Parcel,选择 `Parcel` ,选择 `DOWNLOAD NOW` ,将下载Key Trustee KMS parcels 和 manifest.json ，将下载的 `.tar.gz` 上传到web服务器上，并解压，以Key Trustee KMS 6.2.0为例\n\n```bash\n$ sudo mkdir -p /var/www/html/cloudera-repos/keytrustee-kms\n$ sudo tar xvfz /path/to/keytrustee-kms-6.2.0-parcels.tar.gz -C /var/www/html/cloudera-repos/keytrustee-kms --strip-components=1\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/keytrustee-kms\n```\n\n     **Sqoop Connectors** <br />以下载最新版Sqoop为例\n```bash\n$ sudo mkdir -p /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories http://archive.cloudera.com/sqoop-connectors/parcels/latest/ -P /var/www/html/cloudera-repos\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/sqoop-connectors\n```\n\n\n2. 访问repo地址 `http://<Web_server>/cloudera-repos/` 确保你下载的文件能够正常访问。\n\n<a name=\"IlmKd\"></a>\n### 配置Cloudera Manager 使用Parcel repo\n\n1. 两种方法二选一，配置parcel\n  1. Navigation bar - 导航条\n    1. 点击navigation bar 的parcel图标或者点击 `Hosts` 然后点击 `Parcels` 标签\n    1. 点击 `Configuration` 按钮\n  2. Menu - 菜单\n    1. 选择 `Administration` (管理) -> `Settings` (设置)\n    1. 选择 `Category`  > `Parcels` \n2. 在 `Remote Pacel Respository URLs` 点击添加按钮，并添加。\n2. 填上parcel地址，比如  `http://<web_server>/cloudera-parcels/cdh6/6.2.0/` \n2. 填写 `Reason for change`  变更原因,点击 `Save Changes` 提交保存。\n\n<a name=\"4qw5J\"></a>\n## 国内镜像源\n本文写完后，发现中科大有一个CDH的反代，速度还挺快，可以按需使用。参考 [ustclug/mirrorrequest#56](https://github.com/ustclug/mirrorrequest/issues/56) ，经测试，特别不稳定，持续两天，访问不通。\n\n<a name=\"9OziU\"></a>\n## 参考资料\n\n- [Configuring a Local Package Repository](https://www.cloudera.com/documentation/enterprise/latest/topics/cm_ig_create_local_package_repo.html?cdoc-os=ubuntu+1604+xenial#internal_package_repo)\n- [Configuring a Local Parcel Repository](https://www.cloudera.com/documentation/enterprise/latest/topics/cm_ig_create_local_parcel_repo.html)\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-04-28 19:10:00</p><p>tags: [CDH,hadoop,大数据]</p><p>categories: 大数据</p><p>---</p><blockquote><p>这是坚持技术写作计划（含翻译）的第18篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>目前国内还没有机构或者个人提供CDH的公共加速源，导致CDH安装时超慢，并且一旦失败后，还得不支持断点安装(linux机制)，配置CDH本地repo是学习cdh的第一步，否则单是安装就需要以小时为单位。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><p>本文以centos7.6为例（其余发行版类似），介绍CDH 自定义 <span>parcel和package 镜像源（parcel是cdh自定义格式）</span></p><p><br /></p><h2 id=\"22xMQ\">创建内网repo</h2><h3 id=\"4pKfU\">配置web服务器</h3><p>可以用apache2，也可以用nginx，任何提供http服务的都可以</p><pre data-lang=\"bash\"><code>$ sudo apt-get install -y httpd\n$ sudo systemctl start httpd\n$ sudo systemctl enable httpd</code></pre><p><br /></p><h3 id=\"D9i4s\">下载packages</h3><p>这是给centos安装cm6用的</p><p><br /></p><pre data-lang=\"bash\"><code>$ sudo mkdir -p /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/cm6/6.2.0/redhat7/ -P /var/www/html/cloudera-repos\n$ sudo wget https://archive.cloudera.com/cm6/6.2.0/allkeys.asc -P /var/www/html/cloudera-repos/cm6/6.2.0/\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/cm6</code></pre><p><br /></p><h3 id=\"POHSQ\">下载和发布<span>parcel</span> repo</h3><ol start=\"1\"><li>下载 <code>manifest.json</code> 和parcel 文件<br /><strong>CDH6</strong> </li></ol><p>CDH 6 parcel中包含 Apache Impala, Apache Kudu, Apache Spark 2, and Cloudera Search等组件，<span>以6.2.0为例，</span>在web服务器上运行下面指令，用来下载最新版的cdh 6.2，如果要换成cdh6.x的其他版本，只需要替换命令中的 <code>6.2.0</code> 即可。<span>更多6.x版本信息参见</span> <a href=\"https://www.cloudera.com/documentation/enterprise/latest/topics/rg_cdh_6_download.html#cdh_download_info\" target=\"_blank\">CDH 6 Download Information</a> 。</p><pre data-lang=\"bash\"><code>$ sudo mkdir -p /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/cdh6/6.2.0/parcels/ -P /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/gplextras6/6.2.0/parcels/ -P /var/www/html/cloudera-repos\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/cdh6\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/gplextras6</code></pre><ol start=\"2\"><p>     <strong>CDH5</strong> </p><p>CDH 5 parcel中包含 Impala, Kudu, Spark 1, and Search 等组件，以5.14.4为例，在web服务器上运行以下指令，如果要换成cdh5.x的其他版本,需要替换命令中的 <code>5.14.4</code> 为指定版本号，更多5.x版本信息参见 <a href=\"https://www.cloudera.com/documentation/enterprise/release-notes/topics/cdh_vd_cdh_download.html\" target=\"_blank\">CDH Download Information</a></p></ol><pre data-lang=\"bash\"><code>$ sudo mkdir -p /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/cdh5/parcels/5.14.4/ -P /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/gplextras5/parcels/5.14.4/ -P /var/www/html/cloudera-repos\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/cdh5\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/gplextras5</code></pre><ol start=\"2\"><p>如果像本文实例一样，只需支持单一版本（<span>centos7.6</span>）cdh即可，为了节省时间，可以只下载具体版本。</p><p>以CDH6的为例，增加 <code>--accept-regex &quot;el7|manifest&quot;</code> ,代表只下载包含xenial和maifest的文件</p></ol><pre data-lang=\"bash\"><code># 官方命令\nsudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/cdh6/6.2.0/parcels/ -P /var/www/html/cloudera-repos\n# 改后命令\nsudo wget --recursive --no-parent --accept-regex &quot;el7|manifest&quot; --no-host-directories https://archive.cloudera.com/cdh6/6.2.0/parcels/ -P /var/www/html/cloudera-repos</code></pre><ol start=\"2\"><p>如果想再快点，可以使用迅雷，axel，aria2等多线程工具快速下载后，上传到web服务器。</p><p>      <strong>Apache Accumulo for CDH</strong> </p><p>以下载Accumulo1.7.2为例,如果换成别的版本，替换命令中1.7.2即可</p><p><br /></p></ol><pre data-lang=\"bash\"><code>$ sudo mkdir -p /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/accumulo-c5/parcels/1.7.2/ -P /var/www/html/cloudera-repos\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/accumulo-c5</code></pre><ol start=\"2\"><p>     <strong>CDS Powered By Apache Spark 2 for CDH</strong> </p><p>以下载CDS2.3.0.cloudera3为例,更多版本信息参见  <a href=\"https://www.cloudera.com/documentation/spark2/latest/topics/spark2_packaging.html#versions\" target=\"_blank\">CDS Powered By Apache Spark Version Information</a></p></ol><pre data-lang=\"bash\"><code>$ sudo mkdir -p /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/spark2/parcels/2.3.0.cloudera3/ -P /var/www/html/cloudera-repos\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/spark2</code></pre><ol start=\"2\"><p>     <strong>Cloudera Navigator Key Trustee Server</strong> </p><p> Key Trustee KMS parcel中包含  Cloudera Navigator HSM KMS ，从 <a href=\"http://www.cloudera.com/content/www/en-us/downloads/navigator/key-trustee-kms.html\" target=\"_blank\">download page</a> 下载Key Trustee KMS，选择指定Version，比如 <code>Navigator Key Trustee KMS 6.2.0</code> ,选择Package or Parcel,选择 <code>Parcel</code> ,选择 <code>DOWNLOAD NOW</code> ,将下载Key Trustee KMS parcels 和 manifest.json ，将下载的 <code>.tar.gz</code> 上传到web服务器上，并解压，以Key Trustee KMS 6.2.0为例</p><p><br /></p></ol><pre data-lang=\"bash\"><code>$ sudo mkdir -p /var/www/html/cloudera-repos/keytrustee-kms\n$ sudo tar xvfz /path/to/keytrustee-kms-6.2.0-parcels.tar.gz -C /var/www/html/cloudera-repos/keytrustee-kms --strip-components=1\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/keytrustee-kms</code></pre><ol start=\"2\"><p>     <strong>Sqoop Connectors</strong> </p><p>以下载最新版Sqoop为例</p></ol><pre data-lang=\"bash\"><code>$ sudo mkdir -p /var/www/html/cloudera-repos\n$ sudo wget --recursive --no-parent --no-host-directories http://archive.cloudera.com/sqoop-connectors/parcels/latest/ -P /var/www/html/cloudera-repos\n$ sudo chmod -R ugo+rX /var/www/html/cloudera-repos/sqoop-connectors</code></pre><ol start=\"2\"><p><br /></p><li>访问repo地址 <code>http://&lt;Web_server&gt;/cloudera-repos/</code> 确保你下载的文件能够正常访问。</li></ol><p><br /></p><h3 id=\"IlmKd\">配置Cloudera Manager 使用Parcel repo</h3><ol start=\"1\"><li>两种方法二选一，配置parcel</li></ol><ol data-lake-indent=\"1\"><li>Navigation bar - 导航条</li></ol><ol data-lake-indent=\"2\"><li>点击navigation bar 的parcel图标或者点击 <code>Hosts</code> 然后点击 <code>Parcels</code> 标签</li><li>点击 <code>Configuration</code> 按钮</li></ol><ol data-lake-indent=\"1\" start=\"2\"><li>Menu - 菜单</li></ol><ol data-lake-indent=\"2\"><li>选择 <code>Administration</code> (管理) -&gt; <code>Settings</code> (设置)</li><li>选择 <code>Category</code>  &gt; <code>Parcels</code> </li></ol><ol start=\"2\"><li>在 <code>Remote Pacel Respository URLs</code> 点击添加按钮，并添加。</li><li>填上parcel地址，比如  <code>http://&lt;web_server&gt;/cloudera-parcels/cdh6/6.2.0/</code> </li><li>填写 <code>Reason for change</code>  变更原因,点击 <code>Save Changes</code> 提交保存。</li></ol><p><br /></p><h2 id=\"4qw5J\">国内镜像源</h2><p>本文写完后，发现中科大有一个CDH的反代，速度还挺快，可以按需使用。参考 <a href=\"https://github.com/ustclug/mirrorrequest/issues/56\" target=\"_blank\">ustclug/mirrorrequest#56</a> ，经测试，特别不稳定，持续两天，访问不通。</p><p><br /></p><h2 id=\"9OziU\">参考资料</h2><ul><li><a href=\"https://www.cloudera.com/documentation/enterprise/latest/topics/cm_ig_create_local_package_repo.html?cdoc-os=ubuntu+1604+xenial#internal_package_repo\" target=\"_blank\">Configuring a Local Package Repository</a></li><li><a href=\"https://www.cloudera.com/documentation/enterprise/latest/topics/cm_ig_create_local_parcel_repo.html\" target=\"_blank\">Configuring a Local Parcel Repository</a></li></ul>",
    "body_lake": "<!doctype lake><p>date: 2019-04-28 19:10:00</p><p>tags: [CDH,hadoop,大数据]</p><p>categories: 大数据</p><p>---</p><blockquote><p>这是坚持技术写作计划（含翻译）的第18篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>目前国内还没有机构或者个人提供CDH的公共加速源，导致CDH安装时超慢，并且一旦失败后，还得不支持断点安装(linux机制)，配置CDH本地repo是学习cdh的第一步，否则单是安装就需要以小时为单位。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><p>本文以centos7.6为例（其余发行版类似），介绍CDH 自定义 <span>parcel和package 镜像源（parcel是cdh自定义格式）</span></p><p><br /></p><h2 id=\"22xMQ\">创建内网repo</h2><h3 id=\"4pKfU\">配置web服务器</h3><p>可以用apache2，也可以用nginx，任何提供http服务的都可以</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20sudo%20apt-get%20install%20-y%20httpd%5Cn%24%20sudo%20systemctl%20start%20httpd%5Cn%24%20sudo%20systemctl%20enable%20httpd%22%2C%22id%22%3A%22yMq5h%22%7D\"></card><p><br /></p><h3 id=\"D9i4s\">下载packages</h3><p>这是给centos安装cm6用的</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20sudo%20mkdir%20-p%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%5Cn%24%20sudo%20wget%20--recursive%20--no-parent%20--no-host-directories%20https%3A%2F%2Farchive.cloudera.com%2Fcm6%2F6.2.0%2Fredhat7%2F%20-P%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%5Cn%24%20sudo%20wget%20https%3A%2F%2Farchive.cloudera.com%2Fcm6%2F6.2.0%2Fallkeys.asc%20-P%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%2Fcm6%2F6.2.0%2F%5Cn%24%20sudo%20chmod%20-R%20ugo%2BrX%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%2Fcm6%22%2C%22id%22%3A%22Pt7Di%22%7D\"></card><p><br /></p><h3 id=\"POHSQ\">下载和发布<span>parcel</span> repo</h3><ol start=\"1\"><li>下载 <code>manifest.json</code> 和parcel 文件<br /><strong>CDH6</strong> </li></ol><p>CDH 6 parcel中包含 Apache Impala, Apache Kudu, Apache Spark 2, and Cloudera Search等组件，<span>以6.2.0为例，</span>在web服务器上运行下面指令，用来下载最新版的cdh 6.2，如果要换成cdh6.x的其他版本，只需要替换命令中的 <code>6.2.0</code> 即可。<span>更多6.x版本信息参见</span> <a href=\"https://www.cloudera.com/documentation/enterprise/latest/topics/rg_cdh_6_download.html#cdh_download_info\" target=\"_blank\">CDH 6 Download Information</a> 。</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20sudo%20mkdir%20-p%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%5Cn%24%20sudo%20wget%20--recursive%20--no-parent%20--no-host-directories%20https%3A%2F%2Farchive.cloudera.com%2Fcdh6%2F6.2.0%2Fparcels%2F%20-P%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%5Cn%24%20sudo%20wget%20--recursive%20--no-parent%20--no-host-directories%20https%3A%2F%2Farchive.cloudera.com%2Fgplextras6%2F6.2.0%2Fparcels%2F%20-P%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%5Cn%24%20sudo%20chmod%20-R%20ugo%2BrX%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%2Fcdh6%5Cn%24%20sudo%20chmod%20-R%20ugo%2BrX%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%2Fgplextras6%22%2C%22id%22%3A%22umMOf%22%7D\"></card><ol start=\"2\"><p>     <strong>CDH5</strong> </p><p>CDH 5 parcel中包含 Impala, Kudu, Spark 1, and Search 等组件，以5.14.4为例，在web服务器上运行以下指令，如果要换成cdh5.x的其他版本,需要替换命令中的 <code>5.14.4</code> 为指定版本号，更多5.x版本信息参见 <a href=\"https://www.cloudera.com/documentation/enterprise/release-notes/topics/cdh_vd_cdh_download.html\" target=\"_blank\">CDH Download Information</a></p></ol><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20sudo%20mkdir%20-p%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%5Cn%24%20sudo%20wget%20--recursive%20--no-parent%20--no-host-directories%20https%3A%2F%2Farchive.cloudera.com%2Fcdh5%2Fparcels%2F5.14.4%2F%20-P%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%5Cn%24%20sudo%20wget%20--recursive%20--no-parent%20--no-host-directories%20https%3A%2F%2Farchive.cloudera.com%2Fgplextras5%2Fparcels%2F5.14.4%2F%20-P%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%5Cn%24%20sudo%20chmod%20-R%20ugo%2BrX%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%2Fcdh5%5Cn%24%20sudo%20chmod%20-R%20ugo%2BrX%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%2Fgplextras5%22%2C%22id%22%3A%22a6WaR%22%7D\"></card><ol start=\"2\"><p>如果像本文实例一样，只需支持单一版本（<span>centos7.6</span>）cdh即可，为了节省时间，可以只下载具体版本。</p><p>以CDH6的为例，增加 <code>--accept-regex &quot;el7|manifest&quot;</code> ,代表只下载包含xenial和maifest的文件</p></ol><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23%20%E5%AE%98%E6%96%B9%E5%91%BD%E4%BB%A4%5Cnsudo%20wget%20--recursive%20--no-parent%20--no-host-directories%20https%3A%2F%2Farchive.cloudera.com%2Fcdh6%2F6.2.0%2Fparcels%2F%20-P%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%5Cn%23%20%E6%94%B9%E5%90%8E%E5%91%BD%E4%BB%A4%5Cnsudo%20wget%20--recursive%20--no-parent%20--accept-regex%20%5C%22el7%7Cmanifest%5C%22%20--no-host-directories%20https%3A%2F%2Farchive.cloudera.com%2Fcdh6%2F6.2.0%2Fparcels%2F%20-P%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%22%2C%22id%22%3A%22xZsDd%22%7D\"></card><ol start=\"2\"><p>如果想再快点，可以使用迅雷，axel，aria2等多线程工具快速下载后，上传到web服务器。</p><p>      <strong>Apache Accumulo for CDH</strong> </p><p>以下载Accumulo1.7.2为例,如果换成别的版本，替换命令中1.7.2即可</p><p><br /></p></ol><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20sudo%20mkdir%20-p%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%5Cn%24%20sudo%20wget%20--recursive%20--no-parent%20--no-host-directories%20https%3A%2F%2Farchive.cloudera.com%2Faccumulo-c5%2Fparcels%2F1.7.2%2F%20-P%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%5Cn%24%20sudo%20chmod%20-R%20ugo%2BrX%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%2Faccumulo-c5%22%2C%22id%22%3A%22hTBAW%22%7D\"></card><ol start=\"2\"><p>     <strong>CDS Powered By Apache Spark 2 for CDH</strong> </p><p>以下载CDS2.3.0.cloudera3为例,更多版本信息参见  <a href=\"https://www.cloudera.com/documentation/spark2/latest/topics/spark2_packaging.html#versions\" target=\"_blank\">CDS Powered By Apache Spark Version Information</a></p></ol><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20sudo%20mkdir%20-p%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%5Cn%24%20sudo%20wget%20--recursive%20--no-parent%20--no-host-directories%20https%3A%2F%2Farchive.cloudera.com%2Fspark2%2Fparcels%2F2.3.0.cloudera3%2F%20-P%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%5Cn%24%20sudo%20chmod%20-R%20ugo%2BrX%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%2Fspark2%22%2C%22id%22%3A%22AZ0zG%22%7D\"></card><ol start=\"2\"><p>     <strong>Cloudera Navigator Key Trustee Server</strong> </p><p> Key Trustee KMS parcel中包含  Cloudera Navigator HSM KMS ，从 <a href=\"http://www.cloudera.com/content/www/en-us/downloads/navigator/key-trustee-kms.html\" target=\"_blank\">download page</a> 下载Key Trustee KMS，选择指定Version，比如 <code>Navigator Key Trustee KMS 6.2.0</code> ,选择Package or Parcel,选择 <code>Parcel</code> ,选择 <code>DOWNLOAD NOW</code> ,将下载Key Trustee KMS parcels 和 manifest.json ，将下载的 <code>.tar.gz</code> 上传到web服务器上，并解压，以Key Trustee KMS 6.2.0为例</p><p><br /></p></ol><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20sudo%20mkdir%20-p%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%2Fkeytrustee-kms%5Cn%24%20sudo%20tar%20xvfz%20%2Fpath%2Fto%2Fkeytrustee-kms-6.2.0-parcels.tar.gz%20-C%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%2Fkeytrustee-kms%20--strip-components%3D1%5Cn%24%20sudo%20chmod%20-R%20ugo%2BrX%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%2Fkeytrustee-kms%22%2C%22id%22%3A%22af9iv%22%7D\"></card><ol start=\"2\"><p>     <strong>Sqoop Connectors</strong> </p><p>以下载最新版Sqoop为例</p></ol><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20sudo%20mkdir%20-p%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%5Cn%24%20sudo%20wget%20--recursive%20--no-parent%20--no-host-directories%20http%3A%2F%2Farchive.cloudera.com%2Fsqoop-connectors%2Fparcels%2Flatest%2F%20-P%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%5Cn%24%20sudo%20chmod%20-R%20ugo%2BrX%20%2Fvar%2Fwww%2Fhtml%2Fcloudera-repos%2Fsqoop-connectors%22%2C%22id%22%3A%22oi1lJ%22%7D\"></card><ol start=\"2\"><p><br /></p><li>访问repo地址 <code>http://&lt;Web_server&gt;/cloudera-repos/</code> 确保你下载的文件能够正常访问。</li></ol><p><br /></p><h3 id=\"IlmKd\">配置Cloudera Manager 使用Parcel repo</h3><ol start=\"1\"><li>两种方法二选一，配置parcel</li></ol><ol data-lake-indent=\"1\"><li>Navigation bar - 导航条</li></ol><ol data-lake-indent=\"2\"><li>点击navigation bar 的parcel图标或者点击 <code>Hosts</code> 然后点击 <code>Parcels</code> 标签</li><li>点击 <code>Configuration</code> 按钮</li></ol><ol data-lake-indent=\"1\" start=\"2\"><li>Menu - 菜单</li></ol><ol data-lake-indent=\"2\"><li>选择 <code>Administration</code> (管理) -&gt; <code>Settings</code> (设置)</li><li>选择 <code>Category</code>  &gt; <code>Parcels</code> </li></ol><ol start=\"2\"><li>在 <code>Remote Pacel Respository URLs</code> 点击添加按钮，并添加。</li><li>填上parcel地址，比如  <code>http://&lt;web_server&gt;/cloudera-parcels/cdh6/6.2.0/</code> </li><li>填写 <code>Reason for change</code>  变更原因,点击 <code>Save Changes</code> 提交保存。</li></ol><p><br /></p><h2 id=\"4qw5J\">国内镜像源</h2><p>本文写完后，发现中科大有一个CDH的反代，速度还挺快，可以按需使用。参考 <a href=\"https://github.com/ustclug/mirrorrequest/issues/56\" target=\"_blank\">ustclug/mirrorrequest#56</a> ，经测试，特别不稳定，持续两天，访问不通。</p><p><br /></p><h2 id=\"9OziU\">参考资料</h2><ul><li><a href=\"https://www.cloudera.com/documentation/enterprise/latest/topics/cm_ig_create_local_package_repo.html?cdoc-os=ubuntu+1604+xenial#internal_package_repo\" target=\"_blank\">Configuring a Local Package Repository</a></li><li><a href=\"https://www.cloudera.com/documentation/enterprise/latest/topics/cm_ig_create_local_parcel_repo.html\" target=\"_blank\">Configuring a Local Parcel Repository</a></li></ul>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-05-06T09:01:26.000Z",
    "deleted_at": null,
    "created_at": "2019-04-26T08:53:50.000Z",
    "updated_at": "2019-05-18T09:04:43.000Z",
    "published_at": "2019-05-06T09:01:26.000Z",
    "first_published_at": "2019-04-28T07:20:50.000Z",
    "word_count": 1330,
    "cover": "",
    "description": "date: 2019-04-28 19:10:00tags: [CDH,hadoop,大数据]categories: 大数据---这是坚持技术写作计划（含翻译）的第18篇，定个小目标999，每周最少2篇。目前国内还没有机构或者个人提供CDH的公共加速源，导致CDH安装时超慢，并且一旦失败后，还...",
    "custom_description": "目前国内还没有机构或者个人提供CDH的公共加速源，导致CDH安装时超慢，并且一旦失败后，还得不支持断点安装(linux机制)，配置CDH本地repo是学习cdh的第一步，否则单是安装就需要以小时为单位。",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1593594,
    "slug": "cdh-6-2-x",
    "title": "017-Centos7.6+CDH 6.2 安装和使用",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-04-25 19:10:00<br />tags: [大数据,hadoop,spark,cdh,hdp]<br />categories: 大数据<br />---\n> 这是坚持技术写作计划（含翻译）的第17篇，定个小目标999，每周最少2篇。\n\n\n本文主要介绍hadoop发行版CDH最新版(6.2)的安装。\n\n<!-- more -->\n\n\n<a name=\"x5Osz\"></a>\n## 准备\n<a name=\"hybLO\"></a>\n### 硬件配置\n| IP | HostName | OS | Cores | Mem | Disk | Rules |\n| --- | --- | --- | --- | --- | --- | --- |\n| 192.168.20.24 | cdh01.anjia.com | centos7.6 mini | 4 | 16G | 100G | CM6,CDH agent |\n| 192.168.20.25 | cdh02.anjia.com | centos7.6 mini | 4 | 16G | 100G | CDH agent |\n| 192.168.20.28 | cdh03.anjia.com | centos7.6 mini | 4 | 16G | 100G | CDH agent |\n\n<a name=\"YUZct\"></a>\n### 软件包\n本地搭建镜像源，加速构建。参考 [018-CDH6.2构建本地源加速CDH安装](https://juejin.im/post/5cc57a01f265da036c57929b)\n\n<a name=\"eLCZv\"></a>\n### 安装前准备\n<a name=\"V4FS6\"></a>\n#### CM存储空间规划\n参考 [Storage Space Planning for Cloudera Manager](https://www.cloudera.com/documentation/enterprise/6/6.2/topics/cm_ig_reqs_space.html)\n<a name=\"mC4zx\"></a>\n#### 配置网络名\n\n```bash\n# cdh01.anjia.com 192.168.20.24\nsudo hostnamectl set-hostname cdh01.anjia.com\ncat << EOF | sudo tee -a /etc/hosts\n192.168.20.24  cdh01.anjia.com  cdh01\n192.168.20.25  cdh02.anjia.com  cdh02\n192.168.20.28  cdh03.anjia.com  cdh03\nEOF\necho \"HOSTNAME=cdh01.anjia.com\" >> /etc/sysconfig/network\n\n# cdh02.anjia.com 192.168.20.25\nsudo hostnamectl set-hostname cdh02.anjia.com\ncat << EOF | sudo tee -a /etc/hosts\n192.168.20.24  cdh01.anjia.com  cdh01\n192.168.20.25  cdh02.anjia.com  cdh02\n192.168.20.28  cdh03.anjia.com  cdh03\nEOF\necho \"HOSTNAME=cdh02.anjia.com\" >> /etc/sysconfig/network\n\n# cdh03.anjia.com 192.168.20.28\nsudo hostnamectl set-hostname cdh03.anjia.com\ncat << EOF | sudo tee -a /etc/hosts\n192.168.20.24  cdh01.anjia.com  cdh01\n192.168.20.25  cdh02.anjia.com  cdh02\n192.168.20.28  cdh03.anjia.com  cdh03\nEOF\necho \"HOSTNAME=cdh03.anjia.com\" >> /etc/sysconfig/network\n```\n\n参考 [Configure Network Names](https://www.cloudera.com/documentation/enterprise/6/6.2/topics/configure_network_names.html)\n\n<a name=\"4udpU\"></a>\n#### 禁用防火墙\n每台都执行\n```bash\nsudo iptables-save > ~/firewall.rules\nsudo systemctl disable firewalld\nsudo systemctl stop firewalld\n```\n参考 [Disabling the Firewall](https://www.cloudera.com/documentation/enterprise/6/6.2/topics/install_cdh_disable_iptables.html)\n\n<a name=\"DnQF2\"></a>\n#### 开启ntp同步时钟\n每台都执行\n```bash\nyum install -y ntp\nsed -i \"/^server/ d\" /etc/ntp.conf\ncat << EOF | sudo tee -a /etc/ntp.conf\nserver ntp1.aliyun.com\nserver ntp2.aliyun.com\nserver ntp3.aliyun.com\nserver ntp4.aliyun.com\nEOF\nsudo systemctl start ntpd\nsudo systemctl enable ntpd\nntpdate -u ntp1.aliyun.com\nhwclock --systohc\n```\n\n<a name=\"dLErf\"></a>\n#### 修改repo\n每台都执行\n```bash\nsudo wget https://archive.cloudera.com/cm6/6.2.0/redhat7/yum/cloudera-manager.repo -P /etc/yum.repos.d/\nsed -i \"s/https\\:\\/\\/archive.cloudera.com/http\\:\\/\\/192.168.20.24\\/cloudera-repos/g\"  /etc/yum.repos.d/cloudera-manager.repo\nsudo rpm --import https://archive.cloudera.com/cm6/6.2.0/redhat7/yum/RPM-GPG-KEY-cloudera\n```\n<a name=\"OpEts\"></a>\n#### 优化虚拟内存需求率\n每台都执行\n```bash\necho 'vm.swappiness = 10' >> /etc/sysctl.conf\nsysctl -p\n```\n<a name=\"RRcLH\"></a>\n#### 解决透明大页面问题\n\n```bash\necho never > /sys/kernel/mm/transparent_hugepage/defrag\necho never > /sys/kernel/mm/transparent_hugepage/enabled\n```\n\n<a name=\"GBoH7\"></a>\n#### 安装jdk\n每台都执行\n\n```bash\nsudo yum install -y oracle-j2sdk1.8\n\ncat << EOF | sudo tee -a /etc/profile\n#设置java环境\nexport JAVA_HOME=/usr/java/jdk1.8.0_181-cloudera/\nexport CLASSPATH=.:\\$JAVA_HOME/lib:\\$JAVA_HOME/jre/lib:\\$CLASSPATH\nexport PATH=\\$JAVA_HOME/bin:\\$JAVA_HOME/jre/bin:\\$PATH\nEOF\nsource /etc/profile\n```\n\n<a name=\"rmtsK\"></a>\n### 安装CM和CDH\n\n<a name=\"tjzk3\"></a>\n#### 安装CM\n在cdh01.anjia.com执行\n```bash\nsudo yum install -y cloudera-manager-daemons cloudera-manager-agent cloudera-manager-server\n```\n启用Auto-TLS,在CM6.2.0人工不启用auto-tls会导致登陆不成功\n```bash\nsudo JAVA_HOME=/usr/java/jdk1.8.0_181-cloudera /opt/cloudera/cm-agent/bin/certmanager --location /opt/cloudera/CMCA setup --configure-services\n```\n\n<a name=\"F5mJx\"></a>\n#### 安装数据库\n本文选择MariaDB<br />在cdh01.anjia.com执行\n```bash\nsudo yum install -y mariadb-server\nsudo systemctl stop mariadb\ncat << EOF | sudo tee -a /etc/my.cnf.d/cdh-db.cnf\n[mysqld]\ntransaction-isolation = READ-COMMITTED\n# Disabling symbolic-links is recommended to prevent assorted security risks;\n# to do so, uncomment this line:\nsymbolic-links = 0\n# Settings user and group are ignored when systemd is used.\n# If you need to run mysqld under a different user or group,\n# customize your systemd unit file for mariadb according to the\n# instructions in http://fedoraproject.org/wiki/Systemd\n\nkey_buffer = 16M\nkey_buffer_size = 32M\nmax_allowed_packet = 32M\nthread_stack = 256K\nthread_cache_size = 64\nquery_cache_limit = 8M\nquery_cache_size = 64M\nquery_cache_type = 1\n\nmax_connections = 550\n#expire_logs_days = 10\n#max_binlog_size = 100M\n\n#log_bin should be on a disk with enough free space.\n#Replace '/var/lib/mysql/mysql_binary_log' with an appropriate path for your\n#system and chown the specified folder to the mysql user.\nlog_bin=/var/lib/mysql/mysql_binary_log\n\n#In later versions of MariaDB, if you enable the binary log and do not set\n#a server_id, MariaDB will not start. The server_id must be unique within\n#the replicating group.\nserver_id=1\n\nbinlog_format = mixed\n\nread_buffer_size = 2M\nread_rnd_buffer_size = 16M\nsort_buffer_size = 8M\njoin_buffer_size = 8M\n\n# InnoDB settings\ninnodb_file_per_table = 1\ninnodb_flush_log_at_trx_commit  = 2\ninnodb_log_buffer_size = 64M\ninnodb_buffer_pool_size = 4G\ninnodb_thread_concurrency = 8\ninnodb_flush_method = O_DIRECT\ninnodb_log_file_size = 512M\nEOF\n\n\nsudo systemctl enable mariadb\nsudo systemctl start mariadb\n\nsudo /usr/bin/mysql_secure_installation\n\n[...]\nEnter current password for root (enter for none):\nOK, successfully used password, moving on...\n[...]\nSet root password? [Y/n] Y\nNew password:\nRe-enter new password:\n[...]\nRemove anonymous users? [Y/n] Y\n[...]\nDisallow root login remotely? [Y/n] N\n[...]\nRemove test database and access to it [Y/n] Y\n[...]\nReload privilege tables now? [Y/n] Y\n[...]\nAll done!  If you've completed all of the above steps, your MariaDB\ninstallation should now be secure.\n\nThanks for using MariaDB!\n\n```\n<a name=\"so3ND\"></a>\n#### 安装数据库驱动\n每台都执行\n```bash\nwget https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-5.1.46.tar.gz\ntar zxvf mysql-connector-java-5.1.46.tar.gz\nsudo mkdir -p /usr/share/java/\ncd mysql-connector-java-5.1.46\nsudo cp mysql-connector-java-5.1.46-bin.jar /usr/share/java/mysql-connector-java.jar\n```\n\n<a name=\"VXP2c\"></a>\n#### 创建数据库\n在cdh01.anjia.com执行\n\n```bash\nmysql -u root -p<password>\n\nCREATE DATABASE <database> DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;\nGRANT ALL ON <database>.* TO '<user>'@'%' IDENTIFIED BY '<password>';\n```\n这一步scm是必须的，其余的数据库可以等后边真实使用时再创建。\n\n| Service | Database | User |\n| :---: | :---: | :---: |\n| Cloudera Manager Server | scm | scm |\n| Activity Monitor | amon | amon |\n| Reports Manager | rman | rman |\n| Hue | hue | hue |\n| Hive Metastore Server | metastore | hive |\n| Sentry Server | sentry | sentry |\n| Cloudera Navigator Audit Server | nav | nav |\n| Cloudera Navigator Metadata Server | navms | navms |\n| Oozie | oozie | oozie |\n\n<a name=\"TujCM\"></a>\n#### 配置CM数据库\n\n```bash\nsudo /opt/cloudera/cm/schema/scm_prepare_database.sh [options] <databaseType> <databaseName> <databaseUser> <password>\n# 输出\nJAVA_HOME=/usr/java/jdk1.8.0_181-cloudera\nVerifying that we can write to /etc/cloudera-scm-server\nCreating SCM configuration file in /etc/cloudera-scm-server\nExecuting:  /usr/java/jdk1.8.0_181-cloudera/bin/java -cp /usr/share/java/mysql-connector-java.jar:/usr/share/java/oracle-connector-java.jar:/usr/share/java/postgresql-connector-java.jar:/opt/cloudera/cm/schema/../lib/* com.cloudera.enterprise.dbutil.DbCommandExecutor /etc/cloudera-scm-server/db.properties com.cloudera.cmf.db.\n[                          main] DbCommandExecutor              INFO  Successfully connected to database.\nAll done, your SCM database is configured correctly!\n```\n详细参数，参考 [Syntax for scm_prepare_database.sh](https://www.cloudera.com/documentation/enterprise/latest/topics/prepare_cm_database.html#scm_prepare_syntax)\n\n<a name=\"ZjPAa\"></a>\n#### 安装CDH和其他软件\n\n```bash\nsudo systemctl start cloudera-scm-server\n# 启动后，监听server日志，大约1-3分钟左右\nsudo tail -f /var/log/cloudera-scm-server/cloudera-scm-server.log\n# 直到日志出现，如下内容，即启动成功。\n2019-05-08 13:12:26,523 INFO WebServerImpl:com.cloudera.server.cmf.WebServerImpl: Started Jetty server.\n```\n参考资料<br />\n\n- [CDH 6.2.x Packaging](https://www.cloudera.com/documentation/enterprise/6/release-notes/topics/rg_cdh_62_packaging.html)\n",
    "body_draft": "",
    "body_html": "<p><span>date: 2019-04-25 19:10:00</span></p><p>tags: [大数据,hadoop,spark,cdh,hdp]</p><p>categories: 大数据</p><p>---</p><blockquote><p>这是坚持技术写作计划（含翻译）的第17篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要介绍hadoop发行版CDH最新版(6.2)的安装。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><p><br /></p><h2 id=\"x5Osz\">准备</h2><h3 id=\"hybLO\">硬件配置</h3><table class=\"lake-table\" style=\"width: 1681px;\"><colgroup><col width=\"240\"></col><col width=\"240\"></col><col width=\"240\"></col><col width=\"240\"></col><col width=\"240\"></col><col width=\"240\"></col><col width=\"240\"></col></colgroup><tbody><tr><td><p>IP</p></td><td><p>HostName</p></td><td><p>OS</p></td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>Cores</p></td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>Mem</p></td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>Disk</p></td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>Rules</p></td></tr><tr><td><p>192.168.20.24</p></td><td><p>cdh01.anjia.com</p></td><td><p>centos7.6 mini</p></td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>4</p></td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>16G</p></td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>100G</p></td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>CM6,CDH agent</p></td></tr><tr><td><p>192.168.20.25</p></td><td><p>cdh02.anjia.com</p></td><td><p>centos7.6 mini</p></td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>4</p></td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>16G</p></td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>100G</p></td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>CDH agent</p></td></tr><tr><td colspan=\"1\"><p>192.168.20.28</p></td><td colspan=\"1\"><p>cdh03.anjia.com</p></td><td colspan=\"1\"><p>centos7.6 mini</p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p>4</p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p>16G</p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p>100G</p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p>CDH agent</p></td></tr></tbody></table><h3 id=\"YUZct\">软件包</h3><p>本地搭建镜像源，加速构建。参考 <a href=\"https://juejin.im/post/5cc57a01f265da036c57929b\" target=\"_blank\">018-CDH6.2构建本地源加速CDH安装</a></p><p><br /></p><h3 id=\"eLCZv\">安装前准备</h3><h4 id=\"V4FS6\">CM存储空间规划</h4><p>参考 <a href=\"https://www.cloudera.com/documentation/enterprise/6/6.2/topics/cm_ig_reqs_space.html\" target=\"_blank\">Storage Space Planning for Cloudera Manager</a></p><h4 id=\"mC4zx\">配置网络名</h4><p><br /></p><pre data-lang=\"bash\"><code># cdh01.anjia.com 192.168.20.24\nsudo hostnamectl set-hostname cdh01.anjia.com\ncat &lt;&lt; EOF | sudo tee -a /etc/hosts\n192.168.20.24  cdh01.anjia.com  cdh01\n192.168.20.25  cdh02.anjia.com  cdh02\n192.168.20.28  cdh03.anjia.com  cdh03\nEOF\necho &quot;HOSTNAME=cdh01.anjia.com&quot; &gt;&gt; /etc/sysconfig/network\n\n# cdh02.anjia.com 192.168.20.25\nsudo hostnamectl set-hostname cdh02.anjia.com\ncat &lt;&lt; EOF | sudo tee -a /etc/hosts\n192.168.20.24  cdh01.anjia.com  cdh01\n192.168.20.25  cdh02.anjia.com  cdh02\n192.168.20.28  cdh03.anjia.com  cdh03\nEOF\necho &quot;HOSTNAME=cdh02.anjia.com&quot; &gt;&gt; /etc/sysconfig/network\n\n# cdh03.anjia.com 192.168.20.28\nsudo hostnamectl set-hostname cdh03.anjia.com\ncat &lt;&lt; EOF | sudo tee -a /etc/hosts\n192.168.20.24  cdh01.anjia.com  cdh01\n192.168.20.25  cdh02.anjia.com  cdh02\n192.168.20.28  cdh03.anjia.com  cdh03\nEOF\necho &quot;HOSTNAME=cdh03.anjia.com&quot; &gt;&gt; /etc/sysconfig/network</code></pre><p><br /></p><p>参考 <a href=\"https://www.cloudera.com/documentation/enterprise/6/6.2/topics/configure_network_names.html\" target=\"_blank\">Configure Network Names</a></p><p><br /></p><h4 id=\"4udpU\">禁用防火墙</h4><p>每台都执行</p><pre data-lang=\"bash\"><code>sudo iptables-save &gt; ~/firewall.rules\nsudo systemctl disable firewalld\nsudo systemctl stop firewalld</code></pre><p>参考 <a href=\"https://www.cloudera.com/documentation/enterprise/6/6.2/topics/install_cdh_disable_iptables.html\" target=\"_blank\">Disabling the Firewall</a></p><p><br /></p><h4 id=\"DnQF2\">开启ntp同步时钟</h4><p>每台都执行</p><pre data-lang=\"bash\"><code>yum install -y ntp\nsed -i &quot;/^server/ d&quot; /etc/ntp.conf\ncat &lt;&lt; EOF | sudo tee -a /etc/ntp.conf\nserver ntp1.aliyun.com\nserver ntp2.aliyun.com\nserver ntp3.aliyun.com\nserver ntp4.aliyun.com\nEOF\nsudo systemctl start ntpd\nsudo systemctl enable ntpd\nntpdate -u ntp1.aliyun.com\nhwclock --systohc</code></pre><p><br /></p><h4 id=\"dLErf\">修改repo</h4><p>每台都执行</p><pre data-lang=\"bash\"><code>sudo wget https://archive.cloudera.com/cm6/6.2.0/redhat7/yum/cloudera-manager.repo -P /etc/yum.repos.d/\nsed -i &quot;s/https\\:\\/\\/archive.cloudera.com/http\\:\\/\\/192.168.20.24\\/cloudera-repos/g&quot;  /etc/yum.repos.d/cloudera-manager.repo\nsudo rpm --import https://archive.cloudera.com/cm6/6.2.0/redhat7/yum/RPM-GPG-KEY-cloudera</code></pre><h4 id=\"OpEts\">优化虚拟内存需求率</h4><p>每台都执行</p><pre data-lang=\"bash\"><code>echo 'vm.swappiness = 10' &gt;&gt; /etc/sysctl.conf\nsysctl -p</code></pre><h4 id=\"RRcLH\">解决透明大页面问题</h4><p><br /></p><pre data-lang=\"bash\"><code>echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag\necho never &gt; /sys/kernel/mm/transparent_hugepage/enabled</code></pre><p><br /></p><h4 id=\"GBoH7\">安装jdk</h4><p>每台都执行</p><p><br /></p><pre data-lang=\"bash\"><code>sudo yum install -y oracle-j2sdk1.8\n\ncat &lt;&lt; EOF | sudo tee -a /etc/profile\n#设置java环境\nexport JAVA_HOME=/usr/java/jdk1.8.0_181-cloudera/\nexport CLASSPATH=.:\\$JAVA_HOME/lib:\\$JAVA_HOME/jre/lib:\\$CLASSPATH\nexport PATH=\\$JAVA_HOME/bin:\\$JAVA_HOME/jre/bin:\\$PATH\nEOF\nsource /etc/profile</code></pre><p><br /></p><h3 id=\"rmtsK\">安装CM和CDH</h3><p><br /></p><h4 id=\"tjzk3\">安装CM</h4><p>在cdh01.anjia.com执行</p><pre data-lang=\"bash\"><code>sudo yum install -y cloudera-manager-daemons cloudera-manager-agent cloudera-manager-server</code></pre><p>启用Auto-TLS,在CM6.2.0人工不启用auto-tls会导致登陆不成功</p><pre data-lang=\"bash\"><code>sudo JAVA_HOME=/usr/java/jdk1.8.0_181-cloudera /opt/cloudera/cm-agent/bin/certmanager --location /opt/cloudera/CMCA setup --configure-services</code></pre><p><br /></p><h4 id=\"F5mJx\">安装数据库</h4><p>本文选择MariaDB</p><p><span>在cdh01.anjia.com执行</span></p><pre data-lang=\"bash\"><code>sudo yum install -y mariadb-server\nsudo systemctl stop mariadb\ncat &lt;&lt; EOF | sudo tee -a /etc/my.cnf.d/cdh-db.cnf\n[mysqld]\ntransaction-isolation = READ-COMMITTED\n# Disabling symbolic-links is recommended to prevent assorted security risks;\n# to do so, uncomment this line:\nsymbolic-links = 0\n# Settings user and group are ignored when systemd is used.\n# If you need to run mysqld under a different user or group,\n# customize your systemd unit file for mariadb according to the\n# instructions in http://fedoraproject.org/wiki/Systemd\n\nkey_buffer = 16M\nkey_buffer_size = 32M\nmax_allowed_packet = 32M\nthread_stack = 256K\nthread_cache_size = 64\nquery_cache_limit = 8M\nquery_cache_size = 64M\nquery_cache_type = 1\n\nmax_connections = 550\n#expire_logs_days = 10\n#max_binlog_size = 100M\n\n#log_bin should be on a disk with enough free space.\n#Replace '/var/lib/mysql/mysql_binary_log' with an appropriate path for your\n#system and chown the specified folder to the mysql user.\nlog_bin=/var/lib/mysql/mysql_binary_log\n\n#In later versions of MariaDB, if you enable the binary log and do not set\n#a server_id, MariaDB will not start. The server_id must be unique within\n#the replicating group.\nserver_id=1\n\nbinlog_format = mixed\n\nread_buffer_size = 2M\nread_rnd_buffer_size = 16M\nsort_buffer_size = 8M\njoin_buffer_size = 8M\n\n# InnoDB settings\ninnodb_file_per_table = 1\ninnodb_flush_log_at_trx_commit  = 2\ninnodb_log_buffer_size = 64M\ninnodb_buffer_pool_size = 4G\ninnodb_thread_concurrency = 8\ninnodb_flush_method = O_DIRECT\ninnodb_log_file_size = 512M\nEOF\n\n\nsudo systemctl enable mariadb\nsudo systemctl start mariadb\n\nsudo /usr/bin/mysql_secure_installation\n\n[...]\nEnter current password for root (enter for none):\nOK, successfully used password, moving on...\n[...]\nSet root password? [Y/n] Y\nNew password:\nRe-enter new password:\n[...]\nRemove anonymous users? [Y/n] Y\n[...]\nDisallow root login remotely? [Y/n] N\n[...]\nRemove test database and access to it [Y/n] Y\n[...]\nReload privilege tables now? [Y/n] Y\n[...]\nAll done!  If you've completed all of the above steps, your MariaDB\ninstallation should now be secure.\n\nThanks for using MariaDB!\n</code></pre><h4 id=\"so3ND\">安装数据库驱动</h4><p>每台都执行</p><pre data-lang=\"bash\"><code>wget https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-5.1.46.tar.gz\ntar zxvf mysql-connector-java-5.1.46.tar.gz\nsudo mkdir -p /usr/share/java/\ncd mysql-connector-java-5.1.46\nsudo cp mysql-connector-java-5.1.46-bin.jar /usr/share/java/mysql-connector-java.jar</code></pre><p><br /></p><h4 id=\"VXP2c\">创建数据库</h4><p><span>在cdh01.anjia.com执行</span></p><p><br /></p><pre data-lang=\"bash\"><code>mysql -u root -p&lt;password&gt;\n\nCREATE DATABASE &lt;database&gt; DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;\nGRANT ALL ON &lt;database&gt;.* TO '&lt;user&gt;'@'%' IDENTIFIED BY '&lt;password&gt;';</code></pre><p>这一步scm是必须的，其余的数据库可以等后边真实使用时再创建。</p><table class=\"lake-table\" style=\"width: 721px;\"><colgroup><col width=\"240\"></col><col width=\"240\"></col><col width=\"240\"></col></colgroup><tbody><tr><td style=\"text-align: center;\">Service</td><td style=\"text-align: center;\">Database</td><td style=\"text-align: center;\">User</td></tr></tbody><tbody><tr><td style=\"text-align: center;\">Cloudera Manager Server</td><td style=\"text-align: center;\">scm</td><td style=\"text-align: center;\">scm</td></tr><tr><td style=\"text-align: center;\">Activity Monitor</td><td style=\"text-align: center;\">amon</td><td style=\"text-align: center;\">amon</td></tr><tr><td style=\"text-align: center;\">Reports Manager</td><td style=\"text-align: center;\">rman</td><td style=\"text-align: center;\">rman</td></tr><tr><td style=\"text-align: center;\">Hue</td><td style=\"text-align: center;\">hue</td><td style=\"text-align: center;\">hue</td></tr><tr><td style=\"text-align: center;\">Hive Metastore Server</td><td style=\"text-align: center;\">metastore</td><td style=\"text-align: center;\">hive</td></tr><tr><td style=\"text-align: center;\">Sentry Server</td><td style=\"text-align: center;\">sentry</td><td style=\"text-align: center;\">sentry</td></tr><tr><td style=\"text-align: center;\">Cloudera Navigator Audit Server</td><td style=\"text-align: center;\">nav</td><td style=\"text-align: center;\">nav</td></tr><tr><td style=\"text-align: center;\">Cloudera Navigator Metadata Server</td><td style=\"text-align: center;\">navms</td><td style=\"text-align: center;\">navms</td></tr><tr><td style=\"text-align: center;\">Oozie</td><td style=\"text-align: center;\">oozie</td><td style=\"text-align: center;\">oozie</td></tr></tbody></table><h4 id=\"TujCM\">配置CM数据库</h4><p><br /></p><pre data-lang=\"bash\"><code>sudo /opt/cloudera/cm/schema/scm_prepare_database.sh [options] &lt;databaseType&gt; &lt;databaseName&gt; &lt;databaseUser&gt; &lt;password&gt;\n# 输出\nJAVA_HOME=/usr/java/jdk1.8.0_181-cloudera\nVerifying that we can write to /etc/cloudera-scm-server\nCreating SCM configuration file in /etc/cloudera-scm-server\nExecuting:  /usr/java/jdk1.8.0_181-cloudera/bin/java -cp /usr/share/java/mysql-connector-java.jar:/usr/share/java/oracle-connector-java.jar:/usr/share/java/postgresql-connector-java.jar:/opt/cloudera/cm/schema/../lib/* com.cloudera.enterprise.dbutil.DbCommandExecutor /etc/cloudera-scm-server/db.properties com.cloudera.cmf.db.\n[                          main] DbCommandExecutor              INFO  Successfully connected to database.\nAll done, your SCM database is configured correctly!</code></pre><p>详细参数，参考 <a href=\"https://www.cloudera.com/documentation/enterprise/latest/topics/prepare_cm_database.html#scm_prepare_syntax\" target=\"_blank\">Syntax for scm_prepare_database.sh</a></p><p><br /></p><h4 id=\"ZjPAa\">安装CDH和其他软件</h4><p><br /></p><pre data-lang=\"bash\"><code>sudo systemctl start cloudera-scm-server\n# 启动后，监听server日志，大约1-3分钟左右\nsudo tail -f /var/log/cloudera-scm-server/cloudera-scm-server.log\n# 直到日志出现，如下内容，即启动成功。\n2019-05-08 13:12:26,523 INFO WebServerImpl:com.cloudera.server.cmf.WebServerImpl: Started Jetty server.</code></pre><p><span style=\"background-color: transparent;\">参考资料</span><br /></p><ul><li><a href=\"https://www.cloudera.com/documentation/enterprise/6/release-notes/topics/rg_cdh_62_packaging.html\" target=\"_blank\">CDH 6.2.x Packaging</a></li></ul>",
    "body_lake": "<!doctype lake><p><span>date: 2019-04-25 19:10:00</span></p><p>tags: [大数据,hadoop,spark,cdh,hdp]</p><p>categories: 大数据</p><p>---</p><blockquote><p>这是坚持技术写作计划（含翻译）的第17篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要介绍hadoop发行版CDH最新版(6.2)的安装。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><p><br /></p><h2 id=\"x5Osz\">准备</h2><h3 id=\"hybLO\">硬件配置</h3><card type=\"block\" name=\"table\" value=\"data:%7B%22rows%22%3A4%2C%22cols%22%3A7%2C%22html%22%3A%22%3Ctable%20class%3D%5C%22lake-table%5C%22%20style%3D%5C%22width%3A%201681px%3B%5C%22%3E%3Ccolgroup%3E%3Ccol%20width%3D%5C%22240%5C%22%20span%3D%5C%221%5C%22%20%2F%3E%3Ccol%20width%3D%5C%22240%5C%22%20span%3D%5C%221%5C%22%20%2F%3E%3Ccol%20width%3D%5C%22240%5C%22%20span%3D%5C%221%5C%22%20%2F%3E%3Ccol%20width%3D%5C%22240%5C%22%20span%3D%5C%221%5C%22%20%2F%3E%3Ccol%20width%3D%5C%22240%5C%22%20span%3D%5C%221%5C%22%20%2F%3E%3Ccol%20width%3D%5C%22240%5C%22%20span%3D%5C%221%5C%22%20%2F%3E%3Ccol%20width%3D%5C%22240%5C%22%20span%3D%5C%221%5C%22%20%2F%3E%3C%2Fcolgroup%3E%3Ctbody%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3E%3Cp%3EIP%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%3Cp%3EHostName%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%3Cp%3EOS%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3ECores%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3EMem%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3EDisk%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3ERules%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3E%3Cp%3E192.168.20.24%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%3Cp%3Ecdh01.anjia.com%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%3Cp%3Ecentos7.6%20mini%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E4%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E16G%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E100G%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3ECM6%2CCDH%20agent%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3E%3Cp%3E192.168.20.25%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%3Cp%3Ecdh02.anjia.com%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%3Cp%3Ecentos7.6%20mini%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E4%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E16G%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E100G%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3ECDH%20agent%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20colspan%3D%5C%221%5C%22%3E%3Cp%3E192.168.20.28%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%3E%3Cp%3Ecdh03.anjia.com%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%3E%3Cp%3Ecentos7.6%20mini%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E4%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E16G%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E100G%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3ECDH%20agent%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3C%2Ftbody%3E%3C%2Ftable%3E%22%2C%22id%22%3A%22t0bGq%22%7D\"></card><h3 id=\"YUZct\">软件包</h3><p>本地搭建镜像源，加速构建。参考 <a href=\"https://juejin.im/post/5cc57a01f265da036c57929b\" target=\"_blank\">018-CDH6.2构建本地源加速CDH安装</a></p><p><br /></p><h3 id=\"eLCZv\">安装前准备</h3><h4 id=\"V4FS6\">CM存储空间规划</h4><p>参考 <a href=\"https://www.cloudera.com/documentation/enterprise/6/6.2/topics/cm_ig_reqs_space.html\" target=\"_blank\">Storage Space Planning for Cloudera Manager</a></p><h4 id=\"mC4zx\">配置网络名</h4><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23%20cdh01.anjia.com%20192.168.20.24%5Cnsudo%20hostnamectl%20set-hostname%20cdh01.anjia.com%5Cncat%20%3C%3C%20EOF%20%7C%20sudo%20tee%20-a%20%2Fetc%2Fhosts%5Cn192.168.20.24%20%20cdh01.anjia.com%20%20cdh01%5Cn192.168.20.25%20%20cdh02.anjia.com%20%20cdh02%5Cn192.168.20.28%20%20cdh03.anjia.com%20%20cdh03%5CnEOF%5Cnecho%20%5C%22HOSTNAME%3Dcdh01.anjia.com%5C%22%20%3E%3E%20%2Fetc%2Fsysconfig%2Fnetwork%5Cn%5Cn%23%20cdh02.anjia.com%20192.168.20.25%5Cnsudo%20hostnamectl%20set-hostname%20cdh02.anjia.com%5Cncat%20%3C%3C%20EOF%20%7C%20sudo%20tee%20-a%20%2Fetc%2Fhosts%5Cn192.168.20.24%20%20cdh01.anjia.com%20%20cdh01%5Cn192.168.20.25%20%20cdh02.anjia.com%20%20cdh02%5Cn192.168.20.28%20%20cdh03.anjia.com%20%20cdh03%5CnEOF%5Cnecho%20%5C%22HOSTNAME%3Dcdh02.anjia.com%5C%22%20%3E%3E%20%2Fetc%2Fsysconfig%2Fnetwork%5Cn%5Cn%23%20cdh03.anjia.com%20192.168.20.28%5Cnsudo%20hostnamectl%20set-hostname%20cdh03.anjia.com%5Cncat%20%3C%3C%20EOF%20%7C%20sudo%20tee%20-a%20%2Fetc%2Fhosts%5Cn192.168.20.24%20%20cdh01.anjia.com%20%20cdh01%5Cn192.168.20.25%20%20cdh02.anjia.com%20%20cdh02%5Cn192.168.20.28%20%20cdh03.anjia.com%20%20cdh03%5CnEOF%5Cnecho%20%5C%22HOSTNAME%3Dcdh03.anjia.com%5C%22%20%3E%3E%20%2Fetc%2Fsysconfig%2Fnetwork%22%2C%22id%22%3A%22oWEtg%22%7D\"></card><p><br /></p><p>参考 <a href=\"https://www.cloudera.com/documentation/enterprise/6/6.2/topics/configure_network_names.html\" target=\"_blank\">Configure Network Names</a></p><p><br /></p><h4 id=\"4udpU\">禁用防火墙</h4><p>每台都执行</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22sudo%20iptables-save%20%3E%20~%2Ffirewall.rules%5Cnsudo%20systemctl%20disable%20firewalld%5Cnsudo%20systemctl%20stop%20firewalld%22%2C%22id%22%3A%22978Zq%22%7D\"></card><p>参考 <a href=\"https://www.cloudera.com/documentation/enterprise/6/6.2/topics/install_cdh_disable_iptables.html\" target=\"_blank\">Disabling the Firewall</a></p><p><br /></p><h4 id=\"DnQF2\">开启ntp同步时钟</h4><p>每台都执行</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22yum%20install%20-y%20ntp%5Cnsed%20-i%20%5C%22%2F%5Eserver%2F%20d%5C%22%20%2Fetc%2Fntp.conf%5Cncat%20%3C%3C%20EOF%20%7C%20sudo%20tee%20-a%20%2Fetc%2Fntp.conf%5Cnserver%20ntp1.aliyun.com%5Cnserver%20ntp2.aliyun.com%5Cnserver%20ntp3.aliyun.com%5Cnserver%20ntp4.aliyun.com%5CnEOF%5Cnsudo%20systemctl%20start%20ntpd%5Cnsudo%20systemctl%20enable%20ntpd%5Cnntpdate%20-u%20ntp1.aliyun.com%5Cnhwclock%20--systohc%22%2C%22id%22%3A%22lCYgo%22%7D\"></card><p><br /></p><h4 id=\"dLErf\">修改repo</h4><p>每台都执行</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22sudo%20wget%20https%3A%2F%2Farchive.cloudera.com%2Fcm6%2F6.2.0%2Fredhat7%2Fyum%2Fcloudera-manager.repo%20-P%20%2Fetc%2Fyum.repos.d%2F%5Cnsed%20-i%20%5C%22s%2Fhttps%5C%5C%3A%5C%5C%2F%5C%5C%2Farchive.cloudera.com%2Fhttp%5C%5C%3A%5C%5C%2F%5C%5C%2F192.168.20.24%5C%5C%2Fcloudera-repos%2Fg%5C%22%20%20%2Fetc%2Fyum.repos.d%2Fcloudera-manager.repo%5Cnsudo%20rpm%20--import%20https%3A%2F%2Farchive.cloudera.com%2Fcm6%2F6.2.0%2Fredhat7%2Fyum%2FRPM-GPG-KEY-cloudera%22%2C%22id%22%3A%22kzkRP%22%7D\"></card><h4 id=\"OpEts\">优化虚拟内存需求率</h4><p>每台都执行</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22echo%20'vm.swappiness%20%3D%2010'%20%3E%3E%20%2Fetc%2Fsysctl.conf%5Cnsysctl%20-p%22%2C%22id%22%3A%22jJAnM%22%7D\"></card><h4 id=\"RRcLH\">解决透明大页面问题</h4><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22echo%20never%20%3E%20%2Fsys%2Fkernel%2Fmm%2Ftransparent_hugepage%2Fdefrag%5Cnecho%20never%20%3E%20%2Fsys%2Fkernel%2Fmm%2Ftransparent_hugepage%2Fenabled%22%2C%22id%22%3A%22zTwjz%22%7D\"></card><p><br /></p><h4 id=\"GBoH7\">安装jdk</h4><p>每台都执行</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22sudo%20yum%20install%20-y%20oracle-j2sdk1.8%5Cn%5Cncat%20%3C%3C%20EOF%20%7C%20sudo%20tee%20-a%20%2Fetc%2Fprofile%5Cn%23%E8%AE%BE%E7%BD%AEjava%E7%8E%AF%E5%A2%83%5Cnexport%20JAVA_HOME%3D%2Fusr%2Fjava%2Fjdk1.8.0_181-cloudera%2F%5Cnexport%20CLASSPATH%3D.%3A%5C%5C%24JAVA_HOME%2Flib%3A%5C%5C%24JAVA_HOME%2Fjre%2Flib%3A%5C%5C%24CLASSPATH%5Cnexport%20PATH%3D%5C%5C%24JAVA_HOME%2Fbin%3A%5C%5C%24JAVA_HOME%2Fjre%2Fbin%3A%5C%5C%24PATH%5CnEOF%5Cnsource%20%2Fetc%2Fprofile%22%2C%22id%22%3A%22xz156%22%7D\"></card><p><br /></p><h3 id=\"rmtsK\">安装CM和CDH</h3><p><br /></p><h4 id=\"tjzk3\">安装CM</h4><p>在cdh01.anjia.com执行</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22sudo%20yum%20install%20-y%20cloudera-manager-daemons%20cloudera-manager-agent%20cloudera-manager-server%22%2C%22id%22%3A%22EWLJi%22%7D\"></card><p>启用Auto-TLS,在CM6.2.0人工不启用auto-tls会导致登陆不成功</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22sudo%20JAVA_HOME%3D%2Fusr%2Fjava%2Fjdk1.8.0_181-cloudera%20%2Fopt%2Fcloudera%2Fcm-agent%2Fbin%2Fcertmanager%20--location%20%2Fopt%2Fcloudera%2FCMCA%20setup%20--configure-services%22%2C%22id%22%3A%22WeavL%22%7D\"></card><p><br /></p><h4 id=\"F5mJx\">安装数据库</h4><p>本文选择MariaDB</p><p><span>在cdh01.anjia.com执行</span></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22sudo%20yum%20install%20-y%20mariadb-server%5Cnsudo%20systemctl%20stop%20mariadb%5Cncat%20%3C%3C%20EOF%20%7C%20sudo%20tee%20-a%20%2Fetc%2Fmy.cnf.d%2Fcdh-db.cnf%5Cn%5Bmysqld%5D%5Cntransaction-isolation%20%3D%20READ-COMMITTED%5Cn%23%20Disabling%20symbolic-links%20is%20recommended%20to%20prevent%20assorted%20security%20risks%3B%5Cn%23%20to%20do%20so%2C%20uncomment%20this%20line%3A%5Cnsymbolic-links%20%3D%200%5Cn%23%20Settings%20user%20and%20group%20are%20ignored%20when%20systemd%20is%20used.%5Cn%23%20If%20you%20need%20to%20run%20mysqld%20under%20a%20different%20user%20or%20group%2C%5Cn%23%20customize%20your%20systemd%20unit%20file%20for%20mariadb%20according%20to%20the%5Cn%23%20instructions%20in%20http%3A%2F%2Ffedoraproject.org%2Fwiki%2FSystemd%5Cn%5Cnkey_buffer%20%3D%2016M%5Cnkey_buffer_size%20%3D%2032M%5Cnmax_allowed_packet%20%3D%2032M%5Cnthread_stack%20%3D%20256K%5Cnthread_cache_size%20%3D%2064%5Cnquery_cache_limit%20%3D%208M%5Cnquery_cache_size%20%3D%2064M%5Cnquery_cache_type%20%3D%201%5Cn%5Cnmax_connections%20%3D%20550%5Cn%23expire_logs_days%20%3D%2010%5Cn%23max_binlog_size%20%3D%20100M%5Cn%5Cn%23log_bin%20should%20be%20on%20a%20disk%20with%20enough%20free%20space.%5Cn%23Replace%20'%2Fvar%2Flib%2Fmysql%2Fmysql_binary_log'%20with%20an%20appropriate%20path%20for%20your%5Cn%23system%20and%20chown%20the%20specified%20folder%20to%20the%20mysql%20user.%5Cnlog_bin%3D%2Fvar%2Flib%2Fmysql%2Fmysql_binary_log%5Cn%5Cn%23In%20later%20versions%20of%20MariaDB%2C%20if%20you%20enable%20the%20binary%20log%20and%20do%20not%20set%5Cn%23a%20server_id%2C%20MariaDB%20will%20not%20start.%20The%20server_id%20must%20be%20unique%20within%5Cn%23the%20replicating%20group.%5Cnserver_id%3D1%5Cn%5Cnbinlog_format%20%3D%20mixed%5Cn%5Cnread_buffer_size%20%3D%202M%5Cnread_rnd_buffer_size%20%3D%2016M%5Cnsort_buffer_size%20%3D%208M%5Cnjoin_buffer_size%20%3D%208M%5Cn%5Cn%23%20InnoDB%20settings%5Cninnodb_file_per_table%20%3D%201%5Cninnodb_flush_log_at_trx_commit%20%20%3D%202%5Cninnodb_log_buffer_size%20%3D%2064M%5Cninnodb_buffer_pool_size%20%3D%204G%5Cninnodb_thread_concurrency%20%3D%208%5Cninnodb_flush_method%20%3D%20O_DIRECT%5Cninnodb_log_file_size%20%3D%20512M%5CnEOF%5Cn%5Cn%5Cnsudo%20systemctl%20enable%20mariadb%5Cnsudo%20systemctl%20start%20mariadb%5Cn%5Cnsudo%20%2Fusr%2Fbin%2Fmysql_secure_installation%5Cn%5Cn%5B...%5D%5CnEnter%20current%20password%20for%20root%20(enter%20for%20none)%3A%5CnOK%2C%20successfully%20used%20password%2C%20moving%20on...%5Cn%5B...%5D%5CnSet%20root%20password%3F%20%5BY%2Fn%5D%20Y%5CnNew%20password%3A%5CnRe-enter%20new%20password%3A%5Cn%5B...%5D%5CnRemove%20anonymous%20users%3F%20%5BY%2Fn%5D%20Y%5Cn%5B...%5D%5CnDisallow%20root%20login%20remotely%3F%20%5BY%2Fn%5D%20N%5Cn%5B...%5D%5CnRemove%20test%20database%20and%20access%20to%20it%20%5BY%2Fn%5D%20Y%5Cn%5B...%5D%5CnReload%20privilege%20tables%20now%3F%20%5BY%2Fn%5D%20Y%5Cn%5B...%5D%5CnAll%20done!%20%20If%20you've%20completed%20all%20of%20the%20above%20steps%2C%20your%20MariaDB%5Cninstallation%20should%20now%20be%20secure.%5Cn%5CnThanks%20for%20using%20MariaDB!%5Cn%22%2C%22id%22%3A%22jjgQs%22%7D\"></card><h4 id=\"so3ND\">安装数据库驱动</h4><p>每台都执行</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22wget%20https%3A%2F%2Fdev.mysql.com%2Fget%2FDownloads%2FConnector-J%2Fmysql-connector-java-5.1.46.tar.gz%5Cntar%20zxvf%20mysql-connector-java-5.1.46.tar.gz%5Cnsudo%20mkdir%20-p%20%2Fusr%2Fshare%2Fjava%2F%5Cncd%20mysql-connector-java-5.1.46%5Cnsudo%20cp%20mysql-connector-java-5.1.46-bin.jar%20%2Fusr%2Fshare%2Fjava%2Fmysql-connector-java.jar%22%2C%22id%22%3A%22fftLN%22%7D\"></card><p><br /></p><h4 id=\"VXP2c\">创建数据库</h4><p><span>在cdh01.anjia.com执行</span></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22mysql%20-u%20root%20-p%3Cpassword%3E%5Cn%5CnCREATE%20DATABASE%20%3Cdatabase%3E%20DEFAULT%20CHARACTER%20SET%20utf8%20DEFAULT%20COLLATE%20utf8_general_ci%3B%5CnGRANT%20ALL%20ON%20%3Cdatabase%3E.*%20TO%20'%3Cuser%3E'%40'%25'%20IDENTIFIED%20BY%20'%3Cpassword%3E'%3B%22%2C%22id%22%3A%22ouBGN%22%7D\"></card><p>这一步scm是必须的，其余的数据库可以等后边真实使用时再创建。</p><card type=\"block\" name=\"table\" value=\"data:%7B%22rows%22%3A10%2C%22cols%22%3A3%2C%22html%22%3A%22%3Ctable%20class%3D%5C%22lake-table%5C%22%20style%3D%5C%22width%3A%20721px%3B%5C%22%3E%3Ccolgroup%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22240%5C%22%20%2F%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22240%5C%22%20%2F%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22240%5C%22%20%2F%3E%3C%2Fcolgroup%3E%3Ctbody%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3EService%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3EDatabase%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3EUser%3C%2Ftd%3E%3C%2Ftr%3E%3C%2Ftbody%3E%3Ctbody%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3ECloudera%20Manager%20Server%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Escm%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Escm%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3EActivity%20Monitor%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Eamon%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Eamon%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3EReports%20Manager%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Erman%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Erman%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3EHue%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Ehue%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Ehue%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3EHive%20Metastore%20Server%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Emetastore%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Ehive%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3ESentry%20Server%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Esentry%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Esentry%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3ECloudera%20Navigator%20Audit%20Server%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Enav%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Enav%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3ECloudera%20Navigator%20Metadata%20Server%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Enavms%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Enavms%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3EOozie%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Eoozie%3C%2Ftd%3E%3Ctd%20style%3D%5C%22text-align%3A%20center%3B%5C%22%3Eoozie%3C%2Ftd%3E%3C%2Ftr%3E%3C%2Ftbody%3E%3C%2Ftable%3E%22%2C%22id%22%3A%221bec0189%22%7D\"></card><h4 id=\"TujCM\">配置CM数据库</h4><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22sudo%20%2Fopt%2Fcloudera%2Fcm%2Fschema%2Fscm_prepare_database.sh%20%5Boptions%5D%20%3CdatabaseType%3E%20%3CdatabaseName%3E%20%3CdatabaseUser%3E%20%3Cpassword%3E%5Cn%23%20%E8%BE%93%E5%87%BA%5CnJAVA_HOME%3D%2Fusr%2Fjava%2Fjdk1.8.0_181-cloudera%5CnVerifying%20that%20we%20can%20write%20to%20%2Fetc%2Fcloudera-scm-server%5CnCreating%20SCM%20configuration%20file%20in%20%2Fetc%2Fcloudera-scm-server%5CnExecuting%3A%20%20%2Fusr%2Fjava%2Fjdk1.8.0_181-cloudera%2Fbin%2Fjava%20-cp%20%2Fusr%2Fshare%2Fjava%2Fmysql-connector-java.jar%3A%2Fusr%2Fshare%2Fjava%2Foracle-connector-java.jar%3A%2Fusr%2Fshare%2Fjava%2Fpostgresql-connector-java.jar%3A%2Fopt%2Fcloudera%2Fcm%2Fschema%2F..%2Flib%2F*%20com.cloudera.enterprise.dbutil.DbCommandExecutor%20%2Fetc%2Fcloudera-scm-server%2Fdb.properties%20com.cloudera.cmf.db.%5Cn%5B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20main%5D%20DbCommandExecutor%20%20%20%20%20%20%20%20%20%20%20%20%20%20INFO%20%20Successfully%20connected%20to%20database.%5CnAll%20done%2C%20your%20SCM%20database%20is%20configured%20correctly!%22%2C%22id%22%3A%22jUsWV%22%7D\"></card><p>详细参数，参考 <a href=\"https://www.cloudera.com/documentation/enterprise/latest/topics/prepare_cm_database.html#scm_prepare_syntax\" target=\"_blank\">Syntax for scm_prepare_database.sh</a></p><p><br /></p><h4 id=\"ZjPAa\">安装CDH和其他软件</h4><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22sudo%20systemctl%20start%20cloudera-scm-server%5Cn%23%20%E5%90%AF%E5%8A%A8%E5%90%8E%EF%BC%8C%E7%9B%91%E5%90%ACserver%E6%97%A5%E5%BF%97%EF%BC%8C%E5%A4%A7%E7%BA%A61-3%E5%88%86%E9%92%9F%E5%B7%A6%E5%8F%B3%5Cnsudo%20tail%20-f%20%2Fvar%2Flog%2Fcloudera-scm-server%2Fcloudera-scm-server.log%5Cn%23%20%E7%9B%B4%E5%88%B0%E6%97%A5%E5%BF%97%E5%87%BA%E7%8E%B0%EF%BC%8C%E5%A6%82%E4%B8%8B%E5%86%85%E5%AE%B9%EF%BC%8C%E5%8D%B3%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F%E3%80%82%5Cn2019-05-08%2013%3A12%3A26%2C523%20INFO%20WebServerImpl%3Acom.cloudera.server.cmf.WebServerImpl%3A%20Started%20Jetty%20server.%22%2C%22id%22%3A%22tKPgy%22%7D\"></card><p><span style=\"background-color: transparent;\">参考资料</span><br /></p><ul><li><a href=\"https://www.cloudera.com/documentation/enterprise/6/release-notes/topics/rg_cdh_62_packaging.html\" target=\"_blank\">CDH 6.2.x Packaging</a></li></ul>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-05-09T03:54:19.000Z",
    "deleted_at": null,
    "created_at": "2019-04-25T11:01:13.000Z",
    "updated_at": "2019-08-15T11:06:27.000Z",
    "published_at": "2019-05-09T03:54:19.000Z",
    "first_published_at": "2019-05-09T03:54:19.000Z",
    "word_count": 1521,
    "cover": "",
    "description": "date: 2019-04-25 19:10:00tags: [大数据,hadoop,spark,cdh,hdp]categories: 大数据---这是坚持技术写作计划（含翻译）的第17篇，定个小目标999，每周最少2篇。本文主要介绍hadoop发行版CDH最新版(6.2)的安装。&lt;!...",
    "custom_description": "本文主要介绍hadoop发行版CDH最新版(6.2)的安装。",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1554946,
    "slug": "java-decompiler",
    "title": "016-JDK8+可用的反编译工具(JD_GUI+Procyon)",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-04-18 12:10:00<br />tags: [java,jdk8,反编译]<br />categories: java<br />---\n> 这是坚持技术写作计划（含翻译）的第16篇，定个小目标999，每周最少2篇。\n\n\n本文是源于一次逆向android app，辛苦脱壳后得到 `classes_dumped_29-dex2jar.jar` ，要得到源码，但是又不想降级jdk到1.7来迁就jd_gui。花了一分钟，找到jd_gui 在1.8下的用法,至于 基于procyon的UI luyten 纯是凑数。\n\n<!-- more -->\n\n<a name=\"JD_GUI\"></a>\n## JD_GUI\n打开 [http://java-decompiler.github.io/](http://java-decompiler.github.io/)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1555556972336-dbd69397-f0ee-454a-b39c-779eca71dd63.png#align=left&display=inline&height=678&name=image.png&originHeight=678&originWidth=1219&size=90920&status=done&width=1219)<br />其实官网已经很明显了，大家之所以以讹传讹，认为JD_GUI不支持1.8，大多是被度娘或者CSDN荼毒。<br />1.4.0 及以前的jd_gui，在1.8打开一般是<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1555557122787-0a3fac4f-3f1f-4da0-a48c-d7547ab217fa.png#align=left&display=inline&height=151&name=image.png&originHeight=151&originWidth=357&size=5587&status=done&width=357)\n\n下载并解压预览版，然后 `java -jar jd-gui-1.4.1.jar` <br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1555557322830-cb8915d1-e7bd-4e98-921c-ede3571d0a02.png#align=left&display=inline&height=505&name=image.png&originHeight=505&originWidth=1094&size=76642&status=done&width=1094)<br />熟悉的界面，熟悉的配方。\n\n<a name=\"ddbfde32\"></a>\n### 官方截图\n![LocalMethodClasses.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1555557366601-a7591bd1-09c5-4287-833c-fc0324d02ee4.png#align=left&display=inline&height=425&name=LocalMethodClasses.png&originHeight=665&originWidth=1168&size=88222&status=done&width=746)![TryWithResources.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1555557367229-70fe5c9d-b2be-421a-83df-0d90e890899c.png#align=left&display=inline&height=426&name=TryWithResources.png&originHeight=665&originWidth=1165&size=96487&status=done&width=746)![DefaultMethodsInInterface.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1555557367292-f0ef5b46-5a2f-4576-9182-203baae7a0ff.png#align=left&display=inline&height=426&name=DefaultMethodsInInterface.png&originHeight=665&originWidth=1165&size=88222&status=done&width=746)![Lambda.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1555557367324-1e872a6b-a4e2-4ce7-a852-305362ae113f.png#align=left&display=inline&height=426&name=Lambda.png&originHeight=665&originWidth=1165&size=82190&status=done&width=746)\n\n<a name=\"1df6ea45\"></a>\n## procyon + luyten\n\n下载最新版的 [luyten.jar](https://github.com/deathmarine/Luyten/releases) ,然后   `java -jar luyten-0.5.4.jar` <br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1555557560115-d10ea3a0-3d78-46e7-a6ab-13047ae1f347.png#align=left&display=inline&height=516&name=image.png&originHeight=516&originWidth=942&size=68141&status=done&width=942)<br />只是轻度使用的话，两个差不多，建议用jd_gui,起码搜索速度能甩luyten 10条街啊。\n<a name=\"433531fd\"></a>\n## 结语\n是不是以为会有类似lambda反编译比对一类的评测文？答案是，你想多了。这些工具只要有数就行，一个不好用，换另一个就行。\n\n其实，一般情况下，使用独立反编译工具的可能性很小,一般是IDE的插件居多，比如，[cnfree/Eclipse-Class-Decompiler](https://github.com/cnfree/Eclipse-Class-Decompiler) ,而idea默认有简易版的反编译插件。足以应付日常工作中零星的反编译用途。\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。<br />长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n",
    "body_draft": "",
    "body_html": "<p><span>date: 2019-04-18 12:10:00</span></p><p>tags: [java,jdk8,反编译]</p><p>categories: java</p><p>---</p><blockquote><p>这是坚持技术写作计划（含翻译）的第16篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文是源于一次逆向android app，辛苦脱壳后得到 <code>classes_dumped_29-dex2jar.jar</code> ，要得到源码，但是又不想降级jdk到1.7来迁就jd_gui。花了一分钟，找到jd_gui 在1.8下的用法,至于 基于procyon的UI luyten 纯是凑数。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"JD_GUI\">JD_GUI</h2><p>打开 <a href=\"http://java-decompiler.github.io/\" target=\"_blank\">http://java-decompiler.github.io/</a></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1555556972336-dbd69397-f0ee-454a-b39c-779eca71dd63.png#align=left&amp;display=inline&amp;height=678&amp;name=image.png&amp;originHeight=678&amp;originWidth=1219&amp;size=90920&amp;status=done&amp;width=1219\" style=\"max-width: 600px; width: 1219px;\" /></p><p>其实官网已经很明显了，大家之所以以讹传讹，认为JD_GUI不支持1.8，大多是被度娘或者CSDN荼毒。</p><p>1.4.0 及以前的jd_gui，在1.8打开一般是</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1555557122787-0a3fac4f-3f1f-4da0-a48c-d7547ab217fa.png#align=left&amp;display=inline&amp;height=151&amp;name=image.png&amp;originHeight=151&amp;originWidth=357&amp;size=5587&amp;status=done&amp;width=357\" style=\"max-width: 600px; width: 357px;\" /></p><p><br /></p><p>下载并解压预览版，然后 <code>java -jar jd-gui-1.4.1.jar</code> </p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1555557322830-cb8915d1-e7bd-4e98-921c-ede3571d0a02.png#align=left&amp;display=inline&amp;height=505&amp;name=image.png&amp;originHeight=505&amp;originWidth=1094&amp;size=76642&amp;status=done&amp;width=1094\" style=\"max-width: 600px; width: 1094px;\" /></p><p>熟悉的界面，熟悉的配方。</p><p><br /></p><h3 id=\"ddbfde32\">官方截图</h3><p><img alt=\"LocalMethodClasses.png\" title=\"LocalMethodClasses.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1555557366601-a7591bd1-09c5-4287-833c-fc0324d02ee4.png#align=left&amp;display=inline&amp;height=425&amp;name=LocalMethodClasses.png&amp;originHeight=665&amp;originWidth=1168&amp;size=88222&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /><img alt=\"TryWithResources.png\" title=\"TryWithResources.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1555557367229-70fe5c9d-b2be-421a-83df-0d90e890899c.png#align=left&amp;display=inline&amp;height=426&amp;name=TryWithResources.png&amp;originHeight=665&amp;originWidth=1165&amp;size=96487&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /><img alt=\"DefaultMethodsInInterface.png\" title=\"DefaultMethodsInInterface.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1555557367292-f0ef5b46-5a2f-4576-9182-203baae7a0ff.png#align=left&amp;display=inline&amp;height=426&amp;name=DefaultMethodsInInterface.png&amp;originHeight=665&amp;originWidth=1165&amp;size=88222&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /><img alt=\"Lambda.png\" title=\"Lambda.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1555557367324-1e872a6b-a4e2-4ce7-a852-305362ae113f.png#align=left&amp;display=inline&amp;height=426&amp;name=Lambda.png&amp;originHeight=665&amp;originWidth=1165&amp;size=82190&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p><br /></p><h2 id=\"1df6ea45\">procyon + <span>luyten</span></h2><p><span><br /></span></p><p><span>下载最新版的 </span><span><a href=\"https://github.com/deathmarine/Luyten/releases\" target=\"_blank\">luyten.jar</a> ,然后  </span> <code>java -jar luyten-0.5.4.jar</code> </p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1555557560115-d10ea3a0-3d78-46e7-a6ab-13047ae1f347.png#align=left&amp;display=inline&amp;height=516&amp;name=image.png&amp;originHeight=516&amp;originWidth=942&amp;size=68141&amp;status=done&amp;width=942\" style=\"max-width: 600px; width: 942px;\" /></p><p>只是轻度使用的话，两个差不多，建议用jd_gui,起码搜索速度能甩luyten 10条街啊。</p><h2 id=\"433531fd\">结语</h2><p><span>是不是以为会有类似lambda反编译比对一类的评测文？答案是，你想多了。这些工具只要有数就行，一个不好用，换另一个就行。</span></p><p><span><br /></span></p><p>其实，一般情况下，使用独立反编译工具的可能性很小,一般是IDE的插件居多，比如，<a href=\"https://github.com/cnfree/Eclipse-Class-Decompiler\" target=\"_blank\">cnfree/Eclipse-Class-Decompiler</a> ,而idea默认有简易版的反编译插件。足以应付日常工作中零星的反编译用途。</p><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "body_lake": "<!doctype lake><p><span>date: 2019-04-18 12:10:00</span></p><p>tags: [java,jdk8,反编译]</p><p>categories: java</p><p>---</p><blockquote><p>这是坚持技术写作计划（含翻译）的第16篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文是源于一次逆向android app，辛苦脱壳后得到 <code>classes_dumped_29-dex2jar.jar</code> ，要得到源码，但是又不想降级jdk到1.7来迁就jd_gui。花了一分钟，找到jd_gui 在1.8下的用法,至于 基于procyon的UI luyten 纯是凑数。</p><p><cursor /><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"JD_GUI\">JD_GUI</h2><p>打开 <a href=\"http://java-decompiler.github.io/\" target=\"_blank\">http://java-decompiler.github.io/</a></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1555556972336-dbd69397-f0ee-454a-b39c-779eca71dd63.png%22%2C%22originWidth%22%3A1219%2C%22originHeight%22%3A678%2C%22name%22%3A%22image.png%22%2C%22size%22%3A90920%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1219%2C%22height%22%3A678%7D\"></card></p><p>其实官网已经很明显了，大家之所以以讹传讹，认为JD_GUI不支持1.8，大多是被度娘或者CSDN荼毒。</p><p>1.4.0 及以前的jd_gui，在1.8打开一般是</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1555557122787-0a3fac4f-3f1f-4da0-a48c-d7547ab217fa.png%22%2C%22originWidth%22%3A357%2C%22originHeight%22%3A151%2C%22name%22%3A%22image.png%22%2C%22size%22%3A5587%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A357%2C%22height%22%3A151%7D\"></card></p><p><br /></p><p>下载并解压预览版，然后 <code>java -jar jd-gui-1.4.1.jar</code> </p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1555557322830-cb8915d1-e7bd-4e98-921c-ede3571d0a02.png%22%2C%22originWidth%22%3A1094%2C%22originHeight%22%3A505%2C%22name%22%3A%22image.png%22%2C%22size%22%3A76642%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1094%2C%22height%22%3A505%7D\"></card></p><p>熟悉的界面，熟悉的配方。</p><p><br /></p><h3 id=\"ddbfde32\">官方截图</h3><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1555557366601-a7591bd1-09c5-4287-833c-fc0324d02ee4.png%22%2C%22originWidth%22%3A1168%2C%22originHeight%22%3A665%2C%22name%22%3A%22LocalMethodClasses.png%22%2C%22size%22%3A88222%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A425%7D\"></card><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1555557367229-70fe5c9d-b2be-421a-83df-0d90e890899c.png%22%2C%22originWidth%22%3A1165%2C%22originHeight%22%3A665%2C%22name%22%3A%22TryWithResources.png%22%2C%22size%22%3A96487%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A426%7D\"></card><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1555557367292-f0ef5b46-5a2f-4576-9182-203baae7a0ff.png%22%2C%22originWidth%22%3A1165%2C%22originHeight%22%3A665%2C%22name%22%3A%22DefaultMethodsInInterface.png%22%2C%22size%22%3A88222%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A426%7D\"></card><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1555557367324-1e872a6b-a4e2-4ce7-a852-305362ae113f.png%22%2C%22originWidth%22%3A1165%2C%22originHeight%22%3A665%2C%22name%22%3A%22Lambda.png%22%2C%22size%22%3A82190%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A426%7D\"></card></p><p><br /></p><h2 id=\"1df6ea45\">procyon + <span>luyten</span></h2><p><span><br /></span></p><p><span>下载最新版的 </span><span><a href=\"https://github.com/deathmarine/Luyten/releases\" target=\"_blank\">luyten.jar</a> ,然后  </span> <code>java -jar luyten-0.5.4.jar</code> </p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1555557560115-d10ea3a0-3d78-46e7-a6ab-13047ae1f347.png%22%2C%22originWidth%22%3A942%2C%22originHeight%22%3A516%2C%22name%22%3A%22image.png%22%2C%22size%22%3A68141%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A942%2C%22height%22%3A516%7D\"></card></p><p>只是轻度使用的话，两个差不多，建议用jd_gui,起码搜索速度能甩luyten 10条街啊。</p><h2 id=\"433531fd\">结语</h2><p><span>是不是以为会有类似lambda反编译比对一类的评测文？答案是，你想多了。这些工具只要有数就行，一个不好用，换另一个就行。</span></p><p><span><br /></span></p><p>其实，一般情况下，使用独立反编译工具的可能性很小,一般是IDE的插件居多，比如，<a href=\"https://github.com/cnfree/Eclipse-Class-Decompiler\" target=\"_blank\">cnfree/Eclipse-Class-Decompiler</a> ,而idea默认有简易版的反编译插件。足以应付日常工作中零星的反编译用途。</p><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-04-18T03:29:02.000Z",
    "deleted_at": null,
    "created_at": "2019-04-18T02:50:06.000Z",
    "updated_at": "2019-08-01T01:42:47.000Z",
    "published_at": "2019-04-18T03:29:02.000Z",
    "first_published_at": "2019-04-18T03:29:02.000Z",
    "word_count": 438,
    "cover": "",
    "description": "date: 2019-04-18 12:10:00tags: [java,jdk8,反编译]categories: java---这是坚持技术写作计划（含翻译）的第16篇，定个小目标999，每周最少2篇。本文是源于一次逆向android app，辛苦脱壳后得到 classes_dumped_2...",
    "custom_description": "本文是源于一次逆向android app，辛苦脱壳后得到 classes_dumped_29-dex2jar.jar ，要得到源码，但是又不想降级jdk到1.7来迁就jd_gui。花了一分钟，找到jd_gui 在1.8下的用法,至于 基于procyon的UI luyten 纯是凑数。",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1528952,
    "slug": "ansible-beats",
    "title": "015-Ansible批量安装Elastic Beats(支持Linux和Windows)",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-04-13 20:41:00<br />tags: [ansible,linux,运维,beats,es,elasticsearch]<br />categories: 运维,elasticsearch<br />---\n> 这是坚持技术写作计划（含翻译）的第15篇，定个小目标999，每周最少2篇。\n\n\n使用[elastic beats](https://www.elastic.co/cn/downloads/beats)进行拨测，metric采集，主机监控，但是批量化安装仍是个问题，好在elastic官方有开源的 [ansible-beats](https://github.com/elastic/ansible-beats) 但是只支持Linux，而我们在某些业务场景下，还有WinServer的存在。故而在官方基础上fork并增加了windows的支持（[已提交PR](https://github.com/elastic/ansible-beats/pull/17)，但是官方不一定给合并 [捂脸] ）。关于Ansible管理windows可以参考我之前写的一篇文章 [Ansible2.7批量管理Windows](https://juejin.im/post/5c644d7ef265da2dea050f66)。\n\n<!-- more -->\n\n<a name=\"12267079\"></a>\n## 实验环境\n| 类型 | 系统 | ip |\n| --- | --- | --- |\n| Server(主控) | Ubuntu Server 16.04.5 LTS X64 | 192.168.0.22 |\n| Client(受控) | Windows Server 2008 R2 SP1 | 192.168.0.23 |\n| Clinet(受控) | Ubuntu Server 16.04.5 LTS X64 | 192.168.0.24 |\n| Clinet(受控) | CentOS  7.6.1810 (Core) | 192.168.0.25 |\n\n> 注意: 主控端需要安装Ansible 2.7.12 可参考 \n\n\n<a name=\"52b36576\"></a>\n## 步骤\n此处已假设主控端已安装Ansible 2.7+，被控端的Windows的WinRM已配置完成\n\n<a name=\"5be9697d\"></a>\n### 安装[anjia0532.ansible_beats](https://galaxy.ansible.com/anjia0532/ansible_beats)\n在主控端(192.168.0.22)执行以下命令\n```bash\nroot@ubuntu:/root/# ansible-galaxy install anjia0532.ansible_beats\n- downloading role 'ansible_beats', owned by anjia0532\n- downloading role from https://github.com/anjia0532/ansible-beats/archive/master.tar.gz\n- extracting anjia0532.ansible_beats to /root/.ansible/roles/anjia0532.ansible_beats\n- anjia0532.ansible_beats (master) was installed successfully\n```\n\n<a name=\"e7a37043\"></a>\n### 创建inventorys\n创建 `inventorys/hosts.yml` \n```yaml\nbeats:\n  hosts: \n    192.168.0.23:\n        ansible_user: Administrator\n        ansible_password: password\n        ansible_connection: winrm\n        ansible_winrm_transport: basic\n        ansible_port: 5985\n    192.168.0.24:\n        ansible_user: root\n        ansible_ssh_private_key_file: /root/.ssh/id_rsa\n    192.168.0.25:\n        ansible_user: root\n        ansible_ssh_private_key_file: /root/.ssh/id_rsa\n```\n\n<a name=\"b990749b\"></a>\n### 创建 task\n创建 beats.yml\n\n```yaml\n- name: Example playbook for installing packetbeat\n  hosts: beats\n  roles:\n    - { role: anjia0532.ansible_beats,\n        beat: \"packetbeat\",\n        beat_conf: {\n          \"interfaces\": {\"device\":\"any\"},\n          \"protocols\": {\n            \"dns\": {\n              \"ports\": [53],\n              \"include_authorities\":true\n            },\n            \"http\": {\n              \"ports\": [80, 8080, 8000, 5000, 8002]\n            },\n            \"memcache\": {\n              \"ports\": [11211]\n            },\n            \"mysql\": {\n              \"ports\": [3306]\n            },\n            \"pgsql\": {\n              \"ports\": [5432]\n            },\n            \"redis\": {\n              \"ports\": [6379]\n            },\n            \"thrift\": {\n              \"ports\": [9090]\n            },\n            \"mongodb\": {\n              \"ports\": [27017]\n            }\n          }\n        },\n        output_conf : {\n          \"elasticsearch\": {\n            \"hosts\": [\"localhost:9200\"]\n          }\n        }\n    }\n  vars:\n    use_repository: true\n```\n\n<a name=\"b47ee1bf\"></a>\n### 安装beats\n\n```bash\n# ansible-playbook -i inventorys/hosts.yml ./beats.yml\n\n// 忽略输出\nPLAY RECAP *******************************************************************************************************************************************************************************************************************************************************************\n192.168.0.23               : ok=17   changed=17    unreachable=0    failed=0\n192.168.0.24               : ok=19   changed=19    unreachable=0    failed=0\n192.168.0.25               : ok=19   changed=19    unreachable=0    failed=0\n```\n表明都成功了\n\n<a name=\"7a433c76\"></a>\n### 查看配置文件和日志\n\n```bash\nssh root@192.168.0.24\ncat /etc/packetbeat/packetbeat.yml\n```\n\n```yaml\n################### packetbeat Configuration #########################\n\n############################# packetbeat ######################################\ninterfaces:\n    device: any\nprotocols:\n    dns:\n        include_authorities: true\n        ports:\n        - 53\n    http:\n        ports:\n        - 80\n        - 8080\n        - 8000\n        - 5000\n        - 8002\n    memcache:\n        ports:\n        - 11211\n    mongodb:\n        ports:\n        - 27017\n    mysql:\n        ports:\n        - 3306\n    pgsql:\n        ports:\n        - 5432\n    redis:\n        ports:\n        - 6379\n    thrift:\n        ports:\n        - 9090\n\n\n###############################################################################\n############################# Libbeat Config ##################################\n# Base config file used by all other beats for using libbeat features\n\n############################# Output ##########################################\n\noutput:\n    elasticsearch:\n        hosts:\n        - localhost:9200\n\n\n############################# Logging #########################################\n\nlogging:\n    files:\n        rotateeverybytes: 10485760\n```\n\n```bash\n# less /var/log/packetbeat/packetbeat\n\n2019-04-13T09:38:44.865+0800    INFO    instance/beat.go:611    Home path: [/usr/share/packetbeat] Config path: [/etc/packetbeat] Data path: [/var/lib/packetbeat] Logs path: [/var/log/packetbeat]\n2019-04-13T09:38:44.868+0800    INFO    instance/beat.go:618    Beat UUID: 8fbd86a8-0bbc-4349-8aca-d4dc8c897ba2\n2019-04-13T09:38:44.868+0800    INFO    [seccomp]       seccomp/seccomp.go:116  Syscall filter successfully installed\n2019-04-13T09:38:44.868+0800    INFO    [beat]  instance/beat.go:931    Beat info       {\"system_info\": {\"beat\": {\"path\": {\"config\": \"/etc/packetbeat\", \"data\": \"/var/lib/packetbeat\", \"home\": \"/usr/share/packetbeat\", \"logs\": \"/var/log/packetbeat\"}, \"type\": \"packetbeat\", \"uuid\": \"8fbd86a8-0bbc-4349-8aca-d4dc8c897ba2\"}}}\n2019-04-13T09:38:44.868+0800    INFO    [beat]  instance/beat.go:940    Build info      {\"system_info\": {\"build\": {\"commit\": \"1d55b4bd9dbf106a4ad4bc34fe9ee425d922363b\", \"libbeat\": \"6.7.1\", \"time\": \"2019-04-02T15:15:12.000Z\", \"version\": \"6.7.1\"}}}\n2019-04-13T09:38:44.868+0800    INFO    [beat]  instance/beat.go:943    Go runtime info {\"system_info\": {\"go\": {\"os\":\"linux\",\"arch\":\"amd64\",\"max_procs\":4,\"version\":\"go1.10.8\"}}}\n2019-04-13T09:38:44.872+0800    INFO    [beat]  instance/beat.go:947    Host info       {\"system_info\": {\"host\": {\"architecture\":\"x86_64\",\"boot_time\":\"2019-04-12T20:58:45+08:00\",\"containerized\":true,\"name\":\"localhost.localdomain\",\"ip\":[\"127.0.0.1/8\",\"::1/128\",\"172.60.20.116/24\",\"fe80::536d:17d0:e9f6:57c/64\"],\"kernel_version\":\"3.10.0-957.el7.x86_64\",\"mac\":[\"00:50:56:9f:8b:b7\"],\"os\":{\"family\":\"redhat\",\"platform\":\"centos\",\"name\":\"CentOS Linux\",\"version\":\"7 (Core)\",\"major\":7,\"minor\":6,\"patch\":1810,\"codename\":\"Core\"},\"timezone\":\"CST\",\"timezone_offset_sec\":28800,\"id\":\"cd7bb2d0c80a41c89bb5b596c22fc85e\"}}}\n2019-04-13T09:38:44.873+0800    INFO    [beat]  instance/beat.go:976    Process info    {\"system_info\": {\"process\": {\"capabilities\": {\"inheritable\":null,\"permitted\":[\"chown\",\"dac_override\",\"dac_read_search\",\"fowner\",\"fsetid\",\"kill\",\"setgid\",\"setuid\",\"setpcap\",\"linux_immutable\",\"net_bind_service\",\"net_broadcast\",\"net_admin\",\"net_raw\",\"ipc_lock\",\"ipc_owner\",\"sys_module\",\"sys_rawio\",\"sys_chroot\",\"sys_ptrace\",\"sys_pacct\",\"sys_admin\",\"sys_boot\",\"sys_nice\",\"sys_resource\",\"sys_time\",\"sys_tty_config\",\"mknod\",\"lease\",\"audit_write\",\"audit_control\",\"setfcap\",\"mac_override\",\"mac_admin\",\"syslog\",\"wake_alarm\",\"block_suspend\"],\"effective\":[\"chown\",\"dac_override\",\"dac_read_search\",\"fowner\",\"fsetid\",\"kill\",\"setgid\",\"setuid\",\"setpcap\",\"linux_immutable\",\"net_bind_service\",\"net_broadcast\",\"net_admin\",\"net_raw\",\"ipc_lock\",\"ipc_owner\",\"sys_module\",\"sys_rawio\",\"sys_chroot\",\"sys_ptrace\",\"sys_pacct\",\"sys_admin\",\"sys_boot\",\"sys_nice\",\"sys_resource\",\"sys_time\",\"sys_tty_config\",\"mknod\",\"lease\",\"audit_write\",\"audit_control\",\"setfcap\",\"mac_override\",\"mac_admin\",\"syslog\",\"wake_alarm\",\"block_suspend\"],\"bounding\":[\"chown\",\"dac_override\",\"dac_read_search\",\"fowner\",\"fsetid\",\"kill\",\"setgid\",\"setuid\",\"setpcap\",\"linux_immutable\",\"net_bind_service\",\"net_broadcast\",\"net_admin\",\"net_raw\",\"ipc_lock\",\"ipc_owner\",\"sys_module\",\"sys_rawio\",\"sys_chroot\",\"sys_ptrace\",\"sys_pacct\",\"sys_admin\",\"sys_boot\",\"sys_nice\",\"sys_resource\",\"sys_time\",\"sys_tty_config\",\"mknod\",\"lease\",\"audit_write\",\"audit_control\",\"setfcap\",\"mac_override\",\"mac_admin\",\"syslog\",\"wake_alarm\",\"block_suspend\"],\"ambient\":null}, \"cwd\": \"/\", \"exe\": \"/usr/share/packetbeat/bin/packetbeat\", \"name\": \"packetbeat\", \"pid\": 9683, \"ppid\": 1, \"seccomp\": {\"mode\":\"filter\"}, \"start_time\": \"2019-04-13T09:38:44.350+0800\"}}}\n2019-04-13T09:38:44.874+0800    INFO    instance/beat.go:280    Setup Beat: packetbeat; Version: 6.7.1\n2019-04-13T09:38:44.874+0800    INFO    elasticsearch/client.go:164     Elasticsearch url: http://localhost:9200\n2019-04-13T09:38:44.875+0800    INFO    [publisher]     pipeline/module.go:110  Beat name: localhost.localdomain\n2019-04-13T09:38:44.875+0800    INFO    procs/procs.go:101      Process watcher disabled\n2019-04-13T09:38:44.877+0800    INFO    instance/beat.go:402    packetbeat start running.\n2019-04-13T09:38:44.877+0800    INFO    [monitoring]    log/log.go:117  Starting metrics logging every 30s\n2019-04-13T09:39:14.887+0800    INFO    [monitoring]    log/log.go:144  Non-zero metrics in the last 30s        {\"monitoring\": {\"metrics\": {\"beat\":{\"cpu\":{\"system\":{\"ticks\":160,\"time\":{\"ms\":162}},\"total\":{\"ticks\":610,\"time\":{\"ms\":614},\"value\":0},\"user\":{\"ticks\":450,\"time\":{\"ms\":452}}},\"handles\":{\"limit\":{\"hard\":4096,\"soft\":1024},\"open\":7},\"info\":{\"ephemeral_id\":\"691a2203-1433-44d4-b173-938a52dbea22\",\"uptime\":{\"ms\":30042}},\"memstats\":{\"gc_next\":36201104,\"memory_alloc\":18724416,\"memory_total\":23093208,\"rss\":45715456}},\"libbeat\":{\"config\":{\"module\":{\"running\":0}},\"output\":{\"type\":\"elasticsearch\"},\"pipeline\":{\"clients\":0,\"events\":{\"active\":0}}},\"system\":{\"cpu\":{\"cores\":4},\"load\":{\"1\":0.1,\"15\":0.06,\"5\":0.05,\"norm\":{\"1\":0.025,\"15\":0.015,\"5\":0.0125}}}}}}\n```\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [Latest Releases via Apt (Ubuntu)](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#latest-releases-via-apt-ubuntu)\n- [Windows Guides](https://docs.ansible.com/ansible/latest/user_guide/windows.html)\n- [Document npcap requires WinPcap Compatible Mode](https://github.com/elastic/beats/issues/4364)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。<br />长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n",
    "body_draft": "",
    "body_html": "<p><span>date: 2019-04-13 20:41:00</span></p><p>tags: [ansible,linux,运维,beats,es,elasticsearch]</p><p>categories: 运维,elasticsearch</p><p>---</p><blockquote><p>这是坚持技术写作计划（含翻译）的第15篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>使用<a href=\"https://www.elastic.co/cn/downloads/beats\" target=\"_blank\">elastic beats</a>进行拨测，metric采集，主机监控，但是批量化安装仍是个问题，好在elastic官方有开源的 <a href=\"https://github.com/elastic/ansible-beats\" target=\"_blank\">ansible-beats</a> 但是只支持Linux，而我们在某些业务场景下，还有WinServer的存在。故而在官方基础上fork并增加了windows的支持（<a href=\"https://github.com/elastic/ansible-beats/pull/17\" target=\"_blank\">已提交PR</a>，但是官方不一定给合并 [捂脸] ）。关于Ansible管理windows可以参考我之前写的一篇文章 <a href=\"https://juejin.im/post/5c644d7ef265da2dea050f66\" target=\"_blank\">Ansible2.7批量管理Windows</a>。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"12267079\">实验环境</h2><table class=\"lake-table\" style=\"width: 721px;\"><colgroup><col width=\"240\"></col><col width=\"240\"></col><col width=\"240\"></col></colgroup><tbody><tr><td>类型</td><td>系统</td><td>ip</td></tr></tbody><tbody><tr><td>Server(主控)</td><td>Ubuntu Server 16.04.5 LTS X64</td><td>192.168.0.22</td></tr><tr><td><p>Client(受控)</p></td><td>Windows Server 2008 R2 SP1</td><td>192.168.0.23</td></tr><tr><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p>Clinet(受控)</p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p><span>Ubuntu Server 16.04.5 LTS X64</span></p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p><span>192.168.0.24</span></p></td></tr><tr><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p>Clinet(受控)</p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p>CentOS  7.6.1810 (Core)</p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p><span>192.168.0.25</span></p></td></tr></tbody></table><blockquote><p>注意: 主控端需要安装Ansible 2.7.12 可参考 </p></blockquote><p><br /></p><h2 id=\"52b36576\">步骤</h2><p>此处已假设主控端已安装Ansible 2.7+，被控端的Windows的WinRM已配置完成</p><p><br /></p><h3 id=\"5be9697d\">安装<a href=\"https://galaxy.ansible.com/anjia0532/ansible_beats\" target=\"_blank\">anjia0532.ansible_beats</a></h3><p>在主控端(<span>192.168.0.22</span>)执行以下命令</p><pre data-lang=\"bash\"><code>root@ubuntu:/root/# ansible-galaxy install anjia0532.ansible_beats\n- downloading role 'ansible_beats', owned by anjia0532\n- downloading role from https://github.com/anjia0532/ansible-beats/archive/master.tar.gz\n- extracting anjia0532.ansible_beats to /root/.ansible/roles/anjia0532.ansible_beats\n- anjia0532.ansible_beats (master) was installed successfully</code></pre><p><br /></p><h3 id=\"e7a37043\">创建inventorys</h3><p>创建 <code>inventorys/hosts.yml</code> </p><pre data-lang=\"yaml\"><code>beats:\n  hosts: \n    192.168.0.23:\n        ansible_user: Administrator\n        ansible_password: password\n        ansible_connection: winrm\n        ansible_winrm_transport: basic\n        ansible_port: 5985\n    192.168.0.24:\n        ansible_user: root\n        ansible_ssh_private_key_file: /root/.ssh/id_rsa\n    192.168.0.25:\n        ansible_user: root\n        ansible_ssh_private_key_file: /root/.ssh/id_rsa</code></pre><p><br /></p><h3 id=\"b990749b\">创建 task</h3><p>创建 beats.yml</p><p><br /></p><pre data-lang=\"yaml\"><code>- name: Example playbook for installing packetbeat\n  hosts: beats\n  roles:\n    - { role: anjia0532.ansible_beats,\n        beat: &quot;packetbeat&quot;,\n        beat_conf: {\n          &quot;interfaces&quot;: {&quot;device&quot;:&quot;any&quot;},\n          &quot;protocols&quot;: {\n            &quot;dns&quot;: {\n              &quot;ports&quot;: [53],\n              &quot;include_authorities&quot;:true\n            },\n            &quot;http&quot;: {\n              &quot;ports&quot;: [80, 8080, 8000, 5000, 8002]\n            },\n            &quot;memcache&quot;: {\n              &quot;ports&quot;: [11211]\n            },\n            &quot;mysql&quot;: {\n              &quot;ports&quot;: [3306]\n            },\n            &quot;pgsql&quot;: {\n              &quot;ports&quot;: [5432]\n            },\n            &quot;redis&quot;: {\n              &quot;ports&quot;: [6379]\n            },\n            &quot;thrift&quot;: {\n              &quot;ports&quot;: [9090]\n            },\n            &quot;mongodb&quot;: {\n              &quot;ports&quot;: [27017]\n            }\n          }\n        },\n        output_conf : {\n          &quot;elasticsearch&quot;: {\n            &quot;hosts&quot;: [&quot;localhost:9200&quot;]\n          }\n        }\n    }\n  vars:\n    use_repository: true</code></pre><p><br /></p><h3 id=\"b47ee1bf\">安装beats</h3><p><br /></p><pre data-lang=\"bash\"><code># ansible-playbook -i inventorys/hosts.yml ./beats.yml\n\n// 忽略输出\nPLAY RECAP *******************************************************************************************************************************************************************************************************************************************************************\n192.168.0.23               : ok=17   changed=17    unreachable=0    failed=0\n192.168.0.24               : ok=19   changed=19    unreachable=0    failed=0\n192.168.0.25               : ok=19   changed=19    unreachable=0    failed=0</code></pre><p>表明都成功了</p><p><br /></p><h3 id=\"7a433c76\">查看配置文件和日志</h3><p><br /></p><pre data-lang=\"bash\"><code>ssh root@192.168.0.24\ncat /etc/packetbeat/packetbeat.yml</code></pre><p><br /></p><pre data-lang=\"yaml\"><code>################### packetbeat Configuration #########################\n\n############################# packetbeat ######################################\ninterfaces:\n    device: any\nprotocols:\n    dns:\n        include_authorities: true\n        ports:\n        - 53\n    http:\n        ports:\n        - 80\n        - 8080\n        - 8000\n        - 5000\n        - 8002\n    memcache:\n        ports:\n        - 11211\n    mongodb:\n        ports:\n        - 27017\n    mysql:\n        ports:\n        - 3306\n    pgsql:\n        ports:\n        - 5432\n    redis:\n        ports:\n        - 6379\n    thrift:\n        ports:\n        - 9090\n\n\n###############################################################################\n############################# Libbeat Config ##################################\n# Base config file used by all other beats for using libbeat features\n\n############################# Output ##########################################\n\noutput:\n    elasticsearch:\n        hosts:\n        - localhost:9200\n\n\n############################# Logging #########################################\n\nlogging:\n    files:\n        rotateeverybytes: 10485760</code></pre><p><br /></p><pre data-lang=\"bash\"><code># less /var/log/packetbeat/packetbeat\n\n2019-04-13T09:38:44.865+0800    INFO    instance/beat.go:611    Home path: [/usr/share/packetbeat] Config path: [/etc/packetbeat] Data path: [/var/lib/packetbeat] Logs path: [/var/log/packetbeat]\n2019-04-13T09:38:44.868+0800    INFO    instance/beat.go:618    Beat UUID: 8fbd86a8-0bbc-4349-8aca-d4dc8c897ba2\n2019-04-13T09:38:44.868+0800    INFO    [seccomp]       seccomp/seccomp.go:116  Syscall filter successfully installed\n2019-04-13T09:38:44.868+0800    INFO    [beat]  instance/beat.go:931    Beat info       {&quot;system_info&quot;: {&quot;beat&quot;: {&quot;path&quot;: {&quot;config&quot;: &quot;/etc/packetbeat&quot;, &quot;data&quot;: &quot;/var/lib/packetbeat&quot;, &quot;home&quot;: &quot;/usr/share/packetbeat&quot;, &quot;logs&quot;: &quot;/var/log/packetbeat&quot;}, &quot;type&quot;: &quot;packetbeat&quot;, &quot;uuid&quot;: &quot;8fbd86a8-0bbc-4349-8aca-d4dc8c897ba2&quot;}}}\n2019-04-13T09:38:44.868+0800    INFO    [beat]  instance/beat.go:940    Build info      {&quot;system_info&quot;: {&quot;build&quot;: {&quot;commit&quot;: &quot;1d55b4bd9dbf106a4ad4bc34fe9ee425d922363b&quot;, &quot;libbeat&quot;: &quot;6.7.1&quot;, &quot;time&quot;: &quot;2019-04-02T15:15:12.000Z&quot;, &quot;version&quot;: &quot;6.7.1&quot;}}}\n2019-04-13T09:38:44.868+0800    INFO    [beat]  instance/beat.go:943    Go runtime info {&quot;system_info&quot;: {&quot;go&quot;: {&quot;os&quot;:&quot;linux&quot;,&quot;arch&quot;:&quot;amd64&quot;,&quot;max_procs&quot;:4,&quot;version&quot;:&quot;go1.10.8&quot;}}}\n2019-04-13T09:38:44.872+0800    INFO    [beat]  instance/beat.go:947    Host info       {&quot;system_info&quot;: {&quot;host&quot;: {&quot;architecture&quot;:&quot;x86_64&quot;,&quot;boot_time&quot;:&quot;2019-04-12T20:58:45+08:00&quot;,&quot;containerized&quot;:true,&quot;name&quot;:&quot;localhost.localdomain&quot;,&quot;ip&quot;:[&quot;127.0.0.1/8&quot;,&quot;::1/128&quot;,&quot;172.60.20.116/24&quot;,&quot;fe80::536d:17d0:e9f6:57c/64&quot;],&quot;kernel_version&quot;:&quot;3.10.0-957.el7.x86_64&quot;,&quot;mac&quot;:[&quot;00:50:56:9f:8b:b7&quot;],&quot;os&quot;:{&quot;family&quot;:&quot;redhat&quot;,&quot;platform&quot;:&quot;centos&quot;,&quot;name&quot;:&quot;CentOS Linux&quot;,&quot;version&quot;:&quot;7 (Core)&quot;,&quot;major&quot;:7,&quot;minor&quot;:6,&quot;patch&quot;:1810,&quot;codename&quot;:&quot;Core&quot;},&quot;timezone&quot;:&quot;CST&quot;,&quot;timezone_offset_sec&quot;:28800,&quot;id&quot;:&quot;cd7bb2d0c80a41c89bb5b596c22fc85e&quot;}}}\n2019-04-13T09:38:44.873+0800    INFO    [beat]  instance/beat.go:976    Process info    {&quot;system_info&quot;: {&quot;process&quot;: {&quot;capabilities&quot;: {&quot;inheritable&quot;:null,&quot;permitted&quot;:[&quot;chown&quot;,&quot;dac_override&quot;,&quot;dac_read_search&quot;,&quot;fowner&quot;,&quot;fsetid&quot;,&quot;kill&quot;,&quot;setgid&quot;,&quot;setuid&quot;,&quot;setpcap&quot;,&quot;linux_immutable&quot;,&quot;net_bind_service&quot;,&quot;net_broadcast&quot;,&quot;net_admin&quot;,&quot;net_raw&quot;,&quot;ipc_lock&quot;,&quot;ipc_owner&quot;,&quot;sys_module&quot;,&quot;sys_rawio&quot;,&quot;sys_chroot&quot;,&quot;sys_ptrace&quot;,&quot;sys_pacct&quot;,&quot;sys_admin&quot;,&quot;sys_boot&quot;,&quot;sys_nice&quot;,&quot;sys_resource&quot;,&quot;sys_time&quot;,&quot;sys_tty_config&quot;,&quot;mknod&quot;,&quot;lease&quot;,&quot;audit_write&quot;,&quot;audit_control&quot;,&quot;setfcap&quot;,&quot;mac_override&quot;,&quot;mac_admin&quot;,&quot;syslog&quot;,&quot;wake_alarm&quot;,&quot;block_suspend&quot;],&quot;effective&quot;:[&quot;chown&quot;,&quot;dac_override&quot;,&quot;dac_read_search&quot;,&quot;fowner&quot;,&quot;fsetid&quot;,&quot;kill&quot;,&quot;setgid&quot;,&quot;setuid&quot;,&quot;setpcap&quot;,&quot;linux_immutable&quot;,&quot;net_bind_service&quot;,&quot;net_broadcast&quot;,&quot;net_admin&quot;,&quot;net_raw&quot;,&quot;ipc_lock&quot;,&quot;ipc_owner&quot;,&quot;sys_module&quot;,&quot;sys_rawio&quot;,&quot;sys_chroot&quot;,&quot;sys_ptrace&quot;,&quot;sys_pacct&quot;,&quot;sys_admin&quot;,&quot;sys_boot&quot;,&quot;sys_nice&quot;,&quot;sys_resource&quot;,&quot;sys_time&quot;,&quot;sys_tty_config&quot;,&quot;mknod&quot;,&quot;lease&quot;,&quot;audit_write&quot;,&quot;audit_control&quot;,&quot;setfcap&quot;,&quot;mac_override&quot;,&quot;mac_admin&quot;,&quot;syslog&quot;,&quot;wake_alarm&quot;,&quot;block_suspend&quot;],&quot;bounding&quot;:[&quot;chown&quot;,&quot;dac_override&quot;,&quot;dac_read_search&quot;,&quot;fowner&quot;,&quot;fsetid&quot;,&quot;kill&quot;,&quot;setgid&quot;,&quot;setuid&quot;,&quot;setpcap&quot;,&quot;linux_immutable&quot;,&quot;net_bind_service&quot;,&quot;net_broadcast&quot;,&quot;net_admin&quot;,&quot;net_raw&quot;,&quot;ipc_lock&quot;,&quot;ipc_owner&quot;,&quot;sys_module&quot;,&quot;sys_rawio&quot;,&quot;sys_chroot&quot;,&quot;sys_ptrace&quot;,&quot;sys_pacct&quot;,&quot;sys_admin&quot;,&quot;sys_boot&quot;,&quot;sys_nice&quot;,&quot;sys_resource&quot;,&quot;sys_time&quot;,&quot;sys_tty_config&quot;,&quot;mknod&quot;,&quot;lease&quot;,&quot;audit_write&quot;,&quot;audit_control&quot;,&quot;setfcap&quot;,&quot;mac_override&quot;,&quot;mac_admin&quot;,&quot;syslog&quot;,&quot;wake_alarm&quot;,&quot;block_suspend&quot;],&quot;ambient&quot;:null}, &quot;cwd&quot;: &quot;/&quot;, &quot;exe&quot;: &quot;/usr/share/packetbeat/bin/packetbeat&quot;, &quot;name&quot;: &quot;packetbeat&quot;, &quot;pid&quot;: 9683, &quot;ppid&quot;: 1, &quot;seccomp&quot;: {&quot;mode&quot;:&quot;filter&quot;}, &quot;start_time&quot;: &quot;2019-04-13T09:38:44.350+0800&quot;}}}\n2019-04-13T09:38:44.874+0800    INFO    instance/beat.go:280    Setup Beat: packetbeat; Version: 6.7.1\n2019-04-13T09:38:44.874+0800    INFO    elasticsearch/client.go:164     Elasticsearch url: http://localhost:9200\n2019-04-13T09:38:44.875+0800    INFO    [publisher]     pipeline/module.go:110  Beat name: localhost.localdomain\n2019-04-13T09:38:44.875+0800    INFO    procs/procs.go:101      Process watcher disabled\n2019-04-13T09:38:44.877+0800    INFO    instance/beat.go:402    packetbeat start running.\n2019-04-13T09:38:44.877+0800    INFO    [monitoring]    log/log.go:117  Starting metrics logging every 30s\n2019-04-13T09:39:14.887+0800    INFO    [monitoring]    log/log.go:144  Non-zero metrics in the last 30s        {&quot;monitoring&quot;: {&quot;metrics&quot;: {&quot;beat&quot;:{&quot;cpu&quot;:{&quot;system&quot;:{&quot;ticks&quot;:160,&quot;time&quot;:{&quot;ms&quot;:162}},&quot;total&quot;:{&quot;ticks&quot;:610,&quot;time&quot;:{&quot;ms&quot;:614},&quot;value&quot;:0},&quot;user&quot;:{&quot;ticks&quot;:450,&quot;time&quot;:{&quot;ms&quot;:452}}},&quot;handles&quot;:{&quot;limit&quot;:{&quot;hard&quot;:4096,&quot;soft&quot;:1024},&quot;open&quot;:7},&quot;info&quot;:{&quot;ephemeral_id&quot;:&quot;691a2203-1433-44d4-b173-938a52dbea22&quot;,&quot;uptime&quot;:{&quot;ms&quot;:30042}},&quot;memstats&quot;:{&quot;gc_next&quot;:36201104,&quot;memory_alloc&quot;:18724416,&quot;memory_total&quot;:23093208,&quot;rss&quot;:45715456}},&quot;libbeat&quot;:{&quot;config&quot;:{&quot;module&quot;:{&quot;running&quot;:0}},&quot;output&quot;:{&quot;type&quot;:&quot;elasticsearch&quot;},&quot;pipeline&quot;:{&quot;clients&quot;:0,&quot;events&quot;:{&quot;active&quot;:0}}},&quot;system&quot;:{&quot;cpu&quot;:{&quot;cores&quot;:4},&quot;load&quot;:{&quot;1&quot;:0.1,&quot;15&quot;:0.06,&quot;5&quot;:0.05,&quot;norm&quot;:{&quot;1&quot;:0.025,&quot;15&quot;:0.015,&quot;5&quot;:0.0125}}}}}}</code></pre><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#latest-releases-via-apt-ubuntu\" target=\"_blank\">Latest Releases via Apt (Ubuntu)</a></li><li><a href=\"https://docs.ansible.com/ansible/latest/user_guide/windows.html\" target=\"_blank\">Windows Guides</a></li><li><a href=\"https://github.com/elastic/beats/issues/4364\" target=\"_blank\">Document npcap requires WinPcap Compatible Mode</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "body_lake": "<!doctype lake><p><span>date: 2019-04-13 20:41:00</span></p><p>tags: [ansible,linux,运维,beats,es,elasticsearch]</p><p>categories: 运维,elasticsearch</p><p>---<cursor /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第15篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>使用<a href=\"https://www.elastic.co/cn/downloads/beats\" target=\"_blank\">elastic beats</a>进行拨测，metric采集，主机监控，但是批量化安装仍是个问题，好在elastic官方有开源的 <a href=\"https://github.com/elastic/ansible-beats\" target=\"_blank\">ansible-beats</a> 但是只支持Linux，而我们在某些业务场景下，还有WinServer的存在。故而在官方基础上fork并增加了windows的支持（<a href=\"https://github.com/elastic/ansible-beats/pull/17\" target=\"_blank\">已提交PR</a>，但是官方不一定给合并 [捂脸] ）。关于Ansible管理windows可以参考我之前写的一篇文章 <a href=\"https://juejin.im/post/5c644d7ef265da2dea050f66\" target=\"_blank\">Ansible2.7批量管理Windows</a>。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"12267079\">实验环境</h2><card type=\"block\" name=\"table\" value=\"data:%7B%22rows%22%3A5%2C%22cols%22%3A3%2C%22html%22%3A%22%3Ctable%20class%3D%5C%22lake-table%5C%22%20style%3D%5C%22width%3A%20721px%3B%5C%22%3E%3Ccolgroup%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22240%5C%22%20%2F%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22240%5C%22%20%2F%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22240%5C%22%20%2F%3E%3C%2Fcolgroup%3E%3Ctbody%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3E%E7%B1%BB%E5%9E%8B%3C%2Ftd%3E%3Ctd%3E%E7%B3%BB%E7%BB%9F%3C%2Ftd%3E%3Ctd%3Eip%3C%2Ftd%3E%3C%2Ftr%3E%3C%2Ftbody%3E%3Ctbody%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3EServer(%E4%B8%BB%E6%8E%A7)%3C%2Ftd%3E%3Ctd%3EUbuntu%20Server%2016.04.5%20LTS%20X64%3C%2Ftd%3E%3Ctd%3E192.168.0.22%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3E%3Cp%3EClient(%E5%8F%97%E6%8E%A7)%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3EWindows%20Server%202008%20R2%20SP1%3C%2Ftd%3E%3Ctd%3E192.168.0.23%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3EClinet(%E5%8F%97%E6%8E%A7)%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E%3Cspan%3EUbuntu%20Server%2016.04.5%20LTS%20X64%3C%2Fspan%3E%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E%3Cspan%3E192.168.0.24%3C%2Fspan%3E%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3EClinet(%E5%8F%97%E6%8E%A7)%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3ECentOS%20%207.6.1810%20(Core)%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E%3Cspan%3E192.168.0.25%3C%2Fspan%3E%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3C%2Ftbody%3E%3C%2Ftable%3E%22%2C%22id%22%3A%22f74dd100%22%7D\"></card><blockquote><p>注意: 主控端需要安装Ansible 2.7.12 可参考 </p></blockquote><p><br /></p><h2 id=\"52b36576\">步骤</h2><p>此处已假设主控端已安装Ansible 2.7+，被控端的Windows的WinRM已配置完成</p><p><br /></p><h3 id=\"5be9697d\">安装<a href=\"https://galaxy.ansible.com/anjia0532/ansible_beats\" target=\"_blank\">anjia0532.ansible_beats</a></h3><p>在主控端(<span>192.168.0.22</span>)执行以下命令</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22root%40ubuntu%3A%2Froot%2F%23%20ansible-galaxy%20install%20anjia0532.ansible_beats%5Cn-%20downloading%20role%20'ansible_beats'%2C%20owned%20by%20anjia0532%5Cn-%20downloading%20role%20from%20https%3A%2F%2Fgithub.com%2Fanjia0532%2Fansible-beats%2Farchive%2Fmaster.tar.gz%5Cn-%20extracting%20anjia0532.ansible_beats%20to%20%2Froot%2F.ansible%2Froles%2Fanjia0532.ansible_beats%5Cn-%20anjia0532.ansible_beats%20(master)%20was%20installed%20successfully%22%2C%22id%22%3A%22YzzwB%22%7D\"></card><p><br /></p><h3 id=\"e7a37043\">创建inventorys</h3><p>创建 <code>inventorys/hosts.yml</code> </p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22yaml%22%2C%22code%22%3A%22beats%3A%5Cn%20%20hosts%3A%20%5Cn%20%20%20%20192.168.0.23%3A%5Cn%20%20%20%20%20%20%20%20ansible_user%3A%20Administrator%5Cn%20%20%20%20%20%20%20%20ansible_password%3A%20password%5Cn%20%20%20%20%20%20%20%20ansible_connection%3A%20winrm%5Cn%20%20%20%20%20%20%20%20ansible_winrm_transport%3A%20basic%5Cn%20%20%20%20%20%20%20%20ansible_port%3A%205985%5Cn%20%20%20%20192.168.0.24%3A%5Cn%20%20%20%20%20%20%20%20ansible_user%3A%20root%5Cn%20%20%20%20%20%20%20%20ansible_ssh_private_key_file%3A%20%2Froot%2F.ssh%2Fid_rsa%5Cn%20%20%20%20192.168.0.25%3A%5Cn%20%20%20%20%20%20%20%20ansible_user%3A%20root%5Cn%20%20%20%20%20%20%20%20ansible_ssh_private_key_file%3A%20%2Froot%2F.ssh%2Fid_rsa%22%2C%22id%22%3A%22RIVJQ%22%7D\"></card><p><br /></p><h3 id=\"b990749b\">创建 task</h3><p>创建 beats.yml</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22yaml%22%2C%22code%22%3A%22-%20name%3A%20Example%20playbook%20for%20installing%20packetbeat%5Cn%20%20hosts%3A%20beats%5Cn%20%20roles%3A%5Cn%20%20%20%20-%20%7B%20role%3A%20anjia0532.ansible_beats%2C%5Cn%20%20%20%20%20%20%20%20beat%3A%20%5C%22packetbeat%5C%22%2C%5Cn%20%20%20%20%20%20%20%20beat_conf%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%5C%22interfaces%5C%22%3A%20%7B%5C%22device%5C%22%3A%5C%22any%5C%22%7D%2C%5Cn%20%20%20%20%20%20%20%20%20%20%5C%22protocols%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22dns%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ports%5C%22%3A%20%5B53%5D%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%22include_authorities%5C%22%3Atrue%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22http%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ports%5C%22%3A%20%5B80%2C%208080%2C%208000%2C%205000%2C%208002%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22memcache%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ports%5C%22%3A%20%5B11211%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22mysql%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ports%5C%22%3A%20%5B3306%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22pgsql%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ports%5C%22%3A%20%5B5432%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22redis%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ports%5C%22%3A%20%5B6379%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22thrift%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ports%5C%22%3A%20%5B9090%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22mongodb%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ports%5C%22%3A%20%5B27017%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%7D%2C%5Cn%20%20%20%20%20%20%20%20output_conf%20%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%5C%22elasticsearch%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22hosts%5C%22%3A%20%5B%5C%22localhost%3A9200%5C%22%5D%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D%5Cn%20%20vars%3A%5Cn%20%20%20%20use_repository%3A%20true%22%2C%22id%22%3A%226stNU%22%7D\"></card><p><br /></p><h3 id=\"b47ee1bf\">安装beats</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23%20ansible-playbook%20-i%20inventorys%2Fhosts.yml%20.%2Fbeats.yml%5Cn%5Cn%2F%2F%20%E5%BF%BD%E7%95%A5%E8%BE%93%E5%87%BA%5CnPLAY%20RECAP%20*******************************************************************************************************************************************************************************************************************************************************************%5Cn192.168.0.23%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3A%20ok%3D17%20%20%20changed%3D17%20%20%20%20unreachable%3D0%20%20%20%20failed%3D0%5Cn192.168.0.24%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3A%20ok%3D19%20%20%20changed%3D19%20%20%20%20unreachable%3D0%20%20%20%20failed%3D0%5Cn192.168.0.25%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3A%20ok%3D19%20%20%20changed%3D19%20%20%20%20unreachable%3D0%20%20%20%20failed%3D0%22%2C%22id%22%3A%22gzkft%22%7D\"></card><p>表明都成功了</p><p><br /></p><h3 id=\"7a433c76\">查看配置文件和日志</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22ssh%20root%40192.168.0.24%5Cncat%20%2Fetc%2Fpacketbeat%2Fpacketbeat.yml%22%2C%22id%22%3A%22qF2Ee%22%7D\"></card><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22yaml%22%2C%22code%22%3A%22%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%20packetbeat%20Configuration%20%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%5Cn%5Cn%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%20packetbeat%20%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%5Cninterfaces%3A%5Cn%20%20%20%20device%3A%20any%5Cnprotocols%3A%5Cn%20%20%20%20dns%3A%5Cn%20%20%20%20%20%20%20%20include_authorities%3A%20true%5Cn%20%20%20%20%20%20%20%20ports%3A%5Cn%20%20%20%20%20%20%20%20-%2053%5Cn%20%20%20%20http%3A%5Cn%20%20%20%20%20%20%20%20ports%3A%5Cn%20%20%20%20%20%20%20%20-%2080%5Cn%20%20%20%20%20%20%20%20-%208080%5Cn%20%20%20%20%20%20%20%20-%208000%5Cn%20%20%20%20%20%20%20%20-%205000%5Cn%20%20%20%20%20%20%20%20-%208002%5Cn%20%20%20%20memcache%3A%5Cn%20%20%20%20%20%20%20%20ports%3A%5Cn%20%20%20%20%20%20%20%20-%2011211%5Cn%20%20%20%20mongodb%3A%5Cn%20%20%20%20%20%20%20%20ports%3A%5Cn%20%20%20%20%20%20%20%20-%2027017%5Cn%20%20%20%20mysql%3A%5Cn%20%20%20%20%20%20%20%20ports%3A%5Cn%20%20%20%20%20%20%20%20-%203306%5Cn%20%20%20%20pgsql%3A%5Cn%20%20%20%20%20%20%20%20ports%3A%5Cn%20%20%20%20%20%20%20%20-%205432%5Cn%20%20%20%20redis%3A%5Cn%20%20%20%20%20%20%20%20ports%3A%5Cn%20%20%20%20%20%20%20%20-%206379%5Cn%20%20%20%20thrift%3A%5Cn%20%20%20%20%20%20%20%20ports%3A%5Cn%20%20%20%20%20%20%20%20-%209090%5Cn%5Cn%5Cn%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%5Cn%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%20Libbeat%20Config%20%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%5Cn%23%20Base%20config%20file%20used%20by%20all%20other%20beats%20for%20using%20libbeat%20features%5Cn%5Cn%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%20Output%20%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%5Cn%5Cnoutput%3A%5Cn%20%20%20%20elasticsearch%3A%5Cn%20%20%20%20%20%20%20%20hosts%3A%5Cn%20%20%20%20%20%20%20%20-%20localhost%3A9200%5Cn%5Cn%5Cn%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%20Logging%20%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%5Cn%5Cnlogging%3A%5Cn%20%20%20%20files%3A%5Cn%20%20%20%20%20%20%20%20rotateeverybytes%3A%2010485760%22%2C%22id%22%3A%22U8pOe%22%7D\"></card><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23%20less%20%2Fvar%2Flog%2Fpacketbeat%2Fpacketbeat%5Cn%5Cn2019-04-13T09%3A38%3A44.865%2B0800%20%20%20%20INFO%20%20%20%20instance%2Fbeat.go%3A611%20%20%20%20Home%20path%3A%20%5B%2Fusr%2Fshare%2Fpacketbeat%5D%20Config%20path%3A%20%5B%2Fetc%2Fpacketbeat%5D%20Data%20path%3A%20%5B%2Fvar%2Flib%2Fpacketbeat%5D%20Logs%20path%3A%20%5B%2Fvar%2Flog%2Fpacketbeat%5D%5Cn2019-04-13T09%3A38%3A44.868%2B0800%20%20%20%20INFO%20%20%20%20instance%2Fbeat.go%3A618%20%20%20%20Beat%20UUID%3A%208fbd86a8-0bbc-4349-8aca-d4dc8c897ba2%5Cn2019-04-13T09%3A38%3A44.868%2B0800%20%20%20%20INFO%20%20%20%20%5Bseccomp%5D%20%20%20%20%20%20%20seccomp%2Fseccomp.go%3A116%20%20Syscall%20filter%20successfully%20installed%5Cn2019-04-13T09%3A38%3A44.868%2B0800%20%20%20%20INFO%20%20%20%20%5Bbeat%5D%20%20instance%2Fbeat.go%3A931%20%20%20%20Beat%20info%20%20%20%20%20%20%20%7B%5C%22system_info%5C%22%3A%20%7B%5C%22beat%5C%22%3A%20%7B%5C%22path%5C%22%3A%20%7B%5C%22config%5C%22%3A%20%5C%22%2Fetc%2Fpacketbeat%5C%22%2C%20%5C%22data%5C%22%3A%20%5C%22%2Fvar%2Flib%2Fpacketbeat%5C%22%2C%20%5C%22home%5C%22%3A%20%5C%22%2Fusr%2Fshare%2Fpacketbeat%5C%22%2C%20%5C%22logs%5C%22%3A%20%5C%22%2Fvar%2Flog%2Fpacketbeat%5C%22%7D%2C%20%5C%22type%5C%22%3A%20%5C%22packetbeat%5C%22%2C%20%5C%22uuid%5C%22%3A%20%5C%228fbd86a8-0bbc-4349-8aca-d4dc8c897ba2%5C%22%7D%7D%7D%5Cn2019-04-13T09%3A38%3A44.868%2B0800%20%20%20%20INFO%20%20%20%20%5Bbeat%5D%20%20instance%2Fbeat.go%3A940%20%20%20%20Build%20info%20%20%20%20%20%20%7B%5C%22system_info%5C%22%3A%20%7B%5C%22build%5C%22%3A%20%7B%5C%22commit%5C%22%3A%20%5C%221d55b4bd9dbf106a4ad4bc34fe9ee425d922363b%5C%22%2C%20%5C%22libbeat%5C%22%3A%20%5C%226.7.1%5C%22%2C%20%5C%22time%5C%22%3A%20%5C%222019-04-02T15%3A15%3A12.000Z%5C%22%2C%20%5C%22version%5C%22%3A%20%5C%226.7.1%5C%22%7D%7D%7D%5Cn2019-04-13T09%3A38%3A44.868%2B0800%20%20%20%20INFO%20%20%20%20%5Bbeat%5D%20%20instance%2Fbeat.go%3A943%20%20%20%20Go%20runtime%20info%20%7B%5C%22system_info%5C%22%3A%20%7B%5C%22go%5C%22%3A%20%7B%5C%22os%5C%22%3A%5C%22linux%5C%22%2C%5C%22arch%5C%22%3A%5C%22amd64%5C%22%2C%5C%22max_procs%5C%22%3A4%2C%5C%22version%5C%22%3A%5C%22go1.10.8%5C%22%7D%7D%7D%5Cn2019-04-13T09%3A38%3A44.872%2B0800%20%20%20%20INFO%20%20%20%20%5Bbeat%5D%20%20instance%2Fbeat.go%3A947%20%20%20%20Host%20info%20%20%20%20%20%20%20%7B%5C%22system_info%5C%22%3A%20%7B%5C%22host%5C%22%3A%20%7B%5C%22architecture%5C%22%3A%5C%22x86_64%5C%22%2C%5C%22boot_time%5C%22%3A%5C%222019-04-12T20%3A58%3A45%2B08%3A00%5C%22%2C%5C%22containerized%5C%22%3Atrue%2C%5C%22name%5C%22%3A%5C%22localhost.localdomain%5C%22%2C%5C%22ip%5C%22%3A%5B%5C%22127.0.0.1%2F8%5C%22%2C%5C%22%3A%3A1%2F128%5C%22%2C%5C%22172.60.20.116%2F24%5C%22%2C%5C%22fe80%3A%3A536d%3A17d0%3Ae9f6%3A57c%2F64%5C%22%5D%2C%5C%22kernel_version%5C%22%3A%5C%223.10.0-957.el7.x86_64%5C%22%2C%5C%22mac%5C%22%3A%5B%5C%2200%3A50%3A56%3A9f%3A8b%3Ab7%5C%22%5D%2C%5C%22os%5C%22%3A%7B%5C%22family%5C%22%3A%5C%22redhat%5C%22%2C%5C%22platform%5C%22%3A%5C%22centos%5C%22%2C%5C%22name%5C%22%3A%5C%22CentOS%20Linux%5C%22%2C%5C%22version%5C%22%3A%5C%227%20(Core)%5C%22%2C%5C%22major%5C%22%3A7%2C%5C%22minor%5C%22%3A6%2C%5C%22patch%5C%22%3A1810%2C%5C%22codename%5C%22%3A%5C%22Core%5C%22%7D%2C%5C%22timezone%5C%22%3A%5C%22CST%5C%22%2C%5C%22timezone_offset_sec%5C%22%3A28800%2C%5C%22id%5C%22%3A%5C%22cd7bb2d0c80a41c89bb5b596c22fc85e%5C%22%7D%7D%7D%5Cn2019-04-13T09%3A38%3A44.873%2B0800%20%20%20%20INFO%20%20%20%20%5Bbeat%5D%20%20instance%2Fbeat.go%3A976%20%20%20%20Process%20info%20%20%20%20%7B%5C%22system_info%5C%22%3A%20%7B%5C%22process%5C%22%3A%20%7B%5C%22capabilities%5C%22%3A%20%7B%5C%22inheritable%5C%22%3Anull%2C%5C%22permitted%5C%22%3A%5B%5C%22chown%5C%22%2C%5C%22dac_override%5C%22%2C%5C%22dac_read_search%5C%22%2C%5C%22fowner%5C%22%2C%5C%22fsetid%5C%22%2C%5C%22kill%5C%22%2C%5C%22setgid%5C%22%2C%5C%22setuid%5C%22%2C%5C%22setpcap%5C%22%2C%5C%22linux_immutable%5C%22%2C%5C%22net_bind_service%5C%22%2C%5C%22net_broadcast%5C%22%2C%5C%22net_admin%5C%22%2C%5C%22net_raw%5C%22%2C%5C%22ipc_lock%5C%22%2C%5C%22ipc_owner%5C%22%2C%5C%22sys_module%5C%22%2C%5C%22sys_rawio%5C%22%2C%5C%22sys_chroot%5C%22%2C%5C%22sys_ptrace%5C%22%2C%5C%22sys_pacct%5C%22%2C%5C%22sys_admin%5C%22%2C%5C%22sys_boot%5C%22%2C%5C%22sys_nice%5C%22%2C%5C%22sys_resource%5C%22%2C%5C%22sys_time%5C%22%2C%5C%22sys_tty_config%5C%22%2C%5C%22mknod%5C%22%2C%5C%22lease%5C%22%2C%5C%22audit_write%5C%22%2C%5C%22audit_control%5C%22%2C%5C%22setfcap%5C%22%2C%5C%22mac_override%5C%22%2C%5C%22mac_admin%5C%22%2C%5C%22syslog%5C%22%2C%5C%22wake_alarm%5C%22%2C%5C%22block_suspend%5C%22%5D%2C%5C%22effective%5C%22%3A%5B%5C%22chown%5C%22%2C%5C%22dac_override%5C%22%2C%5C%22dac_read_search%5C%22%2C%5C%22fowner%5C%22%2C%5C%22fsetid%5C%22%2C%5C%22kill%5C%22%2C%5C%22setgid%5C%22%2C%5C%22setuid%5C%22%2C%5C%22setpcap%5C%22%2C%5C%22linux_immutable%5C%22%2C%5C%22net_bind_service%5C%22%2C%5C%22net_broadcast%5C%22%2C%5C%22net_admin%5C%22%2C%5C%22net_raw%5C%22%2C%5C%22ipc_lock%5C%22%2C%5C%22ipc_owner%5C%22%2C%5C%22sys_module%5C%22%2C%5C%22sys_rawio%5C%22%2C%5C%22sys_chroot%5C%22%2C%5C%22sys_ptrace%5C%22%2C%5C%22sys_pacct%5C%22%2C%5C%22sys_admin%5C%22%2C%5C%22sys_boot%5C%22%2C%5C%22sys_nice%5C%22%2C%5C%22sys_resource%5C%22%2C%5C%22sys_time%5C%22%2C%5C%22sys_tty_config%5C%22%2C%5C%22mknod%5C%22%2C%5C%22lease%5C%22%2C%5C%22audit_write%5C%22%2C%5C%22audit_control%5C%22%2C%5C%22setfcap%5C%22%2C%5C%22mac_override%5C%22%2C%5C%22mac_admin%5C%22%2C%5C%22syslog%5C%22%2C%5C%22wake_alarm%5C%22%2C%5C%22block_suspend%5C%22%5D%2C%5C%22bounding%5C%22%3A%5B%5C%22chown%5C%22%2C%5C%22dac_override%5C%22%2C%5C%22dac_read_search%5C%22%2C%5C%22fowner%5C%22%2C%5C%22fsetid%5C%22%2C%5C%22kill%5C%22%2C%5C%22setgid%5C%22%2C%5C%22setuid%5C%22%2C%5C%22setpcap%5C%22%2C%5C%22linux_immutable%5C%22%2C%5C%22net_bind_service%5C%22%2C%5C%22net_broadcast%5C%22%2C%5C%22net_admin%5C%22%2C%5C%22net_raw%5C%22%2C%5C%22ipc_lock%5C%22%2C%5C%22ipc_owner%5C%22%2C%5C%22sys_module%5C%22%2C%5C%22sys_rawio%5C%22%2C%5C%22sys_chroot%5C%22%2C%5C%22sys_ptrace%5C%22%2C%5C%22sys_pacct%5C%22%2C%5C%22sys_admin%5C%22%2C%5C%22sys_boot%5C%22%2C%5C%22sys_nice%5C%22%2C%5C%22sys_resource%5C%22%2C%5C%22sys_time%5C%22%2C%5C%22sys_tty_config%5C%22%2C%5C%22mknod%5C%22%2C%5C%22lease%5C%22%2C%5C%22audit_write%5C%22%2C%5C%22audit_control%5C%22%2C%5C%22setfcap%5C%22%2C%5C%22mac_override%5C%22%2C%5C%22mac_admin%5C%22%2C%5C%22syslog%5C%22%2C%5C%22wake_alarm%5C%22%2C%5C%22block_suspend%5C%22%5D%2C%5C%22ambient%5C%22%3Anull%7D%2C%20%5C%22cwd%5C%22%3A%20%5C%22%2F%5C%22%2C%20%5C%22exe%5C%22%3A%20%5C%22%2Fusr%2Fshare%2Fpacketbeat%2Fbin%2Fpacketbeat%5C%22%2C%20%5C%22name%5C%22%3A%20%5C%22packetbeat%5C%22%2C%20%5C%22pid%5C%22%3A%209683%2C%20%5C%22ppid%5C%22%3A%201%2C%20%5C%22seccomp%5C%22%3A%20%7B%5C%22mode%5C%22%3A%5C%22filter%5C%22%7D%2C%20%5C%22start_time%5C%22%3A%20%5C%222019-04-13T09%3A38%3A44.350%2B0800%5C%22%7D%7D%7D%5Cn2019-04-13T09%3A38%3A44.874%2B0800%20%20%20%20INFO%20%20%20%20instance%2Fbeat.go%3A280%20%20%20%20Setup%20Beat%3A%20packetbeat%3B%20Version%3A%206.7.1%5Cn2019-04-13T09%3A38%3A44.874%2B0800%20%20%20%20INFO%20%20%20%20elasticsearch%2Fclient.go%3A164%20%20%20%20%20Elasticsearch%20url%3A%20http%3A%2F%2Flocalhost%3A9200%5Cn2019-04-13T09%3A38%3A44.875%2B0800%20%20%20%20INFO%20%20%20%20%5Bpublisher%5D%20%20%20%20%20pipeline%2Fmodule.go%3A110%20%20Beat%20name%3A%20localhost.localdomain%5Cn2019-04-13T09%3A38%3A44.875%2B0800%20%20%20%20INFO%20%20%20%20procs%2Fprocs.go%3A101%20%20%20%20%20%20Process%20watcher%20disabled%5Cn2019-04-13T09%3A38%3A44.877%2B0800%20%20%20%20INFO%20%20%20%20instance%2Fbeat.go%3A402%20%20%20%20packetbeat%20start%20running.%5Cn2019-04-13T09%3A38%3A44.877%2B0800%20%20%20%20INFO%20%20%20%20%5Bmonitoring%5D%20%20%20%20log%2Flog.go%3A117%20%20Starting%20metrics%20logging%20every%2030s%5Cn2019-04-13T09%3A39%3A14.887%2B0800%20%20%20%20INFO%20%20%20%20%5Bmonitoring%5D%20%20%20%20log%2Flog.go%3A144%20%20Non-zero%20metrics%20in%20the%20last%2030s%20%20%20%20%20%20%20%20%7B%5C%22monitoring%5C%22%3A%20%7B%5C%22metrics%5C%22%3A%20%7B%5C%22beat%5C%22%3A%7B%5C%22cpu%5C%22%3A%7B%5C%22system%5C%22%3A%7B%5C%22ticks%5C%22%3A160%2C%5C%22time%5C%22%3A%7B%5C%22ms%5C%22%3A162%7D%7D%2C%5C%22total%5C%22%3A%7B%5C%22ticks%5C%22%3A610%2C%5C%22time%5C%22%3A%7B%5C%22ms%5C%22%3A614%7D%2C%5C%22value%5C%22%3A0%7D%2C%5C%22user%5C%22%3A%7B%5C%22ticks%5C%22%3A450%2C%5C%22time%5C%22%3A%7B%5C%22ms%5C%22%3A452%7D%7D%7D%2C%5C%22handles%5C%22%3A%7B%5C%22limit%5C%22%3A%7B%5C%22hard%5C%22%3A4096%2C%5C%22soft%5C%22%3A1024%7D%2C%5C%22open%5C%22%3A7%7D%2C%5C%22info%5C%22%3A%7B%5C%22ephemeral_id%5C%22%3A%5C%22691a2203-1433-44d4-b173-938a52dbea22%5C%22%2C%5C%22uptime%5C%22%3A%7B%5C%22ms%5C%22%3A30042%7D%7D%2C%5C%22memstats%5C%22%3A%7B%5C%22gc_next%5C%22%3A36201104%2C%5C%22memory_alloc%5C%22%3A18724416%2C%5C%22memory_total%5C%22%3A23093208%2C%5C%22rss%5C%22%3A45715456%7D%7D%2C%5C%22libbeat%5C%22%3A%7B%5C%22config%5C%22%3A%7B%5C%22module%5C%22%3A%7B%5C%22running%5C%22%3A0%7D%7D%2C%5C%22output%5C%22%3A%7B%5C%22type%5C%22%3A%5C%22elasticsearch%5C%22%7D%2C%5C%22pipeline%5C%22%3A%7B%5C%22clients%5C%22%3A0%2C%5C%22events%5C%22%3A%7B%5C%22active%5C%22%3A0%7D%7D%7D%2C%5C%22system%5C%22%3A%7B%5C%22cpu%5C%22%3A%7B%5C%22cores%5C%22%3A4%7D%2C%5C%22load%5C%22%3A%7B%5C%221%5C%22%3A0.1%2C%5C%2215%5C%22%3A0.06%2C%5C%225%5C%22%3A0.05%2C%5C%22norm%5C%22%3A%7B%5C%221%5C%22%3A0.025%2C%5C%2215%5C%22%3A0.015%2C%5C%225%5C%22%3A0.0125%7D%7D%7D%7D%7D%7D%22%2C%22id%22%3A%22L7Awb%22%7D\"></card><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#latest-releases-via-apt-ubuntu\" target=\"_blank\">Latest Releases via Apt (Ubuntu)</a></li><li><a href=\"https://docs.ansible.com/ansible/latest/user_guide/windows.html\" target=\"_blank\">Windows Guides</a></li><li><a href=\"https://github.com/elastic/beats/issues/4364\" target=\"_blank\">Document npcap requires WinPcap Compatible Mode</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-04-18T03:03:27.000Z",
    "deleted_at": null,
    "created_at": "2019-04-12T12:31:54.000Z",
    "updated_at": "2019-04-18T03:03:27.000Z",
    "published_at": "2019-04-18T03:03:27.000Z",
    "first_published_at": "2019-04-13T04:25:23.000Z",
    "word_count": 1958,
    "cover": "",
    "description": "date: 2019-04-13 20:41:00tags: [ansible,linux,运维,beats,es,elasticsearch]categories: 运维,elasticsearch---这是坚持技术写作计划（含翻译）的第15篇，定个小目标999，每周最少2篇。使用elast...",
    "custom_description": "使用elastic beats进行拨测，metric采集，主机监控，但是批量化安装仍是个问题，好在elastic官方有开源的 ansible-beats 但是只支持Linux，而我们在某些业务场景下，还有WinServer的存在。故而在官方基础上fork并增加了windows的支持（已提交PR，但是",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1465333,
    "slug": "scrapy-proxy",
    "title": "014-活该你爬虫被封之Scrapy Ip代理中间件",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-04-02 20:41:00\n\ntags: [python,scrapy,proxy]<br />categories: 爬虫<br />---\n\n> 这是坚持技术写作计划（含翻译）的第14篇，定个小目标999，每周最少2篇。\n\n\n背景: 房租到期了。<br />需求: 找到便宜，交通便利的房源，了解当前租房行情，便于砍价。\n\n在爬取58，赶集，链家，安居客的数据时，被封是常事，基于此，fork并修改了两个库。用于抓取免费代理ip，用于支持爬取租房数据。\n\n注意：租房网站的数据，大概率失真，仅做参考。\n\n<!-- more -->\n\n其中部分数据截图<br />\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1554210833561-38730012-a2d6-4d00-aed7-5576b112e7c5.png#align=left&display=inline&height=740&name=image.png&originHeight=740&originWidth=1868&size=451298&status=done&width=1868)\n\n本文只介绍Scrapy的ip代理中间件，不多讲如何爬取租房网站数据以及数据分析，后边可能会写。\n\n<a name=\"274ffdf6\"></a>\n## 获取代理ip\n如果有付费的代理ip更好，如果没有的话，可以用我构建的docker镜像\n\n```bash\ndocker run -p8765:8765 -d anjia0532/ipproxy-dockerfile\n```\n\n稍等2-5分钟，访问  http://${docker ip}:8765/ ,如果有值，则抓取代理ip成功。\n\n<a name=\"scrapy-proxies-tool\"></a>\n## scrapy-proxies-tool\n\n<a name=\"e655a410\"></a>\n### 安装\n\n```bash\npip install scrapy-proxies-tool\n```\n\n<a name=\"224e2ccd\"></a>\n### 配置\n修改 Scrapy settings.py，源[repo ](https://github.com/aivarsk/scrapy-proxies)只支持从文件读取代理ip\n\n```python\n# Retry many times since proxies often fail\nRETRY_TIMES = 10\n# Retry on most error codes since proxies fail for different reasons\nRETRY_HTTP_CODES = [500, 503, 504, 400, 403, 404, 408]\n\nDOWNLOADER_MIDDLEWARES = {\n  'scrapy.downloadermiddlewares.retry.RetryMiddleware': 90,\n  'scrapy_proxies.RandomProxy': 100,\n  'scrapy.downloadermiddlewares.httpproxy.HttpProxyMiddleware': 110,\n}\n\nPROXY_SETTINGS = {\n  # Proxy list containing entries like\n  # http://host1:port\n  # http://username:password@host2:port\n  # http://host3:port\n  # ...\n  # if PROXY_SETTINGS[from_proxies_server] = True , proxy_list is server address (ref https://github.com/qiyeboy/IPProxyPool and https://github.com/awolfly9/IPProxyTool )\n  # Only support http(ref https://github.com/qiyeboy/IPProxyPool#%E5%8F%82%E6%95%B0)\n  # list : ['http://localhost:8765?protocol=0'],\n  'list':['/path/to/proxy/list.txt'],\n\n  # disable proxy settings and  use real ip when all proxies are unusable\n  'use_real_when_empty':False,\n  'from_proxies_server':False,\n\n  # If proxy mode is 2 uncomment this sentence :\n  # 'custom_proxy': \"http://host1:port\",\n\n  # Proxy mode\n  # 0 = Every requests have different proxy\n  # 1 = Take only one proxy from the list and assign it to every requests\n  # 2 = Put a custom proxy to use in the settings\n  'mode':0\n}\n```\n\n可以通过爬取 [http://myip.ipip.net/](http://myip.ipip.net/) 来判断代理ip是否生效。\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [https://github.com/anjia0532/IPProxyPool](https://github.com/anjia0532/IPProxyPool)\n- [https://hub.docker.com/r/anjia0532/ipproxy-dockerfile](https://hub.docker.com/r/anjia0532/ipproxy-dockerfile)\n- [https://github.com/aivarsk/scrapy-proxies](https://github.com/aivarsk/scrapy-proxies)\n- [https://github.com/anjia0532/scrapy-proxies](https://github.com/anjia0532/scrapy-proxies)\n",
    "body_draft": "",
    "body_html": "<p><span>date: 2019-04-02 20:41:00</span><br /></p><p>tags: [python,scrapy,proxy]</p><p>categories: 爬虫</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第14篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>背景: 房租到期了。</p><p>需求: 找到便宜，交通便利的房源，了解当前租房行情，便于砍价。</p><p><br /></p><p>在爬取58，赶集，链家，安居客的数据时，被封是常事，基于此，fork并修改了两个库。用于抓取免费代理ip，用于支持爬取租房数据。</p><p><br /></p><p>注意：租房网站的数据，大概率失真，仅做参考。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><p>其中部分数据截图</p><p><br /><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1554210833561-38730012-a2d6-4d00-aed7-5576b112e7c5.png#align=left&amp;display=inline&amp;height=740&amp;name=image.png&amp;originHeight=740&amp;originWidth=1868&amp;size=451298&amp;status=done&amp;width=1868\" style=\"max-width: 600px; width: 1868px;\" /></p><p><br /></p><p>本文只介绍Scrapy的ip代理中间件，不多讲如何爬取租房网站数据以及数据分析，后边可能会写。</p><p><br /></p><h2 id=\"274ffdf6\">获取代理ip</h2><p>如果有付费的代理ip更好，如果没有的话，可以用我构建的docker镜像</p><p><br /></p><pre data-lang=\"bash\"><code>docker run -p8765:8765 -d anjia0532/ipproxy-dockerfile</code></pre><p><br /></p><p>稍等2-5分钟，访问  http://${docker ip}:8765/ ,如果有值，则抓取代理ip成功。</p><p><br /></p><h2 id=\"scrapy-proxies-tool\">scrapy-proxies-tool</h2><p><br /></p><h3 id=\"e655a410\">安装</h3><p><br /></p><pre data-lang=\"bash\"><code>pip install scrapy-proxies-tool</code></pre><p><br /></p><h3 id=\"224e2ccd\">配置</h3><p>修改 Scrapy settings.py，源<a href=\"https://github.com/aivarsk/scrapy-proxies\" target=\"_blank\">repo </a>只支持从文件读取代理ip</p><p><br /></p><pre data-lang=\"python\"><code># Retry many times since proxies often fail\nRETRY_TIMES = 10\n# Retry on most error codes since proxies fail for different reasons\nRETRY_HTTP_CODES = [500, 503, 504, 400, 403, 404, 408]\n\nDOWNLOADER_MIDDLEWARES = {\n  'scrapy.downloadermiddlewares.retry.RetryMiddleware': 90,\n  'scrapy_proxies.RandomProxy': 100,\n  'scrapy.downloadermiddlewares.httpproxy.HttpProxyMiddleware': 110,\n}\n\nPROXY_SETTINGS = {\n  # Proxy list containing entries like\n  # http://host1:port\n  # http://username:password@host2:port\n  # http://host3:port\n  # ...\n  # if PROXY_SETTINGS[from_proxies_server] = True , proxy_list is server address (ref https://github.com/qiyeboy/IPProxyPool and https://github.com/awolfly9/IPProxyTool )\n  # Only support http(ref https://github.com/qiyeboy/IPProxyPool#%E5%8F%82%E6%95%B0)\n  # list : ['http://localhost:8765?protocol=0'],\n  'list':['/path/to/proxy/list.txt'],\n\n  # disable proxy settings and  use real ip when all proxies are unusable\n  'use_real_when_empty':False,\n  'from_proxies_server':False,\n\n  # If proxy mode is 2 uncomment this sentence :\n  # 'custom_proxy': &quot;http://host1:port&quot;,\n\n  # Proxy mode\n  # 0 = Every requests have different proxy\n  # 1 = Take only one proxy from the list and assign it to every requests\n  # 2 = Put a custom proxy to use in the settings\n  'mode':0\n}</code></pre><p><br /></p><p>可以通过爬取 <a href=\"http://myip.ipip.net/\" target=\"_blank\">http://myip.ipip.net/</a> 来判断代理ip是否生效。</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://github.com/anjia0532/IPProxyPool\" target=\"_blank\">https://github.com/anjia0532/IPProxyPool</a></li><li><a href=\"https://hub.docker.com/r/anjia0532/ipproxy-dockerfile\" target=\"_blank\">https://hub.docker.com/r/anjia0532/ipproxy-dockerfile</a></li><li><a href=\"https://github.com/aivarsk/scrapy-proxies\" target=\"_blank\">https://github.com/aivarsk/scrapy-proxies</a></li><li><a href=\"https://github.com/anjia0532/scrapy-proxies\" target=\"_blank\">https://github.com/anjia0532/scrapy-proxies</a></li></ul>",
    "body_lake": "<!doctype lake><p><span>date: 2019-04-02 20:41:00</span><br /></p><p>tags: [python,scrapy,proxy]</p><p>categories: 爬虫</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第14篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>背景: 房租到期了。</p><p>需求: 找到便宜，交通便利的房源，了解当前租房行情，便于砍价。</p><p><br /></p><p>在爬取58，赶集，链家，安居客的数据时，被封是常事，基于此，fork并修改了两个库。用于抓取免费代理ip，用于支持爬取租房数据。</p><p><br /></p><p>注意：租房网站的数据，大概率失真，仅做参考。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><p>其中部分数据截图</p><p><br /><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1554210833561-38730012-a2d6-4d00-aed7-5576b112e7c5.png%22%2C%22originWidth%22%3A1868%2C%22originHeight%22%3A740%2C%22name%22%3A%22image.png%22%2C%22size%22%3A451298%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1868%2C%22height%22%3A740%7D\"></card></p><p><br /></p><p>本文只介绍Scrapy的ip代理中间件，不多讲如何爬取租房网站数据以及数据分析，后边可能会写。</p><p><br /></p><h2 id=\"274ffdf6\">获取代理ip</h2><p>如果有付费的代理ip更好，如果没有的话，可以用我构建的docker镜像</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22docker%20run%20-p8765%3A8765%20-d%20anjia0532%2Fipproxy-dockerfile%22%2C%22id%22%3A%229dlA1%22%7D\"></card><p><br /></p><p>稍等2-5分钟，访问  http://${docker ip}:8765/ ,如果有值，则抓取代理ip成功。</p><p><br /></p><h2 id=\"scrapy-proxies-tool\">scrapy-proxies-tool</h2><p><br /></p><h3 id=\"e655a410\">安装</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22pip%20install%20scrapy-proxies-tool%22%2C%22id%22%3A%22uQAA2%22%7D\"></card><p><br /></p><h3 id=\"224e2ccd\">配置</h3><p>修改 Scrapy settings.py，源<a href=\"https://github.com/aivarsk/scrapy-proxies\" target=\"_blank\">repo </a>只支持从文件读取代理ip</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22python%22%2C%22code%22%3A%22%23%20Retry%20many%20times%20since%20proxies%20often%20fail%5CnRETRY_TIMES%20%3D%2010%5Cn%23%20Retry%20on%20most%20error%20codes%20since%20proxies%20fail%20for%20different%20reasons%5CnRETRY_HTTP_CODES%20%3D%20%5B500%2C%20503%2C%20504%2C%20400%2C%20403%2C%20404%2C%20408%5D%5Cn%5CnDOWNLOADER_MIDDLEWARES%20%3D%20%7B%5Cn%20%20'scrapy.downloadermiddlewares.retry.RetryMiddleware'%3A%2090%2C%5Cn%20%20'scrapy_proxies.RandomProxy'%3A%20100%2C%5Cn%20%20'scrapy.downloadermiddlewares.httpproxy.HttpProxyMiddleware'%3A%20110%2C%5Cn%7D%5Cn%5CnPROXY_SETTINGS%20%3D%20%7B%5Cn%20%20%23%20Proxy%20list%20containing%20entries%20like%5Cn%20%20%23%20http%3A%2F%2Fhost1%3Aport%5Cn%20%20%23%20http%3A%2F%2Fusername%3Apassword%40host2%3Aport%5Cn%20%20%23%20http%3A%2F%2Fhost3%3Aport%5Cn%20%20%23%20...%5Cn%20%20%23%20if%20PROXY_SETTINGS%5Bfrom_proxies_server%5D%20%3D%20True%20%2C%20proxy_list%20is%20server%20address%20(ref%20https%3A%2F%2Fgithub.com%2Fqiyeboy%2FIPProxyPool%20and%20https%3A%2F%2Fgithub.com%2Fawolfly9%2FIPProxyTool%20)%5Cn%20%20%23%20Only%20support%20http(ref%20https%3A%2F%2Fgithub.com%2Fqiyeboy%2FIPProxyPool%23%25E5%258F%2582%25E6%2595%25B0)%5Cn%20%20%23%20list%20%3A%20%5B'http%3A%2F%2Flocalhost%3A8765%3Fprotocol%3D0'%5D%2C%5Cn%20%20'list'%3A%5B'%2Fpath%2Fto%2Fproxy%2Flist.txt'%5D%2C%5Cn%5Cn%20%20%23%20disable%20proxy%20settings%20and%20%20use%20real%20ip%20when%20all%20proxies%20are%20unusable%5Cn%20%20'use_real_when_empty'%3AFalse%2C%5Cn%20%20'from_proxies_server'%3AFalse%2C%5Cn%5Cn%20%20%23%20If%20proxy%20mode%20is%202%20uncomment%20this%20sentence%20%3A%5Cn%20%20%23%20'custom_proxy'%3A%20%5C%22http%3A%2F%2Fhost1%3Aport%5C%22%2C%5Cn%5Cn%20%20%23%20Proxy%20mode%5Cn%20%20%23%200%20%3D%20Every%20requests%20have%20different%20proxy%5Cn%20%20%23%201%20%3D%20Take%20only%20one%20proxy%20from%20the%20list%20and%20assign%20it%20to%20every%20requests%5Cn%20%20%23%202%20%3D%20Put%20a%20custom%20proxy%20to%20use%20in%20the%20settings%5Cn%20%20'mode'%3A0%5Cn%7D%22%2C%22id%22%3A%22yezh8%22%7D\"></card><p><br /></p><p>可以通过爬取 <a href=\"http://myip.ipip.net/\" target=\"_blank\">http://myip.ipip.net/</a> 来判断代理ip是否生效。</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://github.com/anjia0532/IPProxyPool\" target=\"_blank\">https://github.com/anjia0532/IPProxyPool</a></li><li><a href=\"https://hub.docker.com/r/anjia0532/ipproxy-dockerfile\" target=\"_blank\">https://hub.docker.com/r/anjia0532/ipproxy-dockerfile</a></li><li><a href=\"https://github.com/aivarsk/scrapy-proxies\" target=\"_blank\">https://github.com/aivarsk/scrapy-proxies</a></li><li><a href=\"https://github.com/anjia0532/scrapy-proxies\" target=\"_blank\">https://github.com/anjia0532/scrapy-proxies<cursor /></a></li></ul>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-07-18T04:16:05.000Z",
    "deleted_at": null,
    "created_at": "2019-04-02T12:39:04.000Z",
    "updated_at": "2019-07-18T04:16:05.000Z",
    "published_at": "2019-07-18T04:16:05.000Z",
    "first_published_at": "2019-04-02T13:10:41.000Z",
    "word_count": 529,
    "cover": "",
    "description": "date: 2019-04-02 20:41:00tags: [python,scrapy,proxy]categories: 爬虫---这是坚持技术写作计划（含翻译）的第14篇，定个小目标999，每周最少2篇。背景: 房租到期了。需求: 找到便宜，交通便利的房源，了解当前租房行情，便于砍价。...",
    "custom_description": "背景: 房租到期了。需求: 找到便宜，交通便利的房源，了解当前租房行情，便于砍价。",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1449832,
    "slug": "d7y-private-registry",
    "title": "013-阿里Dragonfly体验之私有registry下载",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-03-30 10:17:00<br />tags: [docker,k8s,kubernetes,alibaba,Dragonfly]<br />categories: 运维<br />---\n\n> 这是坚持技术写作计划（含翻译）的第13篇，定个小目标999，每周最少2篇。\n\n\n书接上篇[ 012-P2P加速Docker镜像分发(阿里Dragonfly)](https://juejin.im/post/5c98a8e9f265da60e346fe04) ,讲解了如何快速搭建Dragonfly,但是访问的是公开镜像，本文主要讲解如何下载私有镜像。\n\n<!-- more -->\n\n<a name=\"12267079\"></a>\n## 实验环境\n<a name=\"65227369\"></a>\n### 主机\n| 类型 | 主机名 | 系统 | ip | docker version |\n| --- | --- | --- | --- | --- |\n| supernode | d7y-1 | Ubuntu Server 16.04.6 LTS X64 | 192.168.0.75 | 17.06.2ubuntu |\n| clinet1 | d7y-2 | Ubuntu Server 16.04.6 LTS X64 | 192.168.0.76 | 17.06.2ubuntu |\n| clinet2 | d7y-3 | Ubuntu Server 16.04.6 LTS X64 | 192.168.0.77 | 17.06.2ubuntu |\n\n<a name=\"592cc647\"></a>\n### 私有registry\n本次以[阿里云私有镜像库](https://cr.console.aliyun.com/cn-qingdao/instances/repositories)为例，可以自行开通。\n\n<a name=\"c40e1e5e\"></a>\n### 文档之坑\n官方文档比较简单,甚至带有误导性，下意识的以为应该在dfdaemon节点上配置auth信息，并且配的是真实的私有registry，如果真这么搞了，肯定被坑。（但是也能解释通，比较绕，dfdaemon本身就是一个伪装成registry，用来加速私有registry，那么登陆信息就应该换成dfdaemon ip，只是示例不太恰当而已，对初学者相当不友好倒是真的）<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1553913213390-3865b763-e270-4d25-8043-d140efc5faeb.png#align=left&display=inline&height=546&name=image.png&originHeight=546&originWidth=922&size=67579&status=done&width=922)\n\n<a name=\"494e38bf\"></a>\n## supernode步骤\n\n<a name=\"71e91348\"></a>\n### 安装supernode\n```bash\nroot@d7y-1:~# docker run --name dragonfly-supernode --restart=always \\\n              -d -p 8001:8001 -p 8002:8002 -v /data/dragonfly/supernode:/home/admin/supernode \\\n              registry.cn-hangzhou.aliyuncs.com/dragonflyoss/supernode:0.3.0 \\\n              -Dsupernode.advertiseIp=192.168.0.75\n\nroot@d7y-1:~# docker ps\nCONTAINER ID        IMAGE                                                            COMMAND                  CREATED              STATUS              PORTS                              NAMES\nbe7fb931db0b        registry.cn-hangzhou.aliyuncs.com/dragonflyoss/supernode:0.3.0   \"/bin/sh -c '/root...\"   About a minute ago   Up About a minute   0.0.0.0:8001-8002->8001-8002/tcp   dragonfly-supernode\n\nroot@d7y-1:/data/dragonfly/supernode/logs# cat app.log \n2019-03-30 01:04:40.065 INFO  [      main] c.d.d.s.SuperNodeStarter       - Starting SuperNodeStarter on be7fb931db0b with PID 9 (/supernode.jar started by root in /)\n2019-03-30 01:04:40.069 INFO  [      main] c.d.d.s.SuperNodeStarter       - No active profile set, falling back to default profiles: default\n2019-03-30 01:04:42.151 INFO  [      main] c.d.d.s.c.SupernodeProperties  - init local ip of supernode, use ip:192.168.0.75\n2019-03-30 01:04:42.253 INFO  [      main] c.d.d.s.c.SupernodeProperties  - cluster members: [{\"downloadPort\":8001,\"ip\":\"localhost\",\"registerPort\":8002}]\n2019-03-30 01:04:42.263 INFO  [      main] c.d.d.s.c.util.MonitorService  - available processors count is 4\n2019-03-30 01:04:42.272 ERROR [  Thread-2] c.d.d.s.c.util.MonitorService  - process fields:null error\njava.io.IOException: Cannot run program \"tsar\": error=2, No such file or directory\n\tat java.lang.ProcessBuilder.start(ProcessBuilder.java:1048)\n\tat java.lang.Runtime.exec(Runtime.java:620)\n\tat java.lang.Runtime.exec(Runtime.java:450)\n\tat java.lang.Runtime.exec(Runtime.java:347)\n\tat com.dragonflyoss.dragonfly.supernode.common.util.MonitorService$1.run(MonitorService.java:56)\n\tat java.lang.Thread.run(Thread.java:748)\nCaused by: java.io.IOException: error=2, No such file or directory\n\tat java.lang.UNIXProcess.forkAndExec(Native Method)\n\tat java.lang.UNIXProcess.<init>(UNIXProcess.java:247)\n\tat java.lang.ProcessImpl.start(ProcessImpl.java:134)\n\tat java.lang.ProcessBuilder.start(ProcessBuilder.java:1029)\n\t... 5 common frames omitted\n2019-03-30 01:04:43.507 INFO  [      main] c.d.d.s.SuperNodeStarter       - Started SuperNodeStarter in 3.906 seconds (JVM running for 4.59)\n2019-03-30 01:04:49.472 INFO  [  spring-1] c.d.d.s.s.p.PreheatServiceImpl - deleteExpiresPreheatTask, count:0\n```\n\n从 `2019-03-30 01:04:42.151 INFO  [      main] c.d.d.s.c.SupernodeProperties  - init local ip of supernode, use ip:192.168.0.75`  看，启动ip设置成功.\n\n注意，官方的镜像没改时区，默认是UTC时间，比北京东八区早8小时。\n\n<a name=\"2537d15e\"></a>\n### 登陆私有registry并推送镜像\n```bash\nroot@d7y-1:~# docker login https://registry.cn-qingdao.aliyuncs.com \nUsername: //你阿里云账号\nPassword: //你阿里云密码\nLogin Succeeded\nroot@d7y-1:~# docker pull nginx:alpine\nroot@d7y-1:~# docker tag nginx:alpine registry.cn-qingdao.aliyuncs.com/d7y-test/nginx:alpine\nroot@d7y-1:~# docker push registry.cn-qingdao.aliyuncs.com/d7y-test/nginx:alpine\nalpine: digest: sha256:857e6f195df0e9b497be0c7fad0f013126407aaeb71edcef66a24e8b990d94b3 size: 1153\n```\n\n<a name=\"5b37fed5\"></a>\n## dfdaemon 步骤\n<a name=\"fe0b02fa\"></a>\n### 安装dfdaemon\n在两台client节点分别执行如下命令\n```bash\nroot@d7y-2:~# cat <<EOD >/etc/dragonfly.conf\n[node]\naddress=192.168.0.75\nEOD\nroot@d7y-2:~# docker run --name dragonfly-dfclient --restart=always \\\n\t\t\t\t\t\t-d -p 65001:65001 -v /root/.small-dragonfly:/root/.small-dragonfly \\\n            -v /etc/dragonfly.conf:/etc/dragonfly.conf dragonflyoss/dfclient:v0.3.0 \\\n            --registry=https://registry.cn-qingdao.aliyuncs.com  --ratelimit 100M\nUnable to find image 'dragonflyoss/dfclient:v0.3.0' locally\nv0.3.0: Pulling from dragonflyoss/dfclient\n169185f82c45: Pull complete \nf58f64214283: Pull complete \nbd8f062dc2d2: Pull complete \nDigest: sha256:5bcabd5b34f4da0c2d489c8f99a23a401fb9ec57e54d4fa90457a93c5a85371f\nStatus: Downloaded newer image for dragonflyoss/dfclient:v0.3.0\nb491e90489a584119b82ca934cf2ae087abc136f7f9de3542e14fb12bc1c7512\n\nroot@d7y-2:~# cat <<EOD >/etc/docker/daemon.json\n{\n\"registry-mirrors\": [\"http://127.0.0.1:65001\"]\n}\nEOD\nroot@d7y-2:~# systemctl restart docker \n\nroot@d7y-2:~# docker ps\nCONTAINER ID        IMAGE                          COMMAND                  CREATED             STATUS              PORTS                      NAMES\nb491e90489a5        dragonflyoss/dfclient:v0.3.0   \"/dfclient/dfdaemo...\"   28 seconds ago      Up 4 seconds        0.0.0.0:65001->65001/tcp   dragonfly-dfclient\n\nroot@d7y-2:~/.small-dragonfly/logs# cat dfdaemon.log\n2019-03-30 01:18:21.331 INFO sign:1 : init...\n2019-03-30 01:18:21.331 INFO sign:1 : rotate log routine start...\n2019-03-30 01:18:21.338 INFO sign:1 : dfget version:\n2019-03-30 01:18:21.338 ERRO sign:1 : init properties failed:open /etc/dragonfly/dfdaemon.yml: no such file or directory\n2019-03-30 01:18:21.338 INFO sign:1 : init properties:{\"Registries\":[{\"Schema\":\"https\",\"Host\":\"registry.cn-qingdao.aliyuncs.com\",\"Certs\":null,\"Regx\":\"(^localhost$)|(^127.0.0.1$)|(^127.0.0.1$)\"}]}\n2019-03-30 01:18:21.338 INFO sign:1 : init finish\n2019-03-30 01:18:21.338 INFO sign:1 : start dfdaemon param: &{DfPath:/dfclient/dfget DFRepo:/root/.small-dragonfly/dfdaemon/data/ RateLimit:100M CallSystem:com_ops_dragonfly URLFilter:Signature&Expires&OSSAccessKeyId Notbs:true MaxProcs:4 Version:false Verbose:false HostIP:127.0.0.1 Port:65001 Registry:https://registry.cn-qingdao.aliyuncs.com DownRule: CertFile: KeyFile: TrustHosts:[] ConfigPath:/etc/dragonfly/dfdaemon.yml}\n2019-03-30 01:18:21.338 INFO sign:1 : launch dfdaemon http server on 127.0.0.1:65001\n```\n\n<a name=\"414f9e5b\"></a>\n### 登陆dfdaemon\n\n```bash\nroot@d7y-2:~# docker login http://127.0.0.1:65001\nUsername: //你阿里云账号\nPassword: //你阿里云密码\nLogin Succeeded\nroot@d7y-2:~# cat ~/.docker/config.json \n{\n\t\"auths\": {\n\t\t\"127.0.0.1:65001\": {\n\t\t\t\"auth\": \"zzxxxxxx=\"\n\t\t}\n\t}\n}\n\n```\n\n<a name=\"c6e04966\"></a>\n### pull 私有镜像\n\n```bash\nroot@d7y-2:~# docker pull 127.0.0.1:65001/d7y-test/nginx:alpine\nalpine: Pulling from d7y-test/nginx\n8e402f1a9c57: Pull complete \n56b0d9b69cc9: Pull complete \nb66c8bb200cc: Pull complete \n4ec77fc9c55f: Pull complete \nDigest: sha256:857e6f195df0e9b497be0c7fad0f013126407aaeb71edcef66a24e8b990d94b3\nStatus: Downloaded newer image for 127.0.0.1:65001/d7y-test/nginx:alpine\n```\n\n可以通过iftop 等命令，观察流量。\n\n\n<a name=\"0d98c747\"></a>\n## 其他\n<a name=\"21b8fa6d\"></a>\n### 排错\n如果有遇到其他问题，可以通过查看日志来获取更多信息。<br />dfdaemon log : /root/.small-dragonfly/logs/{dfclient.log,dfdaemon.log,dfserver.log}<br />supernode log: /home/admin/supernode/{app.log,data-gc.log,downloader.log,piece-hit.log,space-gc.log}\n\n<a name=\"269346af\"></a>\n### 公开和私有registry混用\n如果大量都是私有registry的话，可以在/etc/docker/daemon.json 中配置dfdaemon和加速器，如果是一半一半的话，那就干脆起两个dfdaemon就行了，一个--registry写私有的，一个--registry写公有的，然后也是配置 /etc/docker/daemon.json\n\n```bash\ncat /etc/docker/daemon.json \n{\n  \"registry-mirrors\": [\"http://127.0.0.1:65001\",\"https://xxx.mirror.aliyuncs.com\"],\n  \"dns\": [\"223.5.5.5\"]\n}\n```\n\n<a name=\"1075cc79\"></a>\n### 吐槽\n再次吐槽一下d7y的产品很好，解决了很大问题。但是这文档，真心不是给新手看的。从未见过如此坑多且深的文档。没见过哪家quick start 写的这么复杂。\n\n<a name=\"5eff9f05\"></a>\n### 鸣谢\n非常感谢钉钉群内的 d7y 的 contributor [太云-lowzj](https://github.com/lowzj) 耐心解答，从开始研究d7y开始，遇到的很多坑都是在   [太云-lowzj](https://github.com/lowzj) 帮助下蹚过去的。但是还是觉得，如果文档足够友好，肯定会减少群内被打扰的次数，进而节省自己时间的。<br />\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1553916020142-2062e206-a3e6-4df0-bb28-1b20632751a7.png#align=left&display=inline&height=153&name=image.png&originHeight=153&originWidth=436&size=12860&status=done&width=436)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。\n\n长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-03-30 10:17:00</p><p>tags: [docker,k8s,kubernetes,alibaba,Dragonfly]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote style=\"padding-left: 1em;\"><p>这是坚持技术写作计划（含翻译）的第13篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>书接上篇<a href=\"https://juejin.im/post/5c98a8e9f265da60e346fe04\" target=\"_blank\"> 012-P2P加速Docker镜像分发(阿里Dragonfly)</a> ,讲解了如何快速搭建Dragonfly,但是访问的是公开镜像，本文主要讲解如何下载私有镜像。</p><p><br /></p><p><span>&lt;!-- more --&gt;</span></p><p><br /></p><h2 id=\"12267079\">实验环境</h2><h3 id=\"65227369\">主机</h3><table class=\"lake-table\" style=\"width: 901px;\"><colgroup><col width=\"180\"></col><col width=\"180\"></col><col width=\"180\"></col><col width=\"180\"></col><col width=\"180\"></col></colgroup><tbody><tr><td>类型</td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>主机名</p></td><td>系统</td><td>ip</td><td>docker version</td></tr></tbody><tbody><tr><td>supernode</td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>d7y-1</p></td><td>Ubuntu Server 16.04.6 LTS X64</td><td>192.168.0.75</td><td>17.06.2<sub>ce-0</sub>ubuntu</td></tr><tr><td>clinet1</td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p><span>d7y-2</span></p></td><td>Ubuntu Server 16.04.6 LTS X64</td><td>192.168.0.76</td><td>17.06.2<sub>ce-0</sub>ubuntu</td></tr><tr><td>clinet2</td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p><span>d7y-3</span></p></td><td>Ubuntu Server 16.04.6 LTS X64</td><td>192.168.0.77</td><td>17.06.2<sub>ce-0</sub>ubuntu</td></tr></tbody></table><h3 id=\"592cc647\">私有registry</h3><p>本次以<a href=\"https://cr.console.aliyun.com/cn-qingdao/instances/repositories\" target=\"_blank\">阿里云私有镜像库</a>为例，可以自行开通。</p><p><br /></p><h3 id=\"c40e1e5e\">文档之坑</h3><p>官方文档比较简单,甚至带有误导性，下意识的以为应该在dfdaemon节点上配置auth信息，并且配的是真实的私有registry，如果真这么搞了，肯定被坑。（但是也能解释通，比较绕，dfdaemon本身就是一个伪装成registry，用来加速私有registry，那么登陆信息就应该换成dfdaemon ip，只是示例不太恰当而已，对初学者相当不友好倒是真的）</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1553913213390-3865b763-e270-4d25-8043-d140efc5faeb.png#align=left&amp;display=inline&amp;height=546&amp;name=image.png&amp;originHeight=546&amp;originWidth=922&amp;size=67579&amp;status=done&amp;width=922\" style=\"max-width: 600px; width: 922px;\" /></p><p><br /></p><h2 id=\"494e38bf\">supernode步骤</h2><p><br /></p><h3 id=\"71e91348\">安装supernode</h3><pre data-lang=\"bash\"><code>root@d7y-1:~# docker run --name dragonfly-supernode --restart=always \\\n              -d -p 8001:8001 -p 8002:8002 -v /data/dragonfly/supernode:/home/admin/supernode \\\n              registry.cn-hangzhou.aliyuncs.com/dragonflyoss/supernode:0.3.0 \\\n              -Dsupernode.advertiseIp=192.168.0.75\n\nroot@d7y-1:~# docker ps\nCONTAINER ID        IMAGE                                                            COMMAND                  CREATED              STATUS              PORTS                              NAMES\nbe7fb931db0b        registry.cn-hangzhou.aliyuncs.com/dragonflyoss/supernode:0.3.0   &quot;/bin/sh -c '/root...&quot;   About a minute ago   Up About a minute   0.0.0.0:8001-8002-&gt;8001-8002/tcp   dragonfly-supernode\n\nroot@d7y-1:/data/dragonfly/supernode/logs# cat app.log \n2019-03-30 01:04:40.065 INFO  [      main] c.d.d.s.SuperNodeStarter       - Starting SuperNodeStarter on be7fb931db0b with PID 9 (/supernode.jar started by root in /)\n2019-03-30 01:04:40.069 INFO  [      main] c.d.d.s.SuperNodeStarter       - No active profile set, falling back to default profiles: default\n2019-03-30 01:04:42.151 INFO  [      main] c.d.d.s.c.SupernodeProperties  - init local ip of supernode, use ip:192.168.0.75\n2019-03-30 01:04:42.253 INFO  [      main] c.d.d.s.c.SupernodeProperties  - cluster members: [{&quot;downloadPort&quot;:8001,&quot;ip&quot;:&quot;localhost&quot;,&quot;registerPort&quot;:8002}]\n2019-03-30 01:04:42.263 INFO  [      main] c.d.d.s.c.util.MonitorService  - available processors count is 4\n2019-03-30 01:04:42.272 ERROR [  Thread-2] c.d.d.s.c.util.MonitorService  - process fields:null error\njava.io.IOException: Cannot run program &quot;tsar&quot;: error=2, No such file or directory\n\tat java.lang.ProcessBuilder.start(ProcessBuilder.java:1048)\n\tat java.lang.Runtime.exec(Runtime.java:620)\n\tat java.lang.Runtime.exec(Runtime.java:450)\n\tat java.lang.Runtime.exec(Runtime.java:347)\n\tat com.dragonflyoss.dragonfly.supernode.common.util.MonitorService$1.run(MonitorService.java:56)\n\tat java.lang.Thread.run(Thread.java:748)\nCaused by: java.io.IOException: error=2, No such file or directory\n\tat java.lang.UNIXProcess.forkAndExec(Native Method)\n\tat java.lang.UNIXProcess.&lt;init&gt;(UNIXProcess.java:247)\n\tat java.lang.ProcessImpl.start(ProcessImpl.java:134)\n\tat java.lang.ProcessBuilder.start(ProcessBuilder.java:1029)\n\t... 5 common frames omitted\n2019-03-30 01:04:43.507 INFO  [      main] c.d.d.s.SuperNodeStarter       - Started SuperNodeStarter in 3.906 seconds (JVM running for 4.59)\n2019-03-30 01:04:49.472 INFO  [  spring-1] c.d.d.s.s.p.PreheatServiceImpl - deleteExpiresPreheatTask, count:0</code></pre><p><br /></p><p>从 <code>2019-03-30 01:04:42.151 INFO  [      main] c.d.d.s.c.SupernodeProperties  - init local ip of supernode, use ip:192.168.0.75</code>  看，启动ip设置成功.</p><p><br /></p><p>注意，官方的镜像没改时区，默认是UTC时间，比北京东八区早8小时。</p><p><br /></p><h3 id=\"2537d15e\">登陆私有registry并推送镜像</h3><pre data-lang=\"bash\"><code>root@d7y-1:~# docker login https://registry.cn-qingdao.aliyuncs.com \nUsername: //你阿里云账号\nPassword: //你阿里云密码\nLogin Succeeded\nroot@d7y-1:~# docker pull nginx:alpine\nroot@d7y-1:~# docker tag nginx:alpine registry.cn-qingdao.aliyuncs.com/d7y-test/nginx:alpine\nroot@d7y-1:~# docker push registry.cn-qingdao.aliyuncs.com/d7y-test/nginx:alpine\nalpine: digest: sha256:857e6f195df0e9b497be0c7fad0f013126407aaeb71edcef66a24e8b990d94b3 size: 1153</code></pre><p><br /></p><h2 id=\"5b37fed5\">dfdaemon 步骤</h2><h3 id=\"fe0b02fa\">安装dfdaemon</h3><p>在两台client节点分别执行如下命令</p><pre data-lang=\"bash\"><code>root@d7y-2:~# cat &lt;&lt;EOD &gt;/etc/dragonfly.conf\n[node]\naddress=192.168.0.75\nEOD\nroot@d7y-2:~# docker run --name dragonfly-dfclient --restart=always \\\n\t\t\t\t\t\t-d -p 65001:65001 -v /root/.small-dragonfly:/root/.small-dragonfly \\\n            -v /etc/dragonfly.conf:/etc/dragonfly.conf dragonflyoss/dfclient:v0.3.0 \\\n            --registry=https://registry.cn-qingdao.aliyuncs.com  --ratelimit 100M\nUnable to find image 'dragonflyoss/dfclient:v0.3.0' locally\nv0.3.0: Pulling from dragonflyoss/dfclient\n169185f82c45: Pull complete \nf58f64214283: Pull complete \nbd8f062dc2d2: Pull complete \nDigest: sha256:5bcabd5b34f4da0c2d489c8f99a23a401fb9ec57e54d4fa90457a93c5a85371f\nStatus: Downloaded newer image for dragonflyoss/dfclient:v0.3.0\nb491e90489a584119b82ca934cf2ae087abc136f7f9de3542e14fb12bc1c7512\n\nroot@d7y-2:~# cat &lt;&lt;EOD &gt;/etc/docker/daemon.json\n{\n&quot;registry-mirrors&quot;: [&quot;http://127.0.0.1:65001&quot;]\n}\nEOD\nroot@d7y-2:~# systemctl restart docker \n\nroot@d7y-2:~# docker ps\nCONTAINER ID        IMAGE                          COMMAND                  CREATED             STATUS              PORTS                      NAMES\nb491e90489a5        dragonflyoss/dfclient:v0.3.0   &quot;/dfclient/dfdaemo...&quot;   28 seconds ago      Up 4 seconds        0.0.0.0:65001-&gt;65001/tcp   dragonfly-dfclient\n\nroot@d7y-2:~/.small-dragonfly/logs# cat dfdaemon.log\n2019-03-30 01:18:21.331 INFO sign:1 : init...\n2019-03-30 01:18:21.331 INFO sign:1 : rotate log routine start...\n2019-03-30 01:18:21.338 INFO sign:1 : dfget version:\n2019-03-30 01:18:21.338 ERRO sign:1 : init properties failed:open /etc/dragonfly/dfdaemon.yml: no such file or directory\n2019-03-30 01:18:21.338 INFO sign:1 : init properties:{&quot;Registries&quot;:[{&quot;Schema&quot;:&quot;https&quot;,&quot;Host&quot;:&quot;registry.cn-qingdao.aliyuncs.com&quot;,&quot;Certs&quot;:null,&quot;Regx&quot;:&quot;(^localhost$)|(^127.0.0.1$)|(^127.0.0.1$)&quot;}]}\n2019-03-30 01:18:21.338 INFO sign:1 : init finish\n2019-03-30 01:18:21.338 INFO sign:1 : start dfdaemon param: &amp;{DfPath:/dfclient/dfget DFRepo:/root/.small-dragonfly/dfdaemon/data/ RateLimit:100M CallSystem:com_ops_dragonfly URLFilter:Signature&amp;Expires&amp;OSSAccessKeyId Notbs:true MaxProcs:4 Version:false Verbose:false HostIP:127.0.0.1 Port:65001 Registry:https://registry.cn-qingdao.aliyuncs.com DownRule: CertFile: KeyFile: TrustHosts:[] ConfigPath:/etc/dragonfly/dfdaemon.yml}\n2019-03-30 01:18:21.338 INFO sign:1 : launch dfdaemon http server on 127.0.0.1:65001</code></pre><p><br /></p><h3 id=\"414f9e5b\">登陆dfdaemon</h3><p><br /></p><pre data-lang=\"bash\"><code>root@d7y-2:~# docker login http://127.0.0.1:65001\nUsername: //你阿里云账号\nPassword: //你阿里云密码\nLogin Succeeded\nroot@d7y-2:~# cat ~/.docker/config.json \n{\n\t&quot;auths&quot;: {\n\t\t&quot;127.0.0.1:65001&quot;: {\n\t\t\t&quot;auth&quot;: &quot;zzxxxxxx=&quot;\n\t\t}\n\t}\n}\n</code></pre><p><br /></p><h3 id=\"c6e04966\">pull 私有镜像</h3><p><br /></p><pre data-lang=\"bash\"><code>root@d7y-2:~# docker pull 127.0.0.1:65001/d7y-test/nginx:alpine\nalpine: Pulling from d7y-test/nginx\n8e402f1a9c57: Pull complete \n56b0d9b69cc9: Pull complete \nb66c8bb200cc: Pull complete \n4ec77fc9c55f: Pull complete \nDigest: sha256:857e6f195df0e9b497be0c7fad0f013126407aaeb71edcef66a24e8b990d94b3\nStatus: Downloaded newer image for 127.0.0.1:65001/d7y-test/nginx:alpine</code></pre><p><br /></p><p>可以通过iftop 等命令，观察流量。</p><p><br /></p><p><br /></p><h2 id=\"0d98c747\">其他</h2><h3 id=\"21b8fa6d\">排错</h3><p>如果有遇到其他问题，可以通过查看日志来获取更多信息。</p><p>dfdaemon log : /root/.small-dragonfly/logs/{dfclient.log,dfdaemon.log,dfserver.log}</p><p>supernode log: /home/admin/supernode/{app.log,data-gc.log,downloader.log,piece-hit.log,space-gc.log}</p><p><br /></p><h3 id=\"269346af\">公开和私有registry混用</h3><p>如果大量都是私有registry的话，可以在/etc/docker/daemon.json 中配置dfdaemon和加速器，如果是一半一半的话，那就干脆起两个dfdaemon就行了，一个--registry写私有的，一个--registry写公有的，然后也是配置 <span>/etc/docker/daemon.json</span></p><p><br /></p><pre data-lang=\"bash\"><code>cat /etc/docker/daemon.json \n{\n  &quot;registry-mirrors&quot;: [&quot;http://127.0.0.1:65001&quot;,&quot;https://xxx.mirror.aliyuncs.com&quot;],\n  &quot;dns&quot;: [&quot;223.5.5.5&quot;]\n}</code></pre><p><br /></p><h3 id=\"1075cc79\">吐槽</h3><p>再次吐槽一下d7y的产品很好，解决了很大问题。但是这文档，真心不是给新手看的。从未见过如此坑多且深的文档。没见过哪家quick start 写的这么复杂。</p><p><br /></p><h3 id=\"5eff9f05\">鸣谢</h3><p>非常感谢钉钉群内的 d7y 的 contributor <a href=\"https://github.com/lowzj\" target=\"_blank\">太云-lowzj</a> 耐心解答，从开始研究d7y开始，遇到的很多坑都是在   <a href=\"https://github.com/lowzj\" target=\"_blank\">太云-lowzj</a> 帮助下蹚过去的。但是还是觉得，如果文档足够友好，肯定会减少群内被打扰的次数，进而节省自己时间的。</p><p><br /><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1553916020142-2062e206-a3e6-4df0-bb28-1b20632751a7.png#align=left&amp;display=inline&amp;height=153&amp;name=image.png&amp;originHeight=153&amp;originWidth=436&amp;size=12860&amp;status=done&amp;width=436\" style=\"max-width: 600px; width: 436px;\" /></p><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "body_lake": "<!doctype lake><p>date: 2019-03-30 10:17:00</p><p>tags: [docker,k8s,kubernetes,alibaba,Dragonfly]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote style=\"padding-left: 1em;\"><p>这是坚持技术写作计划（含翻译）的第13篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>书接上篇<a href=\"https://juejin.im/post/5c98a8e9f265da60e346fe04\" target=\"_blank\"> 012-P2P加速Docker镜像分发(阿里Dragonfly)</a> ,讲解了如何快速搭建Dragonfly,但是访问的是公开镜像，本文主要讲解如何下载私有镜像。</p><p><br /></p><p><span>&lt;!-- more --&gt;</span></p><p><br /></p><h2 id=\"12267079\">实验环境</h2><h3 id=\"65227369\">主机</h3><card type=\"block\" name=\"table\" value=\"data:%7B%22rows%22%3A4%2C%22cols%22%3A5%2C%22html%22%3A%22%3Ctable%20class%3D%5C%22lake-table%5C%22%20style%3D%5C%22width%3A%20901px%3B%5C%22%3E%3Ccolgroup%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22180%5C%22%20%2F%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22180%5C%22%20%2F%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22180%5C%22%20%2F%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22180%5C%22%20%2F%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22180%5C%22%20%2F%3E%3C%2Fcolgroup%3E%3Ctbody%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3E%E7%B1%BB%E5%9E%8B%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E%E4%B8%BB%E6%9C%BA%E5%90%8D%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%E7%B3%BB%E7%BB%9F%3C%2Ftd%3E%3Ctd%3Eip%3C%2Ftd%3E%3Ctd%3Edocker%20version%3C%2Ftd%3E%3C%2Ftr%3E%3C%2Ftbody%3E%3Ctbody%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3Esupernode%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3Ed7y-1%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3EUbuntu%20Server%2016.04.6%20LTS%20X64%3C%2Ftd%3E%3Ctd%3E192.168.0.75%3C%2Ftd%3E%3Ctd%3E17.06.2%3Csub%3Ece-0%3C%2Fsub%3Eubuntu%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3Eclinet1%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E%3Cspan%3Ed7y-2%3C%2Fspan%3E%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3EUbuntu%20Server%2016.04.6%20LTS%20X64%3C%2Ftd%3E%3Ctd%3E192.168.0.76%3C%2Ftd%3E%3Ctd%3E17.06.2%3Csub%3Ece-0%3C%2Fsub%3Eubuntu%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3Eclinet2%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E%3Cspan%3Ed7y-3%3C%2Fspan%3E%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3EUbuntu%20Server%2016.04.6%20LTS%20X64%3C%2Ftd%3E%3Ctd%3E192.168.0.77%3C%2Ftd%3E%3Ctd%3E17.06.2%3Csub%3Ece-0%3C%2Fsub%3Eubuntu%3C%2Ftd%3E%3C%2Ftr%3E%3C%2Ftbody%3E%3C%2Ftable%3E%22%2C%22id%22%3A%22314a8bbf%22%7D\"></card><h3 id=\"592cc647\">私有registry</h3><p>本次以<a href=\"https://cr.console.aliyun.com/cn-qingdao/instances/repositories\" target=\"_blank\">阿里云私有镜像库</a>为例，可以自行开通。</p><p><br /></p><h3 id=\"c40e1e5e\">文档之坑</h3><p>官方文档比较简单,甚至带有误导性，下意识的以为应该在dfdaemon节点上配置auth信息，并且配的是真实的私有registry，如果真这么搞了，肯定被坑。（但是也能解释通，比较绕，dfdaemon本身就是一个伪装成registry，用来加速私有registry，那么登陆信息就应该换成dfdaemon ip，只是示例不太恰当而已，对初学者相当不友好倒是真的）</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1553913213390-3865b763-e270-4d25-8043-d140efc5faeb.png%22%2C%22originWidth%22%3A922%2C%22originHeight%22%3A546%2C%22name%22%3A%22image.png%22%2C%22size%22%3A67579%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A922%2C%22height%22%3A546%7D\"></card></p><p><br /></p><h2 id=\"494e38bf\">supernode步骤</h2><p><br /></p><h3 id=\"71e91348\">安装supernode</h3><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22root%40d7y-1%3A~%23%20docker%20run%20--name%20dragonfly-supernode%20--restart%3Dalways%20%5C%5C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20-d%20-p%208001%3A8001%20-p%208002%3A8002%20-v%20%2Fdata%2Fdragonfly%2Fsupernode%3A%2Fhome%2Fadmin%2Fsupernode%20%5C%5C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20registry.cn-hangzhou.aliyuncs.com%2Fdragonflyoss%2Fsupernode%3A0.3.0%20%5C%5C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20-Dsupernode.advertiseIp%3D192.168.0.75%5Cn%5Cnroot%40d7y-1%3A~%23%20docker%20ps%5CnCONTAINER%20ID%20%20%20%20%20%20%20%20IMAGE%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20COMMAND%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20CREATED%20%20%20%20%20%20%20%20%20%20%20%20%20%20STATUS%20%20%20%20%20%20%20%20%20%20%20%20%20%20PORTS%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20NAMES%5Cnbe7fb931db0b%20%20%20%20%20%20%20%20registry.cn-hangzhou.aliyuncs.com%2Fdragonflyoss%2Fsupernode%3A0.3.0%20%20%20%5C%22%2Fbin%2Fsh%20-c%20'%2Froot...%5C%22%20%20%20About%20a%20minute%20ago%20%20%20Up%20About%20a%20minute%20%20%200.0.0.0%3A8001-8002-%3E8001-8002%2Ftcp%20%20%20dragonfly-supernode%5Cn%5Cnroot%40d7y-1%3A%2Fdata%2Fdragonfly%2Fsupernode%2Flogs%23%20cat%20app.log%20%5Cn2019-03-30%2001%3A04%3A40.065%20INFO%20%20%5B%20%20%20%20%20%20main%5D%20c.d.d.s.SuperNodeStarter%20%20%20%20%20%20%20-%20Starting%20SuperNodeStarter%20on%20be7fb931db0b%20with%20PID%209%20(%2Fsupernode.jar%20started%20by%20root%20in%20%2F)%5Cn2019-03-30%2001%3A04%3A40.069%20INFO%20%20%5B%20%20%20%20%20%20main%5D%20c.d.d.s.SuperNodeStarter%20%20%20%20%20%20%20-%20No%20active%20profile%20set%2C%20falling%20back%20to%20default%20profiles%3A%20default%5Cn2019-03-30%2001%3A04%3A42.151%20INFO%20%20%5B%20%20%20%20%20%20main%5D%20c.d.d.s.c.SupernodeProperties%20%20-%20init%20local%20ip%20of%20supernode%2C%20use%20ip%3A192.168.0.75%5Cn2019-03-30%2001%3A04%3A42.253%20INFO%20%20%5B%20%20%20%20%20%20main%5D%20c.d.d.s.c.SupernodeProperties%20%20-%20cluster%20members%3A%20%5B%7B%5C%22downloadPort%5C%22%3A8001%2C%5C%22ip%5C%22%3A%5C%22localhost%5C%22%2C%5C%22registerPort%5C%22%3A8002%7D%5D%5Cn2019-03-30%2001%3A04%3A42.263%20INFO%20%20%5B%20%20%20%20%20%20main%5D%20c.d.d.s.c.util.MonitorService%20%20-%20available%20processors%20count%20is%204%5Cn2019-03-30%2001%3A04%3A42.272%20ERROR%20%5B%20%20Thread-2%5D%20c.d.d.s.c.util.MonitorService%20%20-%20process%20fields%3Anull%20error%5Cnjava.io.IOException%3A%20Cannot%20run%20program%20%5C%22tsar%5C%22%3A%20error%3D2%2C%20No%20such%20file%20or%20directory%5Cn%5Ctat%20java.lang.ProcessBuilder.start(ProcessBuilder.java%3A1048)%5Cn%5Ctat%20java.lang.Runtime.exec(Runtime.java%3A620)%5Cn%5Ctat%20java.lang.Runtime.exec(Runtime.java%3A450)%5Cn%5Ctat%20java.lang.Runtime.exec(Runtime.java%3A347)%5Cn%5Ctat%20com.dragonflyoss.dragonfly.supernode.common.util.MonitorService%241.run(MonitorService.java%3A56)%5Cn%5Ctat%20java.lang.Thread.run(Thread.java%3A748)%5CnCaused%20by%3A%20java.io.IOException%3A%20error%3D2%2C%20No%20such%20file%20or%20directory%5Cn%5Ctat%20java.lang.UNIXProcess.forkAndExec(Native%20Method)%5Cn%5Ctat%20java.lang.UNIXProcess.%3Cinit%3E(UNIXProcess.java%3A247)%5Cn%5Ctat%20java.lang.ProcessImpl.start(ProcessImpl.java%3A134)%5Cn%5Ctat%20java.lang.ProcessBuilder.start(ProcessBuilder.java%3A1029)%5Cn%5Ct...%205%20common%20frames%20omitted%5Cn2019-03-30%2001%3A04%3A43.507%20INFO%20%20%5B%20%20%20%20%20%20main%5D%20c.d.d.s.SuperNodeStarter%20%20%20%20%20%20%20-%20Started%20SuperNodeStarter%20in%203.906%20seconds%20(JVM%20running%20for%204.59)%5Cn2019-03-30%2001%3A04%3A49.472%20INFO%20%20%5B%20%20spring-1%5D%20c.d.d.s.s.p.PreheatServiceImpl%20-%20deleteExpiresPreheatTask%2C%20count%3A0%22%2C%22id%22%3A%22A48Fh%22%7D\"></card><p><br /></p><p>从 <code>2019-03-30 01:04:42.151 INFO  [      main] c.d.d.s.c.SupernodeProperties  - init local ip of supernode, use ip:192.168.0.75</code>  看，启动ip设置成功.</p><p><br /></p><p>注意，官方的镜像没改时区，默认是UTC时间，比北京东八区早8小时。</p><p><br /></p><h3 id=\"2537d15e\">登陆私有registry并推送镜像</h3><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22root%40d7y-1%3A~%23%20docker%20login%20https%3A%2F%2Fregistry.cn-qingdao.aliyuncs.com%20%5CnUsername%3A%20%2F%2F%E4%BD%A0%E9%98%BF%E9%87%8C%E4%BA%91%E8%B4%A6%E5%8F%B7%5CnPassword%3A%20%2F%2F%E4%BD%A0%E9%98%BF%E9%87%8C%E4%BA%91%E5%AF%86%E7%A0%81%5CnLogin%20Succeeded%5Cnroot%40d7y-1%3A~%23%20docker%20pull%20nginx%3Aalpine%5Cnroot%40d7y-1%3A~%23%20docker%20tag%20nginx%3Aalpine%20registry.cn-qingdao.aliyuncs.com%2Fd7y-test%2Fnginx%3Aalpine%5Cnroot%40d7y-1%3A~%23%20docker%20push%20registry.cn-qingdao.aliyuncs.com%2Fd7y-test%2Fnginx%3Aalpine%5Cnalpine%3A%20digest%3A%20sha256%3A857e6f195df0e9b497be0c7fad0f013126407aaeb71edcef66a24e8b990d94b3%20size%3A%201153%22%2C%22id%22%3A%22tTXWT%22%7D\"></card><p><br /></p><h2 id=\"5b37fed5\">dfdaemon 步骤</h2><h3 id=\"fe0b02fa\">安装dfdaemon</h3><p>在两台client节点分别执行如下命令</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22root%40d7y-2%3A~%23%20cat%20%3C%3CEOD%20%3E%2Fetc%2Fdragonfly.conf%5Cn%5Bnode%5D%5Cnaddress%3D192.168.0.75%5CnEOD%5Cnroot%40d7y-2%3A~%23%20docker%20run%20--name%20dragonfly-dfclient%20--restart%3Dalways%20%5C%5C%5Cn%5Ct%5Ct%5Ct%5Ct%5Ct%5Ct-d%20-p%2065001%3A65001%20-v%20%2Froot%2F.small-dragonfly%3A%2Froot%2F.small-dragonfly%20%5C%5C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20-v%20%2Fetc%2Fdragonfly.conf%3A%2Fetc%2Fdragonfly.conf%20dragonflyoss%2Fdfclient%3Av0.3.0%20%5C%5C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20--registry%3Dhttps%3A%2F%2Fregistry.cn-qingdao.aliyuncs.com%20%20--ratelimit%20100M%5CnUnable%20to%20find%20image%20'dragonflyoss%2Fdfclient%3Av0.3.0'%20locally%5Cnv0.3.0%3A%20Pulling%20from%20dragonflyoss%2Fdfclient%5Cn169185f82c45%3A%20Pull%20complete%20%5Cnf58f64214283%3A%20Pull%20complete%20%5Cnbd8f062dc2d2%3A%20Pull%20complete%20%5CnDigest%3A%20sha256%3A5bcabd5b34f4da0c2d489c8f99a23a401fb9ec57e54d4fa90457a93c5a85371f%5CnStatus%3A%20Downloaded%20newer%20image%20for%20dragonflyoss%2Fdfclient%3Av0.3.0%5Cnb491e90489a584119b82ca934cf2ae087abc136f7f9de3542e14fb12bc1c7512%5Cn%5Cnroot%40d7y-2%3A~%23%20cat%20%3C%3CEOD%20%3E%2Fetc%2Fdocker%2Fdaemon.json%5Cn%7B%5Cn%5C%22registry-mirrors%5C%22%3A%20%5B%5C%22http%3A%2F%2F127.0.0.1%3A65001%5C%22%5D%5Cn%7D%5CnEOD%5Cnroot%40d7y-2%3A~%23%20systemctl%20restart%20docker%20%5Cn%5Cnroot%40d7y-2%3A~%23%20docker%20ps%5CnCONTAINER%20ID%20%20%20%20%20%20%20%20IMAGE%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20COMMAND%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20CREATED%20%20%20%20%20%20%20%20%20%20%20%20%20STATUS%20%20%20%20%20%20%20%20%20%20%20%20%20%20PORTS%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20NAMES%5Cnb491e90489a5%20%20%20%20%20%20%20%20dragonflyoss%2Fdfclient%3Av0.3.0%20%20%20%5C%22%2Fdfclient%2Fdfdaemo...%5C%22%20%20%2028%20seconds%20ago%20%20%20%20%20%20Up%204%20seconds%20%20%20%20%20%20%20%200.0.0.0%3A65001-%3E65001%2Ftcp%20%20%20dragonfly-dfclient%5Cn%5Cnroot%40d7y-2%3A~%2F.small-dragonfly%2Flogs%23%20cat%20dfdaemon.log%5Cn2019-03-30%2001%3A18%3A21.331%20INFO%20sign%3A1%20%3A%20init...%5Cn2019-03-30%2001%3A18%3A21.331%20INFO%20sign%3A1%20%3A%20rotate%20log%20routine%20start...%5Cn2019-03-30%2001%3A18%3A21.338%20INFO%20sign%3A1%20%3A%20dfget%20version%3A%5Cn2019-03-30%2001%3A18%3A21.338%20ERRO%20sign%3A1%20%3A%20init%20properties%20failed%3Aopen%20%2Fetc%2Fdragonfly%2Fdfdaemon.yml%3A%20no%20such%20file%20or%20directory%5Cn2019-03-30%2001%3A18%3A21.338%20INFO%20sign%3A1%20%3A%20init%20properties%3A%7B%5C%22Registries%5C%22%3A%5B%7B%5C%22Schema%5C%22%3A%5C%22https%5C%22%2C%5C%22Host%5C%22%3A%5C%22registry.cn-qingdao.aliyuncs.com%5C%22%2C%5C%22Certs%5C%22%3Anull%2C%5C%22Regx%5C%22%3A%5C%22(%5Elocalhost%24)%7C(%5E127.0.0.1%24)%7C(%5E127.0.0.1%24)%5C%22%7D%5D%7D%5Cn2019-03-30%2001%3A18%3A21.338%20INFO%20sign%3A1%20%3A%20init%20finish%5Cn2019-03-30%2001%3A18%3A21.338%20INFO%20sign%3A1%20%3A%20start%20dfdaemon%20param%3A%20%26%7BDfPath%3A%2Fdfclient%2Fdfget%20DFRepo%3A%2Froot%2F.small-dragonfly%2Fdfdaemon%2Fdata%2F%20RateLimit%3A100M%20CallSystem%3Acom_ops_dragonfly%20URLFilter%3ASignature%26Expires%26OSSAccessKeyId%20Notbs%3Atrue%20MaxProcs%3A4%20Version%3Afalse%20Verbose%3Afalse%20HostIP%3A127.0.0.1%20Port%3A65001%20Registry%3Ahttps%3A%2F%2Fregistry.cn-qingdao.aliyuncs.com%20DownRule%3A%20CertFile%3A%20KeyFile%3A%20TrustHosts%3A%5B%5D%20ConfigPath%3A%2Fetc%2Fdragonfly%2Fdfdaemon.yml%7D%5Cn2019-03-30%2001%3A18%3A21.338%20INFO%20sign%3A1%20%3A%20launch%20dfdaemon%20http%20server%20on%20127.0.0.1%3A65001%22%2C%22id%22%3A%22F3tAg%22%7D\"></card><p><br /></p><h3 id=\"414f9e5b\">登陆dfdaemon</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22root%40d7y-2%3A~%23%20docker%20login%20http%3A%2F%2F127.0.0.1%3A65001%5CnUsername%3A%20%2F%2F%E4%BD%A0%E9%98%BF%E9%87%8C%E4%BA%91%E8%B4%A6%E5%8F%B7%5CnPassword%3A%20%2F%2F%E4%BD%A0%E9%98%BF%E9%87%8C%E4%BA%91%E5%AF%86%E7%A0%81%5CnLogin%20Succeeded%5Cnroot%40d7y-2%3A~%23%20cat%20~%2F.docker%2Fconfig.json%20%5Cn%7B%5Cn%5Ct%5C%22auths%5C%22%3A%20%7B%5Cn%5Ct%5Ct%5C%22127.0.0.1%3A65001%5C%22%3A%20%7B%5Cn%5Ct%5Ct%5Ct%5C%22auth%5C%22%3A%20%5C%22zzxxxxxx%3D%5C%22%5Cn%5Ct%5Ct%7D%5Cn%5Ct%7D%5Cn%7D%5Cn%22%2C%22id%22%3A%227TQZz%22%7D\"></card><p><br /></p><h3 id=\"c6e04966\">pull 私有镜像</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22root%40d7y-2%3A~%23%20docker%20pull%20127.0.0.1%3A65001%2Fd7y-test%2Fnginx%3Aalpine%5Cnalpine%3A%20Pulling%20from%20d7y-test%2Fnginx%5Cn8e402f1a9c57%3A%20Pull%20complete%20%5Cn56b0d9b69cc9%3A%20Pull%20complete%20%5Cnb66c8bb200cc%3A%20Pull%20complete%20%5Cn4ec77fc9c55f%3A%20Pull%20complete%20%5CnDigest%3A%20sha256%3A857e6f195df0e9b497be0c7fad0f013126407aaeb71edcef66a24e8b990d94b3%5CnStatus%3A%20Downloaded%20newer%20image%20for%20127.0.0.1%3A65001%2Fd7y-test%2Fnginx%3Aalpine%22%2C%22id%22%3A%22rRxJM%22%7D\"></card><p><br /></p><p>可以通过iftop 等命令，观察流量。</p><p><br /></p><p><br /></p><h2 id=\"0d98c747\">其他</h2><h3 id=\"21b8fa6d\">排错</h3><p>如果有遇到其他问题，可以通过查看日志来获取更多信息。</p><p>dfdaemon log : /root/.small-dragonfly/logs/{dfclient.log,dfdaemon.log,dfserver.log}</p><p>supernode log: /home/admin/supernode/{app.log,data-gc.log,downloader.log,piece-hit.log,space-gc.log}</p><p><br /></p><h3 id=\"269346af\">公开和私有registry混用</h3><p>如果大量都是私有registry的话，可以在/etc/docker/daemon.json 中配置dfdaemon和加速器，如果是一半一半的话，那就干脆起两个dfdaemon就行了，一个--registry写私有的，一个--registry写公有的，然后也是配置 <span>/etc/docker/daemon.json</span></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22cat%20%2Fetc%2Fdocker%2Fdaemon.json%20%5Cn%7B%5Cn%20%20%5C%22registry-mirrors%5C%22%3A%20%5B%5C%22http%3A%2F%2F127.0.0.1%3A65001%5C%22%2C%5C%22https%3A%2F%2Fxxx.mirror.aliyuncs.com%5C%22%5D%2C%5Cn%20%20%5C%22dns%5C%22%3A%20%5B%5C%22223.5.5.5%5C%22%5D%5Cn%7D%22%2C%22id%22%3A%22dE8xc%22%7D\"></card><p><br /></p><h3 id=\"1075cc79\">吐槽</h3><p>再次吐槽一下d7y的产品很好，解决了很大问题。但是这文档，真心不是给新手看的。从未见过如此坑多且深的文档。没见过哪家quick start 写的这么复杂。</p><p><br /></p><h3 id=\"5eff9f05\">鸣谢</h3><p>非常感谢钉钉群内的 d7y 的 contributor <a href=\"https://github.com/lowzj\" target=\"_blank\">太云-lowzj</a> 耐心解答，从开始研究d7y开始，遇到的很多坑都是在   <a href=\"https://github.com/lowzj\" target=\"_blank\">太云-lowzj</a> 帮助下蹚过去的。但是还是觉得，如果文档足够友好，肯定会减少群内被打扰的次数，进而节省自己时间的。</p><p><br /><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1553916020142-2062e206-a3e6-4df0-bb28-1b20632751a7.png%22%2C%22originWidth%22%3A436%2C%22originHeight%22%3A153%2C%22name%22%3A%22image.png%22%2C%22size%22%3A12860%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A436%2C%22height%22%3A153%7D\"></card></p><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /><cursor /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-07-08T04:01:32.000Z",
    "deleted_at": null,
    "created_at": "2019-03-30T02:16:54.000Z",
    "updated_at": "2019-07-08T04:01:32.000Z",
    "published_at": "2019-07-08T04:01:32.000Z",
    "first_published_at": "2019-03-30T03:15:13.000Z",
    "word_count": 1763,
    "cover": "",
    "description": "date: 2019-03-30 10:17:00tags: [docker,k8s,kubernetes,alibaba,Dragonfly]categories: 运维---这是坚持技术写作计划（含翻译）的第13篇，定个小目标999，每周最少2篇。书接上篇 012-P2P加速Docker镜...",
    "custom_description": "书接上篇 012-P2P加速Docker镜像分发(阿里Dragonfly) ,讲解了如何快速搭建Dragonfly,但是访问的是公开镜像，本文主要讲解如何下载私有镜像。",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1424559,
    "slug": "dragonfly",
    "title": "012-P2P加速Docker镜像分发(阿里Dragonfly)",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-03-25 16:58:00<br />tags: [docker,k8s,kubernetes,alibaba,Dragonfly]<br />categories: 运维<br />---\n\n> 这是坚持技术写作计划（含翻译）的第12篇，定个小目标999，每周最少2篇。\n\n\n吐槽一下，最近有点懒，居然欠了4篇，后续会慢慢补上。\n\n<a name=\"61a3ec66\"></a>\n## 介绍\n如果说，微服务和容器是最佳拍档，那么模块多实例是肯定少不了。<br />假如没有使用类似 [Google jib](https://github.com/GoogleContainerTools/jib) 等手段进行镜像分层（利用镜像缓存），势必会造成\n\n- 带宽浪费：尤其是公网带宽，如果是自建harbor，那么会容易导致单节点网卡被打满，如果用了harbor联邦，又会导致数据同步等运维问题。\n- 集群拉起慢：镜像下载慢，必然会导致服务拉起慢。\n\n关于Google jib可以参见我另外一篇 [加速和简化构建Docker(基于Google jib)](https://juejin.im/post/5c60c021f265da2dd37bf85b) ，本文只介绍 Dragonfly + dfdaemon \n\nDragonfly是阿里巴巴自研并开源的一款基于P2P协议的文件分发系统。除了使用 dfget 进行文件下载外，还支持dfdaemon 进行docker镜像下载。\n\n关于Dragonfly的镜像分发的原理性说明，可参见 [直击阿里双11神秘技术：PB级大规模文件分发系统“蜻蜓”](https://yq.aliyun.com/articles/244897) ，文中介绍很详细，此处不多说明。\n\n<!-- more -->\n\n<a name=\"12267079\"></a>\n### 实验环境\n\n| 类型 | 系统 | ip | docker version |\n| --- | --- | --- | --- |\n| supernode | Ubuntu Server 16.04.6 LTS X64 | 192.168.0.44 | 17.06.2~ce-0~ubuntu |\n| clinet1 | Ubuntu Server 16.04.6 LTS X64 | 192.168.0.40 | 17.06.2~ce-0~ubuntu |\n| clinet2 | Ubuntu Server 16.04.6 LTS X64 | 192.168.0.45 | 17.06.2~ce-0~ubuntu |\n\n\n**注意：** <br />如果是实验目的，建议用Vmware，并且在关键操作时备份快照（比如，刚装完环境），这样能够及时，干净的还原现场，节省每次重装系统导致的时间浪费\n\n安装\n\n吐槽一下Dragonfly的文档，简直让人不知所以。结合issues + 钉钉群内请教，遂整理出最简使用文档。\n<a name=\"supernode\"></a>\n### supernode\n可选：给supernode增加docker加速器，可以参考 https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors ，如果不需要，可以去掉。\n```bash\n$ cat <<EOD >/etc/docker/daemon.json\n{\n\"registry-mirrors\": [\"https://xxxx.mirror.aliyuncs.com\"] \n}\nEOD\n$ systemctl restart docker \n```\n\n```bash\n$ docker run --name dragonfly-supernode --restart=always -d -p 8001:8001 -p 8002:8002 -v /data/dragonfly/supernode:/home/admin/supernode registry.cn-hangzhou.aliyuncs.com/dragonflyoss/supernode:0.3.0 -Dsupernode.advertiseIp=192.168.0.44\n```\n\n**说明：**\n\n- --restart=always 在容器退出时，自动重启容器，防止异常kill或者oom导致的异常退出\n- registry.cn-hangzhou.aliyuncs.com/dragonflyoss/supernode:0.3.0 dragonfly的supernode目前没有docker hub镜像，只能用阿里云的\n- -v /data/dragonfly/supernode:/home/admin/supernode 将supernode的data dir挂载到宿主机上\n- -Dsupernode.advertiseIp=192.168.0.44 设置clinet可以访问的supernode ip,这是一个大坑。如果不设置，有可能会导致client无法连接supernode，届时，docker pull会走clinet的网络，从真实的registry直接下载镜像\n\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1553506862485-080cc522-2d28-47b9-8d6b-3db34db173f3.png#align=left&display=inline&height=624&name=image.png&originHeight=624&originWidth=725&size=90024&status=done&width=725)\n<a name=\"752efc6a\"></a>\n### dfdaemon \n\n```bash\n$ cat <<EOD >/etc/dragonfly.conf\n[node]\naddress=192.168.0.44\nEOD\n$ docker run --name dragonfly-dfclient --restart=always -d -p 65001:65001 -v /root/.small-dragonfly:/root/.small-dragonfly -v /etc/dragonfly.conf:/etc/dragonfly.conf dragonflyoss/dfclient:v0.3.0 --registry=https://xxx.mirror.aliyuncs.com  --ratelimit 100M\n$ cat <<EOD >/etc/docker/daemon.json\n{\n\"registry-mirrors\": [\"http://127.0.0.1:65001\"]\n}\nEOD\n$ systemctl restart docker \n```\n\n**说明：** \n\n- 在 /etc/dragonfly.conf 中配置client可以访问的supernode的ip地址，但是，目前官方没有做HA，supernode没法组集群，撑死算是联邦，不能共享文件信息，而且最坑的是，快速开始里，中英文均未提供需要配置此文件，而是在 [Downloading Files with Dragonfly](https://d7y.io/en-us/docs/userguide/download_files.html) 等有所提及（我都是被坑完后，用关键词在d7y的org里搜索，类似知道答案后，找出处 手动[捂脸]）\n- -v /root/.small-dragonfly:/root/.small-dragonfly ,将容器中的关键目录挂载到宿主机上，防止重启或者镜像升级时，数据丢失\n- --registry=https://xxx.mirror.aliyuncs.com 从何处下载镜像，可以写harbor地址，也可以写加速器地址。默认是 [https://index.docker.io](https://index.docker.io) ，但是，因为国内网络原因，会导致大概率性失败。很灵异。而官方文档是写的 `--registry https://xxx.xx.x` 不能算是坑，但是，对于docker不熟悉的，往往会不知能不能用加速器。\n- --ratelimit 100M 是限速，默认是20M ,这肯定不算坑哈，这是正常特性，在  [dfdaemon#Options](https://d7y.io/zh-cn/docs/quickstart.html) 有说明，但是，文档是有误的 `-ratelimit` 而实际是 `--ratelimit` ,如果不改此参数，会发现，下载很慢。\n- 修改/etc/docker/daemon.json 是为了让docker engine走 dfdaemon\n- systemctl restart docker 是为了让daemon生效\n\n<a name=\"db06c78d\"></a>\n## 测试\n<a name=\"4a76b96e\"></a>\n### 大文件测试\n\n```bash\n$ docker pull anjia0532/kubeflow-images-public.tensorflow-1.6.0-notebook-gpu:v20180604-b3733835\n```\n可以通过 `iftop` 等软件，查看带宽使用情况判断是否生效，也可以通过查看日志来判断。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1553508378817-cde03b19-e0e2-4d03-a233-b9090cc0db2f.png#align=left&display=inline&height=821&name=image.png&originHeight=821&originWidth=1911&size=46951&status=done&width=1911)<br />但是会经常性的出现 `error pulling image configuration: received unexpected HTTP status: 502 Bad Gateway` \n\n<a name=\"9415a826\"></a>\n## 最后\n需要结合实际情况，配置相关参数，比如，文件失效时间，用来平衡文件有效期及磁盘使用量。\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [直击阿里双11神秘技术：PB级大规模文件分发系统“蜻蜓”](https://yq.aliyun.com/articles/244897)\n- [深度解读阿里巴巴云原生镜像分发系统 Dragonfly](https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&mid=2247484045&idx=1&sn=2e4586171930b8d3080eadd55be09723)\n- [Dragonfly Quick Start](https://d7y.io/en-us/docs/quickstart.html)\n- [加速和简化构建Docker(基于Google jib)](https://juejin.im/post/5c60c021f265da2dd37bf85b)\n- [浙江移动容器云基于 Dragonfly 的统一文件分发平台生产实践](https://d7y.io/zh-cn/blog/china-mobile-practice.html)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。\n\n长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-03-25 16:58:00</p><p>tags: [docker,k8s,kubernetes,alibaba,Dragonfly]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote style=\"padding-left: 1em;\"><p>这是坚持技术写作计划（含翻译）的第12篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>吐槽一下，最近有点懒，居然欠了4篇，后续会慢慢补上。</p><p><br /></p><h2 id=\"61a3ec66\">介绍</h2><p>如果说，微服务和容器是最佳拍档，那么模块多实例是肯定少不了。</p><p>假如没有使用类似 <a href=\"https://github.com/GoogleContainerTools/jib\" target=\"_blank\">Google jib</a> 等手段进行镜像分层（利用镜像缓存），势必会造成</p><ul><li>带宽浪费：尤其是公网带宽，如果是自建harbor，那么会容易导致单节点网卡被打满，如果用了harbor联邦，又会导致数据同步等运维问题。</li><li>集群拉起慢：镜像下载慢，必然会导致服务拉起慢。</li></ul><p><br /></p><p>关于Google jib可以参见我另外一篇 <a href=\"https://juejin.im/post/5c60c021f265da2dd37bf85b\" target=\"_blank\">加速和简化构建Docker(基于Google jib)</a> ，本文只介绍 <span>Dragonfly + </span><span>dfdaemon </span></p><p><br /></p><p>Dragonfly是阿里巴巴自研并开源的一款基于P2P协议的文件分发系统。除了使用 dfget 进行文件下载外，还支持dfdaemon 进行docker镜像下载。</p><p><br /></p><p><span>关于Dragonfly的镜像分发的原理性说明，可参见 </span><a href=\"https://yq.aliyun.com/articles/244897\" target=\"_blank\">直击阿里双11神秘技术：PB级大规模文件分发系统“蜻蜓”</a><span> ，文中介绍很详细，此处不多说明。</span></p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h3 id=\"12267079\">实验环境</h3><p><br /></p><table class=\"lake-table\" style=\"width: 961px;\"><colgroup><col width=\"240\"></col><col width=\"240\"></col><col width=\"240\"></col><col width=\"240\"></col></colgroup><tbody><tr><td>类型</td><td>系统</td><td>ip</td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>docker version</p></td></tr></tbody><tbody><tr><td>supernode</td><td>Ubuntu Server 16.04.6 LTS X64</td><td>192.168.0.44</td><td rowspan=\"1\" style=\"background-color: #FFFFFF;\"><p>17.06.2~ce-0~ubuntu</p></td></tr><tr><td>clinet1</td><td><p><span>Ubuntu Server 16.04.6 LTS X64</span></p></td><td>192.168.0.40</td><td rowspan=\"1\" colspan=\"1\" style=\"background-color: #FFFFFF;\">17.06.2~ce-0~ubuntu</td></tr><tr><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p>clinet2</p></td><td colspan=\"1\" style=\"background-color: #FFFFFF;\"><p><span>Ubuntu Server 16.04.6 LTS X64</span></p></td><td colspan=\"1\" rowspan=\"1\" style=\"background-color: #FFFFFF;\"><span style=\"color: #262626; background-color: #FFFFFF;\">192.168.0.45</span></td><td rowspan=\"1\" colspan=\"1\" style=\"background-color: #FFFFFF;\">17.06.2~ce-0~ubuntu</td></tr></tbody></table><p><br /></p><p><strong>注意：</strong> </p><p>如果是实验目的，建议用Vmware，并且在关键操作时备份快照（比如，刚装完环境），这样能够及时，干净的还原现场，节省每次重装系统导致的时间浪费</p><p><br /></p><p><span>安装</span></p><p><span><br /></span></p><p>吐槽一下Dragonfly的文档，简直让人不知所以。结合issues + 钉钉群内请教，遂整理出最简使用文档。</p><h3 id=\"supernode\">supernode</h3><p>可选：给supernode增加docker加速器<span>，可以参考 https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors ，如果不需要，可以去掉。</span></p><pre data-lang=\"bash\"><code>$ cat &lt;&lt;EOD &gt;/etc/docker/daemon.json\n{\n&quot;registry-mirrors&quot;: [&quot;https://xxxx.mirror.aliyuncs.com&quot;] \n}\nEOD\n$ systemctl restart docker </code></pre><p><br /></p><pre data-lang=\"bash\"><code>$ docker run --name dragonfly-supernode --restart=always -d -p 8001:8001 -p 8002:8002 -v /data/dragonfly/supernode:/home/admin/supernode registry.cn-hangzhou.aliyuncs.com/dragonflyoss/supernode:0.3.0 -Dsupernode.advertiseIp=192.168.0.44</code></pre><p><br /></p><p><strong>说明：</strong></p><ul><li>--restart=always 在容器退出时，自动重启容器，防止异常kill或者oom导致的异常退出</li><li>registry.cn-hangzhou.aliyuncs.com/dragonflyoss/supernode:0.3.0 dragonfly的supernode目前没有docker hub镜像，只能用阿里云的</li><li>-v /data/dragonfly/supernode:/home/admin/supernode 将supernode的data dir挂载到宿主机上</li><li>-Dsupernode.advertiseIp=192.168.0.44 设置clinet可以访问的supernode ip,这是一个大坑。如果不设置，有可能会导致client无法连接supernode，届时，docker pull会走clinet的网络，从真实的registry直接下载镜像</li></ul><p><br /><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1553506862485-080cc522-2d28-47b9-8d6b-3db34db173f3.png#align=left&amp;display=inline&amp;height=624&amp;name=image.png&amp;originHeight=624&amp;originWidth=725&amp;size=90024&amp;status=done&amp;width=725\" style=\"max-width: 600px; width: 725px;\" /></p><h3 id=\"752efc6a\"><span>dfdaemon </span></h3><p><br /></p><pre data-lang=\"bash\"><code>$ cat &lt;&lt;EOD &gt;/etc/dragonfly.conf\n[node]\naddress=192.168.0.44\nEOD\n$ docker run --name dragonfly-dfclient --restart=always -d -p 65001:65001 -v /root/.small-dragonfly:/root/.small-dragonfly -v /etc/dragonfly.conf:/etc/dragonfly.conf dragonflyoss/dfclient:v0.3.0 --registry=https://xxx.mirror.aliyuncs.com  --ratelimit 100M\n$ cat &lt;&lt;EOD &gt;/etc/docker/daemon.json\n{\n&quot;registry-mirrors&quot;: [&quot;http://127.0.0.1:65001&quot;]\n}\nEOD\n$ systemctl restart docker </code></pre><p><br /></p><p><strong>说明：</strong> </p><ul><li>在 /etc/dragonfly.conf 中配置client可以访问的supernode的ip地址，但是，目前官方没有做HA，supernode没法组集群，撑死算是联邦，不能共享文件信息，而且最坑的是，快速开始里，中英文均未提供需要配置此文件，而是在 <a href=\"https://d7y.io/en-us/docs/userguide/download_files.html\" target=\"_blank\">Downloading Files with Dragonfly</a> 等有所提及（我都是被坑完后，用关键词在d7y的org里搜索，类似知道答案后，找出处 手动[捂脸]）</li><li>-v /root/.small-dragonfly:/root/.small-dragonfly ,将容器中的关键目录挂载到宿主机上，防止重启或者镜像升级时，数据丢失</li><li>--registry=https://xxx.mirror.aliyuncs.com 从何处下载镜像，可以写harbor地址，也可以写加速器地址。默认是 <a href=\"https://index.docker.io\" target=\"_blank\">https://index.docker.io</a> ，但是，因为国内网络原因，会导致大概率性失败。很灵异。而官方文档是写的 <code>--registry https://xxx.xx.x</code> 不能算是坑，但是，对于docker不熟悉的，往往会不知能不能用加速器。</li><li>--ratelimit 100M 是限速，默认是20M ,这肯定不算坑哈，这是正常特性，在  <a href=\"https://d7y.io/zh-cn/docs/quickstart.html\" target=\"_blank\">dfdaemon#Options</a> 有说明，但是，文档是有误的 <code>-ratelimit</code> 而实际是 <code>--ratelimit</code> ,如果不改此参数，会发现，下载很慢。</li><li>修改/etc/docker/daemon.json 是为了让docker engine走 dfdaemon</li><li>systemctl restart docker 是为了让daemon生效</li></ul><p><br /></p><h2 id=\"db06c78d\">测试</h2><h3 id=\"4a76b96e\">大文件测试</h3><p><br /></p><pre data-lang=\"bash\"><code>$ docker pull anjia0532/kubeflow-images-public.tensorflow-1.6.0-notebook-gpu:v20180604-b3733835</code></pre><p>可以通过 <code>iftop</code> 等软件，查看带宽使用情况判断是否生效，也可以通过查看日志来判断。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1553508378817-cde03b19-e0e2-4d03-a233-b9090cc0db2f.png#align=left&amp;display=inline&amp;height=821&amp;name=image.png&amp;originHeight=821&amp;originWidth=1911&amp;size=46951&amp;status=done&amp;width=1911\" style=\"max-width: 600px; width: 1911px;\" /></p><p>但是会经常性的出现 <code>error pulling image configuration: received unexpected HTTP status: 502 Bad Gateway</code> </p><p><br /></p><h2 id=\"9415a826\">最后</h2><p>需要结合实际情况，配置相关参数，比如，文件失效时间，用来平衡文件有效期及磁盘使用量。</p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://yq.aliyun.com/articles/244897\" target=\"_blank\">直击阿里双11神秘技术：PB级大规模文件分发系统“蜻蜓”</a></li><li><a href=\"https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247484045&amp;idx=1&amp;sn=2e4586171930b8d3080eadd55be09723\" target=\"_blank\">深度解读阿里巴巴云原生镜像分发系统 Dragonfly</a></li><li><a href=\"https://d7y.io/en-us/docs/quickstart.html\" target=\"_blank\">Dragonfly Quick Start</a></li><li><a href=\"https://juejin.im/post/5c60c021f265da2dd37bf85b\" target=\"_blank\">加速和简化构建Docker(基于Google jib)</a></li><li><a href=\"https://d7y.io/zh-cn/blog/china-mobile-practice.html\" target=\"_blank\">浙江移动容器云基于 Dragonfly 的统一文件分发平台生产实践</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "body_lake": "<!doctype lake><p>date: 2019-03-25 16:58:00</p><p>tags: [docker,k8s,kubernetes,alibaba,Dragonfly]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote style=\"padding-left: 1em;\"><p>这是坚持技术写作计划（含翻译）的第12篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>吐槽一下，最近有点懒，居然欠了4篇，后续会慢慢补上。</p><p><br /></p><h2 id=\"61a3ec66\">介绍</h2><p>如果说，微服务和容器是最佳拍档，那么模块多实例是肯定少不了。</p><p>假如没有使用类似 <a href=\"https://github.com/GoogleContainerTools/jib\" target=\"_blank\">Google jib</a> 等手段进行镜像分层（利用镜像缓存），势必会造成</p><ul><li>带宽浪费：尤其是公网带宽，如果是自建harbor，那么会容易导致单节点网卡被打满，如果用了harbor联邦，又会导致数据同步等运维问题。</li><li>集群拉起慢：镜像下载慢，必然会导致服务拉起慢。</li></ul><p><br /></p><p>关于Google jib可以参见我另外一篇 <a href=\"https://juejin.im/post/5c60c021f265da2dd37bf85b\" target=\"_blank\">加速和简化构建Docker(基于Google jib)</a> ，本文只介绍 <span>Dragonfly + </span><span>dfdaemon </span></p><p><br /></p><p>Dragonfly是阿里巴巴自研并开源的一款基于P2P协议的文件分发系统。除了使用 dfget 进行文件下载外，还支持dfdaemon 进行docker镜像下载。</p><p><br /></p><p><span>关于Dragonfly的镜像分发的原理性说明，可参见 </span><a href=\"https://yq.aliyun.com/articles/244897\" target=\"_blank\">直击阿里双11神秘技术：PB级大规模文件分发系统“蜻蜓”</a><span> ，文中介绍很详细，此处不多说明。</span></p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h3 id=\"12267079\">实验环境</h3><p><br /></p><card type=\"block\" name=\"table\" value=\"data:%7B%22rows%22%3A4%2C%22cols%22%3A4%2C%22html%22%3A%22%3Ctable%20class%3D%5C%22lake-table%5C%22%20style%3D%5C%22width%3A%20961px%3B%5C%22%3E%3Ccolgroup%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22240%5C%22%20%2F%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22240%5C%22%20%2F%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22240%5C%22%20%2F%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22240%5C%22%20%2F%3E%3C%2Fcolgroup%3E%3Ctbody%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3E%E7%B1%BB%E5%9E%8B%3C%2Ftd%3E%3Ctd%3E%E7%B3%BB%E7%BB%9F%3C%2Ftd%3E%3Ctd%3Eip%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3Edocker%20version%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3C%2Ftbody%3E%3Ctbody%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3Esupernode%3C%2Ftd%3E%3Ctd%3EUbuntu%20Server%2016.04.6%20LTS%20X64%3C%2Ftd%3E%3Ctd%3E192.168.0.44%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E17.06.2~ce-0~ubuntu%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3Eclinet1%3C%2Ftd%3E%3Ctd%3E%3Cp%3E%3Cspan%3EUbuntu%20Server%2016.04.6%20LTS%20X64%3C%2Fspan%3E%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E192.168.0.40%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E17.06.2~ce-0~ubuntu%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3Eclinet2%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%3E%3Cspan%3EUbuntu%20Server%2016.04.6%20LTS%20X64%3C%2Fspan%3E%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20rowspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cspan%20style%3D%5C%22color%3A%20%23262626%3B%20background-color%3A%20%23FFFFFF%3B%5C%22%3E192.168.0.45%3C%2Fspan%3E%3C%2Ftd%3E%3Ctd%20rowspan%3D%5C%221%5C%22%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E17.06.2~ce-0~ubuntu%3C%2Ftd%3E%3C%2Ftr%3E%3C%2Ftbody%3E%3C%2Ftable%3E%22%2C%22id%22%3A%22OzSZg%22%7D\"></card><p><br /></p><p><strong>注意：</strong> </p><p>如果是实验目的，建议用Vmware，并且在关键操作时备份快照（比如，刚装完环境），这样能够及时，干净的还原现场，节省每次重装系统导致的时间浪费</p><p><br /></p><p><span>安装</span></p><p><span><br /></span></p><p>吐槽一下Dragonfly的文档，简直让人不知所以。结合issues + 钉钉群内请教，遂整理出最简使用文档。</p><h3 id=\"supernode\">supernode</h3><p>可选：给supernode增加docker加速器<span>，可以参考 https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors ，如果不需要，可以去掉。</span></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20cat%20%3C%3CEOD%20%3E%2Fetc%2Fdocker%2Fdaemon.json%5Cn%7B%5Cn%5C%22registry-mirrors%5C%22%3A%20%5B%5C%22https%3A%2F%2Fxxxx.mirror.aliyuncs.com%5C%22%5D%20%5Cn%7D%5CnEOD%5Cn%24%20systemctl%20restart%20docker%20%22%7D\"></card><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20docker%20run%20--name%20dragonfly-supernode%20--restart%3Dalways%20-d%20-p%208001%3A8001%20-p%208002%3A8002%20-v%20%2Fdata%2Fdragonfly%2Fsupernode%3A%2Fhome%2Fadmin%2Fsupernode%20registry.cn-hangzhou.aliyuncs.com%2Fdragonflyoss%2Fsupernode%3A0.3.0%20-Dsupernode.advertiseIp%3D192.168.0.44%22%7D\"></card><p><br /></p><p><strong>说明：</strong></p><ul><li>--restart=always 在容器退出时，自动重启容器，防止异常kill或者oom导致的异常退出</li><li>registry.cn-hangzhou.aliyuncs.com/dragonflyoss/supernode:0.3.0 dragonfly的supernode目前没有docker hub镜像，只能用阿里云的</li><li>-v /data/dragonfly/supernode:/home/admin/supernode 将supernode的data dir挂载到宿主机上</li><li>-Dsupernode.advertiseIp=192.168.0.44<cursor /> 设置clinet可以访问的supernode ip,这是一个大坑。如果不设置，有可能会导致client无法连接supernode，届时，docker pull会走clinet的网络，从真实的registry直接下载镜像</li></ul><p><br /><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1553506862485-080cc522-2d28-47b9-8d6b-3db34db173f3.png%22%2C%22originWidth%22%3A725%2C%22originHeight%22%3A624%2C%22name%22%3A%22image.png%22%2C%22size%22%3A90024%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A725%2C%22height%22%3A624%7D\"></card></p><h3 id=\"752efc6a\"><span>dfdaemon </span></h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20cat%20%3C%3CEOD%20%3E%2Fetc%2Fdragonfly.conf%5Cn%5Bnode%5D%5Cnaddress%3D192.168.0.44%5CnEOD%5Cn%24%20docker%20run%20--name%20dragonfly-dfclient%20--restart%3Dalways%20-d%20-p%2065001%3A65001%20-v%20%2Froot%2F.small-dragonfly%3A%2Froot%2F.small-dragonfly%20-v%20%2Fetc%2Fdragonfly.conf%3A%2Fetc%2Fdragonfly.conf%20dragonflyoss%2Fdfclient%3Av0.3.0%20--registry%3Dhttps%3A%2F%2Fxxx.mirror.aliyuncs.com%20%20--ratelimit%20100M%5Cn%24%20cat%20%3C%3CEOD%20%3E%2Fetc%2Fdocker%2Fdaemon.json%5Cn%7B%5Cn%5C%22registry-mirrors%5C%22%3A%20%5B%5C%22http%3A%2F%2F127.0.0.1%3A65001%5C%22%5D%5Cn%7D%5CnEOD%5Cn%24%20systemctl%20restart%20docker%20%22%7D\"></card><p><br /></p><p><strong>说明：</strong> </p><ul><li>在 /etc/dragonfly.conf 中配置client可以访问的supernode的ip地址，但是，目前官方没有做HA，supernode没法组集群，撑死算是联邦，不能共享文件信息，而且最坑的是，快速开始里，中英文均未提供需要配置此文件，而是在 <a href=\"https://d7y.io/en-us/docs/userguide/download_files.html\" target=\"_blank\">Downloading Files with Dragonfly</a> 等有所提及（我都是被坑完后，用关键词在d7y的org里搜索，类似知道答案后，找出处 手动[捂脸]）</li><li>-v /root/.small-dragonfly:/root/.small-dragonfly ,将容器中的关键目录挂载到宿主机上，防止重启或者镜像升级时，数据丢失</li><li>--registry=https://xxx.mirror.aliyuncs.com 从何处下载镜像，可以写harbor地址，也可以写加速器地址。默认是 <a href=\"https://index.docker.io\" target=\"_blank\">https://index.docker.io</a> ，但是，因为国内网络原因，会导致大概率性失败。很灵异。而官方文档是写的 <code>--registry https://xxx.xx.x</code> 不能算是坑，但是，对于docker不熟悉的，往往会不知能不能用加速器。</li><li>--ratelimit 100M 是限速，默认是20M ,这肯定不算坑哈，这是正常特性，在  <a href=\"https://d7y.io/zh-cn/docs/quickstart.html\" target=\"_blank\">dfdaemon#Options</a> 有说明，但是，文档是有误的 <code>-ratelimit</code> 而实际是 <code>--ratelimit</code> ,如果不改此参数，会发现，下载很慢。</li><li>修改/etc/docker/daemon.json 是为了让docker engine走 dfdaemon</li><li>systemctl restart docker 是为了让daemon生效</li></ul><p><br /></p><h2 id=\"db06c78d\">测试</h2><h3 id=\"4a76b96e\">大文件测试</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20docker%20pull%20anjia0532%2Fkubeflow-images-public.tensorflow-1.6.0-notebook-gpu%3Av20180604-b3733835%22%7D\"></card><p>可以通过 <code>iftop</code> 等软件，查看带宽使用情况判断是否生效，也可以通过查看日志来判断。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1553508378817-cde03b19-e0e2-4d03-a233-b9090cc0db2f.png%22%2C%22originWidth%22%3A1911%2C%22originHeight%22%3A821%2C%22name%22%3A%22image.png%22%2C%22size%22%3A46951%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1911%2C%22height%22%3A821%7D\"></card></p><p>但是会经常性的出现 <code>error pulling image configuration: received unexpected HTTP status: 502 Bad Gateway</code> </p><p><br /></p><h2 id=\"9415a826\">最后</h2><p>需要结合实际情况，配置相关参数，比如，文件失效时间，用来平衡文件有效期及磁盘使用量。</p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://yq.aliyun.com/articles/244897\" target=\"_blank\">直击阿里双11神秘技术：PB级大规模文件分发系统“蜻蜓”</a></li><li><a href=\"https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247484045&amp;idx=1&amp;sn=2e4586171930b8d3080eadd55be09723\" target=\"_blank\">深度解读阿里巴巴云原生镜像分发系统 Dragonfly</a></li><li><a href=\"https://d7y.io/en-us/docs/quickstart.html\" target=\"_blank\">Dragonfly Quick Start</a></li><li><a href=\"https://juejin.im/post/5c60c021f265da2dd37bf85b\" target=\"_blank\">加速和简化构建Docker(基于Google jib)</a></li><li><a href=\"https://d7y.io/zh-cn/blog/china-mobile-practice.html\" target=\"_blank\">浙江移动容器云基于 Dragonfly 的统一文件分发平台生产实践</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-03-29T07:00:57.000Z",
    "deleted_at": null,
    "created_at": "2019-03-25T08:57:51.000Z",
    "updated_at": "2019-06-15T10:06:36.000Z",
    "published_at": "2019-03-29T07:00:57.000Z",
    "first_published_at": "2019-03-25T10:08:54.000Z",
    "word_count": 1392,
    "cover": "",
    "description": "date: 2019-03-25 16:58:00tags: [docker,k8s,kubernetes,alibaba,Dragonfly]categories: 运维---这是坚持技术写作计划（含翻译）的第12篇，定个小目标999，每周最少2篇。吐槽一下，最近有点懒，居然欠了4篇，后续会...",
    "custom_description": "如果说，微服务和容器是最佳拍档，那么模块多实例是肯定少不了。\n\n假如没有使用类似 Google jib 等手段进行镜像分层（利用镜像缓存），势必会造成\n\n带宽浪费：尤其是公网带宽，如果是自建harbor，那么会容易导致单节点网卡被打满，如果用了harbor联邦，又会导致数据同步等运维问题。\n集群拉起",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1372368,
    "slug": "openresty-maxminddb",
    "title": "011-openresty的maxminddb插件",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-03-14 23:26:00<br />tags: [nginx,openresty,maxminddb,maxmind,ipip]<br />categories: 运维<br />---\n\n> 这是坚持技术写作计划（含翻译）的第11篇，定个小目标999，每周最少2篇。\n\n\n本文主要介绍我之前基于openresty写的maxminddb的解析插件 -- [anjia0532/lua-resty-maxminddb](https://github.com/anjia0532/lua-resty-maxminddb) (已开源)。主要用途是根据ip获取地理位置。国内精确度不如国内[ipip.net](https://www.ipip.net/) ，但是胜在免费。在精确度要求不高的场景，还是可以用的。\n\n如果要用ipip.net的lua库，可以参考官方的 [ipipdotnet/ipdb-luajit](https://github.com/ipipdotnet/ipdb-luajit)\n\n<a name=\"b0ff454a\"></a>\n## 前提条件\n<a name=\"OpenResty\"></a>\n### OpenResty\n```bash\n# import our GPG key:\nwget -qO - https://openresty.org/package/pubkey.gpg | sudo apt-key add -\n\n# for installing the add-apt-repository command\n# (you can remove this package and its dependencies later):\nsudo apt-get -y install software-properties-common\n\n# add the our official APT repository:\nsudo add-apt-repository -y \"deb http://openresty.org/package/ubuntu $(lsb_release -sc) main\"\n\n# to update the APT index:\nsudo apt-get update\n\nsudo apt-get install openresty\n```\n\n<a name=\"62a25ba8\"></a>\n### maxmind/libmaxminddb && maxmind/geoipupdate\n```bash\nsudo add-apt-repository ppa:maxmind/ppa\nsudo apt update\nsudo apt install libmaxminddb0 libmaxminddb-dev mmdb-bin geoipupdate\n```\n\n<a name=\"a259fd57\"></a>\n### 配置 geoipupdate\n\n```bash\nsudo tee /etc/GeoIP.conf <<-'EOF'\n# The following AccountID and LicenseKey are required placeholders.\n# For geoipupdate versions earlier than 2.5.0, use UserId here instead of AccountID.\nAccountID 0\nLicenseKey 000000000000\n\n# Include one or more of the following edition IDs:\n# * GeoLite2-City - GeoLite 2 City\n# * GeoLite2-Country - GeoLite2 Country\n# For geoipupdate versions earlier than 2.5.0, use ProductIds here instead of EditionIDs.\nEditionIDs GeoLite2-City GeoLite2-Country\nEOF\n\nsudo /usr/local/bin/geoipupdate\n```\n\n\n<a name=\"68692f19\"></a>\n## 安装和使用 lua-resty-maxminddb\n\n<a name=\"e655a410\"></a>\n### 安装\n```bash\nopm get anjia0532/lua-resty-maxminddb\n```\n\n<a name=\"2651f0d5\"></a>\n### 配置openresty\n\n```bash\n  local cjson = require 'cjson'\n  local geo = require 'resty.maxminddb'\n  if not geo.initted() then\n      geo.init(\"/path/to/GeoLite2-City.mmdb\")\n  end\n  local res,err = geo.lookup(ngx.var.arg_ip or ngx.var.remote_addr) --support ipv6 e.g. 2001:4860:0:1001::3004:ef68\n\n  if not res then\n      ngx.log(ngx.ERR,'failed to lookup by ip ,reason:',err)\n  end\n\n  ngx.say(\"full :\",cjson.encode(res))\n  if ngx.var.arg_node then\n     ngx.say(\"node name:\",ngx.var.arg_node,\" ,value:\", cjson.encode(res[ngx.var.arg_node] or {}))\n  end\n```\n\n<a name=\"db06c78d\"></a>\n### 测试\n\n```bash\n#ipv4\ncurl localhost/ip=114.114.114.114&node=city\n#ipv6\n#curl localhost/ip=2001:4860:0:1001::3004:ef68&node=country\nfull :{\"city\":{\"geoname_id\":1799962,\"names\":{\"en\":\"Nanjing\",\"ru\":\"Нанкин\",\"fr\":\"Nankin\",\"pt-BR\":\"Nanquim\",\"zh-CN\":\"南京\",\"es\":\"Nankín\",\"de\":\"Nanjing\",\"ja\":\"南京市\"}},\"subdivisions\":[{\"geoname_id\":1806260,\"names\":{\"en\":\"Jiangsu\",\"fr\":\"Province de Jiangsu\",\"zh-CN\":\"江苏省\"},\"iso_code\":\"32\"}],\"country\":{\"geoname_id\":1814991,\"names\":{\"en\":\"China\",\"ru\":\"Китай\",\"fr\":\"Chine\",\"pt-BR\":\"China\",\"zh-CN\":\"中国\",\"es\":\"China\",\"de\":\"China\",\"ja\":\"中国\"},\"iso_code\":\"CN\"},\"registered_country\":{\"geoname_id\":1814991,\"names\":{\"en\":\"China\",\"ru\":\"Китай\",\"fr\":\"Chine\",\"pt-BR\":\"China\",\"zh-CN\":\"中国\",\"es\":\"China\",\"de\":\"China\",\"ja\":\"中国\"},\"iso_code\":\"CN\"},\"location\":{\"time_zone\":\"Asia\\/Shanghai\",\"longitude\":118.7778,\"accuracy_radius\":50,\"latitude\":32.0617},\"continent\":{\"geoname_id\":6255147,\"names\":{\"en\":\"Asia\",\"ru\":\"Азия\",\"fr\":\"Asie\",\"pt-BR\":\"Ásia\",\"zh-CN\":\"亚洲\",\"es\":\"Asia\",\"de\":\"Asien\",\"ja\":\"アジア\"},\"code\":\"AS\"}}\nnode name:city ,value:{\"geoname_id\":1799962,\"names\":{\"en\":\"Nanjing\",\"ru\":\"Нанкин\",\"fr\":\"Nankin\",\"pt-BR\":\"Nanquim\",\"zh-CN\":\"南京\",\"es\":\"Nankín\",\"de\":\"Nanjing\",\"ja\":\"南京市\"}}\n```\n\n格式化一下\n\n```javascript\nfull: {\n    \"city\": {\n        \"geoname_id\": 1799962,\n        \"names\": {\n            \"en\": \"Nanjing\",\n            \"ru\": \"Нанкин\",\n            \"fr\": \"Nankin\",\n            \"pt-BR\": \"Nanquim\",\n            \"zh-CN\": \"南京\",\n            \"es\": \"Nankín\",\n            \"de\": \"Nanjing\",\n            \"ja\": \"南京市\"\n        }\n    },\n    \"subdivisions\": [{\n            \"geoname_id\": 1806260,\n            \"names\": {\n                \"en\": \"Jiangsu\",\n                \"fr\": \"Province de Jiangsu\",\n                \"zh-CN\": \"江苏省\"\n            },\n            \"iso_code\": \"32\"\n        }\n    ],\n    \"country\": {\n        \"geoname_id\": 1814991,\n        \"names\": {\n            \"en\": \"China\",\n            \"ru\": \"Китай\",\n            \"fr\": \"Chine\",\n            \"pt-BR\": \"China\",\n            \"zh-CN\": \"中国\",\n            \"es\": \"China\",\n            \"de\": \"China\",\n            \"ja\": \"中国\"\n        },\n        \"iso_code\": \"CN\"\n    },\n    \"registered_country\": {\n        \"geoname_id\": 1814991,\n        \"names\": {\n            \"en\": \"China\",\n            \"ru\": \"Китай\",\n            \"fr\": \"Chine\",\n            \"pt-BR\": \"China\",\n            \"zh-CN\": \"中国\",\n            \"es\": \"China\",\n            \"de\": \"China\",\n            \"ja\": \"中国\"\n        },\n        \"iso_code\": \"CN\"\n    },\n    \"location\": {\n        \"time_zone\": \"Asia\\/Shanghai\",\n        \"longitude\": 118.7778,\n        \"accuracy_radius\": 50,\n        \"latitude\": 32.0617\n    },\n    \"continent\": {\n        \"geoname_id\": 6255147,\n        \"names\": {\n            \"en\": \"Asia\",\n            \"ru\": \"Азия\",\n            \"fr\": \"Asie\",\n            \"pt-BR\": \"Ásia\",\n            \"zh-CN\": \"亚洲\",\n            \"es\": \"Asia\",\n            \"de\": \"Asien\",\n            \"ja\": \"アジア\"\n        },\n        \"code\": \"AS\"\n    }\n}\nnode name: city, value: {\n    \"geoname_id\": 1799962,\n    \"names\": {\n        \"en\": \"Nanjing\",\n        \"ru\": \"Нанкин\",\n        \"fr\": \"Nankin\",\n        \"pt-BR\": \"Nanquim\",\n        \"zh-CN\": \"南京\",\n        \"es\": \"Nankín\",\n        \"de\": \"Nanjing\",\n        \"ja\": \"南京市\"\n    }\n}\n```\n\n<a name=\"97caa17e\"></a>\n## 压测 & 性能\n事先安装好 [wrk](https://github.com/wg/wrk/wiki)\n```bash\nsudo tee /tmp/wrk.lua <<-'EOF'\nwrk.method = \"GET\";\nwrk.body = \"\";\n\nlogfile = io.open(\"wrk.log\", \"w\");\n\nrequest = function()\nip = tostring(math.random(1, 255))..\".\"..tostring(math.random(1, 255))..\".\"..tostring(math.random(1, 255))..\".\"..tostring(math.random(1, 255))\npath = \"/?ip=\" .. ip\nreturn wrk.format(nil, path)\nend\n\nresponse = function(status,header,body)\nlogfile:write(\"\\nbody:\" .. body .. \"\\n-----------------\");\nend\nEOF\n\nsudo wrk -t50 -c200 -d120s -s /tmp/wrk.lua --latency http://127.0.0.1\n```\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1552578843226-04258e12-de95-4cad-89a2-5a4e8021de30.png#align=left&display=inline&height=157&originHeight=258&originWidth=1227&size=0&status=done&width=746)<br />![](https://cdn.nlark.com/yuque/0/2019/png/226273/1552578867709-755ce4c2-069f-4db9-b8ee-dfaa91331193.png#align=left&display=inline&height=209&originHeight=209&originWidth=635&size=0&status=done&width=635)\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [OpenResty® Linux Packages](https://openresty.org/en/linux-packages.html)\n- [Automatic Updates for GeoIP2 and GeoIP Legacy Databases](https://dev.maxmind.com/geoip/geoipupdate/)\n- [maxmind/libmaxminddb](https://github.com/maxmind/libmaxminddb)\n- [maxmind/geoipupdate](https://github.com/maxmind/geoipupdate)\n- [wg/wrk#wiki](https://github.com/wg/wrk/wiki)\n- [MMDB_free_entry_data_list (entry_data_list=0x23) at maxminddb.c:1860 #9](https://github.com/anjia0532/lua-resty-maxminddb/issues/9)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。\n\n长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-03-14 23:26:00</p><p>tags: [nginx,openresty,maxminddb,maxmind,ipip]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第11篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要介绍我之前基于openresty写的maxminddb的解析插件 -- <a href=\"https://github.com/anjia0532/lua-resty-maxminddb\" target=\"_blank\">anjia0532/lua-resty-maxminddb</a> (已开源)。主要用途是根据ip获取地理位置。国内精确度不如国内<a href=\"https://www.ipip.net/\" target=\"_blank\">ipip.net</a> ，但是胜在免费。在精确度要求不高的场景，还是可以用的。</p><p><br /></p><p>如果要用ipip.net的lua库，可以参考官方的 <a href=\"https://github.com/ipipdotnet/ipdb-luajit\" target=\"_blank\">ipipdotnet/ipdb-luajit</a></p><p><br /></p><h2 id=\"b0ff454a\">前提条件</h2><h3 id=\"OpenResty\">OpenResty</h3><pre data-lang=\"bash\"><code># import our GPG key:\nwget -qO - https://openresty.org/package/pubkey.gpg | sudo apt-key add -\n\n# for installing the add-apt-repository command\n# (you can remove this package and its dependencies later):\nsudo apt-get -y install software-properties-common\n\n# add the our official APT repository:\nsudo add-apt-repository -y &quot;deb http://openresty.org/package/ubuntu $(lsb_release -sc) main&quot;\n\n# to update the APT index:\nsudo apt-get update\n\nsudo apt-get install openresty</code></pre><p><br /></p><h3 id=\"62a25ba8\">maxmind/libmaxminddb &amp;&amp; maxmind/geoipupdate</h3><pre data-lang=\"bash\"><code>sudo add-apt-repository ppa:maxmind/ppa\nsudo apt update\nsudo apt install libmaxminddb0 libmaxminddb-dev mmdb-bin geoipupdate</code></pre><p><br /></p><h3 id=\"a259fd57\">配置 geoipupdate</h3><p><br /></p><pre data-lang=\"bash\"><code>sudo tee /etc/GeoIP.conf &lt;&lt;-'EOF'\n# The following AccountID and LicenseKey are required placeholders.\n# For geoipupdate versions earlier than 2.5.0, use UserId here instead of AccountID.\nAccountID 0\nLicenseKey 000000000000\n\n# Include one or more of the following edition IDs:\n# * GeoLite2-City - GeoLite 2 City\n# * GeoLite2-Country - GeoLite2 Country\n# For geoipupdate versions earlier than 2.5.0, use ProductIds here instead of EditionIDs.\nEditionIDs GeoLite2-City GeoLite2-Country\nEOF\n\nsudo /usr/local/bin/geoipupdate</code></pre><p><br /></p><p><br /></p><h2 id=\"68692f19\">安装和使用 lua-resty-maxminddb</h2><p><br /></p><h3 id=\"e655a410\">安装</h3><pre data-lang=\"bash\"><code>opm get anjia0532/lua-resty-maxminddb</code></pre><p><br /></p><h3 id=\"2651f0d5\">配置openresty</h3><p><br /></p><pre data-lang=\"bash\"><code>  local cjson = require 'cjson'\n  local geo = require 'resty.maxminddb'\n  if not geo.initted() then\n      geo.init(&quot;/path/to/GeoLite2-City.mmdb&quot;)\n  end\n  local res,err = geo.lookup(ngx.var.arg_ip or ngx.var.remote_addr) --support ipv6 e.g. 2001:4860:0:1001::3004:ef68\n\n  if not res then\n      ngx.log(ngx.ERR,'failed to lookup by ip ,reason:',err)\n  end\n\n  ngx.say(&quot;full :&quot;,cjson.encode(res))\n  if ngx.var.arg_node then\n     ngx.say(&quot;node name:&quot;,ngx.var.arg_node,&quot; ,value:&quot;, cjson.encode(res[ngx.var.arg_node] or {}))\n  end</code></pre><p><br /></p><h3 id=\"db06c78d\">测试</h3><p><br /></p><pre data-lang=\"bash\"><code>#ipv4\ncurl localhost/ip=114.114.114.114&amp;node=city\n#ipv6\n#curl localhost/ip=2001:4860:0:1001::3004:ef68&amp;node=country\nfull :{&quot;city&quot;:{&quot;geoname_id&quot;:1799962,&quot;names&quot;:{&quot;en&quot;:&quot;Nanjing&quot;,&quot;ru&quot;:&quot;Нанкин&quot;,&quot;fr&quot;:&quot;Nankin&quot;,&quot;pt-BR&quot;:&quot;Nanquim&quot;,&quot;zh-CN&quot;:&quot;南京&quot;,&quot;es&quot;:&quot;Nankín&quot;,&quot;de&quot;:&quot;Nanjing&quot;,&quot;ja&quot;:&quot;南京市&quot;}},&quot;subdivisions&quot;:[{&quot;geoname_id&quot;:1806260,&quot;names&quot;:{&quot;en&quot;:&quot;Jiangsu&quot;,&quot;fr&quot;:&quot;Province de Jiangsu&quot;,&quot;zh-CN&quot;:&quot;江苏省&quot;},&quot;iso_code&quot;:&quot;32&quot;}],&quot;country&quot;:{&quot;geoname_id&quot;:1814991,&quot;names&quot;:{&quot;en&quot;:&quot;China&quot;,&quot;ru&quot;:&quot;Китай&quot;,&quot;fr&quot;:&quot;Chine&quot;,&quot;pt-BR&quot;:&quot;China&quot;,&quot;zh-CN&quot;:&quot;中国&quot;,&quot;es&quot;:&quot;China&quot;,&quot;de&quot;:&quot;China&quot;,&quot;ja&quot;:&quot;中国&quot;},&quot;iso_code&quot;:&quot;CN&quot;},&quot;registered_country&quot;:{&quot;geoname_id&quot;:1814991,&quot;names&quot;:{&quot;en&quot;:&quot;China&quot;,&quot;ru&quot;:&quot;Китай&quot;,&quot;fr&quot;:&quot;Chine&quot;,&quot;pt-BR&quot;:&quot;China&quot;,&quot;zh-CN&quot;:&quot;中国&quot;,&quot;es&quot;:&quot;China&quot;,&quot;de&quot;:&quot;China&quot;,&quot;ja&quot;:&quot;中国&quot;},&quot;iso_code&quot;:&quot;CN&quot;},&quot;location&quot;:{&quot;time_zone&quot;:&quot;Asia\\/Shanghai&quot;,&quot;longitude&quot;:118.7778,&quot;accuracy_radius&quot;:50,&quot;latitude&quot;:32.0617},&quot;continent&quot;:{&quot;geoname_id&quot;:6255147,&quot;names&quot;:{&quot;en&quot;:&quot;Asia&quot;,&quot;ru&quot;:&quot;Азия&quot;,&quot;fr&quot;:&quot;Asie&quot;,&quot;pt-BR&quot;:&quot;Ásia&quot;,&quot;zh-CN&quot;:&quot;亚洲&quot;,&quot;es&quot;:&quot;Asia&quot;,&quot;de&quot;:&quot;Asien&quot;,&quot;ja&quot;:&quot;アジア&quot;},&quot;code&quot;:&quot;AS&quot;}}\nnode name:city ,value:{&quot;geoname_id&quot;:1799962,&quot;names&quot;:{&quot;en&quot;:&quot;Nanjing&quot;,&quot;ru&quot;:&quot;Нанкин&quot;,&quot;fr&quot;:&quot;Nankin&quot;,&quot;pt-BR&quot;:&quot;Nanquim&quot;,&quot;zh-CN&quot;:&quot;南京&quot;,&quot;es&quot;:&quot;Nankín&quot;,&quot;de&quot;:&quot;Nanjing&quot;,&quot;ja&quot;:&quot;南京市&quot;}}</code></pre><p><br /></p><p>格式化一下</p><p><br /></p><pre data-lang=\"javascript\"><code>full: {\n    &quot;city&quot;: {\n        &quot;geoname_id&quot;: 1799962,\n        &quot;names&quot;: {\n            &quot;en&quot;: &quot;Nanjing&quot;,\n            &quot;ru&quot;: &quot;Нанкин&quot;,\n            &quot;fr&quot;: &quot;Nankin&quot;,\n            &quot;pt-BR&quot;: &quot;Nanquim&quot;,\n            &quot;zh-CN&quot;: &quot;南京&quot;,\n            &quot;es&quot;: &quot;Nankín&quot;,\n            &quot;de&quot;: &quot;Nanjing&quot;,\n            &quot;ja&quot;: &quot;南京市&quot;\n        }\n    },\n    &quot;subdivisions&quot;: [{\n            &quot;geoname_id&quot;: 1806260,\n            &quot;names&quot;: {\n                &quot;en&quot;: &quot;Jiangsu&quot;,\n                &quot;fr&quot;: &quot;Province de Jiangsu&quot;,\n                &quot;zh-CN&quot;: &quot;江苏省&quot;\n            },\n            &quot;iso_code&quot;: &quot;32&quot;\n        }\n    ],\n    &quot;country&quot;: {\n        &quot;geoname_id&quot;: 1814991,\n        &quot;names&quot;: {\n            &quot;en&quot;: &quot;China&quot;,\n            &quot;ru&quot;: &quot;Китай&quot;,\n            &quot;fr&quot;: &quot;Chine&quot;,\n            &quot;pt-BR&quot;: &quot;China&quot;,\n            &quot;zh-CN&quot;: &quot;中国&quot;,\n            &quot;es&quot;: &quot;China&quot;,\n            &quot;de&quot;: &quot;China&quot;,\n            &quot;ja&quot;: &quot;中国&quot;\n        },\n        &quot;iso_code&quot;: &quot;CN&quot;\n    },\n    &quot;registered_country&quot;: {\n        &quot;geoname_id&quot;: 1814991,\n        &quot;names&quot;: {\n            &quot;en&quot;: &quot;China&quot;,\n            &quot;ru&quot;: &quot;Китай&quot;,\n            &quot;fr&quot;: &quot;Chine&quot;,\n            &quot;pt-BR&quot;: &quot;China&quot;,\n            &quot;zh-CN&quot;: &quot;中国&quot;,\n            &quot;es&quot;: &quot;China&quot;,\n            &quot;de&quot;: &quot;China&quot;,\n            &quot;ja&quot;: &quot;中国&quot;\n        },\n        &quot;iso_code&quot;: &quot;CN&quot;\n    },\n    &quot;location&quot;: {\n        &quot;time_zone&quot;: &quot;Asia\\/Shanghai&quot;,\n        &quot;longitude&quot;: 118.7778,\n        &quot;accuracy_radius&quot;: 50,\n        &quot;latitude&quot;: 32.0617\n    },\n    &quot;continent&quot;: {\n        &quot;geoname_id&quot;: 6255147,\n        &quot;names&quot;: {\n            &quot;en&quot;: &quot;Asia&quot;,\n            &quot;ru&quot;: &quot;Азия&quot;,\n            &quot;fr&quot;: &quot;Asie&quot;,\n            &quot;pt-BR&quot;: &quot;Ásia&quot;,\n            &quot;zh-CN&quot;: &quot;亚洲&quot;,\n            &quot;es&quot;: &quot;Asia&quot;,\n            &quot;de&quot;: &quot;Asien&quot;,\n            &quot;ja&quot;: &quot;アジア&quot;\n        },\n        &quot;code&quot;: &quot;AS&quot;\n    }\n}\nnode name: city, value: {\n    &quot;geoname_id&quot;: 1799962,\n    &quot;names&quot;: {\n        &quot;en&quot;: &quot;Nanjing&quot;,\n        &quot;ru&quot;: &quot;Нанкин&quot;,\n        &quot;fr&quot;: &quot;Nankin&quot;,\n        &quot;pt-BR&quot;: &quot;Nanquim&quot;,\n        &quot;zh-CN&quot;: &quot;南京&quot;,\n        &quot;es&quot;: &quot;Nankín&quot;,\n        &quot;de&quot;: &quot;Nanjing&quot;,\n        &quot;ja&quot;: &quot;南京市&quot;\n    }\n}</code></pre><p><br /></p><h2 id=\"97caa17e\">压测 &amp; 性能</h2><p>事先安装好 <a href=\"https://github.com/wg/wrk/wiki\" target=\"_blank\">wrk</a></p><pre data-lang=\"bash\"><code>sudo tee /tmp/wrk.lua &lt;&lt;-'EOF'\nwrk.method = &quot;GET&quot;;\nwrk.body = &quot;&quot;;\n\nlogfile = io.open(&quot;wrk.log&quot;, &quot;w&quot;);\n\nrequest = function()\nip = tostring(math.random(1, 255))..&quot;.&quot;..tostring(math.random(1, 255))..&quot;.&quot;..tostring(math.random(1, 255))..&quot;.&quot;..tostring(math.random(1, 255))\npath = &quot;/?ip=&quot; .. ip\nreturn wrk.format(nil, path)\nend\n\nresponse = function(status,header,body)\nlogfile:write(&quot;\\nbody:&quot; .. body .. &quot;\\n-----------------&quot;);\nend\nEOF\n\nsudo wrk -t50 -c200 -d120s -s /tmp/wrk.lua --latency http://127.0.0.1</code></pre><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1552578843226-04258e12-de95-4cad-89a2-5a4e8021de30.png#align=left&amp;display=inline&amp;height=157&amp;originHeight=258&amp;originWidth=1227&amp;size=0&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1552578867709-755ce4c2-069f-4db9-b8ee-dfaa91331193.png#align=left&amp;display=inline&amp;height=209&amp;originHeight=209&amp;originWidth=635&amp;size=0&amp;status=done&amp;width=635\" style=\"max-width: 600px; width: 635px;\" /></p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://openresty.org/en/linux-packages.html\" target=\"_blank\">OpenResty® Linux Packages</a></li><li><a href=\"https://dev.maxmind.com/geoip/geoipupdate/\" target=\"_blank\">Automatic Updates for GeoIP2 and GeoIP Legacy Databases</a></li><li><a href=\"https://github.com/maxmind/libmaxminddb\" target=\"_blank\">maxmind/libmaxminddb</a></li><li><a href=\"https://github.com/maxmind/geoipupdate\" target=\"_blank\">maxmind/geoipupdate</a></li><li><a href=\"https://github.com/wg/wrk/wiki\" target=\"_blank\">wg/wrk#wiki</a></li><li><a href=\"https://github.com/anjia0532/lua-resty-maxminddb/issues/9\" target=\"_blank\">MMDB_free_entry_data_list (entry_data_list=0x23) at maxminddb.c:1860 #9</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "body_lake": "<!doctype lake><p>date: 2019-03-14 23:26:00</p><p>tags: [nginx,openresty,maxminddb,maxmind,ipip]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第11篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要介绍我之前基于openresty写的maxminddb的解析插件 -- <a href=\"https://github.com/anjia0532/lua-resty-maxminddb\" target=\"_blank\">anjia0532/lua-resty-maxminddb</a> (已开源)。主要用途是根据ip获取地理位置。国内精确度不如国内<a href=\"https://www.ipip.net/\" target=\"_blank\">ipip.net</a> ，但是胜在免费。在精确度要求不高的场景，还是可以用的。</p><p><br /></p><p>如果要用ipip.net的lua库，可以参考官方的 <a href=\"https://github.com/ipipdotnet/ipdb-luajit\" target=\"_blank\">ipipdotnet/ipdb-luajit</a></p><p><br /></p><h2 id=\"b0ff454a\">前提条件</h2><h3 id=\"OpenResty\">OpenResty</h3><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23%20import%20our%20GPG%20key%3A%5Cnwget%20-qO%20-%20https%3A%2F%2Fopenresty.org%2Fpackage%2Fpubkey.gpg%20%7C%20sudo%20apt-key%20add%20-%5Cn%5Cn%23%20for%20installing%20the%20add-apt-repository%20command%5Cn%23%20(you%20can%20remove%20this%20package%20and%20its%20dependencies%20later)%3A%5Cnsudo%20apt-get%20-y%20install%20software-properties-common%5Cn%5Cn%23%20add%20the%20our%20official%20APT%20repository%3A%5Cnsudo%20add-apt-repository%20-y%20%5C%22deb%20http%3A%2F%2Fopenresty.org%2Fpackage%2Fubuntu%20%24(lsb_release%20-sc)%20main%5C%22%5Cn%5Cn%23%20to%20update%20the%20APT%20index%3A%5Cnsudo%20apt-get%20update%5Cn%5Cnsudo%20apt-get%20install%20openresty%22%7D\"></card><p><br /></p><h3 id=\"62a25ba8\">maxmind/libmaxminddb &amp;&amp; maxmind/geoipupdate</h3><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22sudo%20add-apt-repository%20ppa%3Amaxmind%2Fppa%5Cnsudo%20apt%20update%5Cnsudo%20apt%20install%20libmaxminddb0%20libmaxminddb-dev%20mmdb-bin%20geoipupdate%22%7D\"></card><p><br /></p><h3 id=\"a259fd57\">配置 geoipupdate</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22sudo%20tee%20%2Fetc%2FGeoIP.conf%20%3C%3C-'EOF'%5Cn%23%20The%20following%20AccountID%20and%20LicenseKey%20are%20required%20placeholders.%5Cn%23%20For%20geoipupdate%20versions%20earlier%20than%202.5.0%2C%20use%20UserId%20here%20instead%20of%20AccountID.%5CnAccountID%200%5CnLicenseKey%20000000000000%5Cn%5Cn%23%20Include%20one%20or%20more%20of%20the%20following%20edition%20IDs%3A%5Cn%23%20*%20GeoLite2-City%20-%20GeoLite%202%20City%5Cn%23%20*%20GeoLite2-Country%20-%20GeoLite2%20Country%5Cn%23%20For%20geoipupdate%20versions%20earlier%20than%202.5.0%2C%20use%20ProductIds%20here%20instead%20of%20EditionIDs.%5CnEditionIDs%20GeoLite2-City%20GeoLite2-Country%5CnEOF%5Cn%5Cnsudo%20%2Fusr%2Flocal%2Fbin%2Fgeoipupdate%22%7D\"></card><p><br /></p><p><br /></p><h2 id=\"68692f19\">安装和使用 lua-resty-maxminddb</h2><p><br /></p><h3 id=\"e655a410\">安装</h3><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22opm%20get%20anjia0532%2Flua-resty-maxminddb%22%7D\"></card><p><br /></p><h3 id=\"2651f0d5\">配置openresty</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%20%20local%20cjson%20%3D%20require%20'cjson'%5Cn%20%20local%20geo%20%3D%20require%20'resty.maxminddb'%5Cn%20%20if%20not%20geo.initted()%20then%5Cn%20%20%20%20%20%20geo.init(%5C%22%2Fpath%2Fto%2FGeoLite2-City.mmdb%5C%22)%5Cn%20%20end%5Cn%20%20local%20res%2Cerr%20%3D%20geo.lookup(ngx.var.arg_ip%20or%20ngx.var.remote_addr)%20--support%20ipv6%20e.g.%202001%3A4860%3A0%3A1001%3A%3A3004%3Aef68%5Cn%5Cn%20%20if%20not%20res%20then%5Cn%20%20%20%20%20%20ngx.log(ngx.ERR%2C'failed%20to%20lookup%20by%20ip%20%2Creason%3A'%2Cerr)%5Cn%20%20end%5Cn%5Cn%20%20ngx.say(%5C%22full%20%3A%5C%22%2Ccjson.encode(res))%5Cn%20%20if%20ngx.var.arg_node%20then%5Cn%20%20%20%20%20ngx.say(%5C%22node%20name%3A%5C%22%2Cngx.var.arg_node%2C%5C%22%20%2Cvalue%3A%5C%22%2C%20cjson.encode(res%5Bngx.var.arg_node%5D%20or%20%7B%7D))%5Cn%20%20end%22%7D\"></card><p><br /></p><h3 id=\"db06c78d\">测试</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23ipv4%5Cncurl%20localhost%2Fip%3D114.114.114.114%26node%3Dcity%5Cn%23ipv6%5Cn%23curl%20localhost%2Fip%3D2001%3A4860%3A0%3A1001%3A%3A3004%3Aef68%26node%3Dcountry%5Cnfull%20%3A%7B%5C%22city%5C%22%3A%7B%5C%22geoname_id%5C%22%3A1799962%2C%5C%22names%5C%22%3A%7B%5C%22en%5C%22%3A%5C%22Nanjing%5C%22%2C%5C%22ru%5C%22%3A%5C%22%D0%9D%D0%B0%D0%BD%D0%BA%D0%B8%D0%BD%5C%22%2C%5C%22fr%5C%22%3A%5C%22Nankin%5C%22%2C%5C%22pt-BR%5C%22%3A%5C%22Nanquim%5C%22%2C%5C%22zh-CN%5C%22%3A%5C%22%E5%8D%97%E4%BA%AC%5C%22%2C%5C%22es%5C%22%3A%5C%22Nank%C3%ADn%5C%22%2C%5C%22de%5C%22%3A%5C%22Nanjing%5C%22%2C%5C%22ja%5C%22%3A%5C%22%E5%8D%97%E4%BA%AC%E5%B8%82%5C%22%7D%7D%2C%5C%22subdivisions%5C%22%3A%5B%7B%5C%22geoname_id%5C%22%3A1806260%2C%5C%22names%5C%22%3A%7B%5C%22en%5C%22%3A%5C%22Jiangsu%5C%22%2C%5C%22fr%5C%22%3A%5C%22Province%20de%20Jiangsu%5C%22%2C%5C%22zh-CN%5C%22%3A%5C%22%E6%B1%9F%E8%8B%8F%E7%9C%81%5C%22%7D%2C%5C%22iso_code%5C%22%3A%5C%2232%5C%22%7D%5D%2C%5C%22country%5C%22%3A%7B%5C%22geoname_id%5C%22%3A1814991%2C%5C%22names%5C%22%3A%7B%5C%22en%5C%22%3A%5C%22China%5C%22%2C%5C%22ru%5C%22%3A%5C%22%D0%9A%D0%B8%D1%82%D0%B0%D0%B9%5C%22%2C%5C%22fr%5C%22%3A%5C%22Chine%5C%22%2C%5C%22pt-BR%5C%22%3A%5C%22China%5C%22%2C%5C%22zh-CN%5C%22%3A%5C%22%E4%B8%AD%E5%9B%BD%5C%22%2C%5C%22es%5C%22%3A%5C%22China%5C%22%2C%5C%22de%5C%22%3A%5C%22China%5C%22%2C%5C%22ja%5C%22%3A%5C%22%E4%B8%AD%E5%9B%BD%5C%22%7D%2C%5C%22iso_code%5C%22%3A%5C%22CN%5C%22%7D%2C%5C%22registered_country%5C%22%3A%7B%5C%22geoname_id%5C%22%3A1814991%2C%5C%22names%5C%22%3A%7B%5C%22en%5C%22%3A%5C%22China%5C%22%2C%5C%22ru%5C%22%3A%5C%22%D0%9A%D0%B8%D1%82%D0%B0%D0%B9%5C%22%2C%5C%22fr%5C%22%3A%5C%22Chine%5C%22%2C%5C%22pt-BR%5C%22%3A%5C%22China%5C%22%2C%5C%22zh-CN%5C%22%3A%5C%22%E4%B8%AD%E5%9B%BD%5C%22%2C%5C%22es%5C%22%3A%5C%22China%5C%22%2C%5C%22de%5C%22%3A%5C%22China%5C%22%2C%5C%22ja%5C%22%3A%5C%22%E4%B8%AD%E5%9B%BD%5C%22%7D%2C%5C%22iso_code%5C%22%3A%5C%22CN%5C%22%7D%2C%5C%22location%5C%22%3A%7B%5C%22time_zone%5C%22%3A%5C%22Asia%5C%5C%2FShanghai%5C%22%2C%5C%22longitude%5C%22%3A118.7778%2C%5C%22accuracy_radius%5C%22%3A50%2C%5C%22latitude%5C%22%3A32.0617%7D%2C%5C%22continent%5C%22%3A%7B%5C%22geoname_id%5C%22%3A6255147%2C%5C%22names%5C%22%3A%7B%5C%22en%5C%22%3A%5C%22Asia%5C%22%2C%5C%22ru%5C%22%3A%5C%22%D0%90%D0%B7%D0%B8%D1%8F%5C%22%2C%5C%22fr%5C%22%3A%5C%22Asie%5C%22%2C%5C%22pt-BR%5C%22%3A%5C%22%C3%81sia%5C%22%2C%5C%22zh-CN%5C%22%3A%5C%22%E4%BA%9A%E6%B4%B2%5C%22%2C%5C%22es%5C%22%3A%5C%22Asia%5C%22%2C%5C%22de%5C%22%3A%5C%22Asien%5C%22%2C%5C%22ja%5C%22%3A%5C%22%E3%82%A2%E3%82%B8%E3%82%A2%5C%22%7D%2C%5C%22code%5C%22%3A%5C%22AS%5C%22%7D%7D%5Cnnode%20name%3Acity%20%2Cvalue%3A%7B%5C%22geoname_id%5C%22%3A1799962%2C%5C%22names%5C%22%3A%7B%5C%22en%5C%22%3A%5C%22Nanjing%5C%22%2C%5C%22ru%5C%22%3A%5C%22%D0%9D%D0%B0%D0%BD%D0%BA%D0%B8%D0%BD%5C%22%2C%5C%22fr%5C%22%3A%5C%22Nankin%5C%22%2C%5C%22pt-BR%5C%22%3A%5C%22Nanquim%5C%22%2C%5C%22zh-CN%5C%22%3A%5C%22%E5%8D%97%E4%BA%AC%5C%22%2C%5C%22es%5C%22%3A%5C%22Nank%C3%ADn%5C%22%2C%5C%22de%5C%22%3A%5C%22Nanjing%5C%22%2C%5C%22ja%5C%22%3A%5C%22%E5%8D%97%E4%BA%AC%E5%B8%82%5C%22%7D%7D%22%7D\"></card><p><br /></p><p>格式化一下</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22javascript%22%2C%22code%22%3A%22full%3A%20%7B%5Cn%20%20%20%20%5C%22city%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%5C%22geoname_id%5C%22%3A%201799962%2C%5Cn%20%20%20%20%20%20%20%20%5C%22names%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22en%5C%22%3A%20%5C%22Nanjing%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ru%5C%22%3A%20%5C%22%D0%9D%D0%B0%D0%BD%D0%BA%D0%B8%D0%BD%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22fr%5C%22%3A%20%5C%22Nankin%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22pt-BR%5C%22%3A%20%5C%22Nanquim%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22zh-CN%5C%22%3A%20%5C%22%E5%8D%97%E4%BA%AC%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22es%5C%22%3A%20%5C%22Nank%C3%ADn%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22de%5C%22%3A%20%5C%22Nanjing%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ja%5C%22%3A%20%5C%22%E5%8D%97%E4%BA%AC%E5%B8%82%5C%22%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D%2C%5Cn%20%20%20%20%5C%22subdivisions%5C%22%3A%20%5B%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22geoname_id%5C%22%3A%201806260%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22names%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%22en%5C%22%3A%20%5C%22Jiangsu%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%22fr%5C%22%3A%20%5C%22Province%20de%20Jiangsu%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%22zh-CN%5C%22%3A%20%5C%22%E6%B1%9F%E8%8B%8F%E7%9C%81%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22iso_code%5C%22%3A%20%5C%2232%5C%22%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%5D%2C%5Cn%20%20%20%20%5C%22country%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%5C%22geoname_id%5C%22%3A%201814991%2C%5Cn%20%20%20%20%20%20%20%20%5C%22names%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22en%5C%22%3A%20%5C%22China%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ru%5C%22%3A%20%5C%22%D0%9A%D0%B8%D1%82%D0%B0%D0%B9%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22fr%5C%22%3A%20%5C%22Chine%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22pt-BR%5C%22%3A%20%5C%22China%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22zh-CN%5C%22%3A%20%5C%22%E4%B8%AD%E5%9B%BD%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22es%5C%22%3A%20%5C%22China%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22de%5C%22%3A%20%5C%22China%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ja%5C%22%3A%20%5C%22%E4%B8%AD%E5%9B%BD%5C%22%5Cn%20%20%20%20%20%20%20%20%7D%2C%5Cn%20%20%20%20%20%20%20%20%5C%22iso_code%5C%22%3A%20%5C%22CN%5C%22%5Cn%20%20%20%20%7D%2C%5Cn%20%20%20%20%5C%22registered_country%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%5C%22geoname_id%5C%22%3A%201814991%2C%5Cn%20%20%20%20%20%20%20%20%5C%22names%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22en%5C%22%3A%20%5C%22China%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ru%5C%22%3A%20%5C%22%D0%9A%D0%B8%D1%82%D0%B0%D0%B9%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22fr%5C%22%3A%20%5C%22Chine%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22pt-BR%5C%22%3A%20%5C%22China%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22zh-CN%5C%22%3A%20%5C%22%E4%B8%AD%E5%9B%BD%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22es%5C%22%3A%20%5C%22China%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22de%5C%22%3A%20%5C%22China%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ja%5C%22%3A%20%5C%22%E4%B8%AD%E5%9B%BD%5C%22%5Cn%20%20%20%20%20%20%20%20%7D%2C%5Cn%20%20%20%20%20%20%20%20%5C%22iso_code%5C%22%3A%20%5C%22CN%5C%22%5Cn%20%20%20%20%7D%2C%5Cn%20%20%20%20%5C%22location%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%5C%22time_zone%5C%22%3A%20%5C%22Asia%5C%5C%2FShanghai%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%5C%22longitude%5C%22%3A%20118.7778%2C%5Cn%20%20%20%20%20%20%20%20%5C%22accuracy_radius%5C%22%3A%2050%2C%5Cn%20%20%20%20%20%20%20%20%5C%22latitude%5C%22%3A%2032.0617%5Cn%20%20%20%20%7D%2C%5Cn%20%20%20%20%5C%22continent%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%5C%22geoname_id%5C%22%3A%206255147%2C%5Cn%20%20%20%20%20%20%20%20%5C%22names%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22en%5C%22%3A%20%5C%22Asia%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ru%5C%22%3A%20%5C%22%D0%90%D0%B7%D0%B8%D1%8F%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22fr%5C%22%3A%20%5C%22Asie%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22pt-BR%5C%22%3A%20%5C%22%C3%81sia%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22zh-CN%5C%22%3A%20%5C%22%E4%BA%9A%E6%B4%B2%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22es%5C%22%3A%20%5C%22Asia%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22de%5C%22%3A%20%5C%22Asien%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5C%22ja%5C%22%3A%20%5C%22%E3%82%A2%E3%82%B8%E3%82%A2%5C%22%5Cn%20%20%20%20%20%20%20%20%7D%2C%5Cn%20%20%20%20%20%20%20%20%5C%22code%5C%22%3A%20%5C%22AS%5C%22%5Cn%20%20%20%20%7D%5Cn%7D%5Cnnode%20name%3A%20city%2C%20value%3A%20%7B%5Cn%20%20%20%20%5C%22geoname_id%5C%22%3A%201799962%2C%5Cn%20%20%20%20%5C%22names%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%20%20%5C%22en%5C%22%3A%20%5C%22Nanjing%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%5C%22ru%5C%22%3A%20%5C%22%D0%9D%D0%B0%D0%BD%D0%BA%D0%B8%D0%BD%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%5C%22fr%5C%22%3A%20%5C%22Nankin%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%5C%22pt-BR%5C%22%3A%20%5C%22Nanquim%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%5C%22zh-CN%5C%22%3A%20%5C%22%E5%8D%97%E4%BA%AC%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%5C%22es%5C%22%3A%20%5C%22Nank%C3%ADn%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%5C%22de%5C%22%3A%20%5C%22Nanjing%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%5C%22ja%5C%22%3A%20%5C%22%E5%8D%97%E4%BA%AC%E5%B8%82%5C%22%5Cn%20%20%20%20%7D%5Cn%7D%22%7D\"></card><p><br /></p><h2 id=\"97caa17e\">压测 &amp; 性能</h2><p>事先安装好 <a href=\"https://github.com/wg/wrk/wiki\" target=\"_blank\">wrk</a></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22sudo%20tee%20%2Ftmp%2Fwrk.lua%20%3C%3C-'EOF'%5Cnwrk.method%20%3D%20%5C%22GET%5C%22%3B%5Cnwrk.body%20%3D%20%5C%22%5C%22%3B%5Cn%5Cnlogfile%20%3D%20io.open(%5C%22wrk.log%5C%22%2C%20%5C%22w%5C%22)%3B%5Cn%5Cnrequest%20%3D%20function()%5Cnip%20%3D%20tostring(math.random(1%2C%20255))..%5C%22.%5C%22..tostring(math.random(1%2C%20255))..%5C%22.%5C%22..tostring(math.random(1%2C%20255))..%5C%22.%5C%22..tostring(math.random(1%2C%20255))%5Cnpath%20%3D%20%5C%22%2F%3Fip%3D%5C%22%20..%20ip%5Cnreturn%20wrk.format(nil%2C%20path)%5Cnend%5Cn%5Cnresponse%20%3D%20function(status%2Cheader%2Cbody)%5Cnlogfile%3Awrite(%5C%22%5C%5Cnbody%3A%5C%22%20..%20body%20..%20%5C%22%5C%5Cn-----------------%5C%22)%3B%5Cnend%5CnEOF%5Cn%5Cnsudo%20wrk%20-t50%20-c200%20-d120s%20-s%20%2Ftmp%2Fwrk.lua%20--latency%20http%3A%2F%2F127.0.0.1%22%7D\"></card><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1552578843226-04258e12-de95-4cad-89a2-5a4e8021de30.png%22%2C%22originWidth%22%3A1227%2C%22originHeight%22%3A258%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A157%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1552578867709-755ce4c2-069f-4db9-b8ee-dfaa91331193.png%22%2C%22originWidth%22%3A635%2C%22originHeight%22%3A209%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A635%2C%22height%22%3A209%7D\"></card></p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://openresty.org/en/linux-packages.html\" target=\"_blank\">OpenResty® Linux Packages</a></li><li><a href=\"https://dev.maxmind.com/geoip/geoipupdate/\" target=\"_blank\">Automatic Updates for GeoIP2 and GeoIP Legacy Databases</a></li><li><a href=\"https://github.com/maxmind/libmaxminddb\" target=\"_blank\">maxmind/libmaxminddb</a></li><li><a href=\"https://github.com/maxmind/geoipupdate\" target=\"_blank\">maxmind/geoipupdate</a></li><li><a href=\"https://github.com/wg/wrk/wiki\" target=\"_blank\">wg/wrk#wiki</a></li><li><a href=\"https://github.com/anjia0532/lua-resty-maxminddb/issues/9\" target=\"_blank\">MMDB_free_entry_data_list (entry_data_list=0x23) at maxminddb.c:1860 #9</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /><cursor /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-03-14T16:00:03.000Z",
    "deleted_at": null,
    "created_at": "2019-03-14T15:24:00.000Z",
    "updated_at": "2019-03-14T16:00:03.000Z",
    "published_at": "2019-03-14T16:00:03.000Z",
    "first_published_at": "2019-03-14T16:00:03.000Z",
    "word_count": 1491,
    "cover": "",
    "description": "date: 2019-03-14 23:26:00tags: [nginx,openresty,maxminddb,maxmind,ipip]categories: 运维---这是坚持技术写作计划（含翻译）的第11篇，定个小目标999，每周最少2篇。本文主要介绍我之前基于openresty写的...",
    "custom_description": "本文主要介绍我之前基于openresty写的maxminddb的解析插件 -- anjia0532/lua-resty-maxminddb (已开源)。主要用途是根据ip获取地理位置。国内精确度不如国内ipip.net ，但是胜在免费。在精确度要求不高的场景，还是可以用的。",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1349245,
    "slug": "cloudboot-ros",
    "title": "010-cloudboot批量安装rancheros",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "> 这是坚持技术写作计划（含翻译）的第10篇，定个小目标999，每周最少2篇。\n\n\n本文主要讲解如何使用[cloudboot](http://www.idcos.com/opensource/cloudboot-open-source)简单批量安装[rancheros](https://rancher.com/rancher-os/)。\n\n\n<a name=\"61a3ec66\"></a>\n## 介绍\n\n\n<a name=\"cloudboot\"></a>\n### cloudboot\n\n[cloudboot](http://www.idcos.com/opensource/cloudboot-open-source)是 [云霁科技](http://www.idcos.com/) 科技开源的一款简单易用的装机系统，类似 [cobbler](http://cobbler.github.io) ,但是功能更强大，更易用。(可参考我之前写的 [007-Cobbler批量自动化部署Windows10和Server 2019](https://juejin.im/post/5c748b2af265da2d9262ed0f) 和 [006-Cobbler批量自动化部署CentOS/Ubuntu/Windows](https://juejin.im/post/5c748ae2f265da2d84108d71))\n\n<a name=\"rancheros\"></a>\n### rancheros\n\n[rancheros](https://rancher.com/rancher-os/) 是 [rancher lab](https://rancher.com) 开源的一款容器操作系统，类似[coreos](https://coreos.com/),RancherOS是RancherLab设计的小巧、专用的容器操作系统，可用安装到服务器本地硬盘中，也可以部署到公有云上，或者配合DockerMachine使用。与Ubuntu和CentOS不同，RancherOS使用cloud-config.yml配置文件来管理机器的配置信息，包括系统启动时的服务、网络相关的配置信息、存储配置、容器配置等等，都可以放到配置文件中进行管理。\n\n<a name=\"46679853\"></a>\n## 安装cloudboot\n\n参考 [cloudboot一键部署](http://idcos.github.io/osinstall-doc/environment/%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2.html) 不多赘述\n\n<a name=\"334359aa\"></a>\n### 挂载rancheros镜像\n\n```bash\nwget -P /tmp/ http://releases.rancher.com/os/latest/rancheros.iso\nmkdir -p $PWD/cloudboot/deploy/iso/rancheros/1.5.1/\nmount -o loop /tmp/rancheros.iso /media\nrsync -a /media/ $PWD/cloudboot/deploy/iso/rancheros/1.5.1/\numount /media\n```\n\n<a name=\"483e5673\"></a>\n### 创建软连接\n\n```bash\ndocker exec -it cloudboot /bin/sh\nln -s /data/iso/rancheros /home/www/rancheros\n```\n\n<a name=\"ba8d1dca\"></a>\n### 注意：\n\n- cloudboot默认用户名密码是 admin/admin\n- 登陆后需要配置dhcp(【系统管理】-> 【系统设置】)\n- 需要配置网段(【网段管理】->【应用网段】)\n- 本文讲的是vmware，所以不需要配置OOB\n- 需要配置设备位置(【模板管理】->【位置管理】)\n- 如果cloudboot和rancheros都装在vmware虚拟机里，需要把vmware的网络设置中的dhcp去掉，否则会冲突\n\n<a name=\"375e9611\"></a>\n## pxe安装rancheros\n\n参考 [rancheros#docs#iPXE](https://rancher.com/docs/os/v1.x/en/installation/running-rancheros/server/pxe/) 和 [cloudboot PXE模板定制规范](http://idcos.github.io/osinstall-doc/os/PXE%E6%A8%A1%E6%9D%BF%E5%AE%9A%E5%88%B6%E8%A7%84%E8%8C%83.html)\n\n<a name=\"c51df3a1\"></a>\n### PXE模板管理\n\n从【模板管理】->【PXE模板管理】 新增rancheros-1.5.1\n\n```bash\nDEFAULT rancheros\nLABEL rancheros\nKERNEL http://osinstall.idcos.com/rancheros/1.5.1/boot/vmlinuz-4.14.85-rancher\nAPPEND initrd=http://osinstall.idcos.com/rancheros/1.5.1/boot/initrd-v1.5.1  rancher.cloud_init.datasources=[url:http://osinstall.idcos.com/api/osinstall/v1/device/getSystemBySn?sn={sn}] rancher.autologin=tty1 rancher.autologin=ttyS0 rancher.autologin=ttyS1 rancher.autologin=ttyS1 console=tty1 console=ttyS0 console=ttyS1 printk.devkmsg=on panic=10 \nIPAPPEND 2\n```\n\n<a name=\"b3df8665\"></a>\n### 系统模板管理\n\n从【模板管理】->【系统模板管理】 新增rancheros-1.5.1\n\n把docker  mirror换成实际的加速器，如果不需要，可以删除，[ssh_authorized_keys 换成真实的ssh key](https://rancher.com/docs/os/v1.x/en/installation/configuration/ssh-keys/)\n\n```yaml\n#cloud-config\nrancher:\n    console: alpine\n    docker:\n        registry_mirror: \"https://xxx.mirror.aliyuncs.com\"\nruncmd:\n    - sh -c 'curl http://osinstall.idcos.com/scripts/rancheros.sh | bash'\nssh_authorized_keys:\n    - ssh-rsa AAAA....ZZZZ user@user\n```\n\n<a name=\"95dfb265\"></a>\n### 自定义脚本\n\n在cloudboot宿主机上，运行 `docker exec -it cloudboot /bin/sh` ,然后运行 `vim /home/www/scripts/rancheros.sh`\n\n```bash\n#!/bin/bash\nprogress() {\n    curl -H \"Content-Type: application/json\" -X POST -d \"{\\\"Sn\\\":\\\"$_sn\\\",\\\"Title\\\":\\\"$1\\\",\\\"InstallProgress\\\":$2,\\\"InstallLog\\\":\\\"$3\\\"}\" http://osinstall.idcos.com/api/osinstall/v1/report/deviceInstallInfo\n}\n\n_sn=$(sed q /sys/class/net/eth0/address)\n\nprogress \"配置主机名和网络\" 0.7 \"6YWN572u5Li75py65ZCN5ZKM572R57uc\"\n\n# config network\ncurl -o /tmp/networkinfo \"http://osinstall.idcos.com/api/osinstall/v1/device/getNetworkBySn?sn=${_sn}&type=raw\"\nsource /tmp/networkinfo\n\ncat > /etc/network/interfaces <<EOF\nauto lo\niface lo inet loopback\nauto eth0\niface eth0 inet static\naddress $IPADDR\nnetmask $NETMASK\ngateway $GATEWAY\nEOF\n\necho \"$HOSTNAME\" > /etc/hostname\nsudo hostname \"$HOSTNAME\"\n\nprogress \"配置alpine镜像源\" 0.8 \"6YWN572uYWxwaW5l6ZWc5YOP5rqQ\"\nsed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories\n\nprogress \"安装完成\" 1 \"5a6J6KOF5a6M5oiQ\"\nsudo ros install -c http://osinstall.idcos.com/api/osinstall/v1/device/getSystemBySn?sn=$_sn\" -d /dev/sda -f\n```\n\n<a name=\"b67e6b7d\"></a>\n### 自动化安装rancheros\n\n从vmware创建 空盘 -> 其他Linux4.x或更高版本内核64位，2核2G虚拟机，然后上电<br />虚拟机会从PXE拉取[cloudboot的bootos](http://idcos.github.io/osinstall-doc/bootos/) 安装到内存中，并且往cloudboot上注册待录入的设备（待屏幕变蓝色）\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1552641079937-7895b3bf-3100-47c6-9d89-d1069a5a420c.png#align=left&display=inline&height=400&originHeight=400&originWidth=720&size=0&status=done&width=720)<br />从 `http://${cloudboot host}/#/dashboard/device/scan/list` 会发现新设备，选中后，点击录入新设备<br />![](https://cdn.nlark.com/yuque/0/2019/png/226273/1552641079846-e0a498fc-7070-40b2-b67b-b4dc3c16b04d.png#align=left&display=inline&height=321&originHeight=321&originWidth=691&size=0&status=done&width=691)\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1552641079934-c5031ae9-b299-4b91-bcde-90d607704755.png#align=left&display=inline&height=222&originHeight=379&originWidth=1276&size=0&status=done&width=746)\n\nbootos会自动轮询是否有自动装机任务，所以静候即可。如果等不及，可以在录入成功后，手动重启虚拟机。<br />在【正在安装的设备】中，会自动出现要安装的设备\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1552641079912-f3e907b7-188d-4b82-aeff-1e577a4aba40.png#align=left&display=inline&height=98&originHeight=236&originWidth=1801&size=0&status=done&width=746)\n\n点击【详情】会在滚动模式下试试看到安装进度\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1552641079852-3baec0a2-0627-4fe9-8233-0459d3e5c20d.png#align=left&display=inline&height=157&originHeight=157&originWidth=440&size=0&status=done&width=440)\n\n在【设备列表】可以看到已安装成功的设备\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1552641079889-990adf01-3db1-4cd2-9791-4fc4d6b36e57.png#align=left&display=inline&height=72&originHeight=176&originWidth=1826&size=0&status=done&width=746)\n\n<a name=\"138a6766\"></a>\n### 注意\n\n~~不知道为嘛，安装后需要重启一下虚拟机后，才能使用ssh进行连接。~~\n\n根据rancher labs 大神腩哥指点\n\n> booting from ISO 首次启动，整个系统都在内存中。\n> \n> 执行ros install后，安装bootloader和initrd/vmlinuz到磁盘。\n> \n> 再次启动后，就是完整的运行在硬盘上的操作系统。\n\n\n<a name=\"c9665e1f\"></a>\n## 脑洞\n\n其实是正规操作，可以在 cloud config 配置自定义服务，这样装机后，就可以直接启动服务，不需要ssh到ros上，手动执行命令，例如配置rancher client的添加主机的命令，这样就可以直接添加到已有集群。 更多参考 [Custom System Services](https://rancher.com/docs/os/v1.x/en/installation/system-services/custom-system-services/)\n\n```yaml\n#cloud-config\nrancher:\n  services:\n    nginxapp:\n      image: nginx\n      restart: always\n```\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [cloudboot一键部署](http://idcos.github.io/osinstall-doc/environment/%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2.html)\n- [cloudboot PXE模板定制规范](http://idcos.github.io/osinstall-doc/os/PXE%E6%A8%A1%E6%9D%BF%E5%AE%9A%E5%88%B6%E8%A7%84%E8%8C%83.html)\n- [rancheros#docs#iPXE](https://rancher.com/docs/os/v1.x/en/installation/running-rancheros/server/pxe/)\n- [006-Cobbler批量自动化部署CentOS/Ubuntu/Windows](https://juejin.im/post/5c748ae2f265da2d84108d71)\n- [007-Cobbler批量自动化部署Windows10和Server 2019](https://juejin.im/post/5c748b2af265da2d9262ed0f)\n\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。\n\n长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n",
    "body_draft": "",
    "body_html": "<blockquote><p>这是坚持技术写作计划（含翻译）的第10篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要讲解如何使用<a href=\"http://www.idcos.com/opensource/cloudboot-open-source\" target=\"_blank\">cloudboot</a>简单批量安装<a href=\"https://rancher.com/rancher-os/\" target=\"_blank\">rancheros</a>。</p><p><br /></p><p><br /></p><h2 id=\"61a3ec66\">介绍</h2><p><br /></p><p><br /></p><h3 id=\"cloudboot\">cloudboot</h3><p><br /></p><p><a href=\"http://www.idcos.com/opensource/cloudboot-open-source\" target=\"_blank\">cloudboot</a>是 <a href=\"http://www.idcos.com/\" target=\"_blank\">云霁科技</a> 科技开源的一款简单易用的装机系统，类似 <a href=\"http://cobbler.github.io\" target=\"_blank\">cobbler</a> ,但是功能更强大，更易用。(可参考我之前写的 <a href=\"https://juejin.im/post/5c748b2af265da2d9262ed0f\" target=\"_blank\">007-Cobbler批量自动化部署Windows10和Server 2019</a> 和 <a href=\"https://juejin.im/post/5c748ae2f265da2d84108d71\" target=\"_blank\">006-Cobbler批量自动化部署CentOS/Ubuntu/Windows</a>)</p><p><br /></p><h3 id=\"rancheros\">rancheros</h3><p><br /></p><p><a href=\"https://rancher.com/rancher-os/\" target=\"_blank\">rancheros</a> 是 <a href=\"https://rancher.com\" target=\"_blank\">rancher lab</a> 开源的一款容器操作系统，类似<a href=\"https://coreos.com/\" target=\"_blank\">coreos</a>,RancherOS是RancherLab设计的小巧、专用的容器操作系统，可用安装到服务器本地硬盘中，也可以部署到公有云上，或者配合DockerMachine使用。与Ubuntu和CentOS不同，RancherOS使用cloud-config.yml配置文件来管理机器的配置信息，包括系统启动时的服务、网络相关的配置信息、存储配置、容器配置等等，都可以放到配置文件中进行管理。</p><p><br /></p><h2 id=\"46679853\">安装cloudboot</h2><p><br /></p><p>参考 <a href=\"http://idcos.github.io/osinstall-doc/environment/%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2.html\" target=\"_blank\">cloudboot一键部署</a> 不多赘述</p><p><br /></p><h3 id=\"334359aa\">挂载rancheros镜像</h3><p><br /></p><pre data-lang=\"bash\"><code>wget -P /tmp/ http://releases.rancher.com/os/latest/rancheros.iso\nmkdir -p $PWD/cloudboot/deploy/iso/rancheros/1.5.1/\nmount -o loop /tmp/rancheros.iso /media\nrsync -a /media/ $PWD/cloudboot/deploy/iso/rancheros/1.5.1/\numount /media</code></pre><p><br /></p><h3 id=\"483e5673\">创建软连接</h3><p><br /></p><pre data-lang=\"bash\"><code>docker exec -it cloudboot /bin/sh\nln -s /data/iso/rancheros /home/www/rancheros</code></pre><p><br /></p><h3 id=\"ba8d1dca\">注意：</h3><p><br /></p><ul><li>cloudboot默认用户名密码是 admin/admin</li></ul><ul><li>登陆后需要配置dhcp(【系统管理】-&gt; 【系统设置】)</li></ul><ul><li>需要配置网段(【网段管理】-&gt;【应用网段】)</li></ul><ul><li>本文讲的是vmware，所以不需要配置OOB</li></ul><ul><li>需要配置设备位置(【模板管理】-&gt;【位置管理】)</li></ul><ul><li>如果cloudboot和rancheros都装在vmware虚拟机里，需要把vmware的网络设置中的dhcp去掉，否则会冲突</li></ul><p><br /></p><h2 id=\"375e9611\">pxe安装rancheros</h2><p><br /></p><p>参考 <a href=\"https://rancher.com/docs/os/v1.x/en/installation/running-rancheros/server/pxe/\" target=\"_blank\">rancheros#docs#iPXE</a> 和 <a href=\"http://idcos.github.io/osinstall-doc/os/PXE%E6%A8%A1%E6%9D%BF%E5%AE%9A%E5%88%B6%E8%A7%84%E8%8C%83.html\" target=\"_blank\">cloudboot PXE模板定制规范</a></p><p><br /></p><h3 id=\"c51df3a1\">PXE模板管理</h3><p><br /></p><p>从【模板管理】-&gt;【PXE模板管理】 新增rancheros-1.5.1</p><p><br /></p><pre data-lang=\"bash\"><code>DEFAULT rancheros\nLABEL rancheros\nKERNEL http://osinstall.idcos.com/rancheros/1.5.1/boot/vmlinuz-4.14.85-rancher\nAPPEND initrd=http://osinstall.idcos.com/rancheros/1.5.1/boot/initrd-v1.5.1  rancher.cloud_init.datasources=[url:http://osinstall.idcos.com/api/osinstall/v1/device/getSystemBySn?sn={sn}] rancher.autologin=tty1 rancher.autologin=ttyS0 rancher.autologin=ttyS1 rancher.autologin=ttyS1 console=tty1 console=ttyS0 console=ttyS1 printk.devkmsg=on panic=10 \nIPAPPEND 2</code></pre><p><br /></p><h3 id=\"b3df8665\">系统模板管理</h3><p><br /></p><p>从【模板管理】-&gt;【系统模板管理】 新增rancheros-1.5.1</p><p><br /></p><p>把docker  mirror换成实际的加速器，如果不需要，可以删除，<a href=\"https://rancher.com/docs/os/v1.x/en/installation/configuration/ssh-keys/\" target=\"_blank\">ssh_authorized_keys 换成真实的ssh key</a></p><p><br /></p><pre data-lang=\"yaml\"><code>#cloud-config\nrancher:\n    console: alpine\n    docker:\n        registry_mirror: &quot;https://xxx.mirror.aliyuncs.com&quot;\nruncmd:\n    - sh -c 'curl http://osinstall.idcos.com/scripts/rancheros.sh | bash'\nssh_authorized_keys:\n    - ssh-rsa AAAA....ZZZZ user@user</code></pre><p><br /></p><h3 id=\"95dfb265\">自定义脚本</h3><p><br /></p><p>在cloudboot宿主机上，运行 <code>docker exec -it cloudboot /bin/sh</code> ,然后运行 <code>vim /home/www/scripts/rancheros.sh</code></p><p><br /></p><pre data-lang=\"bash\"><code>#!/bin/bash\nprogress() {\n    curl -H &quot;Content-Type: application/json&quot; -X POST -d &quot;{\\&quot;Sn\\&quot;:\\&quot;$_sn\\&quot;,\\&quot;Title\\&quot;:\\&quot;$1\\&quot;,\\&quot;InstallProgress\\&quot;:$2,\\&quot;InstallLog\\&quot;:\\&quot;$3\\&quot;}&quot; http://osinstall.idcos.com/api/osinstall/v1/report/deviceInstallInfo\n}\n\n_sn=$(sed q /sys/class/net/eth0/address)\n\nprogress &quot;配置主机名和网络&quot; 0.7 &quot;6YWN572u5Li75py65ZCN5ZKM572R57uc&quot;\n\n# config network\ncurl -o /tmp/networkinfo &quot;http://osinstall.idcos.com/api/osinstall/v1/device/getNetworkBySn?sn=${_sn}&amp;type=raw&quot;\nsource /tmp/networkinfo\n\ncat &gt; /etc/network/interfaces &lt;&lt;EOF\nauto lo\niface lo inet loopback\nauto eth0\niface eth0 inet static\naddress $IPADDR\nnetmask $NETMASK\ngateway $GATEWAY\nEOF\n\necho &quot;$HOSTNAME&quot; &gt; /etc/hostname\nsudo hostname &quot;$HOSTNAME&quot;\n\nprogress &quot;配置alpine镜像源&quot; 0.8 &quot;6YWN572uYWxwaW5l6ZWc5YOP5rqQ&quot;\nsed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories\n\nprogress &quot;安装完成&quot; 1 &quot;5a6J6KOF5a6M5oiQ&quot;\nsudo ros install -c http://osinstall.idcos.com/api/osinstall/v1/device/getSystemBySn?sn=$_sn&quot; -d /dev/sda -f</code></pre><p><br /></p><h3 id=\"b67e6b7d\">自动化安装rancheros</h3><p><br /></p><p>从vmware创建 空盘 -&gt; 其他Linux4.x或更高版本内核64位，2核2G虚拟机，然后上电</p><p>虚拟机会从PXE拉取<a href=\"http://idcos.github.io/osinstall-doc/bootos/\" target=\"_blank\">cloudboot的bootos</a> 安装到内存中，并且往cloudboot上注册待录入的设备（待屏幕变蓝色）</p><p><br /></p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1552641079937-7895b3bf-3100-47c6-9d89-d1069a5a420c.png#align=left&amp;display=inline&amp;height=400&amp;originHeight=400&amp;originWidth=720&amp;size=0&amp;status=done&amp;width=720\" style=\"max-width: 600px; width: 720px;\" /></p><p>从 <code>http://${cloudboot host}/#/dashboard/device/scan/list</code> 会发现新设备，选中后，点击录入新设备</p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1552641079846-e0a498fc-7070-40b2-b67b-b4dc3c16b04d.png#align=left&amp;display=inline&amp;height=321&amp;originHeight=321&amp;originWidth=691&amp;size=0&amp;status=done&amp;width=691\" style=\"max-width: 600px; width: 691px;\" /></p><p><br /></p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1552641079934-c5031ae9-b299-4b91-bcde-90d607704755.png#align=left&amp;display=inline&amp;height=222&amp;originHeight=379&amp;originWidth=1276&amp;size=0&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p><br /></p><p>bootos会自动轮询是否有自动装机任务，所以静候即可。如果等不及，可以在录入成功后，手动重启虚拟机。</p><p>在【正在安装的设备】中，会自动出现要安装的设备</p><p><br /></p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1552641079912-f3e907b7-188d-4b82-aeff-1e577a4aba40.png#align=left&amp;display=inline&amp;height=98&amp;originHeight=236&amp;originWidth=1801&amp;size=0&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p><br /></p><p>点击【详情】会在滚动模式下试试看到安装进度</p><p><br /></p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1552641079852-3baec0a2-0627-4fe9-8233-0459d3e5c20d.png#align=left&amp;display=inline&amp;height=157&amp;originHeight=157&amp;originWidth=440&amp;size=0&amp;status=done&amp;width=440\" style=\"max-width: 600px; width: 440px;\" /></p><p><br /></p><p>在【设备列表】可以看到已安装成功的设备</p><p><br /></p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1552641079889-990adf01-3db1-4cd2-9791-4fc4d6b36e57.png#align=left&amp;display=inline&amp;height=72&amp;originHeight=176&amp;originWidth=1826&amp;size=0&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p><br /></p><h3 id=\"138a6766\">注意</h3><p><br /></p><p><del>不知道为嘛，安装后需要重启一下虚拟机后，才能使用ssh进行连接。</del></p><p><br /></p><p>根据rancher labs 大神腩哥指点</p><p><br /></p><blockquote><p>booting from ISO 首次启动，整个系统都在内存中。</p><p><br /></p><p>执行ros install后，安装bootloader和initrd/vmlinuz到磁盘。</p><p><br /></p><p>再次启动后，就是完整的运行在硬盘上的操作系统。</p></blockquote><p><br /></p><h2 id=\"c9665e1f\">脑洞</h2><p><br /></p><p>其实是正规操作，可以在 cloud config 配置自定义服务，这样装机后，就可以直接启动服务，不需要ssh到ros上，手动执行命令，例如配置rancher client的添加主机的命令，这样就可以直接添加到已有集群。 更多参考 <a href=\"https://rancher.com/docs/os/v1.x/en/installation/system-services/custom-system-services/\" target=\"_blank\">Custom System Services</a></p><p><br /></p><pre data-lang=\"yaml\"><code>#cloud-config\nrancher:\n  services:\n    nginxapp:\n      image: nginx\n      restart: always</code></pre><p><br /></p><h2 id=\"35808e79\">参考资料</h2><p><br /></p><ul><li><a href=\"http://idcos.github.io/osinstall-doc/environment/%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2.html\" target=\"_blank\">cloudboot一键部署</a></li></ul><ul><li><a href=\"http://idcos.github.io/osinstall-doc/os/PXE%E6%A8%A1%E6%9D%BF%E5%AE%9A%E5%88%B6%E8%A7%84%E8%8C%83.html\" target=\"_blank\">cloudboot PXE模板定制规范</a></li></ul><ul><li><a href=\"https://rancher.com/docs/os/v1.x/en/installation/running-rancheros/server/pxe/\" target=\"_blank\">rancheros#docs#iPXE</a></li></ul><ul><li><a href=\"https://juejin.im/post/5c748ae2f265da2d84108d71\" target=\"_blank\">006-Cobbler批量自动化部署CentOS/Ubuntu/Windows</a></li></ul><ul><li><a href=\"https://juejin.im/post/5c748b2af265da2d9262ed0f\" target=\"_blank\">007-Cobbler批量自动化部署Windows10和Server 2019</a></li></ul><p><br /></p><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "body_lake": "<!doctype lake><blockquote><p>这是坚持技术写作计划（含翻译）的第10篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要讲解如何使用<a href=\"http://www.idcos.com/opensource/cloudboot-open-source\" target=\"_blank\">cloudboot</a>简单批量安装<a href=\"https://rancher.com/rancher-os/\" target=\"_blank\">rancheros</a>。</p><p><br /></p><p><br /></p><h2 id=\"61a3ec66\">介绍</h2><p><br /></p><p><br /></p><h3 id=\"cloudboot\">cloudboot</h3><p><br /></p><p><a href=\"http://www.idcos.com/opensource/cloudboot-open-source\" target=\"_blank\">cloudboot</a>是 <a href=\"http://www.idcos.com/\" target=\"_blank\">云霁科技</a> 科技开源的一款简单易用的装机系统，类似 <a href=\"http://cobbler.github.io\" target=\"_blank\">cobbler</a> ,但是功能更强大，更易用。(可参考我之前写的 <a href=\"https://juejin.im/post/5c748b2af265da2d9262ed0f\" target=\"_blank\">007-Cobbler批量自动化部署Windows10和Server 2019</a> 和 <a href=\"https://juejin.im/post/5c748ae2f265da2d84108d71\" target=\"_blank\">006-Cobbler批量自动化部署CentOS/Ubuntu/Windows</a>)</p><p><br /></p><h3 id=\"rancheros\">rancheros</h3><p><br /></p><p><a href=\"https://rancher.com/rancher-os/\" target=\"_blank\">rancheros</a> 是 <a href=\"https://rancher.com\" target=\"_blank\">rancher lab</a> 开源的一款容器操作系统，类似<a href=\"https://coreos.com/\" target=\"_blank\">coreos</a>,RancherOS是RancherLab设计的小巧、专用的容器操作系统，可用安装到服务器本地硬盘中，也可以部署到公有云上，或者配合DockerMachine使用。与Ubuntu和CentOS不同，RancherOS使用cloud-config.yml配置文件来管理机器的配置信息，包括系统启动时的服务、网络相关的配置信息、存储配置、容器配置等等，都可以放到配置文件中进行管理。</p><p><br /></p><h2 id=\"46679853\">安装cloudboot</h2><p><br /></p><p>参考 <a href=\"http://idcos.github.io/osinstall-doc/environment/%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2.html\" target=\"_blank\">cloudboot一键部署</a> 不多赘述</p><p><br /></p><h3 id=\"334359aa\">挂载rancheros镜像</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22wget%20-P%20%2Ftmp%2F%20http%3A%2F%2Freleases.rancher.com%2Fos%2Flatest%2Francheros.iso%5Cnmkdir%20-p%20%24PWD%2Fcloudboot%2Fdeploy%2Fiso%2Francheros%2F1.5.1%2F%5Cnmount%20-o%20loop%20%2Ftmp%2Francheros.iso%20%2Fmedia%5Cnrsync%20-a%20%2Fmedia%2F%20%24PWD%2Fcloudboot%2Fdeploy%2Fiso%2Francheros%2F1.5.1%2F%5Cnumount%20%2Fmedia%22%7D\"></card><p><br /></p><h3 id=\"483e5673\">创建软连接</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22docker%20exec%20-it%20cloudboot%20%2Fbin%2Fsh%5Cnln%20-s%20%2Fdata%2Fiso%2Francheros%20%2Fhome%2Fwww%2Francheros%22%7D\"></card><p><br /></p><h3 id=\"ba8d1dca\">注意：</h3><p><br /></p><ul><li>cloudboot默认用户名密码是 admin/admin</li></ul><ul><li>登陆后需要配置dhcp(【系统管理】-&gt; 【系统设置】)</li></ul><ul><li>需要配置网段(【网段管理】-&gt;【应用网段】)</li></ul><ul><li>本文讲的是vmware，所以不需要配置OOB</li></ul><ul><li>需要配置设备位置(【模板管理】-&gt;【位置管理】)</li></ul><ul><li>如果cloudboot和rancheros都装在vmware虚拟机里，需要把vmware的网络设置中的dhcp去掉，否则会冲突</li></ul><p><br /></p><h2 id=\"375e9611\">pxe安装rancheros</h2><p><br /></p><p>参考 <a href=\"https://rancher.com/docs/os/v1.x/en/installation/running-rancheros/server/pxe/\" target=\"_blank\">rancheros#docs#iPXE</a> 和 <a href=\"http://idcos.github.io/osinstall-doc/os/PXE%E6%A8%A1%E6%9D%BF%E5%AE%9A%E5%88%B6%E8%A7%84%E8%8C%83.html\" target=\"_blank\">cloudboot PXE模板定制规范</a></p><p><br /></p><h3 id=\"c51df3a1\">PXE模板管理</h3><p><br /></p><p>从【模板管理】-&gt;【PXE模板管理】 新增rancheros-1.5.1</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22DEFAULT%20rancheros%5CnLABEL%20rancheros%5CnKERNEL%20http%3A%2F%2Fosinstall.idcos.com%2Francheros%2F1.5.1%2Fboot%2Fvmlinuz-4.14.85-rancher%5CnAPPEND%20initrd%3Dhttp%3A%2F%2Fosinstall.idcos.com%2Francheros%2F1.5.1%2Fboot%2Finitrd-v1.5.1%20%20rancher.cloud_init.datasources%3D%5Burl%3Ahttp%3A%2F%2Fosinstall.idcos.com%2Fapi%2Fosinstall%2Fv1%2Fdevice%2FgetSystemBySn%3Fsn%3D%7Bsn%7D%5D%20rancher.autologin%3Dtty1%20rancher.autologin%3DttyS0%20rancher.autologin%3DttyS1%20rancher.autologin%3DttyS1%20console%3Dtty1%20console%3DttyS0%20console%3DttyS1%20printk.devkmsg%3Don%20panic%3D10%20%5CnIPAPPEND%202%22%7D\"></card><p><br /></p><h3 id=\"b3df8665\">系统模板管理</h3><p><br /></p><p>从【模板管理】-&gt;【系统模板管理】 新增rancheros-1.5.1</p><p><br /></p><p>把docker  mirror换成实际的加速器，如果不需要，可以删除，<a href=\"https://rancher.com/docs/os/v1.x/en/installation/configuration/ssh-keys/\" target=\"_blank\">ssh_authorized_keys 换成真实的ssh key</a></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22yaml%22%2C%22code%22%3A%22%23cloud-config%5Cnrancher%3A%5Cn%20%20%20%20console%3A%20alpine%5Cn%20%20%20%20docker%3A%5Cn%20%20%20%20%20%20%20%20registry_mirror%3A%20%5C%22https%3A%2F%2Fxxx.mirror.aliyuncs.com%5C%22%5Cnruncmd%3A%5Cn%20%20%20%20-%20sh%20-c%20'curl%20http%3A%2F%2Fosinstall.idcos.com%2Fscripts%2Francheros.sh%20%7C%20bash'%5Cnssh_authorized_keys%3A%5Cn%20%20%20%20-%20ssh-rsa%20AAAA....ZZZZ%20user%40user%22%7D\"></card><p><br /></p><h3 id=\"95dfb265\">自定义脚本</h3><p><br /></p><p>在cloudboot宿主机上，运行 <code>docker exec -it cloudboot /bin/sh</code> ,然后运行 <code>vim /home/www/scripts/rancheros.sh</code></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23!%2Fbin%2Fbash%5Cnprogress()%20%7B%5Cn%20%20%20%20curl%20-H%20%5C%22Content-Type%3A%20application%2Fjson%5C%22%20-X%20POST%20-d%20%5C%22%7B%5C%5C%5C%22Sn%5C%5C%5C%22%3A%5C%5C%5C%22%24_sn%5C%5C%5C%22%2C%5C%5C%5C%22Title%5C%5C%5C%22%3A%5C%5C%5C%22%241%5C%5C%5C%22%2C%5C%5C%5C%22InstallProgress%5C%5C%5C%22%3A%242%2C%5C%5C%5C%22InstallLog%5C%5C%5C%22%3A%5C%5C%5C%22%243%5C%5C%5C%22%7D%5C%22%20http%3A%2F%2Fosinstall.idcos.com%2Fapi%2Fosinstall%2Fv1%2Freport%2FdeviceInstallInfo%5Cn%7D%5Cn%5Cn_sn%3D%24(sed%20q%20%2Fsys%2Fclass%2Fnet%2Feth0%2Faddress)%5Cn%5Cnprogress%20%5C%22%E9%85%8D%E7%BD%AE%E4%B8%BB%E6%9C%BA%E5%90%8D%E5%92%8C%E7%BD%91%E7%BB%9C%5C%22%200.7%20%5C%226YWN572u5Li75py65ZCN5ZKM572R57uc%5C%22%5Cn%5Cn%23%20config%20network%5Cncurl%20-o%20%2Ftmp%2Fnetworkinfo%20%5C%22http%3A%2F%2Fosinstall.idcos.com%2Fapi%2Fosinstall%2Fv1%2Fdevice%2FgetNetworkBySn%3Fsn%3D%24%7B_sn%7D%26type%3Draw%5C%22%5Cnsource%20%2Ftmp%2Fnetworkinfo%5Cn%5Cncat%20%3E%20%2Fetc%2Fnetwork%2Finterfaces%20%3C%3CEOF%5Cnauto%20lo%5Cniface%20lo%20inet%20loopback%5Cnauto%20eth0%5Cniface%20eth0%20inet%20static%5Cnaddress%20%24IPADDR%5Cnnetmask%20%24NETMASK%5Cngateway%20%24GATEWAY%5CnEOF%5Cn%5Cnecho%20%5C%22%24HOSTNAME%5C%22%20%3E%20%2Fetc%2Fhostname%5Cnsudo%20hostname%20%5C%22%24HOSTNAME%5C%22%5Cn%5Cnprogress%20%5C%22%E9%85%8D%E7%BD%AEalpine%E9%95%9C%E5%83%8F%E6%BA%90%5C%22%200.8%20%5C%226YWN572uYWxwaW5l6ZWc5YOP5rqQ%5C%22%5Cnsed%20-i%20's%2Fdl-cdn.alpinelinux.org%2Fmirrors.aliyun.com%2Fg'%20%2Fetc%2Fapk%2Frepositories%5Cn%5Cnprogress%20%5C%22%E5%AE%89%E8%A3%85%E5%AE%8C%E6%88%90%5C%22%201%20%5C%225a6J6KOF5a6M5oiQ%5C%22%5Cnsudo%20ros%20install%20-c%20http%3A%2F%2Fosinstall.idcos.com%2Fapi%2Fosinstall%2Fv1%2Fdevice%2FgetSystemBySn%3Fsn%3D%24_sn%5C%22%20-d%20%2Fdev%2Fsda%20-f%22%7D\"></card><p><br /></p><h3 id=\"b67e6b7d\">自动化安装rancheros</h3><p><br /></p><p>从vmware创建 空盘 -&gt; 其他Linux4.x或更高版本内核64位，2核2G虚拟机，然后上电</p><p>虚拟机会从PXE拉取<a href=\"http://idcos.github.io/osinstall-doc/bootos/\" target=\"_blank\">cloudboot的bootos</a> 安装到内存中，并且往cloudboot上注册待录入的设备（待屏幕变蓝色）</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1552641079937-7895b3bf-3100-47c6-9d89-d1069a5a420c.png%22%2C%22originWidth%22%3A720%2C%22originHeight%22%3A400%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A720%2C%22height%22%3A400%7D\"></card></p><p>从 <code>http://${cloudboot host}/#/dashboard/device/scan/list</code> 会发现新设备，选中后，点击录入新设备</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1552641079846-e0a498fc-7070-40b2-b67b-b4dc3c16b04d.png%22%2C%22originWidth%22%3A691%2C%22originHeight%22%3A321%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A691%2C%22height%22%3A321%7D\"></card></p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1552641079934-c5031ae9-b299-4b91-bcde-90d607704755.png%22%2C%22originWidth%22%3A1276%2C%22originHeight%22%3A379%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A222%7D\"></card><cursor /></p><p><br /></p><p>bootos会自动轮询是否有自动装机任务，所以静候即可。如果等不及，可以在录入成功后，手动重启虚拟机。</p><p>在【正在安装的设备】中，会自动出现要安装的设备</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1552641079912-f3e907b7-188d-4b82-aeff-1e577a4aba40.png%22%2C%22originWidth%22%3A1801%2C%22originHeight%22%3A236%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A98%7D\"></card></p><p><br /></p><p>点击【详情】会在滚动模式下试试看到安装进度</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1552641079852-3baec0a2-0627-4fe9-8233-0459d3e5c20d.png%22%2C%22originWidth%22%3A440%2C%22originHeight%22%3A157%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A440%2C%22height%22%3A157%7D\"></card></p><p><br /></p><p>在【设备列表】可以看到已安装成功的设备</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1552641079889-990adf01-3db1-4cd2-9791-4fc4d6b36e57.png%22%2C%22originWidth%22%3A1826%2C%22originHeight%22%3A176%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A72%7D\"></card></p><p><br /></p><h3 id=\"138a6766\">注意</h3><p><br /></p><p><del>不知道为嘛，安装后需要重启一下虚拟机后，才能使用ssh进行连接。</del></p><p><br /></p><p>根据rancher labs 大神腩哥指点</p><p><br /></p><blockquote><p>booting from ISO 首次启动，整个系统都在内存中。</p><p><br /></p><p>执行ros install后，安装bootloader和initrd/vmlinuz到磁盘。</p><p><br /></p><p>再次启动后，就是完整的运行在硬盘上的操作系统。</p></blockquote><p><br /></p><h2 id=\"c9665e1f\">脑洞</h2><p><br /></p><p>其实是正规操作，可以在 cloud config 配置自定义服务，这样装机后，就可以直接启动服务，不需要ssh到ros上，手动执行命令，例如配置rancher client的添加主机的命令，这样就可以直接添加到已有集群。 更多参考 <a href=\"https://rancher.com/docs/os/v1.x/en/installation/system-services/custom-system-services/\" target=\"_blank\">Custom System Services</a></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22yaml%22%2C%22code%22%3A%22%23cloud-config%5Cnrancher%3A%5Cn%20%20services%3A%5Cn%20%20%20%20nginxapp%3A%5Cn%20%20%20%20%20%20image%3A%20nginx%5Cn%20%20%20%20%20%20restart%3A%20always%22%7D\"></card><p><br /></p><h2 id=\"35808e79\">参考资料</h2><p><br /></p><ul><li><a href=\"http://idcos.github.io/osinstall-doc/environment/%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2.html\" target=\"_blank\">cloudboot一键部署</a></li></ul><ul><li><a href=\"http://idcos.github.io/osinstall-doc/os/PXE%E6%A8%A1%E6%9D%BF%E5%AE%9A%E5%88%B6%E8%A7%84%E8%8C%83.html\" target=\"_blank\">cloudboot PXE模板定制规范</a></li></ul><ul><li><a href=\"https://rancher.com/docs/os/v1.x/en/installation/running-rancheros/server/pxe/\" target=\"_blank\">rancheros#docs#iPXE</a></li></ul><ul><li><a href=\"https://juejin.im/post/5c748ae2f265da2d84108d71\" target=\"_blank\">006-Cobbler批量自动化部署CentOS/Ubuntu/Windows</a></li></ul><ul><li><a href=\"https://juejin.im/post/5c748b2af265da2d9262ed0f\" target=\"_blank\">007-Cobbler批量自动化部署Windows10和Server 2019</a></li></ul><p><br /></p><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-03-15T09:11:36.000Z",
    "deleted_at": null,
    "created_at": "2019-03-10T10:41:55.000Z",
    "updated_at": "2019-08-16T03:49:30.000Z",
    "published_at": "2019-03-15T09:11:36.000Z",
    "first_published_at": "2019-03-10T11:49:29.000Z",
    "word_count": 1332,
    "cover": "",
    "description": "这是坚持技术写作计划（含翻译）的第10篇，定个小目标999，每周最少2篇。本文主要讲解如何使用cloudboot简单批量安装rancheros。介绍cloudbootcloudboot是 云霁科技 科技开源的一款简单易用的装机系统，类似 cobbler ,但是功能更强大，更易用。(可参考我之前...",
    "custom_description": "本文主要讲解如何使用cloudboot批量安装rancheros。",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1340064,
    "slug": "sentinel-timestamp",
    "title": "009-时间不同步导致Sentinel监控异常",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-03-07 19:10:00<br />tags: [spring boot,spring cloud,sentinel,hystrix,微服务,熔断]<br />categories: 微服务<br />---\n\n> 这是坚持技术写作计划（含翻译）的第9篇，定个小目标999，每周最少2篇。\n\n\n<a name=\"d96ebbc8\"></a>\n## 背景描述\n\n在公司测试服务器调试[ahas](https://www.aliyun.com/product/ahas)（Sentinel商业版）时，发现频发性无规律的出现Ahas控制台【监控详情】不显示,甚至应用直接消失的问题。\n\n开始以为是非Spring boot应用的问题(因为另外一个产品线是spring boot的，测试没问题)，反复翻看开源[sentinel的wiki](https://github.com/alibaba/Sentinel/wiki)和[商业ahas的帮助文档](https://help.aliyun.com/product/87450.html) ,并且结合Sentinel的日志排查，毫无头绪。但是换成开源的Sentinel Dashboard没问题\n\n<a name=\"7f539a3d\"></a>\n## 解决步骤\n\n<a name=\"fa18035d\"></a>\n### 问题原因\n\n上文提到的，Spring boot 可以，是因为其部署在阿里云ecs上，而阿里云主机默认都有ntp同步\n\n而测试机连Sentinel 的Dashboard没问题，换成ahas就有问题，是因为 Sentinel的client和dashboard，部署在同一台服务器，不存在时间差问题。\n\n后来通过 [@乐有](#) 和 [@云寅](#) 的帮助，定位到时钟问题, 据 @乐有 介绍Sentinel允许的最大时间误差是30s，而实验中，测试机和北京时间误差超过55s。\n\n\n<a name=\"1b69cacb\"></a>\n### windows 自动同步时间及修改同步频率\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1551944444938-feeadc19-7e4d-4b5a-8783-b8758668e48e.png#align=left&display=inline&height=595&originHeight=595&originWidth=538&status=done&width=538)\n\n如果同步出错，可以重启一下 `Windows Time` 服务，再次同步。\n\n但是过了半天后，时钟又差1分钟，所以需要调整一下NTP同步频率<br />打开注册表，找到 `SpecialPollInterval` (<br />`HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\W32Time\\TimeProviders\\NtpClien\\SpecialPollInterval` )\n\n发现默认值是十六进制 `93a80` ，换成10进制是 `604800` (7天*24小时*60分钟*60秒=604800)，间隔太长了 ,改成300(5分钟*60秒)即可。\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [Sentinel#Wiki#FAQ](https://github.com/alibaba/Sentinel/wiki/FAQ#q-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%8E%A7%E5%88%B6%E5%8F%B0%E4%B8%8D%E5%9C%A8%E4%B8%80%E5%8F%B0%E6%9C%BA%E5%99%A8%E4%B8%8A%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%88%90%E5%8A%9F%E6%8E%A5%E5%85%A5%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%90%8E%E6%8E%A7%E5%88%B6%E5%8F%B0%E6%97%A0%E6%B3%95%E6%98%BE%E7%A4%BA%E5%AE%9E%E6%97%B6%E7%9A%84%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE%E4%BD%86%E7%B0%87%E7%82%B9%E9%93%BE%E8%B7%AF%E9%A1%B5%E9%9D%A2%E6%9C%89%E5%AE%9E%E6%97%B6%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%BA-0)\n- [配置Windows实例NTP服务](https://help.aliyun.com/document_detail/51890.html?spm=a2c4g.11186623.6.664.6ab468b6AQsVAL)\n- [使用阿里云NTP服务器](https://help.aliyun.com/document_detail/92704.html?spm=a2c4g.11186623.6.663.284f49eaBjyUPf)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。\n\n长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n",
    "body_draft": "",
    "body_html": "<p><span>date: 2019-03-07 19:10:00</span></p><p>tags: [spring boot,spring cloud,sentinel,hystrix,微服务,熔断]</p><p>categories: 微服务</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第9篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><h2 id=\"d96ebbc8\">背景描述</h2><p><br /></p><p>在公司测试服务器调试<a href=\"https://www.aliyun.com/product/ahas\" target=\"_blank\">ahas</a>（<span>Sentinel商业版</span>）时，发现频发性<span>无规律</span>的出现Ahas控制台【监控详情】不显示,甚至应用直接消失的问题。</p><p><br /></p><p>开始以为是非Spring boot应用的问题(因为另外一个产品线是spring boot的，测试没问题)，反复翻看开源<a href=\"https://github.com/alibaba/Sentinel/wiki\" target=\"_blank\">sentinel的wiki</a>和<a href=\"https://help.aliyun.com/product/87450.html\" target=\"_blank\">商业ahas的帮助文档</a> ,并且结合Sentinel的日志排查，毫无头绪。但是换成开源的Sentinel Dashboard没问题</p><p><br /></p><h2 id=\"7f539a3d\">解决步骤</h2><p><br /></p><h3 id=\"fa18035d\">问题原因</h3><p><br /></p><p><span>上文提到的，Spring boot 可以，是因为其部署在阿里云ecs上，而阿里云主机默认都有ntp同步</span></p><p><span><br /></span></p><p><span>而测试机连Sentinel 的Dashboard没问题，换成ahas就有问题，是因为 Sentinel的client和dashboard，部署在同一台</span><span>服务器，不存在时间差问题。</span></p><p><br /></p><p>后来通过 <a href=\"#\">@乐有</a> 和 <a href=\"#\">@云寅</a> 的帮助，定位到时钟问题, 据 @乐有 介绍Sentinel允许的最大时间误差是30s，而实验中，测试机和北京时间误差超过55s。</p><p><br /></p><p><br /></p><h3 id=\"1b69cacb\">windows 自动同步时间及修改同步频率</h3><p><br /></p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1551944444938-feeadc19-7e4d-4b5a-8783-b8758668e48e.png#align=left&amp;display=inline&amp;height=595&amp;originHeight=595&amp;originWidth=538&amp;status=done&amp;width=538\" style=\"max-width: 600px; width: 538px;\" /></p><p><br /></p><p>如果同步出错，可以重启一下 <code>Windows Time</code> 服务，再次同步。</p><p><br /></p><p>但是过了半天后，时钟又差1分钟，所以需要调整一下NTP同步频率</p><p>打开注册表，找到 `<span class=\"lake-fontsize-12\" style=\"color: #4F4F4F;\">SpecialPollInterval</span>` (</p><p>`<span class=\"lake-fontsize-12\" style=\"color: #4F4F4F;\">HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\W32Time\\TimeProviders\\NtpClien\\SpecialPollInterval</span>` )</p><p><br /></p><p>发现默认值是十六进制 <code>93a80</code> ，换成10进制是 <code>604800</code> (7天*24小时*60分钟*60秒=604800)，间隔太长了 ,改成300(5分钟*60秒)即可。</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://github.com/alibaba/Sentinel/wiki/FAQ#q-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%8E%A7%E5%88%B6%E5%8F%B0%E4%B8%8D%E5%9C%A8%E4%B8%80%E5%8F%B0%E6%9C%BA%E5%99%A8%E4%B8%8A%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%88%90%E5%8A%9F%E6%8E%A5%E5%85%A5%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%90%8E%E6%8E%A7%E5%88%B6%E5%8F%B0%E6%97%A0%E6%B3%95%E6%98%BE%E7%A4%BA%E5%AE%9E%E6%97%B6%E7%9A%84%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE%E4%BD%86%E7%B0%87%E7%82%B9%E9%93%BE%E8%B7%AF%E9%A1%B5%E9%9D%A2%E6%9C%89%E5%AE%9E%E6%97%B6%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%BA-0\" target=\"_blank\">Sentinel#Wiki#FAQ</a></li><li><a href=\"https://help.aliyun.com/document_detail/51890.html?spm=a2c4g.11186623.6.664.6ab468b6AQsVAL\" target=\"_blank\">配置Windows实例NTP服务</a></li><li><a href=\"https://help.aliyun.com/document_detail/92704.html?spm=a2c4g.11186623.6.663.284f49eaBjyUPf\" target=\"_blank\">使用阿里云NTP服务器</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "body_lake": "<!doctype lake><p><span>date: 2019-03-07 19:10:00</span></p><p>tags: [spring boot,spring cloud,sentinel,hystrix,微服务,熔断]</p><p>categories: 微服务</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第9篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><h2 id=\"d96ebbc8\">背景描述</h2><p><br /></p><p>在公司测试服务器调试<a href=\"https://www.aliyun.com/product/ahas\" target=\"_blank\">ahas</a>（<span>Sentinel商业版</span>）时，发现频发性<span>无规律</span>的出现Ahas控制台【监控详情】不显示,甚至应用直接消失的问题。</p><p><br /></p><p>开始以为是非Spring boot应用的问题(因为另外一个产品线是spring boot的，测试没问题)，反复翻看开源<a href=\"https://github.com/alibaba/Sentinel/wiki\" target=\"_blank\">sentinel的wiki</a>和<a href=\"https://help.aliyun.com/product/87450.html\" target=\"_blank\">商业ahas的帮助文档</a> ,并且结合Sentinel的日志排查，毫无头绪。但是换成开源的Sentinel Dashboard没问题</p><p><br /></p><h2 id=\"7f539a3d\">解决步骤</h2><p><br /></p><h3 id=\"fa18035d\">问题原因</h3><p><br /></p><p><span>上文提到的，Spring boot 可以，是因为其部署在阿里云ecs上，而阿里云主机默认都有ntp同步</span></p><p><span><br /></span></p><p><span>而测试机连Sentinel 的Dashboard没问题，换成ahas就有问题，是因为 Sentinel的client和dashboard，部署在同一台</span><span>服务器，不存在时间差问题。</span></p><p><br /></p><p>后来通过 <card type=\"inline\" name=\"mention\" value=\"data:%7B%22login%22%3A%22%22%2C%22name%22%3A%22%E4%B9%90%E6%9C%89%22%7D\"></card> 和 <card type=\"inline\" name=\"mention\" value=\"data:%7B%22login%22%3A%22%22%2C%22name%22%3A%22%E4%BA%91%E5%AF%85%22%7D\"></card> 的帮助，定位到时钟问题, 据 @乐有 介绍Sentinel允许的最大时间误差是30s，而实验中，测试机和北京时间误差超过55s。</p><p><br /></p><p><br /></p><h3 id=\"1b69cacb\">windows 自动同步时间及修改同步频率</h3><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1551944444938-feeadc19-7e4d-4b5a-8783-b8758668e48e.png%22%2C%22originWidth%22%3A538%2C%22originHeight%22%3A595%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A538%2C%22height%22%3A595%7D\"></card></p><p><br /></p><p>如果同步出错，可以重启一下 <code>Windows Time</code> 服务，再次同步。</p><p><br /></p><p>但是过了半天后，时钟又差1分钟，所以需要调整一下NTP同步频率</p><p>打开注册表，找到 `<span class=\"lake-fontsize-12\" style=\"color: #4F4F4F;\">SpecialPollInterval</span>` (</p><p>`<span class=\"lake-fontsize-12\" style=\"color: #4F4F4F;\">HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\W32Time\\TimeProviders\\NtpClien\\SpecialPollInterval</span>` )</p><p><br /></p><p>发现默认值是十六进制 <code>93a80</code> ，换成10进制是 <code>604800</code> (7天*24小时*60分钟*60秒=604800)，间隔太长了 ,改成300(5分钟*60秒)即可。<cursor /></p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://github.com/alibaba/Sentinel/wiki/FAQ#q-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%8E%A7%E5%88%B6%E5%8F%B0%E4%B8%8D%E5%9C%A8%E4%B8%80%E5%8F%B0%E6%9C%BA%E5%99%A8%E4%B8%8A%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%88%90%E5%8A%9F%E6%8E%A5%E5%85%A5%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%90%8E%E6%8E%A7%E5%88%B6%E5%8F%B0%E6%97%A0%E6%B3%95%E6%98%BE%E7%A4%BA%E5%AE%9E%E6%97%B6%E7%9A%84%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE%E4%BD%86%E7%B0%87%E7%82%B9%E9%93%BE%E8%B7%AF%E9%A1%B5%E9%9D%A2%E6%9C%89%E5%AE%9E%E6%97%B6%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%BA-0\" target=\"_blank\">Sentinel#Wiki#FAQ</a></li><li><a href=\"https://help.aliyun.com/document_detail/51890.html?spm=a2c4g.11186623.6.664.6ab468b6AQsVAL\" target=\"_blank\">配置Windows实例NTP服务</a></li><li><a href=\"https://help.aliyun.com/document_detail/92704.html?spm=a2c4g.11186623.6.663.284f49eaBjyUPf\" target=\"_blank\">使用阿里云NTP服务器</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-03-10T10:18:19.000Z",
    "deleted_at": null,
    "created_at": "2019-03-07T11:05:54.000Z",
    "updated_at": "2019-03-10T10:18:19.000Z",
    "published_at": "2019-03-10T10:18:19.000Z",
    "first_published_at": "2019-03-07T11:56:58.000Z",
    "word_count": 521,
    "cover": "",
    "description": "date: 2019-03-07 19:10:00tags: [spring boot,spring cloud,sentinel,hystrix,微服务,熔断]categories: 微服务---这是坚持技术写作计划（含翻译）的第9篇，定个小目标999，每周最少2篇。背景描述在公司测试服务器...",
    "custom_description": "在公司测试服务器调试ahas（Sentinel商业版）时，发现频发性无规律的出现Ahas控制台【监控详情】不显示,甚至应用直接消失的问题。\n\n开始以为是非Spring boot应用的问题(因为另外一个产品线是spring boot的，测试没问题)，反复翻看开源sentinel的wiki和商业ah",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1329366,
    "slug": "sentinel-restful",
    "title": "008-Sentinel清洗RESTful的@PathVariable",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-03-05 18:30:00<br />tags: [spring boot,spring cloud,sentinel,hystrix,微服务,熔断]<br />categories: 微服务<br />---\n\n> 这是坚持技术写作计划（含翻译）的第8篇，定个小目标999，每周最少2篇。\n\n\n前段时间的文章多是运维方面的，最近放出一波后端相关的。\n\n<a name=\"8e1b944f\"></a>\n## 背景\n最近开始使用Sentinel进行流量保护，但是默认的web servlet filter是拦截全部http请求。在传统的项目中问题不大。但是如果项目中用了Spring MVC，并且用了@PathVariable就尴尬了。<br />比如 uri pattern是  `/foo/{id}` ,而从Sentinel监控看 `/foo/1` 和 `/foo/2` 就是两个资源了，并且Sentinel最大支持6000个资源，再多就不生效了。\n\n<a name=\"81c1dff6\"></a>\n## 解决办法\n\n<a name=\"beee100b\"></a>\n### 官方给的方案是:UrlCleaner\n\n```java\n WebCallbackManager.setUrlCleaner(new UrlCleaner() {\n            @Override\n            public String clean(String originUrl) {\n                if (originUrl.startsWith(fooPrefix)) {\n                    return \"/foo/*\";\n                }\n                return originUrl;\n            }\n        });\n```\n但是想想就吐， `/v1/{foo}/{bar}/qux/{baz}` 这种的来个20来个，截一个我看看。\n\n<a name=\"AOP\"></a>\n### AOP\n换种思路，uri pattern难搞，用笨办法 aop总行吧？答案是可以的。\n\n```java\n@Aspect\npublic class SentinelResourceAspect {\n    @Pointcut(\"within(com.anjia.*.web.rest..*)\")\n    public void sentinelResourcePackagePointcut() {\n        // Method is empty as this is just a Pointcut, the implementations are\n        // in the advices.\n    }\n    @Around(\"sentinelResourcePackagePointcut()\")\n    public Object sentinelResourceAround(ProceedingJoinPoint joinPoint) throws Throwable {\n        Entry entry = null;\n        // 务必保证finally会被执行\n        try {\n          // 资源名可使用任意有业务语义的字符串\n          // 注意此处只是类名#方法名，方法重载是合并的，如果需要进行区分，\n          // 可以获取参数类型加入到资源名称上\n          entry = SphU.entry(joinPoint.getSignature().getDeclaringTypeName()+\n                             \"#\"+joinPoint.getSignature().getName());\n          // 被保护的业务逻辑\n          // do something...\n        } catch (BlockException ex) {\n          // 资源访问阻止，被限流或被降级\n          // 进行相应的处理操作\n        } finally {\n          if (entry != null) {\n            entry.exit();\n          }\n        }\n        return result;\n    }\n}\n```\n\n\n<a name=\"f7ae864d\"></a>\n### 拦截器\n温习一下 Spring mvc的执行流程 `doFilter -> doService -> dispatcher -> preHandle -> controller -> postHandle -> afterCompletion -> filterAfter` \n\n核心的是 `String pattern = (String) request.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE);` 但是是在dispatcher阶段才赋值的，所以在CommFilter是取不到的，所以导致使用官方的Filter是不行的。只能用拦截器\n\n```java\n\nimport com.alibaba.csp.sentinel.EntryType;\nimport com.alibaba.csp.sentinel.SphU;\nimport com.alibaba.csp.sentinel.adapter.servlet.callback.RequestOriginParser;\nimport com.alibaba.csp.sentinel.adapter.servlet.callback.UrlCleaner;\nimport com.alibaba.csp.sentinel.adapter.servlet.callback.WebCallbackManager;\nimport com.alibaba.csp.sentinel.adapter.servlet.util.FilterUtil;\nimport com.alibaba.csp.sentinel.context.ContextUtil;\nimport com.alibaba.csp.sentinel.log.RecordLog;\nimport com.alibaba.csp.sentinel.slots.block.BlockException;\nimport com.alibaba.csp.sentinel.util.StringUtil;\nimport org.apache.commons.lang3.StringUtils;\nimport org.springframework.web.servlet.HandlerInterceptor;\nimport org.springframework.web.servlet.HandlerMapping;\nimport org.springframework.web.servlet.ModelAndView;\n\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\n\n@Component\npublic class SentinelHandlerInterceptor implements HandlerInterceptor {\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n        String origin = parseOrigin(request);\n        String pattern = (String) request.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE);\n        String uriTarget = StringUtils.defaultString(pattern,FilterUtil.filterTarget(request));\n        try {\n            // Clean and unify the URL.\n            // For REST APIs, you have to clean the URL (e.g. `/foo/1` and `/foo/2` -> `/foo/:id`), or\n            // the amount of context and resources will exceed the threshold.\n            UrlCleaner urlCleaner = WebCallbackManager.getUrlCleaner();\n            if (urlCleaner != null) {\n                uriTarget = urlCleaner.clean(uriTarget);\n            }\n            RecordLog.info(String.format(\"[Sentinel Pre Filter] Origin: %s enter Uri Path: %s\", origin, uriTarget));\n            SphU.entry(uriTarget, EntryType.IN);\n            return true;\n        } catch (BlockException ex) {\n            RecordLog.warn(String.format(\"[Sentinel Pre Filter] Block Exception when Origin: %s enter fall back uri: %s\", origin, uriTarget), ex);\n            WebCallbackManager.getUrlBlockHandler().blocked(request, response, ex);\n            return false;\n        }\n    }\n\n    @Override\n    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {\n        while (ContextUtil.getContext() != null && ContextUtil.getContext().getCurEntry() != null) {\n            ContextUtil.getContext().getCurEntry().exit();\n        }\n        ContextUtil.exit();\n    }\n\n    @Override\n    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {\n\n    }\n\n    private String parseOrigin(HttpServletRequest request) {\n        RequestOriginParser originParser = WebCallbackManager.getRequestOriginParser();\n        String origin = EMPTY_ORIGIN;\n        if (originParser != null) {\n            origin = originParser.parseOrigin(request);\n            if (StringUtil.isEmpty(origin)) {\n                return EMPTY_ORIGIN;\n            }\n        }\n        return origin;\n    }\n\n\n    private static final String EMPTY_ORIGIN = \"\";\n}\n\n```\n\n```java\n\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.web.servlet.config.annotation.InterceptorRegistry;\nimport org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport;\n\n@Configuration\npublic class WebConfig extends WebMvcConfigurerAdapter {\n    @Inject\n    SentinelHandlerInterceptor sentinelHandlerInterceptor;\n\n    @Override\n    public void addInterceptors(InterceptorRegistry registry) {\n        registry.addInterceptor(sentinelHandlerInterceptor);\n    }\n}\n\n```\n\n<a name=\"999b84d8\"></a>\n## UrlBlockHandler和UrlCleaner和WebServletConfig.setBlockPage(blockPage)\n上面说过，UrlCleaner是为了归并请求，清洗url用的。而UrlBlockHandler是在被拦截后的默认处理器。但是clean和handler都不是链式的，所以如果有多种处理，需要自己在一个方法里，进行逻辑判断。\n\nUrlCleaner\n```java\n WebCallbackManager.setUrlCleaner(new UrlCleaner() {\n            @Override\n            public String clean(String originUrl) {\n                if (originUrl.startsWith(fooPrefix)) {\n                    return \"/foo/*\";\n                }\n                return originUrl;\n            }\n        });\n```\n\nUrlBlockHandler<br />如果通用一点的，可以自己根据request的 content-type进行自适应返回内容(PLAN_TEXT和JSON)\n\n```java\nWebCallbackManager.setUrlBlockHandler((request, response, ex) -> {\n    response.addHeader(\"Content-Type\",\"application/json;charset=UTF-8\");\n    PrintWriter out = response.getWriter();\n    out.print(\"{\\\"code\\\"\":429,\\\"msg\\\":\\\"系统繁忙，请稍后重试\\\"\"}\");\n    out.flush();\n    out.close();\n});\n```\n\nWebServletConfig.setBlockPage(blockPage)\n```java\nWebServletConfig.setBlockPage(\"http://www.baidu.com\")\n```\n\n注意，三个方法都不是不支持调用链，比如我写两个UrlBlockHandler,只认最后一个。\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [wiki/主流框架的适配#web-servlet](https://github.com/alibaba/Sentinel/wiki/主流框架的适配#web-servlet)\n- [issues#](https://github.com/alibaba/Sentinel/issues/286)[REST API pattern UrlCleaner同一处理](https://github.com/alibaba/Sentinel/issues/286)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。\n\n长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n",
    "body_draft": "",
    "body_html": "<p>date: 2019-03-05 18:30:00</p><p>tags: [spring boot,spring cloud,sentinel,hystrix,微服务,熔断]</p><p>categories: 微服务</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第8篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>前段时间的文章多是运维方面的，最近放出一波后端相关的。</p><p><br /></p><h2 id=\"8e1b944f\">背景</h2><p>最近开始使用Sentinel进行流量保护，但是默认的web servlet filter是拦截全部http请求。在传统的项目中问题不大。但是如果项目中用了Spring MVC，并且用了@PathVariable就尴尬了。</p><p>比如 uri pattern是  <code>/foo/{id}</code> ,而从Sentinel监控看 <code>/foo/1</code> 和 <code>/foo/2</code> 就是两个资源了，并且Sentinel最大支持6000个资源，再多就不生效了。</p><p><br /></p><h2 id=\"81c1dff6\">解决办法</h2><p><br /></p><h3 id=\"beee100b\">官方给的方案是:UrlCleaner</h3><p><br /></p><pre data-lang=\"java\"><code> WebCallbackManager.setUrlCleaner(new UrlCleaner() {\n            @Override\n            public String clean(String originUrl) {\n                if (originUrl.startsWith(fooPrefix)) {\n                    return &quot;/foo/*&quot;;\n                }\n                return originUrl;\n            }\n        });</code></pre><p>但是想想就吐， <code>/v1/{foo}/{bar}/qux/{baz}</code> 这种的来个20来个，截一个我看看。</p><p><br /></p><h3 id=\"AOP\">AOP</h3><p>换种思路，uri pattern难搞，用笨办法 aop总行吧<span>？</span>答案是可以的。</p><p><br /></p><pre data-lang=\"java\"><code>@Aspect\npublic class SentinelResourceAspect {\n    @Pointcut(&quot;within(com.anjia.*.web.rest..*)&quot;)\n    public void sentinelResourcePackagePointcut() {\n        // Method is empty as this is just a Pointcut, the implementations are\n        // in the advices.\n    }\n    @Around(&quot;sentinelResourcePackagePointcut()&quot;)\n    public Object sentinelResourceAround(ProceedingJoinPoint joinPoint) throws Throwable {\n        Entry entry = null;\n        // 务必保证finally会被执行\n        try {\n          // 资源名可使用任意有业务语义的字符串\n          // 注意此处只是类名#方法名，方法重载是合并的，如果需要进行区分，\n          // 可以获取参数类型加入到资源名称上\n          entry = SphU.entry(joinPoint.getSignature().getDeclaringTypeName()+\n                             &quot;#&quot;+joinPoint.getSignature().getName());\n          // 被保护的业务逻辑\n          // do something...\n        } catch (BlockException ex) {\n          // 资源访问阻止，被限流或被降级\n          // 进行相应的处理操作\n        } finally {\n          if (entry != null) {\n            entry.exit();\n          }\n        }\n        return result;\n    }\n}</code></pre><p><br /></p><p><br /></p><h3 id=\"f7ae864d\">拦截器</h3><p>温习一下 Spring mvc的执行流程 <code>doFilter -&gt; doService -&gt; dispatcher -&gt; preHandle -&gt; controller -&gt; postHandle -&gt; afterCompletion -&gt; filterAfter</code> </p><p><br /></p><p>核心的是 <code>String pattern = (String) request.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE);</code> 但是是在dispatcher阶段才赋值的，所以在CommFilter是取不到的，所以导致使用官方的Filter是不行的。只能用拦截器</p><p><span style=\"color: #24292E;\"><br /></span></p><pre data-lang=\"java\"><code>\nimport com.alibaba.csp.sentinel.EntryType;\nimport com.alibaba.csp.sentinel.SphU;\nimport com.alibaba.csp.sentinel.adapter.servlet.callback.RequestOriginParser;\nimport com.alibaba.csp.sentinel.adapter.servlet.callback.UrlCleaner;\nimport com.alibaba.csp.sentinel.adapter.servlet.callback.WebCallbackManager;\nimport com.alibaba.csp.sentinel.adapter.servlet.util.FilterUtil;\nimport com.alibaba.csp.sentinel.context.ContextUtil;\nimport com.alibaba.csp.sentinel.log.RecordLog;\nimport com.alibaba.csp.sentinel.slots.block.BlockException;\nimport com.alibaba.csp.sentinel.util.StringUtil;\nimport org.apache.commons.lang3.StringUtils;\nimport org.springframework.web.servlet.HandlerInterceptor;\nimport org.springframework.web.servlet.HandlerMapping;\nimport org.springframework.web.servlet.ModelAndView;\n\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\n\n@Component\npublic class SentinelHandlerInterceptor implements HandlerInterceptor {\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n        String origin = parseOrigin(request);\n        String pattern = (String) request.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE);\n        String uriTarget = StringUtils.defaultString(pattern,FilterUtil.filterTarget(request));\n        try {\n            // Clean and unify the URL.\n            // For REST APIs, you have to clean the URL (e.g. `/foo/1` and `/foo/2` -&gt; `/foo/:id`), or\n            // the amount of context and resources will exceed the threshold.\n            UrlCleaner urlCleaner = WebCallbackManager.getUrlCleaner();\n            if (urlCleaner != null) {\n                uriTarget = urlCleaner.clean(uriTarget);\n            }\n            RecordLog.info(String.format(&quot;[Sentinel Pre Filter] Origin: %s enter Uri Path: %s&quot;, origin, uriTarget));\n            SphU.entry(uriTarget, EntryType.IN);\n            return true;\n        } catch (BlockException ex) {\n            RecordLog.warn(String.format(&quot;[Sentinel Pre Filter] Block Exception when Origin: %s enter fall back uri: %s&quot;, origin, uriTarget), ex);\n            WebCallbackManager.getUrlBlockHandler().blocked(request, response, ex);\n            return false;\n        }\n    }\n\n    @Override\n    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {\n        while (ContextUtil.getContext() != null &amp;&amp; ContextUtil.getContext().getCurEntry() != null) {\n            ContextUtil.getContext().getCurEntry().exit();\n        }\n        ContextUtil.exit();\n    }\n\n    @Override\n    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {\n\n    }\n\n    private String parseOrigin(HttpServletRequest request) {\n        RequestOriginParser originParser = WebCallbackManager.getRequestOriginParser();\n        String origin = EMPTY_ORIGIN;\n        if (originParser != null) {\n            origin = originParser.parseOrigin(request);\n            if (StringUtil.isEmpty(origin)) {\n                return EMPTY_ORIGIN;\n            }\n        }\n        return origin;\n    }\n\n\n    private static final String EMPTY_ORIGIN = &quot;&quot;;\n}\n</code></pre><p><br /></p><pre data-lang=\"java\"><code>\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.web.servlet.config.annotation.InterceptorRegistry;\nimport org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport;\n\n@Configuration\npublic class WebConfig extends WebMvcConfigurerAdapter {\n    @Inject\n    SentinelHandlerInterceptor sentinelHandlerInterceptor;\n\n    @Override\n    public void addInterceptors(InterceptorRegistry registry) {\n        registry.addInterceptor(sentinelHandlerInterceptor);\n    }\n}\n</code></pre><p><br /></p><h2 id=\"999b84d8\">UrlBlockHandler和UrlCleaner和WebServletConfig.setBlockPage(blockPage)</h2><p>上面说过，UrlCleaner是为了归并请求，清洗url用的。而UrlBlockHandler是在被拦截后的默认处理器。但是clean和handler都不是链式的，所以如果有多种处理，需要自己在一个方法里，进行逻辑判断。</p><p><br /></p><p>UrlCleaner</p><pre data-lang=\"java\"><code> WebCallbackManager.setUrlCleaner(new UrlCleaner() {\n            @Override\n            public String clean(String originUrl) {\n                if (originUrl.startsWith(fooPrefix)) {\n                    return &quot;/foo/*&quot;;\n                }\n                return originUrl;\n            }\n        });</code></pre><p><br /></p><p><span>UrlBlockHandler</span></p><p>如果通用一点的，可以自己根据request的 content-type进行自适应返回内容(PLAN_TEXT和JSON)</p><p><br /></p><pre data-lang=\"java\"><code>WebCallbackManager.setUrlBlockHandler((request, response, ex) -&gt; {\n    response.addHeader(&quot;Content-Type&quot;,&quot;application/json;charset=UTF-8&quot;);\n    PrintWriter out = response.getWriter();\n    out.print(&quot;{\\&quot;code\\&quot;&quot;:429,\\&quot;msg\\&quot;:\\&quot;系统繁忙，请稍后重试\\&quot;&quot;}&quot;);\n    out.flush();\n    out.close();\n});</code></pre><p><br /></p><p>WebServletConfig.setBlockPage(blockPage)</p><pre data-lang=\"java\"><code>WebServletConfig.setBlockPage(&quot;http://www.baidu.com&quot;)</code></pre><p><br /></p><p>注意，三个方法都不是不支持调用链，比如我写两个UrlBlockHandler,只认最后一个。</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://github.com/alibaba/Sentinel/wiki/主流框架的适配#web-servlet\" target=\"_blank\">wiki/主流框架的适配#web-servlet</a></li><li><a href=\"https://github.com/alibaba/Sentinel/issues/286\" target=\"_blank\">issues#</a><span><a href=\"https://github.com/alibaba/Sentinel/issues/286\" target=\"_blank\">REST API pattern UrlCleaner同一处理</a></span></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "body_lake": "<!doctype lake><p>date: 2019-03-05 18:30:00</p><p>tags: [spring boot,spring cloud,sentinel,hystrix,微服务,熔断]</p><p>categories: 微服务</p><p>---</p><p><br /></p><blockquote><p>这是坚持技术写作计划（含翻译）的第8篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>前段时间的文章多是运维方面的，最近放出一波后端相关的。</p><p><br /></p><h2 id=\"8e1b944f\">背景</h2><p>最近开始使用Sentinel进行流量保护，但是默认的web servlet filter是拦截全部http请求。在传统的项目中问题不大。但是如果项目中用了Spring MVC，并且用了@PathVariable就尴尬了。</p><p>比如 uri pattern是  <code>/foo/{id}</code> ,而从Sentinel监控看 <code>/foo/1</code> 和 <code>/foo/2</code> 就是两个资源了，并且Sentinel最大支持6000个资源，再多就不生效了。</p><p><br /></p><h2 id=\"81c1dff6\">解决办法</h2><p><br /></p><h3 id=\"beee100b\">官方给的方案是:UrlCleaner</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22java%22%2C%22code%22%3A%22%20WebCallbackManager.setUrlCleaner(new%20UrlCleaner()%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%40Override%5Cn%20%20%20%20%20%20%20%20%20%20%20%20public%20String%20clean(String%20originUrl)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(originUrl.startsWith(fooPrefix))%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%5C%22%2Ffoo%2F*%5C%22%3B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20originUrl%3B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%7D)%3B%22%7D\"></card><p>但是想想就吐， <code>/v1/{foo}/{bar}/qux/{baz}</code> 这种的来个20来个，截一个我看看。</p><p><br /></p><h3 id=\"AOP\">AOP</h3><p>换种思路，uri pattern难搞，用笨办法 aop总行吧<span>？</span>答案是可以的。</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22java%22%2C%22code%22%3A%22%40Aspect%5Cnpublic%20class%20SentinelResourceAspect%20%7B%5Cn%20%20%20%20%40Pointcut(%5C%22within(com.anjia.*.web.rest..*)%5C%22)%5Cn%20%20%20%20public%20void%20sentinelResourcePackagePointcut()%20%7B%5Cn%20%20%20%20%20%20%20%20%2F%2F%20Method%20is%20empty%20as%20this%20is%20just%20a%20Pointcut%2C%20the%20implementations%20are%5Cn%20%20%20%20%20%20%20%20%2F%2F%20in%20the%20advices.%5Cn%20%20%20%20%7D%5Cn%20%20%20%20%40Around(%5C%22sentinelResourcePackagePointcut()%5C%22)%5Cn%20%20%20%20public%20Object%20sentinelResourceAround(ProceedingJoinPoint%20joinPoint)%20throws%20Throwable%20%7B%5Cn%20%20%20%20%20%20%20%20Entry%20entry%20%3D%20null%3B%5Cn%20%20%20%20%20%20%20%20%2F%2F%20%E5%8A%A1%E5%BF%85%E4%BF%9D%E8%AF%81finally%E4%BC%9A%E8%A2%AB%E6%89%A7%E8%A1%8C%5Cn%20%20%20%20%20%20%20%20try%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%B5%84%E6%BA%90%E5%90%8D%E5%8F%AF%E4%BD%BF%E7%94%A8%E4%BB%BB%E6%84%8F%E6%9C%89%E4%B8%9A%E5%8A%A1%E8%AF%AD%E4%B9%89%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%5Cn%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%B3%A8%E6%84%8F%E6%AD%A4%E5%A4%84%E5%8F%AA%E6%98%AF%E7%B1%BB%E5%90%8D%23%E6%96%B9%E6%B3%95%E5%90%8D%EF%BC%8C%E6%96%B9%E6%B3%95%E9%87%8D%E8%BD%BD%E6%98%AF%E5%90%88%E5%B9%B6%E7%9A%84%EF%BC%8C%E5%A6%82%E6%9E%9C%E9%9C%80%E8%A6%81%E8%BF%9B%E8%A1%8C%E5%8C%BA%E5%88%86%EF%BC%8C%5Cn%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%8F%AF%E4%BB%A5%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B%E5%8A%A0%E5%85%A5%E5%88%B0%E8%B5%84%E6%BA%90%E5%90%8D%E7%A7%B0%E4%B8%8A%5Cn%20%20%20%20%20%20%20%20%20%20entry%20%3D%20SphU.entry(joinPoint.getSignature().getDeclaringTypeName()%2B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%22%23%5C%22%2BjoinPoint.getSignature().getName())%3B%5Cn%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%A2%AB%E4%BF%9D%E6%8A%A4%E7%9A%84%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%5Cn%20%20%20%20%20%20%20%20%20%20%2F%2F%20do%20something...%5Cn%20%20%20%20%20%20%20%20%7D%20catch%20(BlockException%20ex)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%B5%84%E6%BA%90%E8%AE%BF%E9%97%AE%E9%98%BB%E6%AD%A2%EF%BC%8C%E8%A2%AB%E9%99%90%E6%B5%81%E6%88%96%E8%A2%AB%E9%99%8D%E7%BA%A7%5Cn%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%BF%9B%E8%A1%8C%E7%9B%B8%E5%BA%94%E7%9A%84%E5%A4%84%E7%90%86%E6%93%8D%E4%BD%9C%5Cn%20%20%20%20%20%20%20%20%7D%20finally%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20if%20(entry%20!%3D%20null)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20entry.exit()%3B%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20return%20result%3B%5Cn%20%20%20%20%7D%5Cn%7D%22%7D\"></card><p><br /></p><p><br /></p><h3 id=\"f7ae864d\">拦截器</h3><p>温习一下 Spring mvc的执行流程 <code>doFilter -&gt; doService -&gt; dispatcher -&gt; preHandle -&gt; controller -&gt; postHandle -&gt; afterCompletion -&gt; filterAfter</code> </p><p><br /></p><p>核心的是 <code>String pattern = (String) request.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE);</code> 但是是在dispatcher阶段才赋值的，所以在CommFilter是取不到的，所以导致使用官方的Filter是不行的。只能用拦截器</p><p><span style=\"color: #24292E;\"><br /></span></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22java%22%2C%22code%22%3A%22%5Cnimport%20com.alibaba.csp.sentinel.EntryType%3B%5Cnimport%20com.alibaba.csp.sentinel.SphU%3B%5Cnimport%20com.alibaba.csp.sentinel.adapter.servlet.callback.RequestOriginParser%3B%5Cnimport%20com.alibaba.csp.sentinel.adapter.servlet.callback.UrlCleaner%3B%5Cnimport%20com.alibaba.csp.sentinel.adapter.servlet.callback.WebCallbackManager%3B%5Cnimport%20com.alibaba.csp.sentinel.adapter.servlet.util.FilterUtil%3B%5Cnimport%20com.alibaba.csp.sentinel.context.ContextUtil%3B%5Cnimport%20com.alibaba.csp.sentinel.log.RecordLog%3B%5Cnimport%20com.alibaba.csp.sentinel.slots.block.BlockException%3B%5Cnimport%20com.alibaba.csp.sentinel.util.StringUtil%3B%5Cnimport%20org.apache.commons.lang3.StringUtils%3B%5Cnimport%20org.springframework.web.servlet.HandlerInterceptor%3B%5Cnimport%20org.springframework.web.servlet.HandlerMapping%3B%5Cnimport%20org.springframework.web.servlet.ModelAndView%3B%5Cn%5Cnimport%20javax.servlet.http.HttpServletRequest%3B%5Cnimport%20javax.servlet.http.HttpServletResponse%3B%5Cn%5Cn%40Component%5Cnpublic%20class%20SentinelHandlerInterceptor%20implements%20HandlerInterceptor%20%7B%5Cn%20%20%20%20%40Override%5Cn%20%20%20%20public%20boolean%20preHandle(HttpServletRequest%20request%2C%20HttpServletResponse%20response%2C%20Object%20handler)%20throws%20Exception%20%7B%5Cn%20%20%20%20%20%20%20%20String%20origin%20%3D%20parseOrigin(request)%3B%5Cn%20%20%20%20%20%20%20%20String%20pattern%20%3D%20(String)%20request.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE)%3B%5Cn%20%20%20%20%20%20%20%20String%20uriTarget%20%3D%20StringUtils.defaultString(pattern%2CFilterUtil.filterTarget(request))%3B%5Cn%20%20%20%20%20%20%20%20try%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20Clean%20and%20unify%20the%20URL.%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20For%20REST%20APIs%2C%20you%20have%20to%20clean%20the%20URL%20(e.g.%20%60%2Ffoo%2F1%60%20and%20%60%2Ffoo%2F2%60%20-%3E%20%60%2Ffoo%2F%3Aid%60)%2C%20or%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20the%20amount%20of%20context%20and%20resources%20will%20exceed%20the%20threshold.%5Cn%20%20%20%20%20%20%20%20%20%20%20%20UrlCleaner%20urlCleaner%20%3D%20WebCallbackManager.getUrlCleaner()%3B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20if%20(urlCleaner%20!%3D%20null)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20uriTarget%20%3D%20urlCleaner.clean(uriTarget)%3B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20RecordLog.info(String.format(%5C%22%5BSentinel%20Pre%20Filter%5D%20Origin%3A%20%25s%20enter%20Uri%20Path%3A%20%25s%5C%22%2C%20origin%2C%20uriTarget))%3B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20SphU.entry(uriTarget%2C%20EntryType.IN)%3B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20return%20true%3B%5Cn%20%20%20%20%20%20%20%20%7D%20catch%20(BlockException%20ex)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20RecordLog.warn(String.format(%5C%22%5BSentinel%20Pre%20Filter%5D%20Block%20Exception%20when%20Origin%3A%20%25s%20enter%20fall%20back%20uri%3A%20%25s%5C%22%2C%20origin%2C%20uriTarget)%2C%20ex)%3B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20WebCallbackManager.getUrlBlockHandler().blocked(request%2C%20response%2C%20ex)%3B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20return%20false%3B%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D%5Cn%5Cn%20%20%20%20%40Override%5Cn%20%20%20%20public%20void%20postHandle(HttpServletRequest%20request%2C%20HttpServletResponse%20response%2C%20Object%20handler%2C%20ModelAndView%20modelAndView)%20throws%20Exception%20%7B%5Cn%20%20%20%20%20%20%20%20while%20(ContextUtil.getContext()%20!%3D%20null%20%26%26%20ContextUtil.getContext().getCurEntry()%20!%3D%20null)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20ContextUtil.getContext().getCurEntry().exit()%3B%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20ContextUtil.exit()%3B%5Cn%20%20%20%20%7D%5Cn%5Cn%20%20%20%20%40Override%5Cn%20%20%20%20public%20void%20afterCompletion(HttpServletRequest%20request%2C%20HttpServletResponse%20response%2C%20Object%20handler%2C%20Exception%20ex)%20throws%20Exception%20%7B%5Cn%5Cn%20%20%20%20%7D%5Cn%5Cn%20%20%20%20private%20String%20parseOrigin(HttpServletRequest%20request)%20%7B%5Cn%20%20%20%20%20%20%20%20RequestOriginParser%20originParser%20%3D%20WebCallbackManager.getRequestOriginParser()%3B%5Cn%20%20%20%20%20%20%20%20String%20origin%20%3D%20EMPTY_ORIGIN%3B%5Cn%20%20%20%20%20%20%20%20if%20(originParser%20!%3D%20null)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20origin%20%3D%20originParser.parseOrigin(request)%3B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20if%20(StringUtil.isEmpty(origin))%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20EMPTY_ORIGIN%3B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20return%20origin%3B%5Cn%20%20%20%20%7D%5Cn%5Cn%5Cn%20%20%20%20private%20static%20final%20String%20EMPTY_ORIGIN%20%3D%20%5C%22%5C%22%3B%5Cn%7D%5Cn%22%7D\"></card><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22java%22%2C%22code%22%3A%22%5Cnimport%20org.springframework.context.annotation.Configuration%3B%5Cnimport%20org.springframework.web.servlet.config.annotation.InterceptorRegistry%3B%5Cnimport%20org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport%3B%5Cn%5Cn%40Configuration%5Cnpublic%20class%20WebConfig%20extends%20WebMvcConfigurerAdapter%20%7B%5Cn%20%20%20%20%40Inject%5Cn%20%20%20%20SentinelHandlerInterceptor%20sentinelHandlerInterceptor%3B%5Cn%5Cn%20%20%20%20%40Override%5Cn%20%20%20%20public%20void%20addInterceptors(InterceptorRegistry%20registry)%20%7B%5Cn%20%20%20%20%20%20%20%20registry.addInterceptor(sentinelHandlerInterceptor)%3B%5Cn%20%20%20%20%7D%5Cn%7D%5Cn%22%7D\"></card><p><br /></p><h2 id=\"999b84d8\">UrlBlockHandler和UrlCleaner和WebServletConfig.setBlockPage(blockPage)</h2><p>上面说过，UrlCleaner是为了归并请求，清洗url用的。而UrlBlockHandler是在被拦截后的默认处理器。但是clean和handler都不是链式的，所以如果有多种处理，需要自己在一个方法里，进行逻辑判断。</p><p><br /></p><p>UrlCleaner</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22java%22%2C%22code%22%3A%22%20WebCallbackManager.setUrlCleaner(new%20UrlCleaner()%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%40Override%5Cn%20%20%20%20%20%20%20%20%20%20%20%20public%20String%20clean(String%20originUrl)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(originUrl.startsWith(fooPrefix))%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%5C%22%2Ffoo%2F*%5C%22%3B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20originUrl%3B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%7D)%3B%22%7D\"></card><p><br /></p><p><span>UrlBlockHandler</span></p><p>如果通用一点的，可以自己根据request的 content-type进行自适应返回内容(PLAN_TEXT和JSON)</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22java%22%2C%22code%22%3A%22WebCallbackManager.setUrlBlockHandler((request%2C%20response%2C%20ex)%20-%3E%20%7B%5Cn%20%20%20%20response.addHeader(%5C%22Content-Type%5C%22%2C%5C%22application%2Fjson%3Bcharset%3DUTF-8%5C%22)%3B%5Cn%20%20%20%20PrintWriter%20out%20%3D%20response.getWriter()%3B%5Cn%20%20%20%20out.print(%5C%22%7B%5C%5C%5C%22code%5C%5C%5C%22%5C%22%3A429%2C%5C%5C%5C%22msg%5C%5C%5C%22%3A%5C%5C%5C%22%E7%B3%BB%E7%BB%9F%E7%B9%81%E5%BF%99%EF%BC%8C%E8%AF%B7%E7%A8%8D%E5%90%8E%E9%87%8D%E8%AF%95%5C%5C%5C%22%5C%22%7D%5C%22)%3B%5Cn%20%20%20%20out.flush()%3B%5Cn%20%20%20%20out.close()%3B%5Cn%7D)%3B%22%7D\"></card><p><br /></p><p>WebServletConfig.setBlockPage(blockPage)</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22java%22%2C%22code%22%3A%22WebServletConfig.setBlockPage(%5C%22http%3A%2F%2Fwww.baidu.com%5C%22)%22%7D\"></card><p><br /></p><p>注意，三个方法都不是不支持调用链，比如我写两个UrlBlockHandler,只认最后一个。</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://github.com/alibaba/Sentinel/wiki/主流框架的适配#web-servlet\" target=\"_blank\">wiki/主流框架的适配#web-servlet<cursor /></a></li><li><a href=\"https://github.com/alibaba/Sentinel/issues/286\" target=\"_blank\">issues#</a><span><a href=\"https://github.com/alibaba/Sentinel/issues/286\" target=\"_blank\">REST API pattern UrlCleaner同一处理</a></span></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-03-06T10:41:54.000Z",
    "deleted_at": null,
    "created_at": "2019-03-05T10:29:33.000Z",
    "updated_at": "2019-03-06T10:41:54.000Z",
    "published_at": "2019-03-06T10:41:54.000Z",
    "first_published_at": "2019-03-06T02:54:55.000Z",
    "word_count": 1201,
    "cover": "",
    "description": "date: 2019-03-05 18:30:00tags: [spring boot,spring cloud,sentinel,hystrix,微服务,熔断]categories: 微服务---这是坚持技术写作计划（含翻译）的第8篇，定个小目标999，每周最少2篇。前段时间的文章多是运维方...",
    "custom_description": "最近开始使用Sentinel进行流量保护，但是默认的web servlet filter是拦截全部http请求。在传统的项目中问题不大。但是如果项目中用了Spring MVC，并且用了@PathVariable就尴尬了。\n\n比如 uri pattern是  /foo/{id} ,而从Sentinel",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1294477,
    "slug": "cobbler-win10-win-server-2019",
    "title": "007-Cobbler批量自动化部署Windows10和Server 2019",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-02-22 15:46:00<br />tags: [pxe,dhcp,cobbler,centos,ubuntu,windows,tftp,win10,server-2019]<br />categories: 运维<br />---\n\n> 这是坚持技术写作计划（含翻译）的第7篇，定个小目标999，每周最少2篇。\n\n\n本文主要讲解通过CentOS7.6 Minimal + Cobbler 自动化安装CentOS,Ubuntu,Windows 10 和 Windows Server 2019。\n\n请注意，一般安装windows是用[MDT](https://docs.microsoft.com/zh-cn/windows/deployment/deploy-windows-mdt/deploy-a-windows-10-image-using-mdt)或者WDS居多，毕竟是巨硬自己家的，而且WDT还支持分布式镜像传输（主要是巨硬家的OS，动辄超过4G，万兆网卡也会卡啊）。本文不涉及到WDT或者WDS相关操作，感兴趣的可自行百度或者msdn。\n\n<a name=\"424a2ad8\"></a>\n## 准备\n\n- [Windows ADK](https://docs.microsoft.com/zh-cn/windows-hardware/get-started/adk-install#winADK) (分别下载 [Download the Windows ADK for Windows 10, version 1809](https://go.microsoft.com/fwlink/?linkid=2026036) 和 [Download the Windows PE add-on for the ADK](https://go.microsoft.com/fwlink/?linkid=2022233))\n- 下载 [Windows 10 (business edition), version 1809 (Updated Feb 2019) (x64) - DVD (Chinese-Simplified)](http://msdn.itellyou.cn/)[ ](http://msdn.itellyou.cn/)\n- 下载 [Windows Server 2019 (x64) - DVD (Chinese-Simplified)](http://msdn.itellyou.cn/)\n\n注意，adk的两个都要下载，这俩都是引导包，真正的安装程序会由这俩软件进行下载。其中WinPE需要用到5G左右的磁盘空间，简直不能忍受。。。<br />msdn i tell u 堪称良心站，是windows装机神站啊，不过，没有直达页面挺不爽。为了防止下错，特意截图。<br />![Snipaste_2019-02-25_22-18-07.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1551104465714-66f42f29-fbcf-476f-b2e7-b1f3a6fb319b.png#align=left&display=inline&height=365&name=Snipaste_2019-02-25_22-18-07.png&originHeight=573&originWidth=1171&size=143092&status=done&width=746)\n\n<a name=\"9639c173\"></a>\n## 安装ADK和WinPE\n我已经装过，且忘记截图了，这是事后补图，只需要勾选必须的就行<br />![Snipaste_2019-02-25_22-32-48.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1551105181245-e9b47d7d-e1b3-48f8-918e-42cdff955406.png#align=left&display=inline&height=548&name=Snipaste_2019-02-25_22-32-48.png&originHeight=548&originWidth=746&size=36472&status=done&width=746)![Snipaste_2019-02-25_22-32-20.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1551105181277-4477f2fc-1cfe-414c-9178-c30ae74e725c.png#align=left&display=inline&height=548&name=Snipaste_2019-02-25_22-32-20.png&originHeight=548&originWidth=746&size=52141&status=done&width=746)\n\n安装完后，以管理员身份打开部署和映像工具环境\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1551105055491-d302cb36-bb44-4359-8fb5-c7342e9854fa.png#align=left&display=inline&height=425&name=image.png&originHeight=425&originWidth=613&size=193121&status=done&width=613)\n\n定制Win 10 PE \n\n```bash\ncopype amd64 C:\\winpe\n\nDism /mount-image /imagefile:C:\\winpe\\media\\sources\\boot.wim /index:1 /mountdir:C:\\winpe\\mount\n\necho net use z: \\\\192.168.0.253\\share >> C:\\winpe\\mount\\Windows\\System32\\startnet.cmd\necho z:\\win\\setup.exe /unattend:z:\\win\\win10_x64_bios_auto.xml >> C:\\winpe\\mount\\Windows\\System32\\startnet.cmd\n\nDism /unmount-image /mountdir:C:\\winpe\\mount /commit\nMakeWinPEMedia /ISO C:\\winpe C:\\winpe\\winpe_win10_amd64.iso\n```\n\n1. 本地生成winpe文件目录\n1. dism 挂载 winpe的启动文件到winpe的mount目录\n1. 将启动命令硬编码写死到winpe的startnet.cmd文件里\n1. 无人值守安装\n1. 卸载winpe的挂载（一定要执行，否则直接强制删除文件夹会出一些稀奇古怪的问题）\n1. 制作win10镜像，名为 winpe_win10_amd64.iso\n\n第三步的硬编码是无奈之举，因为要想挂载共享文件夹，必须要知道smb主机，但是这个参数又很难传递进来。<br />如果是U盘启动，可以写死U盘路径，大不了插上U盘后，手动改卷标(当然因为U盘挂载顺序不一致，可以通过for循环A-Z盘，挨个盘访问某个文件名，如果存在，即认为此盘是自己U盘，设置环境变量)。而网上说的，startnet.cmd调用另外一个bat，多是基于这个原理。\n\n而如果PXE要达到跟上述要求，动态设置smb主机，要么写死域名，然后劫持或者配置域名，加上bat文件，在winpe启动时，通过startnet.cmd下载，并执行。要么找办法，看看能不能在启动时，传入参数（目前我还没找到），当然还可以用MDT方案，看着比PXE+无人应答文件简单很多。\n\n<a name=\"d36faa4b\"></a>\n## 配置Cobbler Server\n\n<a name=\"42b542e5\"></a>\n### 导入Cobbler\n使用WinScp 等工具，将 winpe_win10_amd64.iso 上传到 Cobbler 服务器上\n\n```bash\n[root@localhost ~]# cobbler distro add --name=windows_10_x64 --kernel=/var/lib/tftpboot/memdisk --initrd=/root/winpe_win10_amd64.iso --kopts=\"raw iso\"\n[root@localhost ~]# touch /var/lib/cobbler/kickstarts/winpe.xml\n[root@localhost ~]# cobbler profile add --name=windows_10_x64 --distro=windows_10_x64 --kickstart=/var/lib/cobbler/kickstarts/winpe.xml\n```\n\n\n<a name=\"b15fbfd6\"></a>\n### 创建自动应答文件\n直接从 [Windows Answer File Generator#win10_x86_64](http://www.windowsafg.com/win10x86_x64.html) 通过简单配置后，下载即可（只支持简单操作，比如，装系统，格式化磁盘，设置密码等）。当然也可以使用 【Windows系统映像管理器】，不过挺难用的，具体用法可以参考 [How to create an unattended installation of Windows 10](https://www.windowscentral.com/how-create-unattended-media-do-automated-installation-windows-10)。也可以通过MDT简化操作。\n\n但是如果使用直接生成的，有点问题，即使页面设置了安装语言，但是仍旧需要手动选择，经过多方研究，发现<br />主要卡在UILanguage和Inputlocale上，全写zh-CN无效。\n```xml\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<component 此处忽略>\n  <SetupUILanguage>\n    <UILanguage>en-US</UILanguage>\n  </SetupUILanguage>\n  <InputLocale>0804:{81D4E9C9-1D3B-41BC-9E6C-4B40BF79E35E}{FA550B04-5AD7-411f-A5AC-CA038EC515D7}</InputLocale> \n  <SystemLocale>zh-CN</SystemLocale>\n  <UILanguage>zh-CN</UILanguage>\n  <UILanguageFallback>zh-CN</UILanguageFallback>\n  <UserLocale>zh-CN</UserLocale>\n</component>\n\n```\n\n另外就是安装密钥,统一替换为 VK7JG-NPHTM-C97JM-9MPGT-3V66T\n\n下面是我的应答文件，仅做参考。\n\n```bash\n<!--*************************************************\nWindows 10 Answer File Generator\nCreated using Windows AFG found at:\n;http://www.windowsafg.com\n\nInstallation Notes\nLocation: zh-CN\nNotes: Enter your comments here...\n**************************************************-->\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<unattend\n    xmlns=\"urn:schemas-microsoft-com:unattend\">\n    <settings pass=\"windowsPE\">\n        <component name=\"Microsoft-Windows-International-Core-WinPE\" processorArchitecture=\"x86\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <SetupUILanguage>\n                <UILanguage>en-US</UILanguage>\n            </SetupUILanguage>\n            <InputLocale>0804:{81D4E9C9-1D3B-41BC-9E6C-4B40BF79E35E}{FA550B04-5AD7-411f-A5AC-CA038EC515D7}</InputLocale>\n            <SystemLocale>zh-CN</SystemLocale>\n            <UILanguage>zh-CN</UILanguage>\n            <UILanguageFallback>zh-CN</UILanguageFallback>\n            <UserLocale>zh-CN</UserLocale>\n        </component>\n        <component name=\"Microsoft-Windows-International-Core-WinPE\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <SetupUILanguage>\n                <UILanguage>en-US</UILanguage>\n            </SetupUILanguage>\n            <InputLocale>0804:{81D4E9C9-1D3B-41BC-9E6C-4B40BF79E35E}{FA550B04-5AD7-411f-A5AC-CA038EC515D7}</InputLocale>\n            <SystemLocale>zh-CN</SystemLocale>\n            <UILanguage>zh-CN</UILanguage>\n            <UILanguageFallback>zh-CN</UILanguageFallback>\n            <UserLocale>zh-CN</UserLocale>\n        </component>\n        <component name=\"Microsoft-Windows-Setup\" processorArchitecture=\"x86\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <DiskConfiguration>\n                <Disk wcm:action=\"add\">\n                    <CreatePartitions>\n                        <CreatePartition wcm:action=\"add\">\n                            <Order>1</Order>\n                            <Type>Primary</Type>\n                            <Size>100</Size>\n                        </CreatePartition>\n                        <CreatePartition wcm:action=\"add\">\n                            <Extend>true</Extend>\n                            <Order>2</Order>\n                            <Type>Primary</Type>\n                        </CreatePartition>\n                    </CreatePartitions>\n                    <ModifyPartitions>\n                        <ModifyPartition wcm:action=\"add\">\n                            <Active>true</Active>\n                            <Format>NTFS</Format>\n                            <Label>System Reserved</Label>\n                            <Order>1</Order>\n                            <PartitionID>1</PartitionID>\n                            <TypeID>0x27</TypeID>\n                        </ModifyPartition>\n                        <ModifyPartition wcm:action=\"add\">\n                            <Active>true</Active>\n                            <Format>NTFS</Format>\n                            <Label>OS</Label>\n                            <Letter>C</Letter>\n                            <Order>2</Order>\n                            <PartitionID>2</PartitionID>\n                        </ModifyPartition>\n                    </ModifyPartitions>\n                    <DiskID>0</DiskID>\n                    <WillWipeDisk>true</WillWipeDisk>\n                </Disk>\n            </DiskConfiguration>\n            <ImageInstall>\n                <OSImage>\n                    <InstallTo>\n                        <DiskID>0</DiskID>\n                        <PartitionID>2</PartitionID>\n                    </InstallTo>\n                    <InstallToAvailablePartition>false</InstallToAvailablePartition>\n                </OSImage>\n            </ImageInstall>\n            <UserData>\n                <AcceptEula>true</AcceptEula>\n                <FullName>AnJia</FullName>\n                <Organization>AnJia</Organization>\n                <ProductKey>\n                    <Key>VK7JG-NPHTM-C97JM-9MPGT-3V66T</Key>\n                </ProductKey>\n            </UserData>\n        </component>\n        <component name=\"Microsoft-Windows-Setup\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <DiskConfiguration>\n                <Disk wcm:action=\"add\">\n                    <CreatePartitions>\n                        <CreatePartition wcm:action=\"add\">\n                            <Order>1</Order>\n                            <Type>Primary</Type>\n                            <Size>100</Size>\n                        </CreatePartition>\n                        <CreatePartition wcm:action=\"add\">\n                            <Extend>true</Extend>\n                            <Order>2</Order>\n                            <Type>Primary</Type>\n                        </CreatePartition>\n                    </CreatePartitions>\n                    <ModifyPartitions>\n                        <ModifyPartition wcm:action=\"add\">\n                            <Active>true</Active>\n                            <Format>NTFS</Format>\n                            <Label>System Reserved</Label>\n                            <Order>1</Order>\n                            <PartitionID>1</PartitionID>\n                            <TypeID>0x27</TypeID>\n                        </ModifyPartition>\n                        <ModifyPartition wcm:action=\"add\">\n                            <Active>true</Active>\n                            <Format>NTFS</Format>\n                            <Label>OS</Label>\n                            <Letter>C</Letter>\n                            <Order>2</Order>\n                            <PartitionID>2</PartitionID>\n                        </ModifyPartition>\n                    </ModifyPartitions>\n                    <DiskID>0</DiskID>\n                    <WillWipeDisk>true</WillWipeDisk>\n                </Disk>\n            </DiskConfiguration>\n            <ImageInstall>\n                <OSImage>\n                    <InstallTo>\n                        <DiskID>0</DiskID>\n                        <PartitionID>2</PartitionID>\n                    </InstallTo>\n                    <InstallToAvailablePartition>false</InstallToAvailablePartition>\n                </OSImage>\n            </ImageInstall>\n            <UserData>\n                <AcceptEula>true</AcceptEula>\n                <FullName>AnJia</FullName>\n                <Organization>AnJia</Organization>\n                <ProductKey>\n                    <Key>VK7JG-NPHTM-C97JM-9MPGT-3V66T</Key>\n                </ProductKey>\n            </UserData>\n        </component>\n    </settings>\n    <settings pass=\"offlineServicing\">\n        <component name=\"Microsoft-Windows-LUA-Settings\" processorArchitecture=\"x86\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <EnableLUA>false</EnableLUA>\n        </component>\n    </settings>\n    <settings pass=\"offlineServicing\">\n        <component name=\"Microsoft-Windows-LUA-Settings\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <EnableLUA>false</EnableLUA>\n        </component>\n    </settings>\n    <settings pass=\"generalize\">\n        <component name=\"Microsoft-Windows-Security-SPP\" processorArchitecture=\"x86\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <SkipRearm>1</SkipRearm>\n        </component>\n    </settings>\n    <settings pass=\"generalize\">\n        <component name=\"Microsoft-Windows-Security-SPP\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <SkipRearm>1</SkipRearm>\n        </component>\n    </settings>\n    <settings pass=\"specialize\">\n        <component name=\"Microsoft-Windows-International-Core\" processorArchitecture=\"x86\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <InputLocale>0804:{81D4E9C9-1D3B-41BC-9E6C-4B40BF79E35E}{FA550B04-5AD7-411f-A5AC-CA038EC515D7}</InputLocale>\n            <SystemLocale>zh-CN</SystemLocale>\n            <UILanguage>zh-CN</UILanguage>\n            <UILanguageFallback>zh-CN</UILanguageFallback>\n            <UserLocale>zh-CN</UserLocale>\n        </component>\n        <component name=\"Microsoft-Windows-International-Core\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <InputLocale>0804:{81D4E9C9-1D3B-41BC-9E6C-4B40BF79E35E}{FA550B04-5AD7-411f-A5AC-CA038EC515D7}</InputLocale>\n            <SystemLocale>zh-CN</SystemLocale>\n            <UILanguage>zh-CN</UILanguage>\n            <UILanguageFallback>zh-CN</UILanguageFallback>\n            <UserLocale>zh-CN</UserLocale>\n        </component>\n        <component name=\"Microsoft-Windows-Security-SPP-UX\" processorArchitecture=\"x86\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <SkipAutoActivation>true</SkipAutoActivation>\n        </component>\n        <component name=\"Microsoft-Windows-Security-SPP-UX\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <SkipAutoActivation>true</SkipAutoActivation>\n        </component>\n        <component name=\"Microsoft-Windows-SQMApi\" processorArchitecture=\"x86\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <CEIPEnabled>0</CEIPEnabled>\n        </component>\n        <component name=\"Microsoft-Windows-SQMApi\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <CEIPEnabled>0</CEIPEnabled>\n        </component>\n        <component name=\"Microsoft-Windows-Shell-Setup\" processorArchitecture=\"x86\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <ComputerName>AnJia-PC</ComputerName>\n            <ProductKey>VK7JG-NPHTM-C97JM-9MPGT-3V66T</ProductKey>\n        </component>\n        <component name=\"Microsoft-Windows-Shell-Setup\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <ComputerName>AnJia-PC</ComputerName>\n            <ProductKey>VK7JG-NPHTM-C97JM-9MPGT-3V66T</ProductKey>\n        </component>\n    </settings>\n    <settings pass=\"oobeSystem\">\n        <component name=\"Microsoft-Windows-Shell-Setup\" processorArchitecture=\"x86\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <AutoLogon>\n                <Password>\n                    <Value></Value>\n                    <PlainText>true</PlainText>\n                </Password>\n                <Enabled>true</Enabled>\n                <Username>AnJia</Username>\n            </AutoLogon>\n            <OOBE>\n                <HideEULAPage>true</HideEULAPage>\n                <HideOEMRegistrationScreen>true</HideOEMRegistrationScreen>\n                <HideOnlineAccountScreens>true</HideOnlineAccountScreens>\n                <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>\n                <NetworkLocation>Work</NetworkLocation>\n                <SkipUserOOBE>true</SkipUserOOBE>\n                <SkipMachineOOBE>true</SkipMachineOOBE>\n                <ProtectYourPC>1</ProtectYourPC>\n            </OOBE>\n            <UserAccounts>\n                <LocalAccounts>\n                    <LocalAccount wcm:action=\"add\">\n                        <Password>\n                            <Value></Value>\n                            <PlainText>true</PlainText>\n                        </Password>\n                        <Description>AnJia</Description>\n                        <DisplayName>AnJia</DisplayName>\n                        <Group>Administrators</Group>\n                        <Name>AnJia</Name>\n                    </LocalAccount>\n                </LocalAccounts>\n            </UserAccounts>\n            <RegisteredOrganization>AnJia</RegisteredOrganization>\n            <RegisteredOwner>AnJia</RegisteredOwner>\n            <DisableAutoDaylightTimeSet>false</DisableAutoDaylightTimeSet>\n            <FirstLogonCommands>\n                <SynchronousCommand wcm:action=\"add\">\n                    <Description>Control Panel View</Description>\n                    <Order>1</Order>\n                    <CommandLine>reg add \"HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ControlPanel\" /v StartupPage /t REG_DWORD /d 1 /f</CommandLine>\n                    <RequiresUserInput>true</RequiresUserInput>\n                </SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <Order>2</Order>\n                    <Description>Control Panel Icon Size</Description>\n                    <RequiresUserInput>false</RequiresUserInput>\n                    <CommandLine>reg add \"HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ControlPanel\" /v AllItemsIconView /t REG_DWORD /d 0 /f</CommandLine>\n                </SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <Order>3</Order>\n                    <RequiresUserInput>false</RequiresUserInput>\n                    <CommandLine>cmd /C wmic useraccount where name=\"AnJia\" set PasswordExpires=false</CommandLine>\n                    <Description>Password Never Expires</Description>\n                </SynchronousCommand>\n            </FirstLogonCommands>\n            <TimeZone>China Standard Time</TimeZone>\n        </component>\n        <component name=\"Microsoft-Windows-Shell-Setup\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\"\n            xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\"\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n            <AutoLogon>\n                <Password>\n                    <Value></Value>\n                    <PlainText>true</PlainText>\n                </Password>\n                <Enabled>true</Enabled>\n                <Username>AnJia</Username>\n            </AutoLogon>\n            <OOBE>\n                <HideEULAPage>true</HideEULAPage>\n                <HideOEMRegistrationScreen>true</HideOEMRegistrationScreen>\n                <HideOnlineAccountScreens>true</HideOnlineAccountScreens>\n                <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>\n                <NetworkLocation>Work</NetworkLocation>\n                <SkipUserOOBE>true</SkipUserOOBE>\n                <SkipMachineOOBE>true</SkipMachineOOBE>\n                <ProtectYourPC>1</ProtectYourPC>\n            </OOBE>\n            <UserAccounts>\n                <LocalAccounts>\n                    <LocalAccount wcm:action=\"add\">\n                        <Password>\n                            <Value></Value>\n                            <PlainText>true</PlainText>\n                        </Password>\n                        <Description>AnJia</Description>\n                        <DisplayName>AnJia</DisplayName>\n                        <Group>Administrators</Group>\n                        <Name>AnJia</Name>\n                    </LocalAccount>\n                </LocalAccounts>\n            </UserAccounts>\n            <RegisteredOrganization>AnJia</RegisteredOrganization>\n            <RegisteredOwner>AnJia</RegisteredOwner>\n            <DisableAutoDaylightTimeSet>false</DisableAutoDaylightTimeSet>\n            <FirstLogonCommands>\n                <SynchronousCommand wcm:action=\"add\">\n                    <Description>Control Panel View</Description>\n                    <Order>1</Order>\n                    <CommandLine>reg add \"HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ControlPanel\" /v StartupPage /t REG_DWORD /d 1 /f</CommandLine>\n                    <RequiresUserInput>true</RequiresUserInput>\n                </SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <Order>2</Order>\n                    <Description>Control Panel Icon Size</Description>\n                    <RequiresUserInput>false</RequiresUserInput>\n                    <CommandLine>reg add \"HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ControlPanel\" /v AllItemsIconView /t REG_DWORD /d 0 /f</CommandLine>\n                </SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <Order>3</Order>\n                    <RequiresUserInput>false</RequiresUserInput>\n                    <CommandLine>cmd /C wmic useraccount where name=\"AnJia\" set PasswordExpires=false</CommandLine>\n                    <Description>Password Never Expires</Description>\n                </SynchronousCommand>\n            </FirstLogonCommands>\n            <TimeZone>China Standard Time</TimeZone>\n        </component>\n    </settings>\n</unattend>\n```\n\n<a name=\"727af9d3\"></a>\n### 配置samba\n在Cobbler上执行\n<a name=\"0125c65d\"></a>\n#### 安装samba\n```bash\n[root@localhost ~]# yum install samba -y\n```\n<a name=\"6f1032ee\"></a>\n#### 修改smb config\n\n```bash\n[root@localhost ~]# vi /etc/samba/smb.conf\n \n# /etc/samba/smb.conf\n[global]\nlog file = /var/log/samba/log.%m\nmax log size = 5000\nsecurity = user\nguest account = nobody\nmap to guest = Bad User\nload printers = yes\ncups options = raw\n \n[share]\ncomment = share directory目录\npath = /smb/\ndirectory mask = 0755\ncreate mask = 0755\nguest ok=yes\nwritable=yes\n```\n\n<a name=\"9b9fd94f\"></a>\n#### 启动smb服务\n\n```bash\n[root@localhost ~]# service smb start\n[root@localhost ~]# systemctl enable smb\n```\n\n<a name=\"6e499122\"></a>\n#### 挂载win10系统\n通过winscp等软件将 cn_windows_10_business_edition_version_1809_updated_sept_2018_x64_dvd_84ac403f.iso 上传到cobbler服务器上,并将创建的应答文件，上传到cobbler `/smb/win/win10_x64_bios_auto.xml` \n\n```bash\n[root@localhost ~]# mkdir -p /smb/win\n[root@localhost ~]# mount -o loop,ro /tmp/cn_windows_10_business_edition_version_1809_updated_sept_2018_x64_dvd_84ac403f.iso /mnt/\n[root@localhost ~]# cp -r /mnt/* /smb/win\n[root@localhost ~]# umount /mnt/\n```\n\n<a name=\"a23d1d1f\"></a>\n### 自动化安装Windows10\n从vmware创建一台内存4G，cpu2核，磁盘60G的空盘，win10虚拟机，然后开机。记得选BIOS，别选UEFI。<br />![Snipaste_2019-02-26_00-05-00.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1551110723753-c7785e92-60be-4a90-a606-96bc92306aaa.png#align=left&display=inline&height=400&name=Snipaste_2019-02-26_00-05-00.png&originHeight=400&originWidth=720&size=5025&status=done&width=720)\n\n![Snipaste_2019-02-25_23-44-27.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1551110627345-af185562-5a0f-4b4c-98ef-68974880a6a3.png#align=left&display=inline&height=560&name=Snipaste_2019-02-25_23-44-27.png&originHeight=768&originWidth=1024&size=19684&status=done&width=746)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1551112320786-fc312bb1-ce6c-4771-864f-e8900a1aed58.png#align=left&display=inline&height=768&name=image.png&originHeight=768&originWidth=1024&size=233953&status=done&width=1024)\n\n至于如何激活，参考  [vlmcsd搭建KMS服务器，成功激活Server 2019数据中心版本，全网应是我首发](http://bbs.pcbeta.com/viewthread-1796113-1-1.html)\n\n<a name=\"31f87578\"></a>\n## Windows Server 2019\n因为2019用的也是1809版本的，所以制作步骤一样的，在此不再赘述。\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [使用Cobbler批量部署Linux和Windows：Windows系统批量安装（三）](https://www.cnblogs.com/pluse/p/8508538.html)\n- [WINPE镜像制作-startnet.cmd详解](https://blog.csdn.net/greless/article/details/52815716)\n- [Windows 中的默认输入配置文件（输入区域设置）](https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn898524(v=vs.85).aspx)\n- [Answer files (unattend.xml)](https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/update-windows-settings-and-scripts-create-your-own-answer-file-sxs)\n- [Windows Answer File Generator#win10_x86_64](http://www.windowsafg.com/win10x86_x64.html)\n- [WinPE: Mount and Customize](https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/winpe-mount-and-customize)\n- [Components](https://docs.microsoft.com/en-us/windows-hardware/customize/desktop/unattend/components-b-unattend)\n- [How to create an unattended installation of Windows 10](https://www.windowscentral.com/how-create-unattended-media-do-automated-installation-windows-10)\n-  [vlmcsd搭建KMS服务器，成功激活Server 2019数据中心版本，全网应是我首发](http://bbs.pcbeta.com/viewthread-1796113-1-1.html)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。\n\n长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n",
    "body_draft": "",
    "body_html": "<p><span>date: 2019-02-22 15:46:00</span></p><p>tags: [pxe,dhcp,cobbler,centos,ubuntu,windows,tftp,win10,server-2019]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote style=\"padding-left: 1em;\"><p>这是坚持技术写作计划（含翻译）的第7篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要讲解通过CentOS7.6 Minimal + Cobbler 自动化安装CentOS,Ubuntu,Windows 10 和 Windows Server 2019。</p><p><br /></p><p>请注意，一般安装windows是用<a href=\"https://docs.microsoft.com/zh-cn/windows/deployment/deploy-windows-mdt/deploy-a-windows-10-image-using-mdt\" target=\"_blank\">MDT</a>或者WDS居多，毕竟是巨硬自己家的，而且WDT还支持分布式镜像传输（主要是巨硬家的OS，动辄超过4G，万兆网卡也会卡啊）。本文不涉及到WDT或者WDS相关操作，感兴趣的可自行百度或者msdn。</p><p><br /></p><h2 id=\"424a2ad8\">准备</h2><ul><li><a href=\"https://docs.microsoft.com/zh-cn/windows-hardware/get-started/adk-install#winADK\" target=\"_blank\">Windows ADK</a> (分别下载 <a href=\"https://go.microsoft.com/fwlink/?linkid=2026036\" target=\"_blank\">Download the Windows ADK for Windows 10, version 1809</a> 和 <a href=\"https://go.microsoft.com/fwlink/?linkid=2022233\" target=\"_blank\">Download the Windows PE add-on for the ADK</a>)</li><li>下载 <a href=\"http://msdn.itellyou.cn/\" target=\"_blank\">Windows 10 (business edition), version 1809 (Updated Feb 2019) (x64) - DVD (Chinese-Simplified)</a><a href=\"http://msdn.itellyou.cn/\" target=\"_blank\"><span style=\"color: #333333;\"> </span></a></li><li>下载 <a href=\"http://msdn.itellyou.cn/\" target=\"_blank\"><span style=\"color: #333333;\">Windows Server 2019 (x64) - DVD (Chinese-Simplified)</span></a></li></ul><p><br /></p><p>注意，adk的两个都要下载，这俩都是引导包，真正的安装程序会由这俩软件进行下载。其中WinPE需要用到5G左右的磁盘空间，简直不能忍受。。。</p><p>msdn i tell u 堪称良心站，是windows装机神站啊，不过，没有直达页面挺不爽。为了防止下错，特意截图。</p><p><img alt=\"Snipaste_2019-02-25_22-18-07.png\" title=\"Snipaste_2019-02-25_22-18-07.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1551104465714-66f42f29-fbcf-476f-b2e7-b1f3a6fb319b.png#align=left&amp;display=inline&amp;height=365&amp;name=Snipaste_2019-02-25_22-18-07.png&amp;originHeight=573&amp;originWidth=1171&amp;size=143092&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p><br /></p><h2 id=\"9639c173\">安装ADK和WinPE</h2><p>我已经装过，且忘记截图了，这是事后补图，只需要勾选必须的就行</p><p><img alt=\"Snipaste_2019-02-25_22-32-48.png\" title=\"Snipaste_2019-02-25_22-32-48.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1551105181245-e9b47d7d-e1b3-48f8-918e-42cdff955406.png#align=left&amp;display=inline&amp;height=548&amp;name=Snipaste_2019-02-25_22-32-48.png&amp;originHeight=548&amp;originWidth=746&amp;size=36472&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /><img alt=\"Snipaste_2019-02-25_22-32-20.png\" title=\"Snipaste_2019-02-25_22-32-20.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1551105181277-4477f2fc-1cfe-414c-9178-c30ae74e725c.png#align=left&amp;display=inline&amp;height=548&amp;name=Snipaste_2019-02-25_22-32-20.png&amp;originHeight=548&amp;originWidth=746&amp;size=52141&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p><br /></p><p>安装完后，以管理员身份打开部署和映像工具环境</p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1551105055491-d302cb36-bb44-4359-8fb5-c7342e9854fa.png#align=left&amp;display=inline&amp;height=425&amp;name=image.png&amp;originHeight=425&amp;originWidth=613&amp;size=193121&amp;status=done&amp;width=613\" style=\"max-width: 600px; width: 613px;\" /></p><p><br /></p><p>定制Win 10 PE </p><p><br /></p><pre data-lang=\"bash\"><code>copype amd64 C:\\winpe\n\nDism /mount-image /imagefile:C:\\winpe\\media\\sources\\boot.wim /index:1 /mountdir:C:\\winpe\\mount\n\necho net use z: \\\\192.168.0.253\\share &gt;&gt; C:\\winpe\\mount\\Windows\\System32\\startnet.cmd\necho z:\\win\\setup.exe /unattend:z:\\win\\win10_x64_bios_auto.xml &gt;&gt; C:\\winpe\\mount\\Windows\\System32\\startnet.cmd\n\nDism /unmount-image /mountdir:C:\\winpe\\mount /commit\nMakeWinPEMedia /ISO C:\\winpe C:\\winpe\\winpe_win10_amd64.iso</code></pre><p><br /></p><ol start=\"1\"><li>本地生成winpe文件目录</li><li>dism 挂载 winpe的启动文件到winpe的mount目录</li><li>将启动命令硬编码写死到winpe的startnet.cmd文件里</li><li>无人值守安装</li><li>卸载winpe的挂载（一定要执行，否则直接强制删除文件夹会出一些稀奇古怪的问题）</li><li>制作win10镜像，名为 winpe_win10_amd64.iso</li></ol><p><br /></p><p>第三步的硬编码是无奈之举，因为要想挂载共享文件夹，必须要知道smb主机，但是这个参数又很难传递进来。</p><p>如果是U盘启动，可以写死U盘路径，大不了插上U盘后，手动改卷标(当然因为U盘挂载顺序不一致，可以通过for循环A-Z盘，挨个盘访问某个文件名，如果存在，即认为此盘是自己U盘，设置环境变量)。而网上说的，startnet.cmd调用另外一个bat，多是基于这个原理。</p><p><br /></p><p>而如果PXE要达到跟上述要求，动态设置smb主机，要么写死域名，然后劫持或者配置域名，加上bat文件，在winpe启动时，通过startnet.cmd下载，并执行。要么找办法，看看能不能在启动时，传入参数（目前我还没找到），当然还可以用MDT方案，看着比PXE+无人应答文件简单很多。</p><p><br /></p><h2 id=\"d36faa4b\">配置Cobbler Server</h2><p><br /></p><h3 id=\"42b542e5\">导入Cobbler</h3><p>使用WinScp 等工具，将 <span>winpe_win10_amd64.iso 上传到 Cobbler 服务器上</span></p><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# cobbler distro add --name=windows_10_x64 --kernel=/var/lib/tftpboot/memdisk --initrd=/root/winpe_win10_amd64.iso --kopts=&quot;raw iso&quot;\n[root@localhost ~]# touch /var/lib/cobbler/kickstarts/winpe.xml\n[root@localhost ~]# cobbler profile add --name=windows_10_x64 --distro=windows_10_x64 --kickstart=/var/lib/cobbler/kickstarts/winpe.xml</code></pre><p><br /></p><p><br /></p><h3 id=\"b15fbfd6\">创建自动应答文件</h3><p>直接从 <a href=\"http://www.windowsafg.com/win10x86_x64.html\" target=\"_blank\">Windows Answer File Generator#win10_x86_64</a> 通过简单配置后，下载即可（只支持简单操作，比如，装系统，格式化磁盘，设置密码等）。当然也可以使用 【Windows系统映像管理器<span>】</span>，不过挺难用的，具体用法可以参考 <a href=\"https://www.windowscentral.com/how-create-unattended-media-do-automated-installation-windows-10\" target=\"_blank\">How to create an unattended installation of Windows 10</a>。也可以通过MDT简化操作。</p><p><br /></p><p>但是如果使用直接生成的，有点问题，即使页面设置了安装语言，但是仍旧需要手动选择，经过多方研究，发现</p><p>主要卡在UILanguage和Inputlocale上，全写zh-CN无效。</p><pre data-lang=\"xml\"><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;\n&lt;component 此处忽略&gt;\n  &lt;SetupUILanguage&gt;\n    &lt;UILanguage&gt;en-US&lt;/UILanguage&gt;\n  &lt;/SetupUILanguage&gt;\n  &lt;InputLocale&gt;0804:{81D4E9C9-1D3B-41BC-9E6C-4B40BF79E35E}{FA550B04-5AD7-411f-A5AC-CA038EC515D7}&lt;/InputLocale&gt; \n  &lt;SystemLocale&gt;zh-CN&lt;/SystemLocale&gt;\n  &lt;UILanguage&gt;zh-CN&lt;/UILanguage&gt;\n  &lt;UILanguageFallback&gt;zh-CN&lt;/UILanguageFallback&gt;\n  &lt;UserLocale&gt;zh-CN&lt;/UserLocale&gt;\n&lt;/component&gt;\n</code></pre><p><br /></p><p>另外就是安装密钥,统一替换为 VK7JG-NPHTM-C97JM-9MPGT-3V66T</p><p><br /></p><p>下面是我的应答文件，仅做参考。</p><p><br /></p><pre data-lang=\"bash\"><code>&lt;!--*************************************************\nWindows 10 Answer File Generator\nCreated using Windows AFG found at:\n;http://www.windowsafg.com\n\nInstallation Notes\nLocation: zh-CN\nNotes: Enter your comments here...\n**************************************************--&gt;\n&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;\n&lt;unattend\n    xmlns=&quot;urn:schemas-microsoft-com:unattend&quot;&gt;\n    &lt;settings pass=&quot;windowsPE&quot;&gt;\n        &lt;component name=&quot;Microsoft-Windows-International-Core-WinPE&quot; processorArchitecture=&quot;x86&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;SetupUILanguage&gt;\n                &lt;UILanguage&gt;en-US&lt;/UILanguage&gt;\n            &lt;/SetupUILanguage&gt;\n            &lt;InputLocale&gt;0804:{81D4E9C9-1D3B-41BC-9E6C-4B40BF79E35E}{FA550B04-5AD7-411f-A5AC-CA038EC515D7}&lt;/InputLocale&gt;\n            &lt;SystemLocale&gt;zh-CN&lt;/SystemLocale&gt;\n            &lt;UILanguage&gt;zh-CN&lt;/UILanguage&gt;\n            &lt;UILanguageFallback&gt;zh-CN&lt;/UILanguageFallback&gt;\n            &lt;UserLocale&gt;zh-CN&lt;/UserLocale&gt;\n        &lt;/component&gt;\n        &lt;component name=&quot;Microsoft-Windows-International-Core-WinPE&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;SetupUILanguage&gt;\n                &lt;UILanguage&gt;en-US&lt;/UILanguage&gt;\n            &lt;/SetupUILanguage&gt;\n            &lt;InputLocale&gt;0804:{81D4E9C9-1D3B-41BC-9E6C-4B40BF79E35E}{FA550B04-5AD7-411f-A5AC-CA038EC515D7}&lt;/InputLocale&gt;\n            &lt;SystemLocale&gt;zh-CN&lt;/SystemLocale&gt;\n            &lt;UILanguage&gt;zh-CN&lt;/UILanguage&gt;\n            &lt;UILanguageFallback&gt;zh-CN&lt;/UILanguageFallback&gt;\n            &lt;UserLocale&gt;zh-CN&lt;/UserLocale&gt;\n        &lt;/component&gt;\n        &lt;component name=&quot;Microsoft-Windows-Setup&quot; processorArchitecture=&quot;x86&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;DiskConfiguration&gt;\n                &lt;Disk wcm:action=&quot;add&quot;&gt;\n                    &lt;CreatePartitions&gt;\n                        &lt;CreatePartition wcm:action=&quot;add&quot;&gt;\n                            &lt;Order&gt;1&lt;/Order&gt;\n                            &lt;Type&gt;Primary&lt;/Type&gt;\n                            &lt;Size&gt;100&lt;/Size&gt;\n                        &lt;/CreatePartition&gt;\n                        &lt;CreatePartition wcm:action=&quot;add&quot;&gt;\n                            &lt;Extend&gt;true&lt;/Extend&gt;\n                            &lt;Order&gt;2&lt;/Order&gt;\n                            &lt;Type&gt;Primary&lt;/Type&gt;\n                        &lt;/CreatePartition&gt;\n                    &lt;/CreatePartitions&gt;\n                    &lt;ModifyPartitions&gt;\n                        &lt;ModifyPartition wcm:action=&quot;add&quot;&gt;\n                            &lt;Active&gt;true&lt;/Active&gt;\n                            &lt;Format&gt;NTFS&lt;/Format&gt;\n                            &lt;Label&gt;System Reserved&lt;/Label&gt;\n                            &lt;Order&gt;1&lt;/Order&gt;\n                            &lt;PartitionID&gt;1&lt;/PartitionID&gt;\n                            &lt;TypeID&gt;0x27&lt;/TypeID&gt;\n                        &lt;/ModifyPartition&gt;\n                        &lt;ModifyPartition wcm:action=&quot;add&quot;&gt;\n                            &lt;Active&gt;true&lt;/Active&gt;\n                            &lt;Format&gt;NTFS&lt;/Format&gt;\n                            &lt;Label&gt;OS&lt;/Label&gt;\n                            &lt;Letter&gt;C&lt;/Letter&gt;\n                            &lt;Order&gt;2&lt;/Order&gt;\n                            &lt;PartitionID&gt;2&lt;/PartitionID&gt;\n                        &lt;/ModifyPartition&gt;\n                    &lt;/ModifyPartitions&gt;\n                    &lt;DiskID&gt;0&lt;/DiskID&gt;\n                    &lt;WillWipeDisk&gt;true&lt;/WillWipeDisk&gt;\n                &lt;/Disk&gt;\n            &lt;/DiskConfiguration&gt;\n            &lt;ImageInstall&gt;\n                &lt;OSImage&gt;\n                    &lt;InstallTo&gt;\n                        &lt;DiskID&gt;0&lt;/DiskID&gt;\n                        &lt;PartitionID&gt;2&lt;/PartitionID&gt;\n                    &lt;/InstallTo&gt;\n                    &lt;InstallToAvailablePartition&gt;false&lt;/InstallToAvailablePartition&gt;\n                &lt;/OSImage&gt;\n            &lt;/ImageInstall&gt;\n            &lt;UserData&gt;\n                &lt;AcceptEula&gt;true&lt;/AcceptEula&gt;\n                &lt;FullName&gt;AnJia&lt;/FullName&gt;\n                &lt;Organization&gt;AnJia&lt;/Organization&gt;\n                &lt;ProductKey&gt;\n                    &lt;Key&gt;VK7JG-NPHTM-C97JM-9MPGT-3V66T&lt;/Key&gt;\n                &lt;/ProductKey&gt;\n            &lt;/UserData&gt;\n        &lt;/component&gt;\n        &lt;component name=&quot;Microsoft-Windows-Setup&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;DiskConfiguration&gt;\n                &lt;Disk wcm:action=&quot;add&quot;&gt;\n                    &lt;CreatePartitions&gt;\n                        &lt;CreatePartition wcm:action=&quot;add&quot;&gt;\n                            &lt;Order&gt;1&lt;/Order&gt;\n                            &lt;Type&gt;Primary&lt;/Type&gt;\n                            &lt;Size&gt;100&lt;/Size&gt;\n                        &lt;/CreatePartition&gt;\n                        &lt;CreatePartition wcm:action=&quot;add&quot;&gt;\n                            &lt;Extend&gt;true&lt;/Extend&gt;\n                            &lt;Order&gt;2&lt;/Order&gt;\n                            &lt;Type&gt;Primary&lt;/Type&gt;\n                        &lt;/CreatePartition&gt;\n                    &lt;/CreatePartitions&gt;\n                    &lt;ModifyPartitions&gt;\n                        &lt;ModifyPartition wcm:action=&quot;add&quot;&gt;\n                            &lt;Active&gt;true&lt;/Active&gt;\n                            &lt;Format&gt;NTFS&lt;/Format&gt;\n                            &lt;Label&gt;System Reserved&lt;/Label&gt;\n                            &lt;Order&gt;1&lt;/Order&gt;\n                            &lt;PartitionID&gt;1&lt;/PartitionID&gt;\n                            &lt;TypeID&gt;0x27&lt;/TypeID&gt;\n                        &lt;/ModifyPartition&gt;\n                        &lt;ModifyPartition wcm:action=&quot;add&quot;&gt;\n                            &lt;Active&gt;true&lt;/Active&gt;\n                            &lt;Format&gt;NTFS&lt;/Format&gt;\n                            &lt;Label&gt;OS&lt;/Label&gt;\n                            &lt;Letter&gt;C&lt;/Letter&gt;\n                            &lt;Order&gt;2&lt;/Order&gt;\n                            &lt;PartitionID&gt;2&lt;/PartitionID&gt;\n                        &lt;/ModifyPartition&gt;\n                    &lt;/ModifyPartitions&gt;\n                    &lt;DiskID&gt;0&lt;/DiskID&gt;\n                    &lt;WillWipeDisk&gt;true&lt;/WillWipeDisk&gt;\n                &lt;/Disk&gt;\n            &lt;/DiskConfiguration&gt;\n            &lt;ImageInstall&gt;\n                &lt;OSImage&gt;\n                    &lt;InstallTo&gt;\n                        &lt;DiskID&gt;0&lt;/DiskID&gt;\n                        &lt;PartitionID&gt;2&lt;/PartitionID&gt;\n                    &lt;/InstallTo&gt;\n                    &lt;InstallToAvailablePartition&gt;false&lt;/InstallToAvailablePartition&gt;\n                &lt;/OSImage&gt;\n            &lt;/ImageInstall&gt;\n            &lt;UserData&gt;\n                &lt;AcceptEula&gt;true&lt;/AcceptEula&gt;\n                &lt;FullName&gt;AnJia&lt;/FullName&gt;\n                &lt;Organization&gt;AnJia&lt;/Organization&gt;\n                &lt;ProductKey&gt;\n                    &lt;Key&gt;VK7JG-NPHTM-C97JM-9MPGT-3V66T&lt;/Key&gt;\n                &lt;/ProductKey&gt;\n            &lt;/UserData&gt;\n        &lt;/component&gt;\n    &lt;/settings&gt;\n    &lt;settings pass=&quot;offlineServicing&quot;&gt;\n        &lt;component name=&quot;Microsoft-Windows-LUA-Settings&quot; processorArchitecture=&quot;x86&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;EnableLUA&gt;false&lt;/EnableLUA&gt;\n        &lt;/component&gt;\n    &lt;/settings&gt;\n    &lt;settings pass=&quot;offlineServicing&quot;&gt;\n        &lt;component name=&quot;Microsoft-Windows-LUA-Settings&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;EnableLUA&gt;false&lt;/EnableLUA&gt;\n        &lt;/component&gt;\n    &lt;/settings&gt;\n    &lt;settings pass=&quot;generalize&quot;&gt;\n        &lt;component name=&quot;Microsoft-Windows-Security-SPP&quot; processorArchitecture=&quot;x86&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;SkipRearm&gt;1&lt;/SkipRearm&gt;\n        &lt;/component&gt;\n    &lt;/settings&gt;\n    &lt;settings pass=&quot;generalize&quot;&gt;\n        &lt;component name=&quot;Microsoft-Windows-Security-SPP&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;SkipRearm&gt;1&lt;/SkipRearm&gt;\n        &lt;/component&gt;\n    &lt;/settings&gt;\n    &lt;settings pass=&quot;specialize&quot;&gt;\n        &lt;component name=&quot;Microsoft-Windows-International-Core&quot; processorArchitecture=&quot;x86&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;InputLocale&gt;0804:{81D4E9C9-1D3B-41BC-9E6C-4B40BF79E35E}{FA550B04-5AD7-411f-A5AC-CA038EC515D7}&lt;/InputLocale&gt;\n            &lt;SystemLocale&gt;zh-CN&lt;/SystemLocale&gt;\n            &lt;UILanguage&gt;zh-CN&lt;/UILanguage&gt;\n            &lt;UILanguageFallback&gt;zh-CN&lt;/UILanguageFallback&gt;\n            &lt;UserLocale&gt;zh-CN&lt;/UserLocale&gt;\n        &lt;/component&gt;\n        &lt;component name=&quot;Microsoft-Windows-International-Core&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;InputLocale&gt;0804:{81D4E9C9-1D3B-41BC-9E6C-4B40BF79E35E}{FA550B04-5AD7-411f-A5AC-CA038EC515D7}&lt;/InputLocale&gt;\n            &lt;SystemLocale&gt;zh-CN&lt;/SystemLocale&gt;\n            &lt;UILanguage&gt;zh-CN&lt;/UILanguage&gt;\n            &lt;UILanguageFallback&gt;zh-CN&lt;/UILanguageFallback&gt;\n            &lt;UserLocale&gt;zh-CN&lt;/UserLocale&gt;\n        &lt;/component&gt;\n        &lt;component name=&quot;Microsoft-Windows-Security-SPP-UX&quot; processorArchitecture=&quot;x86&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;SkipAutoActivation&gt;true&lt;/SkipAutoActivation&gt;\n        &lt;/component&gt;\n        &lt;component name=&quot;Microsoft-Windows-Security-SPP-UX&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;SkipAutoActivation&gt;true&lt;/SkipAutoActivation&gt;\n        &lt;/component&gt;\n        &lt;component name=&quot;Microsoft-Windows-SQMApi&quot; processorArchitecture=&quot;x86&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;CEIPEnabled&gt;0&lt;/CEIPEnabled&gt;\n        &lt;/component&gt;\n        &lt;component name=&quot;Microsoft-Windows-SQMApi&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;CEIPEnabled&gt;0&lt;/CEIPEnabled&gt;\n        &lt;/component&gt;\n        &lt;component name=&quot;Microsoft-Windows-Shell-Setup&quot; processorArchitecture=&quot;x86&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;ComputerName&gt;AnJia-PC&lt;/ComputerName&gt;\n            &lt;ProductKey&gt;VK7JG-NPHTM-C97JM-9MPGT-3V66T&lt;/ProductKey&gt;\n        &lt;/component&gt;\n        &lt;component name=&quot;Microsoft-Windows-Shell-Setup&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;ComputerName&gt;AnJia-PC&lt;/ComputerName&gt;\n            &lt;ProductKey&gt;VK7JG-NPHTM-C97JM-9MPGT-3V66T&lt;/ProductKey&gt;\n        &lt;/component&gt;\n    &lt;/settings&gt;\n    &lt;settings pass=&quot;oobeSystem&quot;&gt;\n        &lt;component name=&quot;Microsoft-Windows-Shell-Setup&quot; processorArchitecture=&quot;x86&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;AutoLogon&gt;\n                &lt;Password&gt;\n                    &lt;Value&gt;&lt;/Value&gt;\n                    &lt;PlainText&gt;true&lt;/PlainText&gt;\n                &lt;/Password&gt;\n                &lt;Enabled&gt;true&lt;/Enabled&gt;\n                &lt;Username&gt;AnJia&lt;/Username&gt;\n            &lt;/AutoLogon&gt;\n            &lt;OOBE&gt;\n                &lt;HideEULAPage&gt;true&lt;/HideEULAPage&gt;\n                &lt;HideOEMRegistrationScreen&gt;true&lt;/HideOEMRegistrationScreen&gt;\n                &lt;HideOnlineAccountScreens&gt;true&lt;/HideOnlineAccountScreens&gt;\n                &lt;HideWirelessSetupInOOBE&gt;true&lt;/HideWirelessSetupInOOBE&gt;\n                &lt;NetworkLocation&gt;Work&lt;/NetworkLocation&gt;\n                &lt;SkipUserOOBE&gt;true&lt;/SkipUserOOBE&gt;\n                &lt;SkipMachineOOBE&gt;true&lt;/SkipMachineOOBE&gt;\n                &lt;ProtectYourPC&gt;1&lt;/ProtectYourPC&gt;\n            &lt;/OOBE&gt;\n            &lt;UserAccounts&gt;\n                &lt;LocalAccounts&gt;\n                    &lt;LocalAccount wcm:action=&quot;add&quot;&gt;\n                        &lt;Password&gt;\n                            &lt;Value&gt;&lt;/Value&gt;\n                            &lt;PlainText&gt;true&lt;/PlainText&gt;\n                        &lt;/Password&gt;\n                        &lt;Description&gt;AnJia&lt;/Description&gt;\n                        &lt;DisplayName&gt;AnJia&lt;/DisplayName&gt;\n                        &lt;Group&gt;Administrators&lt;/Group&gt;\n                        &lt;Name&gt;AnJia&lt;/Name&gt;\n                    &lt;/LocalAccount&gt;\n                &lt;/LocalAccounts&gt;\n            &lt;/UserAccounts&gt;\n            &lt;RegisteredOrganization&gt;AnJia&lt;/RegisteredOrganization&gt;\n            &lt;RegisteredOwner&gt;AnJia&lt;/RegisteredOwner&gt;\n            &lt;DisableAutoDaylightTimeSet&gt;false&lt;/DisableAutoDaylightTimeSet&gt;\n            &lt;FirstLogonCommands&gt;\n                &lt;SynchronousCommand wcm:action=&quot;add&quot;&gt;\n                    &lt;Description&gt;Control Panel View&lt;/Description&gt;\n                    &lt;Order&gt;1&lt;/Order&gt;\n                    &lt;CommandLine&gt;reg add &quot;HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ControlPanel&quot; /v StartupPage /t REG_DWORD /d 1 /f&lt;/CommandLine&gt;\n                    &lt;RequiresUserInput&gt;true&lt;/RequiresUserInput&gt;\n                &lt;/SynchronousCommand&gt;\n                &lt;SynchronousCommand wcm:action=&quot;add&quot;&gt;\n                    &lt;Order&gt;2&lt;/Order&gt;\n                    &lt;Description&gt;Control Panel Icon Size&lt;/Description&gt;\n                    &lt;RequiresUserInput&gt;false&lt;/RequiresUserInput&gt;\n                    &lt;CommandLine&gt;reg add &quot;HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ControlPanel&quot; /v AllItemsIconView /t REG_DWORD /d 0 /f&lt;/CommandLine&gt;\n                &lt;/SynchronousCommand&gt;\n                &lt;SynchronousCommand wcm:action=&quot;add&quot;&gt;\n                    &lt;Order&gt;3&lt;/Order&gt;\n                    &lt;RequiresUserInput&gt;false&lt;/RequiresUserInput&gt;\n                    &lt;CommandLine&gt;cmd /C wmic useraccount where name=&quot;AnJia&quot; set PasswordExpires=false&lt;/CommandLine&gt;\n                    &lt;Description&gt;Password Never Expires&lt;/Description&gt;\n                &lt;/SynchronousCommand&gt;\n            &lt;/FirstLogonCommands&gt;\n            &lt;TimeZone&gt;China Standard Time&lt;/TimeZone&gt;\n        &lt;/component&gt;\n        &lt;component name=&quot;Microsoft-Windows-Shell-Setup&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;\n            xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;\n            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;\n            &lt;AutoLogon&gt;\n                &lt;Password&gt;\n                    &lt;Value&gt;&lt;/Value&gt;\n                    &lt;PlainText&gt;true&lt;/PlainText&gt;\n                &lt;/Password&gt;\n                &lt;Enabled&gt;true&lt;/Enabled&gt;\n                &lt;Username&gt;AnJia&lt;/Username&gt;\n            &lt;/AutoLogon&gt;\n            &lt;OOBE&gt;\n                &lt;HideEULAPage&gt;true&lt;/HideEULAPage&gt;\n                &lt;HideOEMRegistrationScreen&gt;true&lt;/HideOEMRegistrationScreen&gt;\n                &lt;HideOnlineAccountScreens&gt;true&lt;/HideOnlineAccountScreens&gt;\n                &lt;HideWirelessSetupInOOBE&gt;true&lt;/HideWirelessSetupInOOBE&gt;\n                &lt;NetworkLocation&gt;Work&lt;/NetworkLocation&gt;\n                &lt;SkipUserOOBE&gt;true&lt;/SkipUserOOBE&gt;\n                &lt;SkipMachineOOBE&gt;true&lt;/SkipMachineOOBE&gt;\n                &lt;ProtectYourPC&gt;1&lt;/ProtectYourPC&gt;\n            &lt;/OOBE&gt;\n            &lt;UserAccounts&gt;\n                &lt;LocalAccounts&gt;\n                    &lt;LocalAccount wcm:action=&quot;add&quot;&gt;\n                        &lt;Password&gt;\n                            &lt;Value&gt;&lt;/Value&gt;\n                            &lt;PlainText&gt;true&lt;/PlainText&gt;\n                        &lt;/Password&gt;\n                        &lt;Description&gt;AnJia&lt;/Description&gt;\n                        &lt;DisplayName&gt;AnJia&lt;/DisplayName&gt;\n                        &lt;Group&gt;Administrators&lt;/Group&gt;\n                        &lt;Name&gt;AnJia&lt;/Name&gt;\n                    &lt;/LocalAccount&gt;\n                &lt;/LocalAccounts&gt;\n            &lt;/UserAccounts&gt;\n            &lt;RegisteredOrganization&gt;AnJia&lt;/RegisteredOrganization&gt;\n            &lt;RegisteredOwner&gt;AnJia&lt;/RegisteredOwner&gt;\n            &lt;DisableAutoDaylightTimeSet&gt;false&lt;/DisableAutoDaylightTimeSet&gt;\n            &lt;FirstLogonCommands&gt;\n                &lt;SynchronousCommand wcm:action=&quot;add&quot;&gt;\n                    &lt;Description&gt;Control Panel View&lt;/Description&gt;\n                    &lt;Order&gt;1&lt;/Order&gt;\n                    &lt;CommandLine&gt;reg add &quot;HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ControlPanel&quot; /v StartupPage /t REG_DWORD /d 1 /f&lt;/CommandLine&gt;\n                    &lt;RequiresUserInput&gt;true&lt;/RequiresUserInput&gt;\n                &lt;/SynchronousCommand&gt;\n                &lt;SynchronousCommand wcm:action=&quot;add&quot;&gt;\n                    &lt;Order&gt;2&lt;/Order&gt;\n                    &lt;Description&gt;Control Panel Icon Size&lt;/Description&gt;\n                    &lt;RequiresUserInput&gt;false&lt;/RequiresUserInput&gt;\n                    &lt;CommandLine&gt;reg add &quot;HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ControlPanel&quot; /v AllItemsIconView /t REG_DWORD /d 0 /f&lt;/CommandLine&gt;\n                &lt;/SynchronousCommand&gt;\n                &lt;SynchronousCommand wcm:action=&quot;add&quot;&gt;\n                    &lt;Order&gt;3&lt;/Order&gt;\n                    &lt;RequiresUserInput&gt;false&lt;/RequiresUserInput&gt;\n                    &lt;CommandLine&gt;cmd /C wmic useraccount where name=&quot;AnJia&quot; set PasswordExpires=false&lt;/CommandLine&gt;\n                    &lt;Description&gt;Password Never Expires&lt;/Description&gt;\n                &lt;/SynchronousCommand&gt;\n            &lt;/FirstLogonCommands&gt;\n            &lt;TimeZone&gt;China Standard Time&lt;/TimeZone&gt;\n        &lt;/component&gt;\n    &lt;/settings&gt;\n&lt;/unattend&gt;</code></pre><p><br /></p><h3 id=\"727af9d3\">配置samba</h3><p>在Cobbler上执行</p><h4 id=\"0125c65d\">安装samba</h4><pre data-lang=\"bash\"><code>[root@localhost ~]# yum install samba -y</code></pre><h4 id=\"6f1032ee\">修改smb config</h4><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# vi /etc/samba/smb.conf\n \n# /etc/samba/smb.conf\n[global]\nlog file = /var/log/samba/log.%m\nmax log size = 5000\nsecurity = user\nguest account = nobody\nmap to guest = Bad User\nload printers = yes\ncups options = raw\n \n[share]\ncomment = share directory目录\npath = /smb/\ndirectory mask = 0755\ncreate mask = 0755\nguest ok=yes\nwritable=yes</code></pre><p><br /></p><h4 id=\"9b9fd94f\">启动smb服务</h4><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# service smb start\n[root@localhost ~]# systemctl enable smb</code></pre><p><br /></p><h4 id=\"6e499122\">挂载win10系统</h4><p>通过winscp等软件将 cn_windows_10_business_edition_version_1809_updated_sept_2018_x64_dvd_84ac403f.iso 上传到cobbler服务器上,并将创建的应答文件，上传到cobbler <code>/smb/win/win10_x64_bios_auto.xml</code> </p><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# mkdir -p /smb/win\n[root@localhost ~]# mount -o loop,ro /tmp/cn_windows_10_business_edition_version_1809_updated_sept_2018_x64_dvd_84ac403f.iso /mnt/\n[root@localhost ~]# cp -r /mnt/* /smb/win\n[root@localhost ~]# umount /mnt/</code></pre><p><br /></p><h3 id=\"a23d1d1f\">自动化安装Windows10</h3><p>从vmware创建一台内存4G，cpu2核，磁盘60G的空盘，win10虚拟机，然后开机。记得选BIOS，别选UEFI。</p><p><img alt=\"Snipaste_2019-02-26_00-05-00.png\" title=\"Snipaste_2019-02-26_00-05-00.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1551110723753-c7785e92-60be-4a90-a606-96bc92306aaa.png#align=left&amp;display=inline&amp;height=400&amp;name=Snipaste_2019-02-26_00-05-00.png&amp;originHeight=400&amp;originWidth=720&amp;size=5025&amp;status=done&amp;width=720\" style=\"max-width: 600px; width: 720px;\" /></p><p><br /></p><p><img alt=\"Snipaste_2019-02-25_23-44-27.png\" title=\"Snipaste_2019-02-25_23-44-27.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1551110627345-af185562-5a0f-4b4c-98ef-68974880a6a3.png#align=left&amp;display=inline&amp;height=560&amp;name=Snipaste_2019-02-25_23-44-27.png&amp;originHeight=768&amp;originWidth=1024&amp;size=19684&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1551112320786-fc312bb1-ce6c-4771-864f-e8900a1aed58.png#align=left&amp;display=inline&amp;height=768&amp;name=image.png&amp;originHeight=768&amp;originWidth=1024&amp;size=233953&amp;status=done&amp;width=1024\" style=\"max-width: 600px; width: 1024px;\" /></p><p><br /></p><p>至于如何激活，参考  <a href=\"http://bbs.pcbeta.com/viewthread-1796113-1-1.html\" target=\"_blank\">vlmcsd搭建KMS服务器，成功激活Server 2019数据中心版本，全网应是我首发</a></p><p><br /></p><h2 id=\"31f87578\">Windows Server 2019</h2><p>因为2019用的也是1809版本的，所以制作步骤一样的，在此不再赘述。</p><h2 id=\"35808e79\">参考资料</h2><p><br /></p><ul><li><a href=\"https://www.cnblogs.com/pluse/p/8508538.html\" target=\"_blank\">使用Cobbler批量部署Linux和Windows：Windows系统批量安装（三）</a></li><li><a href=\"https://blog.csdn.net/greless/article/details/52815716\" target=\"_blank\">WINPE镜像制作-startnet.cmd详解</a></li><li><a href=\"https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn898524(v=vs.85).aspx\" target=\"_blank\">Windows 中的默认输入配置文件（输入区域设置）</a></li><li><a href=\"https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/update-windows-settings-and-scripts-create-your-own-answer-file-sxs\" target=\"_blank\">Answer files (unattend.xml)</a></li><li><a href=\"http://www.windowsafg.com/win10x86_x64.html\" target=\"_blank\">Windows Answer File Generator#win10_x86_64</a></li><li><a href=\"https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/winpe-mount-and-customize\" target=\"_blank\">WinPE: Mount and Customize</a></li><li><a href=\"https://docs.microsoft.com/en-us/windows-hardware/customize/desktop/unattend/components-b-unattend\" target=\"_blank\">Components</a></li><li><a href=\"https://www.windowscentral.com/how-create-unattended-media-do-automated-installation-windows-10\" target=\"_blank\">How to create an unattended installation of Windows 10</a></li><li> <a href=\"http://bbs.pcbeta.com/viewthread-1796113-1-1.html\" target=\"_blank\">vlmcsd搭建KMS服务器，成功激活Server 2019数据中心版本，全网应是我首发</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "body_lake": "<!doctype lake><p><span>date: 2019-02-22 15:46:00</span></p><p>tags: [pxe,dhcp,cobbler,centos,ubuntu,windows,tftp,win10,server-2019]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote style=\"padding-left: 1em;\"><p>这是坚持技术写作计划（含翻译）的第7篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要讲解通过CentOS7.6 Minimal + Cobbler 自动化安装CentOS,Ubuntu,Windows 10 和 Windows Server 2019。</p><p><br /></p><p>请注意，一般安装windows是用<a href=\"https://docs.microsoft.com/zh-cn/windows/deployment/deploy-windows-mdt/deploy-a-windows-10-image-using-mdt\" target=\"_blank\">MDT</a>或者WDS居多，毕竟是巨硬自己家的，而且WDT还支持分布式镜像传输（主要是巨硬家的OS，动辄超过4G，万兆网卡也会卡啊）。本文不涉及到WDT或者WDS相关操作，感兴趣的可自行百度或者msdn。</p><p><br /></p><h2 id=\"424a2ad8\">准备</h2><ul><li><a href=\"https://docs.microsoft.com/zh-cn/windows-hardware/get-started/adk-install#winADK\" target=\"_blank\">Windows ADK</a> (分别下载 <a href=\"https://go.microsoft.com/fwlink/?linkid=2026036\" target=\"_blank\">Download the Windows ADK for Windows 10, version 1809</a> 和 <a href=\"https://go.microsoft.com/fwlink/?linkid=2022233\" target=\"_blank\">Download the Windows PE add-on for the ADK</a>)</li><li>下载 <a href=\"http://msdn.itellyou.cn/\" target=\"_blank\">Windows 10 (business edition), version 1809 (Updated Feb 2019) (x64) - DVD (Chinese-Simplified)</a><a href=\"http://msdn.itellyou.cn/\" target=\"_blank\"><span style=\"color: #333333;\"> </span></a></li><li>下载 <a href=\"http://msdn.itellyou.cn/\" target=\"_blank\"><span style=\"color: #333333;\">Windows Server 2019 (x64) - DVD (Chinese-Simplified)</span></a></li></ul><p><br /></p><p>注意，adk的两个都要下载，这俩都是引导包，真正的安装程序会由这俩软件进行下载。其中WinPE需要用到5G左右的磁盘空间，简直不能忍受。。。</p><p>msdn i tell u 堪称良心站，是windows装机神站啊，不过，没有直达页面挺不爽。为了防止下错，特意截图。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1551104465714-66f42f29-fbcf-476f-b2e7-b1f3a6fb319b.png%22%2C%22originWidth%22%3A1171%2C%22originHeight%22%3A573%2C%22name%22%3A%22Snipaste_2019-02-25_22-18-07.png%22%2C%22size%22%3A143092%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A365%7D\"></card></p><p><br /></p><h2 id=\"9639c173\">安装ADK和WinPE</h2><p>我已经装过，且忘记截图了，这是事后补图，只需要勾选必须的就行</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1551105181245-e9b47d7d-e1b3-48f8-918e-42cdff955406.png%22%2C%22originWidth%22%3A746%2C%22originHeight%22%3A548%2C%22name%22%3A%22Snipaste_2019-02-25_22-32-48.png%22%2C%22size%22%3A36472%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A548%7D\"></card><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1551105181277-4477f2fc-1cfe-414c-9178-c30ae74e725c.png%22%2C%22originWidth%22%3A746%2C%22originHeight%22%3A548%2C%22name%22%3A%22Snipaste_2019-02-25_22-32-20.png%22%2C%22size%22%3A52141%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A548%7D\"></card></p><p><br /></p><p>安装完后，以管理员身份打开部署和映像工具环境</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1551105055491-d302cb36-bb44-4359-8fb5-c7342e9854fa.png%22%2C%22originWidth%22%3A613%2C%22originHeight%22%3A425%2C%22name%22%3A%22image.png%22%2C%22size%22%3A193121%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A613%2C%22height%22%3A425%7D\"></card></p><p><br /></p><p>定制Win 10 PE </p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22copype%20amd64%20C%3A%5C%5Cwinpe%5Cn%5CnDism%20%2Fmount-image%20%2Fimagefile%3AC%3A%5C%5Cwinpe%5C%5Cmedia%5C%5Csources%5C%5Cboot.wim%20%2Findex%3A1%20%2Fmountdir%3AC%3A%5C%5Cwinpe%5C%5Cmount%5Cn%5Cnecho%20net%20use%20z%3A%20%5C%5C%5C%5C192.168.0.253%5C%5Cshare%20%3E%3E%20C%3A%5C%5Cwinpe%5C%5Cmount%5C%5CWindows%5C%5CSystem32%5C%5Cstartnet.cmd%5Cnecho%20z%3A%5C%5Cwin%5C%5Csetup.exe%20%2Funattend%3Az%3A%5C%5Cwin%5C%5Cwin10_x64_bios_auto.xml%20%3E%3E%20C%3A%5C%5Cwinpe%5C%5Cmount%5C%5CWindows%5C%5CSystem32%5C%5Cstartnet.cmd%5Cn%5CnDism%20%2Funmount-image%20%2Fmountdir%3AC%3A%5C%5Cwinpe%5C%5Cmount%20%2Fcommit%5CnMakeWinPEMedia%20%2FISO%20C%3A%5C%5Cwinpe%20C%3A%5C%5Cwinpe%5C%5Cwinpe_win10_amd64.iso%22%7D\"></card><p><br /></p><ol start=\"1\"><li>本地生成winpe文件目录</li><li>dism 挂载 winpe的启动文件到winpe的mount目录</li><li>将启动命令硬编码写死到winpe的startnet.cmd文件里</li><li>无人值守安装</li><li>卸载winpe的挂载（一定要执行，否则直接强制删除文件夹会出一些稀奇古怪的问题）</li><li>制作win10镜像，名为 winpe_win10_amd64.iso</li></ol><p><br /></p><p>第三步的硬编码是无奈之举，因为要想挂载共享文件夹，必须要知道smb主机，但是这个参数又很难传递进来。</p><p>如果是U盘启动，可以写死U盘路径，大不了插上U盘后，手动改卷标(当然因为U盘挂载顺序不一致，可以通过for循环A-Z盘，挨个盘访问某个文件名，如果存在，即认为此盘是自己U盘，设置环境变量)。而网上说的，startnet.cmd调用另外一个bat，多是基于这个原理。</p><p><br /></p><p>而如果PXE要达到跟上述要求，动态设置smb主机，要么写死域名，然后劫持或者配置域名，加上bat文件，在winpe启动时，通过startnet.cmd下载，并执行。要么找办法，看看能不能在启动时，传入参数（目前我还没找到），当然还可以用MDT方案，看着比PXE+无人应答文件简单很多。</p><p><br /></p><h2 id=\"d36faa4b\">配置Cobbler Server</h2><p><br /></p><h3 id=\"42b542e5\">导入Cobbler</h3><p>使用WinScp 等工具，将 <span>winpe_win10_amd64.iso 上传到 Cobbler 服务器上</span></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20cobbler%20distro%20add%20--name%3Dwindows_10_x64%20--kernel%3D%2Fvar%2Flib%2Ftftpboot%2Fmemdisk%20--initrd%3D%2Froot%2Fwinpe_win10_amd64.iso%20--kopts%3D%5C%22raw%20iso%5C%22%5Cn%5Broot%40localhost%20~%5D%23%20touch%20%2Fvar%2Flib%2Fcobbler%2Fkickstarts%2Fwinpe.xml%5Cn%5Broot%40localhost%20~%5D%23%20cobbler%20profile%20add%20--name%3Dwindows_10_x64%20--distro%3Dwindows_10_x64%20--kickstart%3D%2Fvar%2Flib%2Fcobbler%2Fkickstarts%2Fwinpe.xml%22%7D\"></card><p><br /></p><p><br /></p><h3 id=\"b15fbfd6\">创建自动应答文件</h3><p>直接从 <a href=\"http://www.windowsafg.com/win10x86_x64.html\" target=\"_blank\">Windows Answer File Generator#win10_x86_64</a> 通过简单配置后，下载即可（只支持简单操作，比如，装系统，格式化磁盘，设置密码等）。当然也可以使用 【Windows系统映像管理器<span>】</span>，不过挺难用的，具体用法可以参考 <a href=\"https://www.windowscentral.com/how-create-unattended-media-do-automated-installation-windows-10\" target=\"_blank\">How to create an unattended installation of Windows 10</a>。也可以通过MDT简化操作。</p><p><br /></p><p>但是如果使用直接生成的，有点问题，即使页面设置了安装语言，但是仍旧需要手动选择，经过多方研究，发现</p><p>主要卡在UILanguage和Inputlocale上，全写zh-CN无效。</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22xml%22%2C%22code%22%3A%22%3C%3Fxml%20version%3D%5C%221.0%5C%22%20encoding%3D%5C%22utf-8%5C%22%3F%3E%5Cn%3Ccomponent%20%E6%AD%A4%E5%A4%84%E5%BF%BD%E7%95%A5%3E%5Cn%20%20%3CSetupUILanguage%3E%5Cn%20%20%20%20%3CUILanguage%3Een-US%3C%2FUILanguage%3E%5Cn%20%20%3C%2FSetupUILanguage%3E%5Cn%20%20%3CInputLocale%3E0804%3A%7B81D4E9C9-1D3B-41BC-9E6C-4B40BF79E35E%7D%7BFA550B04-5AD7-411f-A5AC-CA038EC515D7%7D%3C%2FInputLocale%3E%20%5Cn%20%20%3CSystemLocale%3Ezh-CN%3C%2FSystemLocale%3E%5Cn%20%20%3CUILanguage%3Ezh-CN%3C%2FUILanguage%3E%5Cn%20%20%3CUILanguageFallback%3Ezh-CN%3C%2FUILanguageFallback%3E%5Cn%20%20%3CUserLocale%3Ezh-CN%3C%2FUserLocale%3E%5Cn%3C%2Fcomponent%3E%5Cn%22%7D\"></card><p><br /></p><p>另外就是安装密钥,统一替换为 VK7JG-NPHTM-C97JM-9MPGT-3V66T</p><p><br /></p><p>下面是我的应答文件，仅做参考。</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%3C!--*************************************************%5CnWindows%2010%20Answer%20File%20Generator%5CnCreated%20using%20Windows%20AFG%20found%20at%3A%5Cn%3Bhttp%3A%2F%2Fwww.windowsafg.com%5Cn%5CnInstallation%20Notes%5CnLocation%3A%20zh-CN%5CnNotes%3A%20Enter%20your%20comments%20here...%5Cn**************************************************--%3E%5Cn%3C%3Fxml%20version%3D%5C%221.0%5C%22%20encoding%3D%5C%22utf-8%5C%22%3F%3E%5Cn%3Cunattend%5Cn%20%20%20%20xmlns%3D%5C%22urn%3Aschemas-microsoft-com%3Aunattend%5C%22%3E%5Cn%20%20%20%20%3Csettings%20pass%3D%5C%22windowsPE%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-International-Core-WinPE%5C%22%20processorArchitecture%3D%5C%22x86%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CSetupUILanguage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CUILanguage%3Een-US%3C%2FUILanguage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FSetupUILanguage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CInputLocale%3E0804%3A%7B81D4E9C9-1D3B-41BC-9E6C-4B40BF79E35E%7D%7BFA550B04-5AD7-411f-A5AC-CA038EC515D7%7D%3C%2FInputLocale%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CSystemLocale%3Ezh-CN%3C%2FSystemLocale%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUILanguage%3Ezh-CN%3C%2FUILanguage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUILanguageFallback%3Ezh-CN%3C%2FUILanguageFallback%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUserLocale%3Ezh-CN%3C%2FUserLocale%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-International-Core-WinPE%5C%22%20processorArchitecture%3D%5C%22amd64%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CSetupUILanguage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CUILanguage%3Een-US%3C%2FUILanguage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FSetupUILanguage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CInputLocale%3E0804%3A%7B81D4E9C9-1D3B-41BC-9E6C-4B40BF79E35E%7D%7BFA550B04-5AD7-411f-A5AC-CA038EC515D7%7D%3C%2FInputLocale%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CSystemLocale%3Ezh-CN%3C%2FSystemLocale%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUILanguage%3Ezh-CN%3C%2FUILanguage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUILanguageFallback%3Ezh-CN%3C%2FUILanguageFallback%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUserLocale%3Ezh-CN%3C%2FUserLocale%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-Setup%5C%22%20processorArchitecture%3D%5C%22x86%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CDiskConfiguration%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDisk%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CCreatePartitions%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CCreatePartition%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrder%3E1%3C%2FOrder%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CType%3EPrimary%3C%2FType%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CSize%3E100%3C%2FSize%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FCreatePartition%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CCreatePartition%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CExtend%3Etrue%3C%2FExtend%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrder%3E2%3C%2FOrder%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CType%3EPrimary%3C%2FType%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FCreatePartition%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FCreatePartitions%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CModifyPartitions%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CModifyPartition%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CActive%3Etrue%3C%2FActive%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CFormat%3ENTFS%3C%2FFormat%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CLabel%3ESystem%20Reserved%3C%2FLabel%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrder%3E1%3C%2FOrder%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CPartitionID%3E1%3C%2FPartitionID%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CTypeID%3E0x27%3C%2FTypeID%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FModifyPartition%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CModifyPartition%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CActive%3Etrue%3C%2FActive%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CFormat%3ENTFS%3C%2FFormat%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CLabel%3EOS%3C%2FLabel%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CLetter%3EC%3C%2FLetter%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrder%3E2%3C%2FOrder%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CPartitionID%3E2%3C%2FPartitionID%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FModifyPartition%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FModifyPartitions%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDiskID%3E0%3C%2FDiskID%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CWillWipeDisk%3Etrue%3C%2FWillWipeDisk%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FDisk%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FDiskConfiguration%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CImageInstall%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COSImage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CInstallTo%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDiskID%3E0%3C%2FDiskID%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CPartitionID%3E2%3C%2FPartitionID%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FInstallTo%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CInstallToAvailablePartition%3Efalse%3C%2FInstallToAvailablePartition%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FOSImage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FImageInstall%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUserData%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CAcceptEula%3Etrue%3C%2FAcceptEula%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CFullName%3EAnJia%3C%2FFullName%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrganization%3EAnJia%3C%2FOrganization%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CProductKey%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CKey%3EVK7JG-NPHTM-C97JM-9MPGT-3V66T%3C%2FKey%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FProductKey%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FUserData%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-Setup%5C%22%20processorArchitecture%3D%5C%22amd64%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CDiskConfiguration%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDisk%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CCreatePartitions%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CCreatePartition%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrder%3E1%3C%2FOrder%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CType%3EPrimary%3C%2FType%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CSize%3E100%3C%2FSize%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FCreatePartition%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CCreatePartition%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CExtend%3Etrue%3C%2FExtend%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrder%3E2%3C%2FOrder%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CType%3EPrimary%3C%2FType%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FCreatePartition%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FCreatePartitions%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CModifyPartitions%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CModifyPartition%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CActive%3Etrue%3C%2FActive%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CFormat%3ENTFS%3C%2FFormat%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CLabel%3ESystem%20Reserved%3C%2FLabel%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrder%3E1%3C%2FOrder%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CPartitionID%3E1%3C%2FPartitionID%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CTypeID%3E0x27%3C%2FTypeID%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FModifyPartition%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CModifyPartition%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CActive%3Etrue%3C%2FActive%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CFormat%3ENTFS%3C%2FFormat%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CLabel%3EOS%3C%2FLabel%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CLetter%3EC%3C%2FLetter%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrder%3E2%3C%2FOrder%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CPartitionID%3E2%3C%2FPartitionID%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FModifyPartition%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FModifyPartitions%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDiskID%3E0%3C%2FDiskID%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CWillWipeDisk%3Etrue%3C%2FWillWipeDisk%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FDisk%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FDiskConfiguration%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CImageInstall%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COSImage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CInstallTo%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDiskID%3E0%3C%2FDiskID%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CPartitionID%3E2%3C%2FPartitionID%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FInstallTo%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CInstallToAvailablePartition%3Efalse%3C%2FInstallToAvailablePartition%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FOSImage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FImageInstall%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUserData%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CAcceptEula%3Etrue%3C%2FAcceptEula%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CFullName%3EAnJia%3C%2FFullName%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrganization%3EAnJia%3C%2FOrganization%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CProductKey%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CKey%3EVK7JG-NPHTM-C97JM-9MPGT-3V66T%3C%2FKey%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FProductKey%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FUserData%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%3C%2Fsettings%3E%5Cn%20%20%20%20%3Csettings%20pass%3D%5C%22offlineServicing%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-LUA-Settings%5C%22%20processorArchitecture%3D%5C%22x86%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CEnableLUA%3Efalse%3C%2FEnableLUA%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%3C%2Fsettings%3E%5Cn%20%20%20%20%3Csettings%20pass%3D%5C%22offlineServicing%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-LUA-Settings%5C%22%20processorArchitecture%3D%5C%22amd64%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CEnableLUA%3Efalse%3C%2FEnableLUA%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%3C%2Fsettings%3E%5Cn%20%20%20%20%3Csettings%20pass%3D%5C%22generalize%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-Security-SPP%5C%22%20processorArchitecture%3D%5C%22x86%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CSkipRearm%3E1%3C%2FSkipRearm%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%3C%2Fsettings%3E%5Cn%20%20%20%20%3Csettings%20pass%3D%5C%22generalize%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-Security-SPP%5C%22%20processorArchitecture%3D%5C%22amd64%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CSkipRearm%3E1%3C%2FSkipRearm%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%3C%2Fsettings%3E%5Cn%20%20%20%20%3Csettings%20pass%3D%5C%22specialize%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-International-Core%5C%22%20processorArchitecture%3D%5C%22x86%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CInputLocale%3E0804%3A%7B81D4E9C9-1D3B-41BC-9E6C-4B40BF79E35E%7D%7BFA550B04-5AD7-411f-A5AC-CA038EC515D7%7D%3C%2FInputLocale%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CSystemLocale%3Ezh-CN%3C%2FSystemLocale%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUILanguage%3Ezh-CN%3C%2FUILanguage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUILanguageFallback%3Ezh-CN%3C%2FUILanguageFallback%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUserLocale%3Ezh-CN%3C%2FUserLocale%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-International-Core%5C%22%20processorArchitecture%3D%5C%22amd64%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CInputLocale%3E0804%3A%7B81D4E9C9-1D3B-41BC-9E6C-4B40BF79E35E%7D%7BFA550B04-5AD7-411f-A5AC-CA038EC515D7%7D%3C%2FInputLocale%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CSystemLocale%3Ezh-CN%3C%2FSystemLocale%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUILanguage%3Ezh-CN%3C%2FUILanguage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUILanguageFallback%3Ezh-CN%3C%2FUILanguageFallback%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUserLocale%3Ezh-CN%3C%2FUserLocale%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-Security-SPP-UX%5C%22%20processorArchitecture%3D%5C%22x86%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CSkipAutoActivation%3Etrue%3C%2FSkipAutoActivation%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-Security-SPP-UX%5C%22%20processorArchitecture%3D%5C%22amd64%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CSkipAutoActivation%3Etrue%3C%2FSkipAutoActivation%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-SQMApi%5C%22%20processorArchitecture%3D%5C%22x86%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CCEIPEnabled%3E0%3C%2FCEIPEnabled%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-SQMApi%5C%22%20processorArchitecture%3D%5C%22amd64%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CCEIPEnabled%3E0%3C%2FCEIPEnabled%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-Shell-Setup%5C%22%20processorArchitecture%3D%5C%22x86%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CComputerName%3EAnJia-PC%3C%2FComputerName%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CProductKey%3EVK7JG-NPHTM-C97JM-9MPGT-3V66T%3C%2FProductKey%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-Shell-Setup%5C%22%20processorArchitecture%3D%5C%22amd64%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CComputerName%3EAnJia-PC%3C%2FComputerName%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CProductKey%3EVK7JG-NPHTM-C97JM-9MPGT-3V66T%3C%2FProductKey%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%3C%2Fsettings%3E%5Cn%20%20%20%20%3Csettings%20pass%3D%5C%22oobeSystem%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-Shell-Setup%5C%22%20processorArchitecture%3D%5C%22x86%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CAutoLogon%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CPassword%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CValue%3E%3C%2FValue%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CPlainText%3Etrue%3C%2FPlainText%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FPassword%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CEnabled%3Etrue%3C%2FEnabled%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CUsername%3EAnJia%3C%2FUsername%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FAutoLogon%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3COOBE%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CHideEULAPage%3Etrue%3C%2FHideEULAPage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CHideOEMRegistrationScreen%3Etrue%3C%2FHideOEMRegistrationScreen%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CHideOnlineAccountScreens%3Etrue%3C%2FHideOnlineAccountScreens%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CHideWirelessSetupInOOBE%3Etrue%3C%2FHideWirelessSetupInOOBE%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CNetworkLocation%3EWork%3C%2FNetworkLocation%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CSkipUserOOBE%3Etrue%3C%2FSkipUserOOBE%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CSkipMachineOOBE%3Etrue%3C%2FSkipMachineOOBE%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CProtectYourPC%3E1%3C%2FProtectYourPC%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FOOBE%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUserAccounts%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CLocalAccounts%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CLocalAccount%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CPassword%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CValue%3E%3C%2FValue%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CPlainText%3Etrue%3C%2FPlainText%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FPassword%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDescription%3EAnJia%3C%2FDescription%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDisplayName%3EAnJia%3C%2FDisplayName%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CGroup%3EAdministrators%3C%2FGroup%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CName%3EAnJia%3C%2FName%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FLocalAccount%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FLocalAccounts%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FUserAccounts%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CRegisteredOrganization%3EAnJia%3C%2FRegisteredOrganization%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CRegisteredOwner%3EAnJia%3C%2FRegisteredOwner%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CDisableAutoDaylightTimeSet%3Efalse%3C%2FDisableAutoDaylightTimeSet%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CFirstLogonCommands%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CSynchronousCommand%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDescription%3EControl%20Panel%20View%3C%2FDescription%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrder%3E1%3C%2FOrder%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CCommandLine%3Ereg%20add%20%5C%22HKEY_CURRENT_USER%5C%5CSoftware%5C%5CMicrosoft%5C%5CWindows%5C%5CCurrentVersion%5C%5CExplorer%5C%5CControlPanel%5C%22%20%2Fv%20StartupPage%20%2Ft%20REG_DWORD%20%2Fd%201%20%2Ff%3C%2FCommandLine%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CRequiresUserInput%3Etrue%3C%2FRequiresUserInput%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FSynchronousCommand%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CSynchronousCommand%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrder%3E2%3C%2FOrder%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDescription%3EControl%20Panel%20Icon%20Size%3C%2FDescription%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CRequiresUserInput%3Efalse%3C%2FRequiresUserInput%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CCommandLine%3Ereg%20add%20%5C%22HKEY_CURRENT_USER%5C%5CSoftware%5C%5CMicrosoft%5C%5CWindows%5C%5CCurrentVersion%5C%5CExplorer%5C%5CControlPanel%5C%22%20%2Fv%20AllItemsIconView%20%2Ft%20REG_DWORD%20%2Fd%200%20%2Ff%3C%2FCommandLine%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FSynchronousCommand%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CSynchronousCommand%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrder%3E3%3C%2FOrder%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CRequiresUserInput%3Efalse%3C%2FRequiresUserInput%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CCommandLine%3Ecmd%20%2FC%20wmic%20useraccount%20where%20name%3D%5C%22AnJia%5C%22%20set%20PasswordExpires%3Dfalse%3C%2FCommandLine%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDescription%3EPassword%20Never%20Expires%3C%2FDescription%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FSynchronousCommand%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FFirstLogonCommands%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CTimeZone%3EChina%20Standard%20Time%3C%2FTimeZone%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%20%20%20%20%3Ccomponent%20name%3D%5C%22Microsoft-Windows-Shell-Setup%5C%22%20processorArchitecture%3D%5C%22amd64%5C%22%20publicKeyToken%3D%5C%2231bf3856ad364e35%5C%22%20language%3D%5C%22neutral%5C%22%20versionScope%3D%5C%22nonSxS%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Awcm%3D%5C%22http%3A%2F%2Fschemas.microsoft.com%2FWMIConfig%2F2002%2FState%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Axsi%3D%5C%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CAutoLogon%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CPassword%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CValue%3E%3C%2FValue%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CPlainText%3Etrue%3C%2FPlainText%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FPassword%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CEnabled%3Etrue%3C%2FEnabled%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CUsername%3EAnJia%3C%2FUsername%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FAutoLogon%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3COOBE%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CHideEULAPage%3Etrue%3C%2FHideEULAPage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CHideOEMRegistrationScreen%3Etrue%3C%2FHideOEMRegistrationScreen%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CHideOnlineAccountScreens%3Etrue%3C%2FHideOnlineAccountScreens%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CHideWirelessSetupInOOBE%3Etrue%3C%2FHideWirelessSetupInOOBE%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CNetworkLocation%3EWork%3C%2FNetworkLocation%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CSkipUserOOBE%3Etrue%3C%2FSkipUserOOBE%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CSkipMachineOOBE%3Etrue%3C%2FSkipMachineOOBE%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CProtectYourPC%3E1%3C%2FProtectYourPC%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FOOBE%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CUserAccounts%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CLocalAccounts%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CLocalAccount%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CPassword%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CValue%3E%3C%2FValue%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CPlainText%3Etrue%3C%2FPlainText%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FPassword%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDescription%3EAnJia%3C%2FDescription%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDisplayName%3EAnJia%3C%2FDisplayName%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CGroup%3EAdministrators%3C%2FGroup%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CName%3EAnJia%3C%2FName%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FLocalAccount%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FLocalAccounts%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FUserAccounts%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CRegisteredOrganization%3EAnJia%3C%2FRegisteredOrganization%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CRegisteredOwner%3EAnJia%3C%2FRegisteredOwner%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CDisableAutoDaylightTimeSet%3Efalse%3C%2FDisableAutoDaylightTimeSet%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CFirstLogonCommands%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CSynchronousCommand%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDescription%3EControl%20Panel%20View%3C%2FDescription%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrder%3E1%3C%2FOrder%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CCommandLine%3Ereg%20add%20%5C%22HKEY_CURRENT_USER%5C%5CSoftware%5C%5CMicrosoft%5C%5CWindows%5C%5CCurrentVersion%5C%5CExplorer%5C%5CControlPanel%5C%22%20%2Fv%20StartupPage%20%2Ft%20REG_DWORD%20%2Fd%201%20%2Ff%3C%2FCommandLine%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CRequiresUserInput%3Etrue%3C%2FRequiresUserInput%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FSynchronousCommand%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CSynchronousCommand%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrder%3E2%3C%2FOrder%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDescription%3EControl%20Panel%20Icon%20Size%3C%2FDescription%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CRequiresUserInput%3Efalse%3C%2FRequiresUserInput%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CCommandLine%3Ereg%20add%20%5C%22HKEY_CURRENT_USER%5C%5CSoftware%5C%5CMicrosoft%5C%5CWindows%5C%5CCurrentVersion%5C%5CExplorer%5C%5CControlPanel%5C%22%20%2Fv%20AllItemsIconView%20%2Ft%20REG_DWORD%20%2Fd%200%20%2Ff%3C%2FCommandLine%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FSynchronousCommand%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CSynchronousCommand%20wcm%3Aaction%3D%5C%22add%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3COrder%3E3%3C%2FOrder%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CRequiresUserInput%3Efalse%3C%2FRequiresUserInput%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CCommandLine%3Ecmd%20%2FC%20wmic%20useraccount%20where%20name%3D%5C%22AnJia%5C%22%20set%20PasswordExpires%3Dfalse%3C%2FCommandLine%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDescription%3EPassword%20Never%20Expires%3C%2FDescription%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FSynchronousCommand%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FFirstLogonCommands%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CTimeZone%3EChina%20Standard%20Time%3C%2FTimeZone%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fcomponent%3E%5Cn%20%20%20%20%3C%2Fsettings%3E%5Cn%3C%2Funattend%3E%22%7D\"></card><p><br /></p><h3 id=\"727af9d3\">配置samba</h3><p>在Cobbler上执行</p><h4 id=\"0125c65d\">安装samba</h4><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20yum%20install%20samba%20-y%22%7D\"></card><h4 id=\"6f1032ee\">修改smb config</h4><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20vi%20%2Fetc%2Fsamba%2Fsmb.conf%5Cn%20%5Cn%23%20%2Fetc%2Fsamba%2Fsmb.conf%5Cn%5Bglobal%5D%5Cnlog%20file%20%3D%20%2Fvar%2Flog%2Fsamba%2Flog.%25m%5Cnmax%20log%20size%20%3D%205000%5Cnsecurity%20%3D%20user%5Cnguest%20account%20%3D%20nobody%5Cnmap%20to%20guest%20%3D%20Bad%20User%5Cnload%20printers%20%3D%20yes%5Cncups%20options%20%3D%20raw%5Cn%20%5Cn%5Bshare%5D%5Cncomment%20%3D%20share%20directory%E7%9B%AE%E5%BD%95%5Cnpath%20%3D%20%2Fsmb%2F%5Cndirectory%20mask%20%3D%200755%5Cncreate%20mask%20%3D%200755%5Cnguest%20ok%3Dyes%5Cnwritable%3Dyes%22%7D\"></card><p><br /></p><h4 id=\"9b9fd94f\">启动smb服务</h4><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20service%20smb%20start%5Cn%5Broot%40localhost%20~%5D%23%20systemctl%20enable%20smb%22%7D\"></card><p><br /></p><h4 id=\"6e499122\">挂载win10系统</h4><p>通过winscp等软件将 cn_windows_10_business_edition_version_1809_updated_sept_2018_x64_dvd_84ac403f.iso 上传到cobbler服务器上,并将创建的应答文件，上传到cobbler <code>/smb/win/win10_x64_bios_auto.xml</code> </p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20mkdir%20-p%20%2Fsmb%2Fwin%5Cn%5Broot%40localhost%20~%5D%23%20mount%20-o%20loop%2Cro%20%2Ftmp%2Fcn_windows_10_business_edition_version_1809_updated_sept_2018_x64_dvd_84ac403f.iso%20%2Fmnt%2F%5Cn%5Broot%40localhost%20~%5D%23%20cp%20-r%20%2Fmnt%2F*%20%2Fsmb%2Fwin%5Cn%5Broot%40localhost%20~%5D%23%20umount%20%2Fmnt%2F%22%7D\"></card><p><br /></p><h3 id=\"a23d1d1f\">自动化安装Windows10</h3><p>从vmware创建一台内存4G，cpu2核，磁盘60G的空盘，win10虚拟机，然后开机。记得选BIOS，别选UEFI。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1551110723753-c7785e92-60be-4a90-a606-96bc92306aaa.png%22%2C%22originWidth%22%3A720%2C%22originHeight%22%3A400%2C%22name%22%3A%22Snipaste_2019-02-26_00-05-00.png%22%2C%22size%22%3A5025%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A720%2C%22height%22%3A400%7D\"></card></p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1551110627345-af185562-5a0f-4b4c-98ef-68974880a6a3.png%22%2C%22originWidth%22%3A1024%2C%22originHeight%22%3A768%2C%22name%22%3A%22Snipaste_2019-02-25_23-44-27.png%22%2C%22size%22%3A19684%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A560%7D\"></card></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1551112320786-fc312bb1-ce6c-4771-864f-e8900a1aed58.png%22%2C%22originWidth%22%3A1024%2C%22originHeight%22%3A768%2C%22name%22%3A%22image.png%22%2C%22size%22%3A233953%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A1024%2C%22height%22%3A768%7D\"></card></p><p><br /></p><p>至于如何激活，参考  <a href=\"http://bbs.pcbeta.com/viewthread-1796113-1-1.html\" target=\"_blank\">vlmcsd搭建KMS服务器，成功激活Server 2019数据中心版本，全网应是我首发</a></p><p><br /></p><h2 id=\"31f87578\">Windows Server 2019</h2><p>因为2019用的也是1809版本的，所以制作步骤一样的，在此不再赘述。</p><h2 id=\"35808e79\">参考资料</h2><p><br /></p><ul><li><a href=\"https://www.cnblogs.com/pluse/p/8508538.html\" target=\"_blank\">使用Cobbler批量部署Linux和Windows：Windows系统批量安装（三）</a></li><li><a href=\"https://blog.csdn.net/greless/article/details/52815716\" target=\"_blank\">WINPE镜像制作-startnet.cmd详解</a></li><li><a href=\"https://msdn.microsoft.com/zh-cn/library/windows/hardware/dn898524(v=vs.85).aspx\" target=\"_blank\">Windows 中的默认输入配置文件（输入区域设置）</a></li><li><a href=\"https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/update-windows-settings-and-scripts-create-your-own-answer-file-sxs\" target=\"_blank\">Answer files (unattend.xml)</a></li><li><a href=\"http://www.windowsafg.com/win10x86_x64.html\" target=\"_blank\">Windows Answer File Generator#win10_x86_64</a></li><li><a href=\"https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/winpe-mount-and-customize\" target=\"_blank\">WinPE: Mount and Customize</a></li><li><a href=\"https://docs.microsoft.com/en-us/windows-hardware/customize/desktop/unattend/components-b-unattend\" target=\"_blank\">Components</a></li><li><a href=\"https://www.windowscentral.com/how-create-unattended-media-do-automated-installation-windows-10\" target=\"_blank\">How to create an unattended installation of Windows 10</a></li><li> <a href=\"http://bbs.pcbeta.com/viewthread-1796113-1-1.html\" target=\"_blank\">vlmcsd搭建KMS服务器，成功激活Server 2019数据中心版本，全网应是我首发</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /><cursor /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-02-26T00:36:38.000Z",
    "deleted_at": null,
    "created_at": "2019-02-25T13:50:12.000Z",
    "updated_at": "2019-02-26T00:36:38.000Z",
    "published_at": "2019-02-26T00:36:38.000Z",
    "first_published_at": "2019-02-25T16:44:05.000Z",
    "word_count": 4296,
    "cover": "https://cdn.nlark.com/yuque/0/2019/png/226273/1551113039570-6bdc0ebe-9ecf-4ea4-8f89-21dcfd41c350.png",
    "description": "date: 2019-02-22 15:46:00tags: [pxe,dhcp,cobbler,centos,ubuntu,windows,tftp,win10,server-2019]categories: 运维---这是坚持技术写作计划（含翻译）的第7篇，定个小目标999，每周最少2篇。...",
    "custom_description": "这是坚持技术写作计划（含翻译）的第7篇，定个小目标999，每周最少2篇。本文主要讲解通过CentOS7.6 安装Cobbler并且自动化安装Windows10 和Windows Server 2019 ...",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1283928,
    "slug": "cobbler",
    "title": "006-Cobbler批量自动化部署CentOS/Ubuntu/Windows",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-02-22 15:46:00<br />tags: [pxe,dhcp,cobbler,centos,ubuntu,windows,tftp]<br />categories: 运维<br />---\n\n> 这是坚持技术写作计划（含翻译）的第6篇，定个小目标999，每周最少2篇。\n\n\n本文主要讲解通过CentOS7.6 Minimal + Cobbler 自动化安装CentOS,Ubuntu,Windows\n\n<a name=\"424a2ad8\"></a>\n## 准备\n从阿里镜像站，下载 [CentOS-7-x86_64-Minimal-1810.iso](https://mirrors.aliyun.com/centos/7.6.1810/isos/x86_64/CentOS-7-x86_64-Minimal-1810.iso) 和 [ubuntu-16.04.5-desktop-amd64.iso](https://mirrors.aliyun.com/ubuntu-releases/releases/releases/16.04.5/ubuntu-16.04.5-desktop-amd64.iso) ，使用VMware创建一台CentOS7的虚拟机。\n\n<a name=\"eb49d426\"></a>\n### 环境初始化\n1.改为阿里源\n\n```bash\n# yum源\n# 备份系统默认源\n[root@localhost ~]# mkdir /etc/yum.repos.d/old && mv /etc/yum.repos.d/C* /etc/yum.repos.d/old/\n[root@localhost ~]# yum clean all\n# 设置阿里yum源\n[root@localhost ~]# curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\n[root@localhost ~]# curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\n\n# pip源(2.8.4的bug)\n[root@localhost ~]# mkdir ~/.pip\n[root@localhost ~]# cat > ~/.pip/pip.conf << EOF\n[global]\ntrusted-host=mirrors.aliyun.com\nindex-url=https://mirrors.aliyun.com/pypi/simple/\nEOF\n```\n\n2.配置ssh\n\n默认ssh_config启用了DNS解析，导致每次远程ssh时都特别慢\n```bash\n[root@localhost ~]# sed -i 's%#UseDNS yes%UseDNS no%' /etc/ssh/sshd_config \n[root@localhost ~]# service sshd restart\n```\n~~3.~~[~~配置SElinux~~](https://access.redhat.com/documentation/en-us/red_hat_network_satellite/5.3/html/reference_guide/ch-cobbler#s3-cobbler-reqs-security-selinux)<br />~~如果要在Centos上开启Cobbler的支持，需要用root用户运行 `setsebool` ，注意 `-P` 参数确保重启仍然生效。~~<br />~~同时需要配置SELinux上下文规则(CentOS 7 Minimal默认不安装 `semanage` )，用于提供引导镜像。~~<br />按照红帽的5.4的教程，设置不生效，所以，禁用SELinux\n```bash\n#//.. setsebool -P httpd_can_network_connect true\n#//.. yum provides semanage\n#//.. yum -y install policycoreutils-python.x86_64\n#//.. semanage fcontext -a -t public_content_t \"/var/lib/tftpboot/.*\"\n[root@localhost ~]# sed -i '/SELINUX/s/enforcing/disabled/' /etc/selinux/config  \n[root@localhost ~]# setenforce 0\n```\n4.[配置防火墙](https://access.redhat.com/documentation/en-us/red_hat_network_satellite/5.3/html/reference_guide/ch-cobbler#s3-cobbler-reqs-security-iptables)\n\n```bash\n# TFTP\n[root@localhost ~]# firewall-cmd --zone=public --add-port=69/tcp --permanent\n[root@localhost ~]# firewall-cmd --zone=public --add-port=69/udp --permanent\n\n# HTTPD\n[root@localhost ~]# firewall-cmd --zone=public --add-port=80/tcp --permanent\n[root@localhost ~]# firewall-cmd --zone=public --add-port=443/tcp --permanent\n\n# Cobbler\n[root@localhost ~]# firewall-cmd --zone=public --add-port=25150/tcp --permanent\n[root@localhost ~]# firewall-cmd --zone=public --add-port=25150/udp --permanent\n\n# Koan 如果未用到，可以不开放\n[root@localhost ~]# firewall-cmd --zone=public --add-port=25151/tcp --permanent\n\n# samba window安装需要用到samba,否则可以不开放\n[root@localhost ~]# firewall-cmd --zone=public --add-port=139/tcp --permanent\n[root@localhost ~]# firewall-cmd --zone=public --add-port=445/tcp --permanent\n[root@localhost ~]# firewall-cmd --zone=public --add-port=137/udp --permanent\n[root@localhost ~]# firewall-cmd --zone=public --add-port=138/udp --permanent\n\n# 更新防火墙规则\n[root@localhost ~]# firewall-cmd --reload\n\n# 查看所有打开的端口\n[root@localhost ~]# firewall-cmd --zone=public --list-ports\n```\n\n<a name=\"7abcbeda\"></a>\n## 安装Cobbler\n\n<a name=\"5fc688fa\"></a>\n### 安装依赖软件\n\n```bash\n[root@localhost ~]# yum install -y cobbler cobbler-web dhcp tftp-server pykickstart httpd xinetd\n```\n\n<a name=\"9d785a63\"></a>\n### 设置开机自启动\n\n```bash\n[root@localhost ~]# systemctl enable httpd\n[root@localhost ~]# systemctl enable xinetd\n[root@localhost ~]# systemctl enable rsyncd\n[root@localhost ~]# systemctl enable tftp\n[root@localhost ~]# systemctl enable cobblerd\n```\n\n<a name=\"33d81c9d\"></a>\n### 启动服务\n\n```bash\n[root@localhost ~]# systemctl start httpd\n[root@localhost ~]# systemctl start xinetd\n[root@localhost ~]# systemctl start tftp\n[root@localhost ~]# systemctl start cobblerd\n```\n\n<a name=\"239c3f37\"></a>\n### 检查配置\n\n```bash\n[root@localhost ~]# cobbler check\nThe following are potential configuration items that you may want to fix:\n\n1 : The 'server' field in /etc/cobbler/settings must be set to something other than localhost, or kickstarting features will not work.  This should be a resolvable hostname or IP for the boot server as reachable by all machines that will use it.\n2 : For PXE to be functional, the 'next_server' field in /etc/cobbler/settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.\n3 : SELinux is enabled. Please review the following wiki page for details on ensuring cobbler works correctly in your SELinux environment:\n    https://github.com/cobbler/cobbler/wiki/Selinux\n4 : change 'disable' to 'no' in /etc/xinetd.d/tftp\n5 : Some network boot-loaders are missing from /var/lib/cobbler/loaders, you may run 'cobbler get-loaders' to download them, or, if you only want to handle x86/x86_64 netbooting, you may ensure that you have installed a *recent* version of the syslinux package installed and can ignore this message entirely.  Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The 'cobbler get-loaders' command is the easiest way to resolve these requirements.\n6 : debmirror package is not installed, it will be required to manage debian deployments and repositories\n7 : The default password used by the sample templates for newly installed machines (default_password_crypted in /etc/cobbler/settings) is still set to 'cobbler' and should be changed, try: \"openssl passwd -1 -salt 'random-phrase-here' 'your-password-here'\" to generate new one\n8 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them\n\nRestart cobblerd and then run 'cobbler sync' to apply changes.\n```\n\n1,2：<br />`cobbler_ip` 为cobbler主机ip<br />`next_server` 是dhcp主机ip，但是本实验dhcp和cobbler是一台\n```bash\n[root@localhost ~]# export cobbler_ip=192.168.0.12\n[root@localhost ~]# sed -i \"s%^server: 127.0.0.1%server: ${cobbler_ip}%g\" /etc/cobbler/settings\n[root@localhost ~]# sed -i \"s%^next_server: 127.0.0.1%next_server: ${cobbler_ip}%g\" /etc/cobbler/settings\n```\n\n3： 可以忽略，因为已经配置SELinux和防火墙了\n\n4：开启tftp功能\n```bash\n[root@localhost ~]# sed -i '/disable\\>/s/\\<yes\\>/no/' /etc/xinetd.d/tftp\n```\n\n5：下载bootload\n```bash\n[root@localhost ~]# cobbler get-loaders\n```\n\n6：下载ubuntu本地包镜像（不装ubuntu的，可以不用改）\n```bash\n[root@localhost ~]# yum install -y debmirror\n[root@localhost ~]# sed -i 's%^@dists=\"sid\"%#@dists=\"sid\"%g;s%@arches=\"i386\"%#@arches=\"i386\"%g' /etc/debmirror.conf\n```\n\n7：设置安装系统后的root密码\n```bash\n[root@localhost ~]# export root_pwd=$(openssl passwd -1 -salt `openssl rand 15 -base64` 'Abcd1234!@#$')\n[root@localhost ~]# sed -i \"s%^default_password_crypted.*%default_password_crypted: \\\"${root_pwd}\\\"%g\" /etc/cobbler/settings\n```\n\n8：电源管理模块(非必选)，cman和ence-agents二选一即可,此处忽略\n\n其余修改：\n```bash\n[root@localhost ~]# sed -i \"s%manage_dhcp: 0%manage_dhcp: 1%g\" /etc/cobbler/settings\n[root@localhost ~]# sed -i \"s%pxe_just_once: 0%pxe_just_once: 1%g\" /etc/cobbler/settings\n```\n\n修改dhcp\n\n```bash\n[root@localhost ~]# vi /etc/cobbler/dhcp.template\n\\#仅列出修改过的部分\n\\......\nsubnet 192.168.0.0 netmask 255.255.255.0 {\n     option routers             192.168.0.1;\n     option domain-name-servers 192.168.0.1;\n     option subnet-mask         255.255.255.0;\n     range dynamic-bootp        192.168.0.100 192.168.0.200;\n\\......\n```\n\n重启服务\n\n```bash\n[root@localhost ~]# systemctl restart httpd\n[root@localhost ~]# systemctl restart xinetd\n[root@localhost ~]# systemctl restart tftp\n[root@localhost ~]# systemctl restart cobblerd\n```\n\n再次校验,发现只有两条信息了，忽略即可。\n```bash\n[root@localhost ~]# cobbler check\nThe following are potential configuration items that you may want to fix:\n\n1 : SELinux is enabled. Please review the following wiki page for details on ensuring cobbler works correctly in your SELinux environment:\n    https://github.com/cobbler/cobbler/wiki/Selinux\n2 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them\n\nRestart cobblerd and then run 'cobbler sync' to apply changes.\n```\n\n执行 `cobbler sync` 同步信息\n```bash\n[root@localhost ~]# cobbler sync\ntask started: 2019-02-22_184309_sync\ntask started (id=Sync, time=Fri Feb 22 18:43:09 2019)\nrunning pre-sync triggers\n# ....忽略\nrunning python trigger cobbler.modules.scm_track\nrunning shell triggers from /var/lib/cobbler/triggers/change/*\n*** TASK COMPLETE ***\n```\n\n<a name=\"cobbler-web\"></a>\n### cobbler-web\n<a name=\"8ac7b7b1\"></a>\n#### 修复2.8.4 bug\n打开 `https://${cobbler_ip}/cobbler_web` 注意是 `https` 但是2.8.4有个bug，会导致打开后报500 `Internal Server Error` 错误 ,是因为  `django` 版本太高了 (参加 [cobbler 2.8.4/2.8.0 on centos 7 error ](https://github.com/cobbler/cobbler/issues/1959))\n\n```bash\n[root@localhost ~]# yum install -y python-pip\n[root@localhost ~]# pip2.7 install -U django==1.9.13\n[root@localhost ~]# systemctl restart cobblerd\n```\n\n<a name=\"545e05cf\"></a>\n#### 设置用户名密码\n默认用户名密码是 cobbler/cobbler\n```bash\n[root@localhost ~]# htdigest -c /etc/cobbler/users.digest Cobbler cobbler # 后边这个是用户名\n[root@localhost ~]# systemctl restart cobblerd\n```\n\n再次打开 `https://${cobbler_ip}/cobbler_web` <br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1550854050621-8cd8b769-08c5-457e-9e1f-e85d64c10479.png#align=left&display=inline&height=519&name=image.png&originHeight=519&originWidth=543&size=42554&status=done&width=543)\n\n<a name=\"2074d2c5\"></a>\n### 挂载镜像\n通过 winscp,mobaxterm等将ubuntu和centos镜像上传到Cobbler服务器上的 `/tmp/` 目录下,其中 `net.ifnames=0 biosdevname=0 noipv6` 是让网卡统一命名成 `eth0` \n\n```bash\n[root@localhost ~]# mount -t iso9660 -o loop /tmp/CentOS-7-x86_64-Minimal-1810.iso /mnt/\n[root@localhost ~]# cobbler import --name=CentOS-7.6.1810-x86_64 --path=/mnt/ --arch=x86_64\n[root@localhost ~]# cobbler profile edit --name=CentOS-7.6.1810-x86_64 --kopts='net.ifnames=0 biosdevname=0'\n[root@localhost ~]# mount -t iso9660 -o loop /tmp/ubuntu-16.04.5-server-amd64.iso /mnt/\n[root@localhost ~]# cobbler import --name=ubuntu-16.04.5-server-x86_64 --path=/mnt/ --arch=x86_64\n```\n\n<a name=\"9135d7d4\"></a>\n### 测试PXE安装系统\n在vmware创建两个虚拟机(选择空白盘),内存2G，CPU2核，磁盘20G，创建完后，记得打个快照，后边做实验失败后，直接恢复即可。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1550853771456-0e9b5af8-6bfe-44e0-83ed-22cf06deb895.png#align=left&display=inline&height=400&name=image.png&originHeight=400&originWidth=720&size=11329&status=done&width=720)<br />选择CentOS，然后回车，系统将自动安装\n\n<a name=\"11e7dd08\"></a>\n## 优化配置\n\n<a name=\"332f378a\"></a>\n### CentOS ks\n\n```bash\n[root@localhost ~]# cobbler profile report --name CentOS-7.6.1810-x86_64\nName                           : CentOS-7.6.1810-x86_64\n#//...忽略\nKickstart                      : /var/lib/cobbler/kickstarts/sample_end.ks\n#//...忽略\n#//复制一份ks，并且进行修改\n[root@localhost ~]# cp /var/lib/cobbler/kickstarts/sample_end.ks /var/lib/cobbler/kickstarts/centos-7-6.ks\n[root@localhost ~]# cobbler profile edit --name CentOS-7.6.1810-x86_64  --kickstart=/var/lib/cobbler/kickstarts/centos-7-6.ks\n[root@localhost ~]# cp /var/lib/cobbler/kickstarts/sample.seed /var/lib/cobbler/kickstarts/ubuntu-16-4-5.seed\n[root@localhost ~]# cobbler profile edit --name ubuntu-16.04.5-server-x86_64  --kickstart=/var/lib/cobbler/kickstarts/ubuntu-16-4-5.seed \n```\n\n具体CentOS的ks语法可以参考这里：[KICKSTART 语法参考](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax)。另外可以参考 [运维工作笔记-Cobbler 配置文件](https://www.kancloud.cn/devops-centos/centos-linux-devops/392369)<br />具体Ubuntu的Preseed可以参考这里：[Preseed语法参考](https://www.debian.org/releases/stable/amd64/apbs04.html.zh-cn)。\n\n吐槽一下，cobbler代码中检测到是ubuntu时，会自动将ks换成url(强制走preseed)，而用惯了ks的，用preseed还是很不习惯的，可以看一下 [Support selection of automatic installation file format in distros which allow it (Debian/Ubuntu allows kickstart and preseed) ](https://github.com/cobbler/cobbler/issues/1262)和 [Problems Provisioning Ubuntu with Cobbler and Kickstart Profiles](https://thornelabs.blog/posts/problems-provisioning-ubuntu-with-cobbler-and-kickstart-profiles.html)<br />此处贴一下 /var/lib/cobbler/kickstarts/ubuntu-16-4-5.seed \n\n```bash\n# Mostly based on the Ubuntu installation guide\n# https://help.ubuntu.com/16.04/installation-guide/\n# Debian sample\n# https://www.debian.org/releases/stable/example-preseed.txt\n\n## Part 1. Localization\n\n# Preseeding only locale sets language, country and locale.\nd-i debian-installer/locale string en_US\n\n# Keyboard selection.\n# Disable automatic (interactive) keymap detection.\nd-i console-setup/ask_detect boolean false\nd-i keyboard-configuration/toggle select No toggling\nd-i keyboard-configuration/layoutcode string us\nd-i keyboard-configuration/variantcode string\n\n## Part 2. Network configuration\n# netcfg will choose an interface that has link if possible. This makes it\n# skip displaying a list if there is more than one interface.\n#set $myhostname = $getVar('hostname',$getVar('name','cobbler')).replace(\"_\",\"-\")\nd-i netcfg/choose_interface select auto\nd-i netcfg/get_hostname string $myhostname\n\n# If non-free firmware is needed for the network or other hardware, you can\n# configure the installer to always try to load it, without prompting. Or\n# change to false to disable asking.\n# d-i hw-detect/load_firmware boolean true\n\n## Part 3 NTP/Time\n# NTP/Time Setup\nd-i time/zone string Asia/Shanghai\nd-i clock-setup/utc boolean true\nd-i clock-setup/ntp boolean true\nd-i clock-setup/ntp-server  string ntp1.aliyun.com\n\n## Part 4. Mirror settings\n# Setup the installation source\nd-i mirror/country string manual\nd-i mirror/http/hostname string $http_server\nd-i mirror/http/directory string $install_source_directory\nd-i mirror/http/proxy string\n\n#set $os_v = $getVar('os_version','')\n#if $breed == \"ubuntu\" and $os_v and ($os_v.lower()[0] > 'p' or $os_v.lower()[0] < 'd')\n# Required at least for ubuntu 12.10+ , so test os_v is higher than precise and lower than drapper\nd-i live-installer/net-image string http://$http_server/cobbler/links/$distro_name/install/filesystem.squashfs\n#end if\n\n# Suite to install.\n# d-i mirror/suite string precise\n# d-i mirror/udeb/suite string precise\n\n# Components to use for loading installer components (optional).\n#d-i mirror/udeb/components multiselect main, restricted\n\n## Part 4. Partitioning\n\n# Disk Partitioning\n# Use LVM, and wipe out anything that already exists\nd-i partman/choose_partition select finish\nd-i partman/confirm boolean true\nd-i partman/confirm_nooverwrite boolean true\nd-i partman-auto/method string lvm\nd-i partman-lvm/device_remove_lvm boolean true\nd-i partman-lvm/confirm boolean true\nd-i partman-lvm/confirm_nooverwrite boolean true\nd-i partman-md/device_remove_md boolean true\nd-i partman-partitioning/confirm_write_new_label boolean true\n\n# You can choose one of the three predefined partitioning recipes:\n# - atomic: all files in one partition\n# - home:   separate /home partition\n# - multi:  separate /home, /usr, /var, and /tmp partitions\nd-i partman-auto/choose_recipe select atomic\n\n# If you just want to change the default filesystem from ext3 to something\n# else, you can do that without providing a full recipe.\n# d-i partman/default_filesystem string ext4\n\n## Part 5. Account setup\n\n# root account and password\nd-i passwd/root-login boolean true\nd-i passwd/root-password-crypted password $default_password_crypted\n\n# skip creation of a normal user account.\nd-i passwd/make-user boolean true\nd-i passwd/user-fullname  string anjia\nd-i passwd/username       string anjia\nd-i passwd/user-password-crypted password $default_password_crypted\n\n## Part 6. Apt setup\n\n# You can choose to install restricted and universe software, or to install\n# software from the backports repository.\n# d-i apt-setup/restricted boolean true\n# d-i apt-setup/universe boolean true\n# d-i apt-setup/backports boolean true\n\n# Uncomment this if you don't want to use a network mirror.\n# d-i apt-setup/use_mirror boolean true\n\n# Select which update services to use; define the mirrors to be used.\n# Values shown below are the normal defaults.\n# d-i apt-setup/services-select multiselect security\n# d-i apt-setup/security_host string mirrors.aliyun.com\n# d-i apt-setup/security_path string /ubuntu\n\n$SNIPPET('preseed_apt_repo_config')\n\n# Enable deb-src lines\n# d-i apt-setup/local0/source boolean true\n\n# URL to the public key of the local repository; you must provide a key or\n# apt will complain about the unauthenticated repository and so the\n# sources.list line will be left commented out\n# d-i apt-setup/local0/key string http://local.server/key\n\n# By default the installer requires that repositories be authenticated\n# using a known gpg key. This setting can be used to disable that\n# authentication. Warning: Insecure, not recommended.\n# d-i debian-installer/allow_unauthenticated boolean true\n\n## Part 7. Package selection\n# Default for minimal\ntasksel tasksel/first multiselect standard\n# Default for server\n# tasksel tasksel/first multiselect standard, web-server\n# Default for gnome-desktop\n# tasksel tasksel/first multiselect standard, gnome-desktop\n\n# Individual additional packages to install\n# wget is REQUIRED otherwise quite a few things won't work\n# later in the build (like late-command scripts)\nd-i pkgsel/include string ntp ssh wget \n\n# Debian needs this for the installer to avoid any question for grub\n# Please verify that it suit your needs as it may overwrite any usb stick\n#if $breed == \"debian\"\nd-i grub-installer/grub2_instead_of_grub_legacy boolean true\nd-i grub-installer/bootdev string default\n#end if\n\n# Use the following option to add additional boot parameters for the\n# installed system (if supported by the bootloader installer).\n# Note: options passed to the installer will be added automatically.\nd-i debian-installer/add-kernel-opts string $kernel_options_post\n\n# Avoid that last message about the install being complete.\nd-i finish-install/reboot_in_progress note\n\n## Figure out if we're kickstarting a system or a profile\n#if $getVar('system_name','') != ''\n#set $what = \"system\"\n#else\n#set $what = \"profile\"\n#end if\n\n# This first command is run as early as possible, just after preseeding is read.\n# d-i preseed/early_command string [command]\nd-i preseed/early_command string wget -O- \\\n   http://$http_server/cblr/svc/op/script/$what/$name/?script=preseed_early_default | \\\n   /bin/sh -s\n\n# This command is run immediately before the partitioner starts. It may be\n# useful to apply dynamic partitioner preseeding that depends on the state\n# of the disks (which may not be visible when preseed/early_command runs).\n# d-i partman/early_command \\\n#       string debconf-set partman-auto/disk \"\\$(list-devices disk | head -n1)\"\n\n# This command is run just before the install finishes, but when there is\n# still a usable /target directory. You can chroot to /target and use it\n# directly, or use the apt-install and in-target commands to easily install\n# packages and run commands in the target system.\n# d-i preseed/late_command string [command]\nd-i preseed/late_command string wget -O- \\\n   http://$http_server/cblr/svc/op/script/$what/$name/?script=preseed_late_default | \\\n   chroot /target /bin/sh -s\n```\n\n<a name=\"516808f3\"></a>\n### 创建snippets\n\n安装完后，自动安装软件,参考 [Using template scripts for Debian and Ubuntu seeds](https://github.com/cobbler/cobbler/wiki/Using%20template%20scripts%20for%20Debian%20and%20Ubuntu%20seeds)\n```bash\n[root@localhost ~]# tee /var/lib/cobbler/snippets/ubuntu_apt_install_soft <<-'EOF'\n\napt-get update\napt-get install -y language-pack-zh-hans apt-transport-https ca-certificates software-properties-common  git ansible openssh-server vim curl htop iotop iftop ncdu\n\ncurl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -\nsudo add-apt-repository \"deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable\"\napt-get update\n\napt-get install -y docker-ce=18.06.2~ce~3-0~ubuntu\napt-mark hold docker-ce\nsystemctl enable docker\nEOF\n\n## // d-i preseed/late_command 阶段执行\n[root@localhost ~]# echo '$SNIPPET(\"ubuntu_apt_install_soft\") >> /var/lib/cobbler/snippets/late_apt_repo_config\n```\n \n<a name=\"2a68d258\"></a>\n### 设置ubuntu package repo\n\n```bash\n[root@localhost ~]# cobbler repo edit --name=ubuntu-16.04.5-server-x86_64 --arch=x86_64 --breed=apt --mirror=http://mirrors.aliyun.com/ubuntu --owners=admin --mirror-locally=False --apt-components='main universe' --apt-dists='xenial xenial-updates xenial-security'\n[root@localhost ~]# cobbler profile edit --name=ubuntu-16.04.5-server-x86_64 --repos=ubuntu-16.04.5-server-x86_64\n```\n\n限于篇幅，下一篇，将介绍Cobbler安装Windows\n\n<a name=\"a08138fa\"></a>\n## 常见错误\n\n```bash\n[root@localhost ~]# cobbler check\ncobblerd does not appear to be running/accessible: error(111, 'Connection refused') \n```\n\n原因：未启动相关服务\n\n```bash\n[root@localhost ~]# cobbler check\nhttpd does not appear to be running and proxying cobbler, or SELinux is in the way. Original traceback:\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/site-packages/cobbler/cli.py\", line 251, in check_setup\n    s.ping()\n  File \"/usr/lib64/python2.7/xmlrpclib.py\", line 1233, in __call__\n    return self.__send(self.__name, args)\n  File \"/usr/lib64/python2.7/xmlrpclib.py\", line 1591, in __request\n    verbose=self.__verbose\n  File \"/usr/lib64/python2.7/xmlrpclib.py\", line 1273, in request\n    return self.single_request(host, handler, request_body, verbose)\n  File \"/usr/lib64/python2.7/xmlrpclib.py\", line 1321, in single_request\n    response.msg,\nProtocolError: <ProtocolError for 127.0.0.1:80/cobbler_api: 503 Service Unavailable>\n```\n未关闭防火墙\n\n```bash\n[root@localhost ~]# cobbler sync\nreceived on stderr: Redirecting to /bin/systemctl restart dhcpd.service\nJob for dhcpd.service failed because the control process exited with error code. See \"systemctl status dhcpd.service\" and \"journalctl -xe\" for details.\n\nException occured: <class 'cobbler.cexceptions.CX'>\nException value: 'cobbler trigger failed: cobbler.modules.sync_post_restart_services'\nException Info:\n  File \"/usr/lib/python2.7/site-packages/cobbler/remote.py\", line 82, in run\n    rc = self._run(self)\n   File \"/usr/lib/python2.7/site-packages/cobbler/remote.py\", line 181, in runner\n    return self.remote.api.sync(self.options.get(\"verbose\",False),logger=self.logger)\n   File \"/usr/lib/python2.7/site-packages/cobbler/api.py\", line 763, in sync\n    return sync.run()\n   File \"/usr/lib/python2.7/site-packages/cobbler/action_sync.py\", line 144, in run\n    utils.run_triggers(self.api, None, \"/var/lib/cobbler/triggers/sync/post/*\", logger=self.logger)\n   File \"/usr/lib/python2.7/site-packages/cobbler/utils.py\", line 928, in run_triggers\n    raise CX(\"cobbler trigger failed: %s\" % m.__name__)\n\n!!! TASK FAILED !!!\n```\n没改dhcp模板，导致sync同步出问题\n\n\n```bash\n[root@localhost ~]# cat /var/log/httpd/ssl_error_log\n[Fri Feb 22 20:07:49.460442 2019] [:error] [pid 6910] [remote 127.0.0.1:204] mod_wsgi (pid=6910): Exception occurred processing WSGI script '/usr/share/cobbler/web/cobbler.wsgi'.\n[Fri Feb 22 20:07:49.460559 2019] [:error] [pid 6910] [remote 127.0.0.1:204] Traceback (most recent call last):\n[Fri Feb 22 20:07:49.460605 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File \"/usr/share/cobbler/web/cobbler.wsgi\", line 26, in application\n[Fri Feb 22 20:07:49.460668 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     _application = get_wsgi_application()\n[Fri Feb 22 20:07:49.460684 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File \"/usr/lib/python2.7/site-packages/django/core/wsgi.py\", line 13, in get_wsgi_application\n[Fri Feb 22 20:07:49.460723 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     django.setup(set_prefix=False)\n[Fri Feb 22 20:07:49.460737 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File \"/usr/lib/python2.7/site-packages/django/__init__.py\", line 22, in setup\n[Fri Feb 22 20:07:49.460768 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     configure_logging(settings.LOGGING_CONFIG, settings.LOGGING)\n[Fri Feb 22 20:07:49.460781 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File \"/usr/lib/python2.7/site-packages/django/conf/__init__.py\", line 56, in __getattr__\n[Fri Feb 22 20:07:49.460812 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     self._setup(name)\n[Fri Feb 22 20:07:49.460824 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File \"/usr/lib/python2.7/site-packages/django/conf/__init__.py\", line 41, in _setup\n[Fri Feb 22 20:07:49.460852 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     self._wrapped = Settings(settings_module)\n[Fri Feb 22 20:07:49.460871 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File \"/usr/lib/python2.7/site-packages/django/conf/__init__.py\", line 110, in __init__\n[Fri Feb 22 20:07:49.460900 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     mod = importlib.import_module(self.SETTINGS_MODULE)\n[Fri Feb 22 20:07:49.460911 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File \"/usr/lib64/python2.7/importlib/__init__.py\", line 37, in import_module\n[Fri Feb 22 20:07:49.460953 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     __import__(name)\n[Fri Feb 22 20:07:49.460973 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File \"/usr/share/cobbler/web/settings.py\", line 89, in <module>\n[Fri Feb 22 20:07:49.460995 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     from django.conf.global_settings import TEMPLATE_CONTEXT_PROCESSORS\n[Fri Feb 22 20:07:49.461043 2019] [:error] [pid 6910] [remote 127.0.0.1:204] ImportError: cannot import name TEMPLATE_CONTEXT_PROCESSORS\n```\n`pip2.7 install -U django==1.9.13` \n\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [配置防火墙](https://access.redhat.com/documentation/en-us/red_hat_network_satellite/5.3/html/reference_guide/ch-cobbler#s3-cobbler-reqs-security-iptables)\n- [cobbler 2.8.4/2.8.0 on centos 7 error](https://github.com/cobbler/cobbler/issues/1959)\n- [KICKSTART 语法参考](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax)\n- [运维工作笔记-Cobbler 配置文件](https://www.kancloud.cn/devops-centos/centos-linux-devops/392369)\n- [Preseed语法参考](https://www.debian.org/releases/stable/amd64/apbs04.html.zh-cn)\n- [Support selection of automatic installation file format in distros which allow it (Debian/Ubuntu allows kickstart and preseed) ](https://github.com/cobbler/cobbler/issues/1262)\n- [Problems Provisioning Ubuntu with Cobbler and Kickstart Profiles](https://thornelabs.blog/posts/problems-provisioning-ubuntu-with-cobbler-and-kickstart-profiles.html)\n- [Using template scripts for Debian and Ubuntu seeds](https://github.com/cobbler/cobbler/wiki/Using%20template%20scripts%20for%20Debian%20and%20Ubuntu%20seeds)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。\n\n长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n",
    "body_draft": "",
    "body_html": "<p><span>date: 2019-02-22 15:46:00</span></p><p>tags: [pxe,dhcp,cobbler,centos,ubuntu,windows,tftp]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote style=\"padding-left: 1em;\"><p>这是坚持技术写作计划（含翻译）的第6篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要讲解通过CentOS7.6 Minimal + Cobbler 自动化安装CentOS,Ubuntu,Windows</p><p><br /></p><h2 id=\"424a2ad8\">准备</h2><p>从阿里镜像站，下载 <span><a href=\"https://mirrors.aliyun.com/centos/7.6.1810/isos/x86_64/CentOS-7-x86_64-Minimal-1810.iso\" target=\"_blank\">CentOS-7-x86_64-Minimal-1810.iso</a> 和 </span><span><span><a href=\"https://mirrors.aliyun.com/ubuntu-releases/releases/releases/16.04.5/ubuntu-16.04.5-desktop-amd64.iso\" target=\"_blank\">ubuntu-16.04.5-desktop-amd64.iso</a> ，使用VMware创建一台CentOS7的虚拟机。</span></span></p><p><span><span><br /></span></span></p><h3 id=\"eb49d426\">环境初始化</h3><p>1.改为阿里源</p><p><br /></p><pre data-lang=\"bash\"><code># yum源\n# 备份系统默认源\n[root@localhost ~]# mkdir /etc/yum.repos.d/old &amp;&amp; mv /etc/yum.repos.d/C* /etc/yum.repos.d/old/\n[root@localhost ~]# yum clean all\n# 设置阿里yum源\n[root@localhost ~]# curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\n[root@localhost ~]# curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\n\n# pip源(2.8.4的bug)\n[root@localhost ~]# mkdir ~/.pip\n[root@localhost ~]# cat &gt; ~/.pip/pip.conf &lt;&lt; EOF\n[global]\ntrusted-host=mirrors.aliyun.com\nindex-url=https://mirrors.aliyun.com/pypi/simple/\nEOF</code></pre><p><br /></p><p>2.配置ssh</p><p><br /></p><p>默认ssh_config启用了DNS解析，导致每次远程ssh时都特别慢</p><pre data-lang=\"bash\"><code>[root@localhost ~]# sed -i 's%#UseDNS yes%UseDNS no%' /etc/ssh/sshd_config \n[root@localhost ~]# service sshd restart</code></pre><p><del>3.</del><a href=\"https://access.redhat.com/documentation/en-us/red_hat_network_satellite/5.3/html/reference_guide/ch-cobbler#s3-cobbler-reqs-security-selinux\" target=\"_blank\"><del>配置SElinux</del></a></p><p><del>如果要在Centos上开启Cobbler的支持，需要用root用户运行 </del><del><code>setsebool</code></del><del> ，注意 </del><del><code>-P</code></del><del> 参数确保重启仍然生效。</del></p><p><del>同时需要配置SELinux上下文规则(CentOS 7 </del><del><span>Minimal</span></del><del>默认不安装 </del><del><code>semanage</code></del><del> )，用于提供引导镜像。</del></p><p>按照红帽的5.4的教程，设置不生效，所以，禁用SELinux</p><pre data-lang=\"bash\"><code>#//.. setsebool -P httpd_can_network_connect true\n#//.. yum provides semanage\n#//.. yum -y install policycoreutils-python.x86_64\n#//.. semanage fcontext -a -t public_content_t &quot;/var/lib/tftpboot/.*&quot;\n[root@localhost ~]# sed -i '/SELINUX/s/enforcing/disabled/' /etc/selinux/config  \n[root@localhost ~]# setenforce 0</code></pre><p>4.<a href=\"https://access.redhat.com/documentation/en-us/red_hat_network_satellite/5.3/html/reference_guide/ch-cobbler#s3-cobbler-reqs-security-iptables\" target=\"_blank\">配置防火墙</a></p><p><br /></p><pre data-lang=\"bash\"><code># TFTP\n[root@localhost ~]# firewall-cmd --zone=public --add-port=69/tcp --permanent\n[root@localhost ~]# firewall-cmd --zone=public --add-port=69/udp --permanent\n\n# HTTPD\n[root@localhost ~]# firewall-cmd --zone=public --add-port=80/tcp --permanent\n[root@localhost ~]# firewall-cmd --zone=public --add-port=443/tcp --permanent\n\n# Cobbler\n[root@localhost ~]# firewall-cmd --zone=public --add-port=25150/tcp --permanent\n[root@localhost ~]# firewall-cmd --zone=public --add-port=25150/udp --permanent\n\n# Koan 如果未用到，可以不开放\n[root@localhost ~]# firewall-cmd --zone=public --add-port=25151/tcp --permanent\n\n# samba window安装需要用到samba,否则可以不开放\n[root@localhost ~]# firewall-cmd --zone=public --add-port=139/tcp --permanent\n[root@localhost ~]# firewall-cmd --zone=public --add-port=445/tcp --permanent\n[root@localhost ~]# firewall-cmd --zone=public --add-port=137/udp --permanent\n[root@localhost ~]# firewall-cmd --zone=public --add-port=138/udp --permanent\n\n# 更新防火墙规则\n[root@localhost ~]# firewall-cmd --reload\n\n# 查看所有打开的端口\n[root@localhost ~]# firewall-cmd --zone=public --list-ports</code></pre><p><br /></p><h2 id=\"7abcbeda\">安装Cobbler</h2><p><br /></p><h3 id=\"5fc688fa\">安装依赖软件</h3><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# yum install -y cobbler cobbler-web dhcp tftp-server pykickstart httpd xinetd</code></pre><p><br /></p><h3 id=\"9d785a63\">设置开机自启动</h3><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# systemctl enable httpd\n[root@localhost ~]# systemctl enable xinetd\n[root@localhost ~]# systemctl enable rsyncd\n[root@localhost ~]# systemctl enable tftp\n[root@localhost ~]# systemctl enable cobblerd</code></pre><p><br /></p><h3 id=\"33d81c9d\">启动服务</h3><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# systemctl start httpd\n[root@localhost ~]# systemctl start xinetd\n[root@localhost ~]# systemctl start tftp\n[root@localhost ~]# systemctl start cobblerd</code></pre><p><br /></p><h3 id=\"239c3f37\">检查配置</h3><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# cobbler check\nThe following are potential configuration items that you may want to fix:\n\n1 : The 'server' field in /etc/cobbler/settings must be set to something other than localhost, or kickstarting features will not work.  This should be a resolvable hostname or IP for the boot server as reachable by all machines that will use it.\n2 : For PXE to be functional, the 'next_server' field in /etc/cobbler/settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.\n3 : SELinux is enabled. Please review the following wiki page for details on ensuring cobbler works correctly in your SELinux environment:\n    https://github.com/cobbler/cobbler/wiki/Selinux\n4 : change 'disable' to 'no' in /etc/xinetd.d/tftp\n5 : Some network boot-loaders are missing from /var/lib/cobbler/loaders, you may run 'cobbler get-loaders' to download them, or, if you only want to handle x86/x86_64 netbooting, you may ensure that you have installed a *recent* version of the syslinux package installed and can ignore this message entirely.  Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The 'cobbler get-loaders' command is the easiest way to resolve these requirements.\n6 : debmirror package is not installed, it will be required to manage debian deployments and repositories\n7 : The default password used by the sample templates for newly installed machines (default_password_crypted in /etc/cobbler/settings) is still set to 'cobbler' and should be changed, try: &quot;openssl passwd -1 -salt 'random-phrase-here' 'your-password-here'&quot; to generate new one\n8 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them\n\nRestart cobblerd and then run 'cobbler sync' to apply changes.</code></pre><p><br /></p><p>1,2：</p><p><code>cobbler_ip</code> 为cobbler主机ip</p><p><code>next_server</code> 是dhcp主机ip，但是本实验dhcp和cobbler是一台</p><pre data-lang=\"bash\"><code>[root@localhost ~]# export cobbler_ip=192.168.0.12\n[root@localhost ~]# sed -i &quot;s%^server: 127.0.0.1%server: ${cobbler_ip}%g&quot; /etc/cobbler/settings\n[root@localhost ~]# sed -i &quot;s%^next_server: 127.0.0.1%next_server: ${cobbler_ip}%g&quot; /etc/cobbler/settings</code></pre><p><br /></p><p>3： 可以忽略，因为已经配置SELinux和防火墙了</p><p><br /></p><p>4<span>：开启tftp功能</span></p><pre data-lang=\"bash\"><code>[root@localhost ~]# sed -i '/disable\\&gt;/s/\\&lt;yes\\&gt;/no/' /etc/xinetd.d/tftp</code></pre><p><br /></p><p>5：下载bootload</p><pre data-lang=\"bash\"><code>[root@localhost ~]# cobbler get-loaders</code></pre><p><br /></p><p>6：下载ubuntu本地包镜像（不装ubuntu的，可以不用改）</p><pre data-lang=\"bash\"><code>[root@localhost ~]# yum install -y debmirror\n[root@localhost ~]# sed -i 's%^@dists=&quot;sid&quot;%#@dists=&quot;sid&quot;%g;s%@arches=&quot;i386&quot;%#@arches=&quot;i386&quot;%g' /etc/debmirror.conf</code></pre><p><br /></p><p>7：设置安装系统后的root密码</p><pre data-lang=\"bash\"><code>[root@localhost ~]# export root_pwd=$(openssl passwd -1 -salt `openssl rand 15 -base64` 'Abcd1234!@#$')\n[root@localhost ~]# sed -i &quot;s%^default_password_crypted.*%default_password_crypted: \\&quot;${root_pwd}\\&quot;%g&quot; /etc/cobbler/settings</code></pre><p><br /></p><p>8：电源管理模块(非必选)，cman和ence-agents二选一即可,此处忽略</p><p><br /></p><p>其余修改：</p><pre data-lang=\"bash\"><code>[root@localhost ~]# sed -i &quot;s%manage_dhcp: 0%manage_dhcp: 1%g&quot; /etc/cobbler/settings\n[root@localhost ~]# sed -i &quot;s%pxe_just_once: 0%pxe_just_once: 1%g&quot; /etc/cobbler/settings</code></pre><p><br /></p><p>修改dhcp</p><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# vi /etc/cobbler/dhcp.template\n\\#仅列出修改过的部分\n\\......\nsubnet 192.168.0.0 netmask 255.255.255.0 {\n     option routers             192.168.0.1;\n     option domain-name-servers 192.168.0.1;\n     option subnet-mask         255.255.255.0;\n     range dynamic-bootp        192.168.0.100 192.168.0.200;\n\\......</code></pre><p><br /></p><p>重启服务</p><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# systemctl restart httpd\n[root@localhost ~]# systemctl restart xinetd\n[root@localhost ~]# systemctl restart tftp\n[root@localhost ~]# systemctl restart cobblerd</code></pre><p><br /></p><p>再次校验,发现只有两条信息了，忽略即可。</p><pre data-lang=\"bash\"><code>[root@localhost ~]# cobbler check\nThe following are potential configuration items that you may want to fix:\n\n1 : SELinux is enabled. Please review the following wiki page for details on ensuring cobbler works correctly in your SELinux environment:\n    https://github.com/cobbler/cobbler/wiki/Selinux\n2 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them\n\nRestart cobblerd and then run 'cobbler sync' to apply changes.</code></pre><p><br /></p><p>执行 <code>cobbler sync</code> 同步信息</p><pre data-lang=\"bash\"><code>[root@localhost ~]# cobbler sync\ntask started: 2019-02-22_184309_sync\ntask started (id=Sync, time=Fri Feb 22 18:43:09 2019)\nrunning pre-sync triggers\n# ....忽略\nrunning python trigger cobbler.modules.scm_track\nrunning shell triggers from /var/lib/cobbler/triggers/change/*\n*** TASK COMPLETE ***</code></pre><p><br /></p><h3 id=\"cobbler-web\">cobbler-web</h3><h4 id=\"8ac7b7b1\">修复2.8.4 bug</h4><p>打开 <code>https://${cobbler_ip}/cobbler_web</code> 注意是 <code>https</code> 但是2.8.4有个bug，会导致打开后报500 <code>Internal Server Error</code> 错误 ,是因为  <code>django</code> 版本太高了 (参加 <a href=\"https://github.com/cobbler/cobbler/issues/1959\" target=\"_blank\"><span>cobbler 2.8.4/2.8.0 on centos 7 error </span></a>)</p><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# yum install -y python-pip\n[root@localhost ~]# pip2.7 install -U django==1.9.13\n[root@localhost ~]# systemctl restart cobblerd</code></pre><p><br /></p><h4 id=\"545e05cf\">设置用户名密码</h4><p>默认用户名密码是 cobbler/cobbler</p><pre data-lang=\"bash\"><code>[root@localhost ~]# htdigest -c /etc/cobbler/users.digest Cobbler cobbler # 后边这个是用户名\n[root@localhost ~]# systemctl restart cobblerd</code></pre><p><br /></p><p>再次打开 <code>https://${cobbler_ip}/cobbler_web</code> </p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1550854050621-8cd8b769-08c5-457e-9e1f-e85d64c10479.png#align=left&amp;display=inline&amp;height=519&amp;name=image.png&amp;originHeight=519&amp;originWidth=543&amp;size=42554&amp;status=done&amp;width=543\" style=\"max-width: 600px; width: 543px;\" /></p><p><br /></p><h3 id=\"2074d2c5\">挂载镜像</h3><p>通过 winscp,mobaxterm等将ubuntu和centos镜像上传到Cobbler服务器上的 <code>/tmp/</code> 目录下,其中 <code>net.ifnames=0 biosdevname=0 noipv6</code> 是让网卡统一命名成 <code>eth0</code> </p><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# mount -t iso9660 -o loop /tmp/CentOS-7-x86_64-Minimal-1810.iso /mnt/\n[root@localhost ~]# cobbler import --name=CentOS-7.6.1810-x86_64 --path=/mnt/ --arch=x86_64\n[root@localhost ~]# cobbler profile edit --name=CentOS-7.6.1810-x86_64 --kopts='net.ifnames=0 biosdevname=0'\n[root@localhost ~]# mount -t iso9660 -o loop /tmp/ubuntu-16.04.5-server-amd64.iso /mnt/\n[root@localhost ~]# cobbler import --name=ubuntu-16.04.5-server-x86_64 --path=/mnt/ --arch=x86_64</code></pre><p><br /></p><h3 id=\"9135d7d4\">测试PXE安装系统</h3><p>在vmware创建两个虚拟机(选择空白盘),内存2G，CPU2核，磁盘20G，创建完后，记得打个快照，后边做实验失败后，直接恢复即可。</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1550853771456-0e9b5af8-6bfe-44e0-83ed-22cf06deb895.png#align=left&amp;display=inline&amp;height=400&amp;name=image.png&amp;originHeight=400&amp;originWidth=720&amp;size=11329&amp;status=done&amp;width=720\" style=\"max-width: 600px; width: 720px;\" /></p><p>选择CentOS，然后回车，系统将自动安装</p><p><br /></p><h2 id=\"11e7dd08\">优化配置</h2><p><br /></p><h3 id=\"332f378a\">CentOS ks</h3><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# cobbler profile report --name CentOS-7.6.1810-x86_64\nName                           : CentOS-7.6.1810-x86_64\n#//...忽略\nKickstart                      : /var/lib/cobbler/kickstarts/sample_end.ks\n#//...忽略\n#//复制一份ks，并且进行修改\n[root@localhost ~]# cp /var/lib/cobbler/kickstarts/sample_end.ks /var/lib/cobbler/kickstarts/centos-7-6.ks\n[root@localhost ~]# cobbler profile edit --name CentOS-7.6.1810-x86_64  --kickstart=/var/lib/cobbler/kickstarts/centos-7-6.ks\n[root@localhost ~]# cp /var/lib/cobbler/kickstarts/sample.seed /var/lib/cobbler/kickstarts/ubuntu-16-4-5.seed\n[root@localhost ~]# cobbler profile edit --name ubuntu-16.04.5-server-x86_64  --kickstart=/var/lib/cobbler/kickstarts/ubuntu-16-4-5.seed </code></pre><p><br /></p><p><span class=\"lake-fontsize-11\" style=\"color: #000000;\">具体CentOS的ks语法可以参考这里：</span><a href=\"https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax\" target=\"_blank\">KICKSTART 语法参考</a><span class=\"lake-fontsize-11\" style=\"color: #000000;\">。另外可以参考 </span><a href=\"https://www.kancloud.cn/devops-centos/centos-linux-devops/392369\" target=\"_blank\"><span class=\"lake-fontsize-11\" style=\"color: #000000;\">运维工作笔记-Cobbler 配置文件</span></a></p><p>具体Ubuntu的Preseed<span class=\"lake-fontsize-11\" style=\"color: #000000;\">可以参考这里：</span><a href=\"https://www.debian.org/releases/stable/amd64/apbs04.html.zh-cn\" target=\"_blank\">Preseed语法参考</a><span class=\"lake-fontsize-11\" style=\"color: #000000;\">。</span></p><p><span class=\"lake-fontsize-11\" style=\"color: #000000;\"><br /></span></p><p>吐槽一下，cobbler代码中检测到是ubuntu时，会自动将ks换成url(强制走preseed)，而用惯了ks的，用preseed还是很不习惯的，可以看一下 <span><a href=\"https://github.com/cobbler/cobbler/issues/1262\" target=\"_blank\">Support selection of automatic installation file format in distros which allow it (Debian/Ubuntu allows kickstart and preseed) </a>和 </span><a href=\"https://thornelabs.blog/posts/problems-provisioning-ubuntu-with-cobbler-and-kickstart-profiles.html\" target=\"_blank\"><span>Problems Provisioning Ubuntu with Cobbler and Kickstart Profiles</span></a></p><p>此处贴一下 /var/lib/cobbler/kickstarts/ubuntu-16-4-5.seed </p><p><br /></p><pre data-lang=\"bash\"><code># Mostly based on the Ubuntu installation guide\n# https://help.ubuntu.com/16.04/installation-guide/\n# Debian sample\n# https://www.debian.org/releases/stable/example-preseed.txt\n\n## Part 1. Localization\n\n# Preseeding only locale sets language, country and locale.\nd-i debian-installer/locale string en_US\n\n# Keyboard selection.\n# Disable automatic (interactive) keymap detection.\nd-i console-setup/ask_detect boolean false\nd-i keyboard-configuration/toggle select No toggling\nd-i keyboard-configuration/layoutcode string us\nd-i keyboard-configuration/variantcode string\n\n## Part 2. Network configuration\n# netcfg will choose an interface that has link if possible. This makes it\n# skip displaying a list if there is more than one interface.\n#set $myhostname = $getVar('hostname',$getVar('name','cobbler')).replace(&quot;_&quot;,&quot;-&quot;)\nd-i netcfg/choose_interface select auto\nd-i netcfg/get_hostname string $myhostname\n\n# If non-free firmware is needed for the network or other hardware, you can\n# configure the installer to always try to load it, without prompting. Or\n# change to false to disable asking.\n# d-i hw-detect/load_firmware boolean true\n\n## Part 3 NTP/Time\n# NTP/Time Setup\nd-i time/zone string Asia/Shanghai\nd-i clock-setup/utc boolean true\nd-i clock-setup/ntp boolean true\nd-i clock-setup/ntp-server  string ntp1.aliyun.com\n\n## Part 4. Mirror settings\n# Setup the installation source\nd-i mirror/country string manual\nd-i mirror/http/hostname string $http_server\nd-i mirror/http/directory string $install_source_directory\nd-i mirror/http/proxy string\n\n#set $os_v = $getVar('os_version','')\n#if $breed == &quot;ubuntu&quot; and $os_v and ($os_v.lower()[0] &gt; 'p' or $os_v.lower()[0] &lt; 'd')\n# Required at least for ubuntu 12.10+ , so test os_v is higher than precise and lower than drapper\nd-i live-installer/net-image string http://$http_server/cobbler/links/$distro_name/install/filesystem.squashfs\n#end if\n\n# Suite to install.\n# d-i mirror/suite string precise\n# d-i mirror/udeb/suite string precise\n\n# Components to use for loading installer components (optional).\n#d-i mirror/udeb/components multiselect main, restricted\n\n## Part 4. Partitioning\n\n# Disk Partitioning\n# Use LVM, and wipe out anything that already exists\nd-i partman/choose_partition select finish\nd-i partman/confirm boolean true\nd-i partman/confirm_nooverwrite boolean true\nd-i partman-auto/method string lvm\nd-i partman-lvm/device_remove_lvm boolean true\nd-i partman-lvm/confirm boolean true\nd-i partman-lvm/confirm_nooverwrite boolean true\nd-i partman-md/device_remove_md boolean true\nd-i partman-partitioning/confirm_write_new_label boolean true\n\n# You can choose one of the three predefined partitioning recipes:\n# - atomic: all files in one partition\n# - home:   separate /home partition\n# - multi:  separate /home, /usr, /var, and /tmp partitions\nd-i partman-auto/choose_recipe select atomic\n\n# If you just want to change the default filesystem from ext3 to something\n# else, you can do that without providing a full recipe.\n# d-i partman/default_filesystem string ext4\n\n## Part 5. Account setup\n\n# root account and password\nd-i passwd/root-login boolean true\nd-i passwd/root-password-crypted password $default_password_crypted\n\n# skip creation of a normal user account.\nd-i passwd/make-user boolean true\nd-i passwd/user-fullname  string anjia\nd-i passwd/username       string anjia\nd-i passwd/user-password-crypted password $default_password_crypted\n\n## Part 6. Apt setup\n\n# You can choose to install restricted and universe software, or to install\n# software from the backports repository.\n# d-i apt-setup/restricted boolean true\n# d-i apt-setup/universe boolean true\n# d-i apt-setup/backports boolean true\n\n# Uncomment this if you don't want to use a network mirror.\n# d-i apt-setup/use_mirror boolean true\n\n# Select which update services to use; define the mirrors to be used.\n# Values shown below are the normal defaults.\n# d-i apt-setup/services-select multiselect security\n# d-i apt-setup/security_host string mirrors.aliyun.com\n# d-i apt-setup/security_path string /ubuntu\n\n$SNIPPET('preseed_apt_repo_config')\n\n# Enable deb-src lines\n# d-i apt-setup/local0/source boolean true\n\n# URL to the public key of the local repository; you must provide a key or\n# apt will complain about the unauthenticated repository and so the\n# sources.list line will be left commented out\n# d-i apt-setup/local0/key string http://local.server/key\n\n# By default the installer requires that repositories be authenticated\n# using a known gpg key. This setting can be used to disable that\n# authentication. Warning: Insecure, not recommended.\n# d-i debian-installer/allow_unauthenticated boolean true\n\n## Part 7. Package selection\n# Default for minimal\ntasksel tasksel/first multiselect standard\n# Default for server\n# tasksel tasksel/first multiselect standard, web-server\n# Default for gnome-desktop\n# tasksel tasksel/first multiselect standard, gnome-desktop\n\n# Individual additional packages to install\n# wget is REQUIRED otherwise quite a few things won't work\n# later in the build (like late-command scripts)\nd-i pkgsel/include string ntp ssh wget \n\n# Debian needs this for the installer to avoid any question for grub\n# Please verify that it suit your needs as it may overwrite any usb stick\n#if $breed == &quot;debian&quot;\nd-i grub-installer/grub2_instead_of_grub_legacy boolean true\nd-i grub-installer/bootdev string default\n#end if\n\n# Use the following option to add additional boot parameters for the\n# installed system (if supported by the bootloader installer).\n# Note: options passed to the installer will be added automatically.\nd-i debian-installer/add-kernel-opts string $kernel_options_post\n\n# Avoid that last message about the install being complete.\nd-i finish-install/reboot_in_progress note\n\n## Figure out if we're kickstarting a system or a profile\n#if $getVar('system_name','') != ''\n#set $what = &quot;system&quot;\n#else\n#set $what = &quot;profile&quot;\n#end if\n\n# This first command is run as early as possible, just after preseeding is read.\n# d-i preseed/early_command string [command]\nd-i preseed/early_command string wget -O- \\\n   http://$http_server/cblr/svc/op/script/$what/$name/?script=preseed_early_default | \\\n   /bin/sh -s\n\n# This command is run immediately before the partitioner starts. It may be\n# useful to apply dynamic partitioner preseeding that depends on the state\n# of the disks (which may not be visible when preseed/early_command runs).\n# d-i partman/early_command \\\n#       string debconf-set partman-auto/disk &quot;\\$(list-devices disk | head -n1)&quot;\n\n# This command is run just before the install finishes, but when there is\n# still a usable /target directory. You can chroot to /target and use it\n# directly, or use the apt-install and in-target commands to easily install\n# packages and run commands in the target system.\n# d-i preseed/late_command string [command]\nd-i preseed/late_command string wget -O- \\\n   http://$http_server/cblr/svc/op/script/$what/$name/?script=preseed_late_default | \\\n   chroot /target /bin/sh -s</code></pre><p><br /></p><h3 id=\"516808f3\">创建snippets</h3><p><br /></p><p>安装完后，自动安装软件,参考 <a href=\"https://github.com/cobbler/cobbler/wiki/Using%20template%20scripts%20for%20Debian%20and%20Ubuntu%20seeds\" target=\"_blank\">Using template scripts for Debian and Ubuntu seeds</a></p><pre data-lang=\"bash\"><code>[root@localhost ~]# tee /var/lib/cobbler/snippets/ubuntu_apt_install_soft &lt;&lt;-'EOF'\n\napt-get update\napt-get install -y language-pack-zh-hans apt-transport-https ca-certificates software-properties-common  git ansible openssh-server vim curl htop iotop iftop ncdu\n\ncurl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -\nsudo add-apt-repository &quot;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;\napt-get update\n\napt-get install -y docker-ce=18.06.2~ce~3-0~ubuntu\napt-mark hold docker-ce\nsystemctl enable docker\nEOF\n\n## // d-i preseed/late_command 阶段执行\n[root@localhost ~]# echo '$SNIPPET(&quot;ubuntu_apt_install_soft&quot;) &gt;&gt; /var/lib/cobbler/snippets/late_apt_repo_config</code></pre><p> </p><h3 id=\"2a68d258\">设置ubuntu package repo</h3><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# cobbler repo edit --name=ubuntu-16.04.5-server-x86_64 --arch=x86_64 --breed=apt --mirror=http://mirrors.aliyun.com/ubuntu --owners=admin --mirror-locally=False --apt-components='main universe' --apt-dists='xenial xenial-updates xenial-security'\n[root@localhost ~]# cobbler profile edit --name=ubuntu-16.04.5-server-x86_64 --repos=ubuntu-16.04.5-server-x86_64</code></pre><p><br /></p><p>限于篇幅，下一篇，将介绍Cobbler安装Windows</p><p><br /></p><h2 id=\"a08138fa\">常见错误</h2><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# cobbler check\ncobblerd does not appear to be running/accessible: error(111, 'Connection refused') </code></pre><p><br /></p><p>原因：未启动相关服务</p><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# cobbler check\nhttpd does not appear to be running and proxying cobbler, or SELinux is in the way. Original traceback:\nTraceback (most recent call last):\n  File &quot;/usr/lib/python2.7/site-packages/cobbler/cli.py&quot;, line 251, in check_setup\n    s.ping()\n  File &quot;/usr/lib64/python2.7/xmlrpclib.py&quot;, line 1233, in __call__\n    return self.__send(self.__name, args)\n  File &quot;/usr/lib64/python2.7/xmlrpclib.py&quot;, line 1591, in __request\n    verbose=self.__verbose\n  File &quot;/usr/lib64/python2.7/xmlrpclib.py&quot;, line 1273, in request\n    return self.single_request(host, handler, request_body, verbose)\n  File &quot;/usr/lib64/python2.7/xmlrpclib.py&quot;, line 1321, in single_request\n    response.msg,\nProtocolError: &lt;ProtocolError for 127.0.0.1:80/cobbler_api: 503 Service Unavailable&gt;</code></pre><p>未关闭防火墙</p><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# cobbler sync\nreceived on stderr: Redirecting to /bin/systemctl restart dhcpd.service\nJob for dhcpd.service failed because the control process exited with error code. See &quot;systemctl status dhcpd.service&quot; and &quot;journalctl -xe&quot; for details.\n\nException occured: &lt;class 'cobbler.cexceptions.CX'&gt;\nException value: 'cobbler trigger failed: cobbler.modules.sync_post_restart_services'\nException Info:\n  File &quot;/usr/lib/python2.7/site-packages/cobbler/remote.py&quot;, line 82, in run\n    rc = self._run(self)\n   File &quot;/usr/lib/python2.7/site-packages/cobbler/remote.py&quot;, line 181, in runner\n    return self.remote.api.sync(self.options.get(&quot;verbose&quot;,False),logger=self.logger)\n   File &quot;/usr/lib/python2.7/site-packages/cobbler/api.py&quot;, line 763, in sync\n    return sync.run()\n   File &quot;/usr/lib/python2.7/site-packages/cobbler/action_sync.py&quot;, line 144, in run\n    utils.run_triggers(self.api, None, &quot;/var/lib/cobbler/triggers/sync/post/*&quot;, logger=self.logger)\n   File &quot;/usr/lib/python2.7/site-packages/cobbler/utils.py&quot;, line 928, in run_triggers\n    raise CX(&quot;cobbler trigger failed: %s&quot; % m.__name__)\n\n!!! TASK FAILED !!!</code></pre><p>没改dhcp模板，导致sync同步出问题</p><p><br /></p><p><br /></p><pre data-lang=\"bash\"><code>[root@localhost ~]# cat /var/log/httpd/ssl_error_log\n[Fri Feb 22 20:07:49.460442 2019] [:error] [pid 6910] [remote 127.0.0.1:204] mod_wsgi (pid=6910): Exception occurred processing WSGI script '/usr/share/cobbler/web/cobbler.wsgi'.\n[Fri Feb 22 20:07:49.460559 2019] [:error] [pid 6910] [remote 127.0.0.1:204] Traceback (most recent call last):\n[Fri Feb 22 20:07:49.460605 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File &quot;/usr/share/cobbler/web/cobbler.wsgi&quot;, line 26, in application\n[Fri Feb 22 20:07:49.460668 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     _application = get_wsgi_application()\n[Fri Feb 22 20:07:49.460684 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File &quot;/usr/lib/python2.7/site-packages/django/core/wsgi.py&quot;, line 13, in get_wsgi_application\n[Fri Feb 22 20:07:49.460723 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     django.setup(set_prefix=False)\n[Fri Feb 22 20:07:49.460737 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File &quot;/usr/lib/python2.7/site-packages/django/__init__.py&quot;, line 22, in setup\n[Fri Feb 22 20:07:49.460768 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     configure_logging(settings.LOGGING_CONFIG, settings.LOGGING)\n[Fri Feb 22 20:07:49.460781 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File &quot;/usr/lib/python2.7/site-packages/django/conf/__init__.py&quot;, line 56, in __getattr__\n[Fri Feb 22 20:07:49.460812 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     self._setup(name)\n[Fri Feb 22 20:07:49.460824 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File &quot;/usr/lib/python2.7/site-packages/django/conf/__init__.py&quot;, line 41, in _setup\n[Fri Feb 22 20:07:49.460852 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     self._wrapped = Settings(settings_module)\n[Fri Feb 22 20:07:49.460871 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File &quot;/usr/lib/python2.7/site-packages/django/conf/__init__.py&quot;, line 110, in __init__\n[Fri Feb 22 20:07:49.460900 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     mod = importlib.import_module(self.SETTINGS_MODULE)\n[Fri Feb 22 20:07:49.460911 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File &quot;/usr/lib64/python2.7/importlib/__init__.py&quot;, line 37, in import_module\n[Fri Feb 22 20:07:49.460953 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     __import__(name)\n[Fri Feb 22 20:07:49.460973 2019] [:error] [pid 6910] [remote 127.0.0.1:204]   File &quot;/usr/share/cobbler/web/settings.py&quot;, line 89, in &lt;module&gt;\n[Fri Feb 22 20:07:49.460995 2019] [:error] [pid 6910] [remote 127.0.0.1:204]     from django.conf.global_settings import TEMPLATE_CONTEXT_PROCESSORS\n[Fri Feb 22 20:07:49.461043 2019] [:error] [pid 6910] [remote 127.0.0.1:204] ImportError: cannot import name TEMPLATE_CONTEXT_PROCESSORS</code></pre><p><code>pip2.7 install -U django==1.9.13</code> </p><p><br /></p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://access.redhat.com/documentation/en-us/red_hat_network_satellite/5.3/html/reference_guide/ch-cobbler#s3-cobbler-reqs-security-iptables\" target=\"_blank\">配置防火墙</a></li><li><a href=\"https://github.com/cobbler/cobbler/issues/1959\" target=\"_blank\"><span>cobbler 2.8.4/2.8.0 on centos 7 error</span></a></li><li><a href=\"https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax\" target=\"_blank\">KICKSTART 语法参考</a></li><li><a href=\"https://www.kancloud.cn/devops-centos/centos-linux-devops/392369\" target=\"_blank\"><span class=\"lake-fontsize-11\" style=\"color: #000000;\">运维工作笔记-Cobbler 配置文件</span></a></li><li><a href=\"https://www.debian.org/releases/stable/amd64/apbs04.html.zh-cn\" target=\"_blank\">Preseed语法参考</a></li><li><span><a href=\"https://github.com/cobbler/cobbler/issues/1262\" target=\"_blank\">Support selection of automatic installation file format in distros which allow it (Debian/Ubuntu allows kickstart and preseed) </a></span></li><li><a href=\"https://thornelabs.blog/posts/problems-provisioning-ubuntu-with-cobbler-and-kickstart-profiles.html\" target=\"_blank\"><span>Problems Provisioning Ubuntu with Cobbler and Kickstart Profiles</span></a></li><li><a href=\"https://github.com/cobbler/cobbler/wiki/Using%20template%20scripts%20for%20Debian%20and%20Ubuntu%20seeds\" target=\"_blank\">Using template scripts for Debian and Ubuntu seeds</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "body_lake": "<!doctype lake><p><span>date: 2019-02-22 15:46:00</span></p><p>tags: [pxe,dhcp,cobbler,centos,ubuntu,windows,tftp]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote style=\"padding-left: 1em;\"><p>这是坚持技术写作计划（含翻译）的第6篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><p>本文主要讲解通过CentOS7.6 Minimal + Cobbler 自动化安装CentOS,Ubuntu,Windows</p><p><br /></p><h2 id=\"424a2ad8\">准备</h2><p>从阿里镜像站，下载 <span><a href=\"https://mirrors.aliyun.com/centos/7.6.1810/isos/x86_64/CentOS-7-x86_64-Minimal-1810.iso\" target=\"_blank\">CentOS-7-x86_64-Minimal-1810.iso</a> 和 </span><span><span><a href=\"https://mirrors.aliyun.com/ubuntu-releases/releases/releases/16.04.5/ubuntu-16.04.5-desktop-amd64.iso\" target=\"_blank\">ubuntu-16.04.5-desktop-amd64.iso</a> ，使用VMware创建一台CentOS7的虚拟机。</span></span></p><p><span><span><br /></span></span></p><h3 id=\"eb49d426\">环境初始化</h3><p>1.改为阿里源</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23%20yum%E6%BA%90%5Cn%23%20%E5%A4%87%E4%BB%BD%E7%B3%BB%E7%BB%9F%E9%BB%98%E8%AE%A4%E6%BA%90%5Cn%5Broot%40localhost%20~%5D%23%20mkdir%20%2Fetc%2Fyum.repos.d%2Fold%20%26%26%20mv%20%2Fetc%2Fyum.repos.d%2FC*%20%2Fetc%2Fyum.repos.d%2Fold%2F%5Cn%5Broot%40localhost%20~%5D%23%20yum%20clean%20all%5Cn%23%20%E8%AE%BE%E7%BD%AE%E9%98%BF%E9%87%8Cyum%E6%BA%90%5Cn%5Broot%40localhost%20~%5D%23%20curl%20-o%20%2Fetc%2Fyum.repos.d%2FCentOS-Base.repo%20http%3A%2F%2Fmirrors.aliyun.com%2Frepo%2FCentos-7.repo%5Cn%5Broot%40localhost%20~%5D%23%20curl%20-o%20%2Fetc%2Fyum.repos.d%2Fepel.repo%20http%3A%2F%2Fmirrors.aliyun.com%2Frepo%2Fepel-7.repo%5Cn%5Cn%23%20pip%E6%BA%90(2.8.4%E7%9A%84bug)%5Cn%5Broot%40localhost%20~%5D%23%20mkdir%20~%2F.pip%5Cn%5Broot%40localhost%20~%5D%23%20cat%20%3E%20~%2F.pip%2Fpip.conf%20%3C%3C%20EOF%5Cn%5Bglobal%5D%5Cntrusted-host%3Dmirrors.aliyun.com%5Cnindex-url%3Dhttps%3A%2F%2Fmirrors.aliyun.com%2Fpypi%2Fsimple%2F%5CnEOF%22%7D\"></card><p><br /></p><p>2.配置ssh</p><p><br /></p><p>默认ssh_config启用了DNS解析，导致每次远程ssh时都特别慢</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20sed%20-i%20's%25%23UseDNS%20yes%25UseDNS%20no%25'%20%2Fetc%2Fssh%2Fsshd_config%20%5Cn%5Broot%40localhost%20~%5D%23%20service%20sshd%20restart%22%7D\"></card><p><del>3.</del><a href=\"https://access.redhat.com/documentation/en-us/red_hat_network_satellite/5.3/html/reference_guide/ch-cobbler#s3-cobbler-reqs-security-selinux\" target=\"_blank\"><del>配置SElinux</del></a></p><p><del>如果要在Centos上开启Cobbler的支持，需要用root用户运行 </del><del><code>setsebool</code></del><del> ，注意 </del><del><code>-P</code></del><del> 参数确保重启仍然生效。</del></p><p><del>同时需要配置SELinux上下文规则(CentOS 7 </del><del><span>Minimal</span></del><del>默认不安装 </del><del><code>semanage</code></del><del> )，用于提供引导镜像。</del></p><p>按照红帽的5.4的教程，设置不生效，所以，禁用SELinux</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23%2F%2F..%20setsebool%20-P%20httpd_can_network_connect%20true%5Cn%23%2F%2F..%20yum%20provides%20semanage%5Cn%23%2F%2F..%20yum%20-y%20install%20policycoreutils-python.x86_64%5Cn%23%2F%2F..%20semanage%20fcontext%20-a%20-t%20public_content_t%20%5C%22%2Fvar%2Flib%2Ftftpboot%2F.*%5C%22%5Cn%5Broot%40localhost%20~%5D%23%20sed%20-i%20'%2FSELINUX%2Fs%2Fenforcing%2Fdisabled%2F'%20%2Fetc%2Fselinux%2Fconfig%20%20%5Cn%5Broot%40localhost%20~%5D%23%20setenforce%200%22%7D\"></card><p>4.<a href=\"https://access.redhat.com/documentation/en-us/red_hat_network_satellite/5.3/html/reference_guide/ch-cobbler#s3-cobbler-reqs-security-iptables\" target=\"_blank\">配置防火墙</a></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23%20TFTP%5Cn%5Broot%40localhost%20~%5D%23%20firewall-cmd%20--zone%3Dpublic%20--add-port%3D69%2Ftcp%20--permanent%5Cn%5Broot%40localhost%20~%5D%23%20firewall-cmd%20--zone%3Dpublic%20--add-port%3D69%2Fudp%20--permanent%5Cn%5Cn%23%20HTTPD%5Cn%5Broot%40localhost%20~%5D%23%20firewall-cmd%20--zone%3Dpublic%20--add-port%3D80%2Ftcp%20--permanent%5Cn%5Broot%40localhost%20~%5D%23%20firewall-cmd%20--zone%3Dpublic%20--add-port%3D443%2Ftcp%20--permanent%5Cn%5Cn%23%20Cobbler%5Cn%5Broot%40localhost%20~%5D%23%20firewall-cmd%20--zone%3Dpublic%20--add-port%3D25150%2Ftcp%20--permanent%5Cn%5Broot%40localhost%20~%5D%23%20firewall-cmd%20--zone%3Dpublic%20--add-port%3D25150%2Fudp%20--permanent%5Cn%5Cn%23%20Koan%20%E5%A6%82%E6%9E%9C%E6%9C%AA%E7%94%A8%E5%88%B0%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%B8%8D%E5%BC%80%E6%94%BE%5Cn%5Broot%40localhost%20~%5D%23%20firewall-cmd%20--zone%3Dpublic%20--add-port%3D25151%2Ftcp%20--permanent%5Cn%5Cn%23%20samba%20window%E5%AE%89%E8%A3%85%E9%9C%80%E8%A6%81%E7%94%A8%E5%88%B0samba%2C%E5%90%A6%E5%88%99%E5%8F%AF%E4%BB%A5%E4%B8%8D%E5%BC%80%E6%94%BE%5Cn%5Broot%40localhost%20~%5D%23%20firewall-cmd%20--zone%3Dpublic%20--add-port%3D139%2Ftcp%20--permanent%5Cn%5Broot%40localhost%20~%5D%23%20firewall-cmd%20--zone%3Dpublic%20--add-port%3D445%2Ftcp%20--permanent%5Cn%5Broot%40localhost%20~%5D%23%20firewall-cmd%20--zone%3Dpublic%20--add-port%3D137%2Fudp%20--permanent%5Cn%5Broot%40localhost%20~%5D%23%20firewall-cmd%20--zone%3Dpublic%20--add-port%3D138%2Fudp%20--permanent%5Cn%5Cn%23%20%E6%9B%B4%E6%96%B0%E9%98%B2%E7%81%AB%E5%A2%99%E8%A7%84%E5%88%99%5Cn%5Broot%40localhost%20~%5D%23%20firewall-cmd%20--reload%5Cn%5Cn%23%20%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E6%89%93%E5%BC%80%E7%9A%84%E7%AB%AF%E5%8F%A3%5Cn%5Broot%40localhost%20~%5D%23%20firewall-cmd%20--zone%3Dpublic%20--list-ports%22%7D\"></card><p><br /></p><h2 id=\"7abcbeda\">安装Cobbler</h2><p><br /></p><h3 id=\"5fc688fa\">安装依赖软件</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20yum%20install%20-y%20cobbler%20cobbler-web%20dhcp%20tftp-server%20pykickstart%20httpd%20xinetd%22%7D\"></card><p><br /></p><h3 id=\"9d785a63\">设置开机自启动</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20systemctl%20enable%20httpd%5Cn%5Broot%40localhost%20~%5D%23%20systemctl%20enable%20xinetd%5Cn%5Broot%40localhost%20~%5D%23%20systemctl%20enable%20rsyncd%5Cn%5Broot%40localhost%20~%5D%23%20systemctl%20enable%20tftp%5Cn%5Broot%40localhost%20~%5D%23%20systemctl%20enable%20cobblerd%22%7D\"></card><p><br /></p><h3 id=\"33d81c9d\">启动服务</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20systemctl%20start%20httpd%5Cn%5Broot%40localhost%20~%5D%23%20systemctl%20start%20xinetd%5Cn%5Broot%40localhost%20~%5D%23%20systemctl%20start%20tftp%5Cn%5Broot%40localhost%20~%5D%23%20systemctl%20start%20cobblerd%22%7D\"></card><p><br /></p><h3 id=\"239c3f37\">检查配置</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20cobbler%20check%5CnThe%20following%20are%20potential%20configuration%20items%20that%20you%20may%20want%20to%20fix%3A%5Cn%5Cn1%20%3A%20The%20'server'%20field%20in%20%2Fetc%2Fcobbler%2Fsettings%20must%20be%20set%20to%20something%20other%20than%20localhost%2C%20or%20kickstarting%20features%20will%20not%20work.%20%20This%20should%20be%20a%20resolvable%20hostname%20or%20IP%20for%20the%20boot%20server%20as%20reachable%20by%20all%20machines%20that%20will%20use%20it.%5Cn2%20%3A%20For%20PXE%20to%20be%20functional%2C%20the%20'next_server'%20field%20in%20%2Fetc%2Fcobbler%2Fsettings%20must%20be%20set%20to%20something%20other%20than%20127.0.0.1%2C%20and%20should%20match%20the%20IP%20of%20the%20boot%20server%20on%20the%20PXE%20network.%5Cn3%20%3A%20SELinux%20is%20enabled.%20Please%20review%20the%20following%20wiki%20page%20for%20details%20on%20ensuring%20cobbler%20works%20correctly%20in%20your%20SELinux%20environment%3A%5Cn%20%20%20%20https%3A%2F%2Fgithub.com%2Fcobbler%2Fcobbler%2Fwiki%2FSelinux%5Cn4%20%3A%20change%20'disable'%20to%20'no'%20in%20%2Fetc%2Fxinetd.d%2Ftftp%5Cn5%20%3A%20Some%20network%20boot-loaders%20are%20missing%20from%20%2Fvar%2Flib%2Fcobbler%2Floaders%2C%20you%20may%20run%20'cobbler%20get-loaders'%20to%20download%20them%2C%20or%2C%20if%20you%20only%20want%20to%20handle%20x86%2Fx86_64%20netbooting%2C%20you%20may%20ensure%20that%20you%20have%20installed%20a%20*recent*%20version%20of%20the%20syslinux%20package%20installed%20and%20can%20ignore%20this%20message%20entirely.%20%20Files%20in%20this%20directory%2C%20should%20you%20want%20to%20support%20all%20architectures%2C%20should%20include%20pxelinux.0%2C%20menu.c32%2C%20elilo.efi%2C%20and%20yaboot.%20The%20'cobbler%20get-loaders'%20command%20is%20the%20easiest%20way%20to%20resolve%20these%20requirements.%5Cn6%20%3A%20debmirror%20package%20is%20not%20installed%2C%20it%20will%20be%20required%20to%20manage%20debian%20deployments%20and%20repositories%5Cn7%20%3A%20The%20default%20password%20used%20by%20the%20sample%20templates%20for%20newly%20installed%20machines%20(default_password_crypted%20in%20%2Fetc%2Fcobbler%2Fsettings)%20is%20still%20set%20to%20'cobbler'%20and%20should%20be%20changed%2C%20try%3A%20%5C%22openssl%20passwd%20-1%20-salt%20'random-phrase-here'%20'your-password-here'%5C%22%20to%20generate%20new%20one%5Cn8%20%3A%20fencing%20tools%20were%20not%20found%2C%20and%20are%20required%20to%20use%20the%20(optional)%20power%20management%20features.%20install%20cman%20or%20fence-agents%20to%20use%20them%5Cn%5CnRestart%20cobblerd%20and%20then%20run%20'cobbler%20sync'%20to%20apply%20changes.%22%7D\"></card><p><br /></p><p>1,2：</p><p><code>cobbler_ip</code> 为cobbler主机ip</p><p><code>next_server</code> 是dhcp主机ip，但是本实验dhcp和cobbler是一台</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20export%20cobbler_ip%3D192.168.0.12%5Cn%5Broot%40localhost%20~%5D%23%20sed%20-i%20%5C%22s%25%5Eserver%3A%20127.0.0.1%25server%3A%20%24%7Bcobbler_ip%7D%25g%5C%22%20%2Fetc%2Fcobbler%2Fsettings%5Cn%5Broot%40localhost%20~%5D%23%20sed%20-i%20%5C%22s%25%5Enext_server%3A%20127.0.0.1%25next_server%3A%20%24%7Bcobbler_ip%7D%25g%5C%22%20%2Fetc%2Fcobbler%2Fsettings%22%7D\"></card><p><br /></p><p>3： 可以忽略，因为已经配置SELinux和防火墙了</p><p><br /></p><p>4<span>：开启tftp功能</span></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20sed%20-i%20'%2Fdisable%5C%5C%3E%2Fs%2F%5C%5C%3Cyes%5C%5C%3E%2Fno%2F'%20%2Fetc%2Fxinetd.d%2Ftftp%22%7D\"></card><p><br /></p><p>5：下载bootload</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20cobbler%20get-loaders%22%7D\"></card><p><br /></p><p>6：下载ubuntu本地包镜像（不装ubuntu的，可以不用改）</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20yum%20install%20-y%20debmirror%5Cn%5Broot%40localhost%20~%5D%23%20sed%20-i%20's%25%5E%40dists%3D%5C%22sid%5C%22%25%23%40dists%3D%5C%22sid%5C%22%25g%3Bs%25%40arches%3D%5C%22i386%5C%22%25%23%40arches%3D%5C%22i386%5C%22%25g'%20%2Fetc%2Fdebmirror.conf%22%7D\"></card><p><br /></p><p>7：设置安装系统后的root密码</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20export%20root_pwd%3D%24(openssl%20passwd%20-1%20-salt%20%60openssl%20rand%2015%20-base64%60%20'Abcd1234!%40%23%24')%5Cn%5Broot%40localhost%20~%5D%23%20sed%20-i%20%5C%22s%25%5Edefault_password_crypted.*%25default_password_crypted%3A%20%5C%5C%5C%22%24%7Broot_pwd%7D%5C%5C%5C%22%25g%5C%22%20%2Fetc%2Fcobbler%2Fsettings%22%7D\"></card><p><br /></p><p>8：电源管理模块(非必选)，cman和ence-agents二选一即可,此处忽略</p><p><br /></p><p>其余修改：</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20sed%20-i%20%5C%22s%25manage_dhcp%3A%200%25manage_dhcp%3A%201%25g%5C%22%20%2Fetc%2Fcobbler%2Fsettings%5Cn%5Broot%40localhost%20~%5D%23%20sed%20-i%20%5C%22s%25pxe_just_once%3A%200%25pxe_just_once%3A%201%25g%5C%22%20%2Fetc%2Fcobbler%2Fsettings%22%7D\"></card><p><br /></p><p>修改dhcp</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20vi%20%2Fetc%2Fcobbler%2Fdhcp.template%5Cn%5C%5C%23%E4%BB%85%E5%88%97%E5%87%BA%E4%BF%AE%E6%94%B9%E8%BF%87%E7%9A%84%E9%83%A8%E5%88%86%5Cn%5C%5C......%5Cnsubnet%20192.168.0.0%20netmask%20255.255.255.0%20%7B%5Cn%20%20%20%20%20option%20routers%20%20%20%20%20%20%20%20%20%20%20%20%20192.168.0.1%3B%5Cn%20%20%20%20%20option%20domain-name-servers%20192.168.0.1%3B%5Cn%20%20%20%20%20option%20subnet-mask%20%20%20%20%20%20%20%20%20255.255.255.0%3B%5Cn%20%20%20%20%20range%20dynamic-bootp%20%20%20%20%20%20%20%20192.168.0.100%20192.168.0.200%3B%5Cn%5C%5C......%22%7D\"></card><p><br /></p><p>重启服务</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20systemctl%20restart%20httpd%5Cn%5Broot%40localhost%20~%5D%23%20systemctl%20restart%20xinetd%5Cn%5Broot%40localhost%20~%5D%23%20systemctl%20restart%20tftp%5Cn%5Broot%40localhost%20~%5D%23%20systemctl%20restart%20cobblerd%22%7D\"></card><p><br /></p><p>再次校验,发现只有两条信息了，忽略即可。</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20cobbler%20check%5CnThe%20following%20are%20potential%20configuration%20items%20that%20you%20may%20want%20to%20fix%3A%5Cn%5Cn1%20%3A%20SELinux%20is%20enabled.%20Please%20review%20the%20following%20wiki%20page%20for%20details%20on%20ensuring%20cobbler%20works%20correctly%20in%20your%20SELinux%20environment%3A%5Cn%20%20%20%20https%3A%2F%2Fgithub.com%2Fcobbler%2Fcobbler%2Fwiki%2FSelinux%5Cn2%20%3A%20fencing%20tools%20were%20not%20found%2C%20and%20are%20required%20to%20use%20the%20(optional)%20power%20management%20features.%20install%20cman%20or%20fence-agents%20to%20use%20them%5Cn%5CnRestart%20cobblerd%20and%20then%20run%20'cobbler%20sync'%20to%20apply%20changes.%22%7D\"></card><p><br /></p><p>执行 <code>cobbler sync</code> 同步信息</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20cobbler%20sync%5Cntask%20started%3A%202019-02-22_184309_sync%5Cntask%20started%20(id%3DSync%2C%20time%3DFri%20Feb%2022%2018%3A43%3A09%202019)%5Cnrunning%20pre-sync%20triggers%5Cn%23%20....%E5%BF%BD%E7%95%A5%5Cnrunning%20python%20trigger%20cobbler.modules.scm_track%5Cnrunning%20shell%20triggers%20from%20%2Fvar%2Flib%2Fcobbler%2Ftriggers%2Fchange%2F*%5Cn***%20TASK%20COMPLETE%20***%22%7D\"></card><p><br /></p><h3 id=\"cobbler-web\">cobbler-web</h3><h4 id=\"8ac7b7b1\">修复2.8.4 bug</h4><p>打开 <code>https://${cobbler_ip}/cobbler_web</code> 注意是 <code>https</code> 但是2.8.4有个bug，会导致打开后报500 <code>Internal Server Error</code> 错误 ,是因为  <code>django</code> 版本太高了 (参加 <a href=\"https://github.com/cobbler/cobbler/issues/1959\" target=\"_blank\"><span>cobbler 2.8.4/2.8.0 on centos 7 error </span></a>)</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20yum%20install%20-y%20python-pip%5Cn%5Broot%40localhost%20~%5D%23%20pip2.7%20install%20-U%20django%3D%3D1.9.13%5Cn%5Broot%40localhost%20~%5D%23%20systemctl%20restart%20cobblerd%22%7D\"></card><p><br /></p><h4 id=\"545e05cf\">设置用户名密码</h4><p>默认用户名密码是 cobbler/cobbler</p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20htdigest%20-c%20%2Fetc%2Fcobbler%2Fusers.digest%20Cobbler%20cobbler%20%23%20%E5%90%8E%E8%BE%B9%E8%BF%99%E4%B8%AA%E6%98%AF%E7%94%A8%E6%88%B7%E5%90%8D%5Cn%5Broot%40localhost%20~%5D%23%20systemctl%20restart%20cobblerd%22%7D\"></card><p><br /></p><p>再次打开 <code>https://${cobbler_ip}/cobbler_web</code> </p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1550854050621-8cd8b769-08c5-457e-9e1f-e85d64c10479.png%22%2C%22originWidth%22%3A543%2C%22originHeight%22%3A519%2C%22name%22%3A%22image.png%22%2C%22size%22%3A42554%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A543%2C%22height%22%3A519%7D\"></card></p><p><br /></p><h3 id=\"2074d2c5\">挂载镜像</h3><p>通过 winscp,mobaxterm等将ubuntu和centos镜像上传到Cobbler服务器上的 <code>/tmp/</code> 目录下,其中 <code>net.ifnames=0 biosdevname=0 noipv6</code> 是让网卡统一命名成 <code>eth0</code> </p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20mount%20-t%20iso9660%20-o%20loop%20%2Ftmp%2FCentOS-7-x86_64-Minimal-1810.iso%20%2Fmnt%2F%5Cn%5Broot%40localhost%20~%5D%23%20cobbler%20import%20--name%3DCentOS-7.6.1810-x86_64%20--path%3D%2Fmnt%2F%20--arch%3Dx86_64%5Cn%5Broot%40localhost%20~%5D%23%20cobbler%20profile%20edit%20--name%3DCentOS-7.6.1810-x86_64%20--kopts%3D'net.ifnames%3D0%20biosdevname%3D0'%5Cn%5Broot%40localhost%20~%5D%23%20mount%20-t%20iso9660%20-o%20loop%20%2Ftmp%2Fubuntu-16.04.5-server-amd64.iso%20%2Fmnt%2F%5Cn%5Broot%40localhost%20~%5D%23%20cobbler%20import%20--name%3Dubuntu-16.04.5-server-x86_64%20--path%3D%2Fmnt%2F%20--arch%3Dx86_64%22%7D\"></card><p><br /></p><h3 id=\"9135d7d4\">测试PXE安装系统</h3><p>在vmware创建两个虚拟机(选择空白盘),内存2G，CPU2核，磁盘20G，创建完后，记得打个快照，后边做实验失败后，直接恢复即可。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1550853771456-0e9b5af8-6bfe-44e0-83ed-22cf06deb895.png%22%2C%22originWidth%22%3A720%2C%22originHeight%22%3A400%2C%22name%22%3A%22image.png%22%2C%22size%22%3A11329%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A720%2C%22height%22%3A400%7D\"></card></p><p>选择CentOS，然后回车，系统将自动安装</p><p><br /></p><h2 id=\"11e7dd08\">优化配置</h2><p><br /></p><h3 id=\"332f378a\">CentOS ks</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20cobbler%20profile%20report%20--name%20CentOS-7.6.1810-x86_64%5CnName%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3A%20CentOS-7.6.1810-x86_64%5Cn%23%2F%2F...%E5%BF%BD%E7%95%A5%5CnKickstart%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3A%20%2Fvar%2Flib%2Fcobbler%2Fkickstarts%2Fsample_end.ks%5Cn%23%2F%2F...%E5%BF%BD%E7%95%A5%5Cn%23%2F%2F%E5%A4%8D%E5%88%B6%E4%B8%80%E4%BB%BDks%EF%BC%8C%E5%B9%B6%E4%B8%94%E8%BF%9B%E8%A1%8C%E4%BF%AE%E6%94%B9%5Cn%5Broot%40localhost%20~%5D%23%20cp%20%2Fvar%2Flib%2Fcobbler%2Fkickstarts%2Fsample_end.ks%20%2Fvar%2Flib%2Fcobbler%2Fkickstarts%2Fcentos-7-6.ks%5Cn%5Broot%40localhost%20~%5D%23%20cobbler%20profile%20edit%20--name%20CentOS-7.6.1810-x86_64%20%20--kickstart%3D%2Fvar%2Flib%2Fcobbler%2Fkickstarts%2Fcentos-7-6.ks%5Cn%5Broot%40localhost%20~%5D%23%20cp%20%2Fvar%2Flib%2Fcobbler%2Fkickstarts%2Fsample.seed%20%2Fvar%2Flib%2Fcobbler%2Fkickstarts%2Fubuntu-16-4-5.seed%5Cn%5Broot%40localhost%20~%5D%23%20cobbler%20profile%20edit%20--name%20ubuntu-16.04.5-server-x86_64%20%20--kickstart%3D%2Fvar%2Flib%2Fcobbler%2Fkickstarts%2Fubuntu-16-4-5.seed%20%22%7D\"></card><p><br /></p><p><span class=\"lake-fontsize-11\" style=\"color: #000000;\">具体CentOS的ks语法可以参考这里：</span><a href=\"https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax\" target=\"_blank\">KICKSTART 语法参考</a><span class=\"lake-fontsize-11\" style=\"color: #000000;\">。另外可以参考 </span><a href=\"https://www.kancloud.cn/devops-centos/centos-linux-devops/392369\" target=\"_blank\"><span class=\"lake-fontsize-11\" style=\"color: #000000;\">运维工作笔记-Cobbler 配置文件</span></a></p><p>具体Ubuntu的Preseed<span class=\"lake-fontsize-11\" style=\"color: #000000;\">可以参考这里：</span><a href=\"https://www.debian.org/releases/stable/amd64/apbs04.html.zh-cn\" target=\"_blank\">Preseed语法参考</a><span class=\"lake-fontsize-11\" style=\"color: #000000;\">。</span></p><p><span class=\"lake-fontsize-11\" style=\"color: #000000;\"><br /></span></p><p>吐槽一下，cobbler代码中检测到是ubuntu时，会自动将ks换成url(强制走preseed)，而用惯了ks的，用preseed还是很不习惯的，可以看一下 <span><a href=\"https://github.com/cobbler/cobbler/issues/1262\" target=\"_blank\">Support selection of automatic installation file format in distros which allow it (Debian/Ubuntu allows kickstart and preseed) </a>和 </span><a href=\"https://thornelabs.blog/posts/problems-provisioning-ubuntu-with-cobbler-and-kickstart-profiles.html\" target=\"_blank\"><span>Problems Provisionin<cursor />g Ubuntu with Cobbler and Kickstart Profiles</span></a></p><p>此处贴一下 /var/lib/cobbler/kickstarts/ubuntu-16-4-5.seed </p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%23%20Mostly%20based%20on%20the%20Ubuntu%20installation%20guide%5Cn%23%20https%3A%2F%2Fhelp.ubuntu.com%2F16.04%2Finstallation-guide%2F%5Cn%23%20Debian%20sample%5Cn%23%20https%3A%2F%2Fwww.debian.org%2Freleases%2Fstable%2Fexample-preseed.txt%5Cn%5Cn%23%23%20Part%201.%20Localization%5Cn%5Cn%23%20Preseeding%20only%20locale%20sets%20language%2C%20country%20and%20locale.%5Cnd-i%20debian-installer%2Flocale%20string%20en_US%5Cn%5Cn%23%20Keyboard%20selection.%5Cn%23%20Disable%20automatic%20(interactive)%20keymap%20detection.%5Cnd-i%20console-setup%2Fask_detect%20boolean%20false%5Cnd-i%20keyboard-configuration%2Ftoggle%20select%20No%20toggling%5Cnd-i%20keyboard-configuration%2Flayoutcode%20string%20us%5Cnd-i%20keyboard-configuration%2Fvariantcode%20string%5Cn%5Cn%23%23%20Part%202.%20Network%20configuration%5Cn%23%20netcfg%20will%20choose%20an%20interface%20that%20has%20link%20if%20possible.%20This%20makes%20it%5Cn%23%20skip%20displaying%20a%20list%20if%20there%20is%20more%20than%20one%20interface.%5Cn%23set%20%24myhostname%20%3D%20%24getVar('hostname'%2C%24getVar('name'%2C'cobbler')).replace(%5C%22_%5C%22%2C%5C%22-%5C%22)%5Cnd-i%20netcfg%2Fchoose_interface%20select%20auto%5Cnd-i%20netcfg%2Fget_hostname%20string%20%24myhostname%5Cn%5Cn%23%20If%20non-free%20firmware%20is%20needed%20for%20the%20network%20or%20other%20hardware%2C%20you%20can%5Cn%23%20configure%20the%20installer%20to%20always%20try%20to%20load%20it%2C%20without%20prompting.%20Or%5Cn%23%20change%20to%20false%20to%20disable%20asking.%5Cn%23%20d-i%20hw-detect%2Fload_firmware%20boolean%20true%5Cn%5Cn%23%23%20Part%203%20NTP%2FTime%5Cn%23%20NTP%2FTime%20Setup%5Cnd-i%20time%2Fzone%20string%20Asia%2FShanghai%5Cnd-i%20clock-setup%2Futc%20boolean%20true%5Cnd-i%20clock-setup%2Fntp%20boolean%20true%5Cnd-i%20clock-setup%2Fntp-server%20%20string%20ntp1.aliyun.com%5Cn%5Cn%23%23%20Part%204.%20Mirror%20settings%5Cn%23%20Setup%20the%20installation%20source%5Cnd-i%20mirror%2Fcountry%20string%20manual%5Cnd-i%20mirror%2Fhttp%2Fhostname%20string%20%24http_server%5Cnd-i%20mirror%2Fhttp%2Fdirectory%20string%20%24install_source_directory%5Cnd-i%20mirror%2Fhttp%2Fproxy%20string%5Cn%5Cn%23set%20%24os_v%20%3D%20%24getVar('os_version'%2C'')%5Cn%23if%20%24breed%20%3D%3D%20%5C%22ubuntu%5C%22%20and%20%24os_v%20and%20(%24os_v.lower()%5B0%5D%20%3E%20'p'%20or%20%24os_v.lower()%5B0%5D%20%3C%20'd')%5Cn%23%20Required%20at%20least%20for%20ubuntu%2012.10%2B%20%2C%20so%20test%20os_v%20is%20higher%20than%20precise%20and%20lower%20than%20drapper%5Cnd-i%20live-installer%2Fnet-image%20string%20http%3A%2F%2F%24http_server%2Fcobbler%2Flinks%2F%24distro_name%2Finstall%2Ffilesystem.squashfs%5Cn%23end%20if%5Cn%5Cn%23%20Suite%20to%20install.%5Cn%23%20d-i%20mirror%2Fsuite%20string%20precise%5Cn%23%20d-i%20mirror%2Fudeb%2Fsuite%20string%20precise%5Cn%5Cn%23%20Components%20to%20use%20for%20loading%20installer%20components%20(optional).%5Cn%23d-i%20mirror%2Fudeb%2Fcomponents%20multiselect%20main%2C%20restricted%5Cn%5Cn%23%23%20Part%204.%20Partitioning%5Cn%5Cn%23%20Disk%20Partitioning%5Cn%23%20Use%20LVM%2C%20and%20wipe%20out%20anything%20that%20already%20exists%5Cnd-i%20partman%2Fchoose_partition%20select%20finish%5Cnd-i%20partman%2Fconfirm%20boolean%20true%5Cnd-i%20partman%2Fconfirm_nooverwrite%20boolean%20true%5Cnd-i%20partman-auto%2Fmethod%20string%20lvm%5Cnd-i%20partman-lvm%2Fdevice_remove_lvm%20boolean%20true%5Cnd-i%20partman-lvm%2Fconfirm%20boolean%20true%5Cnd-i%20partman-lvm%2Fconfirm_nooverwrite%20boolean%20true%5Cnd-i%20partman-md%2Fdevice_remove_md%20boolean%20true%5Cnd-i%20partman-partitioning%2Fconfirm_write_new_label%20boolean%20true%5Cn%5Cn%23%20You%20can%20choose%20one%20of%20the%20three%20predefined%20partitioning%20recipes%3A%5Cn%23%20-%20atomic%3A%20all%20files%20in%20one%20partition%5Cn%23%20-%20home%3A%20%20%20separate%20%2Fhome%20partition%5Cn%23%20-%20multi%3A%20%20separate%20%2Fhome%2C%20%2Fusr%2C%20%2Fvar%2C%20and%20%2Ftmp%20partitions%5Cnd-i%20partman-auto%2Fchoose_recipe%20select%20atomic%5Cn%5Cn%23%20If%20you%20just%20want%20to%20change%20the%20default%20filesystem%20from%20ext3%20to%20something%5Cn%23%20else%2C%20you%20can%20do%20that%20without%20providing%20a%20full%20recipe.%5Cn%23%20d-i%20partman%2Fdefault_filesystem%20string%20ext4%5Cn%5Cn%23%23%20Part%205.%20Account%20setup%5Cn%5Cn%23%20root%20account%20and%20password%5Cnd-i%20passwd%2Froot-login%20boolean%20true%5Cnd-i%20passwd%2Froot-password-crypted%20password%20%24default_password_crypted%5Cn%5Cn%23%20skip%20creation%20of%20a%20normal%20user%20account.%5Cnd-i%20passwd%2Fmake-user%20boolean%20true%5Cnd-i%20passwd%2Fuser-fullname%20%20string%20anjia%5Cnd-i%20passwd%2Fusername%20%20%20%20%20%20%20string%20anjia%5Cnd-i%20passwd%2Fuser-password-crypted%20password%20%24default_password_crypted%5Cn%5Cn%23%23%20Part%206.%20Apt%20setup%5Cn%5Cn%23%20You%20can%20choose%20to%20install%20restricted%20and%20universe%20software%2C%20or%20to%20install%5Cn%23%20software%20from%20the%20backports%20repository.%5Cn%23%20d-i%20apt-setup%2Frestricted%20boolean%20true%5Cn%23%20d-i%20apt-setup%2Funiverse%20boolean%20true%5Cn%23%20d-i%20apt-setup%2Fbackports%20boolean%20true%5Cn%5Cn%23%20Uncomment%20this%20if%20you%20don't%20want%20to%20use%20a%20network%20mirror.%5Cn%23%20d-i%20apt-setup%2Fuse_mirror%20boolean%20true%5Cn%5Cn%23%20Select%20which%20update%20services%20to%20use%3B%20define%20the%20mirrors%20to%20be%20used.%5Cn%23%20Values%20shown%20below%20are%20the%20normal%20defaults.%5Cn%23%20d-i%20apt-setup%2Fservices-select%20multiselect%20security%5Cn%23%20d-i%20apt-setup%2Fsecurity_host%20string%20mirrors.aliyun.com%5Cn%23%20d-i%20apt-setup%2Fsecurity_path%20string%20%2Fubuntu%5Cn%5Cn%24SNIPPET('preseed_apt_repo_config')%5Cn%5Cn%23%20Enable%20deb-src%20lines%5Cn%23%20d-i%20apt-setup%2Flocal0%2Fsource%20boolean%20true%5Cn%5Cn%23%20URL%20to%20the%20public%20key%20of%20the%20local%20repository%3B%20you%20must%20provide%20a%20key%20or%5Cn%23%20apt%20will%20complain%20about%20the%20unauthenticated%20repository%20and%20so%20the%5Cn%23%20sources.list%20line%20will%20be%20left%20commented%20out%5Cn%23%20d-i%20apt-setup%2Flocal0%2Fkey%20string%20http%3A%2F%2Flocal.server%2Fkey%5Cn%5Cn%23%20By%20default%20the%20installer%20requires%20that%20repositories%20be%20authenticated%5Cn%23%20using%20a%20known%20gpg%20key.%20This%20setting%20can%20be%20used%20to%20disable%20that%5Cn%23%20authentication.%20Warning%3A%20Insecure%2C%20not%20recommended.%5Cn%23%20d-i%20debian-installer%2Fallow_unauthenticated%20boolean%20true%5Cn%5Cn%23%23%20Part%207.%20Package%20selection%5Cn%23%20Default%20for%20minimal%5Cntasksel%20tasksel%2Ffirst%20multiselect%20standard%5Cn%23%20Default%20for%20server%5Cn%23%20tasksel%20tasksel%2Ffirst%20multiselect%20standard%2C%20web-server%5Cn%23%20Default%20for%20gnome-desktop%5Cn%23%20tasksel%20tasksel%2Ffirst%20multiselect%20standard%2C%20gnome-desktop%5Cn%5Cn%23%20Individual%20additional%20packages%20to%20install%5Cn%23%20wget%20is%20REQUIRED%20otherwise%20quite%20a%20few%20things%20won't%20work%5Cn%23%20later%20in%20the%20build%20(like%20late-command%20scripts)%5Cnd-i%20pkgsel%2Finclude%20string%20ntp%20ssh%20wget%20%5Cn%5Cn%23%20Debian%20needs%20this%20for%20the%20installer%20to%20avoid%20any%20question%20for%20grub%5Cn%23%20Please%20verify%20that%20it%20suit%20your%20needs%20as%20it%20may%20overwrite%20any%20usb%20stick%5Cn%23if%20%24breed%20%3D%3D%20%5C%22debian%5C%22%5Cnd-i%20grub-installer%2Fgrub2_instead_of_grub_legacy%20boolean%20true%5Cnd-i%20grub-installer%2Fbootdev%20string%20default%5Cn%23end%20if%5Cn%5Cn%23%20Use%20the%20following%20option%20to%20add%20additional%20boot%20parameters%20for%20the%5Cn%23%20installed%20system%20(if%20supported%20by%20the%20bootloader%20installer).%5Cn%23%20Note%3A%20options%20passed%20to%20the%20installer%20will%20be%20added%20automatically.%5Cnd-i%20debian-installer%2Fadd-kernel-opts%20string%20%24kernel_options_post%5Cn%5Cn%23%20Avoid%20that%20last%20message%20about%20the%20install%20being%20complete.%5Cnd-i%20finish-install%2Freboot_in_progress%20note%5Cn%5Cn%23%23%20Figure%20out%20if%20we're%20kickstarting%20a%20system%20or%20a%20profile%5Cn%23if%20%24getVar('system_name'%2C'')%20!%3D%20''%5Cn%23set%20%24what%20%3D%20%5C%22system%5C%22%5Cn%23else%5Cn%23set%20%24what%20%3D%20%5C%22profile%5C%22%5Cn%23end%20if%5Cn%5Cn%23%20This%20first%20command%20is%20run%20as%20early%20as%20possible%2C%20just%20after%20preseeding%20is%20read.%5Cn%23%20d-i%20preseed%2Fearly_command%20string%20%5Bcommand%5D%5Cnd-i%20preseed%2Fearly_command%20string%20wget%20-O-%20%5C%5C%5Cn%20%20%20http%3A%2F%2F%24http_server%2Fcblr%2Fsvc%2Fop%2Fscript%2F%24what%2F%24name%2F%3Fscript%3Dpreseed_early_default%20%7C%20%5C%5C%5Cn%20%20%20%2Fbin%2Fsh%20-s%5Cn%5Cn%23%20This%20command%20is%20run%20immediately%20before%20the%20partitioner%20starts.%20It%20may%20be%5Cn%23%20useful%20to%20apply%20dynamic%20partitioner%20preseeding%20that%20depends%20on%20the%20state%5Cn%23%20of%20the%20disks%20(which%20may%20not%20be%20visible%20when%20preseed%2Fearly_command%20runs).%5Cn%23%20d-i%20partman%2Fearly_command%20%5C%5C%5Cn%23%20%20%20%20%20%20%20string%20debconf-set%20partman-auto%2Fdisk%20%5C%22%5C%5C%24(list-devices%20disk%20%7C%20head%20-n1)%5C%22%5Cn%5Cn%23%20This%20command%20is%20run%20just%20before%20the%20install%20finishes%2C%20but%20when%20there%20is%5Cn%23%20still%20a%20usable%20%2Ftarget%20directory.%20You%20can%20chroot%20to%20%2Ftarget%20and%20use%20it%5Cn%23%20directly%2C%20or%20use%20the%20apt-install%20and%20in-target%20commands%20to%20easily%20install%5Cn%23%20packages%20and%20run%20commands%20in%20the%20target%20system.%5Cn%23%20d-i%20preseed%2Flate_command%20string%20%5Bcommand%5D%5Cnd-i%20preseed%2Flate_command%20string%20wget%20-O-%20%5C%5C%5Cn%20%20%20http%3A%2F%2F%24http_server%2Fcblr%2Fsvc%2Fop%2Fscript%2F%24what%2F%24name%2F%3Fscript%3Dpreseed_late_default%20%7C%20%5C%5C%5Cn%20%20%20chroot%20%2Ftarget%20%2Fbin%2Fsh%20-s%22%7D\"></card><p><br /></p><h3 id=\"516808f3\">创建snippets</h3><p><br /></p><p>安装完后，自动安装软件,参考 <a href=\"https://github.com/cobbler/cobbler/wiki/Using%20template%20scripts%20for%20Debian%20and%20Ubuntu%20seeds\" target=\"_blank\">Using template scripts for Debian and Ubuntu seeds</a></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20tee%20%2Fvar%2Flib%2Fcobbler%2Fsnippets%2Fubuntu_apt_install_soft%20%3C%3C-'EOF'%5Cn%5Cnapt-get%20update%5Cnapt-get%20install%20-y%20language-pack-zh-hans%20apt-transport-https%20ca-certificates%20software-properties-common%20%20git%20ansible%20openssh-server%20vim%20curl%20htop%20iotop%20iftop%20ncdu%5Cn%5Cncurl%20-fsSL%20http%3A%2F%2Fmirrors.aliyun.com%2Fdocker-ce%2Flinux%2Fubuntu%2Fgpg%20%7C%20sudo%20apt-key%20add%20-%5Cnsudo%20add-apt-repository%20%5C%22deb%20%5Barch%3Damd64%5D%20http%3A%2F%2Fmirrors.aliyun.com%2Fdocker-ce%2Flinux%2Fubuntu%20%24(lsb_release%20-cs)%20stable%5C%22%5Cnapt-get%20update%5Cn%5Cnapt-get%20install%20-y%20docker-ce%3D18.06.2~ce~3-0~ubuntu%5Cnapt-mark%20hold%20docker-ce%5Cnsystemctl%20enable%20docker%5CnEOF%5Cn%5Cn%23%23%20%2F%2F%20d-i%20preseed%2Flate_command%20%E9%98%B6%E6%AE%B5%E6%89%A7%E8%A1%8C%5Cn%5Broot%40localhost%20~%5D%23%20echo%20'%24SNIPPET(%5C%22ubuntu_apt_install_soft%5C%22)%20%3E%3E%20%2Fvar%2Flib%2Fcobbler%2Fsnippets%2Flate_apt_repo_config%22%7D\"></card><p> </p><h3 id=\"2a68d258\">设置ubuntu package repo</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20cobbler%20repo%20edit%20--name%3Dubuntu-16.04.5-server-x86_64%20--arch%3Dx86_64%20--breed%3Dapt%20--mirror%3Dhttp%3A%2F%2Fmirrors.aliyun.com%2Fubuntu%20--owners%3Dadmin%20--mirror-locally%3DFalse%20--apt-components%3D'main%20universe'%20--apt-dists%3D'xenial%20xenial-updates%20xenial-security'%5Cn%5Broot%40localhost%20~%5D%23%20cobbler%20profile%20edit%20--name%3Dubuntu-16.04.5-server-x86_64%20--repos%3Dubuntu-16.04.5-server-x86_64%22%7D\"></card><p><br /></p><p>限于篇幅，下一篇，将介绍Cobbler安装Windows</p><p><br /></p><h2 id=\"a08138fa\">常见错误</h2><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20cobbler%20check%5Cncobblerd%20does%20not%20appear%20to%20be%20running%2Faccessible%3A%20error(111%2C%20'Connection%20refused')%20%22%7D\"></card><p><br /></p><p>原因：未启动相关服务</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20cobbler%20check%5Cnhttpd%20does%20not%20appear%20to%20be%20running%20and%20proxying%20cobbler%2C%20or%20SELinux%20is%20in%20the%20way.%20Original%20traceback%3A%5CnTraceback%20(most%20recent%20call%20last)%3A%5Cn%20%20File%20%5C%22%2Fusr%2Flib%2Fpython2.7%2Fsite-packages%2Fcobbler%2Fcli.py%5C%22%2C%20line%20251%2C%20in%20check_setup%5Cn%20%20%20%20s.ping()%5Cn%20%20File%20%5C%22%2Fusr%2Flib64%2Fpython2.7%2Fxmlrpclib.py%5C%22%2C%20line%201233%2C%20in%20__call__%5Cn%20%20%20%20return%20self.__send(self.__name%2C%20args)%5Cn%20%20File%20%5C%22%2Fusr%2Flib64%2Fpython2.7%2Fxmlrpclib.py%5C%22%2C%20line%201591%2C%20in%20__request%5Cn%20%20%20%20verbose%3Dself.__verbose%5Cn%20%20File%20%5C%22%2Fusr%2Flib64%2Fpython2.7%2Fxmlrpclib.py%5C%22%2C%20line%201273%2C%20in%20request%5Cn%20%20%20%20return%20self.single_request(host%2C%20handler%2C%20request_body%2C%20verbose)%5Cn%20%20File%20%5C%22%2Fusr%2Flib64%2Fpython2.7%2Fxmlrpclib.py%5C%22%2C%20line%201321%2C%20in%20single_request%5Cn%20%20%20%20response.msg%2C%5CnProtocolError%3A%20%3CProtocolError%20for%20127.0.0.1%3A80%2Fcobbler_api%3A%20503%20Service%20Unavailable%3E%22%7D\"></card><p>未关闭防火墙</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20cobbler%20sync%5Cnreceived%20on%20stderr%3A%20Redirecting%20to%20%2Fbin%2Fsystemctl%20restart%20dhcpd.service%5CnJob%20for%20dhcpd.service%20failed%20because%20the%20control%20process%20exited%20with%20error%20code.%20See%20%5C%22systemctl%20status%20dhcpd.service%5C%22%20and%20%5C%22journalctl%20-xe%5C%22%20for%20details.%5Cn%5CnException%20occured%3A%20%3Cclass%20'cobbler.cexceptions.CX'%3E%5CnException%20value%3A%20'cobbler%20trigger%20failed%3A%20cobbler.modules.sync_post_restart_services'%5CnException%20Info%3A%5Cn%20%20File%20%5C%22%2Fusr%2Flib%2Fpython2.7%2Fsite-packages%2Fcobbler%2Fremote.py%5C%22%2C%20line%2082%2C%20in%20run%5Cn%20%20%20%20rc%20%3D%20self._run(self)%5Cn%20%20%20File%20%5C%22%2Fusr%2Flib%2Fpython2.7%2Fsite-packages%2Fcobbler%2Fremote.py%5C%22%2C%20line%20181%2C%20in%20runner%5Cn%20%20%20%20return%20self.remote.api.sync(self.options.get(%5C%22verbose%5C%22%2CFalse)%2Clogger%3Dself.logger)%5Cn%20%20%20File%20%5C%22%2Fusr%2Flib%2Fpython2.7%2Fsite-packages%2Fcobbler%2Fapi.py%5C%22%2C%20line%20763%2C%20in%20sync%5Cn%20%20%20%20return%20sync.run()%5Cn%20%20%20File%20%5C%22%2Fusr%2Flib%2Fpython2.7%2Fsite-packages%2Fcobbler%2Faction_sync.py%5C%22%2C%20line%20144%2C%20in%20run%5Cn%20%20%20%20utils.run_triggers(self.api%2C%20None%2C%20%5C%22%2Fvar%2Flib%2Fcobbler%2Ftriggers%2Fsync%2Fpost%2F*%5C%22%2C%20logger%3Dself.logger)%5Cn%20%20%20File%20%5C%22%2Fusr%2Flib%2Fpython2.7%2Fsite-packages%2Fcobbler%2Futils.py%5C%22%2C%20line%20928%2C%20in%20run_triggers%5Cn%20%20%20%20raise%20CX(%5C%22cobbler%20trigger%20failed%3A%20%25s%5C%22%20%25%20m.__name__)%5Cn%5Cn!!!%20TASK%20FAILED%20!!!%22%7D\"></card><p>没改dhcp模板，导致sync同步出问题</p><p><br /></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%5Broot%40localhost%20~%5D%23%20cat%20%2Fvar%2Flog%2Fhttpd%2Fssl_error_log%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460442%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20mod_wsgi%20(pid%3D6910)%3A%20Exception%20occurred%20processing%20WSGI%20script%20'%2Fusr%2Fshare%2Fcobbler%2Fweb%2Fcobbler.wsgi'.%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460559%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20Traceback%20(most%20recent%20call%20last)%3A%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460605%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20File%20%5C%22%2Fusr%2Fshare%2Fcobbler%2Fweb%2Fcobbler.wsgi%5C%22%2C%20line%2026%2C%20in%20application%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460668%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20%20%20_application%20%3D%20get_wsgi_application()%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460684%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20File%20%5C%22%2Fusr%2Flib%2Fpython2.7%2Fsite-packages%2Fdjango%2Fcore%2Fwsgi.py%5C%22%2C%20line%2013%2C%20in%20get_wsgi_application%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460723%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20%20%20django.setup(set_prefix%3DFalse)%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460737%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20File%20%5C%22%2Fusr%2Flib%2Fpython2.7%2Fsite-packages%2Fdjango%2F__init__.py%5C%22%2C%20line%2022%2C%20in%20setup%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460768%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20%20%20configure_logging(settings.LOGGING_CONFIG%2C%20settings.LOGGING)%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460781%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20File%20%5C%22%2Fusr%2Flib%2Fpython2.7%2Fsite-packages%2Fdjango%2Fconf%2F__init__.py%5C%22%2C%20line%2056%2C%20in%20__getattr__%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460812%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20%20%20self._setup(name)%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460824%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20File%20%5C%22%2Fusr%2Flib%2Fpython2.7%2Fsite-packages%2Fdjango%2Fconf%2F__init__.py%5C%22%2C%20line%2041%2C%20in%20_setup%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460852%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20%20%20self._wrapped%20%3D%20Settings(settings_module)%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460871%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20File%20%5C%22%2Fusr%2Flib%2Fpython2.7%2Fsite-packages%2Fdjango%2Fconf%2F__init__.py%5C%22%2C%20line%20110%2C%20in%20__init__%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460900%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20%20%20mod%20%3D%20importlib.import_module(self.SETTINGS_MODULE)%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460911%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20File%20%5C%22%2Fusr%2Flib64%2Fpython2.7%2Fimportlib%2F__init__.py%5C%22%2C%20line%2037%2C%20in%20import_module%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460953%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20%20%20__import__(name)%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460973%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20File%20%5C%22%2Fusr%2Fshare%2Fcobbler%2Fweb%2Fsettings.py%5C%22%2C%20line%2089%2C%20in%20%3Cmodule%3E%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.460995%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20%20%20%20%20from%20django.conf.global_settings%20import%20TEMPLATE_CONTEXT_PROCESSORS%5Cn%5BFri%20Feb%2022%2020%3A07%3A49.461043%202019%5D%20%5B%3Aerror%5D%20%5Bpid%206910%5D%20%5Bremote%20127.0.0.1%3A204%5D%20ImportError%3A%20cannot%20import%20name%20TEMPLATE_CONTEXT_PROCESSORS%22%7D\"></card><p><code>pip2.7 install -U django==1.9.13</code> </p><p><br /></p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://access.redhat.com/documentation/en-us/red_hat_network_satellite/5.3/html/reference_guide/ch-cobbler#s3-cobbler-reqs-security-iptables\" target=\"_blank\">配置防火墙</a></li><li><a href=\"https://github.com/cobbler/cobbler/issues/1959\" target=\"_blank\"><span>cobbler 2.8.4/2.8.0 on centos 7 error</span></a></li><li><a href=\"https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax\" target=\"_blank\">KICKSTART 语法参考</a></li><li><a href=\"https://www.kancloud.cn/devops-centos/centos-linux-devops/392369\" target=\"_blank\"><span class=\"lake-fontsize-11\" style=\"color: #000000;\">运维工作笔记-Cobbler 配置文件</span></a></li><li><a href=\"https://www.debian.org/releases/stable/amd64/apbs04.html.zh-cn\" target=\"_blank\">Preseed语法参考</a></li><li><span><a href=\"https://github.com/cobbler/cobbler/issues/1262\" target=\"_blank\">Support selection of automatic installation file format in distros which allow it (Debian/Ubuntu allows kickstart and preseed) </a></span></li><li><a href=\"https://thornelabs.blog/posts/problems-provisioning-ubuntu-with-cobbler-and-kickstart-profiles.html\" target=\"_blank\"><span>Problems Provisioning Ubuntu with Cobbler and Kickstart Profiles</span></a></li><li><a href=\"https://github.com/cobbler/cobbler/wiki/Using%20template%20scripts%20for%20Debian%20and%20Ubuntu%20seeds\" target=\"_blank\">Using template scripts for Debian and Ubuntu seeds</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-02-27T05:25:52.000Z",
    "deleted_at": null,
    "created_at": "2019-02-22T07:44:41.000Z",
    "updated_at": "2019-08-16T03:49:46.000Z",
    "published_at": "2019-02-27T05:25:52.000Z",
    "first_published_at": "2019-02-25T13:49:45.000Z",
    "word_count": 4491,
    "cover": "https://cdn.nlark.com/yuque/0/2019/png/226273/1551102584737-1c17d816-1177-4c36-8f01-343a2b9306d5.png",
    "description": "date: 2019-02-22 15:46:00tags: [pxe,dhcp,cobbler,centos,ubuntu,windows,tftp]categories: 运维---这是坚持技术写作计划（含翻译）的第6篇，定个小目标999，每周最少2篇。本文主要讲解通过CentOS7.6 ...",
    "custom_description": "这是坚持技术写作计划（含翻译）的第6篇，定个小目标999，每周最少2篇。本文主要讲解通过CentOS7.6 安装Cobbler并且自动化安装Centos 7.6 和Ubuntu 16.04 ...",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1259513,
    "slug": "es-forbidden-12",
    "title": "005-blocked by：[FORBIDDEN/12/index read-only / allow delete (api)]",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-02-19 08:31:34<br />tags: [es,elasticsearch,运维]<br />categories: 运维<br />---\n\n> 这是坚持技术写作计划（含翻译）的第5篇，定个小目标999，每周最少2篇。\n\n\n吐槽一下，最近有点招bug，前两天磁盘异常爆满，今天es又挂了。\n\n<a name=\"11e8ce1c\"></a>\n## Logstash ClusterBlockException\n\nlogstash 日志中周期性出现 `FORBIDDEN/12/index read-only / allow delete (api)]` ，并且es中无法写入新数据。<br />原因是 ES 主动保护功能，防止es集群状态变成红色(RED)或者黄色(YELLOW)<br />原因有两个:\n\n- 内存不足：JVMMemoryPressure 超过92%并持续30分钟时，ES触发保护机制，并且阻止写入操作，以防止集群达到红色状态，启用写保护后，写入操作将失败，并且抛出 `ClusterBlockException` ，无法创建新索引，并且抛出 `IndexCreateBlockException` ,当五分钟内恢复到88%以下时，将禁用写保护\n- 磁盘空间不足：es的默认磁盘水位警戒线是85%，一旦磁盘使用率超过85%，es不会再为该节点分配分片，es还有一个磁盘水位警戒线是90%，超过后，将尝试将分片重定位到其他节点。\n\n<a name=\"de842a6c\"></a>\n## 解决方案\n\n- 磁盘扩容\n- 删除无用索引\n- 将旧索引的副本数调小\n- 增加数据节点\n- 手动将 `index.blocks.read_only_allow_delete` 改成false\n\n<a name=\"4d13249a\"></a>\n## 另\n还有一种报错是 `blocked by: [FORBIDDEN/8/index write (api)];` 后续再补充\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [AWS elastic-search. FORBIDDEN/8/index write (api). Unable to write to index](https://stackoverflow.com/questions/44383601/aws-elastic-search-forbidden-8-index-write-api-unable-to-write-to-index)\n- [Dynamic Index Settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules.html#dynamic-index-settings)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。\n\n长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n",
    "body_draft": "",
    "body_html": "<p><span>date: 2019-02-19 08:31:34</span></p><p>tags: [es,elasticsearch,<span>运维</span>]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote><p><span style=\"color: #8C8C8C;\">这是坚持技术写作计划（含翻译）的第5篇，定个小目标999，每周最少2篇。</span></p></blockquote><p><br /></p><p>吐槽一下，最近有点招bug，前两天磁盘异常爆满，今天es又挂了。</p><p><br /></p><h2 id=\"11e8ce1c\">Logstash ClusterBlockException</h2><p><br /></p><p>logstash 日志中周期性出现 <code>FORBIDDEN/12/index read-only / allow delete (api)]</code> ，并且es中无法写入新数据。</p><p>原因是 ES 主动保护功能，防止es集群状态变成红色(RED)或者黄色(YELLOW)</p><p>原因有两个:</p><ul><li>内存不足：JVMMemoryPressure 超过92%并持续30分钟时，ES触发保护机制，并且阻止写入操作，以防止集群达到红色状态，启用写保护后，写入操作将失败，并且抛出 <code>ClusterBlockException</code> ，无法创建新索引，并且抛出 <code>IndexCreateBlockException</code> ,当五分钟内恢复到88%以下时，将禁用写保护</li><li>磁盘空间不足：es的默认磁盘水位警戒线是85%，一旦磁盘使用率超过85%，es不会再为该节点分配分片，es还有一个磁盘水位警戒线是90%，超过后，将尝试将分片重定位到其他节点。</li></ul><p><br /></p><h2 id=\"de842a6c\">解决方案</h2><p><br /></p><ul><li>磁盘扩容</li><li>删除无用索引</li><li>将旧索引的副本数调小</li><li>增加数据节点</li><li>手动将 <code>index.blocks.read_only_allow_delete</code> 改成false</li></ul><p><br /></p><h2 id=\"4d13249a\">另</h2><p>还有一种报错是 <code>blocked by: [FORBIDDEN/8/index write (api)];</code> 后续再补充</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://stackoverflow.com/questions/44383601/aws-elastic-search-forbidden-8-index-write-api-unable-to-write-to-index\" target=\"_blank\">AWS elastic-search. FORBIDDEN/8/index write (api). Unable to write to index</a></li><li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules.html#dynamic-index-settings\" target=\"_blank\">Dynamic Index Settings</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "body_lake": "<!doctype lake><p><span>date: 2019-02-19 08:31:34</span></p><p>tags: [es,elasticsearch,<span>运维</span>]</p><p>categories: 运维<cursor /></p><p>---</p><p><br /></p><blockquote><p><span style=\"color: #8C8C8C;\">这是坚持技术写作计划（含翻译）的第5篇，定个小目标999，每周最少2篇。</span></p></blockquote><p><br /></p><p>吐槽一下，最近有点招bug，前两天磁盘异常爆满，今天es又挂了。</p><p><br /></p><h2 id=\"11e8ce1c\">Logstash ClusterBlockException</h2><p><br /></p><p>logstash 日志中周期性出现 <code>FORBIDDEN/12/index read-only / allow delete (api)]</code> ，并且es中无法写入新数据。</p><p>原因是 ES 主动保护功能，防止es集群状态变成红色(RED)或者黄色(YELLOW)</p><p>原因有两个:</p><ul><li>内存不足：JVMMemoryPressure 超过92%并持续30分钟时，ES触发保护机制，并且阻止写入操作，以防止集群达到红色状态，启用写保护后，写入操作将失败，并且抛出 <code>ClusterBlockException</code> ，无法创建新索引，并且抛出 <code>IndexCreateBlockException</code> ,当五分钟内恢复到88%以下时，将禁用写保护</li><li>磁盘空间不足：es的默认磁盘水位警戒线是85%，一旦磁盘使用率超过85%，es不会再为该节点分配分片，es还有一个磁盘水位警戒线是90%，超过后，将尝试将分片重定位到其他节点。</li></ul><p><br /></p><h2 id=\"de842a6c\">解决方案</h2><p><br /></p><ul><li>磁盘扩容</li><li>删除无用索引</li><li>将旧索引的副本数调小</li><li>增加数据节点</li><li>手动将 <code>index.blocks.read_only_allow_delete</code> 改成false</li></ul><p><br /></p><h2 id=\"4d13249a\">另</h2><p>还有一种报错是 <code>blocked by: [FORBIDDEN/8/index write (api)];</code> 后续再补充</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://stackoverflow.com/questions/44383601/aws-elastic-search-forbidden-8-index-write-api-unable-to-write-to-index\" target=\"_blank\">AWS elastic-search. FORBIDDEN/8/index write (api). Unable to write to index</a></li><li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules.html#dynamic-index-settings\" target=\"_blank\">Dynamic Index Settings</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-02-19T06:21:52.000Z",
    "deleted_at": null,
    "created_at": "2019-02-18T01:41:15.000Z",
    "updated_at": "2019-02-19T06:33:14.000Z",
    "published_at": "2019-02-19T06:33:13.000Z",
    "first_published_at": "2019-02-18T02:05:59.000Z",
    "word_count": 426,
    "cover": "https://cdn.nlark.com/yuque/0/2019/png/226273/1550455558948-fcf67a03-c2b3-4558-abd6-0a31f065277f.png",
    "description": "date: 2019-02-19 08:31:34tags: [es,elasticsearch,运维]categories: 运维---这是坚持技术写作计划（含翻译）的第5篇，定个小目标999，每周最少2篇。吐槽一下，最近有点招bug，前两天磁盘异常爆满，今天es又挂了。Logstash C...",
    "custom_description": "这是坚持技术写作计划（含翻译）的第5篇，定个小目标999，每周最少2篇。吐槽一下，最近有点招bug，前两天磁盘异常爆满，今天es又挂了。Logstash ClusterBlockExceptionlogstash 日志中周期性出现 FORBIDDEN/12/index read-only / ...",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1256013,
    "slug": "lets-encrypt-acme-sh",
    "title": "004-零失败快速搞定通配符SSL证书",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-02-18 12:43:00<br />tags: [ssl,https,http2,lets-encrypt,acme,acme-sh]<br />categories: 运维<br />---\n\n> \n> 这是坚持技术写作计划（含翻译）的第四篇，定个小目标999，每周最少2篇。\n\n\n> 过去几年中，我们一直主张站点采用 HTTPS，以提升其安全性。去年的时候，我们还通过将更大的 HTTP 页面标记为‘不安全’以帮助用户。\n> 不过从 2018 年 7 月开始，随着 Chrome 68 的发布，浏览器会将所有 HTTP 网站标记为‘不安全’。\n> 引用自 [chrome 68 发布说明](https://support.google.com/chrome/a/answer/7679408)\n\n\n得益于Google等大厂的消灭HTTP运动和[Let's Encrypt](https://letsencrypt.org) 非盈利组织的努力，越来越多的站点开始迁移到HTTPS，下图是[Let's Encrypt的统计数据](https://letsencrypt.org/stats/)<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1550317966768-d4587466-a6d0-4868-b9ca-4e65bc45b101.png#align=left&display=inline&height=450&name=image.png&originHeight=450&originWidth=940&size=41971&width=940)<br /><!-- more -->\n\n<a name=\"d8c35fbf\"></a>\n## 什么是Let's Encrypt\n\n部署 HTTPS 网站的时候需要证书，证书由 CA 机构签发，大部分传统 CA 机构签发证书是需要收费的，这不利于推动 HTTPS 协议的使用。\n\nLet's Encrypt是一个国外的非盈利的CA证书机构，旨在以自动化流程消除手动创建和安装证书的复杂流程，并推广使万维网服务器的加密连接无所不在，为安全网站提供免费的SSL/TLS证书。\n\n由Linux基金会托管，许多国内外互联网大厂都对其进行赞助，目前主流浏览器均已信任Let's Encrypt发放的证书。\n\n注意，Let's Encrypt颁发的都是DV证书，不提供OV,EV证书。\n\n本文主要讲解 如何使用Let's Encrypt颁发通配符证书。\n\n<a name=\"cbaf77e0\"></a>\n## 通配符证书\n\n通配符SSL证书旨在保护主域名以及旗下不限数量的子域，即用户可通过单个通配符SSL证书可保护任意数量的子域。如果用户拥有多个子域名平台，可通过通配符SSL证书保护这些子域名。\n\n但是目前Let's Encrypt 只支持同级子域名通配符。例如 `*.demo.com` 只支持 `xx.demo.com` 这种的，而不支持 `xx.xx.demo.com` ，而要支持二级通配符，需要再次颁发二级通配符证书 类似 `*.demo.demo.com` ，注意，这种的二级通配符，要求，一级域名是固定的，意即，不支持 `*.*.demo.com` \n\n<a name=\"1c74e63c\"></a>\n## 使用 acme.sh 简化证书颁发操作\n\n官方建议使用[Certbot](https://certbot.eff.org/) ，但是很长一段时期Certbot不支持通配符（现在已经支持），而且对于证书自动续期支持的也不好。并且操作时也挺麻烦。\n\n\n<a name=\"0c48da8f\"></a>\n### 安装 acme.sh\n\n```bash\n$ curl https://get.acme.sh | sh\n# 或者\n$ wget -O -  https://get.acme.sh | sh\n# 或者\n$ git clone https://github.com/Neilpang/acme.sh.git\n$ ./acme.sh/acme.sh --install\n```\n\n<a name=\"4c752c1e\"></a>\n### DNS Api 颁发通配符证书\nacme.sh 功能很强大，此处只介绍使用Dns Api 自动化颁发通配符证书. 目前支持包含阿里和DNSPod在内的60家dns服务商（参见 [Currently acme.sh supports](https://github.com/Neilpang/acme.sh#currently-acmesh-supports)）\n\n如果你的DNS服务商不提供API或者acme.sh暂未支持，或者处于安全方面的考虑，不想将重要的域名的API权限暴露给 acme.sh，可以申请一个测试域名，然后在重要域名上设置CNAME（参见 [DNS alias mode](https://github.com/Neilpang/acme.sh/wiki/DNS-alias-mode)）\n\n假设您的域名在DNSPod托管，登陆DNSPod后台，依次打开 用户中心->安全设置-> API Token->查看->创建API Token-> 输入任意token名称->确定-> 保存ID和Token值（图中打码部分）\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1550463481824-01a645a7-5a95-4320-80ab-753ff7664bff.png#align=left&display=inline&height=558&name=image.png&originHeight=558&originWidth=1241&size=59891&width=1241)\n\n```bash\n$ export DP_Id=\"你的ID\"\n$ export DP_Key=\"你的Token\"\n$ acme.sh --issue --dns dns_dp -d example.com -d *.example.com\n# 如果 使用了DNS别名，还需要增加 --challenge-alias 别名域名 参数\n# 为了防止dns不生效，脚本会暂停2分钟，并倒计时(Sleep 120 seconds for the txt records to take effect),等待即可\n# 如果成功会出现 Cert success. 字样\n# 不建议直接用~/.acme.sh 下的证书，参考 https://github.com/Neilpang/acme.sh/wiki/说明#3-copy安装-证书\n# 需要使用 --installcert 复制到指定目录\n$ acme.sh --installcert  \\\n\t\t\t\t-d  example.com -d *.example.com \\\n        --key-file /etc/letsencrypt/live/example.com/privkey.pem \\\n        --fullchain-file /etc/letsencrypt/live/example.com/fullchain.pem \\\n        --reloadcmd  \"service nginx reload\"\n```\n\n<a name=\"03e61821\"></a>\n### 优化HTTPS配置\n本文以 [Mozilla SSL Configuration Generator](https://mozilla.github.io/server-side-tls/ssl-config-generator/) 生成的nginx为例，同样也可以生成Apache和IIS\n\n```nginx\nserver {\n    listen 80 default_server;\n    listen [::]:80 default_server;\n\n    # Redirect all HTTP requests to HTTPS with a 301 Moved Permanently response.\n    return 301 https://$host$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n    listen [::]:443 ssl http2;\n\n    # certs sent to the client in SERVER HELLO are concatenated in ssl_certificate\n    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;\n    ssl_session_timeout 1d;\n    ssl_session_cache shared:SSL:50m;\n    ssl_session_tickets off;\n\n    # Diffie-Hellman parameter for DHE ciphersuites, recommended 2048 bits\n    # openssl dhparam -out /etc/letsencrypt/live/example.com/ 2048\n    ssl_dhparam /etc/letsencrypt/live/example.com/dhparam.pem;\n\n    # intermediate configuration. tweak to your needs.\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS';\n    ssl_prefer_server_ciphers on;\n\n    # HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)\n    add_header Strict-Transport-Security max-age=15768000;\n\n    # OCSP Stapling ---\n    # fetch OCSP records from URL in ssl_certificate and cache them\n    ssl_stapling on;\n    ssl_stapling_verify on;\n\n    ## verify chain of trust of OCSP response using Root CA and Intermediate certs\n    # ssl_trusted_certificate /path/to/root_CA_cert_plus_intermediates;\n\n    resolver <IP DNS resolver>;\n\n    ....\n}\n```\n\n<a name=\"7154ff4a\"></a>\n### 检查HTTPS得分\n访问 [https://www.ssllabs.com/ssltest/](https://www.ssllabs.com/ssltest/) 提交自己域名，进行评分\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [Chrome 将不再标记 HTTPS 页面为安全站点](https://www.oschina.net/news/96200/chrome-will-stop-tag-https-site-secure)\n- [Let's Encrypt Stats](https://letsencrypt.org/stats/)\n- [About Let's Encrypt](https://letsencrypt.org/about/)\n- [Mozilla SSL Configuration Generator](https://mozilla.github.io/server-side-tls/ssl-config-generator/)\n- [DV型、OV型、EV型证书的主要区别](https://www.cnblogs.com/sslwork/p/6193256.html)\n- [Neilpang/acme.sh#Wiki#安装说明](https://github.com/Neilpang/acme.sh/blob/master/dnsapi/README.md)\n- [Neilpang/acme.sh#Wiki#How to Install](https://github.com/Neilpang/acme.sh/wiki/How-to-install)\n- [Neilpang/acme.sh#Wiki#How to use DNS API](https://github.com/Neilpang/acme.sh/wiki/How-to-install)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。\n\n长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n",
    "body_draft": "",
    "body_html": "<p><span>date: 2019-02-18 12:43:00</span></p><p>tags: [ssl,https,http2,lets-encrypt,acme,acme-sh]</p><p>categories: 运维</p><p>---</p><p><br /></p><blockquote><p><br /></p><p>这是坚持技术写作计划（含翻译）的第四篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><blockquote><p>过去几年中，我们一直主张站点采用 HTTPS，以提升其安全性。去年的时候，我们还通过将更大的 HTTP 页面标记为‘不安全’以帮助用户。</p><p>不过从 2018 年 7 月开始，随着 Chrome 68 的发布，浏览器会将所有 HTTP 网站标记为‘不安全’。</p><p>引用自 <a href=\"https://support.google.com/chrome/a/answer/7679408\" target=\"_blank\">chrome 68 发布说明</a></p></blockquote><p><br /></p><p>得益于Google等大厂的消灭HTTP运动和<a href=\"https://letsencrypt.org\" target=\"_blank\">Let's Encrypt</a> 非盈利组织的努力，越来越多的站点开始迁移到HTTPS，下图是<a href=\"https://letsencrypt.org/stats/\" target=\"_blank\">Let's Encrypt的统计数据</a></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1550317966768-d4587466-a6d0-4868-b9ca-4e65bc45b101.png#align=left&amp;display=inline&amp;height=450&amp;name=image.png&amp;originHeight=450&amp;originWidth=940&amp;size=41971&amp;width=940\" style=\"max-width: 600px; width: 940px;\" /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"d8c35fbf\">什么是Let's Encrypt</h2><p><br /></p><p>部署 HTTPS 网站的时候需要证书，证书由 CA 机构签发，大部分传统 CA 机构签发证书是需要收费的，这不利于推动 HTTPS 协议的使用。</p><p><br /></p><p>Let's Encrypt是一个国外的非盈利的CA证书机构，旨在以自动化流程消除手动创建和安装证书的复杂流程，并推广使万维网服务器的加密连接无所不在，为安全网站提供免费的SSL/TLS证书。</p><p><br /></p><p>由Linux基金会托管，许多国内外互联网大厂都对其进行赞助，目前主流浏览器均已信任Let's Encrypt发放的证书。</p><p><br /></p><p>注意，Let's Encrypt颁发的都是DV证书，不提供OV,EV证书。</p><p><br /></p><p>本文主要讲解 如何使用Let's Encrypt颁发通配符证书。</p><p><br /></p><h2 id=\"cbaf77e0\">通配符证书</h2><p><br /></p><p>通配符SSL证书旨在保护主域名以及旗下不限数量的子域，即用户可通过单个通配符SSL证书可保护任意数量的子域。如果用户拥有多个子域名平台，可通过通配符SSL证书保护这些子域名。</p><p><br /></p><p>但是目前Let's Encrypt 只支持同级子域名通配符。例如 <code>*.demo.com</code> 只支持 <code>xx.demo.com</code> 这种的，而不支持 <code>xx.xx.demo.com</code> ，而要支持二级通配符，需要再次颁发二级通配符证书 类似 <code>*.demo.demo.com</code> ，注意，这种的二级通配符，要求，一级域名是固定的，意即，不支持 <code>*.*.demo.com</code> </p><p><br /></p><h2 id=\"1c74e63c\">使用 acme.sh 简化证书颁发操作</h2><p><br /></p><p>官方建议使用<a href=\"https://certbot.eff.org/\" target=\"_blank\">Certbot</a> ，但是很长一段时期Certbot不支持通配符<span>（现在已经支持）</span>，而且对于证书自动续期支持的也不好。并且操作时也挺麻烦。</p><p><br /></p><p><br /></p><h3 id=\"0c48da8f\">安装 acme.sh</h3><p><br /></p><pre data-lang=\"bash\"><code>$ curl https://get.acme.sh | sh\n# 或者\n$ wget -O -  https://get.acme.sh | sh\n# 或者\n$ git clone https://github.com/Neilpang/acme.sh.git\n$ ./acme.sh/acme.sh --install</code></pre><p><br /></p><h3 id=\"4c752c1e\">DNS Api 颁发通配符证书</h3><p>acme.sh 功能很强大，此处只介绍使用Dns Api 自动化颁发通配符证书. 目前支持包含阿里和DNSPod在内的60家dns服务商（参见 <a href=\"https://github.com/Neilpang/acme.sh#currently-acmesh-supports\" target=\"_blank\">Currently acme.sh supports</a>）</p><p><br /></p><p>如果你的DNS服务商不提供API或者acme.sh暂未支持，或者处于安全方面的考虑，不想将重要的域名的API权限暴露给 acme.sh，可以申请一个测试域名，然后在重要域名上设置CNAME（参见 <a href=\"https://github.com/Neilpang/acme.sh/wiki/DNS-alias-mode\" target=\"_blank\">DNS alias mode</a>）</p><p><br /></p><p>假设您的域名在DNSPod托管，登陆DNSPod后台，依次打开 用户中心-&gt;安全设置-&gt; API Token-&gt;查看-&gt;创建API Token-&gt; 输入任意token名称-&gt;确定-&gt; 保存ID和Token值（图中打码部分）</p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1550463481824-01a645a7-5a95-4320-80ab-753ff7664bff.png#align=left&amp;display=inline&amp;height=558&amp;name=image.png&amp;originHeight=558&amp;originWidth=1241&amp;size=59891&amp;width=1241\" style=\"max-width: 600px; width: 1241px;\" /></p><p><br /></p><pre data-lang=\"bash\"><code>$ export DP_Id=&quot;你的ID&quot;\n$ export DP_Key=&quot;你的Token&quot;\n$ acme.sh --issue --dns dns_dp -d example.com -d *.example.com\n# 如果 使用了DNS别名，还需要增加 --challenge-alias 别名域名 参数\n# 为了防止dns不生效，脚本会暂停2分钟，并倒计时(Sleep 120 seconds for the txt records to take effect),等待即可\n# 如果成功会出现 Cert success. 字样\n# 不建议直接用~/.acme.sh 下的证书，参考 https://github.com/Neilpang/acme.sh/wiki/说明#3-copy安装-证书\n# 需要使用 --installcert 复制到指定目录\n$ acme.sh --installcert  \\\n\t\t\t\t-d  example.com -d *.example.com \\\n        --key-file /etc/letsencrypt/live/example.com/privkey.pem \\\n        --fullchain-file /etc/letsencrypt/live/example.com/fullchain.pem \\\n        --reloadcmd  &quot;service nginx reload&quot;</code></pre><p><br /></p><h3 id=\"03e61821\">优化HTTPS配置</h3><p>本文以 <a href=\"https://mozilla.github.io/server-side-tls/ssl-config-generator/\" target=\"_blank\">Mozilla SSL Configuration Generator</a> 生成的nginx为例，同样也可以生成Apache和IIS</p><p><br /></p><pre data-lang=\"nginx\"><code>server {\n    listen 80 default_server;\n    listen [::]:80 default_server;\n\n    # Redirect all HTTP requests to HTTPS with a 301 Moved Permanently response.\n    return 301 https://$host$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n    listen [::]:443 ssl http2;\n\n    # certs sent to the client in SERVER HELLO are concatenated in ssl_certificate\n    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;\n    ssl_session_timeout 1d;\n    ssl_session_cache shared:SSL:50m;\n    ssl_session_tickets off;\n\n    # Diffie-Hellman parameter for DHE ciphersuites, recommended 2048 bits\n    # openssl dhparam -out /etc/letsencrypt/live/example.com/ 2048\n    ssl_dhparam /etc/letsencrypt/live/example.com/dhparam.pem;\n\n    # intermediate configuration. tweak to your needs.\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS';\n    ssl_prefer_server_ciphers on;\n\n    # HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)\n    add_header Strict-Transport-Security max-age=15768000;\n\n    # OCSP Stapling ---\n    # fetch OCSP records from URL in ssl_certificate and cache them\n    ssl_stapling on;\n    ssl_stapling_verify on;\n\n    ## verify chain of trust of OCSP response using Root CA and Intermediate certs\n    # ssl_trusted_certificate /path/to/root_CA_cert_plus_intermediates;\n\n    resolver &lt;IP DNS resolver&gt;;\n\n    ....\n}</code></pre><p><br /></p><h3 id=\"7154ff4a\">检查HTTPS得分</h3><p>访问 <a href=\"https://www.ssllabs.com/ssltest/\" target=\"_blank\">https://www.ssllabs.com/ssltest/</a> 提交自己域名，进行评分</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://www.oschina.net/news/96200/chrome-will-stop-tag-https-site-secure\" target=\"_blank\">Chrome 将不再标记 HTTPS 页面为安全站点</a></li><li><a href=\"https://letsencrypt.org/stats/\" target=\"_blank\"><span style=\"color: #000000;\">Let's Encrypt Stats</span></a></li><li><a href=\"https://letsencrypt.org/about/\" target=\"_blank\"><span style=\"color: #000000;\">About Let's Encrypt</span></a></li><li><a href=\"https://mozilla.github.io/server-side-tls/ssl-config-generator/\" target=\"_blank\">Mozilla SSL Configuration Generator</a></li><li><a href=\"https://www.cnblogs.com/sslwork/p/6193256.html\" target=\"_blank\">DV型、OV型、EV型证书的主要区别</a></li><li><a href=\"https://github.com/Neilpang/acme.sh/blob/master/dnsapi/README.md\" target=\"_blank\">Neilpang/acme.sh#Wiki#安装说明</a></li><li><a href=\"https://github.com/Neilpang/acme.sh/wiki/How-to-install\" target=\"_blank\">Neilpang/acme.sh#Wiki#How to Install</a></li><li><a href=\"https://github.com/Neilpang/acme.sh/wiki/How-to-install\" target=\"_blank\">Neilpang/acme.sh#Wiki#How to use DNS API</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "body_lake": "<!doctype lake><p><span>date: 2019-02-18 12:43:00</span></p><p>tags: [ssl,https,http2,lets-encrypt,acme,acme-sh]</p><p>categories: 运维<cursor /></p><p>---</p><p><br /></p><blockquote><p><br /></p><p>这是坚持技术写作计划（含翻译）的第四篇，定个小目标999，每周最少2篇。</p></blockquote><p><br /></p><blockquote><p>过去几年中，我们一直主张站点采用 HTTPS，以提升其安全性。去年的时候，我们还通过将更大的 HTTP 页面标记为‘不安全’以帮助用户。</p><p>不过从 2018 年 7 月开始，随着 Chrome 68 的发布，浏览器会将所有 HTTP 网站标记为‘不安全’。</p><p>引用自 <a href=\"https://support.google.com/chrome/a/answer/7679408\" target=\"_blank\">chrome 68 发布说明</a></p></blockquote><p><br /></p><p>得益于Google等大厂的消灭HTTP运动和<a href=\"https://letsencrypt.org\" target=\"_blank\">Let's Encrypt</a> 非盈利组织的努力，越来越多的站点开始迁移到HTTPS，下图是<a href=\"https://letsencrypt.org/stats/\" target=\"_blank\">Let's Encrypt的统计数据</a></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1550317966768-d4587466-a6d0-4868-b9ca-4e65bc45b101.png%22%2C%22originWidth%22%3A940%2C%22originHeight%22%3A450%2C%22name%22%3A%22image.png%22%2C%22size%22%3A41971%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A940%2C%22height%22%3A450%7D\"></card></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"d8c35fbf\">什么是Let's Encrypt</h2><p><br /></p><p>部署 HTTPS 网站的时候需要证书，证书由 CA 机构签发，大部分传统 CA 机构签发证书是需要收费的，这不利于推动 HTTPS 协议的使用。</p><p><br /></p><p>Let's Encrypt是一个国外的非盈利的CA证书机构，旨在以自动化流程消除手动创建和安装证书的复杂流程，并推广使万维网服务器的加密连接无所不在，为安全网站提供免费的SSL/TLS证书。</p><p><br /></p><p>由Linux基金会托管，许多国内外互联网大厂都对其进行赞助，目前主流浏览器均已信任Let's Encrypt发放的证书。</p><p><br /></p><p>注意，Let's Encrypt颁发的都是DV证书，不提供OV,EV证书。</p><p><br /></p><p>本文主要讲解 如何使用Let's Encrypt颁发通配符证书。</p><p><br /></p><h2 id=\"cbaf77e0\">通配符证书</h2><p><br /></p><p>通配符SSL证书旨在保护主域名以及旗下不限数量的子域，即用户可通过单个通配符SSL证书可保护任意数量的子域。如果用户拥有多个子域名平台，可通过通配符SSL证书保护这些子域名。</p><p><br /></p><p>但是目前Let's Encrypt 只支持同级子域名通配符。例如 <code>*.demo.com</code> 只支持 <code>xx.demo.com</code> 这种的，而不支持 <code>xx.xx.demo.com</code> ，而要支持二级通配符，需要再次颁发二级通配符证书 类似 <code>*.demo.demo.com</code> ，注意，这种的二级通配符，要求，一级域名是固定的，意即，不支持 <code>*.*.demo.com</code> </p><p><br /></p><h2 id=\"1c74e63c\">使用 acme.sh 简化证书颁发操作</h2><p><br /></p><p>官方建议使用<a href=\"https://certbot.eff.org/\" target=\"_blank\">Certbot</a> ，但是很长一段时期Certbot不支持通配符<span>（现在已经支持）</span>，而且对于证书自动续期支持的也不好。并且操作时也挺麻烦。</p><p><br /></p><p><br /></p><h3 id=\"0c48da8f\">安装 acme.sh</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20curl%20https%3A%2F%2Fget.acme.sh%20%7C%20sh%5Cn%23%20%E6%88%96%E8%80%85%5Cn%24%20wget%20-O%20-%20%20https%3A%2F%2Fget.acme.sh%20%7C%20sh%5Cn%23%20%E6%88%96%E8%80%85%5Cn%24%20git%20clone%20https%3A%2F%2Fgithub.com%2FNeilpang%2Facme.sh.git%5Cn%24%20.%2Facme.sh%2Facme.sh%20--install%22%7D\"></card><p><br /></p><h3 id=\"4c752c1e\">DNS Api 颁发通配符证书</h3><p>acme.sh 功能很强大，此处只介绍使用Dns Api 自动化颁发通配符证书. 目前支持包含阿里和DNSPod在内的60家dns服务商（参见 <a href=\"https://github.com/Neilpang/acme.sh#currently-acmesh-supports\" target=\"_blank\">Currently acme.sh supports</a>）</p><p><br /></p><p>如果你的DNS服务商不提供API或者acme.sh暂未支持，或者处于安全方面的考虑，不想将重要的域名的API权限暴露给 acme.sh，可以申请一个测试域名，然后在重要域名上设置CNAME（参见 <a href=\"https://github.com/Neilpang/acme.sh/wiki/DNS-alias-mode\" target=\"_blank\">DNS alias mode</a>）</p><p><br /></p><p>假设您的域名在DNSPod托管，登陆DNSPod后台，依次打开 用户中心-&gt;安全设置-&gt; API Token-&gt;查看-&gt;创建API Token-&gt; 输入任意token名称-&gt;确定-&gt; 保存ID和Token值（图中打码部分）</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1550463481824-01a645a7-5a95-4320-80ab-753ff7664bff.png%22%2C%22originWidth%22%3A1241%2C%22originHeight%22%3A558%2C%22name%22%3A%22image.png%22%2C%22size%22%3A59891%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A1241%2C%22height%22%3A558%7D\"></card></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20export%20DP_Id%3D%5C%22%E4%BD%A0%E7%9A%84ID%5C%22%5Cn%24%20export%20DP_Key%3D%5C%22%E4%BD%A0%E7%9A%84Token%5C%22%5Cn%24%20acme.sh%20--issue%20--dns%20dns_dp%20-d%20example.com%20-d%20*.example.com%5Cn%23%20%E5%A6%82%E6%9E%9C%20%E4%BD%BF%E7%94%A8%E4%BA%86DNS%E5%88%AB%E5%90%8D%EF%BC%8C%E8%BF%98%E9%9C%80%E8%A6%81%E5%A2%9E%E5%8A%A0%20--challenge-alias%20%E5%88%AB%E5%90%8D%E5%9F%9F%E5%90%8D%20%E5%8F%82%E6%95%B0%5Cn%23%20%E4%B8%BA%E4%BA%86%E9%98%B2%E6%AD%A2dns%E4%B8%8D%E7%94%9F%E6%95%88%EF%BC%8C%E8%84%9A%E6%9C%AC%E4%BC%9A%E6%9A%82%E5%81%9C2%E5%88%86%E9%92%9F%EF%BC%8C%E5%B9%B6%E5%80%92%E8%AE%A1%E6%97%B6(Sleep%20120%20seconds%20for%20the%20txt%20records%20to%20take%20effect)%2C%E7%AD%89%E5%BE%85%E5%8D%B3%E5%8F%AF%5Cn%23%20%E5%A6%82%E6%9E%9C%E6%88%90%E5%8A%9F%E4%BC%9A%E5%87%BA%E7%8E%B0%20Cert%20success.%20%E5%AD%97%E6%A0%B7%5Cn%23%20%E4%B8%8D%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E7%94%A8~%2F.acme.sh%20%E4%B8%8B%E7%9A%84%E8%AF%81%E4%B9%A6%EF%BC%8C%E5%8F%82%E8%80%83%20https%3A%2F%2Fgithub.com%2FNeilpang%2Facme.sh%2Fwiki%2F%E8%AF%B4%E6%98%8E%233-copy%E5%AE%89%E8%A3%85-%E8%AF%81%E4%B9%A6%5Cn%23%20%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%20--installcert%20%E5%A4%8D%E5%88%B6%E5%88%B0%E6%8C%87%E5%AE%9A%E7%9B%AE%E5%BD%95%5Cn%24%20acme.sh%20--installcert%20%20%5C%5C%5Cn%5Ct%5Ct%5Ct%5Ct-d%20%20example.com%20-d%20*.example.com%20%5C%5C%5Cn%20%20%20%20%20%20%20%20--key-file%20%2Fetc%2Fletsencrypt%2Flive%2Fexample.com%2Fprivkey.pem%20%5C%5C%5Cn%20%20%20%20%20%20%20%20--fullchain-file%20%2Fetc%2Fletsencrypt%2Flive%2Fexample.com%2Ffullchain.pem%20%5C%5C%5Cn%20%20%20%20%20%20%20%20--reloadcmd%20%20%5C%22service%20nginx%20reload%5C%22%22%7D\"></card><p><br /></p><h3 id=\"03e61821\">优化HTTPS配置</h3><p>本文以 <a href=\"https://mozilla.github.io/server-side-tls/ssl-config-generator/\" target=\"_blank\">Mozilla SSL Configuration Generator</a> 生成的nginx为例，同样也可以生成Apache和IIS</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22nginx%22%2C%22code%22%3A%22server%20%7B%5Cn%20%20%20%20listen%2080%20default_server%3B%5Cn%20%20%20%20listen%20%5B%3A%3A%5D%3A80%20default_server%3B%5Cn%5Cn%20%20%20%20%23%20Redirect%20all%20HTTP%20requests%20to%20HTTPS%20with%20a%20301%20Moved%20Permanently%20response.%5Cn%20%20%20%20return%20301%20https%3A%2F%2F%24host%24request_uri%3B%5Cn%7D%5Cn%5Cnserver%20%7B%5Cn%20%20%20%20listen%20443%20ssl%20http2%3B%5Cn%20%20%20%20listen%20%5B%3A%3A%5D%3A443%20ssl%20http2%3B%5Cn%5Cn%20%20%20%20%23%20certs%20sent%20to%20the%20client%20in%20SERVER%20HELLO%20are%20concatenated%20in%20ssl_certificate%5Cn%20%20%20%20ssl_certificate%20%2Fetc%2Fletsencrypt%2Flive%2Fexample.com%2Ffullchain.pem%3B%5Cn%20%20%20%20ssl_certificate_key%20%2Fetc%2Fletsencrypt%2Flive%2Fexample.com%2Fprivkey.pem%3B%5Cn%20%20%20%20ssl_session_timeout%201d%3B%5Cn%20%20%20%20ssl_session_cache%20shared%3ASSL%3A50m%3B%5Cn%20%20%20%20ssl_session_tickets%20off%3B%5Cn%5Cn%20%20%20%20%23%20Diffie-Hellman%20parameter%20for%20DHE%20ciphersuites%2C%20recommended%202048%20bits%5Cn%20%20%20%20%23%20openssl%20dhparam%20-out%20%2Fetc%2Fletsencrypt%2Flive%2Fexample.com%2F%202048%5Cn%20%20%20%20ssl_dhparam%20%2Fetc%2Fletsencrypt%2Flive%2Fexample.com%2Fdhparam.pem%3B%5Cn%5Cn%20%20%20%20%23%20intermediate%20configuration.%20tweak%20to%20your%20needs.%5Cn%20%20%20%20ssl_protocols%20TLSv1%20TLSv1.1%20TLSv1.2%3B%5Cn%20%20%20%20ssl_ciphers%20'ECDHE-ECDSA-CHACHA20-POLY1305%3AECDHE-RSA-CHACHA20-POLY1305%3AECDHE-ECDSA-AES128-GCM-SHA256%3AECDHE-RSA-AES128-GCM-SHA256%3AECDHE-ECDSA-AES256-GCM-SHA384%3AECDHE-RSA-AES256-GCM-SHA384%3ADHE-RSA-AES128-GCM-SHA256%3ADHE-RSA-AES256-GCM-SHA384%3AECDHE-ECDSA-AES128-SHA256%3AECDHE-RSA-AES128-SHA256%3AECDHE-ECDSA-AES128-SHA%3AECDHE-RSA-AES256-SHA384%3AECDHE-RSA-AES128-SHA%3AECDHE-ECDSA-AES256-SHA384%3AECDHE-ECDSA-AES256-SHA%3AECDHE-RSA-AES256-SHA%3ADHE-RSA-AES128-SHA256%3ADHE-RSA-AES128-SHA%3ADHE-RSA-AES256-SHA256%3ADHE-RSA-AES256-SHA%3AECDHE-ECDSA-DES-CBC3-SHA%3AECDHE-RSA-DES-CBC3-SHA%3AEDH-RSA-DES-CBC3-SHA%3AAES128-GCM-SHA256%3AAES256-GCM-SHA384%3AAES128-SHA256%3AAES256-SHA256%3AAES128-SHA%3AAES256-SHA%3ADES-CBC3-SHA%3A!DSS'%3B%5Cn%20%20%20%20ssl_prefer_server_ciphers%20on%3B%5Cn%5Cn%20%20%20%20%23%20HSTS%20(ngx_http_headers_module%20is%20required)%20(15768000%20seconds%20%3D%206%20months)%5Cn%20%20%20%20add_header%20Strict-Transport-Security%20max-age%3D15768000%3B%5Cn%5Cn%20%20%20%20%23%20OCSP%20Stapling%20---%5Cn%20%20%20%20%23%20fetch%20OCSP%20records%20from%20URL%20in%20ssl_certificate%20and%20cache%20them%5Cn%20%20%20%20ssl_stapling%20on%3B%5Cn%20%20%20%20ssl_stapling_verify%20on%3B%5Cn%5Cn%20%20%20%20%23%23%20verify%20chain%20of%20trust%20of%20OCSP%20response%20using%20Root%20CA%20and%20Intermediate%20certs%5Cn%20%20%20%20%23%20ssl_trusted_certificate%20%2Fpath%2Fto%2Froot_CA_cert_plus_intermediates%3B%5Cn%5Cn%20%20%20%20resolver%20%3CIP%20DNS%20resolver%3E%3B%5Cn%5Cn%20%20%20%20....%5Cn%7D%22%7D\"></card><p><br /></p><h3 id=\"7154ff4a\">检查HTTPS得分</h3><p>访问 <a href=\"https://www.ssllabs.com/ssltest/\" target=\"_blank\">https://www.ssllabs.com/ssltest/</a> 提交自己域名，进行评分</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://www.oschina.net/news/96200/chrome-will-stop-tag-https-site-secure\" target=\"_blank\">Chrome 将不再标记 HTTPS 页面为安全站点</a></li><li><a href=\"https://letsencrypt.org/stats/\" target=\"_blank\"><span style=\"color: #000000;\">Let's Encrypt Stats</span></a></li><li><a href=\"https://letsencrypt.org/about/\" target=\"_blank\"><span style=\"color: #000000;\">About Let's Encrypt</span></a></li><li><a href=\"https://mozilla.github.io/server-side-tls/ssl-config-generator/\" target=\"_blank\">Mozilla SSL Configuration Generator</a></li><li><a href=\"https://www.cnblogs.com/sslwork/p/6193256.html\" target=\"_blank\">DV型、OV型、EV型证书的主要区别</a></li><li><a href=\"https://github.com/Neilpang/acme.sh/blob/master/dnsapi/README.md\" target=\"_blank\">Neilpang/acme.sh#Wiki#安装说明</a></li><li><a href=\"https://github.com/Neilpang/acme.sh/wiki/How-to-install\" target=\"_blank\">Neilpang/acme.sh#Wiki#How to Install</a></li><li><a href=\"https://github.com/Neilpang/acme.sh/wiki/How-to-install\" target=\"_blank\">Neilpang/acme.sh#Wiki#How to use DNS API</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-02-19T06:20:57.000Z",
    "deleted_at": null,
    "created_at": "2019-02-16T10:54:27.000Z",
    "updated_at": "2019-02-19T06:20:57.000Z",
    "published_at": "2019-02-19T06:20:57.000Z",
    "first_published_at": "2019-02-18T04:43:27.000Z",
    "word_count": 1538,
    "cover": "https://cdn.nlark.com/yuque/0/2019/png/226273/1550465007520-e26fc44f-5cbb-4ce3-b70d-2d0099f32279.png",
    "description": "date: 2019-02-18 12:43:00tags: [ssl,https,http2,lets-encrypt,acme,acme-sh]categories: 运维---这是坚持技术写作计划（含翻译）的第四篇，定个小目标999，每周最少2篇。过去几年中，我们一直主张站点采用 HTT...",
    "custom_description": "这是坚持技术写作计划（含翻译）的第四篇，定个小目标999，每周最少2篇。过去几年中，我们一直主张站点采用 HTTPS，以提升其安全性。去年的时候，我们还通过将更大的 HTTP 页面标记为‘不安全’以帮助用户。不过从 2018 年 7 月开始，随着 Chrome 68 的发布，浏览器会将所有 H...",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1249839,
    "slug": "rancher2-k8s-multi-cluster-app",
    "title": "【译】单应用跨多k8s集群的部署与管理",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "tags: [k8s , rancher , rancher2 , 集群 , 运维 , 翻译 ]<br />date: 2019-02-15 14:08:00<br />categories: k8s<br />---\n\n\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1550147773034-220bf087-600f-47dd-9d24-65ac37f79d65.png#align=left&display=inline&height=371&name=image.png&originHeight=371&originWidth=746&size=38965&width=746)\n\n\n<a name=\"e4568847\"></a>\n## 引言\n近日(春节前后)，Rancher labs宣布，其旗下的开源企业级Kubernetes管理平台Rancher，发布了Rancher 2.2 Preview 2（预览版2），它包含了许多在k8s 集群操作的强大特性\n\n可以通过访问[发布页面](https://rancher.com/products/rancher/2.2/)和[发布说明](https://github.com/rancher/rancher/releases/tag/v2.2.0-alpha6)来了解所发布的新功能\n\n本文将介绍其中一个特性：多集群应用(multi-cluster applications)，下面将为您介绍，该特性将如何显著减少您的工作量，并提高多集群操作的可靠性。\n\n<a name=\"86385379\"></a>\n## 概览\n\n假如您有用过k8s，并且有两个及以上的集群运维经验，那么您遇到下面的情况\n\n- 当跨多个可用区部署(AZs)时，应用需要具有更高的容错性\n- 在具有数百个集群的边缘计算场景中，同一个应用需要在多个集群上运行。\n\n在高可靠性的情况下，运维操作人员通常通过将节点从多个可用区纳入到一个集群内来降低单个可用区不可用风险。但是这个方案的问题在于，虽然抵抗了可用区故障，但是防不住集群本身故障，集群故障的可能性高于可用区故障，而且一旦集群出故障后，可能会影响集群中在运行的程序。\n\n另外一种方法是，每个可用区中运行单独的集群，病症每个集群上运行应用程序的副本。相当于每个可用区都有一套k8s集群，但是每个集群手动维护应用程序成本高，又易错。\n\n边缘计算场景跟多可用区集群相同的问题：应用程序手动维护，既耗时，又容易出错，即使运维团队给力，创建了复杂的脚本来部署和升级，但是又多了一个故障点，而且这些脚本也需要升级和维护，并且要求负责的运维人员不仅要编写流程（升级发版流程），还要在脚本失败时能够转成人肉运维。\n\n从[Rancher 2.2 Preview 2](https://github.com/rancher/rancher/releases/tag/v2.2.0-alpha6) 开始，Rancher支持在任意数量的k8s集群中同时部署和升级同一应用程序的副本。\n\n同时也扩展了基于Helm软件包管理器的应用商店(Application Catalogs)，在此之前，应用商店仅适用于单个集群,我们在全局级别增加了一个附加功能，权限允许的情况下，可以将应用程序部署到Rancher管理的任意集群上。\n\n有关Rancher 2.2 Preview2的功能的完整演示，请加入 [Rancher2月份的在线MeetUp](https://rancher.com/events/2019/meetup-multi-cluster-apps/) ，届时将提供新功能的演示，并在Q&A环节进行答疑。\n\n下面将演示，在Rancher中如何便捷的管理多集群应用。\n\n<a name=\"0fbb09d3\"></a>\n## 功能快速入门\n\n- 登陆Rancher后，将看到纳管的所有集群的列表，同时在菜单栏新增了一个 `多集群应用(Multi-Cluster Apps)` 的按钮\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1550210384952-8bbbfcb0-e3d7-42f2-b55f-456323970275.png#align=left&display=inline&height=265&originHeight=568&originWidth=1600&size=0&width=746)\n\n- 单击 `多集群应用` 按钮后，将看到两个按钮，`管理Catalogs` 和 `启动` 。`管理Catalogs` 将跳到 `应用商店(Catalogs)` 的管理页，您开源在其中启用主要Helm repo或者添加其他第三方Helm repo。\n- 单击 `启动` 按钮以启动新应用程序。\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1550210400369-8dd2c530-bffc-484b-8081-310fb69f06b7.png#align=left&display=inline&height=319&originHeight=685&originWidth=1600&size=0&width=746)\n\n- 从显示的可以部署的应用中，选择Grafana(用于演示)。\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1550210419223-c687bf46-93e1-428d-82bc-754a460cdc4b.png#align=left&display=inline&height=298&originHeight=640&originWidth=1600&size=0&width=746)\n\n- 按照要求配置详细信息，使用表单或者直接用提供YAML进行配置，注意，在此处的设置将应用到部署此应用程序的集群中。\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1550210430368-f065ea71-821c-4458-bd14-7457822473bb.png#align=left&display=inline&height=520&originHeight=1115&originWidth=1600&size=0&width=746)\n\n- 在 `配置选项` 下，在 `Target（目标）` 下拉框中选择目标集群的指定项目。\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1550210444391-421fb9d3-d2a5-45ed-89e7-5e4accca5793.png#align=left&display=inline&height=392&originHeight=840&originWidth=1600&size=0&width=746)\n\n- 选择升级策略。此处为了演示，我们将选择 `滚动更新` 并提供每批1个，间隔20秒。此设置可以确保以后升级应用时，一次只更新一个集群，并且每个集群升级操作的间隔为20秒。\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1550210458439-2fd561f6-6ea1-4fdb-bb69-83edb7de2f01.png#align=left&display=inline&height=370&originHeight=794&originWidth=1600&size=0&width=746)\n\n- 如果要调整集群间的差异，可以在 `Answer Overrides` 部分进行设置。\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1550210474235-75246694-14bc-410b-badc-f4bbd81c492d.png#align=left&display=inline&height=270&originHeight=579&originWidth=1600&size=0&width=746)\n\n- 一切准备妥当，点击底部 `启动` ,然后将跳到结果页，显示刚刚已安装的多集群应用(此处是演示用的Grafana)。每个应用将显示当前状态和目标集群以及项目列表。\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1550210490267-a0d665be-27f1-45f6-9988-a2e81c93a3c8.png#align=left&display=inline&height=140&originHeight=301&originWidth=1600&size=0&width=746)\n\n- 当应用程序可以升级时，应用状态将显示 `Upgrade Available` \n- 要启动升级，请单击应用上的菜单按钮（三个点的菜单），然后选择升级\n\n![](https://cdn.nlark.com/yuque/0/2019/png/226273/1550210508332-34b12a85-bcb1-4706-9795-2f839c8aa88d.png#align=left&display=inline&height=287&originHeight=615&originWidth=1600&size=0&width=746)\n\n- 验证是否已选择 `滚动更新` 选项\n- 更改一些设置，然后点击底部的 `升级` 按钮\n\n打开目标集群的 `工作负载` 选项卡，将看到其中一个状态更改为 `更新` ,此集群中的应用将被更新，然后Rancher将暂停20s（刚刚设置的间隔时间）,然后继续更新下一个集群的应用。\n\n<a name=\"25f9c7fa\"></a>\n## 总结\n多集群应用程序将减少运维团队的工作量，并使跨集群快速可靠的部署和升级应用成为可能。<br />要在实验室或者开发环境中测试这些功能，请安装[最新的Alpha版本](https://rancher.com/docs/rancher/v2.x/en/installation/server-tags/#helm-chart-repositories)，如果有任何反馈意见，请在[Github上提交Issues 或](https://github.com/rancher/rancher/issues)者加入[论坛](https://forums.rancher.com/) 或[Slack](https://slack.rancher.io/) 。\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [rancher 博客原文--Introducing Multi-Cluster Applications in Rancher 2.2 Preview 2](https://rancher.com/blog/2019/introducing-multi-cluster-apps/)\n- [Rancher中国微信公众号--革命性新特性 | 单一应用跨多Kubernetes集群的部署与管理](https://mp.weixin.qq.com/s/yfE22D04D98r8e7BAlD3qg)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。\n\n长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。\n\n",
    "body_draft": "",
    "body_html": "<p><span>tags: [k8s , rancher , rancher2 , 集群 , 运维 , 翻译 ]</span></p><p><span>date: 2019-02-15 14:08:00</span></p><p>categories: k8s</p><p><span>---</span></p><p><br /></p><p><br /></p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1550147773034-220bf087-600f-47dd-9d24-65ac37f79d65.png#align=left&amp;display=inline&amp;height=371&amp;name=image.png&amp;originHeight=371&amp;originWidth=746&amp;size=38965&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p><br /></p><p><br /></p><h2 id=\"e4568847\">引言</h2><p>近日(春节前后)，Rancher labs宣布，其旗下的开源企业级Kubernetes管理平台Rancher，发布了Rancher 2.2 Preview 2（预览版2），它包含了许多在k8s 集群操作的强大特性</p><p><br /></p><p>可以通过访问<a href=\"https://rancher.com/products/rancher/2.2/\" target=\"_blank\">发布页面</a>和<a href=\"https://github.com/rancher/rancher/releases/tag/v2.2.0-alpha6\" target=\"_blank\">发布说明</a>来了解所发布的新功能</p><p><br /></p><p>本文将介绍其中一个特性：多集群应用(multi-cluster applications)，下面将为您介绍，该特性将如何显著减少您的工作量，并提高多集群操作的可靠性。</p><p><br /></p><h2 id=\"86385379\">概览</h2><p><br /></p><p>假如您有用过k8s，并且有两个及以上的集群运维经验，那么您遇到下面的情况</p><p><br /></p><ul><li>当跨多个可用区部署(AZs)时，应用需要具有更高的容错性</li><li>在具有数百个集群的边缘计算场景中，同一个应用需要在多个集群上运行。</li></ul><p><br /></p><p>在高可靠性的情况下，运维操作人员通常通过将节点从多个可用区纳入到一个集群内来降低单个可用区不可用风险。但是这个方案的问题在于，虽然抵抗了可用区故障，但是防不住集群本身故障，集群故障的可能性高于可用区故障，而且一旦集群出故障后，可能会影响集群中在运行的程序。</p><p><br /></p><p>另外一种方法是，每个可用区中运行单独的集群，病症每个集群上运行应用程序的副本。相当于每个可用区都有一套k8s集群，但是每个集群手动维护应用程序成本高，又易错。</p><p><br /></p><p>边缘计算场景跟多可用区集群相同的问题：应用程序手动维护，既耗时，又容易出错，即使运维团队给力，创建了复杂的脚本来部署和升级，但是又多了一个故障点，而且这些脚本也需要升级和维护，并且要求负责的运维人员不仅要编写流程（升级发版流程），还要在脚本失败时能够转成人肉运维。</p><p><br /></p><p>从<a href=\"https://github.com/rancher/rancher/releases/tag/v2.2.0-alpha6\" target=\"_blank\">Rancher 2.2 Preview 2</a> 开始，Rancher支持在任意数量的k8s集群中同时部署和升级同一应用程序的副本。</p><p><br /></p><p>同时也扩展了<span>基于Helm软件包管理器的</span>应用商店(Application Catalogs)，在此之前，应用商店仅适用于单个集群,我们在全局级别增加了一个附加功能，权限允许的情况下，可以将应用程序部署到Rancher管理的任意集群上。</p><p><br /></p><p>有关Rancher 2.2 Preview2的功能的完整演示，请加入 <a href=\"https://rancher.com/events/2019/meetup-multi-cluster-apps/\" target=\"_blank\">Rancher2月份的在线MeetUp</a> ，届时将提供新功能的演示，并在Q&amp;A环节进行答疑。</p><p><br /></p><p>下面将演示，在Rancher中如何便捷的管理多集群应用。</p><p><br /></p><h2 id=\"0fbb09d3\">功能快速入门</h2><p><br /></p><ul><li>登陆Rancher后，将看到纳管的所有集群的列表，同时在菜单栏新增了一个 <code>多集群应用(Multi-Cluster Apps)</code> 的按钮</li></ul><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1550210384952-8bbbfcb0-e3d7-42f2-b55f-456323970275.png#align=left&amp;display=inline&amp;height=265&amp;originHeight=568&amp;originWidth=1600&amp;size=0&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><ul><li>单击 <code>多集群应用</code> 按钮后，将看到两个按钮，<code>管理Catalogs</code> 和 <code>启动</code> 。<code>管理Catalogs</code> 将跳到 <code>应用商店(Catalogs)</code> 的管理页，您开源在其中启用主要Helm repo或者添加其他第三方Helm repo。</li><li>单击 <code>启动</code> 按钮以启动新应用程序。</li></ul><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1550210400369-8dd2c530-bffc-484b-8081-310fb69f06b7.png#align=left&amp;display=inline&amp;height=319&amp;originHeight=685&amp;originWidth=1600&amp;size=0&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><ul><li>从显示的可以部署的应用中，选择Grafana(用于演示)。</li></ul><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1550210419223-c687bf46-93e1-428d-82bc-754a460cdc4b.png#align=left&amp;display=inline&amp;height=298&amp;originHeight=640&amp;originWidth=1600&amp;size=0&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><ul><li>按照要求配置详细信息，使用表单或者直接用提供YAML进行配置，注意，在此处的设置将应用到部署此应用程序的集群中。</li></ul><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1550210430368-f065ea71-821c-4458-bd14-7457822473bb.png#align=left&amp;display=inline&amp;height=520&amp;originHeight=1115&amp;originWidth=1600&amp;size=0&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><ul><li>在 <code>配置选项</code> 下，在 <code>Target（目标）</code> 下拉框中选择目标集群的指定项目。</li></ul><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1550210444391-421fb9d3-d2a5-45ed-89e7-5e4accca5793.png#align=left&amp;display=inline&amp;height=392&amp;originHeight=840&amp;originWidth=1600&amp;size=0&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><ul><li>选择升级策略。此处为了演示，我们将选择 <code>滚动更新</code> 并提供每批1个，间隔20秒。此设置可以确保以后升级应用时，一次只更新一个集群，并且每个集群升级操作的间隔为20秒。</li></ul><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1550210458439-2fd561f6-6ea1-4fdb-bb69-83edb7de2f01.png#align=left&amp;display=inline&amp;height=370&amp;originHeight=794&amp;originWidth=1600&amp;size=0&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><ul><li>如果要调整集群间的差异，可以在 <code>Answer Overrides</code> 部分进行设置。</li></ul><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1550210474235-75246694-14bc-410b-badc-f4bbd81c492d.png#align=left&amp;display=inline&amp;height=270&amp;originHeight=579&amp;originWidth=1600&amp;size=0&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><ul><li>一切准备妥当，点击底部 <code>启动</code> ,然后将跳到结果页，显示刚刚已安装的多集群应用(此处是演示用的Grafana)。每个应用将显示当前状态和目标集群以及项目列表。</li></ul><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1550210490267-a0d665be-27f1-45f6-9988-a2e81c93a3c8.png#align=left&amp;display=inline&amp;height=140&amp;originHeight=301&amp;originWidth=1600&amp;size=0&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><ul><li>当应用程序可以升级时，应用状态将显示 <code>Upgrade Available</code> </li><li>要启动升级，请单击应用上的菜单按钮（三个点的菜单），然后选择升级</li></ul><p><br /></p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1550210508332-34b12a85-bcb1-4706-9795-2f839c8aa88d.png#align=left&amp;display=inline&amp;height=287&amp;originHeight=615&amp;originWidth=1600&amp;size=0&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><ul><li>验证是否已选择 <code>滚动更新</code> 选项</li><li>更改一些设置，然后点击底部的 <code>升级</code> <span>按钮</span></li></ul><p><span><br /></span></p><p><span>打开目标集群的 </span><code><span>工作负载</span></code> 选项卡，将看到其中一个状态更改为 <code>更新</code> ,此集群中的应用将被更新，然后Rancher将暂停20s（刚刚设置的间隔时间）,然后继续更新下一个集群的应用。</p><p><br /></p><h2 id=\"25f9c7fa\">总结</h2><p>多集群应用程序将减少运维团队的工作量，并使跨集群快速可靠的部署和升级应用成为可能。</p><p>要在实验室或者开发环境中测试这些功能，请安装<a href=\"https://rancher.com/docs/rancher/v2.x/en/installation/server-tags/#helm-chart-repositories\" target=\"_blank\">最新的Alpha版本</a>，如果有任何反馈意见，请在<a href=\"https://github.com/rancher/rancher/issues\" target=\"_blank\">Github上提交Issues 或</a>者加入<a href=\"https://forums.rancher.com/\" target=\"_blank\">论坛</a> 或<a href=\"https://slack.rancher.io/\" target=\"_blank\">Slack</a> 。</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://rancher.com/blog/2019/introducing-multi-cluster-apps/\" target=\"_blank\">rancher 博客原文--Introducing Multi-Cluster Applications in Rancher 2.2 Preview 2</a></li><li><a href=\"https://mp.weixin.qq.com/s/yfE22D04D98r8e7BAlD3qg\" target=\"_blank\">Rancher中国微信公众号--革命性新特性 | 单一应用跨多Kubernetes集群的部署与管理</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "body_lake": "<!doctype lake><p><span>tags: [k8s , rancher , rancher2 , 集群 , 运维 , 翻译 ]<cursor /></span></p><p><span>date: 2019-02-15 14:08:00</span></p><p>categories: k8s</p><p><span>---</span></p><p><br /></p><p><br /></p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1550147773034-220bf087-600f-47dd-9d24-65ac37f79d65.png%22%2C%22originWidth%22%3A746%2C%22originHeight%22%3A371%2C%22name%22%3A%22image.png%22%2C%22size%22%3A38965%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A746%2C%22height%22%3A371%7D\"></card></p><p><br /></p><p><br /></p><h2 id=\"e4568847\">引言</h2><p>近日(春节前后)，Rancher labs宣布，其旗下的开源企业级Kubernetes管理平台Rancher，发布了Rancher 2.2 Preview 2（预览版2），它包含了许多在k8s 集群操作的强大特性</p><p><br /></p><p>可以通过访问<a href=\"https://rancher.com/products/rancher/2.2/\" target=\"_blank\">发布页面</a>和<a href=\"https://github.com/rancher/rancher/releases/tag/v2.2.0-alpha6\" target=\"_blank\">发布说明</a>来了解所发布的新功能</p><p><br /></p><p>本文将介绍其中一个特性：多集群应用(multi-cluster applications)，下面将为您介绍，该特性将如何显著减少您的工作量，并提高多集群操作的可靠性。</p><p><br /></p><h2 id=\"86385379\">概览</h2><p><br /></p><p>假如您有用过k8s，并且有两个及以上的集群运维经验，那么您遇到下面的情况</p><p><br /></p><ul><li>当跨多个可用区部署(AZs)时，应用需要具有更高的容错性</li><li>在具有数百个集群的边缘计算场景中，同一个应用需要在多个集群上运行。</li></ul><p><br /></p><p>在高可靠性的情况下，运维操作人员通常通过将节点从多个可用区纳入到一个集群内来降低单个可用区不可用风险。但是这个方案的问题在于，虽然抵抗了可用区故障，但是防不住集群本身故障，集群故障的可能性高于可用区故障，而且一旦集群出故障后，可能会影响集群中在运行的程序。</p><p><br /></p><p>另外一种方法是，每个可用区中运行单独的集群，病症每个集群上运行应用程序的副本。相当于每个可用区都有一套k8s集群，但是每个集群手动维护应用程序成本高，又易错。</p><p><br /></p><p>边缘计算场景跟多可用区集群相同的问题：应用程序手动维护，既耗时，又容易出错，即使运维团队给力，创建了复杂的脚本来部署和升级，但是又多了一个故障点，而且这些脚本也需要升级和维护，并且要求负责的运维人员不仅要编写流程（升级发版流程），还要在脚本失败时能够转成人肉运维。</p><p><br /></p><p>从<a href=\"https://github.com/rancher/rancher/releases/tag/v2.2.0-alpha6\" target=\"_blank\">Rancher 2.2 Preview 2</a> 开始，Rancher支持在任意数量的k8s集群中同时部署和升级同一应用程序的副本。</p><p><br /></p><p>同时也扩展了<span>基于Helm软件包管理器的</span>应用商店(Application Catalogs)，在此之前，应用商店仅适用于单个集群,我们在全局级别增加了一个附加功能，权限允许的情况下，可以将应用程序部署到Rancher管理的任意集群上。</p><p><br /></p><p>有关Rancher 2.2 Preview2的功能的完整演示，请加入 <a href=\"https://rancher.com/events/2019/meetup-multi-cluster-apps/\" target=\"_blank\">Rancher2月份的在线MeetUp</a> ，届时将提供新功能的演示，并在Q&amp;A环节进行答疑。</p><p><br /></p><p>下面将演示，在Rancher中如何便捷的管理多集群应用。</p><p><br /></p><h2 id=\"0fbb09d3\">功能快速入门</h2><p><br /></p><ul><li>登陆Rancher后，将看到纳管的所有集群的列表，同时在菜单栏新增了一个 <code>多集群应用(Multi-Cluster Apps)</code> 的按钮</li></ul><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1550210384952-8bbbfcb0-e3d7-42f2-b55f-456323970275.png%22%2C%22originWidth%22%3A1600%2C%22originHeight%22%3A568%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A746%2C%22height%22%3A265%7D\"></card></p><ul><li>单击 <code>多集群应用</code> 按钮后，将看到两个按钮，<code>管理Catalogs</code> 和 <code>启动</code> 。<code>管理Catalogs</code> 将跳到 <code>应用商店(Catalogs)</code> 的管理页，您开源在其中启用主要Helm repo或者添加其他第三方Helm repo。</li><li>单击 <code>启动</code> 按钮以启动新应用程序。</li></ul><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1550210400369-8dd2c530-bffc-484b-8081-310fb69f06b7.png%22%2C%22originWidth%22%3A1600%2C%22originHeight%22%3A685%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A746%2C%22height%22%3A319%7D\"></card></p><ul><li>从显示的可以部署的应用中，选择Grafana(用于演示)。</li></ul><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1550210419223-c687bf46-93e1-428d-82bc-754a460cdc4b.png%22%2C%22originWidth%22%3A1600%2C%22originHeight%22%3A640%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A746%2C%22height%22%3A298%7D\"></card></p><ul><li>按照要求配置详细信息，使用表单或者直接用提供YAML进行配置，注意，在此处的设置将应用到部署此应用程序的集群中。</li></ul><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1550210430368-f065ea71-821c-4458-bd14-7457822473bb.png%22%2C%22originWidth%22%3A1600%2C%22originHeight%22%3A1115%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A746%2C%22height%22%3A520%7D\"></card></p><ul><li>在 <code>配置选项</code> 下，在 <code>Target（目标）</code> 下拉框中选择目标集群的指定项目。</li></ul><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1550210444391-421fb9d3-d2a5-45ed-89e7-5e4accca5793.png%22%2C%22originWidth%22%3A1600%2C%22originHeight%22%3A840%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A746%2C%22height%22%3A392%7D\"></card></p><ul><li>选择升级策略。此处为了演示，我们将选择 <code>滚动更新</code> 并提供每批1个，间隔20秒。此设置可以确保以后升级应用时，一次只更新一个集群，并且每个集群升级操作的间隔为20秒。</li></ul><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1550210458439-2fd561f6-6ea1-4fdb-bb69-83edb7de2f01.png%22%2C%22originWidth%22%3A1600%2C%22originHeight%22%3A794%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A746%2C%22height%22%3A370%7D\"></card></p><ul><li>如果要调整集群间的差异，可以在 <code>Answer Overrides</code> 部分进行设置。</li></ul><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1550210474235-75246694-14bc-410b-badc-f4bbd81c492d.png%22%2C%22originWidth%22%3A1600%2C%22originHeight%22%3A579%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A746%2C%22height%22%3A270%7D\"></card></p><ul><li>一切准备妥当，点击底部 <code>启动</code> ,然后将跳到结果页，显示刚刚已安装的多集群应用(此处是演示用的Grafana)。每个应用将显示当前状态和目标集群以及项目列表。</li></ul><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1550210490267-a0d665be-27f1-45f6-9988-a2e81c93a3c8.png%22%2C%22originWidth%22%3A1600%2C%22originHeight%22%3A301%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A746%2C%22height%22%3A140%7D\"></card></p><ul><li>当应用程序可以升级时，应用状态将显示 <code>Upgrade Available</code> </li><li>要启动升级，请单击应用上的菜单按钮（三个点的菜单），然后选择升级</li></ul><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1550210508332-34b12a85-bcb1-4706-9795-2f839c8aa88d.png%22%2C%22originWidth%22%3A1600%2C%22originHeight%22%3A615%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A746%2C%22height%22%3A287%7D\"></card></p><ul><li>验证是否已选择 <code>滚动更新</code> 选项</li><li>更改一些设置，然后点击底部的 <code>升级</code> <span>按钮</span></li></ul><p><span><br /></span></p><p><span>打开目标集群的 </span><code><span>工作负载</span></code> 选项卡，将看到其中一个状态更改为 <code>更新</code> ,此集群中的应用将被更新，然后Rancher将暂停20s（刚刚设置的间隔时间）,然后继续更新下一个集群的应用。</p><p><br /></p><h2 id=\"25f9c7fa\">总结</h2><p>多集群应用程序将减少运维团队的工作量，并使跨集群快速可靠的部署和升级应用成为可能。</p><p>要在实验室或者开发环境中测试这些功能，请安装<a href=\"https://rancher.com/docs/rancher/v2.x/en/installation/server-tags/#helm-chart-repositories\" target=\"_blank\">最新的Alpha版本</a>，如果有任何反馈意见，请在<a href=\"https://github.com/rancher/rancher/issues\" target=\"_blank\">Github上提交Issues 或</a>者加入<a href=\"https://forums.rancher.com/\" target=\"_blank\">论坛</a> 或<a href=\"https://slack.rancher.io/\" target=\"_blank\">Slack</a> 。</p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://rancher.com/blog/2019/introducing-multi-cluster-apps/\" target=\"_blank\">rancher 博客原文--Introducing Multi-Cluster Applications in Rancher 2.2 Preview 2</a></li><li><a href=\"https://mp.weixin.qq.com/s/yfE22D04D98r8e7BAlD3qg\" target=\"_blank\">Rancher中国微信公众号--革命性新特性 | 单一应用跨多Kubernetes集群的部署与管理</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师，前端工程师。</p><p><br /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-02-19T06:35:09.000Z",
    "deleted_at": null,
    "created_at": "2019-02-14T12:31:34.000Z",
    "updated_at": "2019-06-19T06:31:30.000Z",
    "published_at": "2019-02-19T06:35:09.000Z",
    "first_published_at": "2019-02-15T06:08:58.000Z",
    "word_count": 1443,
    "cover": "https://cdn.nlark.com/yuque/0/2019/png/226273/1550210938329-b053e595-f247-4f9d-a7b7-fdd35ada6c80.png",
    "description": "tags: [k8s , rancher , rancher2 , 集群 , 运维 , 翻译 ]date: 2019-02-15 14:08:00categories: k8s---引言近日(春节前后)，Rancher labs宣布，其旗下的开源企业级Kubernetes管理平台Rancher...",
    "custom_description": "引言近日(春节前后)，Rancher labs宣布，其旗下的开源企业级Kubernetes管理平台Rancher，发布了Rancher 2.2 Preview 2（预览版2），它包含了许多在k8s 集群操作的强大特性可以通过访问发布页面和发布说明来了解所发布的新功能本文将介绍其中一个特性：多集...",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1245476,
    "slug": "linux-ncdu-no-space",
    "title": "Linux磁盘空间占满问题快速排雷",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-02-14 14:36:00<br />tags: [linux,运维,devops,排雷,磁盘,ncdu]<br />categories: 运维<br />---\n\n情人节一大早就接到报警，一台测试服务器磁盘满了，这很程序员。\n\n<!-- more -->\n\n<a name=\"8cb08486\"></a>\n## 磁盘排雷三连\n反手一个 `df` 先看是否是真满了(参考 [df(1) - Linux man page](https://linux.die.net/man/1/df) )<br />需要注意，如果磁盘空间未满，但是仍然报 `No space left on device` ,需要执行 `df -i`  排查inode\n\n```bash\n$ df -h\n文件系统        容量  已用  可用 已用% 挂载点\nudev             47G     0   47G    0% /dev\ntmpfs           9.4G  620M  8.8G    7% /run\n/dev/sda2       1.1T  1.1T    0G    100% /\ntmpfs            47G  8.7M   47G    1% /dev/shm\ntmpfs           5.0M  4.0K  5.0M    1% /run/lock\ntmpfs            47G     0   47G    0% /sys/fs/cgroup\n/dev/sda1       511M  1.2M  510M    1% /boot/efi\ntmpfs           9.4G  108K  9.4G    1% /run/user/1000\ntmpfs           9.4G   40K  9.4G    1% /run/user/0\n\n$ df -i\n文件系统          Inode 已用(I)  可用(I) 已用(I)% 挂载点\nudev           12277823     525 12277298       1% /dev\ntmpfs          12285255    1368 12283887       1% /run\n/dev/sda2      71041024 2250210 68790814       4% /\ntmpfs          12285255      83 12285172       1% /dev/shm\ntmpfs          12285255       5 12285250       1% /run/lock\ntmpfs          12285255      17 12285238       1% /sys/fs/cgroup\n/dev/sda1             0       0        0        - /boot/efi\ntmpfs          12285255      44 12285211       1% /run/user/1000\ntmpfs          12285255      15 12285240       1% /run/user/0\n\n```\n\n通过 `df -h` 只能看出磁盘满了，但是看不出每个文件夹的大小，所以需要使用 `du -ahd1` ,如果文件不是很多，很大，一般速度还能接受，但是今天执行相当慢，所以 `Ctrl+C`  中止。<br />此处简单说明一下 `-ahd1` 的意思(可以通过 `man du` 或者 `du --help` 自行查阅帮助文档,参考 [du(1) - Linux man page](https://linux.die.net/man/1/du))\n\n```\n$ du --help\n用法：du [选项]... [文件]...\n　或：du [选项]... --files0-from=F\n\n  -a, --all             write counts for all files, not just directories (所有文件，不止目录)\n\n  -h, --human-readable  print sizes in human readable format (e.g., 1K 234M 2G) (易读单位，会损失精度)\n\n  -d, --max-depth=N     print the total for a directory (or file, with --all) (只扫描一层目录)\n                          only if it is N or fewer levels below the command\n                          line argument;  --max-depth=0 is the same as\n                          --summarize\n\n```\n\n```bash\n$ du -ahd1 /\n1.6M\t/dev\n4.0K\t/mnt\n4.0K\t/lib64\n455M\t/boot\n0\t/sys\n0\t/vmlinuz.old\n689G\t/data\n370M\t/tmp\n15M\t/etc\n8.0K\t/media\ndu: 无法访问'/proc/24390/task/24390/fd/4': 没有那个文件或目录\ndu: 无法访问'/proc/24390/task/24390/fdinfo/4': 没有那个文件或目录\ndu: 无法访问'/proc/24390/fd/3': 没有那个文件或目录\ndu: 无法访问'/proc/24390/fdinfo/3': 没有那个文件或目录\n^C\n# 慢的要死，Ctrl+C 终止\n```\n\n如果被删除的文件 `df -h` 快满了，而 `du -ahd1` 却很小，往往是文件被删除，而文件句柄没释放导致的,祭出 `lsof | grep deleted ` ，解决办法，要么kill掉pid，释放句柄(治本)，要么就 ` > /path/to/deleted/file` 把内容覆盖掉(治标)。当然还有别的玩法，比如，不小心 `rm -rf /` 了，先别着急跑路，万一 `lsof | grep deleted` 还存在的，都还有救，约等于windows下的回收站的作用。 参考[ lsof(8) - Linux man page](https://linux.die.net/man/8/lsof)\n\n```bash\n$ lsof -i | grep deleted\n# 当然也不快\n```\n\n<a name=\"ncdu\"></a>\n## [ncdu](https://dev.yorhel.nl/ncdu)\n\n针对 `du -d1` 大文件场景下的龟速表现，有人开发了ncdu,以ubuntu为例\n\n```\n# 从APT安装(版本较旧目前是v1.11)\n$ sudo apt-get update\n$ sudo apt-get install -y ncdu\n\n# 从源码编译安装(此处是1.14版本)\n$ sudo apt-get install -y libncurses5-dev # 如果不安装会报 configure: error: required header file not found\n$ wget https://dev.yorhel.nl/download/ncdu-1.14.tar.gz\n$ tar zxf ncdu-1.14.tar.gz\n$ cd ncdu-1.14\n$ ./configure --prefix=/usr\n$ make && make install\n```\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1550123205304-ae5bfcbc-8c91-4f91-ab15-843953ed6701.png#align=left&display=inline&height=397&name=image.png&originHeight=397&originWidth=779&size=37521&width=779)\n\n参考官方文档 [Ncdu Manual](https://dev.yorhel.nl/ncdu/man)\n\n<a name=\"e5d9f3cf\"></a>\n## 额外\n\n通过man查询命令时，手册中会带有数字(例如 `du(1)` , `lsof(8)` )，这代表的是手册的不同部分，可以通过 `man man` 或者 [Linux man pages](https://linux.die.net/man/) 来查看\n\n```\nMANUAL SECTIONS\n    The standard sections of the manual include:\n\n    1      User Commands\n    2      System Calls\n    3      C Library Functions\n    4      Devices and Special Files\n    5      File Formats and Conventions\n    6      Games et. al.\n    7      Miscellanea\n    8      System Administration tools and Daemons\n\n    Distributions customize the manual section to their specifics,\n    which often include additional sections.\n```\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [What do the numbers in a man page mean?](https://unix.stackexchange.com/a/3587)\n- [df(1) - Linux man page](https://linux.die.net/man/1/df)\n- [du(1) - Linux man page](https://linux.die.net/man/1/du)\n- [lsof(8) - Linux man page](https://linux.die.net/man/8/lsof)\n- [Ncdu Manual](https://dev.yorhel.nl/ncdu/man)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。\n\n长期招聘，Java程序员，大数据工程师，运维工程师。\n\n",
    "body_draft": "",
    "body_html": "<p><span>date: 2019-02-14 14:36:00</span></p><p>tags: [linux,运维,devops,排雷,磁盘,ncdu]</p><p>categories: 运维</p><p>---</p><p><br /></p><p>情人节一大早就接到报警，一台测试服务器磁盘满了，这很程序员。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"8cb08486\">磁盘排雷三连</h2><p>反手一个 <code>df</code> 先看是否是真满了(参考 <a href=\"https://linux.die.net/man/1/df\" target=\"_blank\">df(1) - Linux man page</a> )</p><p>需要注意，如果磁盘空间未满，但是仍然报 <code>No space left on device</code> ,需要执行 <code>df -i</code>  排查inode</p><p><br /></p><pre data-lang=\"bash\"><code>$ df -h\n文件系统        容量  已用  可用 已用% 挂载点\nudev             47G     0   47G    0% /dev\ntmpfs           9.4G  620M  8.8G    7% /run\n/dev/sda2       1.1T  1.1T    0G    100% /\ntmpfs            47G  8.7M   47G    1% /dev/shm\ntmpfs           5.0M  4.0K  5.0M    1% /run/lock\ntmpfs            47G     0   47G    0% /sys/fs/cgroup\n/dev/sda1       511M  1.2M  510M    1% /boot/efi\ntmpfs           9.4G  108K  9.4G    1% /run/user/1000\ntmpfs           9.4G   40K  9.4G    1% /run/user/0\n\n$ df -i\n文件系统          Inode 已用(I)  可用(I) 已用(I)% 挂载点\nudev           12277823     525 12277298       1% /dev\ntmpfs          12285255    1368 12283887       1% /run\n/dev/sda2      71041024 2250210 68790814       4% /\ntmpfs          12285255      83 12285172       1% /dev/shm\ntmpfs          12285255       5 12285250       1% /run/lock\ntmpfs          12285255      17 12285238       1% /sys/fs/cgroup\n/dev/sda1             0       0        0        - /boot/efi\ntmpfs          12285255      44 12285211       1% /run/user/1000\ntmpfs          12285255      15 12285240       1% /run/user/0\n</code></pre><p><br /></p><p>通过 <code>df -h</code> 只能看出磁盘满了，但是看不出每个文件夹的大小，所以需要使用 <code>du -ahd1</code> ,如果文件不是很多，很大，一般速度还能接受，但是今天执行相当慢，所以 <code>Ctrl+C</code>  中止。</p><p>此处简单说明一下 <code>-ahd1</code> 的意思(可以通过 <code>man du</code> 或者 <code>du --help</code> 自行查阅帮助文档,参考 <a href=\"https://linux.die.net/man/1/du\" target=\"_blank\">du(1) - Linux man page</a>)</p><p><br /></p><pre><code>$ du --help\n用法：du [选项]... [文件]...\n　或：du [选项]... --files0-from=F\n\n  -a, --all             write counts for all files, not just directories (所有文件，不止目录)\n\n  -h, --human-readable  print sizes in human readable format (e.g., 1K 234M 2G) (易读单位，会损失精度)\n\n  -d, --max-depth=N     print the total for a directory (or file, with --all) (只扫描一层目录)\n                          only if it is N or fewer levels below the command\n                          line argument;  --max-depth=0 is the same as\n                          --summarize\n</code></pre><p><br /></p><pre data-lang=\"bash\"><code>$ du -ahd1 /\n1.6M\t/dev\n4.0K\t/mnt\n4.0K\t/lib64\n455M\t/boot\n0\t/sys\n0\t/vmlinuz.old\n689G\t/data\n370M\t/tmp\n15M\t/etc\n8.0K\t/media\ndu: 无法访问'/proc/24390/task/24390/fd/4': 没有那个文件或目录\ndu: 无法访问'/proc/24390/task/24390/fdinfo/4': 没有那个文件或目录\ndu: 无法访问'/proc/24390/fd/3': 没有那个文件或目录\ndu: 无法访问'/proc/24390/fdinfo/3': 没有那个文件或目录\n^C\n# 慢的要死，Ctrl+C 终止</code></pre><p><br /></p><p>如果被删除的文件 <code>df -h</code> 快满了，而 <code>du -ahd1</code> 却很小，往往是文件被删除，而文件句柄没释放导致的,祭出 <code>lsof | grep deleted </code> ，解决办法，要么kill掉pid，释放句柄(治本)，要么就 <code> &gt; /path/to/deleted/file</code> 把内容覆盖掉(治标)。当然还有别的玩法，比如，不小心 <code>rm -rf /</code> 了，先别着急跑路，万一 <code>lsof | grep deleted</code> 还存在的，都还有救，约等于windows下的回收站的作用。 参考<a href=\"https://linux.die.net/man/8/lsof\" target=\"_blank\"> lsof(8) - Linux man page</a></p><p><br /></p><pre data-lang=\"bash\"><code>$ lsof -i | grep deleted\n# 当然也不快</code></pre><p><br /></p><h2 id=\"ncdu\"><a href=\"https://dev.yorhel.nl/ncdu\" target=\"_blank\">ncdu</a></h2><p><br /></p><p>针对 <code>du -d1</code> 大文件场景下的龟速表现，有人开发了ncdu,以ubuntu为例</p><p><br /></p><pre><code># 从APT安装(版本较旧目前是v1.11)\n$ sudo apt-get update\n$ sudo apt-get install -y ncdu\n\n# 从源码编译安装(此处是1.14版本)\n$ sudo apt-get install -y libncurses5-dev # 如果不安装会报 configure: error: required header file not found\n$ wget https://dev.yorhel.nl/download/ncdu-1.14.tar.gz\n$ tar zxf ncdu-1.14.tar.gz\n$ cd ncdu-1.14\n$ ./configure --prefix=/usr\n$ make &amp;&amp; make install</code></pre><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1550123205304-ae5bfcbc-8c91-4f91-ab15-843953ed6701.png#align=left&amp;display=inline&amp;height=397&amp;name=image.png&amp;originHeight=397&amp;originWidth=779&amp;size=37521&amp;width=779\" style=\"max-width: 600px; width: 779px;\" /></p><p><br /></p><p>参考官方文档 <a href=\"https://dev.yorhel.nl/ncdu/man\" target=\"_blank\">Ncdu Manual</a></p><p><br /></p><h2 id=\"e5d9f3cf\">额外</h2><p><br /></p><p>通过man查询命令时，手册中会带有数字(例如 <code>du(1)</code> , <code>lsof(8)</code> )，这代表的是手册的不同部分，可以通过 <code>man man</code> 或者 <a href=\"https://linux.die.net/man/\" target=\"_blank\">Linux man pages</a> 来查看</p><p><br /></p><pre><code>MANUAL SECTIONS\n    The standard sections of the manual include:\n\n    1      User Commands\n    2      System Calls\n    3      C Library Functions\n    4      Devices and Special Files\n    5      File Formats and Conventions\n    6      Games et. al.\n    7      Miscellanea\n    8      System Administration tools and Daemons\n\n    Distributions customize the manual section to their specifics,\n    which often include additional sections.</code></pre><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://unix.stackexchange.com/a/3587\" target=\"_blank\">What do the numbers in a man page mean?</a></li><li><a href=\"https://linux.die.net/man/1/df\" target=\"_blank\">df(1) - Linux man page</a></li><li><a href=\"https://linux.die.net/man/1/du\" target=\"_blank\">du(1) - Linux man page</a></li><li><a href=\"https://linux.die.net/man/8/lsof\" target=\"_blank\">lsof(8) - Linux man page</a></li><li><a href=\"https://dev.yorhel.nl/ncdu/man\" target=\"_blank\">Ncdu Manual</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师。</p><p><br /></p>",
    "body_lake": "<!doctype lake><p><span><cursor />date: 2019-02-14 14:36:00</span></p><p>tags: [linux,运维,devops,排雷,磁盘,ncdu]</p><p>categories: 运维</p><p>---</p><p><br /></p><p>情人节一大早就接到报警，一台测试服务器磁盘满了，这很程序员。</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"8cb08486\">磁盘排雷三连</h2><p>反手一个 <code>df</code> 先看是否是真满了(参考 <a href=\"https://linux.die.net/man/1/df\" target=\"_blank\">df(1) - Linux man page</a> )</p><p>需要注意，如果磁盘空间未满，但是仍然报 <code>No space left on device</code> ,需要执行 <code>df -i</code>  排查inode</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20df%20-h%5Cn%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20%20%20%20%20%20%20%20%E5%AE%B9%E9%87%8F%20%20%E5%B7%B2%E7%94%A8%20%20%E5%8F%AF%E7%94%A8%20%E5%B7%B2%E7%94%A8%25%20%E6%8C%82%E8%BD%BD%E7%82%B9%5Cnudev%20%20%20%20%20%20%20%20%20%20%20%20%2047G%20%20%20%20%200%20%20%2047G%20%20%20%200%25%20%2Fdev%5Cntmpfs%20%20%20%20%20%20%20%20%20%20%209.4G%20%20620M%20%208.8G%20%20%20%207%25%20%2Frun%5Cn%2Fdev%2Fsda2%20%20%20%20%20%20%201.1T%20%201.1T%20%20%20%200G%20%20%20%20100%25%20%2F%5Cntmpfs%20%20%20%20%20%20%20%20%20%20%20%2047G%20%208.7M%20%20%2047G%20%20%20%201%25%20%2Fdev%2Fshm%5Cntmpfs%20%20%20%20%20%20%20%20%20%20%205.0M%20%204.0K%20%205.0M%20%20%20%201%25%20%2Frun%2Flock%5Cntmpfs%20%20%20%20%20%20%20%20%20%20%20%2047G%20%20%20%20%200%20%20%2047G%20%20%20%200%25%20%2Fsys%2Ffs%2Fcgroup%5Cn%2Fdev%2Fsda1%20%20%20%20%20%20%20511M%20%201.2M%20%20510M%20%20%20%201%25%20%2Fboot%2Fefi%5Cntmpfs%20%20%20%20%20%20%20%20%20%20%209.4G%20%20108K%20%209.4G%20%20%20%201%25%20%2Frun%2Fuser%2F1000%5Cntmpfs%20%20%20%20%20%20%20%20%20%20%209.4G%20%20%2040K%20%209.4G%20%20%20%201%25%20%2Frun%2Fuser%2F0%5Cn%5Cn%24%20df%20-i%5Cn%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20%20%20%20%20%20%20%20%20%20Inode%20%E5%B7%B2%E7%94%A8(I)%20%20%E5%8F%AF%E7%94%A8(I)%20%E5%B7%B2%E7%94%A8(I)%25%20%E6%8C%82%E8%BD%BD%E7%82%B9%5Cnudev%20%20%20%20%20%20%20%20%20%20%2012277823%20%20%20%20%20525%2012277298%20%20%20%20%20%20%201%25%20%2Fdev%5Cntmpfs%20%20%20%20%20%20%20%20%20%2012285255%20%20%20%201368%2012283887%20%20%20%20%20%20%201%25%20%2Frun%5Cn%2Fdev%2Fsda2%20%20%20%20%20%2071041024%202250210%2068790814%20%20%20%20%20%20%204%25%20%2F%5Cntmpfs%20%20%20%20%20%20%20%20%20%2012285255%20%20%20%20%20%2083%2012285172%20%20%20%20%20%20%201%25%20%2Fdev%2Fshm%5Cntmpfs%20%20%20%20%20%20%20%20%20%2012285255%20%20%20%20%20%20%205%2012285250%20%20%20%20%20%20%201%25%20%2Frun%2Flock%5Cntmpfs%20%20%20%20%20%20%20%20%20%2012285255%20%20%20%20%20%2017%2012285238%20%20%20%20%20%20%201%25%20%2Fsys%2Ffs%2Fcgroup%5Cn%2Fdev%2Fsda1%20%20%20%20%20%20%20%20%20%20%20%20%200%20%20%20%20%20%20%200%20%20%20%20%20%20%20%200%20%20%20%20%20%20%20%20-%20%2Fboot%2Fefi%5Cntmpfs%20%20%20%20%20%20%20%20%20%2012285255%20%20%20%20%20%2044%2012285211%20%20%20%20%20%20%201%25%20%2Frun%2Fuser%2F1000%5Cntmpfs%20%20%20%20%20%20%20%20%20%2012285255%20%20%20%20%20%2015%2012285240%20%20%20%20%20%20%201%25%20%2Frun%2Fuser%2F0%5Cn%22%7D\"></card><p><br /></p><p>通过 <code>df -h</code> 只能看出磁盘满了，但是看不出每个文件夹的大小，所以需要使用 <code>du -ahd1</code> ,如果文件不是很多，很大，一般速度还能接受，但是今天执行相当慢，所以 <code>Ctrl+C</code>  中止。</p><p>此处简单说明一下 <code>-ahd1</code> 的意思(可以通过 <code>man du</code> 或者 <code>du --help</code> 自行查阅帮助文档,参考 <a href=\"https://linux.die.net/man/1/du\" target=\"_blank\">du(1) - Linux man page</a>)</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22plain%22%2C%22code%22%3A%22%24%20du%20--help%5Cn%E7%94%A8%E6%B3%95%EF%BC%9Adu%20%5B%E9%80%89%E9%A1%B9%5D...%20%5B%E6%96%87%E4%BB%B6%5D...%5Cn%E3%80%80%E6%88%96%EF%BC%9Adu%20%5B%E9%80%89%E9%A1%B9%5D...%20--files0-from%3DF%5Cn%5Cn%20%20-a%2C%20--all%20%20%20%20%20%20%20%20%20%20%20%20%20write%20counts%20for%20all%20files%2C%20not%20just%20directories%20(%E6%89%80%E6%9C%89%E6%96%87%E4%BB%B6%EF%BC%8C%E4%B8%8D%E6%AD%A2%E7%9B%AE%E5%BD%95)%5Cn%5Cn%20%20-h%2C%20--human-readable%20%20print%20sizes%20in%20human%20readable%20format%20(e.g.%2C%201K%20234M%202G)%20(%E6%98%93%E8%AF%BB%E5%8D%95%E4%BD%8D%EF%BC%8C%E4%BC%9A%E6%8D%9F%E5%A4%B1%E7%B2%BE%E5%BA%A6)%5Cn%5Cn%20%20-d%2C%20--max-depth%3DN%20%20%20%20%20print%20the%20total%20for%20a%20directory%20(or%20file%2C%20with%20--all)%20(%E5%8F%AA%E6%89%AB%E6%8F%8F%E4%B8%80%E5%B1%82%E7%9B%AE%E5%BD%95)%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20only%20if%20it%20is%20N%20or%20fewer%20levels%20below%20the%20command%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%20argument%3B%20%20--max-depth%3D0%20is%20the%20same%20as%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20--summarize%5Cn%22%7D\"></card><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20du%20-ahd1%20%2F%5Cn1.6M%5Ct%2Fdev%5Cn4.0K%5Ct%2Fmnt%5Cn4.0K%5Ct%2Flib64%5Cn455M%5Ct%2Fboot%5Cn0%5Ct%2Fsys%5Cn0%5Ct%2Fvmlinuz.old%5Cn689G%5Ct%2Fdata%5Cn370M%5Ct%2Ftmp%5Cn15M%5Ct%2Fetc%5Cn8.0K%5Ct%2Fmedia%5Cndu%3A%20%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE'%2Fproc%2F24390%2Ftask%2F24390%2Ffd%2F4'%3A%20%E6%B2%A1%E6%9C%89%E9%82%A3%E4%B8%AA%E6%96%87%E4%BB%B6%E6%88%96%E7%9B%AE%E5%BD%95%5Cndu%3A%20%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE'%2Fproc%2F24390%2Ftask%2F24390%2Ffdinfo%2F4'%3A%20%E6%B2%A1%E6%9C%89%E9%82%A3%E4%B8%AA%E6%96%87%E4%BB%B6%E6%88%96%E7%9B%AE%E5%BD%95%5Cndu%3A%20%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE'%2Fproc%2F24390%2Ffd%2F3'%3A%20%E6%B2%A1%E6%9C%89%E9%82%A3%E4%B8%AA%E6%96%87%E4%BB%B6%E6%88%96%E7%9B%AE%E5%BD%95%5Cndu%3A%20%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE'%2Fproc%2F24390%2Ffdinfo%2F3'%3A%20%E6%B2%A1%E6%9C%89%E9%82%A3%E4%B8%AA%E6%96%87%E4%BB%B6%E6%88%96%E7%9B%AE%E5%BD%95%5Cn%5EC%5Cn%23%20%E6%85%A2%E7%9A%84%E8%A6%81%E6%AD%BB%EF%BC%8CCtrl%2BC%20%E7%BB%88%E6%AD%A2%22%7D\"></card><p><br /></p><p>如果被删除的文件 <code>df -h</code> 快满了，而 <code>du -ahd1</code> 却很小，往往是文件被删除，而文件句柄没释放导致的,祭出 <code>lsof | grep deleted </code> ，解决办法，要么kill掉pid，释放句柄(治本)，要么就 <code> &gt; /path/to/deleted/file</code> 把内容覆盖掉(治标)。当然还有别的玩法，比如，不小心 <code>rm -rf /</code> 了，先别着急跑路，万一 <code>lsof | grep deleted</code> 还存在的，都还有救，约等于windows下的回收站的作用。 参考<a href=\"https://linux.die.net/man/8/lsof\" target=\"_blank\"> lsof(8) - Linux man page</a></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20lsof%20-i%20%7C%20grep%20deleted%5Cn%23%20%E5%BD%93%E7%84%B6%E4%B9%9F%E4%B8%8D%E5%BF%AB%22%7D\"></card><p><br /></p><h2 id=\"ncdu\"><a href=\"https://dev.yorhel.nl/ncdu\" target=\"_blank\">ncdu</a></h2><p><br /></p><p>针对 <code>du -d1</code> 大文件场景下的龟速表现，有人开发了ncdu,以ubuntu为例</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22plain%22%2C%22code%22%3A%22%23%20%E4%BB%8EAPT%E5%AE%89%E8%A3%85(%E7%89%88%E6%9C%AC%E8%BE%83%E6%97%A7%E7%9B%AE%E5%89%8D%E6%98%AFv1.11)%5Cn%24%20sudo%20apt-get%20update%5Cn%24%20sudo%20apt-get%20install%20-y%20ncdu%5Cn%5Cn%23%20%E4%BB%8E%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85(%E6%AD%A4%E5%A4%84%E6%98%AF1.14%E7%89%88%E6%9C%AC)%5Cn%24%20sudo%20apt-get%20install%20-y%20libncurses5-dev%20%23%20%E5%A6%82%E6%9E%9C%E4%B8%8D%E5%AE%89%E8%A3%85%E4%BC%9A%E6%8A%A5%20configure%3A%20error%3A%20required%20header%20file%20not%20found%5Cn%24%20wget%20https%3A%2F%2Fdev.yorhel.nl%2Fdownload%2Fncdu-1.14.tar.gz%5Cn%24%20tar%20zxf%20ncdu-1.14.tar.gz%5Cn%24%20cd%20ncdu-1.14%5Cn%24%20.%2Fconfigure%20--prefix%3D%2Fusr%5Cn%24%20make%20%26%26%20make%20install%22%7D\"></card><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1550123205304-ae5bfcbc-8c91-4f91-ab15-843953ed6701.png%22%2C%22originWidth%22%3A779%2C%22originHeight%22%3A397%2C%22name%22%3A%22image.png%22%2C%22size%22%3A37521%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A779%2C%22height%22%3A397%7D\"></card></p><p><br /></p><p>参考官方文档 <a href=\"https://dev.yorhel.nl/ncdu/man\" target=\"_blank\">Ncdu Manual</a></p><p><br /></p><h2 id=\"e5d9f3cf\">额外</h2><p><br /></p><p>通过man查询命令时，手册中会带有数字(例如 <code>du(1)</code> , <code>lsof(8)</code> )，这代表的是手册的不同部分，可以通过 <code>man man</code> 或者 <a href=\"https://linux.die.net/man/\" target=\"_blank\">Linux man pages</a> 来查看</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22plain%22%2C%22code%22%3A%22MANUAL%20SECTIONS%5Cn%20%20%20%20The%20standard%20sections%20of%20the%20manual%20include%3A%5Cn%5Cn%20%20%20%201%20%20%20%20%20%20User%20Commands%5Cn%20%20%20%202%20%20%20%20%20%20System%20Calls%5Cn%20%20%20%203%20%20%20%20%20%20C%20Library%20Functions%5Cn%20%20%20%204%20%20%20%20%20%20Devices%20and%20Special%20Files%5Cn%20%20%20%205%20%20%20%20%20%20File%20Formats%20and%20Conventions%5Cn%20%20%20%206%20%20%20%20%20%20Games%20et.%20al.%5Cn%20%20%20%207%20%20%20%20%20%20Miscellanea%5Cn%20%20%20%208%20%20%20%20%20%20System%20Administration%20tools%20and%20Daemons%5Cn%5Cn%20%20%20%20Distributions%20customize%20the%20manual%20section%20to%20their%20specifics%2C%5Cn%20%20%20%20which%20often%20include%20additional%20sections.%22%7D\"></card><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://unix.stackexchange.com/a/3587\" target=\"_blank\">What do the numbers in a man page mean?</a></li><li><a href=\"https://linux.die.net/man/1/df\" target=\"_blank\">df(1) - Linux man page</a></li><li><a href=\"https://linux.die.net/man/1/du\" target=\"_blank\">du(1) - Linux man page</a></li><li><a href=\"https://linux.die.net/man/8/lsof\" target=\"_blank\">lsof(8) - Linux man page</a></li><li><a href=\"https://dev.yorhel.nl/ncdu/man\" target=\"_blank\">Ncdu Manual</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师。</p><p><br /></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-02-19T06:22:27.000Z",
    "deleted_at": null,
    "created_at": "2019-02-14T01:48:15.000Z",
    "updated_at": "2019-06-19T05:30:40.000Z",
    "published_at": "2019-02-19T06:22:27.000Z",
    "first_published_at": "2019-02-14T06:36:25.000Z",
    "word_count": 1045,
    "cover": "",
    "description": "date: 2019-02-14 14:36:00tags: [linux,运维,devops,排雷,磁盘,ncdu]categories: 运维---情人节一大早就接到报警，一台测试服务器磁盘满了，这很程序员。&lt;!-- more --&gt;磁盘排雷三连反手一个 df 先看是否是真满了...",
    "custom_description": "情人节一大早就接到报警，一台测试服务器磁盘满了，这很程序员。磁盘排雷三连反手一个 df 先看是否是真满了(参考 df(1) - Linux man page )需要注意，如果磁盘空间未满，但是仍然报 No space left on device ,需要执行 df -i  排查inode$ d...",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1242064,
    "slug": "ansible-2-7-windows",
    "title": "Ansible2.7批量管理Windows",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-02-14 00:58:00<br />tags: [ansible,运维,devops,windows,ansible-playbook]<br />categories: 运维<br />---\n\n<a name=\"59683fbc\"></a>\n## 简述\n\n<a name=\"8e1b944f\"></a>\n### 背景\nAnsible是一款轻量级的开源的自动化运维工具，支持linux和windows(只支持client，并且部分模块)，利用Ansible可以简单批量的配置系统，安装软件，或者更高级的运维任务（比如滚动升级）。\n\nAnsible之类的运维工具对运维工作进行抽象及规范，能够极大的降低运维难度。本文只是为了演示如何通过ansible 的各模块对windows进行传输文件,管理账号,执行脚本等批量自动化管理工作\n\n<!-- more -->\n\n<a name=\"12267079\"></a>\n### 实验环境\n| 类型 | 系统 | ip |\n| --- | --- | --- |\n| Server | Ubuntu Server 16.04.5 LTS X64 | 192.168.0.22 |\n| Client | Windows Server 2008 R2 SP1 | 192.168.0.23 |\n\n\n**注意：**\n\n如果是实验目的，建议用Vmware，并且在关键操作时备份快照（比如，刚装完环境，升级完PS和.Net后），这样能够及时，干净的还原现场，节省每次重装系统导致的时间浪费\n\n<a name=\"d29617ad\"></a>\n## Windows 被控端(Ansible Client)\n\nAnsible 只支持Powershell 4.0及以上(用3.0会报 [Process is terminated due to StackOverflowException.](https://github.com/ansible/ansible/issues/10825))，所以要求最低要求Win7,或者Win server 2008,详见 [Ansible Doc host requirements](https://docs.ansible.com/ansible/latest/user_guide/windows_setup.html#host-requirements)\n\n<a name=\"399fa47e\"></a>\n### [升级PowerShell 和.Net Framework](https://docs.ansible.com/ansible/latest/user_guide/windows_setup.html#id2)\n\n官方文档要求升级至ps3.0即可，但是实验发现，3.0会报错\n\n`Win+R`  -> `PowerShell`  打开PowerShell\n\n输入 `$PSVersionTable` 查看 `PSVersion` 确保大于等于4.0(PowerShell 4.0),以及 `CLRVersion` 大于等于4.0(.NET Framework 4.0) ,如果版本过低，则执行下面代码，直接复制到PowerShell 执行即可,建议使用5.1(参考 [hotfixv4.trafficmanager.net dont work](https://github.com/jborean93/ansible-windows/issues/14) 和 [安装和配置 WMF 5.1](https://docs.microsoft.com/zh-cn/powershell/wmf/5.1/install-configure))\n\n**注意：**\n\n- 注意用户名密码改成管理员的用户名密码\n- 确保能够访问外网\n- PowerShell以管理员模式打开\n- PS3不能直升PS5，需要卸载PS3或者保存 PSModulePath\n- 安装PS5需要先打最新SP补丁\n- PS5要求 .NET Framework 不低于 4.5.2\n- 安装成功后会自动重启服务器，注意别影响其他服务\n\n```bash\n$url = \"https://raw.githubusercontent.com/jborean93/ansible-windows/master/scripts/Upgrade-PowerShell.ps1\"\n$file = \"$env:temp\\Upgrade-PowerShell.ps1\"\n$username = \"管理员用户名\"\n$password = \"管理员密码\"\n\n(New-Object -TypeName System.Net.WebClient).DownloadFile($url, $file)\nSet-ExecutionPolicy -ExecutionPolicy Unrestricted -Force\n\n# PowerShell 版本，只能用 3.0, 4.0 和 5.1 \n&$file -Version 5.1 -Username $username -Password $password -Verbose\n```\n\n重启后，再次打开PS ,输入 `$PSVersionTable` 查看版本\n\n<a name=\"fadbd8e5\"></a>\n### 安装WinRM，并且配置监听\n\n```\n## 配置WinRM\n\n$url = \"https://raw.githubusercontent.com/ansible/ansible/devel/examples/scripts/ConfigureRemotingForAnsible.ps1\"\n$file = \"$env:temp\\ConfigureRemotingForAnsible.ps1\"\n(New-Object -TypeName System.Net.WebClient).DownloadFile($url, $file)\npowershell.exe -ExecutionPolicy ByPass -File $file\n```\n\n<a name=\"1994c2f8\"></a>\n## Linux主控端(Ansible Server)\n\n<a name=\"401f96f4\"></a>\n### 安装Ansible和pywinrm\n\n参考 [Installing the Control Machine](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installing-the-control-machine)\n\n```bash\n$ sudo apt-get update\n$ sudo apt-get install -y software-properties-common\n$ sudo apt-add-repository --yes --update ppa:ansible/ansible\n$ sudo apt-get install -y ansible\n$ ansible --version\nansible 2.7.7\n  config file = /etc/ansible/ansible.cfg\n  configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']\n  ansible python module location = /usr/lib/python2.7/dist-packages/ansible\n  executable location = /usr/bin/ansible\n  python version = 2.7.12 (default, Nov 12 2018, 14:36:49) [GCC 5.4.0 20160609]\n\n$ pip install \"pywinrm>=0.3.0\"\n```\n\n<a name=\"a9796771\"></a>\n### 配置Inventory\n\n参考 [Working with Inventory](https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html)\n\n默认是 Inventory `/etc/ansible/hosts` ,此处改为手动指定，Ansible的Inventory支持ini格式和yaml格式，本文采用yaml格式\n\n```bash\n$ mkdir ansible\n$ tee ansible/test_hosts.yaml <<-'EOF'\nwinserver:\n  hosts: \n    192.168.0.23:\n  vars:\n    ansible_user: Administrator\n    ansible_password: 密码\n    ansible_connection: winrm\n    ansible_port: 5986\n    ansible_winrm_server_cert_validation: ignore\n\nEOF\n```\n\n<a name=\"ea275a70\"></a>\n### 探测主机是否存活\n\n```bash\n$ ansible -i ansible/test_hosts.yaml winserver -m win_ping\n 192.168.0.23 | SUCCESS => {\n    \"changed\": false, \n    \"ping\": \"pong\"\n}\n```\n\n如果报错\n\n```bash\nTASK [Gathering Facts] *******************************************************************************************************************************************************************************************************************************************************\nfatal: [192.168.0.23]: UNREACHABLE! => {\"changed\": false, \"msg\": \"ssl: HTTPSConnectionPool(host='192.168.0.23', port=5986): Max retries exceeded with url: /wsman (Caused by SSLError(SSLError(\\\"bad handshake: Error([('SSL routines', 'tls_process_server_certificate', 'certificate verify failed')],)\\\",),))\", \"unreachable\": true}\n```\n\n降级一下 `pip install \"pywinrm==0.2.2\"`\n\n更多实验，参见参考资料中的两篇51cto中的博文\n\n<a name=\"7d486fc7\"></a>\n## 可用的Windows模块\n\n根据 [What modules are available?](https://docs.ansible.com/ansible/latest/user_guide/windows_faq.html#what-modules-are-available) 绝大部分Module都是针对Linux编写的，大部分在windows下不能正常使用，有一些专用的windows module 使用ps编写的，可用在windows下使用，详细列表参见 [Windows modules](https://docs.ansible.com/ansible/latest/modules/list_of_windows_modules.html#windows-modules)\n\n<a name=\"fae94bcd\"></a>\n## [Windows常见问题](https://docs.ansible.com/ansible/latest/user_guide/windows_faq.html#windows-frequently-asked-questions)\n\n官方文档中列举了Ansible windows常见问题，建议仔细阅读\n\n<a name=\"53001b41\"></a>\n## Ansible Playbook\n\nAnsible配合[playbook](https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html#about-playbooks)食用更佳，上述中的 `ansible` 命令是[adhoc命令模式](https://docs.ansible.com/ansible/latest/user_guide/intro_adhoc.html)，类似在bash中手动执行命令，多用于简单，并且不需要复用场景，而 `ansible-playbook` 类似 bash脚本，但是更强大，适合复杂任务编排场景。\n\n考虑后期出一个playbook的文章\n\n推荐配合[vscode](https://code.visualstudio.com/)的[ansible](https://marketplace.visualstudio.com/items?itemName=vscoss.vscode-ansible) 插件(github repo 地址 [https://github.com/VSChina/vscode-ansible](https://github.com/VSChina/vscode-ansible))\n\n效果如下所示，比idea的ansible强大很多。\n\n![](https://cdn.nlark.com/yuque/0/2019/gif/226273/1556186451366-4149328b-fa7d-439d-9761-0194293d9352.gif#align=left&display=inline&height=546&originHeight=724&originWidth=990&size=0&status=done&width=746)\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [官方文档](https://docs.ansible.com/)\n- [官方文档-windows指南](https://docs.ansible.com/ansible/latest/user_guide/windows.html)\n- [官方文档-windows指南-winrm步骤](https://docs.ansible.com/ansible/latest/user_guide/windows_setup.html#winrm-setup)\n- [Ansible批量远程管理Windows主机(部署与配置)](http://blog.51cto.com/7424593/2174156)\n- [ansible自动化管理windows系统实战](http://blog.51cto.com/dyc2005/2064746)\n- [安装和配置 WMF 5.1](https://docs.microsoft.com/zh-cn/powershell/wmf/5.1/install-configure)\n- [hotfixv4.trafficmanager.net dont work](https://github.com/jborean93/ansible-windows/issues/14)\n\n<a name=\"fb674066\"></a>\n## 招聘小广告\n\n山东济南的小伙伴欢迎投简历啊 [加入我们](https://www.shunnengnet.com/index.php/Home/Contact/join.html) , 一起搞事情。\n\n长期招聘，Java程序员，大数据工程师，运维工程师。\n",
    "body_draft": "",
    "body_html": "<p><span>date: 2019-02-14 00:58:00</span></p><p>tags: [ansible,运维,devops,windows,ansible-playbook]</p><p>categories: 运维</p><p>---</p><p><br /></p><h2 id=\"59683fbc\"><span>简述</span></h2><p><br /></p><h3 id=\"8e1b944f\">背景</h3><p>Ansible是一款轻量级的开源的自动化运维工具，支持linux和windows(只支持client，并且部分模块)，利用Ansible可以简单批量的配置系统，安装软件，或者更高级的运维任务（比如滚动升级）。</p><p><br /></p><p>Ansible之类的运维工具对运维工作进行抽象及规范，能够极大的降低运维难度。本文只是为了演示如何通过ansible 的各模块对windows进行传输文件,管理账号,执行脚本等批量自动化管理工作</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h3 id=\"12267079\">实验环境</h3><table class=\"lake-table\" style=\"width: 721px;\"><colgroup><col width=\"240\"></col><col width=\"240\"></col><col width=\"240\"></col></colgroup><tbody><tr><td>类型</td><td>系统</td><td>ip</td></tr></tbody><tbody><tr><td>Server</td><td>Ubuntu Server 16.04.5 LTS X64</td><td>192.168.0.22</td></tr><tr><td>Client</td><td>Windows Server 2008 R2 SP1</td><td>192.168.0.23</td></tr></tbody></table><p><br /></p><p><strong>注意：</strong></p><p><br /></p><p>如果是实验目的，建议用Vmware，并且在关键操作时备份快照（比如，刚装完环境，升级完PS和.Net后），这样能够及时，干净的还原现场，节省每次重装系统导致的时间浪费</p><p><br /></p><h2 id=\"d29617ad\">Windows 被控端(Ansible Client)</h2><p><br /></p><p>Ansible 只支持Powershell 4.0及以上(用3.0会报 <a href=\"https://github.com/ansible/ansible/issues/10825\" target=\"_blank\">Process is terminated due to StackOverflowException.</a>)，所以要求最低要求Win7,或者Win server 2008,详见 <a href=\"https://docs.ansible.com/ansible/latest/user_guide/windows_setup.html#host-requirements\" target=\"_blank\">Ansible Doc host requirements</a></p><p><br /></p><h3 id=\"399fa47e\"><a href=\"https://docs.ansible.com/ansible/latest/user_guide/windows_setup.html#id2\" target=\"_blank\">升级PowerShell 和.Net Framework</a></h3><p><br /></p><p>官方文档要求升级至ps3.0即可，但是实验发现，3.0会报错</p><p><br /></p><p><code>Win+R</code>  -&gt; <code>PowerShell</code>  打开PowerShell</p><p><br /></p><p>输入 <code>$PSVersionTable</code> 查看 <code>PSVersion</code> 确保大于等于4.0(PowerShell 4.0),以及 <code>CLRVersion</code> 大于等于4.0(.NET Framework 4.0) ,如果版本过低，则执行下面代码，直接复制到PowerShell 执行即可,建议使用5.1(参考 <a href=\"https://github.com/jborean93/ansible-windows/issues/14\" target=\"_blank\">hotfixv4.trafficmanager.net dont work</a> 和 <a href=\"https://docs.microsoft.com/zh-cn/powershell/wmf/5.1/install-configure\" target=\"_blank\">安装和配置 WMF 5.1</a>)</p><p><br /></p><p><strong>注意：</strong></p><p><br /></p><ul><li>注意用户名密码改成管理员的用户名密码</li><li>确保能够访问外网</li><li>PowerShell以管理员模式打开</li><li>PS3不能直升PS5，需要卸载PS3或者保存 PSModulePath</li><li>安装PS5需要先打最新SP补丁</li><li>PS5要求 .NET Framework 不低于 4.5.2</li><li>安装成功后会自动重启服务器，注意别影响其他服务</li></ul><p><br /></p><pre data-lang=\"bash\"><code>$url = &quot;https://raw.githubusercontent.com/jborean93/ansible-windows/master/scripts/Upgrade-PowerShell.ps1&quot;\n$file = &quot;$env:temp\\Upgrade-PowerShell.ps1&quot;\n$username = &quot;管理员用户名&quot;\n$password = &quot;管理员密码&quot;\n\n(New-Object -TypeName System.Net.WebClient).DownloadFile($url, $file)\nSet-ExecutionPolicy -ExecutionPolicy Unrestricted -Force\n\n# PowerShell 版本，只能用 3.0, 4.0 和 5.1 \n&amp;$file -Version 5.1 -Username $username -Password $password -Verbose</code></pre><p><br /></p><p>重启后，再次打开PS ,输入 <code>$PSVersionTable</code> 查看版本</p><p><br /></p><h3 id=\"fadbd8e5\">安装WinRM，并且配置监听</h3><p><br /></p><pre><code>## 配置WinRM\n\n$url = &quot;https://raw.githubusercontent.com/ansible/ansible/devel/examples/scripts/ConfigureRemotingForAnsible.ps1&quot;\n$file = &quot;$env:temp\\ConfigureRemotingForAnsible.ps1&quot;\n(New-Object -TypeName System.Net.WebClient).DownloadFile($url, $file)\npowershell.exe -ExecutionPolicy ByPass -File $file</code></pre><p><br /></p><h2 id=\"1994c2f8\">Linux主控端(Ansible Server)</h2><p><br /></p><h3 id=\"401f96f4\">安装Ansible和pywinrm</h3><p><br /></p><p>参考 <a href=\"https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installing-the-control-machine\" target=\"_blank\">Installing the Control Machine</a></p><p><br /></p><pre data-lang=\"bash\"><code>$ sudo apt-get update\n$ sudo apt-get install -y software-properties-common\n$ sudo apt-add-repository --yes --update ppa:ansible/ansible\n$ sudo apt-get install -y ansible\n$ ansible --version\nansible 2.7.7\n  config file = /etc/ansible/ansible.cfg\n  configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']\n  ansible python module location = /usr/lib/python2.7/dist-packages/ansible\n  executable location = /usr/bin/ansible\n  python version = 2.7.12 (default, Nov 12 2018, 14:36:49) [GCC 5.4.0 20160609]\n\n$ pip install &quot;pywinrm&gt;=0.3.0&quot;</code></pre><p><br /></p><h3 id=\"a9796771\">配置Inventory</h3><p><br /></p><p>参考 <a href=\"https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html\" target=\"_blank\">Working with Inventory</a></p><p><br /></p><p>默认是 Inventory <code>/etc/ansible/hosts</code> ,此处改为手动指定，Ansible的Inventory支持ini格式和yaml格式，本文采用yaml格式</p><p><br /></p><pre data-lang=\"bash\"><code>$ mkdir ansible\n$ tee ansible/test_hosts.yaml &lt;&lt;-'EOF'\nwinserver:\n  hosts: \n    192.168.0.23:\n  vars:\n    ansible_user: Administrator\n    ansible_password: 密码\n    ansible_connection: winrm\n    ansible_port: 5986\n    ansible_winrm_server_cert_validation: ignore\n\nEOF</code></pre><p><br /></p><h3 id=\"ea275a70\">探测主机是否存活</h3><p><br /></p><pre data-lang=\"bash\"><code>$ ansible -i ansible/test_hosts.yaml winserver -m win_ping\n 192.168.0.23 | SUCCESS =&gt; {\n    &quot;changed&quot;: false, \n    &quot;ping&quot;: &quot;pong&quot;\n}</code></pre><p><br /></p><p>如果报错</p><p><br /></p><pre data-lang=\"bash\"><code>TASK [Gathering Facts] *******************************************************************************************************************************************************************************************************************************************************\nfatal: [192.168.0.23]: UNREACHABLE! =&gt; {&quot;changed&quot;: false, &quot;msg&quot;: &quot;ssl: HTTPSConnectionPool(host='192.168.0.23', port=5986): Max retries exceeded with url: /wsman (Caused by SSLError(SSLError(\\&quot;bad handshake: Error([('SSL routines', 'tls_process_server_certificate', 'certificate verify failed')],)\\&quot;,),))&quot;, &quot;unreachable&quot;: true}</code></pre><p><br /></p><p>降级一下 <code>pip install &quot;pywinrm==0.2.2&quot;</code></p><p><br /></p><p>更多实验，参见参考资料中的两篇51cto中的博文</p><p><br /></p><h2 id=\"7d486fc7\">可用的Windows模块</h2><p><br /></p><p>根据 <a href=\"https://docs.ansible.com/ansible/latest/user_guide/windows_faq.html#what-modules-are-available\" target=\"_blank\">What modules are available?</a> 绝大部分Module都是针对Linux编写的，大部分在windows下不能正常使用，有一些专用的windows module 使用ps编写的，可用在windows下使用，详细列表参见 <a href=\"https://docs.ansible.com/ansible/latest/modules/list_of_windows_modules.html#windows-modules\" target=\"_blank\">Windows modules</a></p><p><br /></p><h2 id=\"fae94bcd\"><a href=\"https://docs.ansible.com/ansible/latest/user_guide/windows_faq.html#windows-frequently-asked-questions\" target=\"_blank\">Windows常见问题</a></h2><p><br /></p><p>官方文档中列举了Ansible windows常见问题，建议仔细阅读</p><p><br /></p><h2 id=\"53001b41\">Ansible Playbook</h2><p><br /></p><p>Ansible配合<a href=\"https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html#about-playbooks\" target=\"_blank\">playbook</a>食用更佳，上述中的 <code>ansible</code> 命令是<a href=\"https://docs.ansible.com/ansible/latest/user_guide/intro_adhoc.html\" target=\"_blank\">adhoc命令模式</a>，类似在bash中手动执行命令，多用于简单，并且不需要复用场景，而 <code>ansible-playbook</code> 类似 bash脚本，但是更强大，适合复杂任务编排场景。</p><p><br /></p><p>考虑后期出一个playbook的文章</p><p><br /></p><p>推荐配合<a href=\"https://code.visualstudio.com/\" target=\"_blank\">vscode</a>的<a href=\"https://marketplace.visualstudio.com/items?itemName=vscoss.vscode-ansible\" target=\"_blank\">ansible</a> 插件(github repo 地址 <a href=\"https://github.com/VSChina/vscode-ansible\" target=\"_blank\">https://github.com/VSChina/vscode-ansible</a>)</p><p><br /></p><p>效果如下所示，比idea的ansible强大很多。</p><p><br /></p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/gif/226273/1556186451366-4149328b-fa7d-439d-9761-0194293d9352.gif#align=left&amp;display=inline&amp;height=546&amp;originHeight=724&amp;originWidth=990&amp;size=0&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><p><br /></p><ul><li><a href=\"https://docs.ansible.com/\" target=\"_blank\">官方文档</a></li><li><a href=\"https://docs.ansible.com/ansible/latest/user_guide/windows.html\" target=\"_blank\">官方文档-windows指南</a></li><li><a href=\"https://docs.ansible.com/ansible/latest/user_guide/windows_setup.html#winrm-setup\" target=\"_blank\">官方文档-windows指南-winrm步骤</a></li><li><a href=\"http://blog.51cto.com/7424593/2174156\" target=\"_blank\">Ansible批量远程管理Windows主机(部署与配置)</a></li><li><a href=\"http://blog.51cto.com/dyc2005/2064746\" target=\"_blank\">ansible自动化管理windows系统实战</a></li><li><a href=\"https://docs.microsoft.com/zh-cn/powershell/wmf/5.1/install-configure\" target=\"_blank\">安装和配置 WMF 5.1</a></li><li><a href=\"https://github.com/jborean93/ansible-windows/issues/14\" target=\"_blank\">hotfixv4.trafficmanager.net dont work</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师。</p>",
    "body_lake": "<!doctype lake><p><span>date: 2019-02-14 00:58:00</span></p><p>tags: [ansible,运维,devops,windows,ansible-playbook]</p><p>categories: 运维</p><p>---</p><p><br /></p><h2 id=\"59683fbc\"><span>简述</span></h2><p><br /></p><h3 id=\"8e1b944f\">背景</h3><p>Ansible是一款轻量级的开源的自动化运维工具，支持linux和windows(只支持client，并且部分模块)，利用Ansible可以简单批量的配置系统，安装软件，或者更高级的运维任务（比如滚动升级）。</p><p><br /></p><p>Ansible之类的运维工具对运维工作进行抽象及规范，能够极大的降低运维难度。本文只是为了演示如何通过ansible 的各模块对windows进行传输文件,管理账号,执行脚本等批量自动化管理工作</p><p><br /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h3 id=\"12267079\">实验环境</h3><card type=\"block\" name=\"table\" value=\"data:%7B%22rows%22%3A3%2C%22cols%22%3A3%2C%22html%22%3A%22%3Ctable%20class%3D%5C%22lake-table%5C%22%20style%3D%5C%22width%3A%20721px%3B%5C%22%3E%3Ccolgroup%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22240%5C%22%20%2F%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22240%5C%22%20%2F%3E%3Ccol%20span%3D%5C%221%5C%22%20width%3D%5C%22240%5C%22%20%2F%3E%3C%2Fcolgroup%3E%3Ctbody%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3E%E7%B1%BB%E5%9E%8B%3C%2Ftd%3E%3Ctd%3E%E7%B3%BB%E7%BB%9F%3C%2Ftd%3E%3Ctd%3Eip%3C%2Ftd%3E%3C%2Ftr%3E%3C%2Ftbody%3E%3Ctbody%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3EServer%3C%2Ftd%3E%3Ctd%3EUbuntu%20Server%2016.04.5%20LTS%20X64%3C%2Ftd%3E%3Ctd%3E192.168.0.22%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3EClient%3C%2Ftd%3E%3Ctd%3EWindows%20Server%202008%20R2%20SP1%3C%2Ftd%3E%3Ctd%3E192.168.0.23%3C%2Ftd%3E%3C%2Ftr%3E%3C%2Ftbody%3E%3C%2Ftable%3E%22%2C%22id%22%3A%22f74dd100%22%7D\"></card><p><br /></p><p><strong>注意：</strong></p><p><br /></p><p>如果是实验目的，建议用Vmware，并且在关键操作时备份快照（比如，刚装完环境，升级完PS和.Net后），这样能够及时，干净的还原现场，节省每次重装系统导致的时间浪费</p><p><br /></p><h2 id=\"d29617ad\">Windows 被控端(Ansible Client)</h2><p><br /></p><p>Ansible 只支持Powershell 4.0及以上(用3.0会报 <a href=\"https://github.com/ansible/ansible/issues/10825\" target=\"_blank\">Process is terminated due to StackOverflowException.</a>)，所以要求最低要求Win7,或者Win server 2008,详见 <a href=\"https://docs.ansible.com/ansible/latest/user_guide/windows_setup.html#host-requirements\" target=\"_blank\">Ansible Doc host requirements</a></p><p><br /></p><h3 id=\"399fa47e\"><a href=\"https://docs.ansible.com/ansible/latest/user_guide/windows_setup.html#id2\" target=\"_blank\">升级PowerShell 和.Net Framework</a></h3><p><br /></p><p>官方文档要求升级至ps3.0即可，但是实验发现，3.0会报错</p><p><br /></p><p><code>Win+R</code>  -&gt; <code>PowerShell</code>  打开PowerShell</p><p><br /></p><p>输入 <code>$PSVersionTable</code> 查看 <code>PSVersion</code> 确保大于等于4.0(PowerShell 4.0),以及 <code>CLRVersion</code> 大于等于4.0(.NET Framework 4.0) ,如果版本过低，则执行下面代码，直接复制到PowerShell 执行即可,建议使用5.1(参考 <a href=\"https://github.com/jborean93/ansible-windows/issues/14\" target=\"_blank\">hotfixv4.trafficmanager.net dont work</a> 和 <a href=\"https://docs.microsoft.com/zh-cn/powershell/wmf/5.1/install-configure\" target=\"_blank\">安装和配置 WMF 5.1</a>)</p><p><br /></p><p><strong>注意：</strong></p><p><br /></p><ul><li>注意用户名密码改成管理员的用户名密码</li><li>确保能够访问外网</li><li>PowerShell以管理员模式打开</li><li>PS3不能直升PS5，需要卸载PS3或者保存 PSModulePath</li><li>安装PS5需要先打最新SP补丁</li><li>PS5要求 .NET Framework 不低于 4.5.2</li><li>安装成功后会自动重启服务器，注意别影响其他服务</li></ul><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22id%22%3A%22511512d8%22%2C%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24url%20%3D%20%5C%22https%3A%2F%2Fraw.githubusercontent.com%2Fjborean93%2Fansible-windows%2Fmaster%2Fscripts%2FUpgrade-PowerShell.ps1%5C%22%5Cn%24file%20%3D%20%5C%22%24env%3Atemp%5C%5CUpgrade-PowerShell.ps1%5C%22%5Cn%24username%20%3D%20%5C%22%E7%AE%A1%E7%90%86%E5%91%98%E7%94%A8%E6%88%B7%E5%90%8D%5C%22%5Cn%24password%20%3D%20%5C%22%E7%AE%A1%E7%90%86%E5%91%98%E5%AF%86%E7%A0%81%5C%22%5Cn%5Cn(New-Object%20-TypeName%20System.Net.WebClient).DownloadFile(%24url%2C%20%24file)%5CnSet-ExecutionPolicy%20-ExecutionPolicy%20Unrestricted%20-Force%5Cn%5Cn%23%20PowerShell%20%E7%89%88%E6%9C%AC%EF%BC%8C%E5%8F%AA%E8%83%BD%E7%94%A8%203.0%2C%204.0%20%E5%92%8C%205.1%20%5Cn%26%24file%20-Version%205.1%20-Username%20%24username%20-Password%20%24password%20-Verbose%22%7D\"></card><p><br /></p><p>重启后，再次打开PS ,输入 <code>$PSVersionTable</code> 查看版本</p><p><br /></p><h3 id=\"fadbd8e5\">安装WinRM，并且配置监听</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22id%22%3A%22c67e779f%22%2C%22code%22%3A%22%23%23%20%E9%85%8D%E7%BD%AEWinRM%5Cn%5Cn%24url%20%3D%20%5C%22https%3A%2F%2Fraw.githubusercontent.com%2Fansible%2Fansible%2Fdevel%2Fexamples%2Fscripts%2FConfigureRemotingForAnsible.ps1%5C%22%5Cn%24file%20%3D%20%5C%22%24env%3Atemp%5C%5CConfigureRemotingForAnsible.ps1%5C%22%5Cn(New-Object%20-TypeName%20System.Net.WebClient).DownloadFile(%24url%2C%20%24file)%5Cnpowershell.exe%20-ExecutionPolicy%20ByPass%20-File%20%24file%22%7D\"></card><p><br /></p><h2 id=\"1994c2f8\">Linux主控端(Ansible Server)</h2><p><br /></p><h3 id=\"401f96f4\">安装Ansible和pywinrm</h3><p><br /></p><p>参考 <a href=\"https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installing-the-control-machine\" target=\"_blank\">Installing the Control Machine</a></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22id%22%3A%221560da5c%22%2C%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20sudo%20apt-get%20update%5Cn%24%20sudo%20apt-get%20install%20-y%20software-properties-common%5Cn%24%20sudo%20apt-add-repository%20--yes%20--update%20ppa%3Aansible%2Fansible%5Cn%24%20sudo%20apt-get%20install%20-y%20ansible%5Cn%24%20ansible%20--version%5Cnansible%202.7.7%5Cn%20%20config%20file%20%3D%20%2Fetc%2Fansible%2Fansible.cfg%5Cn%20%20configured%20module%20search%20path%20%3D%20%5Bu'%2Froot%2F.ansible%2Fplugins%2Fmodules'%2C%20u'%2Fusr%2Fshare%2Fansible%2Fplugins%2Fmodules'%5D%5Cn%20%20ansible%20python%20module%20location%20%3D%20%2Fusr%2Flib%2Fpython2.7%2Fdist-packages%2Fansible%5Cn%20%20executable%20location%20%3D%20%2Fusr%2Fbin%2Fansible%5Cn%20%20python%20version%20%3D%202.7.12%20(default%2C%20Nov%2012%202018%2C%2014%3A36%3A49)%20%5BGCC%205.4.0%2020160609%5D%5Cn%5Cn%24%20pip%20install%20%5C%22pywinrm%3E%3D0.3.0%5C%22%22%7D\"></card><p><br /></p><h3 id=\"a9796771\">配置Inventory</h3><p><br /></p><p>参考 <a href=\"https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html\" target=\"_blank\">Working with Inventory</a></p><p><br /></p><p>默认是 Inventory <code>/etc/ansible/hosts</code> ,此处改为手动指定，Ansible的Inventory支持ini格式和yaml格式，本文采用yaml格式</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22id%22%3A%2288e13963%22%2C%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20mkdir%20ansible%5Cn%24%20tee%20ansible%2Ftest_hosts.yaml%20%3C%3C-'EOF'%5Cnwinserver%3A%5Cn%20%20hosts%3A%20%5Cn%20%20%20%20192.168.0.23%3A%5Cn%20%20vars%3A%5Cn%20%20%20%20ansible_user%3A%20Administrator%5Cn%20%20%20%20ansible_password%3A%20%E5%AF%86%E7%A0%81%5Cn%20%20%20%20ansible_connection%3A%20winrm%5Cn%20%20%20%20ansible_port%3A%205986%5Cn%20%20%20%20ansible_winrm_server_cert_validation%3A%20ignore%5Cn%5CnEOF%22%7D\"></card><p><br /></p><h3 id=\"ea275a70\">探测主机是否存活</h3><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22id%22%3A%22cd70691d%22%2C%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20ansible%20-i%20ansible%2Ftest_hosts.yaml%20winserver%20-m%20win_ping%5Cn%20192.168.0.23%20%7C%20SUCCESS%20%3D%3E%20%7B%5Cn%20%20%20%20%5C%22changed%5C%22%3A%20false%2C%20%5Cn%20%20%20%20%5C%22ping%5C%22%3A%20%5C%22pong%5C%22%5Cn%7D%22%7D\"></card><p><br /></p><p>如果报错</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22id%22%3A%2236f3b6a7%22%2C%22mode%22%3A%22bash%22%2C%22code%22%3A%22TASK%20%5BGathering%20Facts%5D%20*******************************************************************************************************************************************************************************************************************************************************%5Cnfatal%3A%20%5B192.168.0.23%5D%3A%20UNREACHABLE!%20%3D%3E%20%7B%5C%22changed%5C%22%3A%20false%2C%20%5C%22msg%5C%22%3A%20%5C%22ssl%3A%20HTTPSConnectionPool(host%3D'192.168.0.23'%2C%20port%3D5986)%3A%20Max%20retries%20exceeded%20with%20url%3A%20%2Fwsman%20(Caused%20by%20SSLError(SSLError(%5C%5C%5C%22bad%20handshake%3A%20Error(%5B('SSL%20routines'%2C%20'tls_process_server_certificate'%2C%20'certificate%20verify%20failed')%5D%2C)%5C%5C%5C%22%2C)%2C))%5C%22%2C%20%5C%22unreachable%5C%22%3A%20true%7D%22%7D\"></card><p><br /></p><p>降级一下 <code>pip install &quot;pywinrm==0.2.2&quot;</code></p><p><br /></p><p>更多实验，参见参考资料中的两篇51cto中的博文</p><p><br /></p><h2 id=\"7d486fc7\">可用的Windows模块</h2><p><br /></p><p>根据 <a href=\"https://docs.ansible.com/ansible/latest/user_guide/windows_faq.html#what-modules-are-available\" target=\"_blank\">What modules are available?</a> 绝大部分Module都是针对Linux编写的，大部分在windows下不能正常使用，有一些专用的windows module 使用ps编写的，可用在windows下使用，详细列表参见 <a href=\"https://docs.ansible.com/ansible/latest/modules/list_of_windows_modules.html#windows-modules\" target=\"_blank\">Windows modules</a></p><p><br /></p><h2 id=\"fae94bcd\"><a href=\"https://docs.ansible.com/ansible/latest/user_guide/windows_faq.html#windows-frequently-asked-questions\" target=\"_blank\">Windows常见问题</a></h2><p><br /></p><p>官方文档中列举了Ansible windows常见问题，建议仔细阅读</p><p><br /></p><h2 id=\"53001b41\">Ansible Playbook</h2><p><br /></p><p>Ansible配合<a href=\"https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html#about-playbooks\" target=\"_blank\">playbook</a>食用更佳，上述中的 <code>ansible</code> 命令是<a href=\"https://docs.ansible.com/ansible/latest/user_guide/intro_adhoc.html\" target=\"_blank\">adhoc命令模式</a>，类似在bash中手动执行命令，多用于简单，并且不需要复用场景，而 <code>ansible-playbook</code> 类似 bash脚本，但是更强大，适合复杂任务编排场景。</p><p><br /></p><p>考虑后期出一个playbook的文章</p><p><br /></p><p>推荐配合<a href=\"https://code.visualstudio.com/\" target=\"_blank\">vscode</a>的<a href=\"https://marketplace.visualstudio.com/items?itemName=vscoss.vscode-ansible\" target=\"_blank\">ansible</a> 插件(github repo 地址 <a href=\"https://github.com/VSChina/vscode-ansible\" target=\"_blank\">https://github.com/VSChina/vscode-ansible</a>)</p><p><br /></p><p>效果如下所示，比idea的ansible强大很多。</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fgif%2F226273%2F1556186451366-4149328b-fa7d-439d-9761-0194293d9352.gif%22%2C%22originWidth%22%3A990%2C%22originHeight%22%3A724%2C%22size%22%3A0%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A546%7D\"></card><cursor /></p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><p><br /></p><ul><li><a href=\"https://docs.ansible.com/\" target=\"_blank\">官方文档</a></li><li><a href=\"https://docs.ansible.com/ansible/latest/user_guide/windows.html\" target=\"_blank\">官方文档-windows指南</a></li><li><a href=\"https://docs.ansible.com/ansible/latest/user_guide/windows_setup.html#winrm-setup\" target=\"_blank\">官方文档-windows指南-winrm步骤</a></li><li><a href=\"http://blog.51cto.com/7424593/2174156\" target=\"_blank\">Ansible批量远程管理Windows主机(部署与配置)</a></li><li><a href=\"http://blog.51cto.com/dyc2005/2064746\" target=\"_blank\">ansible自动化管理windows系统实战</a></li><li><a href=\"https://docs.microsoft.com/zh-cn/powershell/wmf/5.1/install-configure\" target=\"_blank\">安装和配置 WMF 5.1</a></li><li><a href=\"https://github.com/jborean93/ansible-windows/issues/14\" target=\"_blank\">hotfixv4.trafficmanager.net dont work</a></li></ul><p><br /></p><h2 id=\"fb674066\">招聘小广告</h2><p><br /></p><p>山东济南的小伙伴欢迎投简历啊 <a href=\"https://www.shunnengnet.com/index.php/Home/Contact/join.html\" target=\"_blank\">加入我们</a> , 一起搞事情。</p><p><br /></p><p>长期招聘，Java程序员，大数据工程师，运维工程师。</p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-04-25T10:01:09.000Z",
    "deleted_at": null,
    "created_at": "2019-02-13T05:45:31.000Z",
    "updated_at": "2019-05-23T08:24:36.000Z",
    "published_at": "2019-04-25T10:01:09.000Z",
    "first_published_at": "2019-02-13T16:58:45.000Z",
    "word_count": 1314,
    "cover": "https://cdn.nlark.com/yuque/0/2019/png/226273/1550077125411-95e47528-4434-42a2-b9ef-89185f2fd324.png",
    "description": "date: 2019-02-14 00:58:00tags: [ansible,运维,devops,windows,ansible-playbook]categories: 运维---简述背景Ansible是一款轻量级的开源的自动化运维工具，支持linux和windows(只支持client，...",
    "custom_description": "Ansible是一款轻量级的开源的自动化运维工具，支持linux和windows(只支持client，并且部分模块)，利用Ansible可以简单批量的配置系统，安装软件，或者更高级的运维任务（比如滚动升级）。\n\n\n\nAnsible之类的运维工具对运维工作进行抽象及规范，能够极大的降低运维难度。本文只",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1229718,
    "slug": "google-jib",
    "title": "加速和简化构建Docker(基于Google jib)",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-02-08 21:26:00<br />tags: [k8s,容器,docker,微服务,容器,google-jib,jib,arthas,jvm]<br />categories: k8s<br />---\n\n<a name=\"61a3ec66\"></a>\n## 介绍\n\n其实jib刚发布时就有关注，但是一直没有用于生产，原因有二\n\n- 基于 [spotify/docker-maven-plugin](https://github.com/spotify/docker-maven-plugin) (原作者已经停止维护docker-maven-plugin，建议使用 [spotify/dockerfile-maven](https://github.com/spotify/dockerfile-maven))的原有流程跑的好好的，没动力换成jib\n- Google jib 一直没有发布1.x ，担心其不稳定\n\n先简单介绍一下: [google jib](https://github.com/GoogleContainerTools/jib/) 是Google于18年7月发布的一个针对Java应用的构建镜像的工具(支持[Maven](https://github.com/GoogleContainerTools/jib/blob/master/jib-maven-plugin)和[Gradle](https://github.com/GoogleContainerTools/jib/blob/master/jib-gradle-plugin)) ，好处是能够复用构建缓存，能够加快构建，减小传输体积（后文会详细讲解），并且让Java工程师不需要理解Docker相关知识就可以简单构建镜像并且发布到指定registry里（不需要docker build , tag, push）\n\n本文会依次讲解三种java构建镜像的方法，分别是 **正统的Dockerfile** ，**spotify/dockerfile-maven** ，**Google jib** <br />\n附赠 [alibaba/arthas](https://github.com/alibaba/arthas) 的集成和使用方法\n\n<!-- more -->\n<a name=\"424a2ad8\"></a>\n## 准备\n\n- Maven3.5\n- Git\n- Jdk 1.8\n- Docker\n\n```bash\n$ git clone https://github.com/anjia0532/jib-demo.git\n$ cd jib-demo\n$ mvn clean package -DskipTests\n$ mkdir docker\n$ cp ./target/*.jar ./docker\n```\n\n<a name=\"Dockerfile\"></a>\n## Dockerfile\n\n创建 `./docker/Dockerfile` ,内容如下，需要注意此处为了方便理解，没有进行改进（比如限制用户，安装必要软件等）\n\n```dockerfile\nFROM openjdk:8-jdk-alpine\n\nADD *.jar /app.jar\n\nEXPOSE 8080\n\nCMD java ${JAVA_OPTS} /app.jar\n```\n\n详情参见 官方文档 [Dockerfile reference](https://docs.docker.com/engine/reference/builder/#usage)\n\n```bash\n$ cd ./docker\n$ sudo docker build . -t jib-demo\n$ docker images --查看本地images\n$ docker tag jib-demo anjia0532/jib-demo --不写registry，则默认为docker hub registry,可以在build时，直接写\n$ docker push anjia0532/jib-demo -- 推送到registry\n```\n\n<a name=\"5db9fd7c\"></a>\n### 小结\n\n**优点：** 不需要改造pom，灵活，配合CI工具，可以不侵入项目，运维可以针对性的进行安全加固，并且可以做到标准化<br />\n**缺点：** 命令复杂，Java程序员需要学习Dockerfile命令，或者运维和java沟通不畅时，时区，软件，甚至目录等都可能有出问题\n\n<a name=\"50df2cce\"></a>\n## spotify/dockerfile-maven\n\n需要注意，spotify/dockerfile-maven 是需要pom+Dockerfile一块用的，而docker-maven-plugin是可选的\n\n在项目根目录创建Dockerfile，如下所示\n\n```dockerfile\nFROM openjdk:8-jdk-alpine\n\nEXPOSE 8080\n\nARG JAR_FILE\nADD target/${JAR_FILE} /usr/share/myservice/myservice.jar\n\nENTRYPOINT [\"/usr/bin/java\", \"-jar\", \"/usr/share/myservice/myservice.jar\"]\n```\n\n在pom里增加dockerfile-maven-plugin到build标签里\n\n```xml\n<build>\n  <plugins>\n    ...\n    <plugin>\n      <groupId>com.spotify</groupId>\n      <artifactId>dockerfile-maven-plugin</artifactId>\n      <version>${dockerfile-maven-version}</version>\n      <executions>\n        <execution>\n          <id>default</id>\n          <goals>\n            <goal>build</goal>\n            <goal>push</goal>\n          </goals>\n        </execution>\n      </executions>\n      <configuration>\n        <repository>anjia0532/dockerfile-maven-demo</repository>\n        <tag>${project.version}</tag>\n        <buildArgs>\n          <JAR_FILE>${project.build.finalName}.jar</JAR_FILE>\n        </buildArgs>\n      </configuration>\n    </plugin>\n    ...\n  <plugins>    \n<build>\n```\n\n运行如下命令进行构建\n\n```bash\n$ mvn package -DskipTests\n```\n\n详情参见 官方文档 [spotify/dockerfile-maven](https://github.com/spotify/dockerfile-maven)\n\n\n<a name=\"5db9fd7c\"></a>\n### 小结\n\n**优点：** 减少了docker build & tag & push 的操作，Java程序员能够控制镜像名<br />\n**缺点： **其实就是省了docker build & tag & push的操作，别的缺点一点没落不说，还得改动pom，还得要求写Dockerfile，tag只支持一个等等\n\n<a name=\"ce62745d\"></a>\n## Google jib\n\n修改默认settings.xml，增加registry认证,参见[Authentication Methods](https://github.com/GoogleContainerTools/jib/tree/master/jib-maven-plugin#authentication-methods)\n\n```xml\n<settings>\n  ...\n  <servers>\n    ...\n    <server>\n      <id>docker_hub</id>\n      <username>MY_USERNAME</username>\n      <password>{MY_SECRET}</password>\n    </server>\n  </servers>\n</settings>\n```\n\n改动pom.xml 增加 jib插件\n\n```xml\n<project>\n  ...\n  <build>\n    <plugins>\n      ...\n      <plugin>\n        <groupId>com.google.cloud.tools</groupId>\n        <artifactId>jib-maven-plugin</artifactId>\n        <version>1.0.0</version>\n        <configuration>\n          <from>\n            <!-- 如果不需要arthas可以改为 registry.hub.docker.com/openjdk:8-jdk-alpine -->\n            <image>registry.hub.docker.com/hengyunabc/arthas:latest</image>\n            <credHelper>docker_hub</credHelper>\n          </from>\n          <to>\n            <image>${project.artifactId}</image>\n            <tags>\n              <tag>latest</tag>\n              <tag>${project.version}</tag>\n            </tags>\n          </to>\n          <container>\n            <mainClass>${start-class}</mainClass>\n            <ports>\n              <port>8080</port>\n              <port>5701/udp</port>\n              <port>8563</port>\n            </ports>\n            <entrypoint>\n              <shell>sh</shell>\n              <option>-c</option>\n              <arg>java -cp /app/resources/:/app/classes/:/app/libs/* com.example.demo.DemoApplication</arg>\n            </entrypoint>\n            <appRoot>/app</appRoot>\n            <useCurrentTimestamp>true</useCurrentTimestamp>\n          </container>\n        </configuration>\n      </plugin>\n      ...\n    </plugins>\n  </build>\n  ...\n</project>\n```\n\n执行`mvn clean compile jib:dockerBuild` 构建docker镜像\n\n**注意：** <br />\npom中用的是 `registry.hub.docker.com/hengyunabc/arthas:latest` 是 [alibaba/arthas](https://github.com/alibaba/arthas/blob/master/README_CN.md) (阿里开源的一个Java诊断工具，便于线上调试)封装的docker镜像，如果不需要可以改成 `registry.hub.docker.com/openjdk:8-jdk-alpine`\n\n```bash\n$ docker run -d --init -p8563:8563 --name demo demo:latest\n## 下面是启动arthas，如果使用的是openjdk镜像请勿执行\n$ docker exec -it demo /bin/sh\n$ jid=$(jps | grep App | awk '{print $1}')\n$ java -jar /opt/arthas/arthas-boot.jar --target-ip 0.0.0.0 ${jid}\n```\n\n如果使用了arthas镜像，可以访问 [http://ip:8563](http://ip:8563) ，在页面上填上宿主ip，点击Connect， 然后参考[Arthas/命令列表](https://alibaba.github.io/arthas/commands.html) 了解Arthas命令用法\n\n![snipaste20190208_201332.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1549628164482-56f9cb66-b8bc-42db-82a3-ceb8717460bd.png#align=left&display=inline&height=340&linkTarget=_blank&name=snipaste20190208_201332.png&originHeight=612&originWidth=1343&size=85193&width=746#align=left&display=inline&height=340&originHeight=612&originWidth=1343&width=746)\n\n<a name=\"5db9fd7c\"></a>\n### 小结\n\n**优点：** 充分利用缓存，加快构建，不强制依赖docker daemon，依赖简单（在maven或gradle增加插件即可）<br />\n**缺点：** 不支持Docker RUN 命令(jib官方建议将run封装到base镜像)，对entrypoint和cmd支持不太好(alpine默认不支持多任务，跑java应用默认是pid 1 ，运行jmap等命令会报错，参考 [jmap not happy on alpine](https://github.com/docker-library/openjdk/issues/76) )\n\n<a name=\"d3f22cc0\"></a>\n### jib 缓存策略\n\n项目每次发布实际上变更的代码量不大，尤其依赖的jar变动的可能性较小，如果按照前两种方案构建镜像，会导致每次都全量构建，会导致存储和带宽资源浪费。\n\n> <a name=\"396d6264\"></a>\n## **Jib 如何让开发变得更美好**\n> Jib 利用了 Docker 镜像的分层机制，将其与构建系统集成，并通过以下方式优化 Java 容器镜像的构建：\n> 1. 简单——Jib 使用 Java 开发，并作为 Maven 或 Gradle 的一部分运行。你不需要编写 Dockerfile 或运行 Docker 守护进程，甚至无需创建包含所有依赖的大 JAR 包。因为 Jib 与 Java 构建过程紧密集成，所以它可以访问到打包应用程序所需的所有信息。在后续的容器构建期间，它将自动选择 Java 构建过的任何变体。\n> 1. 快速——Jib 利用镜像分层和注册表缓存来实现快速、增量的构建。它读取你的构建配置，将你的应用程序组织到不同的层（依赖项、资源、类）中，并只重新构建和推送发生变更的层。在项目进行快速迭代时，Jib 只讲发生变更的层（而不是整个应用程序）推送到注册表来节省宝贵的构建时间。\n> 1. 可重现——Jib 支持根据 Maven 和 Gradle 的构建元数据进行声明式的容器镜像构建，因此，只要输入保持不变，就可以通过配置重复创建相同的镜像。\n\n\n可以可以通过 `mvn clean compile jib:buildTar` 生成 `target/jib-image.tar` 然后用解压缩工具解压后进行分析，实际上jib会将lib中非快照部分放到一个层，将快照部分放到一个层，将源码编译后放到一个层。。。<br />\n![snipaste20190208_211839.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1549631943594-f1682ff3-91f5-47e7-8af4-ba83490c44a0.png#align=left&display=inline&height=485&linkTarget=_blank&name=snipaste20190208_211839.png&originHeight=507&originWidth=780&size=83376&width=746#align=left&display=inline&height=485&originHeight=507&originWidth=780&width=746)\n\n\n\n<a name=\"35808e79\"></a>\n## 参考资料\n\n- [谷歌开源 Java 镜像构建工具 Jib](https://www.infoq.cn/article/2018%2F07%2Fgoogle-opensource-Jib)\n- [jib自定义entrypoint](https://segmentfault.com/a/1190000016254151)\n- [jib打包docker镜像实战](https://segmentfault.com/a/1190000016156009)\n- [Jib - Containerize your Maven project](https://github.com/GoogleContainerTools/jib/blob/master/jib-maven-plugin/README.md)\n",
    "body_draft": "",
    "body_html": "<p><span>date: 2019-02-08 21:26:00</span></p><p>tags: [k8s,容器,docker,微服务,容器,google-jib,jib,arthas,jvm]</p><p>categories: k8s</p><p>---</p><p><br /></p><h2 id=\"61a3ec66\">介绍</h2><p><br /></p><p>其实jib刚发布时就有关注，但是一直没有用于生产，原因有二</p><p><br /></p><ul><li>基于 <a href=\"https://github.com/spotify/docker-maven-plugin\" target=\"_blank\">spotify/docker-maven-plugin</a> (原作者已经停止维护docker-maven-plugin，建议使用 <a href=\"https://github.com/spotify/dockerfile-maven\" target=\"_blank\">spotify/dockerfile-maven</a>)的原有流程跑的好好的，没动力换成jib</li></ul><ul><li>Google jib 一直没有发布1.x ，担心其不稳定</li></ul><p><br /></p><p>先简单介绍一下: <a href=\"https://github.com/GoogleContainerTools/jib/\" target=\"_blank\">google jib</a> 是Google于18年7月发布的一个针对Java应用的构建镜像的工具(支持<a href=\"https://github.com/GoogleContainerTools/jib/blob/master/jib-maven-plugin\" target=\"_blank\">Maven</a>和<a href=\"https://github.com/GoogleContainerTools/jib/blob/master/jib-gradle-plugin\" target=\"_blank\">Gradle</a>) ，好处是能够复用构建缓存，能够加快构建，减小传输体积（后文会详细讲解），并且让Java工程师不需要理解Docker相关知识就可以简单构建镜像并且发布到指定registry里（不需要docker build , tag, push）</p><p><br /></p><p>本文会依次讲解三种java构建镜像的方法，分别是 <strong>正统的Dockerfile</strong> ，<strong>spotify/dockerfile-maven</strong> ，<strong>Google jib</strong> <br />\n附赠 <a href=\"https://github.com/alibaba/arthas\" target=\"_blank\">alibaba/arthas</a> 的集成和使用方法</p><p><br /></p><p>&lt;!-- more --&gt;</p><h2 id=\"424a2ad8\">准备</h2><p><br /></p><ul><li>Maven3.5</li></ul><ul><li>Git</li></ul><ul><li>Jdk 1.8</li></ul><ul><li>Docker</li></ul><p><br /></p><pre data-lang=\"bash\"><code>$ git clone https://github.com/anjia0532/jib-demo.git\n$ cd jib-demo\n$ mvn clean package -DskipTests\n$ mkdir docker\n$ cp ./target/*.jar ./docker</code></pre><p><br /></p><h2 id=\"Dockerfile\">Dockerfile</h2><p><br /></p><p>创建 <code>./docker/Dockerfile</code> ,内容如下，需要注意此处为了方便理解，没有进行改进（比如限制用户，安装必要软件等）</p><p><br /></p><pre data-lang=\"dockerfile\"><code>FROM openjdk:8-jdk-alpine\n\nADD *.jar /app.jar\n\nEXPOSE 8080\n\nCMD java ${JAVA_OPTS} /app.jar</code></pre><p><br /></p><p>详情参见 官方文档 <a href=\"https://docs.docker.com/engine/reference/builder/#usage\" target=\"_blank\">Dockerfile reference</a></p><p><br /></p><pre data-lang=\"bash\"><code>$ cd ./docker\n$ sudo docker build . -t jib-demo\n$ docker images --查看本地images\n$ docker tag jib-demo anjia0532/jib-demo --不写registry，则默认为docker hub registry,可以在build时，直接写\n$ docker push anjia0532/jib-demo -- 推送到registry</code></pre><p><br /></p><h3 id=\"5db9fd7c\">小结</h3><p><br /></p><p><strong>优点：</strong> 不需要改造pom，灵活，配合CI工具，可以不侵入项目，运维可以针对性的进行安全加固，并且可以做到标准化<br />\n<strong>缺点：</strong> 命令复杂，Java程序员需要学习Dockerfile命令，或者运维和java沟通不畅时，时区，软件，甚至目录等都可能有出问题</p><p><br /></p><h2 id=\"50df2cce\">spotify/dockerfile-maven</h2><p><br /></p><p>需要注意，spotify/dockerfile-maven 是需要pom+Dockerfile一块用的，而docker-maven-plugin是可选的</p><p><br /></p><p>在项目根目录创建Dockerfile，如下所示</p><p><br /></p><pre data-lang=\"dockerfile\"><code>FROM openjdk:8-jdk-alpine\n\nEXPOSE 8080\n\nARG JAR_FILE\nADD target/${JAR_FILE} /usr/share/myservice/myservice.jar\n\nENTRYPOINT [&quot;/usr/bin/java&quot;, &quot;-jar&quot;, &quot;/usr/share/myservice/myservice.jar&quot;]</code></pre><p><br /></p><p>在pom里增加dockerfile-maven-plugin到build标签里</p><p><br /></p><pre data-lang=\"xml\"><code>&lt;build&gt;\n  &lt;plugins&gt;\n    ...\n    &lt;plugin&gt;\n      &lt;groupId&gt;com.spotify&lt;/groupId&gt;\n      &lt;artifactId&gt;dockerfile-maven-plugin&lt;/artifactId&gt;\n      &lt;version&gt;${dockerfile-maven-version}&lt;/version&gt;\n      &lt;executions&gt;\n        &lt;execution&gt;\n          &lt;id&gt;default&lt;/id&gt;\n          &lt;goals&gt;\n            &lt;goal&gt;build&lt;/goal&gt;\n            &lt;goal&gt;push&lt;/goal&gt;\n          &lt;/goals&gt;\n        &lt;/execution&gt;\n      &lt;/executions&gt;\n      &lt;configuration&gt;\n        &lt;repository&gt;anjia0532/dockerfile-maven-demo&lt;/repository&gt;\n        &lt;tag&gt;${project.version}&lt;/tag&gt;\n        &lt;buildArgs&gt;\n          &lt;JAR_FILE&gt;${project.build.finalName}.jar&lt;/JAR_FILE&gt;\n        &lt;/buildArgs&gt;\n      &lt;/configuration&gt;\n    &lt;/plugin&gt;\n    ...\n  &lt;plugins&gt;    \n&lt;build&gt;</code></pre><p><br /></p><p>运行如下命令进行构建</p><p><br /></p><pre data-lang=\"bash\"><code>$ mvn package -DskipTests</code></pre><p><br /></p><p>详情参见 官方文档 <a href=\"https://github.com/spotify/dockerfile-maven\" target=\"_blank\">spotify/dockerfile-maven</a></p><p><br /></p><p><br /></p><h3 id=\"5db9fd7c\">小结</h3><p><br /></p><p><strong>优点：</strong> 减少了docker build &amp; tag &amp; push 的操作，Java程序员能够控制镜像名<br />\n<strong>缺点： </strong>其实就是省了docker build &amp; tag &amp; push的操作，别的缺点一点没落不说，还得改动pom，还得要求写Dockerfile，tag只支持一个等等</p><p><br /></p><h2 id=\"ce62745d\">Google jib</h2><p><br /></p><p>修改默认settings.xml，增加registry认证,参见<a href=\"https://github.com/GoogleContainerTools/jib/tree/master/jib-maven-plugin#authentication-methods\" target=\"_blank\">Authentication Methods</a></p><p><br /></p><pre data-lang=\"xml\"><code>&lt;settings&gt;\n  ...\n  &lt;servers&gt;\n    ...\n    &lt;server&gt;\n      &lt;id&gt;docker_hub&lt;/id&gt;\n      &lt;username&gt;MY_USERNAME&lt;/username&gt;\n      &lt;password&gt;{MY_SECRET}&lt;/password&gt;\n    &lt;/server&gt;\n  &lt;/servers&gt;\n&lt;/settings&gt;</code></pre><p><br /></p><p>改动pom.xml 增加 jib插件</p><p><br /></p><pre data-lang=\"xml\"><code>&lt;project&gt;\n  ...\n  &lt;build&gt;\n    &lt;plugins&gt;\n      ...\n      &lt;plugin&gt;\n        &lt;groupId&gt;com.google.cloud.tools&lt;/groupId&gt;\n        &lt;artifactId&gt;jib-maven-plugin&lt;/artifactId&gt;\n        &lt;version&gt;1.0.0&lt;/version&gt;\n        &lt;configuration&gt;\n          &lt;from&gt;\n            &lt;!-- 如果不需要arthas可以改为 registry.hub.docker.com/openjdk:8-jdk-alpine --&gt;\n            &lt;image&gt;registry.hub.docker.com/hengyunabc/arthas:latest&lt;/image&gt;\n            &lt;credHelper&gt;docker_hub&lt;/credHelper&gt;\n          &lt;/from&gt;\n          &lt;to&gt;\n            &lt;image&gt;${project.artifactId}&lt;/image&gt;\n            &lt;tags&gt;\n              &lt;tag&gt;latest&lt;/tag&gt;\n              &lt;tag&gt;${project.version}&lt;/tag&gt;\n            &lt;/tags&gt;\n          &lt;/to&gt;\n          &lt;container&gt;\n            &lt;mainClass&gt;${start-class}&lt;/mainClass&gt;\n            &lt;ports&gt;\n              &lt;port&gt;8080&lt;/port&gt;\n              &lt;port&gt;5701/udp&lt;/port&gt;\n              &lt;port&gt;8563&lt;/port&gt;\n            &lt;/ports&gt;\n            &lt;entrypoint&gt;\n              &lt;shell&gt;sh&lt;/shell&gt;\n              &lt;option&gt;-c&lt;/option&gt;\n              &lt;arg&gt;java -cp /app/resources/:/app/classes/:/app/libs/* com.example.demo.DemoApplication&lt;/arg&gt;\n            &lt;/entrypoint&gt;\n            &lt;appRoot&gt;/app&lt;/appRoot&gt;\n            &lt;useCurrentTimestamp&gt;true&lt;/useCurrentTimestamp&gt;\n          &lt;/container&gt;\n        &lt;/configuration&gt;\n      &lt;/plugin&gt;\n      ...\n    &lt;/plugins&gt;\n  &lt;/build&gt;\n  ...\n&lt;/project&gt;</code></pre><p><br /></p><p>执行<code>mvn clean compile jib:dockerBuild</code> 构建docker镜像</p><p><br /></p><p><strong>注意：</strong> <br />\npom中用的是 <code>registry.hub.docker.com/hengyunabc/arthas:latest</code> 是 <a href=\"https://github.com/alibaba/arthas/blob/master/README_CN.md\" target=\"_blank\">alibaba/arthas</a> (阿里开源的一个Java诊断工具，便于线上调试)封装的docker镜像，如果不需要可以改成 <code>registry.hub.docker.com/openjdk:8-jdk-alpine</code></p><p><br /></p><pre data-lang=\"bash\"><code>$ docker run -d --init -p8563:8563 --name demo demo:latest\n## 下面是启动arthas，如果使用的是openjdk镜像请勿执行\n$ docker exec -it demo /bin/sh\n$ jid=$(jps | grep App | awk '{print $1}')\n$ java -jar /opt/arthas/arthas-boot.jar --target-ip 0.0.0.0 ${jid}</code></pre><p><br /></p><p>如果使用了arthas镜像，可以访问 <a href=\"http://ip:8563\" target=\"_blank\">http://ip:8563</a> ，在页面上填上宿主ip，点击Connect， 然后参考<a href=\"https://alibaba.github.io/arthas/commands.html\" target=\"_blank\">Arthas/命令列表</a> 了解Arthas命令用法</p><p><br /></p><p><img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1549628164482-56f9cb66-b8bc-42db-82a3-ceb8717460bd.png#align=left&amp;display=inline&amp;height=340&amp;linkTarget=_blank&amp;name=snipaste20190208_201332.png&amp;originHeight=612&amp;originWidth=1343&amp;size=85193&amp;width=746#align=left&amp;display=inline&amp;height=340&amp;originHeight=612&amp;originWidth=1343&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p><br /></p><h3 id=\"5db9fd7c\">小结</h3><p><br /></p><p><strong>优点：</strong> 充分利用缓存，加快构建，不强制依赖docker daemon，依赖简单（在maven或gradle增加插件即可）<br />\n<strong>缺点：</strong> 不支持Docker RUN 命令(jib官方建议将run封装到base镜像)，对entrypoint和cmd支持不太好(alpine默认不支持多任务，跑java应用默认是pid 1 ，运行jmap等命令会报错，参考 <a href=\"https://github.com/docker-library/openjdk/issues/76\" target=\"_blank\">jmap not happy on alpine</a> )</p><p><br /></p><h3 id=\"d3f22cc0\">jib 缓存策略</h3><p><br /></p><p>项目每次发布实际上变更的代码量不大，尤其依赖的jar变动的可能性较小，如果按照前两种方案构建镜像，会导致每次都全量构建，会导致存储和带宽资源浪费。</p><p><br /></p><blockquote><h2 style=\"text-align: justify;\"><strong>Jib 如何让开发变得更美好</strong></h2><p style=\"text-align: justify;\">Jib 利用了 Docker 镜像的分层机制，将其与构建系统集成，并通过以下方式优化 Java 容器镜像的构建：</p><ol style=\"text-align: justify;\"><li>简单——Jib 使用 Java 开发，并作为 Maven 或 Gradle 的一部分运行。你不需要编写 Dockerfile 或运行 Docker 守护进程，甚至无需创建包含所有依赖的大 JAR 包。因为 Jib 与 Java 构建过程紧密集成，所以它可以访问到打包应用程序所需的所有信息。在后续的容器构建期间，它将自动选择 Java 构建过的任何变体。</li><li>快速——Jib 利用镜像分层和注册表缓存来实现快速、增量的构建。它读取你的构建配置，将你的应用程序组织到不同的层（依赖项、资源、类）中，并只重新构建和推送发生变更的层。在项目进行快速迭代时，Jib 只讲发生变更的层（而不是整个应用程序）推送到注册表来节省宝贵的构建时间。</li><li>可重现——Jib 支持根据 Maven 和 Gradle 的构建元数据进行声明式的容器镜像构建，因此，只要输入保持不变，就可以通过配置重复创建相同的镜像。</li></ol></blockquote><p><br /></p><p>可以可以通过 <code>mvn clean compile jib:buildTar</code> 生成 <code>target/jib-image.tar</code> 然后用解压缩工具解压后进行分析，实际上jib会将lib中非快照部分放到一个层，将快照部分放到一个层，将源码编译后放到一个层。。。<br />\n<img src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1549631943594-f1682ff3-91f5-47e7-8af4-ba83490c44a0.png#align=left&amp;display=inline&amp;height=485&amp;linkTarget=_blank&amp;name=snipaste20190208_211839.png&amp;originHeight=507&amp;originWidth=780&amp;size=83376&amp;width=746#align=left&amp;display=inline&amp;height=485&amp;originHeight=507&amp;originWidth=780&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p><br /></p><p><br /></p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://www.infoq.cn/article/2018%2F07%2Fgoogle-opensource-Jib\" target=\"_blank\">谷歌开源 Java 镜像构建工具 Jib</a></li><li><a href=\"https://segmentfault.com/a/1190000016254151\" target=\"_blank\">jib自定义entrypoint</a></li><li><a href=\"https://segmentfault.com/a/1190000016156009\" target=\"_blank\">jib打包docker镜像实战</a></li><li><a href=\"https://github.com/GoogleContainerTools/jib/blob/master/jib-maven-plugin/README.md\" target=\"_blank\">Jib - Containerize your Maven project</a></li></ul>",
    "body_lake": "<!doctype lake><p><span>date: 2019-02-08 21:26:00</span></p><p>tags: [k8s,容器,docker,微服务,容器,google-jib,jib,arthas,jvm]</p><p>categories: k8s<cursor /></p><p>---</p><p><br /></p><h2 id=\"61a3ec66\">介绍</h2><p><br /></p><p>其实jib刚发布时就有关注，但是一直没有用于生产，原因有二</p><p><br /></p><ul><li>基于 <a href=\"https://github.com/spotify/docker-maven-plugin\" target=\"_blank\">spotify/docker-maven-plugin</a> (原作者已经停止维护docker-maven-plugin，建议使用 <a href=\"https://github.com/spotify/dockerfile-maven\" target=\"_blank\">spotify/dockerfile-maven</a>)的原有流程跑的好好的，没动力换成jib</li></ul><ul><li>Google jib 一直没有发布1.x ，担心其不稳定</li></ul><p><br /></p><p>先简单介绍一下: <a href=\"https://github.com/GoogleContainerTools/jib/\" target=\"_blank\">google jib</a> 是Google于18年7月发布的一个针对Java应用的构建镜像的工具(支持<a href=\"https://github.com/GoogleContainerTools/jib/blob/master/jib-maven-plugin\" target=\"_blank\">Maven</a>和<a href=\"https://github.com/GoogleContainerTools/jib/blob/master/jib-gradle-plugin\" target=\"_blank\">Gradle</a>) ，好处是能够复用构建缓存，能够加快构建，减小传输体积（后文会详细讲解），并且让Java工程师不需要理解Docker相关知识就可以简单构建镜像并且发布到指定registry里（不需要docker build , tag, push）</p><p><br /></p><p>本文会依次讲解三种java构建镜像的方法，分别是 <strong>正统的Dockerfile</strong> ，<strong>spotify/dockerfile-maven</strong> ，<strong>Google jib</strong> <br />\n附赠 <a href=\"https://github.com/alibaba/arthas\" target=\"_blank\">alibaba/arthas</a> 的集成和使用方法</p><p><br /></p><p>&lt;!-- more --&gt;</p><h2 id=\"424a2ad8\">准备</h2><p><br /></p><ul><li>Maven3.5</li></ul><ul><li>Git</li></ul><ul><li>Jdk 1.8</li></ul><ul><li>Docker</li></ul><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20git%20clone%20https%3A%2F%2Fgithub.com%2Fanjia0532%2Fjib-demo.git%5Cn%24%20cd%20jib-demo%5Cn%24%20mvn%20clean%20package%20-DskipTests%5Cn%24%20mkdir%20docker%5Cn%24%20cp%20.%2Ftarget%2F*.jar%20.%2Fdocker%22%7D\"></card><p><br /></p><h2 id=\"Dockerfile\">Dockerfile</h2><p><br /></p><p>创建 <code>./docker/Dockerfile</code> ,内容如下，需要注意此处为了方便理解，没有进行改进（比如限制用户，安装必要软件等）</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22dockerfile%22%2C%22code%22%3A%22FROM%20openjdk%3A8-jdk-alpine%5Cn%5CnADD%20*.jar%20%2Fapp.jar%5Cn%5CnEXPOSE%208080%5Cn%5CnCMD%20java%20%24%7BJAVA_OPTS%7D%20%2Fapp.jar%22%7D\"></card><p><br /></p><p>详情参见 官方文档 <a href=\"https://docs.docker.com/engine/reference/builder/#usage\" target=\"_blank\">Dockerfile reference</a></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20cd%20.%2Fdocker%5Cn%24%20sudo%20docker%20build%20.%20-t%20jib-demo%5Cn%24%20docker%20images%20--%E6%9F%A5%E7%9C%8B%E6%9C%AC%E5%9C%B0images%5Cn%24%20docker%20tag%20jib-demo%20anjia0532%2Fjib-demo%20--%E4%B8%8D%E5%86%99registry%EF%BC%8C%E5%88%99%E9%BB%98%E8%AE%A4%E4%B8%BAdocker%20hub%20registry%2C%E5%8F%AF%E4%BB%A5%E5%9C%A8build%E6%97%B6%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%86%99%5Cn%24%20docker%20push%20anjia0532%2Fjib-demo%20--%20%E6%8E%A8%E9%80%81%E5%88%B0registry%22%7D\"></card><p><br /></p><h3 id=\"5db9fd7c\">小结</h3><p><br /></p><p><strong>优点：</strong> 不需要改造pom，灵活，配合CI工具，可以不侵入项目，运维可以针对性的进行安全加固，并且可以做到标准化<br />\n<strong>缺点：</strong> 命令复杂，Java程序员需要学习Dockerfile命令，或者运维和java沟通不畅时，时区，软件，甚至目录等都可能有出问题</p><p><br /></p><h2 id=\"50df2cce\">spotify/dockerfile-maven</h2><p><br /></p><p>需要注意，spotify/dockerfile-maven 是需要pom+Dockerfile一块用的，而docker-maven-plugin是可选的</p><p><br /></p><p>在项目根目录创建Dockerfile，如下所示</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22dockerfile%22%2C%22code%22%3A%22FROM%20openjdk%3A8-jdk-alpine%5Cn%5CnEXPOSE%208080%5Cn%5CnARG%20JAR_FILE%5CnADD%20target%2F%24%7BJAR_FILE%7D%20%2Fusr%2Fshare%2Fmyservice%2Fmyservice.jar%5Cn%5CnENTRYPOINT%20%5B%5C%22%2Fusr%2Fbin%2Fjava%5C%22%2C%20%5C%22-jar%5C%22%2C%20%5C%22%2Fusr%2Fshare%2Fmyservice%2Fmyservice.jar%5C%22%5D%22%7D\"></card><p><br /></p><p>在pom里增加dockerfile-maven-plugin到build标签里</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22xml%22%2C%22code%22%3A%22%3Cbuild%3E%5Cn%20%20%3Cplugins%3E%5Cn%20%20%20%20...%5Cn%20%20%20%20%3Cplugin%3E%5Cn%20%20%20%20%20%20%3CgroupId%3Ecom.spotify%3C%2FgroupId%3E%5Cn%20%20%20%20%20%20%3CartifactId%3Edockerfile-maven-plugin%3C%2FartifactId%3E%5Cn%20%20%20%20%20%20%3Cversion%3E%24%7Bdockerfile-maven-version%7D%3C%2Fversion%3E%5Cn%20%20%20%20%20%20%3Cexecutions%3E%5Cn%20%20%20%20%20%20%20%20%3Cexecution%3E%5Cn%20%20%20%20%20%20%20%20%20%20%3Cid%3Edefault%3C%2Fid%3E%5Cn%20%20%20%20%20%20%20%20%20%20%3Cgoals%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3Cgoal%3Ebuild%3C%2Fgoal%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3Cgoal%3Epush%3C%2Fgoal%3E%5Cn%20%20%20%20%20%20%20%20%20%20%3C%2Fgoals%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fexecution%3E%5Cn%20%20%20%20%20%20%3C%2Fexecutions%3E%5Cn%20%20%20%20%20%20%3Cconfiguration%3E%5Cn%20%20%20%20%20%20%20%20%3Crepository%3Eanjia0532%2Fdockerfile-maven-demo%3C%2Frepository%3E%5Cn%20%20%20%20%20%20%20%20%3Ctag%3E%24%7Bproject.version%7D%3C%2Ftag%3E%5Cn%20%20%20%20%20%20%20%20%3CbuildArgs%3E%5Cn%20%20%20%20%20%20%20%20%20%20%3CJAR_FILE%3E%24%7Bproject.build.finalName%7D.jar%3C%2FJAR_FILE%3E%5Cn%20%20%20%20%20%20%20%20%3C%2FbuildArgs%3E%5Cn%20%20%20%20%20%20%3C%2Fconfiguration%3E%5Cn%20%20%20%20%3C%2Fplugin%3E%5Cn%20%20%20%20...%5Cn%20%20%3Cplugins%3E%20%20%20%20%5Cn%3Cbuild%3E%22%7D\"></card><p><br /></p><p>运行如下命令进行构建</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20mvn%20package%20-DskipTests%22%7D\"></card><p><br /></p><p>详情参见 官方文档 <a href=\"https://github.com/spotify/dockerfile-maven\" target=\"_blank\">spotify/dockerfile-maven</a></p><p><br /></p><p><br /></p><h3 id=\"5db9fd7c\">小结</h3><p><br /></p><p><strong>优点：</strong> 减少了docker build &amp; tag &amp; push 的操作，Java程序员能够控制镜像名<br />\n<strong>缺点： </strong>其实就是省了docker build &amp; tag &amp; push的操作，别的缺点一点没落不说，还得改动pom，还得要求写Dockerfile，tag只支持一个等等</p><p><br /></p><h2 id=\"ce62745d\">Google jib</h2><p><br /></p><p>修改默认settings.xml，增加registry认证,参见<a href=\"https://github.com/GoogleContainerTools/jib/tree/master/jib-maven-plugin#authentication-methods\" target=\"_blank\">Authentication Methods</a></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22xml%22%2C%22code%22%3A%22%3Csettings%3E%5Cn%20%20...%5Cn%20%20%3Cservers%3E%5Cn%20%20%20%20...%5Cn%20%20%20%20%3Cserver%3E%5Cn%20%20%20%20%20%20%3Cid%3Edocker_hub%3C%2Fid%3E%5Cn%20%20%20%20%20%20%3Cusername%3EMY_USERNAME%3C%2Fusername%3E%5Cn%20%20%20%20%20%20%3Cpassword%3E%7BMY_SECRET%7D%3C%2Fpassword%3E%5Cn%20%20%20%20%3C%2Fserver%3E%5Cn%20%20%3C%2Fservers%3E%5Cn%3C%2Fsettings%3E%22%7D\"></card><p><br /></p><p>改动pom.xml 增加 jib插件</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22xml%22%2C%22code%22%3A%22%3Cproject%3E%5Cn%20%20...%5Cn%20%20%3Cbuild%3E%5Cn%20%20%20%20%3Cplugins%3E%5Cn%20%20%20%20%20%20...%5Cn%20%20%20%20%20%20%3Cplugin%3E%5Cn%20%20%20%20%20%20%20%20%3CgroupId%3Ecom.google.cloud.tools%3C%2FgroupId%3E%5Cn%20%20%20%20%20%20%20%20%3CartifactId%3Ejib-maven-plugin%3C%2FartifactId%3E%5Cn%20%20%20%20%20%20%20%20%3Cversion%3E1.0.0%3C%2Fversion%3E%5Cn%20%20%20%20%20%20%20%20%3Cconfiguration%3E%5Cn%20%20%20%20%20%20%20%20%20%20%3Cfrom%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C!--%20%E5%A6%82%E6%9E%9C%E4%B8%8D%E9%9C%80%E8%A6%81arthas%E5%8F%AF%E4%BB%A5%E6%94%B9%E4%B8%BA%20registry.hub.docker.com%2Fopenjdk%3A8-jdk-alpine%20--%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3Cimage%3Eregistry.hub.docker.com%2Fhengyunabc%2Farthas%3Alatest%3C%2Fimage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CcredHelper%3Edocker_hub%3C%2FcredHelper%3E%5Cn%20%20%20%20%20%20%20%20%20%20%3C%2Ffrom%3E%5Cn%20%20%20%20%20%20%20%20%20%20%3Cto%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3Cimage%3E%24%7Bproject.artifactId%7D%3C%2Fimage%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3Ctags%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctag%3Elatest%3C%2Ftag%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctag%3E%24%7Bproject.version%7D%3C%2Ftag%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Ftags%3E%5Cn%20%20%20%20%20%20%20%20%20%20%3C%2Fto%3E%5Cn%20%20%20%20%20%20%20%20%20%20%3Ccontainer%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CmainClass%3E%24%7Bstart-class%7D%3C%2FmainClass%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3Cports%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cport%3E8080%3C%2Fport%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cport%3E5701%2Fudp%3C%2Fport%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cport%3E8563%3C%2Fport%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fports%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3Centrypoint%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cshell%3Esh%3C%2Fshell%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Coption%3E-c%3C%2Foption%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Carg%3Ejava%20-cp%20%2Fapp%2Fresources%2F%3A%2Fapp%2Fclasses%2F%3A%2Fapp%2Flibs%2F*%20com.example.demo.DemoApplication%3C%2Farg%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fentrypoint%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CappRoot%3E%2Fapp%3C%2FappRoot%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CuseCurrentTimestamp%3Etrue%3C%2FuseCurrentTimestamp%3E%5Cn%20%20%20%20%20%20%20%20%20%20%3C%2Fcontainer%3E%5Cn%20%20%20%20%20%20%20%20%3C%2Fconfiguration%3E%5Cn%20%20%20%20%20%20%3C%2Fplugin%3E%5Cn%20%20%20%20%20%20...%5Cn%20%20%20%20%3C%2Fplugins%3E%5Cn%20%20%3C%2Fbuild%3E%5Cn%20%20...%5Cn%3C%2Fproject%3E%22%7D\"></card><p><br /></p><p>执行<code>mvn clean compile jib:dockerBuild</code> 构建docker镜像</p><p><br /></p><p><strong>注意：</strong> <br />\npom中用的是 <code>registry.hub.docker.com/hengyunabc/arthas:latest</code> 是 <a href=\"https://github.com/alibaba/arthas/blob/master/README_CN.md\" target=\"_blank\">alibaba/arthas</a> (阿里开源的一个Java诊断工具，便于线上调试)封装的docker镜像，如果不需要可以改成 <code>registry.hub.docker.com/openjdk:8-jdk-alpine</code></p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22bash%22%2C%22code%22%3A%22%24%20docker%20run%20-d%20--init%20-p8563%3A8563%20--name%20demo%20demo%3Alatest%5Cn%23%23%20%E4%B8%8B%E9%9D%A2%E6%98%AF%E5%90%AF%E5%8A%A8arthas%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%BD%BF%E7%94%A8%E7%9A%84%E6%98%AFopenjdk%E9%95%9C%E5%83%8F%E8%AF%B7%E5%8B%BF%E6%89%A7%E8%A1%8C%5Cn%24%20docker%20exec%20-it%20demo%20%2Fbin%2Fsh%5Cn%24%20jid%3D%24(jps%20%7C%20grep%20App%20%7C%20awk%20'%7Bprint%20%241%7D')%5Cn%24%20java%20-jar%20%2Fopt%2Farthas%2Farthas-boot.jar%20--target-ip%200.0.0.0%20%24%7Bjid%7D%22%7D\"></card><p><br /></p><p>如果使用了arthas镜像，可以访问 <a href=\"http://ip:8563\" target=\"_blank\">http://ip:8563</a> ，在页面上填上宿主ip，点击Connect， 然后参考<a href=\"https://alibaba.github.io/arthas/commands.html\" target=\"_blank\">Arthas/命令列表</a> 了解Arthas命令用法</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1549628164482-56f9cb66-b8bc-42db-82a3-ceb8717460bd.png%23align%3Dleft%26display%3Dinline%26height%3D340%26linkTarget%3D_blank%26name%3Dsnipaste20190208_201332.png%26originHeight%3D612%26originWidth%3D1343%26size%3D85193%26width%3D746%22%2C%22originWidth%22%3A1343%2C%22originHeight%22%3A612%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A746%2C%22height%22%3A340%7D\"></card></p><p><br /></p><h3 id=\"5db9fd7c\">小结</h3><p><br /></p><p><strong>优点：</strong> 充分利用缓存，加快构建，不强制依赖docker daemon，依赖简单（在maven或gradle增加插件即可）<br />\n<strong>缺点：</strong> 不支持Docker RUN 命令(jib官方建议将run封装到base镜像)，对entrypoint和cmd支持不太好(alpine默认不支持多任务，跑java应用默认是pid 1 ，运行jmap等命令会报错，参考 <a href=\"https://github.com/docker-library/openjdk/issues/76\" target=\"_blank\">jmap not happy on alpine</a> )</p><p><br /></p><h3 id=\"d3f22cc0\">jib 缓存策略</h3><p><br /></p><p>项目每次发布实际上变更的代码量不大，尤其依赖的jar变动的可能性较小，如果按照前两种方案构建镜像，会导致每次都全量构建，会导致存储和带宽资源浪费。</p><p><br /></p><blockquote><h2 style=\"text-align: justify;\"><strong>Jib 如何让开发变得更美好</strong></h2><p style=\"text-align: justify;\">Jib 利用了 Docker 镜像的分层机制，将其与构建系统集成，并通过以下方式优化 Java 容器镜像的构建：</p><ol style=\"text-align: justify;\"><li>简单——Jib 使用 Java 开发，并作为 Maven 或 Gradle 的一部分运行。你不需要编写 Dockerfile 或运行 Docker 守护进程，甚至无需创建包含所有依赖的大 JAR 包。因为 Jib 与 Java 构建过程紧密集成，所以它可以访问到打包应用程序所需的所有信息。在后续的容器构建期间，它将自动选择 Java 构建过的任何变体。</li><li>快速——Jib 利用镜像分层和注册表缓存来实现快速、增量的构建。它读取你的构建配置，将你的应用程序组织到不同的层（依赖项、资源、类）中，并只重新构建和推送发生变更的层。在项目进行快速迭代时，Jib 只讲发生变更的层（而不是整个应用程序）推送到注册表来节省宝贵的构建时间。</li><li>可重现——Jib 支持根据 Maven 和 Gradle 的构建元数据进行声明式的容器镜像构建，因此，只要输入保持不变，就可以通过配置重复创建相同的镜像。</li></ol></blockquote><p><br /></p><p>可以可以通过 <code>mvn clean compile jib:buildTar</code> 生成 <code>target/jib-image.tar</code> 然后用解压缩工具解压后进行分析，实际上jib会将lib中非快照部分放到一个层，将快照部分放到一个层，将源码编译后放到一个层。。。<br />\n<card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1549631943594-f1682ff3-91f5-47e7-8af4-ba83490c44a0.png%23align%3Dleft%26display%3Dinline%26height%3D485%26linkTarget%3D_blank%26name%3Dsnipaste20190208_211839.png%26originHeight%3D507%26originWidth%3D780%26size%3D83376%26width%3D746%22%2C%22originWidth%22%3A780%2C%22originHeight%22%3A507%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A746%2C%22height%22%3A485%7D\"></card></p><p><br /></p><p><br /></p><p><br /></p><h2 id=\"35808e79\">参考资料</h2><ul><li><a href=\"https://www.infoq.cn/article/2018%2F07%2Fgoogle-opensource-Jib\" target=\"_blank\">谷歌开源 Java 镜像构建工具 Jib</a></li><li><a href=\"https://segmentfault.com/a/1190000016254151\" target=\"_blank\">jib自定义entrypoint</a></li><li><a href=\"https://segmentfault.com/a/1190000016156009\" target=\"_blank\">jib打包docker镜像实战</a></li><li><a href=\"https://github.com/GoogleContainerTools/jib/blob/master/jib-maven-plugin/README.md\" target=\"_blank\">Jib - Containerize your Maven project</a></li></ul>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-02-19T06:23:07.000Z",
    "deleted_at": null,
    "created_at": "2019-02-08T13:21:45.000Z",
    "updated_at": "2019-06-18T06:07:58.000Z",
    "published_at": "2019-02-19T06:23:07.000Z",
    "first_published_at": "2019-02-08T13:26:42.000Z",
    "word_count": 1909,
    "cover": "https://cdn.nlark.com/yuque/0/2019/png/226273/1550550871964-cdfd8279-c8ed-4673-ba02-b629bd0f6b46.png",
    "description": "date: 2019-02-08 21:26:00tags: [k8s,容器,docker,微服务,容器,google-jib,jib,arthas,jvm]categories: k8s---介绍其实jib刚发布时就有关注，但是一直没有用于生产，原因有二基于 spotify/docker-m...",
    "custom_description": "介绍其实jib刚发布时就有关注，但是一直没有用于生产，原因有二基于 spotify/docker-maven-plugin (原作者已经停止维护docker-maven-plugin，建议使用 spotify/dockerfile-maven)的原有流程跑的好好的，没动力换成jibGoogle...",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1193588,
    "slug": "ifttt-github-release",
    "title": "订阅github release",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-01-29 12:32:00<br />tags: [github,ifttt]<br />categories: 其他<br />---\n\n关注的github repo项目多了后，往往不能及时获取最新的release信息。本文整理了两种（官方自带+IFTTT）易于使用的订阅方式\n\n<!-- more -->\n<a name=\"9d119ccd\"></a>\n## 官方自带release提醒\ngithub于2018-11-28日推出仅订阅release功能，喜大普奔啊，之前都是IFTTT或者自己写脚本轮或者订阅rss\n\n![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1548733703278-4e1950fb-7799-49eb-8a83-9a0e03619544.png#align=left&display=inline&height=375&name=image.png&originHeight=375&originWidth=1023&size=78024&width=1023)\n\n一旦有新的release，就会发到github绑定的邮箱里了\n\n详见 [Watching and unwatching releases for a repository](https://help.github.com/articles/watching-and-unwatching-releases-for-a-repository/)\n\n\n<a name=\"IFTTT\"></a>\n## IFTTT\n[IFTTT](https://ifttt.com) 是 `If This Then That`  ，简单来说就是如果(IF)发生了某事(This)那么就做啥(That).<br />用在此处就是如果关注的github repo 发布了release，那么就通知我(email或者weibo)\n\n<a name=\"cdcd6e69\"></a>\n### 注册IFTTT账号\n打开 [https://ifttt.com/join](https://ifttt.com/join)  填写邮箱和密码进行注册\n\n<a name=\"085b4fb1\"></a>\n### 创建IFTTT小程序\n打开 [https://ifttt.com/create/](https://ifttt.com/create/) 选择 +this<br />选择 `RSS Feed` -> `New feed item` <br />**Feed URL** 输入 `https://github.com/用户名/repo名/releases.atom` 比如我的一个repo的地址是 [https://github.com/anjia0532/elastalert-wechat-plugin/releases.atom](https://github.com/anjia0532/elastalert-wechat-plugin/releases.atom) <br />点 `Create Trigger` 点 蓝色的 +that 部分<br />选择 `Email` -> `Send me an email` <br />点击 `Create action` \n\n一旦发布releases 就会收到 email<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/226273/1548736026081-37c127af-53cf-4dec-8db3-df8706117d14.png#align=left&display=inline&height=546&name=image.png&originHeight=546&originWidth=783&size=60687&width=783)<br />可以通过 [https://ifttt.com/activity](https://ifttt.com/activity) 查看小程序运行情况\n\n<a name=\"bcd92bce\"></a>\n## Q&A\n**Q: **有了github的watch了，为嘛还要折腾IFTTT？<br />**A: **因为在github出来之前就用了IFTTT了，再一个，IFTTT不光可以发email，还可以发微博和twitter，让你分分钟成为一个技术潮人。新鲜资讯早知道啊.\n",
    "body_draft": "",
    "body_html": "<p><span>date: 2019-01-29 12:32:00</span></p><p>tags: [github,ifttt]</p><p>categories: 其他</p><p>---</p><p><br /></p><p>关注的github repo项目多了后，往往不能及时获取最新的release信息。本文整理了两种（官方自带+IFTTT）易于使用的订阅方式</p><p><br /></p><p>&lt;!-- more --&gt;</p><h2 id=\"9d119ccd\">官方自带release提醒</h2><p>github于2018-11-28日推出仅订阅release功能，喜大普奔啊，之前都是IFTTT或者自己写脚本轮或者订阅rss</p><p><br /></p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1548733703278-4e1950fb-7799-49eb-8a83-9a0e03619544.png#align=left&amp;display=inline&amp;height=375&amp;name=image.png&amp;originHeight=375&amp;originWidth=1023&amp;size=78024&amp;width=1023\" style=\"max-width: 600px; width: 1023px;\" /></p><p><br /></p><p>一旦有新的release，就会发到github绑定的邮箱里了</p><p><br /></p><p>详见 <a href=\"https://help.github.com/articles/watching-and-unwatching-releases-for-a-repository/\" target=\"_blank\">Watching and unwatching releases for a repository</a></p><p><br /></p><p><br /></p><h2 id=\"IFTTT\">IFTTT</h2><p><a href=\"https://ifttt.com\" target=\"_blank\">IFTTT</a> 是 <code>If This Then That</code>  ，简单来说就是如果(IF)发生了某事(This)那么就做啥(That).</p><p>用在此处就是如果关注的github repo 发布了release，那么就通知我(email或者weibo)</p><p><br /></p><h3 id=\"cdcd6e69\">注册IFTTT账号</h3><p>打开 <a href=\"https://ifttt.com/join\" target=\"_blank\">https://ifttt.com/join</a>  填写邮箱和密码进行注册</p><p><br /></p><h3 id=\"085b4fb1\">创建IFTTT小程序</h3><p>打开 <a href=\"https://ifttt.com/create/\" target=\"_blank\">https://ifttt.com/create/</a> 选择 <span style=\"color: #1890FF;\">+this</span></p><p>选择 <code>RSS Feed</code> -&gt; <code>New feed item</code> </p><p><strong>Feed URL</strong><span> 输入 </span><code>https://github.com/用户名/repo名/releases.atom</code><span> 比如我的一个repo的地址是 </span><a href=\"https://github.com/anjia0532/elastalert-wechat-plugin/releases.atom\" target=\"_blank\">https://github.com/anjia0532/elastalert-wechat-plugin/releases.atom</a><span> </span></p><p><span>点 </span><code>Create Trigger</code><span> 点 蓝色的 </span><span style=\"color: #1890FF;\">+that</span><span> 部分</span></p><p>选择 <code>Email</code> -&gt; <code>Send me an email</code> </p><p>点击 <code>Create action</code> </p><p><br /></p><p>一旦发布releases 就会收到 email</p><p><img alt=\"image.png\" title=\"image.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/226273/1548736026081-37c127af-53cf-4dec-8db3-df8706117d14.png#align=left&amp;display=inline&amp;height=546&amp;name=image.png&amp;originHeight=546&amp;originWidth=783&amp;size=60687&amp;width=783\" style=\"max-width: 600px; width: 783px;\" /></p><p>可以通过 <a href=\"https://ifttt.com/activity\" target=\"_blank\">https://ifttt.com/activity</a> 查看小程序运行情况</p><p><br /></p><h2 id=\"bcd92bce\">Q&amp;A</h2><p><strong>Q: </strong>有了github的watch了，为嘛还要折腾IFTTT？</p><p><strong>A: </strong>因为在github出来之前就用了IFTTT了，再一个，IFTTT不光可以发email，还可以发微博和twitter，让你分分钟成为一个技术潮人。新鲜资讯早知道啊.</p>",
    "body_lake": "<!doctype lake><p><span>date: 2019-01-29 12:32:00</span></p><p>tags: [github,ifttt]</p><p>categories: 其他<cursor /></p><p>---</p><p><br /></p><p>关注的github repo项目多了后，往往不能及时获取最新的release信息。本文整理了两种（官方自带+IFTTT）易于使用的订阅方式</p><p><br /></p><p>&lt;!-- more --&gt;</p><h2 id=\"9d119ccd\">官方自带release提醒</h2><p>github于2018-11-28日推出仅订阅release功能，喜大普奔啊，之前都是IFTTT或者自己写脚本轮或者订阅rss</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1548733703278-4e1950fb-7799-49eb-8a83-9a0e03619544.png%22%2C%22originWidth%22%3A1023%2C%22originHeight%22%3A375%2C%22name%22%3A%22image.png%22%2C%22size%22%3A78024%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A1023%2C%22height%22%3A375%7D\"></card></p><p><br /></p><p>一旦有新的release，就会发到github绑定的邮箱里了</p><p><br /></p><p>详见 <a href=\"https://help.github.com/articles/watching-and-unwatching-releases-for-a-repository/\" target=\"_blank\">Watching and unwatching releases for a repository</a></p><p><br /></p><p><br /></p><h2 id=\"IFTTT\">IFTTT</h2><p><a href=\"https://ifttt.com\" target=\"_blank\">IFTTT</a> 是 <code>If This Then That</code>  ，简单来说就是如果(IF)发生了某事(This)那么就做啥(That).</p><p>用在此处就是如果关注的github repo 发布了release，那么就通知我(email或者weibo)</p><p><br /></p><h3 id=\"cdcd6e69\">注册IFTTT账号</h3><p>打开 <a href=\"https://ifttt.com/join\" target=\"_blank\">https://ifttt.com/join</a>  填写邮箱和密码进行注册</p><p><br /></p><h3 id=\"085b4fb1\">创建IFTTT小程序</h3><p>打开 <a href=\"https://ifttt.com/create/\" target=\"_blank\">https://ifttt.com/create/</a> 选择 <span style=\"color: #1890FF;\">+this</span></p><p>选择 <code>RSS Feed</code> -&gt; <code>New feed item</code> </p><p><strong>Feed URL</strong><span> 输入 </span><code>https://github.com/用户名/repo名/releases.atom</code><span> 比如我的一个repo的地址是 </span><a href=\"https://github.com/anjia0532/elastalert-wechat-plugin/releases.atom\" target=\"_blank\">https://github.com/anjia0532/elastalert-wechat-plugin/releases.atom</a><span> </span></p><p><span>点 </span><code>Create Trigger</code><span> 点 蓝色的 </span><span style=\"color: #1890FF;\">+that</span><span> 部分</span></p><p>选择 <code>Email</code> -&gt; <code>Send me an email</code> </p><p>点击 <code>Create action</code> </p><p><br /></p><p>一旦发布releases 就会收到 email</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F226273%2F1548736026081-37c127af-53cf-4dec-8db3-df8706117d14.png%22%2C%22originWidth%22%3A783%2C%22originHeight%22%3A546%2C%22name%22%3A%22image.png%22%2C%22size%22%3A60687%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A783%2C%22height%22%3A546%7D\"></card></p><p>可以通过 <a href=\"https://ifttt.com/activity\" target=\"_blank\">https://ifttt.com/activity</a> 查看小程序运行情况</p><p><br /></p><h2 id=\"bcd92bce\">Q&amp;A</h2><p><strong>Q: </strong>有了github的watch了，为嘛还要折腾IFTTT？</p><p><strong>A: </strong>因为在github出来之前就用了IFTTT了，再一个，IFTTT不光可以发email，还可以发微博和twitter，让你分分钟成为一个技术潮人。新鲜资讯早知道啊.</p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-02-19T06:23:26.000Z",
    "deleted_at": null,
    "created_at": "2019-01-28T02:54:55.000Z",
    "updated_at": "2019-02-19T06:23:26.000Z",
    "published_at": "2019-02-19T06:23:26.000Z",
    "first_published_at": "2019-01-29T04:32:16.000Z",
    "word_count": 385,
    "cover": "https://cdn.nlark.com/yuque/0/2019/png/226273/1548736335808-7106f2f7-a818-444a-a992-a6b8ce0f1811.png",
    "description": "date: 2019-01-29 12:32:00tags: [github,ifttt]categories: 其他---关注的github repo项目多了后，往往不能及时获取最新的release信息。本文整理了两种（官方自带+IFTTT）易于使用的订阅方式&lt;!-- more --&...",
    "custom_description": "关注的github repo项目多了后，往往不能及时获取最新的release信息。本文整理了两种（官方自带+IFTTT）易于使用的订阅方式官方自带release提醒github于2018-11-28日推出仅订阅release功能，喜大普奔啊，之前都是IFTTT或者自己写脚本轮或者订阅rss一旦...",
    "_serializer": "v2.doc_detail"
  },
  {
    "id": 1165620,
    "slug": "debug-cloud-native",
    "title": "云原生时代如何方便的进行本地调试",
    "book_id": 206605,
    "book": {
      "id": 206605,
      "type": "Column",
      "slug": "blog",
      "name": "家的博客",
      "user_id": 226273,
      "description": "",
      "creator_id": 226273,
      "public": 1,
      "items_count": 46,
      "likes_count": 0,
      "watches_count": 1,
      "content_updated_at": "2019-08-16T05:03:02.792Z",
      "updated_at": "2019-08-16T05:03:02.000Z",
      "created_at": "2019-01-18T05:44:48.000Z",
      "namespace": "zhaoanjia/blog",
      "user": {
        "id": 226273,
        "type": "User",
        "login": "zhaoanjia",
        "name": "赵安家",
        "description": null,
        "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
        "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
        "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
        "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
        "books_count": 2,
        "public_books_count": 1,
        "followers_count": 0,
        "following_count": 0,
        "created_at": "2018-12-17T10:18:58.000Z",
        "updated_at": "2019-05-05T00:44:07.000Z",
        "_serializer": "v2.user"
      },
      "_serializer": "v2.book"
    },
    "user_id": 226273,
    "creator": {
      "id": 226273,
      "type": "User",
      "login": "zhaoanjia",
      "name": "赵安家",
      "description": null,
      "avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png",
      "large_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_320,h_320",
      "medium_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_160,h_160",
      "small_avatar_url": "https://cdn.nlark.com/yuque/0/2018/png/226273/1545093783024-be7def76-df9d-4625-823c-a5464cacfa86.png?x-oss-process=image/resize,m_fill,w_80,h_80",
      "books_count": 2,
      "public_books_count": 1,
      "followers_count": 0,
      "following_count": 0,
      "created_at": "2018-12-17T10:18:58.000Z",
      "updated_at": "2019-05-05T00:44:07.000Z",
      "_serializer": "v2.user"
    },
    "format": "lake",
    "body": "date: 2019-01-21 12:00:00<br />tags: [k8s,云原生,devops,微服务,容器,jrebel,telepresence]<br />categories: k8s<br />---\n\n云原生的四要素：持续交付、DevOps、微服务、容器，虽然极大的解放了生产力，但是不可避免的也带来了诸多问题，本文不做延伸，感兴趣的，可以自行百度。<br />本文只为解决微服务(本文以Spring Cloud为例)+Kubernetes开发调试低效问题。\n\n![07e15debbba7479aabef8f861f3ef5f4.jpg](https://cdn.nlark.com/yuque/0/2019/jpeg/226273/1548032278508-325e41b8-29f1-46de-b1a0-5a97e3de41e8.jpeg#align=left&display=inline&height=486&name=07e15debbba7479aabef8f861f3ef5f4.jpg&originHeight=704&originWidth=1080&size=72220&width=746)<br /><!-- more -->\n\n<a name=\"telepresence\"></a>\n## [telepresence](https://www.telepresence.io/)\n如果团队内成员都有k8s基础，并且都用win10或者linux,macos，那建议直接用telepresence,简单直接。详见 [Fast development workflow with Docker and Kubernetes](https://www.telepresence.io/tutorials/docker)，[A development workflow for Kubernetes services](https://articles.microservices.com/a-development-workflow-for-kubernetes-services-10ee017d752a)\n\n\n<a name=\"3e942e04\"></a>\n## Service映射\n如果团队内k8s基础弱，或者硬件条件不满足，可以使用Service映射方案，在k8s集群里创建一个Service和Endpoint，然后进行绑定。但是适用于单向的，比如，k8s访问外部mysql，如果要逆向访问，不好意思，不支持。\n\n<a name=\"93820fd3\"></a>\n## 静态路由\n[https://github.com/jkwong888/k8s-add-static-routes](https://github.com/jkwong888/k8s-add-static-routes)\n\n<a name=\"TDD\"></a>\n## TDD\n如果团队对于单院测试和Mock掌握的比较好，可以直接开启TDD模式，省事省心\n\n<a name=\"93f45b87\"></a>\n## 远程调试\nk8s集群暴露远程调试接口。[Remote debugging Spring Boot on Kubernetes](https://itnext.io/remote-debugging-spring-boot-on-kubernetes-a5f96a40e5c0)\n\n<a name=\"a7f0ffc1\"></a>\n## 开发机纳入集群\n应用发到本地pod里，省的走cicd那么费劲了\n\n<a name=\"86ad854d\"></a>\n## 热部署\n开发机纳入集群后，把target\\class挂载到本地卷，并且配置上rebel.xml，idea build后生成class，然后pod里触发jrebel的热部署。 参考 [https://www.telepresence.io/tutorials/java#hot-code-replace](https://www.telepresence.io/tutorials/java#hot-code-replace)\n",
    "body_draft": "",
    "body_html": "<p><span>date: 2019-01-21 12:00:00</span></p><p>tags: [k8s,云原生,devops,微服务,容器,jrebel,telepresence]</p><p>categories: k8s</p><p>---</p><p><br /></p><p>云原生的四要素：持续交付、DevOps、微服务、容器，虽然极大的解放了生产力，但是不可避免的也带来了诸多问题，本文不做延伸，感兴趣的，可以自行百度。</p><p>本文只为解决微服务(本文以Spring Cloud为例)+Kubernetes开发调试低效问题。</p><p><br /></p><p><img alt=\"07e15debbba7479aabef8f861f3ef5f4.jpg\" title=\"07e15debbba7479aabef8f861f3ef5f4.jpg\" src=\"https://cdn.nlark.com/yuque/0/2019/jpeg/226273/1548032278508-325e41b8-29f1-46de-b1a0-5a97e3de41e8.jpeg#align=left&amp;display=inline&amp;height=486&amp;name=07e15debbba7479aabef8f861f3ef5f4.jpg&amp;originHeight=704&amp;originWidth=1080&amp;size=72220&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"telepresence\"><a href=\"https://www.telepresence.io/\" target=\"_blank\">telepresence</a></h2><p>如果团队内成员都有k8s基础，并且都用win10或者linux,macos，那建议直接用telepresence,简单直接。详见 <a href=\"https://www.telepresence.io/tutorials/docker\" target=\"_blank\">Fast development workflow with Docker and Kubernetes</a>，<a href=\"https://articles.microservices.com/a-development-workflow-for-kubernetes-services-10ee017d752a\" target=\"_blank\">A development workflow for Kubernetes services</a></p><p><br /></p><p><br /></p><h2 id=\"3e942e04\">Service映射</h2><p>如果团队内k8s基础弱，或者硬件条件不满足，可以使用Service映射方案，<span>在k8s集群里创建一个Service和Endpoint，然后进行绑定。但是适用于单向的，比如，k8s访问外部mysql，如果要逆向访问，不好意思，不支持。</span></p><p><span><br /></span></p><h2 id=\"93820fd3\">静态路由</h2><p><a href=\"https://github.com/jkwong888/k8s-add-static-routes\" target=\"_blank\">https://github.com/jkwong888/k8s-add-static-routes</a></p><p><br /></p><h2 id=\"TDD\">TDD</h2><p>如果团队对于单院测试和Mock掌握的比较好，可以直接开启TDD模式，省事省心</p><p><br /></p><h2 id=\"93f45b87\">远程调试</h2><p>k8s集群暴露远程调试接口。<a href=\"https://itnext.io/remote-debugging-spring-boot-on-kubernetes-a5f96a40e5c0\" target=\"_blank\">Remote debugging Spring Boot on Kubernetes</a></p><p><br /></p><h2 id=\"a7f0ffc1\">开发机纳入集群</h2><p>应用发到本地pod里，省的走cicd那么费劲了</p><p><br /></p><h2 id=\"86ad854d\">热部署</h2><p>开发机纳入集群后，把target\\class挂载到本地卷，并且配置上rebel.xml，idea build后生成class，然后pod里触发jrebel的热部署。 参考 <a href=\"https://www.telepresence.io/tutorials/java#hot-code-replace\" target=\"_blank\">https://www.telepresence.io/tutorials/java#hot-code-replace</a></p>",
    "body_lake": "<!doctype lake><p><span>date: 2019-01-21 12:00:00<cursor /></span></p><p>tags: [k8s,云原生,devops,微服务,容器,jrebel,telepresence]</p><p>categories: k8s</p><p>---</p><p><br /></p><p>云原生的四要素：持续交付、DevOps、微服务、容器，虽然极大的解放了生产力，但是不可避免的也带来了诸多问题，本文不做延伸，感兴趣的，可以自行百度。</p><p>本文只为解决微服务(本文以Spring Cloud为例)+Kubernetes开发调试低效问题。</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fjpeg%2F226273%2F1548032278508-325e41b8-29f1-46de-b1a0-5a97e3de41e8.jpeg%22%2C%22originWidth%22%3A1080%2C%22originHeight%22%3A704%2C%22name%22%3A%2207e15debbba7479aabef8f861f3ef5f4.jpg%22%2C%22size%22%3A72220%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22link%22%3A%22%22%2C%22linkTarget%22%3A%22_blank%22%2C%22width%22%3A746%2C%22height%22%3A486%7D\"></card></p><p>&lt;!-- more --&gt;</p><p><br /></p><h2 id=\"telepresence\"><a href=\"https://www.telepresence.io/\" target=\"_blank\">telepresence</a></h2><p>如果团队内成员都有k8s基础，并且都用win10或者linux,macos，那建议直接用telepresence,简单直接。详见 <a href=\"https://www.telepresence.io/tutorials/docker\" target=\"_blank\">Fast development workflow with Docker and Kubernetes</a>，<a href=\"https://articles.microservices.com/a-development-workflow-for-kubernetes-services-10ee017d752a\" target=\"_blank\">A development workflow for Kubernetes services</a></p><p><br /></p><p><br /></p><h2 id=\"3e942e04\">Service映射</h2><p>如果团队内k8s基础弱，或者硬件条件不满足，可以使用Service映射方案，<span>在k8s集群里创建一个Service和Endpoint，然后进行绑定。但是适用于单向的，比如，k8s访问外部mysql，如果要逆向访问，不好意思，不支持。</span></p><p><span><br /></span></p><h2 id=\"93820fd3\">静态路由</h2><p><a href=\"https://github.com/jkwong888/k8s-add-static-routes\" target=\"_blank\">https://github.com/jkwong888/k8s-add-static-routes</a></p><p><br /></p><h2 id=\"TDD\">TDD</h2><p>如果团队对于单院测试和Mock掌握的比较好，可以直接开启TDD模式，省事省心</p><p><br /></p><h2 id=\"93f45b87\">远程调试</h2><p>k8s集群暴露远程调试接口。<a href=\"https://itnext.io/remote-debugging-spring-boot-on-kubernetes-a5f96a40e5c0\" target=\"_blank\">Remote debugging Spring Boot on Kubernetes</a></p><p><br /></p><h2 id=\"a7f0ffc1\">开发机纳入集群</h2><p>应用发到本地pod里，省的走cicd那么费劲了</p><p><br /></p><h2 id=\"86ad854d\">热部署</h2><p>开发机纳入集群后，把target\\class挂载到本地卷，并且配置上rebel.xml，idea build后生成class，然后pod里触发jrebel的热部署。 参考 <a href=\"https://www.telepresence.io/tutorials/java#hot-code-replace\" target=\"_blank\">https://www.telepresence.io/tutorials/java#hot-code-replace</a></p>",
    "public": 1,
    "status": 1,
    "likes_count": 0,
    "comments_count": 0,
    "content_updated_at": "2019-02-19T06:23:46.000Z",
    "deleted_at": null,
    "created_at": "2019-01-21T00:52:14.000Z",
    "updated_at": "2019-06-18T07:54:58.000Z",
    "published_at": "2019-02-19T06:23:46.000Z",
    "first_published_at": "2019-01-21T04:00:49.000Z",
    "word_count": 379,
    "cover": "https://cdn.nlark.com/yuque/0/2019/png/226273/1550550534778-2510b416-a656-46c6-b5a6-1ccebf0141ee.png",
    "description": "date: 2019-01-21 12:00:00tags: [k8s,云原生,devops,微服务,容器,jrebel,telepresence]categories: k8s---云原生的四要素：持续交付、DevOps、微服务、容器，虽然极大的解放了生产力，但是不可避免的也带来了诸多问题，...",
    "custom_description": "云原生的四要素：持续交付、DevOps、微服务、容器，虽然极大的解放了生产力，但是不可避免的也带来了诸多问题，本文不做延伸，感兴趣的，可以自行百度。本文只为解决微服务(本文以Spring Cloud为例)+Kubernetes开发调试低效问题。",
    "_serializer": "v2.doc_detail"
  }
]